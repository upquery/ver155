create or replace PROCEDURE JOB_QUARTER (PRM_CHECK VARCHAR2 DEFAULT NULL)  AS 

    CURSOR CRS_USUARIOS IS
           SELECT   USUARIO, COUNT(*) ACESSOS
           FROM     LOG_EVENTOS
           WHERE    TRUNC(DATA_EVENTO)=TRUNC(SYSDATE-1) AND TIPO='ACESSO'
           GROUP BY USUARIO;

    CURSOR CRS_LOG_JS IS
           SELECT TRUNC(DATA_EVENTO) AS DATA_EVENTO,
                  USUARIO,
                  TRIM(UTL_RAW.CAST_TO_RAW(DESCRICAO)) DESCRICAO, 
                  COUNT(*) QTDE
           FROM   LOG_EVENTOS 
           WHERE  PROGRAMA='JS'
           GROUP BY TRUNC(DATA_EVENTO), USUARIO, DESCRICAO;

    WS_REG_ONLINE       VARCHAR2(100);
    WS_NOACT            EXCEPTION;
    WS_TIMEOUT          EXCEPTION;
    WS_ERRO             VARCHAR2(4000);
    WS_VARTEMP          VARCHAR2(100);
    WS_TRY              NUMBER;
    WS_CHECK            NUMBER     := 0;

    WS_OWNER      VARCHAR2(90);
    WS_NAME       VARCHAR2(90);
    WS_LINE       NUMBER;
    WS_CALLER     VARCHAR2(90);

BEGIN

if to_number(to_char(sysdate, 'HH24')) > 3 and to_number(to_char(sysdate, 'HH24')) < 22 then

   FOR AC_JS IN CRS_LOG_JS LOOP
       EXIT WHEN CRS_LOG_JS%NOTFOUND;

       FCL.REG_ONLINE('005','',AC_JS.DESCRICAO,AC_JS.USUARIO, AC_JS.QTDE);

   END LOOP;

   BEGIN
        DELETE FROM LOG_EVENTOS
        WHERE  PROGRAMA='JS';
        COMMIT;
   EXCEPTION
        WHEN OTHERS THEN
             ROLLBACK;
   END;


    WS_TRY   := 70;
    WS_CHECK := 1;
    LOOP
       EXIT WHEN WS_CHECK=0;

         SELECT COUNT(*) INTO WS_CHECK
         FROM   RUNNING_PROCESS
         WHERE LAST_STATUS='RUNNING';
         WS_TRY := WS_TRY - 1;
         WS_TRY := WS_TRY - 1;
         IF  WS_TRY=0 AND WS_CHECK<>0 THEN
             RAISE WS_TIMEOUT;
         END IF;

         IF  WS_CHECK<>0 THEN
             DBMS_LOCK.SLEEP(15);
         END IF;
    END LOOP;

    WS_TRY   := 70;
    WS_CHECK := 1;
    LOOP
       EXIT WHEN WS_CHECK=0;

         SELECT COUNT(*) INTO WS_CHECK
         FROM   RUNNING_PROCESS
         WHERE LAST_STATUS='RUNNING';
         WS_TRY := WS_TRY - 1;
         IF  WS_TRY=0 AND WS_CHECK<>0 THEN
             RAISE WS_TIMEOUT;
         END IF;

         IF  WS_CHECK<>0 THEN
             DBMS_LOCK.SLEEP(15);
         END IF;
    END LOOP;

    INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-NINICIO PROCESSO!' , USER , 'CALCULO' , 'OK', '0');
    COMMIT;

    BEGIN
         FCL.STATUS_PROCESS('000006','JOB_QUARTER','START');
    EXCEPTION
         WHEN OTHERS THEN
              INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-PROCESSO SEM REGISTRO!' , USER , 'CALCULO' , 'OK', '0');
              COMMIT;
    END;

    INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-RUNNING PROCESS!' , USER , 'CALCULO' , 'OK', '0');
    COMMIT;

    UPDATE VAR_CONTEUDO SET CONTEUDO=TO_CHAR(SYSDATE,'dd/mon/yyyy','NLS_DATE_LANGUAGE = AMERICAN')
                      WHERE VARIAVEL = 'DATA_ATUAL';
    COMMIT;

    EXEC_QUARTER;

    IF  TRUNC(SYSDATE) <> TO_DATE(FUN.RET_VAR('DIA_TROCA'),'dd/mon/yyyy','NLS_DATE_LANGUAGE = AMERICAN') THEN
        INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-Novo Dia Início!' , USER , 'CALCULO' , 'OK', '0');
        COMMIT;

        FOR AC_USER IN CRS_USUARIOS LOOP
            EXIT WHEN CRS_USUARIOS%NOTFOUND;

            FCL.REG_ONLINE('002','',AC_USER.ACESSOS,AC_USER.USUARIO);

        END LOOP;
        COMMIT;

        BEGIN

                SELECT  CONTEUDO INTO WS_VARTEMP
                FROM    VAR_CONTEUDO
                WHERE   VARIAVEL = 'DATA_ATUAL';

                UPDATE VAR_CONTEUDO SET CONTEUDO=TO_CHAR(SYSDATE,'dd/mon/yyyy','NLS_DATE_LANGUAGE = AMERICAN')
                       WHERE VARIAVEL IN ('DIA_TROCA','DATA_ATUAL');
                COMMIT;

                EXEC_DAY;

                INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-Novo Dia Final!' , USER , 'CALCULO' , 'OK', '0');
                COMMIT;

        EXCEPTION
                WHEN OTHERS THEN
                     ROLLBACK;
                     UPDATE VAR_CONTEUDO SET CONTEUDO=TO_CHAR(SYSDATE,'dd/mon/yyyy','NLS_DATE_LANGUAGE = AMERICAN')
                     WHERE VARIAVEL = 'DATA_ATUAL';
                     UPDATE VAR_CONTEUDO SET CONTEUDO=WS_VARTEMP
                     WHERE VARIAVEL = 'DIA_TROCA';
                     COMMIT;
        END;

        FCL.REG_ONLINE('003','VERIFY_DAY','OK');

    END IF;

    INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-FINAL NPROCESSO!' , USER , 'CALCULO' , 'OK', '0');
    COMMIT;

    BEGIN

       FCL.STATUS_PROCESS('000006','JOB_QUARTER','END');
    EXCEPTION
         WHEN OTHERS THEN
              INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-PROCESSO SEM REGISTRO!' , USER , 'CALCULO' , 'OK', '0');
              COMMIT;
    END;

end if;

EXCEPTION
    WHEN WS_NOACT THEN
         INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[OK]-NO ACT!' , USER , 'CALCULO' , 'OK', '0');
         COMMIT;
    WHEN WS_TIMEOUT THEN
         WS_ERRO := SQLERRM;
         INSERT INTO ERR_TXT VALUES(TO_CHAR(SYSDATE,'YYMMDDHH24MI')||'-'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
         INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-TIME OUT!' , USER , 'CALCULO' , 'OK', '0');
         COMMIT;
         FCL.STATUS_PROCESS('000006','JOB_QUARTER','ERRO');
         FCL.REG_ONLINE('001','JOB_QUARTER','ERRO');
         FCL.INSERT_POST('','','','DWU','[JOB_QUARTER] - TIME OUT','1',PRM_SHOW => 'N', PRM_ORIGEM => 'SYS');
    WHEN OTHERS THEN
         WS_ERRO := SQLERRM;
         INSERT INTO ERR_TXT VALUES(TO_CHAR(SYSDATE,'YYMMDDHH24MI')||'-'||DBMS_UTILITY.FORMAT_ERROR_STACK||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
         INSERT INTO LOG_EVENTOS VALUES(SYSDATE , '[QH]-ERRO NPROCESSO!' , USER , 'CALCULO' , 'OK', '0');
         COMMIT;
         FCL.STATUS_PROCESS('000006','JOB_QUARTER','ERRO');
         FCL.REG_ONLINE('001','JOB_QUARTER','ERRO');
         FCL.INSERT_POST('','','','DWU','[JOB_QUARTER] - ERRO EXECUÇÃO','1',PRM_SHOW => 'N', PRM_ORIGEM => 'SYS');

END JOB_QUARTER;