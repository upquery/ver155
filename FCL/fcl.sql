SET SCAN OFF
CREATE OR REPLACE PACKAGE BODY FCL  IS

  G_KEY     RAW(32767)  := UTL_RAW.CAST_TO_RAW('69198823');
  G_PAD_CHR VARCHAR2(1) := '~';

  PROCEDURE PADSTRING (P_TEXT  IN OUT  VARCHAR2);

 
  FUNCTION ENCRYPT (P_TEXT  IN  VARCHAR2) RETURN RAW IS

    L_TEXT       VARCHAR2(32767) := P_TEXT;
    L_ENCRYPTED  RAW(32767);
  BEGIN
    PADSTRING(L_TEXT);
    DBMS_OBFUSCATION_TOOLKIT.DESENCRYPT(INPUT          => UTL_RAW.CAST_TO_RAW(L_TEXT),
                                        KEY            => G_KEY,
                                        ENCRYPTED_DATA => L_ENCRYPTED);
    RETURN L_ENCRYPTED;
  END;

  FUNCTION DECRYPT (P_RAW  IN  RAW) RETURN VARCHAR2 IS

    L_DECRYPTED  VARCHAR2(32767);
  BEGIN
    DBMS_OBFUSCATION_TOOLKIT.DESDECRYPT(INPUT => P_RAW,
                                        KEY   => G_KEY,
                                        DECRYPTED_DATA => L_DECRYPTED);

    RETURN RTRIM(UTL_RAW.CAST_TO_VARCHAR2(L_DECRYPTED), G_PAD_CHR);
  END;

  PROCEDURE PADSTRING (P_TEXT  IN OUT  VARCHAR2) IS

    L_UNITS  NUMBER;
  BEGIN
    IF LENGTH(P_TEXT) MOD 8 > 0 THEN
      L_UNITS := TRUNC(LENGTH(P_TEXT)/8) + 1;
      P_TEXT  := RPAD(P_TEXT, L_UNITS * 8, G_PAD_CHR);
    END IF;
  END;

PROCEDURE INPUTP (	PRM_TIPO	    CHAR DEFAULT NULL,
					PRM_IND		    CHAR DEFAULT NULL,
					PRM_DEFAULT	    CHAR DEFAULT NULL,
					PRM_OBJETO	    CHAR DEFAULT NULL,
					PRM_SUFIXO      CHAR DEFAULT NULL,
					PRM_TMP_FIELD   CHAR DEFAULT NULL,
					PRM_SCRIPT	    CHAR DEFAULT NULL,
					PRM_LIST	    CHAR DEFAULT NULL,
		            PRM_ORDEM       VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT		NUMBER;
	WS_SCRIPT       VARCHAR2(2000);

BEGIN
    
    
CASE PRM_TIPO

    

	WHEN 'CFREE_FONTE' THEN
	    FCL.PICKCOLOR(PRM_DEFAULT, '', '', PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'CFREE_FUNDO' THEN
	    FCL.PICKCOLOR(PRM_DEFAULT, '', '', PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'COR_FONTE' THEN
	    FCL.PICKCOLOR(PRM_DEFAULT, '', '', PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'COR_FUNDO' THEN
	    FCL.PICKCOLOR(PRM_DEFAULT, '', '', PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'LOCAL' THEN
	    FCL.LISTBOX(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'LIGACAO' THEN
	    FCL.LISTLIG(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, PRM_TMP_FIELD, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, PRM_ORDEM);
	WHEN 'TEXTO' THEN
	    FCL.ENTRY(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, '', TRIM(PRM_OBJETO));
	WHEN 'TEXTAREA' THEN
	    HTP.P('<textarea data-atrib="'||TRIM(PRM_OBJETO)||'" title="'||PRM_DEFAULT||'" onblur="if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); } if(document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||')){ document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=this.value; } " onkeyup="'||FUN.ATTRIB_TEMPOREAL(TRIM(PRM_OBJETO), PRM_OBJETO)||'" >'||PRM_DEFAULT||'</textarea>' );
	WHEN 'TEXTO_FLOAT' THEN
	    HTP.P('<input class="float_title" readonly="" type="text" title="'||PRM_TMP_FIELD||'" value="'||PRM_TMP_FIELD||'">');
		FCL.ENTRY(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, '', TRIM(PRM_OBJETO), PRM_TMP_FIELD);
	WHEN 'INTEIRO' THEN
	    FCL.ENTRY(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, '', TRIM(PRM_OBJETO), PRM_TMP_FIELD);
	WHEN 'INTEIRO_FLOAT' THEN
	    HTP.P('<input class="float_title" readonly="" type="text" title="'||PRM_TMP_FIELD||'" value="'||PRM_TMP_FIELD||'">');
		FCL.ENTRY(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, '', TRIM(PRM_OBJETO), PRM_TMP_FIELD);
	WHEN 'NUMERICO' THEN
	    FCL.ENTRY(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, '', TRIM(PRM_OBJETO), PRM_TMP_FIELD);
	WHEN 'DATA' THEN
	    HTP.P('<input class="float_title" readonly="" type="text" title="'||PRM_TMP_FIELD||'" value="'||PRM_TMP_FIELD||'">');
		IF OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') LIKE '%iPhone%'  THEN
		    HTP.P('<input readonly="readonly" style="font-size: 18px;" type="text" id="data_'||'id_'||PRM_TMP_FIELD||PRM_IND||'" onmouseover="calendar.set(this.id);" ontouchend="this.blur();" value="'||PRM_DEFAULT||'" />');
		ELSE
	        HTP.P('<input readonly="readonly" type="text" id="data_'||'id_'||PRM_TMP_FIELD||PRM_IND||'" onmouseover="calendar.set(this.id);" ontouchend="this.blur();" value="'||PRM_DEFAULT||'" />');
		END IF;
	WHEN 'DATA2' THEN
		
		HTP.P('<input placeholder="DD/MM/YY" type="text" id="data_'||'id_'||PRM_TMP_FIELD||PRM_IND||'" oninput="this.value = VMasker.toPattern(this.value, ''99/99/99'');" value="'||PRM_DEFAULT||'" />');
	WHEN 'INTEIRO' THEN
	    
		FCL.ENTRY(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_LIST, '', PRM_TMP_FIELD, PRM_TMP_FIELD);
		
		

	WHEN 'COR_GOM' THEN
	    FCL.PICKCOLOR(PRM_DEFAULT, '', '', PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'FONTE' THEN
	    FCL.PICKFONT(TRIM(PRM_OBJETO)||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT, PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'TAMANHO_FONTE' THEN
	    FCL.PICKFONTSIZE(PRM_OBJETO||'_'||PRM_SUFIXO, 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_SCRIPT, PRM_DEFAULT);
	WHEN 'NEGRITO' THEN
      

        





		
		IF PRM_DEFAULT = 'bold' THEN
	        HTP.P('<span class="checkbox checked" data-positive="bold" data-negative="normal" title="'||PRM_DEFAULT||'"></span>');
		ELSE
		    HTP.P('<span class="checkbox" data-positive="bold" data-negative="normal" title="'||PRM_DEFAULT||'"></span>');
		END IF;

	WHEN 'DEGRADE' THEN
	    
		

	    IF PRM_DEFAULT = 'S' THEN
	        HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||PRM_DEFAULT||'"></span>');
		ELSE
		    HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||PRM_DEFAULT||'"></span>');
		END IF;
	
	WHEN 'ITALICO' THEN
	
	    

	    



		
		IF PRM_DEFAULT = 'italic' THEN
	        HTP.P('<span class="checkbox checked" data-positive="italic" data-negative="normal" title="'||PRM_DEFAULT||'"></span>');
		ELSE
		    HTP.P('<span class="checkbox" data-positive="italic" data-negative="normal" title="'||PRM_DEFAULT||'"></span>');
		END IF;
		
		
      
	WHEN 'BORDA' THEN
	    FCL.CHECKBOX(PRM_TIPO||PRM_IND, TRIM(PRM_OBJETO), PRM_SCRIPT, '1px solid #000000', '', FPDATA(TRIM(PRM_DEFAULT),'1px solid #000000','CHECKED',''), 'id_'||PRM_TMP_FIELD||PRM_IND, PRM_TMP_FIELD, PRM_OBJETO);
	WHEN 'CHECK_ONLY' THEN
	    
		





		
		IF PRM_DEFAULT = 'S' THEN
	        HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||PRM_DEFAULT||'"></span>');
		ELSE
		    HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||PRM_DEFAULT||'"></span>');
		END IF;
	
	WHEN 'ANO' THEN
		WS_COUNT := 2000;
		     HTP.FORMSELECTOPEN( CNAME => TRIM('id_'||PRM_TMP_FIELD||PRM_IND)||'ano_'||PRM_SUFIXO, CATTRIBUTES => ' id="'||TRIM('id_'||PRM_TMP_FIELD||PRM_IND)||'ano_'||PRM_SUFIXO||'id" onchange="document.getElementById('||CHR(39)||'id_'||PRM_TMP_FIELD||PRM_IND||CHR(39)||').value = document.getElementById('||CHR(39)||TRIM('id_'||PRM_TMP_FIELD||PRM_IND)||'ano_'||PRM_SUFIXO||'id'||CHR(39)||').options[document.getElementById('||CHR(39)||TRIM('id_'||PRM_TMP_FIELD||PRM_IND)||'ano_'||PRM_SUFIXO||'id'||CHR(39)||').selectedIndex].value; " ');
		     LOOP
		         IF  WS_COUNT > 2018 THEN
		             EXIT;
		         END IF;

		         IF  TO_NUMBER(NVL(PRM_DEFAULT,'')) = WS_COUNT THEN
		             FCL.FORMSELECTOPTION( WS_COUNT, WS_COUNT, CSELECTED => 'SELECTED');
		         ELSE
		             FCL.FORMSELECTOPTION( WS_COUNT, WS_COUNT);
		         END IF;
		         WS_COUNT := WS_COUNT + 1;
		     END LOOP;
     HTP.FORMSELECTCLOSE;
	ELSE
	    HTP.P('***');
END CASE;

END INPUTP;


PROCEDURE CHECKBOX (    PRM_CHKNAME	    VARCHAR2 DEFAULT NULL,
						PRM_CAMPO	    VARCHAR2 DEFAULT NULL,
						PRM_PROP	    VARCHAR2 DEFAULT NULL,
						PRM_CHK		    VARCHAR2 DEFAULT NULL,
						PRM_NCHK	    VARCHAR2 DEFAULT NULL,
						PRM_DEFAULT	    VARCHAR2 DEFAULT NULL,
						PRM_TMP_FIELD	VARCHAR2 DEFAULT NULL,
						PRM_ATTRIB      VARCHAR2 DEFAULT NULL,
						PRM_OBJETO      VARCHAR2 DEFAULT NULL ) AS

	WS_COMMAND_SCRIPT      VARCHAR2(2000);
	WS_SCRIP_EFEITO        VARCHAR2(2000);

BEGIN
    
    
    








    WS_SCRIP_EFEITO := FUN.ATTRIB_TEMPOREAL(PRM_ATTRIB, PRM_OBJETO);
    
	IF  PRM_PROP <> 'nocheck' THEN
	    WS_COMMAND_SCRIPT := ' onclick=" if(parent.document.getElementById('||CHR(39)||PRM_CAMPO||CHR(39)||')){ if (this.checked) { document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value='||CHR(39)||PRM_CHK||CHR(39)||'; } else { document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=''''; } ; }  " ';
	ELSE
	    WS_COMMAND_SCRIPT := ' onclick=" if (this.checked) { document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value = ''S''; } else { document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value = ''N''; }; " ';
	END IF;

	HTP.P('<input style="width: 14px;" type="checkbox" name="'||PRM_CHKNAME||'" '||FUN.IFNOTNULL(PRM_DEFAULT,' checked ')||WS_COMMAND_SCRIPT||' onchange="'||WS_SCRIP_EFEITO||'" >' );

END CHECKBOX;

PROCEDURE PICKCOLOR (  PRM_VALOR       VARCHAR2 DEFAULT NULL,
                       PRM_PLACEHOLDER VARCHAR2 DEFAULT NULL,
					   PRM_ID          VARCHAR2 DEFAULT NULL,
					   PRM_ATTRIB      VARCHAR2 DEFAULT NULL,
					   PRM_OBJ         VARCHAR2 DEFAULT NULL ) AS

    WS_SCRIP_EFEITO VARCHAR2(2000);
	WS_ID           VARCHAR2(80);

BEGIN

    WS_SCRIP_EFEITO := FUN.ATTRIB_TEMPOREAL(PRM_ATTRIB, PRM_OBJ);

    HTP.P('<input type="color" value="'||NVL(PRM_VALOR, '#111111')||'" oninput="this.nextElementSibling.value = this.value; '||WS_SCRIP_EFEITO||'" />');

	IF NVL(PRM_ID, 'N/A') <> 'N/A' THEN
		WS_ID := 'id="'||PRM_ID||'"';
	END IF;

	
	HTP.P('<input autocomplete="on" type="text" placeholder="'||PRM_PLACEHOLDER||'" title="'||FUN.LANG('DICA: pode ser usado transparent no campo de cor')||'" '||WS_ID||' style="width: 70px;" value="'||NVL(PRM_VALOR, '')||'" oninput="this.previousElementSibling.value = this.value; '||WS_SCRIP_EFEITO||'" />');

END PICKCOLOR;





PROCEDURE LISTLIG (	PRM_CAMPO	CHAR DEFAULT NULL,
					PRM_TMP_FIELD	CHAR DEFAULT NULL,
					PRM_SCRIPT	CHAR DEFAULT NULL,
					PRM_DEFAULT	CHAR DEFAULT NULL,
					PRM_LIST	CHAR DEFAULT NULL,
		            PRM_ORDEM   VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_CDESC IS
			SELECT NDS_CD_CODIGO, NDS_CD_EMPRESA, NDS_CD_DESCRICAO, NDS_TABELA, NDS_TFISICA
			FROM CODIGO_DESCRICAO
			WHERE	NDS_TABELA = UPPER(PRM_SCRIPT);

	WS_CDESC	CRS_CDESC%ROWTYPE;

	WS_CURSOR	INTEGER;
	WS_LINHAS	INTEGER;

	WS_CODIGO	VARCHAR2(30);
	WS_DESCRICAO	VARCHAR2(60);
	WS_PAR_EMP	VARCHAR2(180);

	WS_SQL		VARCHAR2(2000);

	WS_CONTADOR	NUMBER(2);
	WS_ZEBRADO	CHAR(20);
	WS_ACCESSO	EXCEPTION;

	WS_AGRUPADOR	LONG;
	WS_TEXTO	LONG;
	WS_TEXTOT	LONG;
	WS_NM_VAR	LONG;
	WS_CT_VAR	LONG;
	WS_LIMITADOR VARCHAR2(2000);
	WS_COUNT    NUMBER;

BEGIN
    
    OPEN  CRS_CDESC;
    FETCH CRS_CDESC INTO WS_CDESC;
    CLOSE CRS_CDESC;

    IF INSTR(PRM_CAMPO, 'FLOAT') > 0 THEN


		BEGIN
		    SELECT NVL(PROPRIEDADE, 'N/A') INTO WS_LIMITADOR FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_TMP_FIELD AND CD_PROP = 'LIMITADORES';
		EXCEPTION WHEN OTHERS THEN
		    WS_LIMITADOR := 'N/A';
		END;
		
		SELECT LENGTH(PROPRIEDADE) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(PRM_TMP_FIELD) AND CD_PROP = 'LIMITADORES';

		IF WS_LIMITADOR <> 'N/A' THEN
			IF  WS_CDESC.NDS_CD_EMPRESA='*' THEN
				WS_PAR_EMP := ' where '||RTRIM(WS_CDESC.NDS_CD_CODIGO)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||TRIM(PRM_TMP_FIELD)||''' and cd_prop = ''LIMITADORES''))))';
			ELSE
				WS_PAR_EMP := ' where '||RTRIM(WS_CDESC.NDS_CD_EMPRESA)||' = to_number(retorna_empresa) and '||RTRIM(WS_CDESC.NDS_CD_CODIGO)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||TRIM(PRM_TMP_FIELD)||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
			END IF;
		END IF;
	ELSE
		IF  WS_CDESC.NDS_CD_EMPRESA='*' THEN
			WS_PAR_EMP := '';
		ELSE
			WS_PAR_EMP := ' where '||RTRIM(WS_CDESC.NDS_CD_EMPRESA)||' = to_number(retorna_empresa)';
		END IF;
	END IF;

    WS_SQL := 'select '||RTRIM(WS_CDESC.NDS_CD_CODIGO)||', '||RTRIM(WS_CDESC.NDS_CD_DESCRICAO)||' from '||RTRIM(WS_CDESC.NDS_TFISICA)||WS_PAR_EMP||' '||PRM_ORDEM;

    WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

    DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
    DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 60);
    DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 60);

    WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

    WS_AGRUPADOR := SUBSTR(WS_TEXTO, 1 ,INSTR(WS_TEXTO,'|')-1);
    WS_TEXTO := SUBSTR(WS_TEXTO, INSTR(WS_TEXTO,'|')+1, LENGTH(WS_TEXTO));
    IF (PRM_CAMPO = 'NO_') THEN
	    HTP.P('<select onchange= "document.getElementById('''||PRM_TMP_FIELD||''').value=this.options[this.selectedIndex].value " >');
    ELSE
	    HTP.P('<select id="'||PRM_TMP_FIELD||'_ligacao" onchange="if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); }" data-turbo="'||PRM_TMP_FIELD||'_FILTER">');
    END IF;
    
    HTP.P('<option value="" style="display: none;">'||FUN.LANG('Sem Filtro')||'</option>');

    LOOP
		WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
		IF  WS_LINHAS <> 1 THEN EXIT; END IF;

		DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
		DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);

		HTP.P('<option value="'||TRIM(WS_CODIGO)||'" '||FPDATA(PRM_DEFAULT,TRIM(WS_CODIGO),'selected="selected"','')||'>'||WS_DESCRICAO||'</option>');
     END LOOP;
     DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
     HTP.P('</select>');

END LISTLIG;

PROCEDURE PICKFONT ( PRM_CAMPO	    VARCHAR2 DEFAULT NULL,
			         PRM_TMP_FIELD	VARCHAR2 DEFAULT NULL,
			         PRM_SCRIPT	    VARCHAR2 DEFAULT NULL,
			         PRM_DEFAULT	VARCHAR2 DEFAULT NULL,
			         PRM_ATTRIB     VARCHAR2 DEFAULT NULL,
			         PRM_OBJ        VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_FONT IS
		SELECT	CD_FONT
		FROM	FONTS;

	WS_FONT		     CRS_FONT%ROWTYPE;
	WS_SCRIP_EFEITO  VARCHAR2(2000);

BEGIN

    WS_SCRIP_EFEITO := FUN.ATTRIB_TEMPOREAL(PRM_ATTRIB, PRM_OBJ);
    
	HTP.P('<select name="'||PRM_CAMPO||'codefont" onchange="document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=this.options[this.selectedIndex].value; '||WS_SCRIP_EFEITO||'">');
		OPEN CRS_FONT;
		LOOP
			FETCH CRS_FONT INTO WS_FONT;
				EXIT WHEN CRS_FONT%NOTFOUND;
			    HTP.P('<option value="'||WS_FONT.CD_FONT||'" '||FPDATA(PRM_DEFAULT,WS_FONT.CD_FONT,'selected="selected"','')||'>'||WS_FONT.CD_FONT||'</option>');
		END LOOP;
		CLOSE CRS_FONT;
	HTP.P('</select>');

END PICKFONT;

PROCEDURE PICKFONTSIZE (PRM_CAMPO	CHAR DEFAULT NULL,
			PRM_TMP_FIELD	CHAR DEFAULT NULL,
			PRM_SCRIPT	CHAR DEFAULT NULL,
			PRM_DEFAULT	CHAR DEFAULT NULL ) AS


BEGIN
    
	HTP.P('<select name="'||PRM_CAMPO||'tamanho" onchange="document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=this.options[this.selectedIndex].value  ">');

	    HTP.P('<option value="10px" '||FPDATA(PRM_DEFAULT,'10px','selected="selected"','')||'>10px</option>');
		HTP.P('<option value="12px" '||FPDATA(PRM_DEFAULT,'12px','selected="selected"','')||'>12px</option>');
		HTP.P('<option value="14px" '||FPDATA(PRM_DEFAULT,'14px','selected="selected"','')||'>14px</option>');
		HTP.P('<option value="18px" '||FPDATA(PRM_DEFAULT,'18px','selected="selected"','')||'>18px</option>');
		HTP.P('<option value="22px" '||FPDATA(PRM_DEFAULT,'22px','selected="selected"','')||'>22px</option>');
		HTP.P('<option value="28px" '||FPDATA(PRM_DEFAULT,'28px','selected="selected"','')||'>28px</option>');
		HTP.P('<option value="36px" '||FPDATA(PRM_DEFAULT,'36px','selected="selected"','')||'>36px</option>');
		HTP.P('<option value="48px" '||FPDATA(PRM_DEFAULT,'48px','selected="selected"','')||'>48px</option>');
	HTP.P('</select>');
    

END PICKFONTSIZE;





PROCEDURE ENTRY (	PRM_CAMPO	    VARCHAR2 DEFAULT NULL,
					PRM_TMP_FIELD	VARCHAR2 DEFAULT NULL,
					PRM_SCRIPT	    VARCHAR2 DEFAULT NULL,
					PRM_DEFAULT	    VARCHAR2 DEFAULT NULL,
					PRM_LIST	    VARCHAR2 DEFAULT NULL,
					PRM_TIPO	    VARCHAR2 DEFAULT 'TEXT',
					PRM_OBJETO      VARCHAR2 DEFAULT NULL,
					PRM_ATRIB       VARCHAR2 DEFAULT NULL  ) AS

    WS_SCRIP_EFEITO VARCHAR2(2000);
	WS_CUSTOM_STYLE VARCHAR2(2000);
	WS_EXIST        NUMBER;

BEGIN
    
    
    















    
    WS_SCRIP_EFEITO := FUN.ATTRIB_TEMPOREAL(PRM_ATRIB, PRM_OBJETO);
    IF TRIM(PRM_ATRIB) = 'ORDEM' THEN
	    WS_CUSTOM_STYLE := 'position: absolute;';
	END IF;
	
	WS_EXIST := 0;
	
	IF TRIM(PRM_ATRIB) = 'FIXED-N' THEN
		WS_EXIST := LENGTH(TRIM(FUN.GETPROP(PRM_OBJETO, 'TOTAL_GERAL_TEXTO')));
	END IF;
	
	IF WS_EXIST > 0 THEN
	    HTP.P('<input class="readonly" readonly="" style="'||WS_CUSTOM_STYLE||'" data-atrib="'||PRM_ATRIB||'" title="'||PRM_DEFAULT||'" type="'||PRM_TIPO||'" name="'||PRM_CAMPO||'" value="99" onblur="if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); } if(document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||')){ document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=this.value; } " onkeyup="'||WS_SCRIP_EFEITO||'" />' );
    ELSE
		HTP.P('<input data-exist="'||WS_EXIST||'" style="'||WS_CUSTOM_STYLE||'" data-atrib="'||PRM_ATRIB||'" title="'||PRM_DEFAULT||'" type="'||PRM_TIPO||'" name="'||PRM_CAMPO||'" value="'||PRM_DEFAULT||'" onblur="if(this.parentNode.parentNode.id == ''form-parametro''){ this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T''); } if(document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||')){ document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=this.value; }" onkeyup="'||WS_SCRIP_EFEITO||'" />' );
	END IF;

END ENTRY;



PROCEDURE BASET	(		J_BASE		CHAR	DEFAULT NULL ) AS

BEGIN
	HTP.PRINT('<BASE target="'||RTRIM(J_BASE)||'">');

END BASET;



PROCEDURE PDATA (		PRM_MODE	VARCHAR2 DEFAULT NULL,
				PRM_CHECK	VARCHAR2 DEFAULT NULL,
				PRM_DATA	VARCHAR2 DEFAULT NULL,
				PRM_OTHER	VARCHAR2 DEFAULT NULL )  AS

BEGIN
    IF  PRM_MODE = PRM_CHECK THEN
	    HTP.P(PRM_DATA);
	ELSE
	    HTP.P(PRM_OTHER);
	END IF;

END PDATA;

FUNCTION FPDATA (  PRM_MODE	 VARCHAR2 DEFAULT NULL,
				   PRM_CHECK VARCHAR2 DEFAULT NULL,
				   PRM_DATA	 VARCHAR2 DEFAULT NULL,
				   PRM_OTHER VARCHAR2 DEFAULT NULL )   RETURN VARCHAR2 AS

BEGIN
	IF  PRM_MODE = PRM_CHECK THEN
	    RETURN(PRM_DATA);
	ELSE
	    RETURN(PRM_OTHER);
	END IF;

END FPDATA;


FUNCTION FDATALINK ( 		PRM_GIF		VARCHAR2 DEFAULT NULL,
				PRM_LINK	VARCHAR2 DEFAULT NULL,
				PRM_TYPE	VARCHAR2 DEFAULT 'GIF',
				PRM_ALT		VARCHAR2 DEFAULT NULL,
				PRM_PANEL	VARCHAR2 DEFAULT 'COLUNA',
				PRM_FORM	VARCHAR2 DEFAULT NULL,
				PRM_SELECT	VARCHAR2 DEFAULT NULL,
				PRM_URL		VARCHAR2 DEFAULT NULL,
				PRM_COMANDO     VARCHAR2 DEFAULT NULL ) RETURN VARCHAR2 AS

BEGIN
    
	IF  PRM_PANEL = 'SIMPLES' THEN
	    RETURN('<a href="'||PRM_LINK||'">'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE )));
	ELSE
	IF  PRM_GIF = 'NOGIF' THEN
	    RETURN('<a href="'||PRM_URL||'">'||PRM_LINK||'</A>');
	ELSE
	    IF  NVL(PRM_FORM,'NODATA') <> 'NODATA' THEN
		RETURN(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CALT => PRM_ALT,  CATTRIBUTES => 'onclick="document.location.href='''||PRM_URL||'&prm_comando='||PRM_COMANDO||'|'||'''+document.'||PRM_FORM||'.'||PRM_SELECT||'.options[document.'||PRM_FORM||'.'||PRM_SELECT||'.selectedIndex].value;" border="0" ')||'</a>','center','','','','','border="0" width="1%" '));
	    ELSE
		IF  PRM_PANEL = 'COLUNA' THEN
		    RETURN(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CALT => PRM_ALT,  CATTRIBUTES => 'border="0" ')||'</A>','center','','','','','border="0" width="1%" '));
		ELSE
		    RETURN('<a href="'||PRM_LINK||'">'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CATTRIBUTES => 'border="0" '));
		END IF;
	    END IF;
	END IF;
	END IF;

END FDATALINK;

PROCEDURE XDATALINK ( 		PRM_GIF		VARCHAR2 DEFAULT NULL,
				PRM_LINK	VARCHAR2 DEFAULT NULL,
				PRM_TYPE	VARCHAR2 DEFAULT 'GIF',
				PRM_ALT		VARCHAR2 DEFAULT NULL,
				PRM_POSITIONS	VARCHAR2 DEFAULT NULL,
				PRM_URL		VARCHAR2 DEFAULT NULL,
				PRM_COMANDO     VARCHAR2 DEFAULT NULL ) AS

BEGIN
		HTP.P(HTF.TABLEDATA( '<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CALT => PRM_ALT, CATTRIBUTES => ' border="0" onclick="document.location.href='''||PRM_URL||'&prm_locais='''||PRM_POSITIONS||';" ')|| '</a>','center','','','','',' border="0" width="0%" '));

END XDATALINK;


PROCEDURE RURL ( 	PRM_PARAMETROS		VARCHAR2 DEFAULT NULL,
			PRM_MICRO_VISAO		VARCHAR2 DEFAULT NULL,
			PRM_COLUNA		VARCHAR2 DEFAULT NULL,
			PRM_AGRUPADOR		VARCHAR2 DEFAULT NULL,
			PRM_RP			VARCHAR2 DEFAULT 'ROLL',
			PRM_COLUP		VARCHAR2 DEFAULT NULL,
			PRM_COMANDO		VARCHAR2 DEFAULT NULL,
			PRM_OBJID		VARCHAR2 DEFAULT NULL,
			PRM_CCOUNT		VARCHAR2 DEFAULT '0' ) AS

	WS_URL_DEFAULT			LONG;
	WS_COLUP			LONG;
	WS_COLUNA			LONG;
	WS_AGRUPADOR			LONG;
	WS_RP				LONG;
	WS_MODE				LONG;

BEGIN
	WS_COLUP     := PRM_COLUP;
	WS_COLUNA    := PRM_COLUNA;
	WS_AGRUPADOR := PRM_AGRUPADOR;
	WS_RP	     := PRM_RP;
	WS_MODE	     := 'ED';

	HTP.P('<script>');
	HTP.P(' if  (parent.document.getElementById(''cutflag'').value == ''PASS'') {');
	HTP.P('parent.document.getElementById('||CHR(39)||'par_'||PRM_OBJID||CHR(39)||').value='||CHR(39)||PRM_PARAMETROS||CHR(39)||';');
	HTP.P('parent.document.getElementById('||CHR(39)||'mvs_'||PRM_OBJID||CHR(39)||').value='||CHR(39)||PRM_MICRO_VISAO||CHR(39)||';');
	HTP.P('parent.document.getElementById('||CHR(39)||'col_'||PRM_OBJID||CHR(39)||').value='||CHR(39)||WS_COLUNA||CHR(39)||';');
	HTP.P('parent.document.getElementById('||CHR(39)||'agp_'||PRM_OBJID||CHR(39)||').value='||CHR(39)||WS_AGRUPADOR||CHR(39)||';');
	HTP.P('parent.document.getElementById('||CHR(39)||'rps_'||PRM_OBJID||CHR(39)||').value='||CHR(39)||WS_RP||CHR(39)||';');
	HTP.P('parent.document.getElementById('||CHR(39)||'cup_'||PRM_OBJID||CHR(39)||').value='||CHR(39)||WS_COLUP||CHR(39)||';');
	HTP.P('parent.document.getElementById('||CHR(39)||'cutflag'||CHR(39)||').value='||CHR(39)||'STOP'||CHR(39)||';');
	HTP.P('}');
	HTP.P('</script>');
	HTP.P('OK');

END RURL;





PROCEDURE ARRGETPROP (	PRM_OBJETO	CHAR DEFAULT NULL,
						PRM_CD_PROP	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_PROP	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_ROTULO	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_TIPO	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_SUFIXO	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_SCRIPT	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_LIST	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_GRUPO	IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_HINT    IN OUT DBMS_SQL.VARCHAR2_TABLE,
						PRM_ORDEM   IN OUT DBMS_SQL.NUMBER_TABLE,
						PRM_SCREEN VARCHAR2 DEFAULT 'DEFAULT' ) AS

	CURSOR CRS_ATTRIB IS
		SELECT	T1.CD_PROP, T1.LABEL, T1.CD_TIPO, NVL(T2.VL_DEFAULT, T1.VL_DEFAULT) VL_DEFAULT, T1.SUFIXO, T1.SCRIPT, T1.VALIDACAO, T1.GRUPO, T1.HINT, T1.ORDEM
		FROM	OBJETOS, BI_OBJECT_PADRAO T1 
		LEFT JOIN
		OBJECT_PADRAO T2 ON T2.CD_PROP = T1.CD_PROP AND T2.TP_OBJETO = T1.TP_OBJETO
		WHERE	CD_OBJETO = PRM_OBJETO AND
			OBJETOS.TP_OBJETO IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(T1.TP_OBJETO(+))))
			
		AND NVL(T1.SUFIXO, 'N/A') <> 'N/A'
		ORDER BY T1.GRUPO, T1.CD_TIPO, T1.ORDEM, T1.LABEL;

	WS_ATTRIB	CRS_ATTRIB%ROWTYPE;
	WS_COUNT	NUMBER;
	WS_DEFAULT	VARCHAR2(4000);

BEGIN
    
	WS_COUNT := 0;

	OPEN CRS_ATTRIB;
	LOOP
		FETCH CRS_ATTRIB INTO WS_ATTRIB;
			EXIT WHEN CRS_ATTRIB%NOTFOUND;

		WS_COUNT := WS_COUNT + 1;

		IF WS_ATTRIB.CD_PROP = 'DASH_MARGIN' THEN
		    WS_DEFAULT := FUN.GETPROP(PRM_OBJETO,WS_ATTRIB.CD_PROP, PRM_SCREEN);
		ELSIF WS_ATTRIB.CD_PROP = 'ORDEM' THEN
		    WS_DEFAULT := FUN.GETPROP(PRM_OBJETO,WS_ATTRIB.CD_PROP, PRM_USUARIO => GBL.GETUSUARIO);
		ELSE
		    WS_DEFAULT := FUN.GETPROP(PRM_OBJETO,WS_ATTRIB.CD_PROP);
		END IF;
		WS_DEFAULT := FCL.FPDATA(WS_DEFAULT,'',WS_ATTRIB.VL_DEFAULT,WS_DEFAULT);

		PRM_CD_PROP(WS_COUNT) := WS_ATTRIB.CD_PROP;
		PRM_PROP(WS_COUNT)    := WS_DEFAULT;
		PRM_ROTULO(WS_COUNT)  := WS_ATTRIB.LABEL;
		PRM_TIPO(WS_COUNT)    := WS_ATTRIB.CD_TIPO;
		PRM_SUFIXO(WS_COUNT)  := WS_ATTRIB.SUFIXO;
		PRM_SCRIPT(WS_COUNT)  := WS_ATTRIB.SCRIPT;
		PRM_LIST(WS_COUNT)    := WS_ATTRIB.VALIDACAO;
		PRM_GRUPO(WS_COUNT)   := WS_ATTRIB.GRUPO;
		PRM_HINT(WS_COUNT)    := WS_ATTRIB.HINT;
		PRM_ORDEM(WS_COUNT)   := WS_ATTRIB.ORDEM;

	END LOOP;
	CLOSE CRS_ATTRIB;

END ARRGETPROP;

PROCEDURE KEYWORDS AS

BEGIN


    HTP.P('<script>');
	    HTP.PRN('const ');
		FOR I IN(SELECT CD_CONSTANTE, VL_CONSTANTE FROM BI_CONSTANTES) LOOP
			HTP.PRN(I.CD_CONSTANTE||' = "'||FUN.LANG(I.VL_CONSTANTE)||'", ');
		END LOOP;
		HTP.PRN('TR_END = "";');
	HTP.P('</script>');

	HTP.P('<style>ul#filterlist::after { content: "'||FUN.LANG('FILTROS')||'"; } ul#destaquelist::after { content: "'||FUN.LANG('DESTAQUES')||'"; }</style>');

exception
  when others then
  	htp.p('<span> Erro ao gerar as constantes do sistema. </span>');
  	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
	insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' PROCEDURE KEYWORDS - ','DWU','ERRO');

END KEYWORDS;


PROCEDURE POSICIONA_OBJETO	( PRM_OBJETO	CHAR	DEFAULT NULL,
				  PRM_USUARIO   CHAR    DEFAULT NULL,
				  PRM_SCREEN	CHAR	DEFAULT NULL,
				  PRM_BROWSER   CHAR    DEFAULT 'DEFAULT' ) AS

	CURSOR CRS_OBJECT_LOCATION IS
		SELECT	POSX, POSY, NVL(ZINDEX,'auto') AS ZINDEX
		FROM	OBJECT_LOCATION
		WHERE	OWNER = PRM_USUARIO AND
			NAVEGADOR = PRM_BROWSER AND
			SCREEN    = PRM_SCREEN AND
			OBJECT_ID = PRM_OBJETO;

	WS_LOCATION			CRS_OBJECT_LOCATION%ROWTYPE;

BEGIN
    
	OPEN CRS_OBJECT_LOCATION;
	LOOP
		FETCH CRS_OBJECT_LOCATION INTO WS_LOCATION;
			EXIT WHEN CRS_OBJECT_LOCATION%NOTFOUND;
		HTP.PRINT( '<script> moveinit(document.getElementById('''||PRM_OBJETO||'''),'''||WS_LOCATION.POSX||''','''||WS_LOCATION.POSY||''','''||WS_LOCATION.ZINDEX||''');</script>' );
	END LOOP;
	CLOSE CRS_OBJECT_LOCATION;

END POSICIONA_OBJETO;





PROCEDURE SALVA_POSICAO	( PRM_OBJETO VARCHAR2 DEFAULT NULL,
			              PRM_SCREEN VARCHAR2 DEFAULT NULL,
				          PRM_POSX   VARCHAR2 DEFAULT '0',
				          PRM_POSY   VARCHAR2 DEFAULT '0',
				          PRM_ZINDEX VARCHAR2 DEFAULT NULL,
						  PRM_TIPO   VARCHAR2 DEFAULT 'posicao' ) AS

BEGIN
    
	IF PRM_TIPO = 'posicao' THEN
		IF INSTR(PRM_OBJETO, 'ARTICLE') > 0 THEN
			IF LENGTH(PRM_ZINDEX) > 0 THEN
				UPDATE OBJECT_LOCATION SET ZINDEX = PRM_ZINDEX
				WHERE	OWNER = 'DWU' AND
					NAVEGADOR = 'DEFAULT' AND
					SCREEN = PRM_SCREEN AND
					OBJECT_ID = PRM_OBJETO;
			END IF;
			IF LENGTH(PRM_POSY) > 0 THEN
				UPDATE OBJECT_LOCATION SET POSY = PRM_POSY
				WHERE	OWNER = 'DWU' AND
					NAVEGADOR = 'DEFAULT' AND
					SCREEN = PRM_SCREEN AND
					OBJECT_ID = PRM_OBJETO;
			END IF;
			COMMIT;
		ELSIF INSTR(PRM_OBJETO, 'SECTION') > 0 THEN
			UPDATE OBJECT_LOCATION SET ZINDEX = PRM_ZINDEX
				WHERE	OWNER = 'DWU' AND
					NAVEGADOR = 'DEFAULT' AND
					SCREEN = PRM_SCREEN AND
					OBJECT_ID = PRM_OBJETO;
			COMMIT;
		ELSE
			UPDATE OBJECT_LOCATION SET POSX = PRM_POSX, POSY = PRM_POSY, ZINDEX = PRM_ZINDEX
				WHERE	OWNER = 'DWU' AND
					NAVEGADOR = 'DEFAULT' AND
					SCREEN = PRM_SCREEN AND
					OBJECT_ID = PRM_OBJETO;
			COMMIT;
		END IF;
	ELSIF PRM_TIPO = 'porcentagem' THEN
			UPDATE OBJECT_LOCATION SET PORCENTAGEM = PRM_ZINDEX
			WHERE	OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				SCREEN = PRM_SCREEN AND
				OBJECT_ID = PRM_OBJETO;
			COMMIT;
		
	ELSE
	    UPDATE OBJECT_LOCATION SET POSX = PRM_POSX
			WHERE	OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				SCREEN = PRM_SCREEN AND
				OBJECT_ID = PRM_OBJETO;
			COMMIT;
	END IF;
EXCEPTION WHEN OTHERS THEN
    ROLLBACK;
	HTP.P(SQLERRM);
END SALVA_POSICAO;


PROCEDURE SETPOS( PRM_LOCAIS	CHAR	DEFAULT NULL ) AS

	WS_TEXTOT	LONG;
	WS_OBJETO	LONG;
	WS_POSX		LONG;
	WS_POSY		LONG;
	WS_CHECK	VARCHAR2(60);
	WS_FORMAT	CHAR(1);

BEGIN
    
	WS_TEXTOT := PRM_LOCAIS;
	WS_FORMAT := 'V';

	IF  FUN.SETEM(PRM_LOCAIS,'||') THEN
	    WS_FORMAT := 'I';
	    HTP.P('XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX');
	END IF;

	LOOP
	    IF  WS_TEXTOT = 'Y' OR INSTR(WS_TEXTOT,'|') = 0 OR WS_FORMAT = 'I' THEN
	        EXIT;
	    END IF;

	    WS_OBJETO := SUBSTR(WS_TEXTOT, 1 ,INSTR(WS_TEXTOT,'|')-1);
	    WS_TEXTOT := REPLACE(WS_TEXTOT, WS_OBJETO||'|', '');

	    WS_POSX := SUBSTR(WS_TEXTOT, 1 ,INSTR(WS_TEXTOT,'|')-1);
	    WS_TEXTOT := REPLACE(WS_TEXTOT, WS_POSX||'|', '');

	    WS_POSY := SUBSTR(WS_TEXTOT, 1 ,INSTR(WS_TEXTOT,'|')-1);
	    WS_TEXTOT := REPLACE(WS_TEXTOT, WS_POSY||'|', '');

	    IF  INSTR(WS_TEXTOT,'|') = 0 THEN
		WS_POSY := WS_TEXTOT;
		WS_TEXTOT := 'Y';
	    END IF;

	    BEGIN
		SELECT	NAVEGADOR INTO WS_CHECK
		FROM	OBJECT_LOCATION
		WHERE	OWNER = FUN.WHO AND
			NAVEGADOR = 'DEFAULT' AND
			OBJECT_ID = WS_OBJETO;
		UPDATE  OBJECT_LOCATION SET POSX = WS_POSX, POSY = WS_POSY
		WHERE	OWNER = FUN.WHO AND
			NAVEGADOR = 'DEFAULT' AND
			OBJECT_ID = WS_OBJETO;
	    EXCEPTION
	    WHEN OTHERS	THEN
		INSERT INTO OBJECT_LOCATION VALUES ('DWU','DEFAULT', 'erro', WS_OBJETO, WS_POSX, WS_POSY, 'auto', '0');
	    END;

	    COMMIT;

	END LOOP;

END SETPOS;

PROCEDURE INICIAR ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

    WS_PADRAO      VARCHAR2(40);
	WS_SHOW_ONLY   VARCHAR2(1);
	WS_COR_DEFAULT VARCHAR2(10);
	WS_URL_DEFAULT VARCHAR2(800);
	WS_CSS         VARCHAR2(80);
	WS_USUARIO     VARCHAR2(80);
    WS_ADMIN       VARCHAR2(80);
	WS_COUNT       NUMBER;
	WS_TEST 	   VARCHAR2(200);

	WS_NOUSER      EXCEPTION;

	BEGIN

	    WS_USUARIO := GBL.GETUSUARIO;
		WS_ADMIN   := NVL(GBL.GETNIVEL, 'N');
	    
		BEGIN
			SELECT NVL(SHOW_ONLY, 'N') INTO WS_SHOW_ONLY FROM USUARIOS WHERE USU_NOME = WS_USUARIO;
		EXCEPTION WHEN OTHERS THEN
			WS_SHOW_ONLY := 'X';
		END;
		IF FUN.CHECK_SYS <> 'LOCK_SYS' AND WS_SHOW_ONLY <> 'X' THEN
	    IF FUN.CHECK_NETWALL(WS_USUARIO) AND FUN.CHECK_USER(WS_USUARIO) THEN
			IF OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') LIKE '%MSIE 6.0%' THEN
				HTP.P('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			ELSIF OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') LIKE '%MSIE 7.0%' THEN
				HTP.P('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			ELSIF OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') LIKE '%MSIE 8.0%' THEN
				HTP.P('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			ELSIF OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') LIKE '%MSIE 9.0%' THEN
				HTP.P('Seu navegador esta desatualizado! Atualize para uma vers&atilde;o mais recente, ou altere para um navegador com mais recursos.');
			ELSE

			    HTP.P('<!DOCTYPE html>');

			    HTP.P('<html id="html" oncontextmenu="donut(event); return false;">');

				HTP.P('<head>');

					BEGIN
					    SELECT FUN.GETPROP('DEFAULT','TEMA', PRM_USUARIO => WS_USUARIO) INTO WS_CSS FROM DUAL;
						HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo='||NVL(WS_CSS, 'ideativo')||'.css">');
					EXCEPTION WHEN OTHERS THEN
                        HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo=ideativo.css">');
						WS_CSS := 'ideativo';
					END;

					
					
				    HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo=default-min.css">');
					
					HTP.P('<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />');
					HTP.P('<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />');
                    HTP.P('<meta name="google" content="notranslate" />');
					HTP.P('<meta name="theme-color" content="#9a9a9a"/>');
					HTP.P('<title>UpQuery</title>');

					FCL.KEYWORDS;

					IF WS_ADMIN = 'A' THEN
					    FCL.VERIFICA_JOB;
					END IF;

					HTP.P('<meta http-equiv="Pragma" content="no-cache"/>');
					HTP.P('<meta http-equiv="Expires" content="timestamp"/>');
					HTP.P('<meta http-equiv="cache-control" content="max-age=0" />');
					HTP.P('<meta http-equiv="cache-control" content="no-cache" />');
					HTP.P('<meta name="apple-mobile-web-app-capable" content="yes" />');
					HTP.P('<meta name="mobile-web-app-capable" content="yes" />');
					HTP.P('<meta name="viewport" content="width=device-width,user-scalable=no, initial-scale=1">');
					HTP.P('<link rel="favicon" type="image/png" href="'||FUN.R_GIF('upquery-icon','PNG')||'" />');
					HTP.P('<link rel="icon" type="image/png" href="'||FUN.R_GIF('ipad','PNG')||'" />');
					HTP.P('<link rel="shortcut icon apple-touch-icon" href="'||FUN.R_GIF('ipad','PNG')||'" />');
					HTP.P('<link rel="apple-touch-icon" href="'||FUN.R_GIF('ipad','PNG')||'" />');
					HTP.P('<link rel="apple-touch-startup-image" href="'||FUN.R_GIF('logo','PNG')||'">');
					HTP.P('<link rel="json" href="dwu.fcl.download?arquivo=manifest.json">');
					HTP.P('<meta name="apple-mobile-web-app-status-bar-style" content="black">');
					IF NVL(PRM_SCREEN, 'N/A') <> 'N/A' THEN
					    HTP.P('<script>setTimeout(function(){ if(!document.getElementById(''starting'')){ shscr('''||PRM_SCREEN||'''); } else { tempoteste = setInterval(function(){ if(!document.getElementById(''starting'')){ clearInterval(tempoteste); shscr('''||PRM_SCREEN||'''); } }, 500); } document.getElementById(''main'').style.setProperty(''background-color'', ''transparent''); }, 3800);</script>');
					END IF;
				HTP.HEADCLOSE;

				BEGIN
				    IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
				        SELECT NVL(COR_FUNDO, '#FFFFFF'), NVL(URL_FUNDO, FUN.R_GIF('bg','JPG')) INTO WS_COR_DEFAULT, WS_URL_DEFAULT FROM ALL_SCREENS WHERE SCREEN = 'DEFAULT' AND ROWNUM = 1;
				    ELSE
                        SELECT NVL(COR_FUNDO, '#FFFFFF'), NVL(URL_FUNDO, FUN.R_GIF('bg','WEBP')) INTO WS_COR_DEFAULT, WS_URL_DEFAULT FROM ALL_SCREENS WHERE SCREEN = 'DEFAULT' AND ROWNUM = 1;
					END IF;
				EXCEPTION WHEN OTHERS THEN
				    WS_COR_DEFAULT := '#FFFFFF';
					IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
					    WS_URL_DEFAULT := FUN.R_GIF('bg','JPG');
					ELSE
                        if (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'Android') <> 0) or (instr(owa_util.get_cgi_env('HTTP_USER_AGENT'), 'iPhone') <> 0) then
						
							ws_url_default := fun.r_gif('bg','JPG');

						else 
                        	ws_url_default := fun.r_gif('bg','WEBP');

						end if;				
					END IF;
				END;

				BEGIN
				    WS_URL_DEFAULT := FUN.SUBPAR(WS_URL_DEFAULT, 'DEFAULT');
				EXCEPTION WHEN OTHERS THEN
                    WS_URL_DEFAULT := WS_URL_DEFAULT;
                END;

				HTP.P('<body id="princp" class="slide-'||WS_SHOW_ONLY||'" onload="start();">');
				
                    HTP.P('<div id="extra">');

						HTP.P('<input type="hidden" name="moviment" id="movimento" value="yes" />');
						HTP.P('<input type="hidden" name="current_sc" id="current_screen" value="DEFAULT" />');
						HTP.P('<input type="hidden" id="usuario" value="'||WS_USUARIO||'" />');
						HTP.P('<input type="hidden" id="admin" value="'||WS_ADMIN||'" />');
						
						HTP.P('<input type="hidden" name="ndrobj" id="drill_obj" value="NOC" />');
						HTP.P('<input type="hidden" name="reconx" id="refcon" value="N" />');
						HTP.P('<input type="hidden" name="ndrtogo" id="drill_go" value="" />');
						HTP.P('<input type="hidden" name="ndrobjx" id="drill_x" value="" />');
						HTP.P('<input type="hidden" name="ndrobjy" id="drill_y" value="" />');
						HTP.P('<input type="hidden" name="ndrshow" id="drill_show" value="" />');
						
                        
						HTP.P('<input type="hidden" name="agent" id="agent" value="'||OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT')||'" />');

						IF WS_SHOW_ONLY = 'S' THEN
							FOR I IN(SELECT SCREEN, TIME FROM USER_SEQUENCE T1 WHERE USUARIO = WS_USUARIO ORDER BY ORDEM) LOOP
								HTP.P('<input type="hidden" class="show_only" value="'||I.SCREEN||'" data-time="'||I.TIME||'" />');
							END LOOP;
						END IF;

						BEGIN
							SELECT NVL(CONTEUDO, 'PORTUGUESE') INTO WS_PADRAO
							FROM   PARAMETRO_USUARIO
							WHERE  CD_USUARIO = WS_USUARIO AND
							CD_PADRAO='CD_LINGUAGEM';
						EXCEPTION WHEN OTHERS THEN
							WS_PADRAO := 'PORTUGUESE';
						END;

						HTP.P('<input type="hidden" id="xe" value="'||NVL(FUN.RET_VAR('XE'), 'N')||'">');

						HTP.P('<input type="hidden" id="user-language" value="'||WS_PADRAO||'">');
						HTP.P('<input type="hidden" id="sys-language" value="'||FUN.RET_VAR('LANG_SYS')||'">');
						HTP.P('<div id="layer">');
							HTP.P('<div class="layer-fundo"></div>');
							HTP.P('<div class="layer-spin spin5"></div>');
							HTP.P('<div class="layer-spin spin4"></div>');
							HTP.P('<div class="layer-spin spin3"></div>');
							HTP.P('<div class="layer-spin spin2"></div>');
							HTP.P('<div class="layer-spin spin1"></div>');
							HTP.P('<div class="layer-icon"></div>');
					
							HTP.P('<a title="'||FUN.LANG('Cancelar')||'" onclick=" try { window.stop(); var layer = document.getElementById(''layer''); layer.children[1].classList.remove(''visivel'');  layer.children[0].classList.remove(''open''); layer.children[2].classList.remove(''open''); alerta(''feed-fixo'', '''||FUN.LANG('Carregamento dos objetos foi interrompido!')||'''); if(document.getElementById(''layer'').className == ''ativo''){ loading(); } } catch(e){ document.execCommand(''Stop'', false); document.getElementById(''layer'').setAttribute(''class'',''''); } ">X</a>');
						HTP.P('</div>');

                        IF NVL(WS_SHOW_ONLY, 'N') <> 'S' THEN
						    FCL.USERINFO;
						END IF;

						HTP.P('<div id="obs-field"></div>');

						HTP.P('<div id="text-talk" class="" data-objeto="" data-line="" onmouseleave="if(event.relatedTarget != null){ clearInterval(textTalk); }">');
							HTP.P('<div class="list_container">');
								
							HTP.P('</div>');
							
							HTP.P('<div class="chat_container">');
								HTP.P('<h4>'||FUN.LANG('MENSAGENS')||'</h4>');
								HTP.P('<ul id="campo"></ul>');
								HTP.P('<input id="fieldmsg" type="text" placeholder="'||FUN.LANG('Digite a mensagem')||'" onkeypress=" if(event.which == 13){ send_textPost(this.parentNode.getAttribute(''data-objeto''), this.parentNode.getAttribute(''data-line'')); }" />');
								
								HTP.P('<div class="talk-block">');
									HTP.P('<a class="script" onclick="ajax(''list'', ''text_post'', ''prm_objeto=&prm_line=&prm_group=''+this.nextElementSibling.title, true, ''campo'');"></a>');
									FCL.FAKEOPTION('usuario-msg', FUN.LANG('Lista de usu&aacute;rios'), '', 'lista-usuarios-msgs', 'N', 'N');
									FCL.FAKEOPTION('tempo-msg', FUN.LANG('Tempo da mensagem'), '', 'lista-msg-tempo', 'N', 'N');
								HTP.P('</div>');

								HTP.P('<div style="width: 100%; display: flex; margin: 10px 0;">');
								
									HTP.P('<a class="addpurple" onclick="send_textPost('', '');">'||FUN.LANG('ENVIAR MENSAGEM')||'</a>');
									
									
									HTP.P('<img id="sendmail" onclick="this.classList.toggle(''selected'');" src="'||FUN.R_GIF('email','PNG')||'" />');
									HTP.P('<img id="sendsms" onclick="this.classList.toggle(''selected'');" src="'||FUN.R_GIF('cell','PNG')||'" />');

									
									
									
									
								HTP.P('</div>');
							HTP.P('</div>');


						HTP.P('</div>');

						FCL.PERFIL;

						FCL.FLOAT_MENU(PRM_SCREEN);

						IF WS_ADMIN = 'A' THEN
							HTP.P('<div id="screenres">');
								HTP.P('<div class="s1920"><span>1920x1080(iphone6+)</span></div>');
								HTP.P('<div class="s1334"><span>1334x750(iphone6)</span></div>');
								HTP.P('<div class="s1280"><span>1280x720</span></div>');
								HTP.P('<div class="s1136"><span>1136x640(iphone5)</span></div>');
								HTP.P('<div class="s1024"><span>1024x768(ipad)</span></div>');
								HTP.P('<div class="s960"><span>960x640(iphone4)</span></div>');
							HTP.P('</div>');
							HTP.P('<div id="rule"></div>');
						END IF;
						HTP.P('<div style="z-index: 5; position: fixed; top: 3px; left: 90px;">');
							HTP.P('<a id="float-icon" title="'||FUN.LANG('Parametro')||'" class="invisible" onclick="loadAttrib(''get_float'', ''prm_screen=''+tela);"><svg fill="#AAAAAA" enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="user_x5F_close_x5F_settings"><path d="M32,23c-0.002-4.973-4.029-9-9-9c-0.025,0-0.049,0.003-0.074,0.004C23.608,12.826,24,11.459,24,10c0-4.418-3.582-8-8-8   c-4.418,0-8,3.582-8,8c0,4.26,3.332,7.732,7.531,7.977c-0.419,0.622-0.753,1.304-1.008,2.023H4c-4,0-4,4-4,4v8h32v-8   C32,24,32,23.207,32,23z M29.883,23c-0.009,3.799-3.084,6.874-6.883,6.883c-3.801-0.009-6.876-3.084-6.885-6.883   c0.009-3.801,3.084-6.876,6.885-6.884C26.799,16.124,29.874,19.199,29.883,23z"/><path d="M28,24v-2.001h-1.663c-0.063-0.212-0.145-0.413-0.245-0.606l1.187-1.187l-1.416-1.415l-1.165,1.166   c-0.22-0.123-0.452-0.221-0.697-0.294V18h-2v1.662c-0.229,0.068-0.446,0.158-0.652,0.27l-1.141-1.14l-1.415,1.415l1.14,1.14   c-0.112,0.207-0.202,0.424-0.271,0.653H18v2h1.662c0.073,0.246,0.172,0.479,0.295,0.698l-1.165,1.163l1.413,1.416l1.188-1.187   c0.192,0.101,0.394,0.182,0.605,0.245V28H24v-1.665c0.229-0.068,0.445-0.158,0.651-0.27l1.212,1.212l1.414-1.416l-1.212-1.21   c0.111-0.206,0.201-0.423,0.27-0.651H28z M22.999,24.499c-0.829-0.002-1.498-0.671-1.501-1.5c0.003-0.829,0.672-1.498,1.501-1.501   c0.829,0.003,1.498,0.672,1.5,1.501C24.497,23.828,23.828,24.497,22.999,24.499z"/></g></svg></a>');
							HTP.P('<a id="float-icon-filter" title="'||FUN.LANG('Parametro de filtro')||'" class="invisible" onclick=""><svg fill="#AAAAAA" enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="user_x5F_close_x5F_information"><path d="M32,23c-0.002-4.973-4.029-9-9-9c-0.025,0-0.049,0.003-0.074,0.004C23.608,12.826,24,11.459,24,10c0-4.418-3.582-8-8-8   c-4.418,0-8,3.582-8,8c0,4.26,3.332,7.732,7.531,7.977c-0.419,0.622-0.753,1.304-1.008,2.023H4c-4,0-4,4-4,4v8h32v-8   C32,24,32,23.207,32,23z M29.883,23c-0.009,3.799-3.084,6.874-6.883,6.883c-3.801-0.009-6.876-3.084-6.885-6.883   c0.009-3.801,3.084-6.876,6.885-6.884C26.799,16.124,29.874,19.199,29.883,23z"/><path d="M22,28h2v-6h-2V28z M22,18v2h2v-2H22z"/></g></svg></a>');
							HTP.P('<a id="back"  title="'||FUN.LANG('Voltar')||'" class="invisible" onclick="this.className = ''invisible''; shscr(this.getAttribute(''data-screen'')); this.setAttribute(''data-screen'', '''');"><svg enable-background="new 0 0 32 32" fill="#AAAAAA" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="arrow_x5F_full_x5F_left"><polygon points="16,2.001 16,10 30,10 30,22 16,22 16,30 2,16  "/></g></svg></a>');
						HTP.P('</div>');

						HTP.P('<div id="float-space" class="float invisible">');
                        
							HTP.P('<a class="link" onclick="var filhos = document.getElementById(''float-space-inner'').children; for(i=0;i<filhos.length;i++){ if(filhos[i].children[2].className.indexOf(''float'') != -1){ var multi = filhos[i].children[2].children[0].children; var multivar = ''''; for(b=0;b<multi.length;b++){ if(multi[b].selected == true){ multivar = multivar+''|''+multi[b].value; }} ajax(''fly'', ''save_float'', ''ws_conteudo=''+encodeURIComponent(multivar)+''&ws_padrao=''+filhos[i].id);} else { if(filhos[i].children[2]){ ajax(''fly'', ''save_float'', ''ws_conteudo=''+encodeURIComponent(filhos[i].children[2].value)+''&ws_padrao=''+filhos[i].id);} } } setTimeout(function(){ shscr(document.getElementById(''current_screen'').value) }, 500*filhos.length); document.getElementById(''float-space'').classList.toggle(''invisible'');">ALTERAR</a>');
						HTP.P('</div>');

						HTP.P('<div id="float-filter2" class="float invisible">');
							HTP.P('<a class="link" onclick="var filhos = document.getElementById(''float-filter-inner'').children; for(i=0;i<filhos.length;i++){ if(filhos[i].children[2].className.indexOf(''float'') != -1){ var multi = filhos[i].children[2].children[0].children; var multivar = ''''; for(b=0;b<multi.length;b++){ if(multi[b].selected == true){ multivar = multivar+''|''+multi[b].value; }} ajax(''fly'', ''save_float_filter'', ''prm_conteudo=''+encodeURIComponent(multivar)+''&prm_coluna=''+filhos[i].id+''&prm_screen=''+document.getElementById(''current_screen'').value); } else { if(filhos[i].children[0]){ ajax(''fly'', ''save_float_filter'', ''prm_conteudo=''+encodeURIComponent(filhos[i].children[0].value)+''&prm_coluna=''+filhos[i].id.replace(''_FILTER'', '''')+''&prm_screen=''+document.getElementById(''current_screen'').value); } } } setTimeout(function(){ shscr(document.getElementById(''current_screen'').value); }, 100*filhos.length); document.getElementById(''float-filter'').classList.toggle(''invisible'');">ALTERAR</a>');
						HTP.P('</div>');

						IF WS_SHOW_ONLY <> 'S' THEN
							HTP.P('<div id="call-options" style="display: none;">');
								
								HTP.P('<div id="space-options"></div>');
								HTP.P('<a class="border" onclick="var space = document.getElementById(''space''); if(parseInt(space.style.width) > 0){ space.style.setProperty(''width'', ''0''); space.style.overflowY = ''hidden''; this.className=''border''; } else { if(parseInt(maxCall()) > 0){ space.style.setProperty(''width'', maxCall()); space.style.overflowY = ''scroll''; this.className=''border open'';} }"></a>');
							HTP.P('</div>');
						END IF;

						



					    HTP.P('<ul id="filterlist" class="filtro hidden" ontouchend="this.className = ''filtro hidden'';" onmouseleave="this.className = ''filtro hidden''; this.setAttribute(''data-desc'', '''');"></ul>');

						HTP.P('<ul id="destaquelist" class="filtro hidden" ontouchend="this.className = ''filtro hidden'';" onmouseleave="this.className = ''filtro hidden''; this.setAttribute(''data-desc'', '''');"></ul>');
						
					    FCL.ALERTA;

                        HTP.P('<a id="saving"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 468.293 468.293" style="enable-background:new 0 0 468.293 468.293;" xml:space="preserve"> <path style="fill:#2D92BA;" d="M433.951,468.293H34.341c-10.345,0-18.732-8.386-18.732-18.732V18.732C15.61,8.386,23.996,0,34.341,0 h345.82c28.322,28.322,44.2,44.2,72.522,72.522v377.039C452.683,459.906,444.296,468.293,433.951,468.293z"/> <path style="fill:#E0E5E8;" d="M322.648,177.518H118.191c-10.345,0-18.732-8.386-18.732-18.732V0h241.92v158.787 C341.38,169.132,332.994,177.518,322.648,177.518z"/> <path style="fill:#647989;" d="M281.782,151.198h-43.707c-3.448,0-6.244-2.796-6.244-6.244V32.564c0-3.448,2.796-6.244,6.244-6.244 h43.707c3.448,0,6.244,2.795,6.244,6.244v112.39C288.026,148.403,285.23,151.198,281.782,151.198z"/> <g> <path style="fill:#3B566A;" d="M85.527,443.426H41.82v-37.463c0-3.448,2.795-6.244,6.244-6.244h31.22 c3.448,0,6.244,2.795,6.244,6.244V443.426z"/> <path style="fill:#3B566A;" d="M426.473,443.426h-43.707v-37.463c0-3.448,2.796-6.244,6.244-6.244h31.22 c3.448,0,6.244,2.795,6.244,6.244V443.426z"/> </g> <g> <rect x="41.822" y="433.308" style="fill:#D4D5DB;" width="43.707" height="10.115"/> <rect x="382.764" y="433.308" style="fill:#D4D5DB;" width="43.707" height="10.115"/> </g> <path style="fill:#EBEFF2;" d="M359.009,302.076v166.212H109.315V302.076c0-10.366,8.367-18.732,18.732-18.732h212.23 C350.58,283.344,359.009,291.71,359.009,302.076z"/> <path style="fill:#4EBD9E;" d="M359.009,302.076v25.849H109.315v-25.849c0-10.366,8.367-18.732,18.732-18.732h212.23 C350.58,283.344,359.009,291.71,359.009,302.076z"/> <g> <path style="fill:#D4D5DB;" d="M334.065,354.881H134.259c-3.451,0-6.244,2.796-6.244,6.244c0,3.448,2.793,6.244,6.244,6.244 h199.806c3.451,0,6.244-2.796,6.244-6.244C340.309,357.676,337.516,354.881,334.065,354.881z"/> <path style="fill:#D4D5DB;" d="M334.065,391.123H134.259c-3.451,0-6.244,2.796-6.244,6.244c0,3.448,2.793,6.244,6.244,6.244 h199.806c3.451,0,6.244-2.796,6.244-6.244C340.309,393.919,337.516,391.123,334.065,391.123z"/> <path style="fill:#D4D5DB;" d="M334.065,427.365H134.259c-3.451,0-6.244,2.796-6.244,6.244c0,3.448,2.793,6.244,6.244,6.244 h199.806c3.451,0,6.244-2.796,6.244-6.244C340.309,430.161,337.516,427.365,334.065,427.365z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');

						IF WS_ADMIN = 'A' THEN
							HTP.P('<div id="debug" data-value="0">');
							   HTP.P('<input autocomplete="on" list="debug-list" id="debug-in" type="text" value="" style="width: 92%; margin-top: 6px; max-width: none; height: 22px;" onkeypress="debug(event.which);"/>');
							   HTP.P('<a title="'||FUN.LANG('fechar')||'" style="color: #FFF; font-size: 12px; font-weight: bold; margin: 14px 0 14px 5px;" onclick="this.parentNode.className=''''; document.getElementById(''debug'').setAttribute(''data-value'', 0);">'||FUN.LANG('FECHAR')||'</a>');
							   HTP.P('<input type="hidden" value="" id="debug-key">');
							   HTP.P('<datalist id="debug-list">');
								    HTP.P('<option value="dashboard">');
								    HTP.P('<option value="rule">');
								    HTP.P('<option value="query">');
								    HTP.P('<option value="screen">');
								    HTP.P('<option value="grid(Y,X)">');
								    HTP.P('<option value="upload">');
								    HTP.P('<option value="padrao">');
								    HTP.P('<option value="admin">');
								    HTP.P('<option value="help">');
								HTP.P('</datalist>');
							HTP.P('</div>');
						END IF;

					HTP.P('</div>');
					
					
					IF NVL(PRM_SCREEN, 'N/A') <> 'N/A' THEN
					    WS_URL_DEFAULT := '';
					END IF;
                    
					
                    IF FUN.RET_VAR('GPU') = 'S' THEN
					    HTP.P('<style> div#main div.dragme { transform: translate3d(0, 0, 0); -moz-transform: translate3d(0, 0, 0); -webkit-transform: translate3d(0, 0, 0); } </style>');
					END IF;
					
					IF WS_ADMIN = 'A' THEN
					    HTP.P('<div id="main" style="background-color: '||WS_COR_DEFAULT||'; background-image: url('||WS_URL_DEFAULT||'); background-repeat: '||NVL(FUN.GETPROP('DEFAULT','REPEAT'), 'no-repeat')||'; background-position: '||NVL(FUN.GETPROP('DEFAULT','IMG_POS'), 'center')||'; background-size: inherit;">');
					ELSE
						HTP.P('<div id="main" class="usuario" style="background-color: '||WS_COR_DEFAULT||'; background-image: url('||WS_URL_DEFAULT||'); background-repeat: '||NVL(FUN.GETPROP('DEFAULT','REPEAT'), 'no-repeat')||'; background-position: '||NVL(FUN.GETPROP('DEFAULT','IMG_POS'), 'center')||'; background-size: inherit;">');
					END IF;
					
					HTP.P('</div>');

					HTP.P('<div id="main-ext" style="position: absolute; top: 0; left: 0; width: 100%;"></div>');

                    IF LENGTH(FUN.RET_VAR('JS_ADICIONAL')) > 0 THEN
                        FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((FUN.RET_VAR('JS_ADICIONAL'))))) LOOP
                            HTP.P('<script src="dwu.fcl.download?arquivo='||LOWER(TRIM(I.COLUMN_VALUE))||'.js"></script>');
                        END LOOP;
                    END IF;

                    IF LENGTH(FUN.RET_VAR('CSS_ADICIONAL')) > 0 THEN
                        FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((FUN.RET_VAR('CSS_ADICIONAL'))))) LOOP
                            HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo='||LOWER(TRIM(I.COLUMN_VALUE))||'.css">');
                        END LOOP;
                    END IF;

					

					IF WS_ADMIN = 'A' THEN
                        HTP.P('<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"></script>');
						
						
  						
						
						
					END IF;

					
					

				    
					HTP.P('<script>const USUARIO = "'||WS_USUARIO||'", ADMIN = "'||WS_ADMIN||'", LAYER = document.getElementById(''layer''), MAIN = document.getElementById(''main''), PRINCP = document.getElementById(''princp'');</script>');

					
					HTP.P('<script src="dwu.fcl.download?arquivo=calendar.js"></script>');
					HTP.P('<script src="dwu.fcl.download?arquivo=default-min.js"></script>');
					
					
					
					
					
					HTP.P('<script src="dwu.fcl.download?arquivo=vanilla-masker.js"></script>');
					HTP.P('<script src="dwu.fcl.download?arquivo=qrcode.min.js"></script>');
                    
					
                    
					
					
                    

                    HTP.P('<script src="dwu.fcl.download?arquivo=echarts.5.1.js"></script>');
					htp.p('<script src="dwu.fcl.download?arquivo=xlsx.mini.min.js"></script>');  -- converte somente para XLSX		 
					
					SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE TP_OBJETO = 'GEOMAPA'; 

					IF WS_COUNT > 0 THEN
					    HTP.P('<script type="text/javascript" src="dwu.fcl.download?arquivo=leaflet.js" ></script>');
					    HTP.P('<link rel="stylesheet" type="text/css" href="dwu.fcl.download?arquivo=leaflet.css" >');
						HTP.P('<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkr75GOMHoiIk1Va2KOd6nLaa0nBM35AM&libraries=visualization"></script>');
					END IF;

					HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo=pell.min.css">');
					HTP.P('<script type="text/javascript" src="dwu.fcl.download?arquivo=pell.min.js"></script>');
					HTP.P('<link href="https://fonts.googleapis.com/css?family=Courier+Prime" rel="stylesheet" type="text/css">');
					HTP.P('<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">');
					HTP.P('<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" type="text/css">');
					HTP.P('<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet" type="text/css">'); 
					HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo=bro.css">');

				HTP.P('</body>');
			HTP.P('</html>');
		  END IF;
		ELSE
		    HTP.P('<!doctype html public "-//W3C//DTD html 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">');
		    HTP.P('<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="pt-br" lang="pt-br">');
		        HTP.P('<body>');
					HTP.P('<div style="font-weight: bold; font-size: 16px; color: #cc0000; font-family: tahoma; position: absolute; top: 45%; left: 40%;">'||FUN.LANG('USU&Aacute;RIO '||WS_USUARIO||' SEM ACESSO AO SISTEMA!')||'</div>');
		        HTP.P('</body>');
		    HTP.P('</html>');
		END IF;
	ELSE
	    HTP.P('<!doctype html public "-//W3C//DTD html 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">');
		HTP.P('<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="pt-br" lang="pt-br">');
		    HTP.P('<body>');
	            HTP.P('<div style="font-weight: bold; font-size: 16px; color: #cc0000; font-family: tahoma; position: absolute; top: 45%; left: 40%;">'||FUN.LANG('SISTEMA EM MANUTEN&Ccedil;&Atilde;O!')||'</div>');
		    HTP.P('</body>');
		HTP.P('</html>');
	END IF;
EXCEPTION 
	WHEN OTHERS THEN
    	HTP.P(SQLERRM);
END INICIAR;

PROCEDURE GPS( PRM_POSICAO	VARCHAR	DEFAULT NULL ) AS

BEGIN
    INSERT INTO LOG_EVENTOS VALUES(SYSDATE, 'Localiza&ccedil;&atilde;o-['||PRM_POSICAO||']', GBL.GETUSUARIO, 'LOCAL', 'GPS', '01');
EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END GPS;

PROCEDURE DATA ( PRM_OBJETO	    VARCHAR	 DEFAULT NULL,
			     PRM_PARAMETROS VARCHAR2 DEFAULT NULL,
			     PRM_SCREEN     VARCHAR2 DEFAULT NULL ) AS

	WS_CD_PONTO		PONTO_AVALIACAO.CD_PONTO%TYPE;
	WS_NM_PONTO		PONTO_AVALIACAO.NM_PONTO%TYPE;
	WS_DS_PONTO		PONTO_AVALIACAO.DS_PONTO%TYPE;
	WS_TP_RENOVACAO		PONTO_AVALIACAO.TP_RENOVACAO%TYPE;
	WS_CD_MICRO_VISAO PONTO_AVALIACAO.CD_MICRO_VISAO%TYPE;
	WS_PARAMETROS		PONTO_AVALIACAO.PARAMETROS%TYPE;
	WS_VL_SALVO		PONTO_AVALIACAO.VL_SALVO%TYPE;
	WS_CS_PARAMETROS	PONTO_AVALIACAO.CS_PARAMETROS%TYPE;
	WS_CS_COLUNA		PONTO_AVALIACAO.CS_COLUNA%TYPE;
	WS_CS_AGRUPADOR		PONTO_AVALIACAO.CS_AGRUPADOR%TYPE;
	WS_CS_RP		PONTO_AVALIACAO.CS_RP%TYPE;
	WS_CS_COLUP		PONTO_AVALIACAO.CS_COLUP%TYPE;

	WS_CD_OBJETO		OBJETOS.CD_OBJETO%TYPE;
	WS_NM_OBJETO		OBJETOS.NM_OBJETO%TYPE;
	WS_TP_OBJETO		OBJETOS.TP_OBJETO%TYPE;
	WS_CD_USUARIO		OBJETOS.CD_USUARIO%TYPE;
	WS_ATRIBUTOS		OBJETOS.ATRIBUTOS%TYPE;
	WS_DS_OBJETO		OBJETOS.DS_OBJETO%TYPE;

	WS_OBJ			VARCHAR2(60);
	WS_TIP			VARCHAR2(60);
	WS_REFERENCIA		VARCHAR2(60);

BEGIN
    
	SELECT CD_OBJETO, 	NM_OBJETO,    TP_OBJETO,    CD_USUARIO,    ATRIBUTOS,    DS_OBJETO    INTO
	       WS_CD_OBJETO,	WS_NM_OBJETO, WS_TP_OBJETO, WS_CD_USUARIO, WS_ATRIBUTOS, WS_DS_OBJETO
	FROM   OBJETOS
	WHERE  CD_OBJETO=PRM_OBJETO;

	WS_OBJ := TRIM(PRM_OBJETO);
	WS_TIP := TRIM(WS_TP_OBJETO);

	SELECT CD_PONTO,    NM_PONTO,    DS_PONTO,    TP_RENOVACAO,    CD_MICRO_VISAO,    PARAMETROS,    VL_SALVO,    CS_PARAMETROS,    CS_COLUNA,    CS_AGRUPADOR,    CS_RP,    CS_COLUP    INTO
	       WS_CD_PONTO, WS_NM_PONTO, WS_DS_PONTO, WS_TP_RENOVACAO, WS_CD_MICRO_VISAO, WS_PARAMETROS, WS_VL_SALVO, WS_CS_PARAMETROS, WS_CS_COLUNA, WS_CS_AGRUPADOR, WS_CS_RP, WS_CS_COLUP
	FROM   PONTO_AVALIACAO
	WHERE  CD_PONTO = PRM_OBJETO;
	FCL.CHAROUT('1|1', WS_CD_MICRO_VISAO, WS_CD_OBJETO, PRM_SCREEN);

END DATA;


PROCEDURE DATALINK ( PRM_GIF         VARCHAR2 DEFAULT NULL,
					 PRM_LINK        VARCHAR2 DEFAULT NULL,
					 PRM_TYPE        VARCHAR2 DEFAULT 'GIF',
					 PRM_ALT         VARCHAR2 DEFAULT NULL,
					 PRM_PANEL       VARCHAR2 DEFAULT 'COLUNA',
					 PRM_FORM        VARCHAR2 DEFAULT NULL,
					 PRM_SELECT	     VARCHAR2 DEFAULT NULL,
					 PRM_URL	     VARCHAR2 DEFAULT NULL,
					 PRM_COMANDO     VARCHAR2 DEFAULT NULL,
					 PRM_ID          VARCHAR2 DEFAULT NULL,
					 PRM_IDGIF       VARCHAR2 DEFAULT NULL,
					 PRM_ADDSCRIPT   VARCHAR2 DEFAULT NULL,
					 PRM_ATTRIB      VARCHAR2 DEFAULT 'title',
					 PRM_CATTRIBUTES VARCHAR2 DEFAULT NULL,
					 PRM_HIDEB       VARCHAR2 DEFAULT NULL ) AS

	WS_SHOWCOM		VARCHAR2(100);
	WS_HIDEB		VARCHAR2(100) := ' ';

BEGIN
    
	IF  PRM_HIDEB = 'HIDE' THEN
	    WS_HIDEB := ' style=" display: none; " ';
	END IF;

	IF  PRM_PANEL = 'NOSHOW' THEN
	    WS_SHOWCOM := '';
	ELSE
	    WS_SHOWCOM := 'hdobj('||CHR(39)||'telosa'||CHR(39)||','||CHR(39)||''||CHR(39)||');';
	END IF;

	IF  PRM_COMANDO IN ('SAVE','INSGRF','INSPAV','EDPROP','INSPTR','DLPROP') THEN
	    IF  PRM_COMANDO = 'INSPAV' THEN
			HTP.P(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE),  CALT => PRM_ALT,  CATTRIBUTES => FCL.FPDATA(PRM_IDGIF,'','',' id="'||PRM_IDGIF||'"')||' onclick="carrega('''||PRM_URL||'?ws_par_sumary='||'''+document.getElementById('''||PRM_FORM||''').'||PRM_ATTRIB||'+'''||'&ws_par_tipo='||'''+document.getElementById(''seecol_type'').value'||'+'''||'&ws_par_seecol='||'''+document.getElementById(''seecolx'').value'||'); '||PRM_ADDSCRIPT||' '||WS_SHOWCOM||' " border="0" ')||'</a>','center','','','','','border="0" '||WS_HIDEB||' width="1%" id="'||PRM_ID||'" '||PRM_CATTRIBUTES));
	    ELSE
	        IF  PRM_COMANDO = 'INSGRF' THEN
		    	HTP.P(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE),  CALT => PRM_ALT,  CATTRIBUTES => FCL.FPDATA(PRM_IDGIF,'','',' id="'||PRM_IDGIF||'"')||' onclick="'||PRM_ADDSCRIPT||'carrega('''||PRM_URL||'?ws_par_sumary='||'''+document.getElementById('''||PRM_FORM||''').'||PRM_ATTRIB||'+'''||'&ws_par_tipo='||'''+document.getElementById(''seecol_type'').value'||'+'''||'&ws_par_seecol='||'''+document.getElementById(''seecolx'').value'||'+'''||'&ws_par_colunas='||'''+document.getElementById(''col_''+parent.document.getElementById(''seecol_content'').value).value); '||PRM_ADDSCRIPT||' '||WS_SHOWCOM||' " border="0" ')||'</A>','center','','','','','border="0" '||WS_HIDEB||' width="1%" id="'||PRM_ID||'" '||PRM_CATTRIBUTES));
			ELSE
		    	HTP.P(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE),  CALT => PRM_ALT,  CATTRIBUTES => FCL.FPDATA(PRM_IDGIF,'','',' id="'||PRM_IDGIF||'"')||' onclick="carrega('''||PRM_URL||'?ws_par_sumary='||'''+document.getElementById('''||PRM_FORM||''').'||PRM_ATTRIB||'); '||PRM_ADDSCRIPT||' '||WS_SHOWCOM||' " border="0" ')||'</A>','center','','','','','border="0" '||WS_HIDEB||' width="1%" id="'||PRM_ID||'" '||PRM_CATTRIBUTES));
			END IF;
	    END IF;
	ELSE
	    IF  PRM_GIF = 'NOGIF' THEN
			HTP.P('<a href="'||PRM_LINK||'">'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CATTRIBUTES => 'border="0" '||FUN.IFNOTNULL(PRM_ID,' id="'||PRM_ID||'"'))||' </a>');
	    ELSE
			IF  NVL(PRM_FORM,'NODATA') <> 'NODATA' THEN
		    	HTP.P(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CALT => PRM_ALT,  CATTRIBUTES => FCL.FPDATA(PRM_IDGIF,'','',' id="'||PRM_IDGIF||'"')||' onclick="document.location.href='''||PRM_URL||'&prm_comando='||PRM_COMANDO||'|'||'''+document.'||PRM_FORM||'.'||PRM_SELECT||'.options[document.'||PRM_FORM||'.'||PRM_SELECT||'.selectedIndex].value;" border="0" '||FUN.IFNOTNULL(PRM_ID,' id="'||PRM_ID||'"'))||'</a>','center','','','','','border="0" '||WS_HIDEB||' width="1%"  id="'||PRM_ID||'" '||PRM_CATTRIBUTES));
			ELSE
		    	IF  PRM_PANEL = 'COLUNA' THEN
					HTP.P(HTF.TABLEDATA('<a href="'||PRM_LINK||'" >'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CALT => PRM_ALT,  CATTRIBUTES => PRM_CATTRIBUTES||FCL.FPDATA(PRM_IDGIF,'','',' id="'||PRM_IDGIF||'"')||' title="'||PRM_ALT||'" border="0" ')||'</a>','center','','','','','border="0" '||WS_HIDEB||' width="1%" '||FUN.IFNOTNULL(PRM_ID,' id="'||PRM_ID||'"'||PRM_CATTRIBUTES)));
		    	ELSE
					HTP.P('<a href="'||PRM_LINK||'">'||HTF.IMG(FUN.R_GIF(PRM_GIF, PRM_TYPE ), CATTRIBUTES => PRM_CATTRIBUTES||FCL.FPDATA(PRM_IDGIF,'','',' id="'||PRM_IDGIF||'" ')||WS_HIDEB||' border="0" '||FUN.IFNOTNULL(PRM_ID,' id="'||PRM_ID||'"'||PRM_CATTRIBUTES)));
		    	END IF;
	        END IF;
	    END IF;
	END IF;

END DATALINK;


PROCEDURE FORMSELECTOPTION(
			CTEXT       IN VARCHAR2,
			CVALUE	    IN VARCHAR2,
			CATTRIBUTES IN VARCHAR2 DEFAULT NULL,
			CSELECTED   IN VARCHAR2 DEFAULT NULL ) AS
BEGIN
	HTP.PRINT('<option value="'||CVALUE||'" '||FUN.IFNOTNULL(CSELECTED,' SELECTED ')||FUN.IFNOTNULL(CATTRIBUTES,' '||CATTRIBUTES)||'>'||CTEXT||' </option>');
END FORMSELECTOPTION;

FUNCTION HTEXTO ( J_TEXTO	   CHAR	DEFAULT NULL,
				  J_SIZE	   CHAR	DEFAULT NULL,
				  J_COR		   CHAR	DEFAULT NULL,
				  J_HREF	   CHAR	DEFAULT NULL,
				  CATTRIBUTES  CHAR	DEFAULT NULL )  RETURN VARCHAR2 AS

BEGIN
	RETURN('<font '||FUN.IFNOTNULL(J_SIZE,' size="'||J_SIZE||'"')||FUN.IFNOTNULL(J_COR,' color="'||J_COR||'"')||FUN.IFNOTNULL(CATTRIBUTES,' '||CATTRIBUTES)||'>'||FUN.IFNOTNULL(J_HREF,' <a href="'||J_HREF||'" >')||J_TEXTO||FUN.IFNOTNULL(J_HREF,' </a>')||'</font>');
END HTEXTO;

PROCEDURE NEGADO ( J_OBJETO CHAR DEFAULT NULL ) AS

BEGIN

	HTP.P( '<div align="CENTER">' || HTF.BOLD( '<FONT size="5">&nbsp;'|| J_OBJETO ||'&nbsp;</font>') || '</font>' || '</div>');
END NEGADO;

PROCEDURE NOPEN( PRM_NOME	CHAR	DEFAULT NULL ) AS
BEGIN
	HTP.P('<'||PRM_NOME||'>');

END NOPEN;

PROCEDURE NCLOSE( PRM_NOME	CHAR	DEFAULT NULL ) AS
BEGIN
	HTP.P('</'||PRM_NOME||'>');

END NCLOSE;





PROCEDURE DUMP_SCREEN AS

BEGIN
     HTP.P('Clear...');
END DUMP_SCREEN;


PROCEDURE OPENAPPLET( CCODBASE     IN VARCHAR2,
		      CCODE	   IN VARCHAR2,
		      CNAME	   IN VARCHAR2 DEFAULT NULL,
		      CATTRIBUTES  IN VARCHAR2 DEFAULT NULL ) AS
BEGIN
    HTP.PRINT('<APPLET CODEBASE ="'||RTRIM(CCODBASE)||'" CODE = "'||RTRIM(CCODE)||'" NAME = "'||RTRIM(CNAME)||'" '||CATTRIBUTES||' >');

END OPENAPPLET;


PROCEDURE CLOSEAPPLET AS

BEGIN
    HTP.PRINT(' </APPLET> ');

END CLOSEAPPLET;





PROCEDURE NULOPASS AS

BEGIN
    HTP.PRINT(' XX ');

END NULOPASS;





PROCEDURE TABLEDATAOPEN( CALIGN	     IN VARCHAR2 DEFAULT NULL,
			 			 CCOLSPAN    IN VARCHAR2 DEFAULT NULL,
			 CATTRIBUTES IN VARCHAR2 DEFAULT NULL,
			 CROWSPAN    IN VARCHAR2 DEFAULT NULL ) AS

BEGIN
	HTP.PRINT('<td '||FUN.IFNOTNULL(CALIGN,' align="'||CALIGN||'" ')||FUN.IFNOTNULL(CROWSPAN,' rowspan="'||CROWSPAN||'" ')||FUN.IFNOTNULL(CCOLSPAN,' colspan="'||CCOLSPAN||'" ')||FUN.IFNOTNULL(CATTRIBUTES,' '||CATTRIBUTES)||' >');
END TABLEDATAOPEN;





PROCEDURE TABLEDATACLOSE AS

BEGIN

 	HTP.PRINT(' </td> ');

END TABLEDATACLOSE;

PROCEDURE LOAD_TABLES ( PRM_ORDER VARCHAR2 DEFAULT '1',
                        PRM_DIR   VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_VISOES IS
	SELECT NM_MICRO_VISAO, NM_TABELA, DS_MICRO_VISAO, CD_GRUPO_FUNCAO, COUNT(CD_PONTO) AS PONTO, OBSERVACAO
	FROM MICRO_VISAO T1
	LEFT JOIN PONTO_AVALIACAO T2 ON T2.CD_MICRO_VISAO = T1.NM_MICRO_VISAO
    GROUP BY NM_MICRO_VISAO, NM_TABELA, DS_MICRO_VISAO, CD_GRUPO_FUNCAO, OBSERVACAO

	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', NM_MICRO_VISAO, '2', NM_TABELA, '3', DS_MICRO_VISAO, '4', CD_GRUPO_FUNCAO, NM_MICRO_VISAO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', NM_MICRO_VISAO, '2', NM_TABELA, '3', DS_MICRO_VISAO, '4', CD_GRUPO_FUNCAO, NM_MICRO_VISAO) END DESC;

	WS_VISAO    CRS_VISOES%ROWTYPE;

	WS_TMP		LONG;
	WS_COUNT	NUMBER;
	WS_PRIMEIRO	VARCHAR2(60);
	WS_DIR      NUMBER := 1;
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
	WS_ADMIN    VARCHAR2(20);

	WS_NOACCESS   EXCEPTION;
BEGIN

	WS_ADMIN := NVL(GBL.GETNIVEL, 'N');

	IF WS_ADMIN <> 'A' THEN
		RAISE WS_NOACCESS;
	END IF;

    

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    
	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">VIEW</th>');

				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('TABELA')||'</th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</th>');

				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''LOAD_TABLES'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('GRUPO')||'</th>');
				HTP.P('<th>'||FUN.LANG('OBSERVA&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');


		IF TO_NUMBER(PRM_DIR) = 1 THEN
			    WS_DIR := 2;
			END IF;

			HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
			OPEN CRS_VISOES;
				LOOP
					FETCH CRS_VISOES INTO WS_VISAO;
					EXIT WHEN CRS_VISOES%NOTFOUND;
						HTP.P('<tr>');
							HTP.P('<td><a title="'||FUN.LANG('Alterar colunas')||'" class="link" onclick="viewDetalhes('''||WS_VISAO.NM_MICRO_VISAO||''');">'||FUN.UTRANSLATE('NM_MICRO_VISAO', 'MICRO_VISAO', WS_VISAO.NM_MICRO_VISAO, WS_PADRAO)||'</a></td>');

							HTP.P('<td>');
							    HTP.P('<a class="script" onclick="saveView(this, '''||WS_VISAO.NM_MICRO_VISAO||''', ''tabela'');"></a>');
							    FCL.FAKEOPTION(WS_VISAO.NM_MICRO_VISAO, '', WS_VISAO.NM_TABELA, 'lista-tabelas', 'S', 'N', '');
							HTP.P('</td>');
							
							HTP.P('<td>');
							    HTP.P('<input maxlength="60" class="lang" data-default="'||WS_VISAO.NM_MICRO_VISAO||'" type="text" title="'||WS_VISAO.DS_MICRO_VISAO||'" id="'||WS_VISAO.NM_MICRO_VISAO||'_desc" onblur="blurView(this, '''||WS_VISAO.NM_MICRO_VISAO||''');" value="'||FUN.UTRANSLATE('DS_MICRO_VISAO', 'MICRO_VISAO', WS_VISAO.DS_MICRO_VISAO, WS_PADRAO)||'" />');
							    HTP.P('<a class="fakelang" onclick="fakeLang('''||WS_VISAO.NM_MICRO_VISAO||'_desc'', ''MICRO_VISAO|DS_MICRO_VISAO|''+document.getElementById('''||WS_VISAO.NM_MICRO_VISAO||'_desc'').title);">L</a>');
							HTP.P('</td>');
							
                            HTP.P('<td>');
							    HTP.P('<a class="script" onclick="saveView(this, '''||WS_VISAO.NM_MICRO_VISAO||''', ''grupo'');"></a>');
							    FCL.FAKEOPTION(WS_VISAO.NM_MICRO_VISAO||'_grupo', '', WS_VISAO.CD_GRUPO_FUNCAO, 'lista-grupos', 'N', 'N', '');
							HTP.P('</td>');

							HTP.P('<td>');
							    HTP.P('<textarea onblur="saveView(this, '''||WS_VISAO.NM_MICRO_VISAO||''', ''observacao'');">'||WS_VISAO.OBSERVACAO||'</textarea>');
							HTP.P('</td>');

							IF WS_VISAO.PONTO = 0 THEN
								HTP.P('<td>');
									FCL.BUTTON_LIXO('dl_view','prm_view', WS_VISAO.NM_MICRO_VISAO, PRM_TAG => 'a');
								HTP.P('</td>');
							ELSE
							    HTP.P('<td><a class="noremove" title="'||FUN.LANG('Imposs&iacute;vel excluir!')||'">X</a></td>');
						    END IF;
						HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_VISOES;
		HTP.P('</tbody>');
	HTP.P('</table>');
EXCEPTION 
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END LOAD_TABLES;



PROCEDURE NEW_VIEW ( PRM_NOME VARCHAR2 DEFAULT NULL,
                     PRM_TABELA VARCHAR2 DEFAULT NULL,
					 PRM_DESC VARCHAR2 DEFAULT NULL,
					 PRM_GRUPO VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT     NUMBER;
	WS_DESC      VARCHAR2(200);
	WS_ADMIN     VARCHAR2(20);

	WS_ERROR     EXCEPTION;
	WS_DUPLICADO EXCEPTION;
	WS_NOADMIN   EXCEPTION;

BEGIN

    WS_ADMIN := NVL(GBL.GETNIVEL, 'N');

	IF WS_ADMIN <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	
	
	WS_DESC := FUN.CONVERTE(PRM_DESC);

    SELECT COUNT(*) INTO WS_COUNT FROM MICRO_VISAO WHERE NM_MICRO_VISAO = UPPER(TRIM(PRM_NOME));
	IF WS_COUNT = 0 THEN
	    BEGIN
			INSERT INTO MICRO_VISAO (NM_MICRO_VISAO, NM_TABELA, DS_MICRO_VISAO, CD_GRUPO_FUNCAO, DT_ULTIMA_ALTERACAO, CD_USUARIO) 
			VALUES(UPPER(TRIM(PRM_NOME)), UPPER(TRIM(PRM_TABELA)), TRIM(WS_DESC), PRM_GRUPO, SYSDATE, 'DWU');
			
			WS_COUNT := SQL%ROWCOUNT;
			
			IF WS_COUNT = 1 THEN
			    COMMIT;
			ELSE
			    ROLLBACK;
			    RAISE WS_ERROR;
			END IF;
			
            FCL.PADRAO_COLUNAS(UPPER(TRIM(PRM_TABELA)),UPPER(TRIM(PRM_NOME)));
			INSERT INTO TRADUCAO_COLUNAS VALUES('MICRO_VISAO', 'NM_MICRO_VISAO', FUN.RET_VAR('LANG_SYS'), UPPER(TRIM(PRM_NOME)), UPPER(TRIM(PRM_NOME)), 'T', 'N');
			INSERT INTO TRADUCAO_COLUNAS VALUES('MICRO_VISAO', 'DS_MICRO_VISAO', FUN.RET_VAR('LANG_SYS'), TRIM(WS_DESC), TRIM(WS_DESC), 'T', 'N');
			COMMIT;
			
		EXCEPTION WHEN OTHERS THEN
		    RAISE WS_ERROR;
		END;
    ELSE
        RAISE WS_DUPLICADO;
    END IF;
EXCEPTION
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_DUPLICADO THEN
		HTP.P('#alert '||FUN.LANG('view j&aacute; existe')||'!');
	WHEN WS_ERROR THEN
		HTP.P('#alert '||FUN.LANG('imposs&iacute;vel criar a view')||'!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END NEW_VIEW;


PROCEDURE SAVE_VIEW ( PRM_VIEW  VARCHAR2 DEFAULT NULL,
                      PRM_VALOR VARCHAR2 DEFAULT NULL,
                      PRM_TIPO  VARCHAR2 DEFAULT NULL ) AS
	
	WS_CONVERTE VARCHAR2(800);
	WS_ADMIN    VARCHAR2(20);

	WS_NOADMIN  EXCEPTION;
BEGIN
    
	WS_ADMIN := NVL(GBL.GETNIVEL, 'N');

	IF WS_ADMIN <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	
	WS_CONVERTE := FUN.CONVERTE(PRM_VALOR);

	IF PRM_TIPO = 'desc' THEN
		BEGIN
			UPDATE MICRO_VISAO
			SET DS_MICRO_VISAO = TRIM(WS_CONVERTE)
			WHERE NM_MICRO_VISAO = UPPER(TRIM(PRM_VIEW));
		EXCEPTION WHEN OTHERS THEN
			HTP.P('#alert '||FUN.LANG('Erro ao alterar a descri&ccedil;&atilde;o!')||'');
		END;
	ELSIF PRM_TIPO = 'grupo' THEN
		BEGIN
			UPDATE MICRO_VISAO
			SET CD_GRUPO_FUNCAO = TRIM(WS_CONVERTE)
			WHERE NM_MICRO_VISAO = UPPER(TRIM(PRM_VIEW));
		EXCEPTION WHEN OTHERS THEN
			HTP.P('#alert '||FUN.LANG('Erro ao alterar a tabela!')||'');
		END;
	ELSIF PRM_TIPO = 'observacao' THEN
		BEGIN
			UPDATE MICRO_VISAO
			SET OBSERVACAO = TRIM(WS_CONVERTE)
			WHERE NM_MICRO_VISAO = UPPER(TRIM(PRM_VIEW));
		EXCEPTION WHEN OTHERS THEN
			HTP.P('#alert '||FUN.LANG('Erro ao alterar a observa&ccedil;&atilde;o!')||'');
		END;
	ELSE
		BEGIN
			UPDATE MICRO_VISAO
			SET NM_TABELA = TRIM(WS_CONVERTE)
			WHERE NM_MICRO_VISAO = UPPER(TRIM(PRM_VIEW));
		EXCEPTION WHEN OTHERS THEN
			HTP.P('#alert '||FUN.LANG('Erro ao alterar a tabela!')||'');
		END;
	END IF;
EXCEPTION
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END SAVE_VIEW;





PROCEDURE LISTBOX (	PRM_CAMPO	    VARCHAR2 DEFAULT NULL,
					PRM_TMP_FIELD	VARCHAR2 DEFAULT NULL,
					PRM_SCRIPT	    VARCHAR2 DEFAULT NULL,
					PRM_DEFAULT	    VARCHAR2 DEFAULT NULL,
					PRM_LIST	    VARCHAR2 DEFAULT NULL,
					PRM_ATRIB       VARCHAR2 DEFAULT NULL,
					PRM_OBJ         VARCHAR2 DEFAULT NULL ) AS

	WS_AGRUPADOR	       LONG;
	WS_TEXTO	           LONG;
	WS_TEXTOT	           LONG;
	WS_NM_VAR	           LONG;
	WS_CT_VAR	           LONG;
	WS_PROP                LONG;
	WS_COUNT               NUMBER;
	WS_CAMPO               LONG;
	WS_SCRIP_EFEITO        VARCHAR2(2000);

BEGIN

    
    
    WS_TEXTO := PRM_LIST;
    
    





    
     WS_SCRIP_EFEITO := FUN.ATTRIB_TEMPOREAL(PRM_ATRIB, PRM_OBJ);
    

    WS_AGRUPADOR := SUBSTR(WS_TEXTO, 1 ,INSTR(WS_TEXTO,'|')-1);
    WS_TEXTO := SUBSTR(WS_TEXTO, INSTR(WS_TEXTO,'|')+1, LENGTH(WS_TEXTO));

    WS_TEXTOT := WS_TEXTO;
	WS_PROP := '';

	WS_CAMPO := SUBSTR(PRM_CAMPO, 1, LENGTH(PRM_CAMPO)-3);

    IF  WS_AGRUPADOR = '$opc' THEN
		HTP.P('<select name="'||PRM_CAMPO||'codeop" onchange="document.getElementById('||CHR(39)||PRM_TMP_FIELD||CHR(39)||').value=this.options[this.selectedIndex].value; '||WS_SCRIP_EFEITO||'">');
		LOOP
		    IF  WS_TEXTOT = 'Y' OR INSTR(WS_TEXTOT,'|') = 0 THEN
			EXIT;
		    END IF;
		    WS_TEXTOT := WS_TEXTO;
		    WS_NM_VAR := SUBSTR(WS_TEXTOT, 1 ,INSTR(WS_TEXTOT,'|')-1);
		    WS_TEXTOT := SUBSTR(WS_TEXTOT, INSTR(WS_TEXTOT,'|')+1, LENGTH(WS_TEXTOT));

		    IF  INSTR(WS_TEXTOT,'|') = 0 THEN
		    	WS_CT_VAR := WS_TEXTOT;
		    	WS_TEXTOT := 'Y';
		    ELSE
		    	WS_CT_VAR := SUBSTR(WS_TEXTOT, 1, INSTR(WS_TEXTOT,'|')-1);
		    END IF;

		    IF PRM_DEFAULT = WS_NM_VAR THEN
			    HTP.P('<option selected="selected" value="'||WS_NM_VAR||'" '||FPDATA(PRM_DEFAULT,WS_CT_VAR,'','')||'>'||FUN.LANG(WS_CT_VAR)||'</option>');
			ELSE
			    HTP.P('<option value="'||WS_NM_VAR||'" '||FPDATA(PRM_DEFAULT,WS_CT_VAR,'','')||'>'||FUN.LANG(WS_CT_VAR)||'</option>');
			END IF;

		    WS_TEXTO := SUBSTR(WS_TEXTOT, INSTR(WS_TEXTOT,'|')+1, LENGTH(WS_TEXTOT));

		END LOOP;
		HTP.P('</select>');
    END IF;

END LISTBOX;

PROCEDURE LOAD_TIPOS AS

	WS_DIR      NUMBER := 1;
	WS_ADMIN    VARCHAR2(20);
	WS_NOACCESS EXCEPTION;

BEGIN

	WS_ADMIN := NVL(GBL.GETNIVEL, 'N');

	IF WS_ADMIN <> 'A' THEN
		RAISE WS_NOACCESS;
	END IF;

    HTP.P('<div class="searchbar">');
 
		HTP.P('<select id="viewobj" onchange="ajax(''list'', ''list_objetos'', ''prm_tipo=''+this.nextElementSibling.value+''&prm_screen=''+tela+''&prm_visao=''+this.value, true, ''ajax''); ">');
			HTP.P(FUN.LIST_VIEW('T'));
		HTP.P('</select>');

		HTP.P('<select name="colgrp" id="lisobj" onchange="ajax(''list'', ''list_objetos'', ''prm_tipo=''+this.value+''&prm_screen=''+tela+''&prm_visao=''+this.previousElementSibling.value, true, ''ajax''); document.getElementById(''tipo-objeto'').value = this.value;">');
			HTP.P('<option selected disabled hidden value="CONSULTA">'||FUN.LANG('BUSCA POR TIPO DE OBJETO')||'</option>');
			HTP.P('<option value="">'||FUN.LANG('TODOS')||'</option>');
			FOR I IN(SELECT DISTINCT TP_OBJETO, DECODE(TP_OBJETO, 'SCREEN', FUN.LANG('TELA'), 'CALL_LIST', FUN.LANG('MENU'), 'HEATMAP', FUN.LANG('MAPA DE CALOR'), TP_OBJETO) AS OBJETO FROM OBJETOS WHERE TP_OBJETO NOT IN ('UPGETPAR', 'CH_PASS', 'OBJETO') ORDER BY TP_OBJETO) LOOP
				HTP.P('<option value="'||TRIM(I.TP_OBJETO)||'">'||I.OBJETO||'</option>');
			END LOOP;
		HTP.P('</select>');

	HTP.P('</div>');
	
	HTP.P('<input id="tipo-objeto" type="hidden" value="CONSULTA">');

	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		   HTP.P('<tr>');
			    HTP.P('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=1&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax'');">VIEW</th>');
				HTP.P('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=2&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax'');">'||FUN.LANG('NOME')||'</th>');
				HTP.P('<th><a class="red" onclick="var objt = document.getElementById(''tipo-objeto'').value; var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_objetos'', ''prm_tipo=''+objt+''&prm_screen=''+tela+''&prm_order=3&prm_dir=''+dir+''&prm_visao=''+document.getElementById(''viewobj'').value, false, ''ajax'');">'||FUN.LANG('GRUPO')||'</th>');
				HTP.P('<th></th>');
				HTP.P('<th></th>');
				HTP.P('<th></th>');
				HTP.P('<th></th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
        HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
		HTP.P('</tbody>');
	HTP.P('</table>');

EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LOAD_TIPOS;


PROCEDURE SAVE_OBJ ( PRM_NOME VARCHAR2 DEFAULT NULL,
					 PRM_ATRIBUTO VARCHAR2 DEFAULT NULL,
					 PRM_GRUPO VARCHAR2 DEFAULT NULL,
					 PRM_TIPO VARCHAR2 DEFAULT NULL,
                     PRM_VISAO VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT    NUMBER;
	WS_CODIGO   VARCHAR2(200);
    WS_BROWSER  VARCHAR2(200);
	WS_VISAO    VARCHAR2(200);
    WS_ATRIBUTO VARCHAR2(200);
    WS_NOME     VARCHAR2(200);
	WS_USUARIO  VARCHAR2(80);

	WS_FAIL     EXCEPTION;
	WS_NOUSER   EXCEPTION;

BEGIN
    

    WS_USUARIO  := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;


	WS_NOME     := FUN.CONVERTE(PRM_NOME);
	WS_ATRIBUTO := FUN.CONVERTE(PRM_ATRIBUTO);

	WS_VISAO := UPPER(TRIM(PRM_VISAO));

    IF PRM_TIPO = 'BROWSER' THEN
        SELECT 'SRC_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
		(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
		TO_CHAR(SYSDATE,'yymmddhhmiss')) INTO WS_CODIGO FROM DUAL;

        SELECT 'BRO_'||TO_CHAR(SYSDATE,'yymmddhhmiss') INTO WS_BROWSER FROM DUAL;
        
        
        BEGIN
	        FOR B IN(SELECT USU_NOME FROM USUARIOS WHERE USU_NOME NOT IN (SELECT GRANTEE
			  FROM TABLE_PRIVILEGES
			  WHERE OWNER = 'DWU'
			  AND TABLE_NAME = 'BRO'
			  ) AND TRIM(USU_NOME) <> TRIM(WS_USUARIO) AND STATUS <> 'A' AND TRIM(USU_NOME) IN (SELECT TRIM(USERNAME) FROM ALL_USERS)  ) LOOP
	            EXECUTE IMMEDIATE 'grant execute on DWU.BRO to "'||UPPER(TRIM(B.USU_NOME))||'" ';
	        END LOOP;
	    END;

        INSERT INTO MICRO_DATA VALUES (WS_BROWSER, WS_VISAO, WS_NOME, PRM_GRUPO, SYSDATE, 'DWU');
        INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES (WS_BROWSER, PRM_GRUPO, TRIM(WS_NOME), '', UPPER(PRM_TIPO), WS_USUARIO, '', SYSDATE, '');
        
        INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES (WS_CODIGO, PRM_GRUPO, TRIM(WS_NOME), '', 'SCREEN', WS_USUARIO, '', SYSDATE, '');
        INSERT INTO ALL_SCREENS( OWNER, SCREEN, DESCRICAO, DT_CRIACAO, PUBLICO, TIMER, FLEX_FLOW, URL_FUNDO,DISPOSITIVO ) VALUES ( 'DWU', WS_CODIGO, WS_NOME, SYSDATE, 'S', 0, 'column',  '','desktop');
        INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSX, POSY, ZINDEX, PORCENTAGEM) VALUES ('DWU', 'DEFAULT', WS_CODIGO, WS_BROWSER, '100px', '100px', '2', '0');
        INSERT INTO USER_SCREENS (USUARIO, SCREEN, STATUS) VALUES ('DWU', WS_CODIGO, 'A');
        COMMIT;
        
        BEGIN
	        







            INSERT INTO DATA_COLUNA 
	        (CD_MICRO_DATA, CD_COLUNA, NM_ROTULO, NM_MASCARA, CD_LIGACAO, ST_CHAVE, ST_BRANCO, ST_DEFAULT, ST_ALINHAMENTO, ST_INVISIVEL, FORMULA, TIPO, DS_ALINHAMENTO, TIPO_INPUT, TAMANHO, VALIDACAO, ORDEM, PERMISSAO)
	        SELECT WS_BROWSER, 
			TRIM(COLUMN_NAME), 
			REPLACE(REPLACE(REPLACE(TRIM(COLUMN_NAME), 'NM_', ''), 'CD_', ''), 'ST_', ''), '', '', 
			DECODE(NULLABLE, 'N', '1', '0'), '', 
			'', 'left', 'N', '', '', 'left', 
			DECODE(DATA_TYPE, 'NUMBER', 'number', 'text'), 
			DATA_LENGTH, '', '99', 'W' 
			FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = WS_VISAO;    
			COMMIT;


        EXCEPTION WHEN OTHERS THEN
            RAISE WS_FAIL;
        END;
    ELSIF PRM_TIPO = 'CONSULTA' THEN 
        FCL.SAVE_CONSULTA(WS_VISAO, WS_NOME, WS_NOME, '', '', '', PRM_GRUPO, '', ''); 
    ELSE
    	IF PRM_TIPO = 'SCREEN' THEN
    		SELECT 'SRC_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
    		(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
    		TO_CHAR(SYSDATE,'yymmddhhmiss')) INTO WS_CODIGO FROM DUAL;
    	ELSE
    	    SELECT 'OBJ_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
    		(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
    		TO_CHAR(SYSDATE,'yymmddhhmiss')) INTO WS_CODIGO FROM DUAL;
    	END IF;
            
		IF PRM_TIPO = 'RELATORIO' THEN
			WS_ATRIBUTO := REPLACE(TRIM(WS_ATRIBUTO), 'dwu.fcl.download?arquivo=', '');
		ELSE
			WS_ATRIBUTO := TRIM(WS_ATRIBUTO);
		END IF;
		
		IF (PRM_TIPO = 'ICONE' OR PRM_TIPO = 'IMAGE') AND NVL(WS_ATRIBUTO, 'N/A') = 'N/A' THEN
			WS_ATRIBUTO := 'dwu.fcl.download?arquivo=ipad.png';
		END IF;

		INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES (WS_CODIGO, PRM_GRUPO, TRIM(WS_NOME), '', UPPER(PRM_TIPO), WS_USUARIO, WS_ATRIBUTO, SYSDATE, '');
		INSERT INTO OBJECT_ATTRIB SELECT 'DWU','DEFAULT','DEFAULT', WS_CODIGO, CD_PROP, VL_DEFAULT FROM OBJECT_PADRAO WHERE TP_OBJETO = PRM_TIPO;

		IF PRM_TIPO = 'FILE' THEN
			INSERT INTO CALL_LIST
			(CD_LIST, CD_OBJETO, POSX, POSY )
			VALUES
			(WS_VISAO, WS_CODIGO, '', '' );
		END IF;

		IF PRM_TIPO = 'SCREEN' THEN
			INSERT INTO ALL_SCREENS
				( OWNER, SCREEN, DESCRICAO, DT_CRIACAO, PUBLICO, TIMER, FLEX_FLOW, URL_FUNDO )
			VALUES
				( 'DWU', WS_CODIGO, WS_NOME, SYSDATE, 'S', 0, 'column',  WS_ATRIBUTO);

			INSERT INTO USER_SCREENS
				(USUARIO, SCREEN, STATUS)
			VALUES
			('DWU', WS_CODIGO, 'A');
		END IF;

		COMMIT;

    END IF;

		
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_FAIL THEN
	    ROLLBACK;
		HTP.P('ERROCOLUNA');
		INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_OBJ', WS_USUARIO, 'ERRO');
	    COMMIT;
	WHEN OTHERS THEN
	    ROLLBACK;
		HTP.P('FAIL');
		INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_OBJ', WS_USUARIO, 'ERRO');
	    COMMIT;
END SAVE_OBJ;






PROCEDURE LOAD_MVIEW ( PRM_CD_GRUPO CHAR DEFAULT NULL,
		       PRM_MVISAO   CHAR DEFAULT NULL ) AS

	CURSOR CRS_VISAO IS
			SELECT	RTRIM(NM_MICRO_VISAO) AS NM_MICRO_VISAO
			FROM 	MICRO_VISAO
			WHERE	CD_GRUPO_FUNCAO = PRM_CD_GRUPO
			ORDER BY NM_MICRO_VISAO;

	WS_VISAO	CRS_VISAO%ROWTYPE;
	WS_TMP		LONG;
	WS_COUNT	NUMBER;
	WS_PRIMEIRO	VARCHAR2(60);

BEGIN
    
	WS_COUNT := 0;

	WS_TMP := '<script>';
	WS_TMP := WS_TMP||'var incrx=parent.document.getElementById(''lmview''); ';
	WS_TMP := WS_TMP||'incrx.innerHTML = '||CHR(39);
	WS_TMP := WS_TMP||'<select NAME="colgrp" id="grpnm" style="font-size: 10px;" onchange=" carrega(''LOAD_COLUMNS?prm_micro_visao=''+this.options[this.selectedIndex].value);">';

	WS_PRIMEIRO := '%First%';
	OPEN CRS_VISAO;
	LOOP
		FETCH CRS_VISAO INTO WS_VISAO;
		    EXIT WHEN CRS_VISAO%NOTFOUND;
		IF  PRM_MVISAO = WS_VISAO.NM_MICRO_VISAO THEN
		    WS_TMP := WS_TMP||'<option selected value="'||WS_VISAO.NM_MICRO_VISAO||'">'||WS_VISAO.NM_MICRO_VISAO||'</option>';
		    WS_PRIMEIRO := WS_VISAO.NM_MICRO_VISAO;
		ELSE
		    WS_TMP := WS_TMP||'<option value="'||WS_VISAO.NM_MICRO_VISAO||'">'||WS_VISAO.NM_MICRO_VISAO||'</option>';
		END IF;
		IF  WS_PRIMEIRO = '%First%' THEN
		    WS_PRIMEIRO := WS_VISAO.NM_MICRO_VISAO;
		END IF;
		WS_COUNT := WS_COUNT + 1;
	END LOOP;
	CLOSE CRS_VISAO;

	IF  WS_COUNT > 0 THEN
	    WS_TMP := WS_TMP||'</option>'||CHR(39)||'</script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'rptype'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_direct_gid'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_coluna_gid'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_linha_gid'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_agrupadores_gid'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_calc_gid'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ls_mfiltro'||CHR(39)||','||CHR(39)||CHR(39)||'); </script>';
	    HTP.P(WS_TMP);
	    FCL.LOAD_COLUMNS(WS_PRIMEIRO);
	ELSE
	    WS_TMP := '<script>';
	    WS_TMP := WS_TMP||'var incrx=parent.document.getElementById(''lmview''); ';
	    WS_TMP := WS_TMP||'incrx.innerHTML = '||CHR(39)||CHR(39)||'; ';
	    WS_TMP := WS_TMP||'var incry=parent.document.getElementById(''lagrupadores''); ';
	    WS_TMP := WS_TMP||'incry.innerHTML = '||CHR(39)||CHR(39)||'; ';
	    WS_TMP := WS_TMP||'var incrz=parent.document.getElementById(''lvalores''); ';
	    WS_TMP := WS_TMP||'incrz.innerHTML = '||CHR(39)||CHR(39)||'; </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'rptype'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_direct_gid'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_coluna_gid'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_linha_gid'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_agrupadores_gid'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ins_calc_gid'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    WS_TMP := WS_TMP||'<script> parent.phdobj('||CHR(39)||'ls_mfiltro'||CHR(39)||','||CHR(39)||'none'||CHR(39)||'); </script>';
	    HTP.P(WS_TMP);
	END IF;

END LOAD_MVIEW; 





PROCEDURE LOAD_CROCKS ( PRM_VISAO    VARCHAR2 DEFAULT NULL,
						PRM_VALORES  VARCHAR2 DEFAULT NULL,
						PRM_BUSCA    VARCHAR2 DEFAULT NULL,
						PRM_COMPLETO VARCHAR2 DEFAULT 'S',
						PRM_ORDEM    VARCHAR2 DEFAULT '1',
						PRM_DIR      VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_COLS IS
		SELECT CD_COLUNA, NM_ROTULO, ORIGEM FROM (
			SELECT CD_COLUNA, MAX(NM_ROTULO) AS NM_ROTULO, MAX(ORIGEM) AS ORIGEM FROM (
				SELECT COLUMN_NAME AS CD_COLUNA, '' AS NM_ROTULO, 'T' AS ORIGEM
				FROM USER_TAB_COLUMNS 
				WHERE TABLE_NAME = (SELECT NM_TABELA FROM MICRO_VISAO WHERE NM_MICRO_VISAO = PRM_VISAO) AND UPPER(COLUMN_NAME) LIKE '%'||UPPER(NVL(PRM_BUSCA, COLUMN_NAME))||'%'
				
				UNION ALL

				SELECT CD_COLUNA, NM_ROTULO, 'S' AS ORIGEM
				FROM MICRO_COLUNA
				WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA IS NOT NULL AND (
					UPPER(CD_COLUNA) LIKE '%'||UPPER(NVL(PRM_BUSCA, CD_COLUNA))||'%' OR
					UPPER(NM_ROTULO) LIKE '%'||UPPER(NVL(PRM_BUSCA, NM_ROTULO))||'%'
				)
 
		    ) GROUP BY CD_COLUNA 
		)
		ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDEM, '1', CD_COLUNA, '2', NM_ROTULO, CD_COLUNA) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDEM, '1', CD_COLUNA, '2', NM_ROTULO, CD_COLUNA) END DESC;


	WS_COLS CRS_COLS%ROWTYPE;
	WS_RED    NUMBER;
	WS_CLASS  VARCHAR2(20) := '';
	WS_PADRAO VARCHAR2(40) := 'PORTUGUESE';

	WS_NOADMIN EXCEPTION;

BEGIN

	









	IF NVL(GBL.GETNIVEL, 'N') <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;

	WS_PADRAO := GBL.GETLANG;

	

    IF PRM_COMPLETO = 'S' THEN

	  
		
		IF LENGTH(PRM_VISAO) > 0 THEN
		    HTP.P('<input placeholder="'||FUN.LANG('BUSCA POR NOME OU R&Oacute;TULO')||'" type="text" class="searchcolumn" oninput="var busca = document.getElementById(''painel-colunas'').children[0].value; var dir = document.getElementById(''painel-colunas'').getAttribute(''data-dir''); call(''load_crocks'', ''prm_visao='||PRM_VISAO||'&prm_valores='||PRM_VALORES||'&prm_busca=''+busca+''&prm_completo=N&prm_ordem=1&prm_dir=''+dir).then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; }); document.getElementById(''content'').innerHTML = '''';" value="'||PRM_BUSCA||'"  />');
            
		    HTP.P('<a class="busca-colunas" onclick="call(''load_crocks'', ''prm_visao='||PRM_VISAO||'&prm_valores='||PRM_VALORES||'&prm_busca=''+this.previousElementSibling.value+''&prm_completo=N'').then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; });">');
			    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="485.213px" height="485.213px" viewBox="0 0 485.213 485.213" style="enable-background:new 0 0 485.213 485.213;" 	 xml:space="preserve"> <g> 	<g> 		<path d="M363.909,181.955C363.909,81.473,282.44,0,181.956,0C81.474,0,0.001,81.473,0.001,181.955s81.473,181.951,181.955,181.951 			C282.44,363.906,363.909,282.437,363.909,181.955z M181.956,318.416c-75.252,0-136.465-61.208-136.465-136.46 			c0-75.252,61.213-136.465,136.465-136.465c75.25,0,136.468,61.213,136.468,136.465 			C318.424,257.208,257.206,318.416,181.956,318.416z"/> 		<path d="M471.882,407.567L360.567,296.243c-16.586,25.795-38.536,47.734-64.331,64.321l111.324,111.324 			c17.772,17.768,46.587,17.768,64.321,0C489.654,454.149,489.654,425.334,471.882,407.567z"/> 	</g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			HTP.P('</a>');
		END IF;
		
	END IF;

	    HTP.P('<div id="container-colunas">');
		
			HTP.P('<ul id="ajax-lista" data-dir="'||PRM_DIR||'">');

			    HTP.P('<li class="arrowline firstline">');
					HTP.P('<span><a class="red" onclick="var busca = document.getElementById(''painel-colunas'').children[0].value; var dir = order(''notsame'', ''ajax-lista''); call(''load_crocks'', ''prm_visao=''+document.getElementById(''micro-visao'').title+''&prm_valores=''+document.getElementById(''painel-colunas'').getAttribute(''data-colunas'')+''&prm_busca=''+busca+''&prm_ordem=1&prm_dir=''+dir+''&prm_completo=N'').then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; }); document.getElementById(''content'').innerHTML = '''';">'||FUN.LANG('NOME')||'</a></span>');
					HTP.P('<span class="rotulo"><a class="red" onclick="var busca = document.getElementById(''painel-colunas'').children[0].value; var dir = order(''notsame'', ''ajax-lista''); call(''load_crocks'', ''prm_visao=''+document.getElementById(''micro-visao'').title+''&prm_valores=''+document.getElementById(''painel-colunas'').getAttribute(''data-colunas'')+''&prm_busca=''+document.getElementById(''painel-colunas'').children[0].value+''&prm_ordem=2&prm_dir=''+dir+''&prm_completo=N'').then(function(resposta){ document.getElementById(''ajax-lista'').innerHTML = resposta; }); document.getElementById(''content'').innerHTML = '''';">'||FUN.LANG('R&Oacute;TULO')||'</a></span>');
					HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" xml:space="preserve"> <g> <path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 
				HTP.P('</li>');
				
				OPEN CRS_COLS;

					LOOP
						FETCH CRS_COLS INTO WS_COLS;
						EXIT WHEN CRS_COLS%NOTFOUND;

                        WS_RED := 0;
						FOR I IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_VALORES))) LOOP
							IF WS_COLS.CD_COLUNA LIKE I.COLUMN_VALUE THEN
								WS_RED := WS_RED+1;
							END IF;
						END LOOP;

						IF WS_RED > 0 THEN
                            WS_CLASS := 'used';
						END IF;
						

						HTP.P('<li title="'||WS_COLS.CD_COLUNA||'" onclick="arrow(this, '''||WS_COLS.CD_COLUNA||''', ''click'');" class="arrowline '||WS_CLASS||'" id="'||WS_COLS.CD_COLUNA||'id" data-origem="'||WS_COLS.ORIGEM||'">');
							HTP.P('<span>'||WS_COLS.CD_COLUNA||'</span>');

							HTP.P('<span class="rotulo">'||FUN.UTRANSLATE('NM_ROTULO', PRM_VISAO, WS_COLS.NM_ROTULO, WS_PADRAO)||'</span>');

							
								
								

							
								
								HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" xml:space="preserve"> <g> <path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 

							

						HTP.P('</li>');

						WS_CLASS := '';
					END LOOP;

				CLOSE CRS_COLS;
			HTP.P('</ul>');

		HTP.P('</div>');
	




EXCEPTION
	WHEN WS_NOADMIN THEN
		HTP.P(FUN.LANG('Sem permiss&atilde;o!'));
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LOAD_CROCKS;


PROCEDURE EXCLUDE_COLUMN ( PRM_COLUNA VARCHAR2 DEFAULT NULL,
                           PRM_VISAO VARCHAR2 DEFAULT NULL ) AS

		WS_COUNT   NUMBER;
		WS_USED    EXCEPTION;
		WS_NOADMIN EXCEPTION;
    BEGIN

		IF GBL.GETNIVEL <> 'A' THEN
			RAISE WS_NOADMIN;
		END IF;
		
		SELECT COUNT(*) INTO WS_COUNT FROM PONTO_AVALIACAO WHERE CD_MICRO_VISAO = PRM_VISAO AND (CS_COLUP = PRM_COLUNA OR CS_AGRUPADOR = PRM_COLUNA OR CS_COLUNA = PRM_COLUNA);
        IF WS_COUNT = 0 THEN
		    DELETE FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_COLUNA AND CD_MICRO_VISAO = PRM_VISAO;
		    COMMIT;
			HTP.P('OK');
		ELSE
		    RAISE WS_USED;
		END IF;

	EXCEPTION
		WHEN WS_NOADMIN THEN
			HTP.P('Sem permiss&atilde;o!');
		WHEN WS_USED THEN
			HTP.P('#alert '||FUN.LANG('impossivel completar solicita&ccedil;&atilde;o, coluna usada no sistema')||'!');
		WHEN OTHERS THEN
			HTP.P('#alert '||FUN.LANG('impossivel completar solicita&ccedil;&atilde;o')||'!');
END EXCLUDE_COLUMN;


PROCEDURE LOAD_COLUMN ( PRM_VISAO VARCHAR2 DEFAULT NULL,
                        PRM_NAME VARCHAR2 DEFAULT NULL  ) AS

	




	

	CURSOR CRS_VALORES IS
    SELECT ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, 
	ST_INVISIVEL, NM_UNIDADE, HINT, ROTULO_C, FORMULA, COLOR, DECODE(NVL(NM_ROTULO, 'N/A'), 'N/A', '', ' - '||NM_ROTULO) AS ROTULO, 
	NM_ROTULO, FLEXCOL, LIMITE, URL, ANOTACAO
	FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_NAME AND CD_MICRO_VISAO = PRM_VISAO;
	WS_VALOR CRS_VALORES%ROWTYPE;

	WS_AGRUPADOR VARCHAR2(2000);
	WS_LENGTH    NUMBER;
	WS_COUNT     NUMBER;
	WS_PADRAO    VARCHAR2(80) := 'PORTUGUESE';

	WS_NOADMIN   EXCEPTION;

BEGIN

		IF GBL.GETNIVEL <> 'A' THEN
			RAISE WS_NOADMIN;
		END IF;

        
		OPEN CRS_VALORES;
		    LOOP
		        FETCH CRS_VALORES INTO WS_VALOR;
		        EXIT WHEN CRS_VALORES%NOTFOUND;
		    END LOOP;
		CLOSE CRS_VALORES;

        SELECT COUNT(*) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_NAME AND CD_MICRO_VISAO = PRM_VISAO;

		IF WS_COUNT = 0 THEN
		    INSERT INTO MICRO_COLUNA ( CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, ROTULO_C, COLOR, HINT, FLEXCOL, URL, ANOTACAO) VALUES (PRM_VISAO, PRM_NAME, '', 'S', 'SEM', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'T', '', '', '', '', '', '');
		    COMMIT;
		END IF;

        

		FCL.BUTTON_LIXO('dl_column', 'prm_view|prm_coluna', PRM_VISAO||'|'||PRM_NAME, PRM_TAG => 'a');

		IF WS_VALOR.ST_AGRUPADOR = 'TPT' THEN

			SELECT LENGTH(FORMULA) INTO WS_LENGTH FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

			IF WS_LENGTH > 0 THEN
			    SELECT FORMULA INTO WS_AGRUPADOR FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
			END IF;

			HTP.P('<a style="display: block; width: 100%; text-align: center; margin: 20px 0 4px 0;" class="link" onclick="var valores = this.nextElementSibling.getElementsByClassName(''linha''); var valor = ''''; for(i=0;i<valores.length;i++){ valor = valores[i].title+''|''+valor; } fakeOption(valor, ''group-template'', ''coluna-add'', '''||PRM_VISAO||''', '''||PRM_NAME||''');">ADICIONAR COLUNA</a>');
			
			HTP.P('<ul id="colunac" style="float: none; width: 170px; margin: 0 auto;" data-default="'||WS_AGRUPADOR||'" onmouseleave="saveTpt(document.querySelector(''.medida''), '''||PRM_VISAO||''', '''||PRM_NAME||''');" data-tipo="pivot" class="medida" data-type="lista">');

				IF WS_LENGTH > 0 THEN
					--FOR I IN(SELECT COLUMN_VALUE AS COLUNA FROM TABLE(FUN.VPIPE((SELECT FORMULA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME)))) LOOP

					FOR I IN(SELECT COLUMN_VALUE AS COLUNA , T2.NM_ROTULO AS ROTULO  FROM TABLE(FUN.VPIPE((SELECT FORMULA  FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME))) T1,MICRO_COLUNA T2 
 								WHERE T2.CD_MICRO_VISAO = PRM_VISAO 
      							AND CD_COLUNA = COLUMN_VALUE) 
					LOOP
							
						HTP.P('<li onclick="swapColumn(this);" title="'||I.COLUNA||'" class="linha">'||I.COLUNA||' - '||I.ROTULO||'<span onclick="this.parentNode.remove(); saveTpt(document.querySelector(''.medida''), '''||PRM_VISAO||''', '''||PRM_NAME||''');">X</span></li>');
						HTP.P('<li onclick="swapSquare(this);" class="square"></li>');

					END LOOP;
					
				END IF;
			HTP.P('</ul>');
		ELSE
			
			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = GBL.GETUSUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;
			
			HTP.P('<ul class="colunas_att">');

				HTP.P('<li class="columnline">');
					HTP.P('<span class="label">'||FUN.LANG('R&oacute;tulo')||'</span>');
					HTP.P('<textarea onkeypress="if(!input(event, ''rotulo'')){ event.preventDefault(); }" class="" style="resize: none; height: 32px;" maxlength="40" data-default="'||FUN.UTRANSLATE('NM_ROTULO', PRM_VISAO, WS_VALOR.NM_ROTULO, WS_PADRAO)||'" id="'||PRM_NAME||'_rotulo" title="'||WS_VALOR.NM_ROTULO||'" onblur="arrow(this, '''||PRM_NAME||''', ''NM_ROTULO'');">'||FUN.UTRANSLATE('NM_ROTULO', PRM_VISAO, WS_VALOR.NM_ROTULO, WS_PADRAO)||'</textarea>');
					HTP.P('<a class="fakelang mini" onclick="fakeLang('''||PRM_NAME||'_rotulo'', '''||PRM_VISAO||'|NM_ROTULO|''+this.previousElementSibling.title, ''cd'');">L</a></span>');
				HTP.P('</li>');

				HTP.P('<li class="columnline row">');
					HTP.P('<span class="label">'||FUN.LANG('Negrito')||'</span>');
					HTP.P('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=ST_NEGRITO&prm_valor=''+this.nextElementSibling.title);"></a>');

					IF WS_VALOR.ST_NEGRITO <> 'S' THEN
						HTP.P('<span class="checkbox m2" data-positive="S" data-negative="N" title="'||WS_VALOR.ST_NEGRITO||'"></span>');
					ELSE
						HTP.P('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="'||WS_VALOR.ST_NEGRITO||'"></span>');
					END IF;

				    HTP.P('<span class="label" style="margin: 0 16px;">'||FUN.LANG('Cor da coluna')||'</span>');
					HTP.P('<input style="width: 60px; margin: 0 6px 0 0;" type="text" name="p_color" value="'||WS_VALOR.COLOR||'" size="19" onblur=" var valor = encodeURIComponent(this.value); ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=COLOR&prm_valor=''+valor); noerror('''', '''||FUN.LANG('cor alterada com sucesso!')||''', ''msg'');" />');
					HTP.P('<input style="width: 14px;" onchange="this.previousElementSibling.value = this.value; var valor = encodeURIComponent(this.value); ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=COLOR&prm_valor=''+valor); noerror('''', '''||FUN.LANG('cor alterada com sucesso!')||''', ''msg'');" type="color" value="'||WS_VALOR.COLOR||'" />');
				HTP.P('</li>');

                HTP.P('<li class="columnline">');
					HTP.P('<span class="label">'||FUN.LANG('Alinhamento')||'</span>');
					HTP.FORMSELECTOPEN( CNAME => 'p_st_alinhamento', CATTRIBUTES => 'onchange=" ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=ST_ALINHAMENTO&prm_valor=''+this.value); "');
						IF WS_VALOR.ST_ALINHAMENTO = 'CENTER' THEN
							HTP.P('<option value="CENTER" selected>Centro</option>');
						ELSE
							HTP.P('<option value="CENTER">Centro</option>');
						END IF;
						IF WS_VALOR.ST_ALINHAMENTO = 'LEFT' THEN
							HTP.P('<option value="LEFT" selected>Esquerda</option>');
						ELSE
							HTP.P('<option value="LEFT">Esquerda</option>');
						END IF;
						IF WS_VALOR.ST_ALINHAMENTO = 'RIGHT' THEN
							HTP.P('<option value="RIGHT" selected>Direita</option>');
						ELSE
							HTP.P('<option value="RIGHT">Direita</option>');
						END IF;
					HTP.FORMSELECTCLOSE;
				HTP.P('</li>');

				HTP.P('<li class="columnline" data-campo="HINT">');
					HTP.P('<span class="label">Hint</span>');
					HTP.P('<input type="text" maxlength="200" class="listener" value="'||WS_VALOR.HINT||'" />');
				HTP.P('</li>');

                HTP.P('<li class="columnline" data-campo="ROTULO_C">');
					HTP.P('<span class="label">'||FUN.LANG('R&oacute;tulo customizado')||'</span>');
					HTP.P('<textarea onkeypress="/*if(!input(event, ''rotulo'')){ event.preventDefault(); }*/" class="listener" style="resize: none; height: 64px;" maxlength="4000" data-default="'||WS_VALOR.ROTULO_C||'" >'||WS_VALOR.ROTULO_C||'</textarea>');
				HTP.P('</li>');

				HTP.P('<li class="columnline" data-campo="URL">');
					HTP.P('<span class="label">'||FUN.LANG('Imagem')||'</span>');
					HTP.P('<input type="text" class="listener" maxlength="200" data-default="'||TRIM(WS_VALOR.URL)||'" id="url-coluna" value="'||TRIM(WS_VALOR.URL)||'" />');
				HTP.P('</li>');


			HTP.P('</ul>');
            HTP.P('<ul class="colunas_att">');

			    HTP.P('<li class="columnline">');
					HTP.P('<span class="label">'||FUN.LANG('M&aacute;scara')||'</span>');
					HTP.P('<a class="script" onclick="call(''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=NM_MASCARA&prm_valor=''+document.getElementById(''lista-mascara'').title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					FCL.FAKEOPTION('lista-mascara', ''||WS_VALOR.NM_MASCARA||'', ''||WS_VALOR.NM_MASCARA||'', 'lista-mascara', 'N', 'N', '');
				HTP.P('</li>');
				
				HTP.P('<li class="columnline row">');
					HTP.P('<span class="label">'||FUN.LANG('Gerar total')||'</span>');
					HTP.P('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=ST_GERA_REL&prm_valor=''+this.nextElementSibling.title);"></a>');
					IF WS_VALOR.ST_GERA_REL <> 'S' THEN
						HTP.P('<span class="checkbox m2" data-positive="S" data-negative="N" title="'||WS_VALOR.ST_GERA_REL||'"></span>');
					ELSE
						HTP.P('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="'||WS_VALOR.ST_GERA_REL||'"></span>');
					END IF;

					HTP.P('<span class="label">'||FUN.LANG('Incluir c&oacute;digo')||'</span>');
					HTP.P('<a class="script" onclick="ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=ST_COM_CODIGO&prm_valor=''+this.nextElementSibling.title);"></a>');
					IF WS_VALOR.ST_COM_CODIGO <> 'S' THEN
						HTP.P('<span class="checkbox m2" data-positive="S" data-negative="N" title="'||WS_VALOR.ST_COM_CODIGO||'"></span>');
					ELSE
						HTP.P('<span class="checkbox m2 checked" data-positive="S" data-negative="N" title="'||WS_VALOR.ST_COM_CODIGO||'"></span>');
					END IF;
				HTP.P('</li>');
				
				HTP.P('<li class="columnline">');
					HTP.P('<span class="label">'||FUN.LANG('Agrupador')||'</span>');
					HTP.P('<select onchange=" ajax(''fly'', ''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=ST_AGRUPADOR&prm_valor=''+this.value); ">');
						IF WS_VALOR.ST_AGRUPADOR = 'SEM' THEN
							HTP.P('<option value="SEM" selected="selected">'||FUN.LANG('Sem')||'</option>');
						ELSE
							HTP.P('<option value="SEM">'||FUN.LANG('Sem')||'</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'SUM' THEN
							HTP.P('<option value="SUM" selected="selected">Sum</option>');
						ELSE
							HTP.P('<option value="SUM">Sum</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'AVG' THEN
							HTP.P('<option value="AVG" selected="selected">Avg</option>');
						ELSE
							HTP.P('<option value="AVG">Avg</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'MAX' THEN
							HTP.P('<option value="MAX" selected="selected">Max</option>');
						ELSE
							HTP.P('<option value="MAX">Max</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'MIN' THEN
							HTP.P('<option value="MIN" selected="selected">Min</option>');
						ELSE
							HTP.P('<option value="MIN" >Min</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'EXT' THEN
							HTP.P('<option value="EXT" selected="selected">Ext</option>');
						ELSE
							HTP.P('<option value="EXT">Ext</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'PSM' THEN
							HTP.P('<option value="PSM" selected="selected" title="trunc((ratio_to_report(sum(FORMULA)) over ()*100))">Psm</option>');
						ELSE
							HTP.P('<option value="PSM" title="trunc((ratio_to_report(sum(FORMULA)) over ()*100))">Psm</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'PCT' THEN
							HTP.P('<option value="PCT" selected="selected" title="trunc((ratio_to_report(count(distinct FORMULA)) over ()*100))">Pct</option>');
						ELSE
							HTP.P('<option value="PCT" title="trunc((ratio_to_report(count(distinct FORMULA)) over ()*100))">Pct</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'CNT' THEN
							HTP.P('<option value="CNT" selected="selected" title="count(distinct FORMULA)">CNT</option>');
						ELSE
							HTP.P('<option value="CNT" title="count(distinct FORMULA)">CNT</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'MED' THEN
							HTP.P('<option value="MED" selected="selected">Med</option>');
						ELSE
							HTP.P('<option value="MED">Med</option>');
						END IF;
						IF WS_VALOR.ST_AGRUPADOR = 'MOD' THEN
							HTP.P('<option value="MOD" selected="selected">Mod</option>');
						ELSE
							HTP.P('<option value="MOD">Mod</option>');
						END IF;
					HTP.P('</select>');
				HTP.P('</li>');
				
				HTP.P('<li class="columnline">');
					HTP.P('<span class="label">'||FUN.LANG('Liga&ccedil;&atilde;o')||'</span>');
					HTP.P('<a class="script" onclick="call(''save_column'', ''prm_visao='||PRM_VISAO||'&prm_name='||PRM_NAME||'&prm_campo=CD_LIGACAO&prm_valor=''+document.getElementById(''lista-taux-fixa'').title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					FCL.FAKEOPTION('lista-taux-fixa', ''||WS_VALOR.CD_LIGACAO||'', ''||WS_VALOR.CD_LIGACAO||'', 'lista-taux-fixa', 'N', 'N');
				HTP.P('</li>');
				

				HTP.P('<li class="columnline" data-campo="NM_UNIDADE">');
					HTP.P('<span class="label">'||FUN.LANG('Unidade de medida')||'</span>');
					HTP.P('<input type="text" class="listener" maxlength="20" data-default="'||WS_VALOR.NM_UNIDADE||'" value="'||WS_VALOR.NM_UNIDADE||'" />');
				HTP.P('</li>');

				HTP.P('<li class="columnline" data-campo="FLEXCOL">');
					HTP.P('<span class="label">'||FUN.LANG('Flexcol')||'</span>');
					HTP.P('<input type="text" class="listener" maxlength="80" data-default="'||WS_VALOR.FLEXCOL||'" value="'||WS_VALOR.FLEXCOL||'" />');
				HTP.P('</li>');

				HTP.P('<li class="columnline" data-campo="LIMITE">');
					HTP.P('<span class="label">'||FUN.LANG('Limite do texto')||'</span>');
					HTP.P('<input type="text" class="listener" data-default="'||WS_VALOR.LIMITE||'"  value="'||WS_VALOR.LIMITE||'" />');
				HTP.P('</li>');
				
			HTP.P('</ul>');

            HTP.P('<ul class="colunas_att full">');
                HTP.P('<li class="columnline" data-campo="ANOTACAO">');
					HTP.P('<span class="label">'||FUN.LANG('Anota&ccedil;&atilde;o')||'</span>');
					HTP.P('<textarea style="height: 100px;" maxlength="3000" class="listener" data-default="'||TRIM(WS_VALOR.ANOTACAO)||'" id="anotacao-coluna">'||TRIM(WS_VALOR.ANOTACAO)||'</textarea>');
				HTP.P('</li>');
			HTP.P('</ul>');
			
			HTP.P('<ul class="colunas_att full">');
                HTP.P('<li class="columnline" data-campo="FORMULA">');
					HTP.P('<span class="label">'||FUN.LANG('F&oacute;rmula')||'</span>');
					HTP.P('<textarea maxlength="3000" class="listener" data-default="'||TRIM(WS_VALOR.FORMULA)||'" id="formula-coluna" data-startkey="" data-lastkey="" data-search="" onkeyup="auto(this, event, '''||PRM_VISAO||''');">'||TRIM(WS_VALOR.FORMULA)||'</textarea>');
				HTP.P('</li>');
			HTP.P('</ul>');
			HTP.P('<ul id="auto-complete-formula" class="auto off"></ul>');

		END IF;
EXCEPTION 
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
	    HTP.P('#alert '||FUN.LANG('impossivel completar solicita&ccedil;&atilde;o')||'!');
        HTP.P(SQLERRM);
END LOAD_COLUMN;

PROCEDURE AUTO_COMPLETE ( PRM_VISAO   VARCHAR2 DEFAULT NULL,
                          PRM_LETTERS VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_AUTO IS
	    SELECT CD_COLUNA, NM_ROTULO, FORMULA FROM MICRO_COLUNA
		WHERE CD_MICRO_VISAO = PRM_VISAO
		AND UPPER(CD_COLUNA) LIKE UPPER(PRM_LETTERS||'%')
		AND ROWNUM < 8;
	WS_AUTO CRS_AUTO%ROWTYPE;

BEGIN

    OPEN CRS_AUTO;
	    LOOP
		    FETCH CRS_AUTO INTO WS_AUTO;
			EXIT WHEN CRS_AUTO%NOTFOUND;
			    HTP.P('<li title="'||WS_AUTO.FORMULA||'" onclick="autoClick(this);">'||WS_AUTO.CD_COLUNA||'</li>');
		END LOOP;
	CLOSE CRS_AUTO;

END AUTO_COMPLETE;



PROCEDURE SAVE_COLUMN ( PRM_VISAO VARCHAR2 DEFAULT NULL,
                        PRM_NAME  VARCHAR2 DEFAULT NULL,
                        PRM_CAMPO VARCHAR2 DEFAULT NULL,
                        PRM_VALOR VARCHAR2 DEFAULT NULL ) AS


    WS_COUNT    NUMBER;
	WS_PADRAO   VARCHAR2(40);
	WS_CONVERTE VARCHAR2(4000);
	WS_USUARIO  VARCHAR2(80);

	WS_NOUSER   EXCEPTION;

BEGIN
    
    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

    WS_CONVERTE := FUN.CONVERTE(PRM_VALOR);

    SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO='CD_LINGUAGEM';

    IF WS_COUNT = 1 THEN
		SELECT NVL(CONTEUDO, 'PORTUGUESE') INTO WS_PADRAO
		FROM   PARAMETRO_USUARIO
		WHERE  CD_USUARIO = WS_USUARIO AND
		CD_PADRAO='CD_LINGUAGEM';
	ELSE
	    WS_PADRAO := 'PORTUGUESE';
	END IF;

    SELECT COUNT(*) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

	IF WS_COUNT < 2 THEN
	    IF WS_COUNT = 0 THEN
	        INSERT INTO MICRO_COLUNA ( CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, ROTULO_C, COLOR, HINT, FLEXCOL, URL, ANOTACAO ) VALUES (PRM_VISAO, PRM_NAME, '', 'S', 'SEM', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'T', '', '', '', '', '', '');
		END IF;
	    CASE PRM_CAMPO
			WHEN 'NM_ROTULO' THEN

				SELECT COUNT(*) INTO WS_COUNT FROM TRADUCAO_COLUNAS WHERE CD_TABELA = PRM_VISAO AND CD_COLUNA = 'NM_ROTULO' AND CD_LINGUAGEM = WS_PADRAO AND LANG_DEFAULT = (SELECT NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME) AND TIPO = 'C';

				IF WS_COUNT = 0 THEN
				    INSERT INTO TRADUCAO_COLUNAS VALUES (PRM_VISAO, 'NM_ROTULO', WS_PADRAO, TRIM(WS_CONVERTE), TRIM(WS_CONVERTE), 'C', 'N');
				ELSE
					UPDATE TRADUCAO_COLUNAS
					SET TEXTO = TRIM(WS_CONVERTE)
					WHERE CD_TABELA = PRM_VISAO
					AND TIPO = 'C'
					AND CD_COLUNA = 'NM_ROTULO'
					AND CD_LINGUAGEM = WS_PADRAO
					AND LANG_DEFAULT = (SELECT NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME);

					IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
						UPDATE TRADUCAO_COLUNAS
						SET LANG_DEFAULT = TRIM(WS_CONVERTE)
						WHERE CD_TABELA = PRM_VISAO
						AND CD_COLUNA = 'NM_ROTULO'
						 AND TIPO = 'C'
						AND LANG_DEFAULT = (SELECT NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME);
					END IF;
				END IF;
				
				
					
					UPDATE MICRO_COLUNA
					SET NM_ROTULO = WS_CONVERTE
					WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
					COMMIT; 

					HTP.P('#alert '||FUN.LANG('R&oacute;tulo alterado com sucesso')||'!');
				


				
			WHEN 'ST_GERA_REL' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_GERA_REL = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Gerar total alterado com sucesso')||'!');
			WHEN 'ST_AGRUPADOR' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_AGRUPADOR = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Agrupador alterado com sucesso')||'!');
			WHEN 'NM_MASCARA' THEN
			    UPDATE MICRO_COLUNA
		        SET NM_MASCARA = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Mascara alterada com sucesso')||'!');
			WHEN 'CD_LIGACAO' THEN
			    UPDATE MICRO_COLUNA
		        SET CD_LIGACAO = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Liga&ccedil;&atilde;o alterada com sucesso')||'!');
			WHEN 'ST_COM_CODIGO' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_COM_CODIGO = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Com c&oacute;digo alterado com sucesso')||'!');
			WHEN 'ST_ALINHAMENTO' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_ALINHAMENTO = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Alinhamento alterado com sucesso')||'!');
			WHEN 'ST_RESUMIDO' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_RESUMIDO = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Resumido alterado com sucesso')||'!');
		    WHEN 'ST_NEGRITO' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_NEGRITO = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Negrito alterado com sucesso')||'!');
		    WHEN 'ST_INVISIVEL' THEN
			    UPDATE MICRO_COLUNA
		        SET ST_INVISIVEL = UPPER(TRIM(WS_CONVERTE))
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Invis&iacute;vel alterado com sucesso')||'!');
			WHEN 'NM_UNIDADE' THEN
			    UPDATE MICRO_COLUNA
		        SET NM_UNIDADE = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('Unidade alterada com sucesso')||'!');

			WHEN 'HINT' THEN
			    UPDATE MICRO_COLUNA
		        SET HINT = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('Hint alterado com sucesso')||'!');

			WHEN 'LIMITE' THEN
			    UPDATE MICRO_COLUNA
		        SET LIMITE = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('Limite alterado com sucesso')||'!');

			WHEN 'ROTULO_C' THEN
			    UPDATE MICRO_COLUNA
		        SET ROTULO_C = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('R&oacute;tulo alterado com sucesso')||'!');

			WHEN 'COLOR' THEN
			    UPDATE MICRO_COLUNA
		        SET COLOR = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
				HTP.P('#alert '||FUN.LANG('Cor alterada com sucesso')||'!');
		    WHEN 'FLEXCOL' THEN
			    UPDATE MICRO_COLUNA
		        SET FLEXCOL = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('Flexcol alterada com sucesso')||'!');

			WHEN 'URL' THEN
			    UPDATE MICRO_COLUNA
		        SET URL = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('Imagem alterada com sucesso')||'!');
			
			WHEN 'ANOTACAO' THEN
			    UPDATE MICRO_COLUNA
		        SET ANOTACAO = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;

				HTP.P(FUN.LANG('Anota&ccedil;&atilde;o alterada com sucesso')||'!');

			WHEN 'FORMULA' THEN
			    UPDATE MICRO_COLUNA
		        SET FORMULA = TRIM(WS_CONVERTE)
		        WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA = PRM_NAME;
		        
		        DELETE FROM OBJECT_ATTRIB WHERE CD_PROP = 'TPT' AND CD_OBJECT = PRM_NAME AND OWNER <> 'DWU';
		        	
				HTP.P(FUN.LANG('F&oacute;rmula alterada com sucesso')||'!');
				
			ELSE
			    HTP.P(''||FUN.LANG('erro no case, campo n&atilde;o especificado')||'');
		END CASE;
	ELSE
	    HTP.P('#alert '||FUN.LANG('Micro coluna n&atilde;o encontrada com nome e a view definidos!')||'');
	END IF;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P('#alert '||FUN.LANG('Erro ao alterar')||'!');
END SAVE_COLUMN;


PROCEDURE TESTA_FORMULA ( PRM_TABELA  VARCHAR2 DEFAULT NULL,
                          PRM_COLUNA  VARCHAR2 DEFAULT NULL,
              			  PRM_SCREEN  VARCHAR2 DEFAULT NULL ) AS
						  
	WS_SQL     VARCHAR2(4000);
	WS_CURSOR  INTEGER;
	WS_TABELA  VARCHAR2(400);
	WS_FORMULA VARCHAR2(400);
						  
BEGIN

    SELECT NM_TABELA INTO WS_TABELA FROM MICRO_VISAO WHERE UPPER(NM_MICRO_VISAO) = UPPER(PRM_TABELA);
	
    WS_FORMULA := FUN.XCALC(PRM_COLUNA, PRM_TABELA, 'SRC_12723150427125752');

    WS_SQL := 'select '||WS_FORMULA||' from '||WS_TABELA;
	
	WS_CURSOR := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
	DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
	
EXCEPTION 
	WHEN OTHERS THEN
		HTP.P('FAIL '||SQLERRM);
END TESTA_FORMULA;


PROCEDURE LOAD_COLUMNS ( PRM_MICRO_VISAO CHAR DEFAULT NULL ) AS

	CURSOR CRS_VISAO IS
			SELECT	RTRIM(NM_MICRO_VISAO) AS NM_MICRO_VISAO
			FROM 	MICRO_VISAO
			WHERE	CD_GRUPO_FUNCAO = PRM_MICRO_VISAO
			ORDER BY NM_MICRO_VISAO;

	WS_VISAO	CRS_VISAO%ROWTYPE;
	WS_TMP		LONG;
	WS_COUNTER	NUMBER;

	TYPE WS_TMCOLUNAS		IS TABLE OF	MICRO_COLUNA%ROWTYPE
			    		INDEX BY PLS_INTEGER;

	CURSOR NC_COLUNAS IS		SELECT * FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_MICRO_VISAO;

	RET_MCOL			WS_TMCOLUNAS;

BEGIN
    
	OPEN NC_COLUNAS;
	LOOP
	    FETCH NC_COLUNAS BULK COLLECT INTO RET_MCOL LIMIT 100;
	    EXIT WHEN NC_COLUNAS%NOTFOUND;
	END LOOP;
	CLOSE NC_COLUNAS;

	WS_TMP := '<script>';
	WS_TMP := WS_TMP||'var incrx=parent.document.getElementById(''lagrupadores''); ';
	WS_TMP := WS_TMP||'incrx.innerHTML = '||CHR(39);
	WS_TMP := WS_TMP||'<select name="colagp" id="agrp" style="font-size: 10px;" >';

	WS_COUNTER := 0;
	LOOP
	    WS_COUNTER := WS_COUNTER + 1;
	    IF  WS_COUNTER > RET_MCOL.COUNT THEN
		EXIT;
	    END IF;
	    IF  RET_MCOL(WS_COUNTER).ST_AGRUPADOR = 'SEM' THEN
		WS_TMP := WS_TMP||'<option value="'||RET_MCOL(WS_COUNTER).CD_COLUNA||'" >'||RET_MCOL(WS_COUNTER).NM_ROTULO||' </option>';
	    END IF;
	END LOOP;
	WS_TMP := WS_TMP||'</select>'||CHR(39)||';</script>';

	WS_TMP := WS_TMP||'<script>';
	WS_TMP := WS_TMP||'var incrx=parent.document.getElementById(''lvalores''); ';
	WS_TMP := WS_TMP||'incrx.innerHTML = '||CHR(39);
	WS_TMP := WS_TMP||'<select NAME="colval" id="agvl" style="font-size: 10px;" >';
	WS_COUNTER := 0;
	LOOP
	    WS_COUNTER := WS_COUNTER + 1;
	    IF  WS_COUNTER > RET_MCOL.COUNT THEN
		EXIT;
	    END IF;
	    IF  RET_MCOL(WS_COUNTER).ST_AGRUPADOR <> 'SEM' OR RET_MCOL(WS_COUNTER).TIPO='C' THEN
	        WS_TMP := WS_TMP||'<option value="'||RET_MCOL(WS_COUNTER).CD_COLUNA||'" >'||RET_MCOL(WS_COUNTER).NM_ROTULO||' </option>';
	    END IF;
	END LOOP;
	WS_TMP := WS_TMP||'</select>'||CHR(39)||';</script>';

	HTP.P(WS_TMP);

END LOAD_COLUMNS;


PROCEDURE DL_COLUMN ( PRM_VIEW   VARCHAR2 DEFAULT NULL,
                      PRM_COLUNA VARCHAR2 DEFAULT NULL ) AS

	WS_ERRO    EXCEPTION;
	WS_NOADMIN EXCEPTION;

BEGIN
    
	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	
	BEGIN
        DELETE FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_COLUNA AND CD_MICRO_VISAO = PRM_VIEW;
		COMMIT;

		HTP.P('#alert '||FUN.LANG('Coluna excluida do sistema')||'!');
		
		INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Coluna '||PRM_COLUNA||' excluida da view '||PRM_VIEW, GBL.GETUSUARIO, 'EVENTO');
		COMMIT;
	EXCEPTION WHEN OTHERS THEN
	    RAISE WS_ERRO;
	END;
EXCEPTION
    WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_ERRO THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir a coluna')||'!');
    WHEN OTHERS THEN
        HTP.P(SQLERRM);
END DL_COLUMN;



PROCEDURE INITCAB (	WS_XCOUNT	IN OUT 	NUMBER,
					WS_SCOL		IN OUT 	NUMBER,
					PRM_COLUNA	IN OUT 	VARCHAR2,
					WS_MODE		IN OUT 	VARCHAR2,
					CD_LIGACAO	IN OUT 	VARCHAR2,
					ST_COM_CODIGO   IN OUT  VARCHAR2,
					WS_CONTENT_ANT	IN OUT 	LONG,
					PRM_MICRO_VISAO	VARCHAR2 DEFAULT NULL,
                    PRM_OBJID       VARCHAR2 DEFAULT NULL,
					PRM_INVISIBLE   IN OUT 	NUMBER ) AS

			WS_MASCARA     VARCHAR2(400);
            WS_COUNT       NUMBER;
            WS_COLSPAN     NUMBER;
			WS_ALINHAMENTO VARCHAR2(400);
			WS_NEGRITO     VARCHAR2(400);
			WS_FIX         VARCHAR2(400);

BEGIN
    
	WS_COUNT := 0;
    IF LENGTH(FUN.GETPROP(PRM_OBJID,'CALCULADA')) > 0 THEN
        FOR I IN (SELECT COLUMN_VALUE AS VALOR FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_OBJID,'CALCULADA'))))) LOOP
            IF INSTR(I.VALOR, '<') > 0 THEN
                WS_COUNT := WS_COUNT+1;
            END IF;
        END LOOP;
    END IF;

	IF LENGTH(FUN.GETPROP(PRM_OBJID,'CALCULADA')) > 0 THEN
        FOR I IN (SELECT COLUMN_VALUE AS VALOR FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_OBJID,'CALCULADA'))))) LOOP
            IF INSTR(I.VALOR, '>') > 0 THEN
                WS_COUNT := WS_COUNT+1;
            END IF;
        END LOOP;
    END IF;
    
    WS_COLSPAN := ((WS_XCOUNT*WS_SCOL)+WS_COUNT)-(PRM_INVISIBLE*WS_XCOUNT);

	SELECT ST_ALINHAMENTO, ST_NEGRITO INTO WS_ALINHAMENTO, WS_NEGRITO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_MICRO_VISAO AND CD_COLUNA = PRM_COLUNA;

	IF TRIM(WS_ALINHAMENTO) = 'RIGHT' THEN
		IF(TRIM(WS_NEGRITO) = 'S') THEN
			WS_FIX := WS_FIX||' dir bld';
		ELSE
			WS_FIX := WS_FIX||' dir';
		END IF;
	ELSIF TRIM(WS_ALINHAMENTO) = 'CENTER' THEN
		IF(RTRIM(WS_NEGRITO) = 'S') THEN
			WS_FIX := WS_FIX||' cen bld';
		ELSE
			WS_FIX := WS_FIX||' cen';
		END IF;
	ELSE
		IF(RTRIM(WS_NEGRITO) = 'S') THEN
			WS_FIX := WS_FIX||' bld';
		END IF;
	END IF;

	WS_FIX := TRIM(WS_FIX);

    HTP.PRN('<th class="'||WS_FIX||'" colspan="'||WS_COLSPAN||'" title="ws_xcount => '||WS_XCOUNT||', ws_scol => '||WS_SCOL||', ws_count => '||WS_COUNT||'">');
	IF  CD_LIGACAO <> 'SEM' THEN
	    IF  ST_COM_CODIGO = 'S' THEN
			WS_CONTENT_ANT := WS_CONTENT_ANT||'-'||FUN.CDESC(WS_CONTENT_ANT,CD_LIGACAO);
	    ELSE
			WS_CONTENT_ANT := FUN.CDESC(WS_CONTENT_ANT,CD_LIGACAO);
	    END IF;
	END IF;
	BEGIN
	    SELECT NM_MASCARA INTO WS_MASCARA FROM MICRO_COLUNA T1 WHERE T1.CD_COLUNA = PRM_COLUNA AND T1.CD_MICRO_VISAO = PRM_MICRO_VISAO AND ROWNUM = 1;
	    HTP.P(TRIM(FUN.UTRANSLATE('NM_ROTULO', PRM_MICRO_VISAO, FUN.IFMASCARA(WS_CONTENT_ANT,WS_MASCARA, PRM_MICRO_VISAO, PRM_COLUNA, '', '', '', ''))));
	EXCEPTION WHEN OTHERS THEN
	    HTP.P(TRIM(FUN.UTRANSLATE('NM_ROTULO', PRM_MICRO_VISAO, WS_CONTENT_ANT)));
	END;
	HTP.P('</th>');

END INITCAB;


PROCEDURE AV_PROP ( WS_PAR_SUMARY VARCHAR2, 
                    WS_TYPE       VARCHAR2 DEFAULT 'NOSUB', 
					PRM_SCREEN    VARCHAR2 DEFAULT 'DEFAULT' ) AS

	WS_COUNT			NUMBER;
	WS_COUNTER          NUMBER;
	WS_MASCARA			VARCHAR2(30);
	WS_CD_PROP			DBMS_SQL.VARCHAR2_TABLE;
	WS_PROP				DBMS_SQL.VARCHAR2_TABLE;
	WS_ROTULO			DBMS_SQL.VARCHAR2_TABLE;
	WS_TIPO				DBMS_SQL.VARCHAR2_TABLE;
	WS_SUFIXO			DBMS_SQL.VARCHAR2_TABLE;
	WS_SCRIPT			DBMS_SQL.VARCHAR2_TABLE;
	WS_LIST				DBMS_SQL.VARCHAR2_TABLE;
	WS_GRUPO            DBMS_SQL.VARCHAR2_TABLE;
	WS_HINT			    DBMS_SQL.VARCHAR2_TABLE;
	WS_TITLE            VARCHAR2(60);
	WS_VISAO            VARCHAR2(40);
	WS_GRUPO_START      VARCHAR2(60);
	WS_ORDEM            DBMS_SQL.NUMBER_TABLE;
	WS_WIDTH            VARCHAR2(20);
	WS_VALOR            VARCHAR2(3000);
	WS_TIPO_OBJ         VARCHAR2(40);
	WS_ORDER            NUMBER;
	WS_READONLY         VARCHAR2(60) := '';
	WS_USUARIO          VARCHAR2(80);
	WS_ADMIN            VARCHAR2(80);

	WS_NOUSER           EXCEPTION;

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	WS_ADMIN   := GBL.GETNIVEL;

    SELECT TP_OBJETO INTO WS_TIPO_OBJ FROM OBJETOS WHERE CD_OBJETO = WS_PAR_SUMARY;

	FCL.ARRGETPROP( TRIM(WS_PAR_SUMARY), WS_CD_PROP, WS_PROP, WS_ROTULO, WS_TIPO, WS_SUFIXO, WS_SCRIPT, WS_LIST, WS_GRUPO, WS_HINT, WS_ORDEM, PRM_SCREEN);

	HTP.FORMOPEN( CATTRIBUTES => 'name="pontoa" id="saveap" style="display: none;" ', CTARGET => '', CURL => 'dwu.fcl.save_prop', CMETHOD => 'post');
		WS_COUNT := 0;
		LOOP
		    WS_COUNT := WS_COUNT + 1;
		    IF  WS_COUNT > WS_PROP.COUNT THEN
		    	EXIT;
		    END IF;
		    HTP.P( '<input class="array_nomes"  id="'||'xd_'||WS_CD_PROP(WS_COUNT)||WS_COUNT||'" value="'||WS_CD_PROP(WS_COUNT)||'" >' );
		    HTP.P( '<input class="array_transf" id="'||'id_'||WS_CD_PROP(WS_COUNT)||WS_COUNT||'" value="'||WS_PROP(WS_COUNT)||'" >' );
		END LOOP;
		HTP.FORMHIDDEN( CNAME => 'prm_objeto' , CVALUE => WS_PAR_SUMARY, CATTRIBUTES => 'id="obj" ');
		HTP.FORMHIDDEN( CNAME => 'prm_screen' , CVALUE => '', CATTRIBUTES => 'id="tnm_screen" ' );
	HTP.FORMCLOSE;

	HTP.P('<div class="itens" style="width: 346px;" data-obj="'||WS_PAR_SUMARY||'" style="position: relative;" data-save="false" onmouseleave="if(event.relatedTarget != null){ save(''saveprop''); if(document.getElementById('''||WS_PAR_SUMARY||''')){ document.getElementById('''||WS_PAR_SUMARY||''').classList.remove(''destacada''); } }" onmouseenter="if(document.getElementById('''||WS_PAR_SUMARY||''')){ document.getElementById('''||WS_PAR_SUMARY||''').classList.add(''destacada''); }" onscroll="">');
	HTP.P('<h2 class="fixed">'||FUN.LANG('ATRIBUTOS')||'</h2>');

    IF WS_TIPO_OBJ <> 'FLOAT_PAR' AND WS_TIPO_OBJ <> 'FLOAT_FILTER' THEN
	    SELECT TO_CHAR(100/COUNT(DISTINCT GRUPO), '999')||'%' INTO WS_WIDTH FROM BI_OBJECT_PADRAO WHERE TP_OBJETO = WS_TIPO_OBJ;
	
	    WS_COUNT := 0;

	    HTP.P('<div class="abas">');

			FOR I IN (SELECT DISTINCT GRUPO FROM BI_OBJECT_PADRAO WHERE TP_OBJETO = WS_TIPO_OBJ) LOOP
				IF I.GRUPO = WS_GRUPO(1) THEN
					HTP.P('<a style="width: '||WS_WIDTH||';" class="green" data-for="form-'||I.GRUPO||'" onclick="toggleAba(this);">'||FUN.LANG(I.GRUPO)||'</a>');
				ELSE
					HTP.P('<a style="width: '||WS_WIDTH||';" class="" data-for="form-'||I.GRUPO||'" onclick="toggleAba(this);">'||FUN.LANG(I.GRUPO)||'</a>');
				END IF;
			END LOOP;

	    HTP.P('</div>');
	
	ELSE
		HTP.P('<div class="abas">');
			HTP.P('<a style="width: 100%;" class="green" data-for="form-RECURSO">'||FUN.LANG('RECURSO')||'</a>');
		HTP.P('</div>');
	END IF;

	

    












	HTP.P('<ul class="form aba" id="form-'||WS_GRUPO(1)||'">');

	WS_COUNT := 0;
	WS_GRUPO_START := 'N/A';
	LOOP
	    WS_COUNT := WS_COUNT + 1;
	    IF  WS_COUNT > WS_PROP.COUNT THEN
		    HTP.P('</ul>');
			EXIT;
	    END IF;

		IF WS_COUNT = 1 THEN
		    WS_GRUPO_START := WS_GRUPO(WS_COUNT);
		END IF;


		IF WS_GRUPO(WS_COUNT) <> WS_GRUPO_START THEN
		    HTP.P('</ul>');
			HTP.P('<ul class="form aba closed" id="form-'||WS_GRUPO(WS_COUNT)||'" style="overflow: auto; height: calc(100% - '||WS_WIDTH||'px);">');
			WS_GRUPO_START := WS_GRUPO(WS_COUNT);
		END IF;

		BEGIN
			
			IF WS_ROTULO(WS_COUNT) <> 'Vertical' AND WS_CD_PROP(WS_COUNT) <> 'CALCULADA_M' AND WS_CD_PROP(WS_COUNT) <> 'CALCULADA_N' AND 
			WS_CD_PROP(WS_COUNT) <> 'DASH_MARGIN' AND WS_CD_PROP(WS_COUNT) <> 'DASH_MARGIN_RIGHT' AND WS_CD_PROP(WS_COUNT) <> 'DASH_MARGIN_BOT' AND WS_CD_PROP(WS_COUNT) <> 'DASH_MARGIN_LEFT'  THEN
			
				IF WS_CD_PROP(WS_COUNT) <> 'DASH_MARGIN_TOP' THEN
					HTP.P('<li title="'||WS_HINT(WS_COUNT)||'" data-default="'||WS_PROP(WS_COUNT)||'" data-prop="'||WS_CD_PROP(WS_COUNT)||'">');

					HTP.P('<span class="before">'||FUN.LANG(WS_ROTULO(WS_COUNT))||'</span>');
			        HTP.P('<span class="after'||WS_READONLY||'" id="'||WS_PAR_SUMARY||'_'||WS_CD_PROP(WS_COUNT)||'">');

				END IF;

				IF WS_ROTULO(WS_COUNT) = 'Agrupadores' AND WS_ADMIN = 'A' THEN  
					SELECT CD_MICRO_VISAO INTO WS_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND ROWNUM = 1;
					HTP.P('<span id="micro-visao" style="display: none;" title="'||WS_VISAO||'">'||WS_VISAO||'</span>');
					HTP.P('<a class="script" onclick="call(''alter_agrupadores'', ''prm_objeto='||WS_PAR_SUMARY||'&prm_agrupadores=''+this.nextElementSibling.title+''&prm_tipo=AGRUPADORES'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); "></a>');
					FCL.FAKEOPTION('agrupador_'||WS_PAR_SUMARY, 'Escolha um agrupador', FUN.GETPROP(WS_PAR_SUMARY, 'AGRUPADORES'), 'lista-valor', 'N', 'S', 'micro-visao');
				
				ELSIF WS_CD_PROP(WS_COUNT) = 'HIDDEN' AND WS_TIPO_OBJ IN ('LINHAS', 'BARRAS', 'COLUNAS') THEN

					SELECT CD_MICRO_VISAO INTO WS_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND ROWNUM = 1;
					HTP.P('<span id="micro-visao" style="display: none;" title="'||WS_VISAO||'">'||WS_VISAO||'</span>');
					HTP.P('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||WS_PAR_SUMARY||'&prm_prop=HIDDEN&prm_value=''+encodeURIComponent(this.nextElementSibling.title)+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					FCL.FAKEOPTION('hidden_'||WS_PAR_SUMARY, 'Valores para ocultar', FUN.GETPROP(WS_PAR_SUMARY, 'HIDDEN'), 'lista-valor-usado', 'N', 'S', 'micro-visao', PRM_FIXED =>'COLUNAS', PRM_ADICIONAL => WS_PAR_SUMARY);
					
				ELSIF WS_CD_PROP(WS_COUNT) = 'VISIVEL' AND WS_ADMIN = 'A' THEN
					SELECT CD_MICRO_VISAO INTO WS_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND ROWNUM = 1;
					HTP.P('<a class="link" onclick="fakeOption('''||WS_PAR_SUMARY||''', ''VISIVEL'', ''visivel'', '''||WS_VISAO||''');">'||FUN.LANG('ALTERAR')||'</a>');
				ELSIF WS_CD_PROP(WS_COUNT) = 'SUBQUERY' AND WS_ADMIN = 'A' THEN
				    HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''SUBQUERY'', this.nextElementSibling.title); /*document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');*/"></a>');
					FCL.FAKEOPTION('micro-coluna', 'Escolha uma subquery', FUN.GETPROP(WS_PAR_SUMARY,'SUBQUERY'), 'lista-agrupador', 'N', 'S', 'micro-visao');
				ELSIF WS_CD_PROP(WS_COUNT) = 'ENCADEADO' AND WS_ADMIN = 'A' THEN
				    HTP.P('<a class="script" onclick="call(''alter_attrib'', ''prm_objeto='||WS_PAR_SUMARY||'&prm_prop=ENCADEADO&prm_value=''+this.nextElementSibling.title+''&prm_usuario='').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					FCL.FAKEOPTION('padrao-encadeado', 'Escolha padrao para encadear', FUN.GETPROP(WS_PAR_SUMARY,'ENCADEADO'), 'lista-padroes-unicos', 'N', 'N', 'micro-visao');

				ELSIF WS_CD_PROP(WS_COUNT) = 'EXECUCAO' THEN
					HTP.P('<a class="script" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||WS_PAR_SUMARY||'&prm_prop=EXECUCAO&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true);"></a>');
					IF FUN.GETPROP(WS_PAR_SUMARY,'EXECUCAO') = 'EXCLUSIVA' THEN
						HTP.P('<span class="checkbox checked" data-positive="EXCLUSIVA" data-negative="" title="'||FUN.GETPROP(WS_PAR_SUMARY,'EXECUCAO')||'"></span>');
					ELSE
						HTP.P('<span class="checkbox" data-positive="EXCLUSIVA" data-negative="" title="'||FUN.GETPROP(WS_PAR_SUMARY,'EXECUCAO')||'"></span>');
					END IF;
				
				ELSIF WS_CD_PROP(WS_COUNT) = 'ESPACAMENTO' THEN
					WS_ORDER := 4;
					FOR I IN 1..4 LOOP
                        
						WS_VALOR := '';
						
						BEGIN
						    SELECT VALOR INTO WS_VALOR FROM(SELECT COLUMN_VALUE AS VALOR, ROWNUM AS LINHA FROM TABLE(FUN.VPIPE(FUN.GETPROP(WS_PAR_SUMARY, 'ESPACAMENTO')))) WHERE LINHA = I;
                        EXCEPTION WHEN OTHERS THEN
						    WS_VALOR := '';
						END;

						HTP.P('<input type="text" style="order: '||WS_ORDER||'; width: 30px;" onblur="this.parentNode.parentNode.parentNode.setAttribute(''data-alterado'', ''T'');" value="'||WS_VALOR||'" />');
					    WS_ORDER := WS_ORDER-1;
					END LOOP;
				ELSIF WS_CD_PROP(WS_COUNT) = 'DASH_MARGIN_TOP' THEN
					
					IF WS_TIPO_OBJ IN ('CONSULTA', 'PONTEIRO', 'VALOR', 'BARRAS', 'COLUNAS', 'PIZZA', 'LINHAS', 'MAPA', 'FILE', 'TEXTO', 'ICONE', 'IMAGE') THEN

						HTP.P('<li title="Margem do dashboard" data-default="" data-prop="">');
									
							HTP.P('<span class="before" style="margin-right: 48px;">Margem no dashboard</span>');

							HTP.P('<input type="number" min="0" style="order: 1; width: 32px; height: 16px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_LEFT&prm_valor=''+this.value+''px&prm_objeto='||WS_PAR_SUMARY||'&prm_url_default=&prm_screen='||PRM_SCREEN||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||WS_PAR_SUMARY||''').style.setProperty(''margin-left'', this.value+''px''); document.getElementById('''||WS_PAR_SUMARY||''').style.setProperty(''max-width'', ''calc(100% - ''+this.value+''px - ''+this.nextElementSibling.nextElementSibling.value+''px'');" value="'||REPLACE(FUN.GETPROP(WS_PAR_SUMARY, 'DASH_MARGIN_LEFT', PRM_SCREEN),'px','')||'" />');
							HTP.P('<span style="order: 2; display: flex; flex-flow: column;">');
								HTP.P('<input type="number" min="0" style="order: 1; width: 32px; height: 16px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_TOP&prm_valor=''+this.value+''px&prm_objeto='||WS_PAR_SUMARY||'&prm_url_default=&prm_screen='||PRM_SCREEN||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||WS_PAR_SUMARY||''').style.setProperty(''margin-top'', this.value+''px'');" value="'||REPLACE(FUN.GETPROP(WS_PAR_SUMARY, 'DASH_MARGIN_TOP', PRM_SCREEN),'px','')||'" />');
								HTP.P('<input type="number" min="0" style="order: 2; width: 32px; height: 16px; margin-top: 28px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_BOT&prm_valor=''+this.value+''px&prm_objeto='||WS_PAR_SUMARY||'&prm_url_default=&prm_screen='||PRM_SCREEN||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||WS_PAR_SUMARY||''').style.setProperty(''margin-bottom'', this.value+''px'');" value="'||REPLACE(FUN.GETPROP(WS_PAR_SUMARY, 'DASH_MARGIN_BOT', PRM_SCREEN),'px','')||'" />');
							HTP.P('</span>');
							HTP.P('<input type="number" min="0" style="order: 3; width: 32px; height: 16px; text-indent: 0;" onblur="call(''save_prop'', ''prm_prop=DASH_MARGIN_RIGHT&prm_valor=''+this.value+''px&prm_objeto='||WS_PAR_SUMARY||'&prm_url_default=&prm_screen='||PRM_SCREEN||''').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AL); } });" onchange="document.getElementById('''||WS_PAR_SUMARY||''').style.setProperty(''margin-right'', this.value+''px''); document.getElementById('''||WS_PAR_SUMARY||''').style.setProperty(''max-width'', ''calc(100% - ''+this.previousElementSibling.previousElementSibling.value+''px - ''+this.value+''px'');" value="'||REPLACE(FUN.GETPROP(WS_PAR_SUMARY, 'DASH_MARGIN_RIGHT', PRM_SCREEN),'px','')||'" />');

						HTP.P('</li>');
							
					END IF;
					
				ELSIF WS_CD_PROP(WS_COUNT) = 'CORES' AND WS_ADMIN = 'A' THEN
					
					HTP.P('<input type="text" value="'||FUN.GETPROP(WS_PAR_SUMARY, 'CORES')||'" />');
					
				ELSIF WS_CD_PROP(WS_COUNT) = 'ESTADOS' THEN
				    HTP.P('<a class="script" id="objeto-estado-script" title="'||WS_PAR_SUMARY||'" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||WS_PAR_SUMARY||'&prm_prop=ESTADOS&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true);"></a>');
					

					 FCL.FAKEOPTION('objeto-estado', 'Escolha os estados', FUN.GETPROP(WS_PAR_SUMARY, 'ESTADOS'), 'lista-estados', 'N', 'S', 'objeto-estado-script', '', '');
					
				ELSIF WS_ROTULO(WS_COUNT) = 'Cor das colunas' AND WS_ADMIN = 'A' THEN
					HTP.P('<a class="link" onclick="fakeOption('''||WS_PAR_SUMARY||''', ''Cor das colunas'', ''cor-coluna'', '''||WS_PAR_SUMARY||''');">'||FUN.LANG('ALTERAR')||'</a>');
				ELSIF WS_ROTULO(WS_COUNT) = 'Calculada' AND WS_ADMIN = 'A' THEN
					HTP.P('<a class="link" onclick="fakeOption('''||WS_PAR_SUMARY||''', ''Colunas calculadas'', ''calculada'', '''||WS_PAR_SUMARY||''');">'||FUN.LANG('ALTERAR')||'</a>');
				ELSIF WS_ROTULO(WS_COUNT) = 'Limitadores' AND WS_ADMIN = 'A' THEN
					SELECT CD_LIGACAO INTO WS_VISAO FROM PARAMETRO_PADRAO WHERE CD_PADRAO = REPLACE(WS_PAR_SUMARY, '_FILTER', '') AND ROWNUM = 1;
					HTP.P('<span id="micro-visao" style="display: none;" title="'||WS_VISAO||'">'||WS_VISAO||'</span>');
					
				    HTP.P('<a class="script" id="objeto-limitador-script" title="'||REPLACE(WS_PAR_SUMARY, '_FILTER', '')||'" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||REPLACE(WS_PAR_SUMARY, '_FILTER', '')||'&prm_prop=LIMITADORES&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true); alerta(''feed-fixo'', TR_AL);"></a>');
					
					BEGIN
						SELECT PROPRIEDADE INTO WS_VALOR FROM OBJECT_ATTRIB WHERE CD_PROP = 'LIMITADORES' AND CD_OBJECT = REPLACE(WS_PAR_SUMARY, '_FILTER', '');
						
						FCL.FAKEOPTION(REPLACE(WS_PAR_SUMARY, '_FILTER', ''), 'Escolha os limitadores', WS_VALOR, 'lista-limitador', 'N', 'S', 'micro-visao', 'LIMITADORES', '');
				    EXCEPTION WHEN OTHERS THEN
						FCL.FAKEOPTION(REPLACE(WS_PAR_SUMARY, '_FILTER', ''), 'Escolha os limitadores', FUN.GETPROP(REPLACE(WS_PAR_SUMARY, '_FILTER', ''), 'LIMITADORES'), 'lista-limitador', 'N', 'S', 'micro-visao', 'LIMITADORES', '');
					END;
				ELSIF WS_CD_PROP(WS_COUNT) = 'IMG' THEN
				    HTP.P('<a class="script" onclick="var url = ''dwu.fcl.download?arquivo=''+this.nextElementSibling.title; update_prop('''||WS_PAR_SUMARY||''', ''img_valor'', url); document.getElementById('''||WS_PAR_SUMARY||''').querySelector(''.img_container'').children[0].setAttribute(''src'', url);"></a>');
					FCL.FAKEOPTION('fake_img', 'Imagem', REPLACE(UPPER(WS_PROP(WS_COUNT)), 'dwu.fcl.download?arquivo=', ''), 'lista-arquivo', 'S', 'N');
				ELSE
					
				    IF WS_ROTULO(WS_COUNT) = 'Ordem' AND WS_ADMIN = 'A' THEN
					  	BEGIN
							SELECT PROPRIEDADE INTO WS_VALOR FROM OBJECT_ATTRIB WHERE CD_PROP = 'ORDEM' AND OWNER = 'DWU' AND CD_OBJECT = WS_PAR_SUMARY;
							FCL.INPUTP( WS_TIPO(WS_COUNT), WS_COUNT, NVL(WS_VALOR, WS_PROP(WS_COUNT)), TRIM(WS_PAR_SUMARY), WS_SUFIXO(WS_COUNT), WS_CD_PROP(WS_COUNT), WS_SCRIPT(WS_COUNT), WS_LIST(WS_COUNT));
							HTP.P('<input style="cursor: pointer; font-size: 11px; width: 54px; position: absolute;" type="button" value="DEFAULT" onclick="if(confirm(''Essa op&ccedil;&atilde;o vai alterar a ordem deste objeto em todos os usu&aacute;rios para o valor digitado, deseja prosseguir?'')){ ajax(''fly'', ''alter_ordem_geral'', ''prm_valor=''+encodeURIComponent(this.previousElementSibling.value)+''&prm_objeto='||WS_PAR_SUMARY||'''); }"/>');
						EXCEPTION WHEN OTHERS THEN
							FCL.INPUTP( WS_TIPO(WS_COUNT), WS_COUNT, WS_PROP(WS_COUNT), TRIM(WS_PAR_SUMARY), WS_SUFIXO(WS_COUNT), WS_CD_PROP(WS_COUNT), WS_SCRIPT(WS_COUNT), WS_LIST(WS_COUNT));
							HTP.P('<input style="cursor: pointer; font-size: 11px; width: 54px; position: absolute;" type="button" value="DEFAULT" onclick="if(confirm(''Essa op&ccedil;&atilde;o vai alterar a ordem deste objeto em todos os usu&aacute;rios para o valor digitado, deseja prosseguir?'')){ ajax(''fly'', ''alter_ordem_geral'', ''prm_valor=''+encodeURIComponent(this.previousElementSibling.value)+''&prm_objeto='||WS_PAR_SUMARY||'''); }"/>');

						END;
					ELSE
						FCL.INPUTP( WS_TIPO(WS_COUNT), WS_COUNT, WS_PROP(WS_COUNT), TRIM(WS_PAR_SUMARY), WS_SUFIXO(WS_COUNT), WS_CD_PROP(WS_COUNT), WS_SCRIPT(WS_COUNT), WS_LIST(WS_COUNT));
					END IF;

				END IF;
				
				HTP.P('</span>');
				
				HTP.P('</li>');
		
		    END IF;

        EXCEPTION WHEN OTHERS THEN
            HTP.P('');
		END;

	END LOOP;


	HTP.P('</div>');
	
	FCL.CLOSER_MENU;
	
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END AV_PROP;

PROCEDURE ALTER_ATTRIB ( PRM_OBJETO  VARCHAR2 DEFAULT NULL,
                         PRM_PROP    VARCHAR2 DEFAULT NULL,
                         PRM_VALUE   VARCHAR2 DEFAULT NULL,
                         PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
	WS_VALOR VARCHAR2(800);
BEGIN

    WS_VALOR := FUN.CONVERTE(PRM_VALUE);

    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_PROP = PRM_PROP AND CD_OBJECT = PRM_OBJETO AND OWNER = NVL(PRM_USUARIO, OWNER);
	IF WS_COUNT = 1 THEN
	    UPDATE OBJECT_ATTRIB SET PROPRIEDADE = WS_VALOR WHERE CD_PROP = PRM_PROP AND CD_OBJECT = PRM_OBJETO AND OWNER = NVL(PRM_USUARIO, OWNER);
	ELSIF WS_COUNT = 0 THEN
	    INSERT INTO OBJECT_ATTRIB VALUES(NVL(PRM_USUARIO, 'DWU'), 'DEFAULT', 'DEFAULT', PRM_OBJETO, PRM_PROP, WS_VALOR);
	ELSE
	    HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
	END IF;
END ALTER_ATTRIB;


PROCEDURE GET_PAR ( WS_PAR_SUMARY VARCHAR2 DEFAULT NULL,
					WS_TYPE VARCHAR2 DEFAULT 'NOSUB' ) AS

	CURSOR CRS_ATTRIB IS
		SELECT	CD_PADRAO,
			NM_PADRAO,
			TP_PADRAO,
			CD_LIGACAO,
		(SELECT NVL(CONTEUDO,'') FROM PARAMETRO_USUARIO WHERE CD_USUARIO = GBL.GETUSUARIO AND PARAMETRO_USUARIO.CD_PADRAO=PARAMETRO_PADRAO.CD_PADRAO) AS CONTEUDO
		FROM PARAMETRO_PADRAO WHERE STATUS = 'A' ORDER BY ORDEM;
	WS_ATTRIB	CRS_ATTRIB%ROWTYPE;

	WS_COUNT			NUMBER;
	WS_MASCARA			VARCHAR2(30);
	WS_PADRAO           VARCHAR2(80) := 'PORTUGUESE';

	WS_CD_PADRAO			DBMS_SQL.VARCHAR2_TABLE;
	WS_NM_PADRAO			DBMS_SQL.VARCHAR2_TABLE;
	WS_TP_PADRAO			DBMS_SQL.VARCHAR2_TABLE;
	WS_CD_LIGACAO			DBMS_SQL.VARCHAR2_TABLE;
	WS_CONTEUDO				DBMS_SQL.VARCHAR2_TABLE;

BEGIN
    
	WS_COUNT := 0;

	OPEN CRS_ATTRIB;
	LOOP
		FETCH CRS_ATTRIB INTO WS_ATTRIB;
			EXIT WHEN CRS_ATTRIB%NOTFOUND;

		WS_COUNT := WS_COUNT + 1;
		WS_CD_PADRAO(WS_COUNT)	:= WS_ATTRIB.CD_PADRAO;
		WS_NM_PADRAO(WS_COUNT)	:= WS_ATTRIB.NM_PADRAO;
		WS_TP_PADRAO(WS_COUNT)	:= WS_ATTRIB.TP_PADRAO;
		WS_CD_LIGACAO(WS_COUNT)	:= WS_ATTRIB.CD_LIGACAO;
		WS_CONTEUDO(WS_COUNT)	:= WS_ATTRIB.CONTEUDO;

	END LOOP;
	CLOSE CRS_ATTRIB;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	HTP.FORMOPEN( CATTRIBUTES => ' name="pontoa" id="saveap" ', CTARGET => '', CURL => 'dwu.fcl.save_par', CMETHOD => 'post');
	IF  WS_TYPE <> 'NOSUB' THEN
	    HTP.P( '<input type="hidden" name="ws_type"  id="'||'xd_ws_type" value="SUBMIT" >' );
	END IF;
	WS_COUNT := 0;
	LOOP
	    WS_COUNT := WS_COUNT + 1;
	    IF  WS_COUNT > WS_CD_PADRAO.COUNT THEN
	    	EXIT;
	    END IF;
	    HTP.P( '<input type="hidden" class="array_nomes"  id="'||'xd_'||WS_CD_PADRAO(WS_COUNT)||WS_COUNT||'" value="'||WS_CD_PADRAO(WS_COUNT)||'" >' );
	    HTP.P( '<input type="hidden" class="array_transf" id="'||'id_'||WS_CD_PADRAO(WS_COUNT)||WS_COUNT||'" value="'||WS_CONTEUDO(WS_COUNT)||'" >' );
	END LOOP;
	HTP.FORMCLOSE;

	HTP.P('<div class="itens" data-obj="'||WS_PAR_SUMARY||'" data-save="false" style="font-size: 13px;" onmouseleave="if(event.relatedTarget != null){ var screen = document.getElementById(''current_screen'').value; var transf = document.getElementsByClassName(''array_transf''); var nomes = document.getElementsByClassName(''array_nomes''); var x = ''''; for(i=0;i<transf.length;i++){ x = x+''x=''+encodeURIComponent(transf[i].value)+''&''; } var y = ''''; for(i=0;i<nomes.length;i++){ y = y+''y=''+nomes[i].value+''&''; } y = y.slice(0, -1); x = x.slice(0, -1); ajax(''fly'', ''save_par'', y+''&''+x, '''', ''false''); carrega(''ajscreen?prm_screen=''+screen); alerta(''feed-fixo'', TR_AL); ajax(''fly'', ''js_log'', ''prm_msg=''+encodeURIComponent(x)+''&prm_url=&prm_line=&prm_tipo=PARAMETRO'', false); }">');

	WS_COUNT := 0;

	HTP.P('<h2 class="fixed">Entrada de parâmetros</h2>');

	HTP.P('<ul class="form">');

	LOOP
	    WS_COUNT := WS_COUNT + 1;
	    IF  WS_COUNT > WS_CD_PADRAO.COUNT THEN
	    	EXIT;
	    END IF;

	    HTP.P('<li data-hint="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_NM_PADRAO(WS_COUNT), WS_PADRAO)||'">');
			FCL.INPUTP( WS_TP_PADRAO(WS_COUNT), WS_COUNT, WS_CONTEUDO(WS_COUNT), 'NO', '', WS_CD_PADRAO(WS_COUNT), RTRIM(WS_CD_LIGACAO(WS_COUNT)), '');
	    HTP.P('</li>');
	END LOOP;

	HTP.P('</ul>');

	HTP.P('</div>');

	EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);

END GET_PAR;
 

PROCEDURE GET_FLOAT  ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_OBJETOS (PRM_TIPO VARCHAR2) IS
	SELECT CD_OBJETO, NM_OBJETO
	FROM OBJETOS T1
	LEFT JOIN PARAMETRO_PADRAO T2 ON T2.CD_PADRAO = T1.CD_OBJETO
	LEFT JOIN OBJECT_ATTRIB T3 ON CD_OBJECT = T1.CD_OBJETO AND CD_PROP = 'PRIORIDADE' 
	WHERE TP_OBJETO = PRM_TIPO AND 
	T1.CD_OBJETO IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN)
	ORDER BY T3.PROPRIEDADE, T2.ORDEM;
	

	WS_OBJETO CRS_OBJETOS%ROWTYPE;

	WS_COUNT	 NUMBER;
	WS_MIN       NUMBER := 1;
	WS_MASCARA	 VARCHAR2(30);
	WS_CODIGO    VARCHAR2(300);
	WS_DESCRICAO VARCHAR2(600);
	WS_SELECTED  NUMBER;
	WS_CURSOR	 INTEGER;
	WS_LINHAS	 INTEGER;
	WS_PAR_EMP	 VARCHAR2(900);
	WS_SQL		 VARCHAR2(2000);
	WS_CHECK     VARCHAR2(250);
	WS_LIMITADOR VARCHAR2(2000);
	WS_DISPLAY   VARCHAR2(40);
	WS_MULTIPLE  VARCHAR2(40);
	WS_FLOAT     VARCHAR2(40);
	WS_ORDER     VARCHAR2(40);
	WS_PADRAO    VARCHAR2(40);
	WS_DESC      VARCHAR2(200);
	WS_TIPO      VARCHAR2(40);
	WS_LIGACAO   VARCHAR2(40);
	WS_ORDEM     VARCHAR2(10);
	WS_CONTEUDO  VARCHAR2(2000);
	WS_CONT_DESC VARCHAR2(2000);
	WS_FORMATO   VARCHAR2(80);
	WS_USER      VARCHAR2(10) := '';
	WS_EXIST     NUMBER;
	WS_MULTI     VARCHAR2(20) := 'S';
    WS_USUARIO   VARCHAR2(80);
	WS_ADMIN     VARCHAR2(80);
	WS_LINGUAGEM VARCHAR2(80) := 'PORTUGUESE';
	WS_PROPMASK	 VARCHAR2(200);

	WS_NOUSER    EXCEPTION;

BEGIN

    WS_USUARIO  := GBL.GETUSUARIO;
	WS_ADMIN    := NVL(GBL.GETNIVEL, 'N');

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	



	









	WS_LINGUAGEM := GBL.GETLANG;

    WS_SELECTED := 0;

	HTP.P('<div class="itens" id="get_float" data-alterado="F">');

		HTP.P('<h2 style="display: none !important;">'||FUN.LANG('FLOAT')||'</h2>');

		SELECT COUNT(*) INTO WS_EXIST FROM OBJETOS WHERE TP_OBJETO = 'FLOAT_PAR' AND CD_OBJETO IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN);

        

		IF  WS_ADMIN <> 'A' THEN
            WS_USER := 'user';
		END IF;

		

		IF WS_EXIST > 0 THEN
			HTP.P('<ul data-hint="'||FUN.LANG('PAR&Acirc;METROS')||'" class="form float_list '||WS_USER||'" id="form-parametro" >');
		ELSE
			HTP.P('<ul class="form float_list '||WS_USER||'" id="form-parametro">');
		END IF;

			OPEN CRS_OBJETOS('FLOAT_PAR');
			    LOOP
				    FETCH CRS_OBJETOS INTO WS_OBJETO;
					EXIT WHEN CRS_OBJETOS%NOTFOUND;
					
					SELECT CD_PADRAO, NM_PADRAO, TP_PADRAO, CD_LIGACAO, ORDEM,
					(SELECT NVL(CONTEUDO,'') FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND PARAMETRO_USUARIO.CD_PADRAO=PARAMETRO_PADRAO.CD_PADRAO AND ROWNUM = 1) AS CONTEUDO
					INTO WS_PADRAO, WS_DESC, WS_TIPO, WS_LIGACAO, WS_ORDEM, WS_CONTEUDO
					FROM PARAMETRO_PADRAO
					WHERE CD_PADRAO = WS_OBJETO.CD_OBJETO ORDER BY NM_PADRAO ASC;

					HTP.P('<li title="'||WS_OBJETO.CD_OBJETO||'" data-hint="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||'">');

					IF TRIM(FUN.GETPROP(TRIM(REPLACE(WS_OBJETO.CD_OBJETO, 'padrao_', '')), 'VAZIO')) = 'S' THEN
						WS_MIN := 0;
					END IF;

					IF FUN.GETPROP(WS_OBJETO.CD_OBJETO, 'MULTI') = 'S'  THEN

                        HTP.P('<input readonly type="hidden" id="visao_'||WS_OBJETO.CD_OBJETO||'" title="'||WS_LIGACAO||'" value="'||WS_LIGACAO||'">');
					    HTP.P('<input readonly type="text" class="float_title"  title="'||WS_PADRAO||'" value="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||'">');
					      
					    HTP.P('<a class="script" onclick="saveFloat(this.nextElementSibling.title, '''||WS_OBJETO.CD_OBJETO||''');"></a>');
					    IF FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM) <> WS_OBJETO.CD_OBJETO THEN
					        FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes', 'N', 'S', 'visao_'||WS_OBJETO.CD_OBJETO, FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||' - '||WS_OBJETO.CD_OBJETO, WS_CONTEUDO, 'true', PRM_MIN => WS_MIN);
					    ELSE
					        FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes', 'N', 'S', 'visao_'||WS_OBJETO.CD_OBJETO, WS_OBJETO.CD_OBJETO, WS_CONTEUDO, 'true', PRM_MIN => WS_MIN);
					    END IF;

					    IF WS_ADMIN = 'A' THEN
                            FCL.BUTTON_LIXO('dl_obj','prm_tela|prm_cod', PRM_SCREEN||'|'||WS_PADRAO, PRM_OBJETO=> WS_OBJETO.CD_OBJETO, PRM_TAG => 'a');						
						ELSE
							HTP.P('<a class="remove" style="display: none;" title="Fechar">X</a>');
						END IF;

					ELSE
  
						
						CASE WS_TIPO 
						   
							WHEN 'TEXTO' THEN
								WS_PROPMASK := FUN.GETPROP(WS_OBJETO.CD_OBJETO,'MASCARA');
                                HTP.P('<input class="float_title" readonly="" type="text" title="'||WS_OBJETO.CD_OBJETO||'" value="'||WS_OBJETO.NM_OBJETO||'">');
		                        HTP.P('<input onblur="saveFloat(this.value, '''||WS_OBJETO.CD_OBJETO||''');" type="text" value="'||WS_CONTEUDO||'">');
							WHEN 'DATA' THEN
                                
								HTP.P('<input class="float_title" readonly="" type="text" title="'||WS_OBJETO.CD_OBJETO||'" value="'||WS_OBJETO.NM_OBJETO||'">');
								IF OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') LIKE '%iPhone%'  THEN
									HTP.P('<input readonly="readonly" style="font-size: 18px;" type="text" id="data_id_'||WS_OBJETO.CD_OBJETO||'" onmouseover="calendar.set(this.id);" ontouchend="this.blur();" value="'||WS_CONTEUDO||'" />');
								ELSE
									HTP.P('<input readonly="readonly" type="text" id="data_id_'||WS_OBJETO.CD_OBJETO||'" onmouseover="calendar.set(this.id);" ontouchend="this.blur();" value="'||WS_CONTEUDO||'" />');
								END IF;
							WHEN 'DATA2' THEN
                                HTP.P('<input class="float_title" readonly="" type="text" title="'||WS_OBJETO.CD_OBJETO||'" value="'||WS_OBJETO.NM_OBJETO||'">');
		                        HTP.P('<input onblur="saveFloat(this.value, '''||WS_OBJETO.CD_OBJETO||''');" placeholder="DD/MM/YY" type="text" id="data_'||'id_'||WS_OBJETO.CD_OBJETO||'" oninput="this.value = VMasker.toPattern(this.value, ''99/99/99'');" value="'||WS_CONTEUDO||'" />');
						    ELSE
                                HTP.P('<input readonly type="hidden" id="visao_'||WS_OBJETO.CD_OBJETO||'" title="'||WS_LIGACAO||'" value="'||WS_LIGACAO||'">');
								HTP.P('<input readonly type="text" class="float_title" title="'||WS_PADRAO||'" value="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||'">');
								
								HTP.P('<a class="script" onclick="saveFloat(this.nextElementSibling.title, '''||WS_OBJETO.CD_OBJETO||''');"></a>');
								
								WS_FORMATO := FUN.GETPROP(WS_OBJETO.CD_OBJETO, 'FORMATO');

								FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(WS_CONTEUDO))) LOOP
									IF WS_FORMATO = '1' THEN
										WS_CONT_DESC := WS_CONT_DESC||', '||I.COLUMN_VALUE;
									ELSIF WS_FORMATO = '2' THEN
										WS_CONT_DESC := WS_CONT_DESC||', '||FUN.CDESC(I.COLUMN_VALUE, WS_LIGACAO);
									ELSE
										WS_CONT_DESC := WS_CONT_DESC||', '||I.COLUMN_VALUE||' - '||FUN.CDESC(I.COLUMN_VALUE, WS_LIGACAO);
									END IF;
								END LOOP;

								WS_CONT_DESC := SUBSTR(TRIM(WS_CONT_DESC), 2, 999);
								
								
								IF FUN.CDESC(WS_CONTEUDO, WS_LIGACAO) <> WS_CONTEUDO THEN

								    
								    IF WS_FORMATO = 'CD' THEN
									    FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes', 'S', 'N', 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, PRM_DESC => WS_CONT_DESC, PRM_MIN => 1);
                                    ELSIF WS_FORMATO = 'DS' THEN
                                        FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', FUN.CDESC(WS_CONTEUDO, WS_LIGACAO), 'lista-padroes', 'S', 'N', 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, PRM_DESC => WS_CONT_DESC, PRM_MIN => 1);
									ELSE
									    FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO||' - '||FUN.CDESC(WS_CONTEUDO, WS_LIGACAO), 'lista-padroes', 'S', 'N', 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, PRM_DESC => WS_CONT_DESC, PRM_MIN => 1);
								    END IF;

								ELSE
									FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes', 'S', 'N', 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, PRM_MIN => WS_MIN);
								END IF;
						END CASE;

						WS_CONT_DESC := '';
						
						IF WS_ADMIN = 'A' THEN
						    HTP.P('<a class="propriedades" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_PADRAO||'&prm_screen=''+tela);"></a>');
                            FCL.BUTTON_LIXO('dl_obj','prm_tela|prm_cod', PRM_SCREEN||'|'||WS_PADRAO , PRM_OBJETO=> WS_OBJETO.CD_OBJETO, PRM_TAG => 'a');							
						ELSE
							HTP.P('<a class="remove" style="display: none;" title="Fechar">X</a>');
						END IF;
						
					END IF;

					IF NVL(FUN.GETPROP(WS_PADRAO, 'ENCADEADO'), 'N/A') <> 'N/A' THEN
						HTP.P('<a class="chain" title="'||FUN.LANG('Encadeado com o float')||' '||FUN.GETPROP(WS_PADRAO, 'ENCADEADO')||'" style="background-image: url(''dwu.fcl.download?arquivo=link.svg''); background-size: 18px; position: relative; height: 18px; width: 18px; transform: rotate(45deg); margin: 0 2px;"></a>');
                    END IF;

					HTP.P('</li>');

			    END LOOP;
			CLOSE CRS_OBJETOS;

		HTP.P('</ul>');

		SELECT COUNT(*) INTO WS_EXIST FROM OBJETOS WHERE TP_OBJETO = 'FLOAT_FILTER' AND CD_OBJETO IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN);
		
        
		IF WS_EXIST > 0 THEN
		    HTP.P('<ul data-hint="'||FUN.LANG('FILTROS')||'" class="form float_list '||WS_USER||'" id="form-filtro">');
		ELSE
		    HTP.P('<ul class="form float_list '||WS_USER||'" id="form-filtro">');
		END IF;
		
			OPEN CRS_OBJETOS('FLOAT_FILTER');
			    LOOP
				    FETCH CRS_OBJETOS INTO WS_OBJETO;
					EXIT WHEN CRS_OBJETOS%NOTFOUND;

                        SELECT CD_PADRAO, NM_PADRAO, TP_PADRAO, CD_LIGACAO, ORDEM
						INTO WS_PADRAO, WS_DESC, WS_TIPO, WS_LIGACAO, WS_ORDEM
						FROM PARAMETRO_PADRAO
						WHERE CD_PADRAO = WS_OBJETO.CD_OBJETO ORDER BY NM_PADRAO ASC;
							
						BEGIN
							WS_CONTEUDO := '';
							SELECT COUNT(*) INTO WS_COUNT FROM FLOAT_FILTER_ITEM WHERE CD_USUARIO = WS_USUARIO AND CD_COLUNA = TRIM(WS_PADRAO) AND SCREEN = PRM_SCREEN;
							IF WS_COUNT <> 0 THEN
							    SELECT LISTAGG(CONTEUDO, '|') WITHIN GROUP (ORDER BY CD_COLUNA) INTO WS_CONTEUDO FROM FLOAT_FILTER_ITEM WHERE CD_USUARIO = WS_USUARIO AND CD_COLUNA = TRIM(WS_PADRAO) AND SCREEN = PRM_SCREEN GROUP BY CD_COLUNA;
							END IF;
						EXCEPTION WHEN OTHERS THEN
							HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
						END;
					
						HTP.P('<li data-hint="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||'" title="'||WS_OBJETO.CD_OBJETO||'">');

	                        HTP.P('<input readonly type="hidden" id="visao_'||WS_OBJETO.CD_OBJETO||'" title="'||WS_LIGACAO||'" value="'||WS_LIGACAO||'">');
	                        HTP.P('<input class="float_title" readonly type="text" title="'||WS_PADRAO||'" value="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM)||'">');
							HTP.P('<a class="script" onclick="document.getElementById(''get_float'').setAttribute(''data-alterado'', ''T''); call(''save_float_filter'', ''prm_conteudo=''+this.nextElementSibling.title+''&prm_coluna='||WS_OBJETO.CD_OBJETO||'&prm_screen=''+tela).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_EX); } /*document.getElementById(''saving'').classList.remove(''active'');*/ });"></a>');
						    
                            WS_FORMATO := FUN.GETPROP(WS_OBJETO.CD_OBJETO, 'FORMATO');
							WS_CONT_DESC := '';

							FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(WS_CONTEUDO))) LOOP

                                IF WS_FORMATO = '1' THEN
								    WS_CONT_DESC := WS_CONT_DESC||', '||I.COLUMN_VALUE;
								ELSIF WS_FORMATO = '2' THEN
                                    WS_CONT_DESC := WS_CONT_DESC||', '||FUN.CDESC(REPLACE(I.COLUMN_VALUE, '$[NOT]', ''), WS_LIGACAO);
								ELSE
									WS_CONT_DESC := WS_CONT_DESC||', '||REPLACE(I.COLUMN_VALUE, '$[NOT]', '')||' - '||FUN.CDESC(REPLACE(I.COLUMN_VALUE, '$[NOT]', ''), WS_LIGACAO);
								END IF;

							END LOOP;

							WS_CONT_DESC := SUBSTR(TRIM(WS_CONT_DESC), 2, 999);

                            BEGIN
                                IF FUN.GETPROP(WS_OBJETO.CD_OBJETO, 'MULTI') <> 'S' THEN
                                    WS_MULTI     := 'N';
								ELSE
                                    WS_MULTI     := 'S';
								END IF;
							EXCEPTION WHEN OTHERS THEN
                                WS_MULTI     := 'S';
							END;

                            IF FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_DESC, WS_LINGUAGEM) <> WS_OBJETO.CD_OBJETO THEN

								
								IF WS_FORMATO = 'CD' THEN
						            FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes-filtros', 'S', WS_MULTI, 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_OBJETO.CD_OBJETO||'|'||PRM_SCREEN, WS_CONT_DESC, PRM_REVERSE => 'true');
                                ELSIF WS_FORMATO = 'DS' THEN
						            FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes-filtros', 'S', WS_MULTI, 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_OBJETO.CD_OBJETO||'|'||PRM_SCREEN, WS_CONT_DESC, PRM_REVERSE => 'true');
								ELSE
						            FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes-filtros', 'S', WS_MULTI, 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_OBJETO.CD_OBJETO||'|'||PRM_SCREEN, WS_CONT_DESC, PRM_REVERSE => 'true');
								END IF;
									 
							ELSE
                                FCL.FAKEOPTION('padrao_'||WS_OBJETO.CD_OBJETO, '', WS_CONTEUDO, 'lista-padroes-filtros', 'S', WS_MULTI, 'visao_'||WS_OBJETO.CD_OBJETO, '', WS_OBJETO.CD_OBJETO||'|'||PRM_SCREEN, WS_CONT_DESC, PRM_REVERSE => 'true' );
							END IF;

                            WS_CONT_DESC := '';
							
					        IF WS_ADMIN = 'A' THEN
							    HTP.P('<a class="propriedades" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_PADRAO||'&prm_screen=''+tela);"></a>');
								FCL.BUTTON_LIXO('dl_obj','prm_cod|prm_tela', WS_PADRAO||'|'||PRM_SCREEN , PRM_OBJETO=> WS_OBJETO.CD_OBJETO);
	                        ELSE
								HTP.P('<a style="display: none;" class="remove" id="'||WS_OBJETO.CD_OBJETO||'fechar" title="Fechar">X</a>');
							END IF;


                            IF NVL(FUN.GETPROP(WS_PADRAO, 'ENCADEADO'), 'N/A') <> 'N/A' THEN
							    HTP.P('<a class="chain" title="Encadeado com o float '||FUN.GETPROP(WS_PADRAO, 'ENCADEADO')||'" style="background-image: url(''dwu.fcl.download?arquivo=link.svg''); background-size: 18px; position: relative; height: 18px; width: 18px; transform: rotate(45deg); margin: 0 2px;"></a>');
                            END IF;
					    
						HTP.P('</li>');

			    END LOOP;

			CLOSE CRS_OBJETOS;

		HTP.P('</ul>');
		
	HTP.P('</div>');
	
	


	
	FCL.CLOSER_MENU;

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END GET_FLOAT;


PROCEDURE GET_FLOAT_FILTER  ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_ATTRIB(PRM_OBJETO VARCHAR2) IS
		SELECT CD_PADRAO, NM_PADRAO, TP_PADRAO, CD_LIGACAO, ORDEM,
		(SELECT NVL(CONTEUDO,' ') FROM FLOAT_FILTER_ITEM WHERE CD_USUARIO = GBL.GETUSUARIO AND FLOAT_FILTER_ITEM.CD_COLUNA=PARAMETRO_PADRAO.CD_PADRAO AND ROWNUM = 1) AS CONTEUDO
		FROM PARAMETRO_PADRAO
		WHERE CD_PADRAO = PRM_OBJETO ORDER BY NM_PADRAO ASC;

	WS_ATTRIB	CRS_ATTRIB%ROWTYPE;

	WS_COUNT			NUMBER;
	WS_MASCARA			VARCHAR2(30);

	WS_CD_PADRAO		DBMS_SQL.VARCHAR2_TABLE;
	WS_NM_PADRAO		DBMS_SQL.VARCHAR2_TABLE;
	WS_TP_PADRAO		DBMS_SQL.VARCHAR2_TABLE;
	WS_CD_LIGACAO		DBMS_SQL.VARCHAR2_TABLE;
	WS_CONTEUDO			DBMS_SQL.VARCHAR2_TABLE;
	WS_CDESC            VARCHAR2(60);

	WS_CODIGO           VARCHAR2(300);
	WS_DESCRICAO        VARCHAR2(600);
	WS_SELECTED         NUMBER;
	WS_CURSOR	 INTEGER;
	WS_LINHAS	 INTEGER;

	WS_PAR_EMP	 VARCHAR2(900);

	WS_SQL		 VARCHAR2(2000);
	WS_CHECK     VARCHAR2(250);
	WS_DISPLAY   VARCHAR2(40);
	WS_MULTIPLE  VARCHAR2(40);
	WS_FLOAT     VARCHAR2(40);
	WS_LIMITADOR VARCHAR2(2000);
	WS_ORDER     VARCHAR2(40);
	WS_USUARIO   VARCHAR2(80);
	WS_ADMIN     VARCHAR2(80);
	WS_PADRAO    VARCHAR2(80) := 'PORTUGUESE';

	WS_NOUSER    EXCEPTION;

BEGIN
    
    WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    WS_SELECTED := 0;
	WS_COUNT := 0;

	HTP.P('<div class="itens" onmouseleave="">');

	HTP.P('<h2>'||FUN.LANG('PARAMETROS')||'</h2>');
    IF WS_ADMIN <> 'A' THEN
	    HTP.P('<ul class="float_list user">');
	ELSE
        HTP.P('<ul class="float_list">');
	END IF;

	FOR A IN (SELECT OBJECT_ID, TIPO FROM (SELECT OBJECT_ID, (SELECT TP_OBJETO FROM OBJETOS WHERE CD_OBJETO = T1.OBJECT_ID) AS TIPO FROM OBJECT_LOCATION T1 WHERE SCREEN = PRM_SCREEN) WHERE TIPO = 'FLOAT_FILTER') LOOP

		HTP.P('<li>');

			OPEN CRS_ATTRIB(A.OBJECT_ID);
			FETCH CRS_ATTRIB INTO WS_ATTRIB;
			CLOSE CRS_ATTRIB;

			CASE FUN.GETPROP(WS_ATTRIB.CD_PADRAO, 'ORDEM')
				WHEN 1 THEN
					WS_ORDER := 'ORDER BY 1 ASC';
				WHEN 2 THEN
					WS_ORDER := 'ORDER BY 1 DESC';
				WHEN 3 THEN
					WS_ORDER := 'ORDER BY 2 ASC';
				WHEN 4 THEN
					WS_ORDER := 'ORDER BY 2 DESC';
				ELSE
					WS_ORDER := '';
			END CASE;


			IF WS_ADMIN = 'A' THEN
				FCL.BUTTON_LIXO('dl_obj','prm_cod|prm_tela', WS_ATTRIB.CD_PADRAO||'|'||PRM_SCREEN);
			END IF;

			HTP.P('<div id="'||A.OBJECT_ID||'_ds" class="" title="'||A.OBJECT_ID||'" >'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_ATTRIB.NM_PADRAO, WS_PADRAO)||'</div>');

			BEGIN
				SELECT NVL(PROPRIEDADE, 'N/A') INTO WS_LIMITADOR FROM OBJECT_ATTRIB WHERE CD_OBJECT = ''||TRIM(A.OBJECT_ID)||'' AND CD_PROP = 'LIMITADORES';
			EXCEPTION WHEN OTHERS THEN
				WS_LIMITADOR := 'N/A';
			END;

			FOR I IN(SELECT NDS_CD_CODIGO, NDS_CD_EMPRESA, NDS_CD_DESCRICAO, NDS_TFISICA FROM CODIGO_DESCRICAO WHERE NDS_TABELA = UPPER(WS_ATTRIB.CD_LIGACAO) OR NDS_TFISICA = UPPER(WS_ATTRIB.CD_LIGACAO)) LOOP
				IF WS_LIMITADOR <> 'N/A' THEN
					WS_PAR_EMP := ' where '||RTRIM(I.NDS_CD_CODIGO)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||TRIM(A.OBJECT_ID)||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
				ELSE
					WS_PAR_EMP := '';
				END IF;

				WS_SQL := 'select '||RTRIM(I.NDS_CD_CODIGO)||', '||RTRIM(I.NDS_CD_DESCRICAO)||' from '||RTRIM(I.NDS_TFISICA)||WS_PAR_EMP||' '||WS_ORDER;

				WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

				DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 300);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 600);

				WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

				SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = A.OBJECT_ID AND CD_PROP = 'MULTI';

				IF WS_COUNT > 0 THEN
					SELECT PROPRIEDADE INTO WS_MULTIPLE FROM OBJECT_ATTRIB WHERE CD_OBJECT = A.OBJECT_ID AND CD_PROP = 'MULTI';
					IF WS_MULTIPLE = 'S' THEN
						WS_MULTIPLE := 'multiple';
					ELSE
						WS_MULTIPLE := '';
					END IF;
				ELSE
					WS_MULTIPLE := 'multiple';
				END IF;

				SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = A.OBJECT_ID AND CD_PROP = 'FLOAT';

				IF WS_COUNT > 0 THEN
					SELECT PROPRIEDADE INTO WS_FLOAT FROM OBJECT_ATTRIB WHERE CD_OBJECT = A.OBJECT_ID AND CD_PROP = 'FLOAT';
					IF WS_FLOAT = 'S' THEN
						WS_FLOAT := 'horizontal';
					ELSE
						WS_FLOAT := '';
					END IF;
				ELSE
					WS_FLOAT := '';
				END IF;

				HTP.P('<select title="'||FUN.LANG('ctrl para selecionar op&ccedil;&otilde;es deslizando')||'" '||WS_MULTIPLE||' class="selector '||WS_FLOAT||'">');

				LOOP
					WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
					IF  WS_LINHAS <> 1 THEN
						EXIT;
					END IF;

					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);

					WS_CHECK := 'this.classList.toggle(''selected'');';

					SELECT COUNT(*) INTO WS_SELECTED FROM FLOAT_FILTER_ITEM WHERE CD_USUARIO = WS_USUARIO AND CD_COLUNA = WS_ATTRIB.CD_PADRAO AND TRIM(CONTEUDO) = TRIM(WS_CODIGO) AND SCREEN = PRM_SCREEN;

					IF WS_SELECTED = 1 THEN
						HTP.P('<option ondblclick="if(this.selected == true){ this.selected = false; }" selected value="'||TRIM(WS_CODIGO)||'">'||WS_DESCRICAO||'</option>');
					ELSE
						HTP.P('<option ondblclick="if(this.selected == true){ this.selected = false; }" value="'||TRIM(WS_CODIGO)||'">'||WS_DESCRICAO||'</option>');
					END IF;

				END LOOP;
				DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
				HTP.P('</select>');
			END LOOP;

		HTP.P('</li>');

	END LOOP;

	HTP.P('</ul>');

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
	    HTP.P(SQLERRM);
END GET_FLOAT_FILTER;



PROCEDURE CH_PWD AS

  WS_EMAIL  VARCHAR2(60) := '';
  WS_NUMBER VARCHAR2(60) := '';
  WS_NOME   VARCHAR2(120);
  WS_USUARIO VARCHAR2(80);

  CURSOR CRS_LINGUAGENS IS
  SELECT NM_LANG
  FROM LANGUAGE
  WHERE ATIVO = 'S';

  WS_LINGUAGEM CRS_LINGUAGENS%ROWTYPE;

BEGIN
    

    WS_USUARIO := GBL.GETUSUARIO;

	SELECT USU_EMAIL, USU_COMPLETO, USU_NUMBER INTO WS_EMAIL, WS_NOME, WS_NUMBER FROM USUARIOS WHERE TRIM(USU_NOME) = WS_USUARIO;
    



    HTP.P('<div id="smartcard">');
       

	   HTP.FORMOPEN( CATTRIBUTES => ' name="pontoa" id="saveap" ', CTARGET => '', CURL => 'dwu.fcl.save_pwd', CMETHOD => 'post');
			HTP.P('<ul>');
				HTP.P('<li class="readonly"><label>Login:</label><input type="text"  value="'||WS_USUARIO||'" readonly /></li>');
				HTP.P('<li><label>'||FUN.LANG('Nome completo')||':</label><input id="completo" type="text" value="'||WS_NOME||'"/></li>');

				HTP.P('<li><label>'||FUN.LANG('Digite a nova senha')||':</label><input id="senha1" type="password" name="p_senha" value="" maxlength="28" placeholder="'||FUN.LANG('Digite a nova senha')||'" /></li>');
				
				HTP.P('<li><label>Email:</label><input type="text" onkeypress="return input(event, ''email'');"  id="email" name="email" value="'||WS_EMAIL||'" maxlength="40" placeholder="Email"/></li>');
				HTP.P('<li><label>'||FUN.LANG('Telefone')||':</label><input type="text" id="number" name="number" oninput="this.value = VMasker.toPattern(this.value, ''(99)9999-9999'');" value="'||WS_NUMBER||'" maxlength="40" placeholder="'||FUN.LANG('Telefone')||'"/></li>');
				
				

















	HTP.P('</div>');

END CH_PWD;



PROCEDURE LIST_OBJETOS (  PRM_TIPO      VARCHAR2 DEFAULT 'CONSULTA',
			              PRM_SCREEN    VARCHAR2 DEFAULT NULL,
						  PRM_ORDER     VARCHAR2 DEFAULT '1',
						  PRM_DIR       VARCHAR2 DEFAULT '1',
						  PRM_VISAO     VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_OBJ IS
		SELECT CD_OBJETO, COD, VISAO, NM_OBJETO, CD_GRUPO, NM_GRUPO, TP_OBJETO
		FROM ( 
			SELECT CD_OBJETO, COD, NVL(T3.CD_MICRO_VISAO, 'N/A') AS VISAO, 
			NM_OBJETO, T1.CD_GRUPO, NM_GRUPO,T1.TP_OBJETO
			FROM OBJETOS T1
			LEFT JOIN GRUPOS_FUNCAO T2 ON T2.CD_GRUPO = T1.CD_GRUPO
			LEFT JOIN PONTO_AVALIACAO T3 ON T3.CD_PONTO = T1.CD_OBJETO
			WHERE TRIM(T1.TP_OBJETO) = NVL(TRIM(PRM_TIPO), TRIM(T1.TP_OBJETO))
			ORDER BY
			CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', VISAO, '2', NM_OBJETO, '3', T1.CD_GRUPO, VISAO) END ASC,
			CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', VISAO, '2', NM_OBJETO, '3', T1.CD_GRUPO, VISAO) END DESC
		)
		WHERE VISAO = NVL(PRM_VISAO, VISAO)
		ORDER BY TP_OBJETO;

	WS_OBJ		CRS_OBJ%ROWTYPE;

	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN
    

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	OPEN CRS_OBJ;
	LOOP
		FETCH CRS_OBJ INTO WS_OBJ;
		EXIT WHEN CRS_OBJ%NOTFOUND;
	    HTP.P('<tr>');
	    	HTP.P('<td>'||WS_OBJ.VISAO||'</td>');
			HTP.P('<td>'||FUN.UTRANSLATE('NM_OBJETO', WS_OBJ.CD_OBJETO, WS_OBJ.NM_OBJETO, WS_PADRAO)||'</td>');
			HTP.P('<td title="'||WS_OBJ.CD_GRUPO||'">'||WS_OBJ.NM_GRUPO||'</td>');
			CASE WS_OBJ.TP_OBJETO

			    WHEN 'SCREEN' THEN

					HTP.P('<td></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
		            HTP.P('<td colspan=""></td>');

				WHEN 'BROWSER' THEN
					
                    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''browser'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.NM_OBJETO||'''); ajax(''list'', ''browserConfig'', ''prm_microdata='||WS_OBJ.CD_OBJETO||''', false, ''content'', '''', '''', ''BRO''); curtain(''enabled'');">'||FUN.LANG('COLUNAS')||'</a></td>');
				    HTP.P('<td></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');

				WHEN 'PIZZA' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			    	HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||''');  carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				    
				WHEN 'ROSCA' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			    	HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'LINHAS' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			   		HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'BARRAS' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			    	HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'COLUNAS' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			    	HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'PONTEIRO' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			        HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'IMAGE' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
                    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'TEXTO' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
                    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'CALL_LIST' THEN

					HTP.P('<td></td>');
					HTP.P('<td></td>');
				    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_call'', ''prm_object='||WS_OBJ.CD_OBJETO||'&prm_screen=''+document.getElementById(''current_screen'').value); ">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'RELATORIO' THEN

					HTP.P('<td></td>');
					HTP.P('<td></td>');
					HTP.P('<td ><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||'''));">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'FLOAT_PAR' THEN

					HTP.P('<td></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
				
				WHEN 'FLOAT_FILTER' THEN

					HTP.P('<td></td>');					
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td></td>');
					HTP.P('<td></td>');
				
				WHEN 'VALOR' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
                    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ponto_av'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&ws_par_tipo='||PRM_TIPO||'''); ">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				WHEN 'ICONE' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'FILE' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'MAPA' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'ORGANOGRAMA' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'GEOMAPA' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
                    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');
				
				WHEN 'HEATMAP' THEN

					HTP.P('<td></td>');
				    HTP.P('<td colspan=""><a class="link" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
                    HTP.P('<td></td>');
					HTP.P('<td></td>');
				
				WHEN 'SCRIPT' THEN

					HTP.P('<td></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
                    HTP.P('<td colspan=""><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');

				WHEN 'CONSULTA' THEN

					HTP.P('<td><a class="link" title="'||FUN.LANG('Alterar Consulta')||'" onclick="carrega(''consulta?prm_objeto=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_visao='||WS_OBJ.VISAO||'''); carregaPainel(''data_table'', '''||WS_OBJ.VISAO||'|'||WS_OBJ.CD_OBJETO||''');">'||FUN.LANG('COLUNAS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||'''));">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			        HTP.P('<td><a class="link" title="'||FUN.LANG('Filtros')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''objeto'', '''||WS_OBJ.CD_OBJETO||'''); telaSup(''visao'', '''||WS_OBJ.VISAO||'''); carregaPainel(''list_ofiltro'', '''||WS_OBJ.CD_OBJETO||'|'||WS_OBJ.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_visao='||WS_OBJ.VISAO||'''); curtain(''enabled'');">'||FUN.LANG('FILTRO')||'</a></td>');
				
				ELSE

					HTP.P('<td></td>');						
					HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||''')+''&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
					HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary=''+encodeURIComponent('''||WS_OBJ.CD_OBJETO||'''));">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
					HTP.P('<td></td>');

			END CASE;

			HTP.P('<td>');

				FCL.BUTTON_LIXO('dl_object','prm_object', WS_OBJ.CD_OBJETO);
			
			HTP.P('<td>');
			
		HTP.TABLEROWCLOSE;
	END LOOP;
	CLOSE CRS_OBJ;
	HTP.P('</tr>');

END LIST_OBJETOS;


PROCEDURE LIST_VPADRAO ( PRM_ORDER VARCHAR2 DEFAULT '1',
                         PRM_DIR   VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_VPADRAO IS
	SELECT CD_PADRAO, NM_PADRAO, TP_PADRAO, CD_LIGACAO, STATUS, ORDEM FROM
	PARAMETRO_PADRAO
	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_PADRAO, '2', NM_PADRAO, '3', TP_PADRAO, '4', CD_LIGACAO, '5', STATUS, '6', ORDEM, CD_PADRAO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_PADRAO, '2', NM_PADRAO, '3', TP_PADRAO, '4', CD_LIGACAO, '5', STATUS, '6', ORDEM, CD_PADRAO) END DESC;

	WS_VPADRAO	CRS_VPADRAO%ROWTYPE;
   
    WS_DIR 	   NUMBER := 1;
	WS_COUNT   NUMBER;
	WS_FLOAT   VARCHAR2(200);
	WS_PADRAO  VARCHAR2(80)  := 'PORTUGUESE';
	WS_USUARIO VARCHAR2(80);

	WS_NOACESS EXCEPTION;
	
BEGIN

	WS_USUARIO := GBL.GETUSUARIO;
	
	IF GBL.GETNIVEL <> 'A' OR WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACESS;
	END IF;
	
	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    
	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('C&Oacute;DIGO')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('TIPO')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('LOV')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=5&prm_dir=''+dir, false, ''content'');">STATUS</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_vpadrao'', ''prm_order=6&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('ORDEM')||'</a></th>');
				HTP.P('<th>FLOAT</th>');
				HTP.P('<th style="width: 10px"></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;

		HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
		OPEN CRS_VPADRAO;
	        LOOP
		        FETCH CRS_VPADRAO INTO WS_VPADRAO;
		        EXIT WHEN CRS_VPADRAO%NOTFOUND;
	            HTP.P('<tr>');
	    	        HTP.P('<td><span class="text lang" id="'||WS_VPADRAO.CD_PADRAO||'_cd"  title="'||WS_VPADRAO.CD_PADRAO||'">'||FUN.UTRANSLATE('CD_PADRAO', 'PARAMETRO_PADRAO', WS_VPADRAO.CD_PADRAO, WS_PADRAO)||'</span><a class="fakelang" onclick="fakeLang('''||WS_VPADRAO.CD_PADRAO||'_cd'', ''PARAMETRO_PADRAO|CD_PADRAO|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
					HTP.P('<td>');
					    HTP.P('<input type="text" onblur="call(''alter_padrao'', ''prm_padrao='||WS_VPADRAO.CD_PADRAO||'&prm_campo=nome&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||FUN.LANG('Campo alterado com sucesso')||'!''); } else { alerta(''feed-fixo'', '''||FUN.LANG('Erro ao alterar')||'!''); } });" class="text lang" id="'||WS_VPADRAO.CD_PADRAO||'_nome" title="'||WS_VPADRAO.NM_PADRAO||'" value="'||FUN.UTRANSLATE('NM_PADRAO', 'PARAMETRO_PADRAO', WS_VPADRAO.NM_PADRAO, WS_PADRAO)||'" />');
					    HTP.P('<a class="fakelang" onclick="fakeLang('''||WS_VPADRAO.CD_PADRAO||'_nome'', ''PARAMETRO_PADRAO|NM_PADRAO|''+this.previousElementSibling.title);">L</a>');
					HTP.P('</td>');
	    	        
	    	        HTP.P('<td>');
					   HTP.P('<a class="script" onclick="call(''alter_padrao'', ''prm_padrao='||WS_VPADRAO.CD_PADRAO||'&prm_campo=tipo&prm_valor=''+this.nextElementSibling.title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||FUN.LANG('Campo alterado com sucesso')||'!''); } else { alerta(''feed-fixo'', '''||FUN.LANG('Erro ao alterar')||'!''); } });"></a>');
					   FCL.FAKEOPTION('fake_tipo_'||WS_VPADRAO.CD_PADRAO, FUN.LANG(WS_VPADRAO.TP_PADRAO), WS_VPADRAO.TP_PADRAO, 'lista-tipos', 'N', 'N', '');
					HTP.P('</td>');
					HTP.P('<td>');
					    HTP.P('<a class="script" onclick="call(''alter_padrao'', ''prm_padrao='||WS_VPADRAO.CD_PADRAO||'&prm_campo=ligacao&prm_valor=''+this.nextElementSibling.title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||FUN.LANG('Campo alterado com sucesso')||'!''); } else { alerta(''feed-fixo'', '''||FUN.LANG('Erro ao alterar')||'!''); } });"></a>');
					    FCL.FAKEOPTION('fake_cdesc_'||WS_VPADRAO.CD_PADRAO, WS_VPADRAO.CD_LIGACAO, WS_VPADRAO.CD_LIGACAO, 'lista-lovs', 'N', 'N', '');
					HTP.P('</td>');
					
					HTP.P('<td>');
						HTP.P('<select onchange="call(''alter_padrao'', ''prm_padrao='||WS_VPADRAO.CD_PADRAO||'&prm_campo=status&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); ">');
							IF WS_VPADRAO.STATUS = 'A' THEN
								HTP.P('<option value="A" selected="checked">'||FUN.LANG('Ativo')||'</option>');
								HTP.P('<option value="I">'||FUN.LANG('Inativo')||'</option>');
							ELSE
								HTP.P('<option value="A">'||FUN.LANG('Ativo')||'</option>');
								HTP.P('<option value="I" selected="checked">'||FUN.LANG('Inativo')||'</option>');
							END IF;
						HTP.P('</select>');
					HTP.P('</td>');
					HTP.P('<td>');
					    HTP.P('<select onchange="call(''alter_padrao'', ''prm_padrao='||WS_VPADRAO.CD_PADRAO||'&prm_campo=ordem&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
							FCL.NUMERICOPTIONS(9, WS_VPADRAO.ORDEM);
						HTP.P('</select>');
					HTP.P('</td>');
					
					SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = WS_VPADRAO.CD_PADRAO AND TP_OBJETO IN ('FLOAT_PAR', 'FLOAT_FILTER');
			        
					IF WS_COUNT > 0 THEN
					    
						SELECT TP_OBJETO INTO WS_FLOAT FROM OBJETOS WHERE CD_OBJETO = WS_VPADRAO.CD_PADRAO AND TP_OBJETO IN ('FLOAT_PAR', 'FLOAT_FILTER') AND ROWNUM = 1;
						HTP.P('<td>');
							HTP.P('<select disabled class="readonly">');
								HTP.P('<option selected disabled value="'||WS_FLOAT||'">'||REPLACE(WS_FLOAT, 'FLOAT_', '')||'</option>');
							HTP.P('</select>');
						HTP.P('</td>');
					ELSE
					
					    HTP.P('<td>');
						
							HTP.P('<select onchange="var dis = this; call(''savegd'', ''p_cd_micro_visao=&p_funcao=G&p_cd_objeto='||WS_VPADRAO.CD_PADRAO||'&p_nm_objeto='||WS_VPADRAO.NM_PADRAO||'&p_atributos=&fakeoption=GERAL&p_tp_objeto=''+this.value+''&p_ds_objeto=&p_cs_colup='').then(function(resposta){ if(!resposta.includes(''FAIL'')){ alerta(''feed-fixo'', TR_CR); dis.setAttribute(''disabled'', ''disabled''); } else { alerta(''feed-fixo'', TR_CR); } });">');
								HTP.P('<option selected disabled hidden>'||FUN.LANG('GERAR FLOAT')||'</option>');
								HTP.P('<option value="FLOAT_FILTER">FILTER</option>');
								HTP.P('<option value="FLOAT_PAR">PAR</option>');
							HTP.P('</select>');
						
							






						
						HTP.P('</td>');
					END IF;
					HTP.P('<td>');
						FCL.BUTTON_LIXO('dl_vp','ws_par_sumary', WS_VPADRAO.CD_PADRAO);
					HTP.P('</td>');
	            HTP.TABLEROWCLOSE;
	        END LOOP;
	    CLOSE CRS_VPADRAO;
		HTP.P('</tbody>');
	HTP.TABLECLOSE;
EXCEPTION
	WHEN WS_NOACESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_VPADRAO;


PROCEDURE ALTER_PADRAO ( PRM_PADRAO VARCHAR2 DEFAULT NULL,
                         PRM_CAMPO  VARCHAR2 DEFAULT NULL,
						 PRM_VALOR  VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER;
	WS_FAIL  EXCEPTION;
	WS_NOME VARCHAR2(200);

BEGIN

    CASE PRM_CAMPO
		WHEN 'status' THEN
			UPDATE PARAMETRO_PADRAO SET STATUS = PRM_VALOR WHERE CD_PADRAO = PRM_PADRAO;
		WHEN 'nome' THEN
			WS_NOME := FUN.CONVERTE(PRM_VALOR);
			FCL.UPDATE_PROP(PRM_PADRAO, 'nome', WS_NOME);
			UPDATE PARAMETRO_PADRAO SET NM_PADRAO = WS_NOME WHERE CD_PADRAO = PRM_PADRAO;
		WHEN 'ligacao' THEN
			UPDATE PARAMETRO_PADRAO SET CD_LIGACAO = PRM_VALOR WHERE CD_PADRAO = PRM_PADRAO;
		WHEN 'tipo' THEN
			UPDATE PARAMETRO_PADRAO SET TP_PADRAO = PRM_VALOR WHERE CD_PADRAO = PRM_PADRAO;
		WHEN 'ordem' THEN
			UPDATE PARAMETRO_PADRAO SET ORDEM = PRM_VALOR WHERE CD_PADRAO = PRM_PADRAO;
		ELSE
			HTP.P('#alert '||FUN.LANG('Erro ao atualizar')||'!');
	END CASE;

	WS_COUNT := SQL%ROWCOUNT;

	IF WS_COUNT <> 0 THEN
		COMMIT;
	ELSE
		RAISE WS_FAIL;
	END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('FAIL'); 
END ALTER_PADRAO;

PROCEDURE ADD_PADRAO( PRM_PADRAO  VARCHAR2 DEFAULT NULL,
                      PRM_NOME    VARCHAR2 DEFAULT NULL,
					  PRM_TIPO    VARCHAR2 DEFAULT NULL,
					  PRM_LIGACAO VARCHAR2 DEFAULT NULL,
					  PRM_STATUS  VARCHAR2 DEFAULT NULL,
                      PRM_ORDEM   NUMBER   DEFAULT 1,
					  PRM_FLOAT   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT  NUMBER;
	WS_FAIL   EXCEPTION;
	WS_EXIST  EXCEPTION;
	WS_NOME   VARCHAR2(200);
	WS_FUNCAO VARCHAR2(10);

BEGIN

    SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = UPPER(TRIM(PRM_PADRAO));

	IF WS_COUNT <> 0 THEN
        RAISE WS_EXIST;
	END IF;

	WS_NOME := FUN.CONVERTE(PRM_NOME);

	SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_PADRAO WHERE CD_PADRAO = UPPER(TRIM(PRM_PADRAO));
	IF WS_COUNT = 0 THEN

		INSERT INTO PARAMETRO_PADRAO VALUES (UPPER(TRIM(PRM_PADRAO)), TRIM(WS_NOME), PRM_TIPO, PRM_LIGACAO, PRM_STATUS, PRM_ORDEM);

		WS_COUNT := SQL%ROWCOUNT;

		IF WS_COUNT <> 0 THEN

			COMMIT;

            IF NVL(PRM_LIGACAO, 'N/A') <> 'N/A' THEN
			    WS_FUNCAO := 'G';
			END IF; 

			IF NVL(PRM_FLOAT, 'N/A') <> 'N/A' THEN
                FCL.SAVEGD(P_CD_MICRO_VISAO => '', P_FUNCAO => 'G', P_CD_OBJETO => PRM_PADRAO, P_NM_OBJETO => PRM_NOME, P_ATRIBUTOS => '', FAKEOPTION => 'GERAL', P_TP_OBJETO => PRM_FLOAT);
			END IF; 

			INSERT INTO TRADUCAO_COLUNAS VALUES ('PARAMETRO_PADRAO', 'CD_PADRAO', FUN.RET_VAR('LANG_SYS'), UPPER(TRIM(PRM_PADRAO)), UPPER(TRIM(PRM_PADRAO)), 'T', 'N');
		    INSERT INTO TRADUCAO_COLUNAS VALUES ('PARAMETRO_PADRAO', 'NM_PADRAO', FUN.RET_VAR('LANG_SYS'), TRIM(WS_NOME), TRIM(WS_NOME), 'T', 'N');
		    COMMIT;

		ELSE
			RAISE WS_FAIL;
		END IF;

	ELSE
	    RAISE WS_FAIL;
	END IF;

EXCEPTION
    WHEN WS_EXIST THEN
	    HTP.P('FAIL');
    WHEN WS_FAIL THEN
	    HTP.P('FAIL');
	WHEN OTHERS THEN
	    HTP.P('FAIL');
END ADD_PADRAO;


PROCEDURE LIST_OFILTRO ( WS_PAR_SUMARY VARCHAR2 DEFAULT NULL,
                         PRM_VISAO     VARCHAR2 DEFAULT NULL,
						 PRM_ORDER     VARCHAR2 DEFAULT '1',
						 PRM_DIR       VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_FILTRO(PRM_USUARIO VARCHAR2, PRM_ADMIN VARCHAR2) IS
		SELECT CD_COLUNA, CONDICAO, CONTEUDO, MICRO_VISAO, LIGACAO, ST_AGRUPADO, CD_FILTRO, CD_CRIADO
		FROM FILTROS
		WHERE (CD_USUARIO = PRM_USUARIO OR PRM_ADMIN = 'A') AND CD_OBJETO = WS_PAR_SUMARY AND TP_FILTRO = 'objeto'
		ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_COLUNA, '2', CONDICAO, '3', CONTEUDO, '4', LIGACAO, '5', ST_AGRUPADO, CD_COLUNA) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_COLUNA, '2', CONDICAO, '3', CONTEUDO, '4', LIGACAO, '5', ST_AGRUPADO, CD_COLUNA) END DESC;

	WS_FILTRO	CRS_FILTRO%ROWTYPE;

    CURSOR CRS_FILTROB(PRM_USUARIO VARCHAR2, PRM_ADMIN VARCHAR2) IS
		SELECT CD_COLUNA, CONDICAO, CONTEUDO, MICRO_VISAO, LIGACAO, ST_AGRUPADO, CD_USUARIO, CD_FILTRO, CD_CRIADO
		FROM FILTROS
		WHERE (CD_USUARIO = PRM_USUARIO OR PRM_ADMIN = 'A') AND CD_OBJETO  = WS_PAR_SUMARY  AND TP_FILTRO = 'objeto'
		ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_COLUNA, '2', CONDICAO, '3', CONTEUDO, '4', LIGACAO, '5', ST_AGRUPADO, CD_COLUNA) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_COLUNA, '2', CONDICAO, '3', CONTEUDO, '4', LIGACAO, '5', ST_AGRUPADO, CD_COLUNA) END DESC;

	WS_FILTROB	CRS_FILTROB%ROWTYPE;

	CURSOR CRS_COLUNAS IS
		SELECT DISTINCT(CD_COLUNA), NM_ROTULO, '#000000' AS COLOR
		FROM MICRO_COLUNA
		WHERE CD_COLUNA NOT IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR||'|'||PARAMETROS FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY))) WHERE LENGTH(TRIM(COLUMN_VALUE)) > 0) AND
		CD_MICRO_VISAO = PRM_VISAO

		UNION ALL

		SELECT DISTINCT(CD_COLUNA), NM_ROTULO, '#CC0000' AS COLOR
		FROM MICRO_COLUNA
		WHERE CD_COLUNA IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR||'|'||PARAMETROS FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY))) WHERE LENGTH(TRIM(COLUMN_VALUE)) > 0) AND
		CD_MICRO_VISAO = PRM_VISAO
		ORDER BY NM_ROTULO ASC;
	WS_COLUNAS CRS_COLUNAS%ROWTYPE;

	WS_LIGACAO	VARCHAR2(200);
	WS_CONDICAO	VARCHAR2(80);

	WS_POSX		VARCHAR2(80);
	WS_POSY		VARCHAR2(80);

	WS_COUNT    NUMBER;
	WS_COUNTER  NUMBER := 0;
	WS_DIR      NUMBER := 1;
    WS_TIPO     VARCHAR2(80);
    WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(80);

	WS_NOUSER   EXCEPTION;

BEGIN
    

	WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

    SELECT TP_OBJETO INTO WS_TIPO FROM OBJETOS WHERE CD_OBJETO = WS_PAR_SUMARY;
    
    HTP.P('<a class="script" id="filtro-visao" title="'||PRM_VISAO||'"></a>');

	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    
				    HTP.P('<th>'||FUN.LANG('USU&Aacute;RIO')||'</th>');
				
			    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||WS_PAR_SUMARY||'&prm_visao='||PRM_VISAO||'&prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('COLUNA')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||WS_PAR_SUMARY||'&prm_visao='||PRM_VISAO||'&prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||WS_PAR_SUMARY||'&prm_visao='||PRM_VISAO||'&prm_order=3&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('VALOR')||'</a></th>');
				IF WS_TIPO <> 'BROWSER' THEN
                    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||WS_PAR_SUMARY||'&prm_visao='||PRM_VISAO||'&prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||'</a></th>');
				    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||WS_PAR_SUMARY||'&prm_visao='||PRM_VISAO||'&prm_order=5&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('AGRUPADO')||'</a></th>');
				END IF;
                HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;

			HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
			IF WS_TIPO = 'BROWSER' THEN
                

                OPEN CRS_FILTROB(WS_USUARIO, WS_ADMIN);
				LOOP
					FETCH CRS_FILTROB INTO WS_FILTROB;
					EXIT WHEN CRS_FILTROB%NOTFOUND;

					WS_COUNTER := WS_COUNTER+1;

					HTP.P('<tr>');
                        IF WS_FILTROB.CD_CRIADO = WS_USUARIO OR WS_ADMIN = 'A' THEN

						    IF WS_ADMIN = 'A' THEN
							
							    HTP.P('<td>');
									HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTROB.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-usuario-'||WS_COUNTER||''').title)+''&prm_tipo=USUARIO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
									FCL.FAKEOPTION('filtro-usuario-'||WS_COUNTER, 'Lista de usuarios', WS_FILTROB.CD_USUARIO, 'lista-usuarios', 'N', 'N', '', '');
								HTP.P('</td>');
							
							ELSE
							
							    HTP.P('<td class="readonly"><input type="text" readonly id="filtro-usuario-'||WS_COUNTER||'" data-default="'||WS_FILTROB.CD_USUARIO||'" value="'||WS_FILTROB.CD_USUARIO||'" /></td>');
							
							END IF;
						
							
							HTP.P('<td>');
							    
								HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTROB.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||WS_COUNTER||''').title)+''&prm_tipo=COLUNA'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								FCL.FAKEOPTION('filtro-coluna-'||WS_COUNTER, '', WS_FILTROB.CD_COLUNA, 'lista-coluna', 'N', 'N', 'filtro-visao', '');
							HTP.P('</td>');
					        
							






							
							HTP.P('<td>');
							    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTROB.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||WS_COUNTER||''').title)+''&prm_tipo=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
							    FCL.FAKEOPTION('filtro-condicao-'||WS_COUNTER||'', '', WS_FILTROB.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', '', FUN.DCONDICAO(WS_FILTROB.CONDICAO));
							HTP.P('</td>');
							
							
							HTP.P('<td>');
							    
							    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTROB.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||WS_COUNTER||''').title)+''&prm_tipo=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								
								BEGIN
								
								    SELECT CD_LIGACAO INTO WS_LIGACAO FROM MICRO_COLUNA WHERE CD_COLUNA = WS_FILTROB.CD_COLUNA AND CD_MICRO_VISAO = WS_FILTROB.MICRO_VISAO;
								
									IF WS_LIGACAO <> 'SEM' THEN
									    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, WS_FILTROB.CONTEUDO, WS_FILTROB.CONTEUDO, 'lista-valores-browser', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER||'', FUN.CDESC(WS_FILTROB.CONTEUDO, WS_LIGACAO));
									ELSE
									    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, WS_FILTROB.CONTEUDO, WS_FILTROB.CONTEUDO, 'lista-valores-browser', 'S', 'N', 'filtro-visao', '','filtro-coluna-'||WS_COUNTER||'');
									END IF;
								
								EXCEPTION WHEN OTHERS THEN
								    
								    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, WS_FILTROB.CONTEUDO, WS_FILTROB.CONTEUDO, 'lista-valores-browser', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER||'');
								
								END;
								
						    HTP.P('</td>');
							
							
							
                            HTP.P('<td class="noborder invisible"><input type="hidden" id="filtro-ligacao-'||WS_COUNTER||'" data-default="'||WS_FILTROB.LIGACAO||'" /></td>');
							HTP.P('<td class="noborder invisible"><input type="hidden" id="filtro-agrupado-'||WS_COUNTER||'" data-default="'||WS_FILTROB.ST_AGRUPADO||'" /></td>');
                            
							HTP.P('<td>');
								FCL.BUTTON_LIXO('dl_ofiltro','prm_key', WS_FILTROB.CD_FILTRO);
							HTP.P('</td>');

					    
						ELSE
						
						    HTP.P('<td class="readonly"><input type="text" readonly id="filtro-usuario-'||WS_COUNTER||'" data-default="'||WS_FILTROB.CD_USUARIO||'" value="'||WS_FILTROB.CD_USUARIO||'" /></td>');


							
							HTP.P('<td class="readonly"><input type="text" id="filtro-coluna-'||WS_COUNTER||'" data-default="'||WS_FILTROB.CD_COLUNA||'" value="'||WS_FILTROB.CD_COLUNA||'"/></td>');
							
							HTP.P('<td class="readonly"><input type="text" id="filtro-condicao-'||WS_COUNTER||'" data-default="'||WS_FILTROB.CONDICAO||'" value="'||WS_FILTROB.CONDICAO||'"/></td>');

							HTP.P('<td class="readonly"><input data-default="'||WS_FILTROB.CONTEUDO||'" id="filtro-conteudo-'||WS_COUNTER||'" onblur="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ filter('''||WS_PAR_SUMARY||''', '''', '''||WS_COUNTER||''', ''CONTEUDO'', this.id); this.setAttribute(''data-default'', this.value); }}" onkeyup="checkPar(this.id, '''||WS_FILTROB.MICRO_VISAO||''');" value="'||WS_FILTROB.CONTEUDO||'" /></td>');
                            HTP.P('<td class="noborder invisible"><input type="hidden" id="filtro-ligacao-'||WS_COUNTER||'" data-default="'||WS_FILTROB.LIGACAO||'" /></td>');
							HTP.P('<td class="noborder invisible"><input type="hidden" id="filtro-agrupado-'||WS_COUNTER||'" data-default="'||WS_FILTROB.ST_AGRUPADO||'" /></td>');
                            
					        HTP.P('<td><a title="'||FUN.LANG('Excluir')||'" class="noremove">X</a></td>');
					    END IF;
					HTP.P('</tr>');
				END LOOP;
				CLOSE CRS_FILTROB;

            ELSE
	            OPEN CRS_FILTRO(WS_USUARIO, WS_ADMIN);
				LOOP
					FETCH CRS_FILTRO INTO WS_FILTRO;
					EXIT WHEN CRS_FILTRO%NOTFOUND;

					WS_COUNTER := WS_COUNTER+1;

					HTP.P('<tr>');

					 		 HTP.P('<td class="readonly"><input type="text" readonly id="filtro-usuario-'||WS_COUNTER||'" data-default="'||WS_FILTRO.CD_CRIADO||'" value="'||WS_FILTRO.CD_CRIADO||'" /></td>');


                            HTP.P('<td>');
                                HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||WS_COUNTER||''').title)+''&prm_tipo=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
							    FCL.FAKEOPTION('filtro-coluna-'||WS_COUNTER, '', WS_FILTRO.CD_COLUNA, 'lista-colunas', 'N', 'N', 'filtro-visao', '');
							HTP.P('</td>');
							
							HTP.P('<td>');
							    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||WS_COUNTER||''').title)+''&prm_tipo=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								FCL.FAKEOPTION('filtro-condicao-'||WS_COUNTER||'', '', WS_FILTRO.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', '', FUN.DCONDICAO(WS_FILTRO.CONDICAO));
							HTP.P('</td>');

							HTP.P('<td>');
							    
							    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||WS_COUNTER||''').title)+''&prm_tipo=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								
								BEGIN
								
								    SELECT CD_LIGACAO INTO WS_LIGACAO FROM MICRO_COLUNA WHERE CD_COLUNA = WS_FILTRO.CD_COLUNA AND CD_MICRO_VISAO = PRM_VISAO;
								
									IF WS_LIGACAO <> 'SEM' THEN
									    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER, FUN.CDESC(WS_FILTRO.CONTEUDO, WS_LIGACAO));
									ELSE
									    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER);
									END IF;
								
								EXCEPTION WHEN OTHERS THEN
								
									FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER);
								
								END;
							
							HTP.P('</td>');
							
							HTP.P('<td>');
								HTP.P('<select id="filtro-ligacao-'||WS_COUNTER||'" data-default="'||WS_FILTRO.LIGACAO||'" onchange="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+this.value+''&prm_tipo=LIGACAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
									IF WS_FILTRO.LIGACAO = 'and' THEN
										HTP.P('<option value="and" selected>and</option>');
										HTP.P('<option value="or">or</option>');
									ELSE
										HTP.P('<option value="and">and</option>');
										HTP.P('<option value="or" selected>or</option>');
									END IF;
								HTP.P('</select>');
							HTP.P('</td>');

							HTP.P('<td>');
								HTP.P('<select id="filtro-agrupado-'||WS_COUNTER||'" data-default="'||WS_FILTRO.ST_AGRUPADO||'" onchange="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+this.value+''&prm_tipo=AGRUPADO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
									IF WS_FILTRO.ST_AGRUPADO = 'S' THEN
										HTP.P('<option value="S" selected>'||FUN.LANG('Agrupado')||'</option>');
										HTP.P('<option value="N">'||FUN.LANG('N&atilde;o agrupado')||'</option>');
									ELSE
										HTP.P('<option value="S">'||FUN.LANG('Agrupado')||'</option>');
										HTP.P('<option value="N" selected>'||FUN.LANG('N&atilde;o agrupado')||'</option>');
									END IF;
								HTP.P('</select>');
							HTP.P('</td>');

							IF FUN.CHECK_ADMIN('FILTERS_EX') OR WS_ADMIN = 'A' THEN
						        HTP.P('<td>');
									FCL.BUTTON_LIXO('dl_ofiltro','prm_key', WS_FILTRO.CD_FILTRO);
								HTP.P('</td>');
					        ELSE
                                HTP.P('<td><a title="'||FUN.LANG('Sem premissão')||'" class="noremove">X</a></td>');
							END IF;

					HTP.P('</tr>');
				END LOOP;
				CLOSE CRS_FILTRO;
            END IF;
        HTP.P('</tbody>');
	HTP.TABLECLOSE;
EXCEPTION
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_OFILTRO;


PROCEDURE LIST_SFILTRO( WS_PAR_SUMARY VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_FILTRO IS
		SELECT CD_OBJETO, CD_COLUNA, CONDICAO, CONTEUDO, MICRO_VISAO, LIGACAO, CD_FILTRO
		FROM FILTROS
		WHERE CD_USUARIO = 'DWU' AND
		CD_OBJETO  = WS_PAR_SUMARY  AND TP_FILTRO = 'objeto';

	WS_FILTRO	CRS_FILTRO%ROWTYPE;

	WS_LIGACAO	VARCHAR2(200);
	WS_CONDICAO	VARCHAR2(80);
	WS_USUARIO  VARCHAR2(80);
	WS_POSX		VARCHAR2(80);
	WS_POSY		VARCHAR2(80);
	WS_COUNTER  NUMBER := 0;

	WS_NOUSER   EXCEPTION;

BEGIN
    
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	HTP.P('<table class="linha">');
		HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th style="width: 23%;">View</th>');
			    HTP.P('<th style="width: 23%;">'||FUN.LANG('COLUNA')||'</th>');
				HTP.P('<th style="width: 23%;">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th style="width: 23%;">'||FUN.LANG('VALOR')||'</th>');
				HTP.P('<th style="width: 23%;">'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th style="width: 8%;"></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax">');
			OPEN CRS_FILTRO;
			LOOP
				FETCH CRS_FILTRO INTO WS_FILTRO;
					  EXIT WHEN CRS_FILTRO%NOTFOUND;
	                  WS_COUNTER := WS_COUNTER +1;
				HTP.P('<tr>');
				    HTP.P('<td id="filtro-visao" title="'||WS_FILTRO.MICRO_VISAO||'">'||WS_FILTRO.MICRO_VISAO||'</td>');
					
					HTP.P('<td>');
	                    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||WS_COUNTER||''').title)+''&prm_tipo=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						FCL.FAKEOPTION('filtro-coluna-'||WS_COUNTER, '', WS_FILTRO.CD_COLUNA, 'lista-colunas', 'N', 'N', 'filtro-visao', '');
					HTP.P('</td>');

					HTP.P('<td>');
					    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||WS_COUNTER||''').title)+''&prm_tipo=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						FCL.FAKEOPTION('filtro-condicao-'||WS_COUNTER||'', '', WS_FILTRO.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', '', FUN.DCONDICAO(WS_FILTRO.CONDICAO));
					HTP.P('</td>');
					
					HTP.P('<td>');
					    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||WS_COUNTER||''').title)+''&prm_tipo=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						
						BEGIN
						
						    SELECT CD_LIGACAO INTO WS_LIGACAO FROM MICRO_COLUNA WHERE CD_COLUNA = WS_FILTRO.CD_COLUNA AND CD_MICRO_VISAO = WS_FILTRO.MICRO_VISAO;
						
							IF WS_LIGACAO <> 'SEM' THEN
							    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER, FUN.CDESC(WS_FILTRO.CONTEUDO, WS_LIGACAO));
							ELSE
							    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER);
							END IF;
						
						EXCEPTION WHEN OTHERS THEN
						
							FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, WS_FILTRO.CONTEUDO, WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna-'||WS_COUNTER);
						
						END;
					HTP.P('</td>');

	                HTP.P('<td>');
	                	HTP.P('<select id="filtro-ligacao-'||WS_COUNTER||'" data-default="'||WS_FILTRO.LIGACAO||'" onchange="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+this.value+''&prm_tipo=LIGACAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
							IF WS_FILTRO.LIGACAO = 'and' THEN
							    HTP.P('<option value="and" selected>and</option>');
								HTP.P('<option value="or">or</option>');
							ELSE
							    HTP.P('<option value="and">and</option>');
								HTP.P('<option value="or" selected>or</option>');
							END IF;
						HTP.P('</select>');
					HTP.P('</td>');

					HTP.P('<td>');
						FCL.BUTTON_LIXO('dl_ofiltro','prm_key', WS_FILTRO.CD_FILTRO);	
					HTP.P('</td>');
					

				HTP.TABLEROWCLOSE;
			END LOOP;
			CLOSE CRS_FILTRO;
	    HTP.P('</tbody>');
	HTP.P('</table>');
EXCEPTION
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_SFILTRO;

PROCEDURE LISTA_SFILTRO( PRM_VISAO VARCHAR2 DEFAULT NULL ) AS
	CURSOR CRS_COLUNA IS
		SELECT NM_ROTULO, CD_COLUNA
		FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO AND NM_ROTULO <> ''''
		ORDER BY CD_COLUNA;

	WS_COLUNA	CRS_COLUNA%ROWTYPE;

	WS_COUNT  NUMBER;
	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN
    
	
	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
	
	SELECT COUNT(CD_COLUNA) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO;
	IF WS_COUNT > 0 THEN
	HTP.FORMSELECTOPEN( CNAME => 'px_coluna', CATTRIBUTES => ' id="cd_coluna"');
	    OPEN CRS_COLUNA;
	    LOOP
		FETCH CRS_COLUNA INTO WS_COLUNA;
		      EXIT WHEN CRS_COLUNA%NOTFOUND;
		FCL.FORMSELECTOPTION( '['||WS_COLUNA.CD_COLUNA||'] '||FUN.UTRANSLATE('NM_ROTULO', PRM_VISAO, WS_COLUNA.NM_ROTULO, WS_PADRAO),WS_COLUNA.CD_COLUNA, '','');
	    END LOOP;
	    CLOSE CRS_COLUNA;
	HTP.FORMSELECTCLOSE;
	ELSE
		HTP.P('<select><option>'||FUN.LANG('Nenhuma coluna com esta view')||'.</option></select>');
	END IF;
END LISTA_SFILTRO;


PROCEDURE LIST_GO ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                    PRM_ORDER VARCHAR2 DEFAULT '1',
				    PRM_DIR VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_TOGO IS
		SELECT T1.CD_OBJETO, COD, NM_OBJETO NOME, TP_OBJETO TIPO, CD_OBJETO_GO, CD_MICRO_VISAO VISAO, ORDEM
		FROM GOTO_OBJETO T1
		LEFT JOIN 
		PONTO_AVALIACAO ON CD_PONTO = T1.CD_OBJETO_GO
		LEFT JOIN
		OBJETOS T3 ON T3.CD_OBJETO  = T1.CD_OBJETO_GO
		WHERE 
		T1.CD_USUARIO = 'DWU' AND
		T1.CD_OBJETO  = PRM_OBJETO
		ORDER BY
		CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', T1.CD_OBJETO, '2', T1.CD_OBJETO_GO, '3', VISAO, '4', TIPO, T1.CD_OBJETO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', T1.CD_OBJETO, '2', T1.CD_OBJETO_GO, '3', VISAO, '4', TIPO, T1.CD_OBJETO) END DESC;

	WS_TOGO		CRS_TOGO%ROWTYPE;

	WS_LIGACAO	VARCHAR2(200);
	WS_CONDICAO	VARCHAR2(80);

	WS_POSX		VARCHAR2(80);
	WS_POSY		VARCHAR2(80);
	WS_GRUPO    VARCHAR2(40) := '999999999';
	WS_DIR NUMBER := 1;
	WS_EX_PERMISSAO BOOLEAN;

BEGIN
    

	WS_EX_PERMISSAO := FUN.CHECK_ADMIN('DRILLS_EX');

    HTP.P('<table class="linha">');
		HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||PRM_OBJETO||'&prm_order=3&prm_dir=''+dir, false, ''content'');">VIEW</a></th>');
			    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||PRM_OBJETO||'&prm_order=1&prm_dir=''+dir, false, ''content'');">ID</a></th>');
			    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||PRM_OBJETO||'&prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME DA DRILL')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_go'', ''prm_objeto='||PRM_OBJETO||'&prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('TIPO')||'</a></th>');
				HTP.P('<th>'||FUN.LANG('ORDEM')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;

		HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
			OPEN CRS_TOGO;
			LOOP
				FETCH CRS_TOGO INTO WS_TOGO;
				EXIT WHEN CRS_TOGO%NOTFOUND;
				HTP.P('<tr id="'||WS_TOGO.CD_OBJETO_GO||'TR">');
				    HTP.P('<td>'||WS_TOGO.VISAO||'</td>');
					HTP.P('<td>'||NVL(WS_TOGO.COD, WS_TOGO.CD_OBJETO_GO)||'</td>');
					HTP.P('<td>'||WS_TOGO.NOME||'</td>');
					HTP.P('<td>'||WS_TOGO.TIPO||'</td>');
					HTP.P('<td><input type="number" value="'||WS_TOGO.ORDEM||'" oninput="call(''savego'', ''prm_objeto='||PRM_OBJETO||'&prm_go='||WS_TOGO.CD_OBJETO_GO||'&prm_ordem=''+this.value).then(function(res){ if(res.indexOf(''ok'') != -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></td>');
					HTP.P('<td>');
						IF WS_EX_PERMISSAO THEN
							FCL.BUTTON_LIXO('dl_goto','prm_objeto|prm_drill', WS_TOGO.CD_OBJETO||'|'||WS_TOGO.CD_OBJETO_GO);
						ELSE
						    HTP.P('<a class="noremove">X</a>');
						END IF;
				    HTP.P('</td>');

				HTP.P('</tr>');
			END LOOP;
			CLOSE CRS_TOGO;
	    HTP.P('</tbody>');
	HTP.TABLECLOSE;

END LIST_GO;

PROCEDURE LISTGO_OBJETOS ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                           PRM_VISAO  VARCHAR2 DEFAULT NULL,
						   PRM_CAMPO  VARCHAR2 DEFAULT NULL ) AS


    CURSOR CRS_DRILLS IS
	SELECT CD_OBJETO, COD, NM_OBJETO, TP_OBJETO, VISAO FROM (SELECT CD_OBJETO, COD, NM_OBJETO, TP_OBJETO, (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = CD_OBJETO) AS VISAO
	FROM OBJETOS
	WHERE CD_OBJETO NOT IN(SELECT CD_OBJETO_GO FROM GOTO_OBJETO WHERE CD_OBJETO = TRIM(PRM_OBJETO)) AND
	TP_OBJETO IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_CAMPO)))) WHERE
    (VISAO = PRM_VISAO OR TP_OBJETO = PRM_VISAO)
	ORDER BY TP_OBJETO, CD_OBJETO;

	WS_DRILL CRS_DRILLS%ROWTYPE;
	
	WS_TIPO   VARCHAR2(80);
	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';
BEGIN

    WS_TIPO := 'N/A';
    
	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    HTP.P('<option selected readonly disabled>'||FUN.LANG('Escolha um objeto')||'</option>');
	OPEN CRS_DRILLS;
		LOOP
			FETCH CRS_DRILLS INTO WS_DRILL;
			EXIT WHEN CRS_DRILLS%NOTFOUND;
			IF  TRIM(WS_DRILL.TP_OBJETO) <> TRIM(WS_TIPO) THEN
			    HTP.P('<optgroup label="'||UPPER(TRIM(WS_DRILL.TP_OBJETO))||'"></optgroup>');
			    WS_TIPO := TRIM(WS_DRILL.TP_OBJETO);
			END IF;
			HTP.P('<option value="'||WS_DRILL.CD_OBJETO||'">'||FUN.UTRANSLATE('NM_OBJETO', WS_DRILL.CD_OBJETO, WS_DRILL.NM_OBJETO, WS_PADRAO)||' - ['||NVL(WS_DRILL.COD, WS_DRILL.CD_OBJETO)||'] - '||WS_DRILL.TP_OBJETO||'</option>');
		END LOOP;
	CLOSE CRS_DRILLS;
   
    IF PRM_CAMPO = 'CONSULTA|ORGANOGRAMA|SCRIPTS' THEN
        HTP.P('<optgroup label="SCRIPTS"></optgroup>');
        FOR I IN(SELECT CD_OBJETO, COD, NM_OBJETO, TP_OBJETO FROM OBJETOS WHERE TP_OBJETO = 'SCRIPT') LOOP
            HTP.P('<option value="'||I.CD_OBJETO||'">'||FUN.UTRANSLATE('NM_OBJETO', I.CD_OBJETO, I.NM_OBJETO, WS_PADRAO)||' - ['||NVL(I.COD, I.CD_OBJETO)||'] - '||I.TP_OBJETO||'</option>');
        END LOOP;
    END IF;

END LISTGO_OBJETOS;


PROCEDURE LIST_CALL_END( PRM_OBJETO VARCHAR2 DEFAULT NULL,
					     PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

	






	
    CURSOR CRS_TOGO IS
		SELECT CLL.CD_LIST AS CD_OBJETO, CLL.CD_OBJETO AS CD_OBJETO_GO, ORDEM,
		(SELECT NM_ITEM FROM CALL_NAME NAME WHERE NAME.CD_OBJETO=CLL.CD_OBJETO AND NAME.SCREEN=TRIM(PRM_SCREEN)) AS NM_ITEM,
		OBJ.TP_OBJETO AS TIPO,
		OBJ.ATRIBUTOS AS ATT,
		OBJ.NM_OBJETO AS NOME
		FROM CALL_LIST CLL, OBJETOS OBJ
		WHERE
		      CLL.CD_LIST  = PRM_OBJETO AND
			  FUN.CHECK_PERMISSAO(CLL.CD_OBJETO) = 'S' AND
			  OBJ.CD_OBJETO=CLL.CD_OBJETO AND
			  OBJ.TP_OBJETO = 'FILE'
		ORDER BY ORDEM ASC;

	WS_TOGO		CRS_TOGO%ROWTYPE;
	WS_COUNT NUMBER;

BEGIN

	
    HTP.P('<table class="linha">');
	    HTP.P('<thead>');
			HTP.P('<tr>');
			    HTP.P('<th>'||FUN.LANG('OBJETO')||'</th>');
				HTP.P('<th>'||FUN.LANG('NOME')||'</th>');
				HTP.P('<th>URL/'||FUN.LANG('ARQUIVO')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax">');

			OPEN CRS_TOGO;
				LOOP
					FETCH CRS_TOGO INTO WS_TOGO;
					EXIT WHEN CRS_TOGO%NOTFOUND;
					HTP.P('<tr>');
						HTP.P('<td>'||WS_TOGO.CD_OBJETO_GO||'</td>');
						HTP.P('<td>'||WS_TOGO.NOME||'</td>');
						HTP.P('<td>'||WS_TOGO.ATT||'</td>');
						HTP.P('<td>');
							FCL.BUTTON_LIXO('dl_call','p_cd_objeto|p_cd_objeto_go', PRM_OBJETO||'|'||WS_TOGO.CD_OBJETO_GO);
						HTP.P('</td>');
						
				    HTP.P('</tr>');
				END LOOP;
	        CLOSE CRS_TOGO;
        
		HTP.P('</tbody>');
	HTP.P('</table>');

END LIST_CALL_END;


PROCEDURE LIST_CALL ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
					  PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_TOGO IS
		SELECT CLL.CD_LIST AS CD_OBJETO, CLL.CD_OBJETO AS CD_OBJETO_GO, NVL(ORDEM,0), CLL.ORDEM,
		(SELECT NM_ITEM FROM CALL_NAME NAME WHERE NAME.CD_OBJETO=CLL.CD_OBJETO AND NAME.SCREEN=TRIM(PRM_SCREEN)) AS NM_ITEM,
		PA.CD_MICRO_VISAO AS VISAO,
        OBJ.TP_OBJETO AS TIPO,
		OBJ.ATRIBUTOS AS ATT,
		OBJ.NM_OBJETO AS NOME
		FROM CALL_LIST CLL, OBJETOS OBJ, PONTO_AVALIACAO PA
		WHERE
		      CLL.CD_LIST  = PRM_OBJETO AND
			  FUN.CHECK_PERMISSAO(CLL.CD_OBJETO) = 'S' AND
			  OBJ.CD_OBJETO=CLL.CD_OBJETO AND
              PA.CD_PONTO=CLL.CD_OBJETO AND
			  OBJ.TP_OBJETO <> 'FILE' AND TP_OBJETO <> 'RELATORIO'
		ORDER BY ORDEM ASC;

	WS_TOGO		CRS_TOGO%ROWTYPE;

    CURSOR CRS_SCRIPTS IS
    SELECT OBJ.CD_OBJETO AS CD_OBJETO, CLL.CD_OBJETO AS CD_OBJETO_GO, NM_OBJETO AS NM_ITEM, TP_OBJETO, CLL.ORDEM AS ORDEM, OBJ.ATRIBUTOS AS ATT
    FROM OBJETOS OBJ, CALL_LIST CLL
    WHERE TP_OBJETO = 'SCRIPT'AND 
    CLL.CD_OBJETO = OBJ.CD_OBJETO AND
    CLL.CD_LIST  = PRM_OBJETO;

    WS_SCRIPT CRS_SCRIPTS%ROWTYPE;

	CURSOR CRS_RELATORIOS IS
    SELECT OBJ.CD_OBJETO AS CD_OBJETO, CLL.CD_OBJETO AS CD_OBJETO_GO, NM_OBJETO AS NM_ITEM, TP_OBJETO, CLL.ORDEM AS ORDEM, OBJ.ATRIBUTOS AS ATT
    FROM OBJETOS OBJ, CALL_LIST CLL
    WHERE TP_OBJETO = 'RELATORIO' AND
    CLL.CD_OBJETO = OBJ.CD_OBJETO AND
    CLL.CD_LIST  = PRM_OBJETO;

    WS_RELATORIO CRS_RELATORIOS%ROWTYPE;

	CURSOR CRS_FILES IS
		SELECT CLL.CD_LIST AS CD_OBJETO, CLL.CD_OBJETO AS CD_OBJETO_GO, ORDEM,
		(SELECT NM_ITEM FROM CALL_NAME NAME WHERE NAME.CD_OBJETO=CLL.CD_OBJETO AND NAME.SCREEN=TRIM(PRM_SCREEN)) AS NM_ITEM,
		OBJ.TP_OBJETO AS TIPO,
		OBJ.ATRIBUTOS AS ATT,
		OBJ.NM_OBJETO AS NOME
		FROM CALL_LIST CLL, OBJETOS OBJ
		WHERE
		      CLL.CD_LIST  = PRM_OBJETO AND
			  FUN.CHECK_PERMISSAO(CLL.CD_OBJETO) = 'S' AND
			  OBJ.CD_OBJETO=CLL.CD_OBJETO AND
			  OBJ.TP_OBJETO = 'FILE'
		ORDER BY ORDEM ASC;

	WS_FILE		CRS_FILES%ROWTYPE;

	WS_LIGACAO	VARCHAR2(200);
	WS_CONDICAO	VARCHAR2(80);
	WS_POSX		VARCHAR2(80);
	WS_POSY		VARCHAR2(80);
	WS_GRUPO 	VARCHAR2(40) := '999999999';
	WS_COUNT 	NUMBER := 0;

	WS_NOUSER	EXCEPTION;

BEGIN

	IF GBL.GETUSUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
			HTP.P('<tr>');
			    HTP.P('<th>VIEW</th>');
                HTP.P('<th>ID</th>');
				HTP.P('<th>'||FUN.LANG('NOME')||'</th>');
				HTP.P('<th>'||FUN.LANG('TEXTO DO BOT&Atilde;O')||'</th>');
				HTP.P('<th>'||FUN.LANG('ORDEM')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax">');
			OPEN CRS_TOGO;
			LOOP
				FETCH CRS_TOGO INTO WS_TOGO;
				EXIT WHEN CRS_TOGO%NOTFOUND;
				WS_COUNT := WS_COUNT+1;
					HTP.P('<tr>');
						HTP.P('<td style="white-space: nowrap; padding-right: 5px;">'||WS_TOGO.VISAO||'</td>');
                        HTP.P('<td style="white-space: nowrap; padding-right: 5px;">'||WS_TOGO.CD_OBJETO_GO||'</td>');
						HTP.P('<td style="white-space: nowrap; text-overflow: ellipsis;">'||WS_TOGO.NOME||'</td>');
						HTP.P('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ document.getElementById('''||WS_TOGO.CD_OBJETO_GO||'menu'').childNodes[0].innerHTML = this.textContent; } else { document.getElementById('''||WS_TOGO.CD_OBJETO_GO||'menu'').childNodes[0].text =  '''||WS_TOGO.NOME||'''; } ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_TOGO.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=1'', ''true''); "contenteditable="true" >'||WS_TOGO.NM_ITEM||'</div></td>');
						HTP.P('<td>');
								HTP.P('<select title="'||FUN.LANG('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_TOGO.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=2'', ''true''); ">');
									FCL.NUMERICOPTIONS(20, WS_TOGO.ORDEM);
							HTP.P('</select>');
						HTP.P('</td>');
							HTP.P('<td id="'||WS_TOGO.CD_OBJETO_GO||'linha"><a class="remove" title="'||FUN.LANG('Excluir')||'" onclick="var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_call'', ''p_cd_objeto='||PRM_OBJETO||'&p_cd_objeto_go='||WS_TOGO.CD_OBJETO_GO||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_EX); } });">X</a></td>');
					HTP.P('</tr>');
			END LOOP;
			CLOSE CRS_TOGO;

            OPEN CRS_SCRIPTS;
			LOOP
				FETCH CRS_SCRIPTS INTO WS_SCRIPT;
				EXIT WHEN CRS_SCRIPTS%NOTFOUND;
				WS_COUNT := WS_COUNT+1;
					HTP.P('<tr>');
						HTP.P('<td style="white-space: nowrap; padding-right: 5px;">N/A</td>');
                        HTP.P('<td style="white-space: nowrap; padding-right: 5px;">'||WS_SCRIPT.CD_OBJETO_GO||'</td>');
						HTP.P('<td style="white-space: nowrap; text-overflow: ellipsis;">'||WS_SCRIPT.NM_ITEM||'</td>');
						HTP.P('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_SCRIPT.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=1'', ''true''); }" contenteditable="true" >'||WS_SCRIPT.NM_ITEM||'</div></td>');
						HTP.P('<td>');
							HTP.P('<select title="'||FUN.LANG('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_SCRIPT.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=2'', ''true''); ">');
							    FCL.NUMERICOPTIONS(20, WS_SCRIPT.ORDEM);
							HTP.P('</select>');
						HTP.P('</td>');
						HTP.P('<td>');
							FCL.BUTTON_LIXO('dl_call','p_cd_objeto|p_cd_objeto_go', PRM_OBJETO||'|'||WS_TOGO.CD_OBJETO_GO);
						HTP.P('</td>');

					HTP.P('</tr>');
			END LOOP;
			CLOSE CRS_SCRIPTS;

            OPEN CRS_RELATORIOS;
			LOOP
				FETCH CRS_RELATORIOS INTO WS_RELATORIO;
				EXIT WHEN CRS_RELATORIOS%NOTFOUND;
				WS_COUNT := WS_COUNT+1;
					HTP.P('<tr>');
						HTP.P('<td style="white-space: nowrap; padding-right: 5px;">N/A</td>');
                        HTP.P('<td style="white-space: nowrap; padding-right: 5px;">'||WS_RELATORIO.CD_OBJETO_GO||'</td>');
						HTP.P('<td style="white-space: nowrap; text-overflow: ellipsis;">'||FUN.CDESC(WS_RELATORIO.CD_OBJETO_GO,'DESC_CONSULTA')||'</td>');
						HTP.P('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_RELATORIO.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=1'', ''true''); }" contenteditable="true" >'||WS_RELATORIO.NM_ITEM||'</div></td>');
						HTP.P('<td>');
							HTP.P('<select title="'||FUN.LANG('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_RELATORIO.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=2'', ''true''); ">');
							    FCL.NUMERICOPTIONS(20, WS_RELATORIO.ORDEM);
							HTP.P('</select>');
						HTP.P('</td>');

						HTP.P('<td>');
							FCL.BUTTON_LIXO('dl_call','p_cd_objeto|p_cd_objeto_go', PRM_OBJETO||'|'||WS_RELATORIO.CD_OBJETO_GO);
						HTP.P('</td>');
											        
					HTP.P('</tr>');
			END LOOP;
			CLOSE CRS_RELATORIOS;

			OPEN CRS_FILES;
			LOOP
				FETCH CRS_FILES INTO WS_FILE;
				EXIT WHEN CRS_FILES%NOTFOUND;
				WS_COUNT := WS_COUNT+1;
					HTP.P('<tr>');
						HTP.P('<td style="white-space: nowrap; padding-right: 5px;">N/A</td>');
                        HTP.P('<td style="white-space: nowrap; padding-right: 5px;">'||WS_FILE.CD_OBJETO_GO||'</td>');
						HTP.P('<td style="white-space: nowrap; text-overflow: ellipsis;">'||WS_FILE.NOME||' - '||WS_FILE.ATT||'</td>');
						HTP.P('<td><div title="nome no bot&atilde;o" style="min-height: 25px;" class="editable" onblur=" if(this.textContent != ''''){ ajax(''fly'', ''update_call'', ''prm_item=''+this.textContent+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_FILE.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=1'', ''true''); }" contenteditable="true" >'||WS_FILE.NM_ITEM||'</div></td>');
						HTP.P('<td>');
							HTP.P('<select title="'||FUN.LANG('ordem do bot&atilde;o')||'" onchange=" ajax(''fly'', ''update_call'', ''prm_item=''+this.value+''&prm_list='||PRM_OBJETO||'&prm_objeto='||WS_FILE.CD_OBJETO_GO||'&prm_screen='||PRM_SCREEN||'&prm_acao=2'', ''true''); ">');
							    FCL.NUMERICOPTIONS(20, WS_FILE.ORDEM);
							HTP.P('</select>');
						HTP.P('</td>');
						HTP.P('<td>');
							FCL.BUTTON_LIXO('dl_call','p_cd_objeto|p_cd_objeto_go', PRM_OBJETO||'|'||WS_FILE.CD_OBJETO_GO);
						HTP.P('</td>');
					HTP.P('</tr>');
			END LOOP;
			CLOSE CRS_FILES;

		HTP.P('</tbody>');
	HTP.TABLECLOSE;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_CALL;


PROCEDURE UPDATE_CALL( PRM_ITEM VARCHAR2 DEFAULT NULL,
					   PRM_LIST VARCHAR2 DEFAULT NULL,
					   PRM_OBJETO VARCHAR2 DEFAULT NULL,
					   PRM_SCREEN VARCHAR2 DEFAULT NULL,
					   PRM_ACAO INTEGER DEFAULT 1) AS


	WS_COUNT NUMBER;
BEGIN
    
    IF TRIM(PRM_ITEM) <> '''' THEN
	    IF PRM_ACAO = 1 THEN
			SELECT COUNT(*) INTO WS_COUNT FROM CALL_NAME WHERE CD_LIST = PRM_LIST AND SCREEN = PRM_SCREEN AND CD_OBJETO = PRM_OBJETO;
			IF WS_COUNT = 0 THEN
				INSERT INTO CALL_NAME VALUES(PRM_ITEM, PRM_LIST, PRM_OBJETO, PRM_SCREEN);
				COMMIT;
			ELSE
				UPDATE CALL_NAME SET NM_ITEM = PRM_ITEM
				WHERE CD_LIST = PRM_LIST AND CD_OBJETO = PRM_OBJETO AND SCREEN = PRM_SCREEN;
				COMMIT;
			END IF;
		ELSE
		    UPDATE CALL_LIST SET ORDEM = PRM_ITEM
			WHERE CD_LIST = PRM_LIST AND CD_OBJETO = PRM_OBJETO;
			COMMIT;
		END IF;
	ELSE
	    DELETE FROM CALL_NAME
		WHERE CD_LIST = PRM_LIST AND CD_OBJETO = PRM_OBJETO AND SCREEN = PRM_SCREEN;
		COMMIT;
	END IF;

END UPDATE_CALL;




































































































PROCEDURE EDIT_OFILTRO ( P_ITEM         CHAR     DEFAULT '1',
			             NEW_CD_OBJETO  VARCHAR2 DEFAULT NULL,
			             NEW_CD_COLUNA  VARCHAR2 DEFAULT NULL,
			             NEW_CONDICAO   VARCHAR2 DEFAULT NULL,
			             NEW_CONTEUDO   VARCHAR2 DEFAULT NULL,
			             PRM_LIGACAO	VARCHAR2 DEFAULT 'and',
                         PRM_VISAO      VARCHAR2 DEFAULT NULL,
                         PRM_AGRUPADO   CHAR     DEFAULT 'N',
                         PRM_USUARIO    VARCHAR2 DEFAULT NULL ) AS


		WS_CONDICAO	VARCHAR2(80);
		WS_COUNT    NUMBER;
		WS_AGRUPADO CHAR(1);
		WS_INC      NUMBER := 0;
		WS_KEY      NUMBER := 0;

		CURSOR CRS_COLUNAS IS
	    SELECT CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO
	    FROM MICRO_COLUNA
	    WHERE CD_MICRO_VISAO = PRM_VISAO
	    ORDER BY CD_COLUNA DESC;
	    

	WS_COLUNAS CRS_COLUNAS%ROWTYPE;

    WS_TIPO     VARCHAR2(80);
    WS_CONTEUDO VARCHAR2(2000);
	WS_USUARIO  VARCHAR2(80);
	
	WS_NOUSER   EXCEPTION;
BEGIN

    

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	WS_CONTEUDO := FUN.CONVERTE(NEW_CONTEUDO);

    SELECT TP_OBJETO INTO WS_TIPO FROM OBJETOS WHERE CD_OBJETO = NEW_CD_OBJETO;

	IF FUN.CHECK_ADMIN('FILTERS_ADD') OR INSTR(NEW_CD_OBJETO, 'BRO') > 0 THEN

		SELECT COUNT(*) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_COLUNA = NEW_CD_COLUNA AND CD_MICRO_VISAO = PRM_VISAO AND ST_AGRUPADOR = 'SEM' AND ROWNUM = 1;
		IF WS_COUNT = 1 THEN
			WS_AGRUPADO := 'N';
		ELSE
			WS_AGRUPADO := PRM_AGRUPADO;
		END IF;
			
		SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

		LOOP
		
			WS_INC := WS_INC+1;
		
			SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
		
			IF WS_COUNT > 0 THEN
				SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
			ELSE
				EXIT;
			END IF;
		END LOOP;

		INSERT INTO FILTROS VALUES (NVL(PRM_USUARIO, 'DWU'), NEW_CD_OBJETO, PRM_VISAO, NEW_CD_COLUNA, NEW_CONDICAO, WS_CONTEUDO, PRM_LIGACAO, WS_AGRUPADO, WS_KEY, 'objeto', WS_USUARIO);

    ELSE

	    HTP.P('#alert '||FUN.LANG('Sem permiss&atilde;o')||'!');

	END IF;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END EDIT_OFILTRO;



PROCEDURE EDIT_SFILTRO ( P_ITEM          CHAR DEFAULT '1',
			             NEW_CD_OBJETO   VARCHAR2 DEFAULT NULL,
			             NEW_MICRO_VISAO VARCHAR2 DEFAULT NULL,
			             NEW_CD_COLUNA   VARCHAR2 DEFAULT NULL,
			             NEW_CONDICAO	 VARCHAR2 DEFAULT NULL,
			             NEW_CONTEUDO	 VARCHAR2 DEFAULT NULL,
			             NEW_LIGACAO	 VARCHAR2 DEFAULT 'and' ) AS


	WS_MAX      NUMBER;
	WS_COUNT    NUMBER;
	WS_KEY      NUMBER := 0;
	WS_INC      NUMBER := 0;
	WS_CONDICAO	VARCHAR2(80);
	WS_USUARIO  VARCHAR2(80);
	WS_CONTEUDO VARCHAR2(800);

	WS_NOUSER   EXCEPTION;
	WS_FAIL     EXCEPTION;
BEGIN
    
	

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	WS_CONTEUDO := FUN.CONVERTE(NEW_CONTEUDO);
    
    SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;
    
    LOOP
    
        WS_INC := WS_INC+1;
    
	    SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
	
	    IF WS_COUNT > 0 THEN
	        SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
	    ELSE
	        EXIT;
	    END IF;
	END LOOP;
    
    
	INSERT INTO FILTROS
		(CD_USUARIO, CD_OBJETO, MICRO_VISAO, CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO, ST_AGRUPADO, CD_FILTRO, TP_FILTRO, CD_CRIADO)
	VALUES
		('DWU', NEW_CD_OBJETO, NEW_MICRO_VISAO, NEW_CD_COLUNA, NEW_CONDICAO, WS_CONTEUDO, NEW_LIGACAO, 'N', WS_KEY, 'objeto', WS_USUARIO);
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT = 1 THEN
	    COMMIT;
    ELSE
        RAISE WS_FAIL;
    END IF;
		
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_FAIL THEN
	    HTP.P('FAIL');
	WHEN OTHERS THEN
		HTP.P('FAIL');
END EDIT_SFILTRO;





PROCEDURE LIST_CDESC ( PRM_ORDER VARCHAR2 DEFAULT '1',
                       PRM_DIR VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_CDESC IS
		SELECT NDS_TABELA, NDS_OWNER, NDS_TFISICA, NDS_CD_EMPRESA, NDS_CD_CODIGO, NDS_CD_DESCRICAO
		FROM CODIGO_DESCRICAO
		ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', NDS_TABELA, '2', NDS_TFISICA, '3', NDS_CD_EMPRESA, '4', NDS_CD_CODIGO, '5', NDS_CD_DESCRICAO, NDS_TABELA) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', NDS_TABELA, '2', NDS_TFISICA, '3', NDS_CD_EMPRESA, '4', NDS_CD_CODIGO, '5', NDS_CD_DESCRICAO, NDS_TABELA) END DESC;

	WS_CDESC	CRS_CDESC%ROWTYPE;
    WS_DIR NUMBER := 1;

	WS_NOADMIN EXCEPTION;
BEGIN
    
	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;

	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th style="width: 25%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME')||'</a></th>');
				HTP.P('<th style="width: 25%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('TABELA')||'</a></th>');
				HTP.P('<th style="width: 25%;"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('C&Oacute;DIGO')||'</a></th>');
				HTP.P('<th style="width: calc(25% - 22px);"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_cdesc'', ''prm_order=5&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</a></th>');
				HTP.P('<th style="width: 22px;"></th>');
			HTP.P('<tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;

			HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
			OPEN CRS_CDESC;
				LOOP
					FETCH CRS_CDESC INTO WS_CDESC;
					EXIT WHEN CRS_CDESC%NOTFOUND;
						HTP.P('<tr>');
							HTP.P('<td style="width: 25%;">'||WS_CDESC.NDS_TABELA||'</td>');
							HTP.P('<td style="width: 25%;">'||WS_CDESC.NDS_TFISICA||'</td>');
							HTP.P('<td style="width: 25%;">'||WS_CDESC.NDS_CD_CODIGO||'</td>');
							HTP.P('<td style="width: calc(25% - 22px);">'||WS_CDESC.NDS_CD_DESCRICAO||'</td>');
							
							HTP.P('<td>');
								FCL.BUTTON_LIXO('dl_cd','ws_par_sumary', WS_CDESC.NDS_TABELA);
							HTP.P('<td>');
							
							
						HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_CDESC;
		HTP.P('</tbody>');
	HTP.TABLECLOSE;
EXCEPTION
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_CDESC;





PROCEDURE LIST_SINAL AS

	CURSOR CRS_SINAL IS
	SELECT CD_SINAL, DS_SINAL, TP_SINAL, FX_01, FX_02, FX_03, FX_04, FX_05
	FROM SINAIS ORDER BY CD_SINAL ASC;

	WS_SINAL	CRS_SINAL%ROWTYPE;

	CURSOR CRS_COLUNAS IS
	SELECT T1.CD_USUARIO, T2.COD, T1.CD_OBJETO, T2.NM_OBJETO, T1.CD_COLUNA, T1.CD_SINAL
	FROM SINAL_COLUNA T1
	LEFT JOIN OBJETOS T2
	ON T2.CD_OBJETO = T1.CD_OBJETO
	ORDER BY CD_COLUNA ASC;

	WS_COLUNA CRS_COLUNAS%ROWTYPE;

	WS_COUNT    NUMBER;
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO  VARCHAR2(80);
	WS_NOACCESS EXCEPTION;

BEGIN
    

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' OR GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOACCESS;
	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
	
	HTP.P('<ul style="display: flex; flex-flow: row; flex-wrap: wrap;">');
	
	    HTP.P('<li style="flex-basis: 100%; display: flex; flex-flow: row wrap;">');
	
			HTP.P('<h2 style="width: 100%;">'||FUN.LANG('LISTA DE SINALIZADORES')||'</h2>');

			HTP.P('<table class="linha"><thead>');
			HTP.P('<tr>');
				HTP.P('<th>'||FUN.LANG('SINAL')||'</th>');
				HTP.P('<th>'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th>'||FUN.LANG('IMAGEM')||'</th>');
				HTP.P('<th>'||FUN.LANG('FAIXA 1')||'</th>');
				HTP.P('<th>'||FUN.LANG('FAIXA 2')||'</th>');
				HTP.P('<th>'||FUN.LANG('FAIXA 3')||'</th>');
				HTP.P('<th>'||FUN.LANG('FAIXA 4')||'</th>');
				HTP.P('<th>'||FUN.LANG('FAIXA 5')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
			HTP.P('</thead><tbody>');

			OPEN CRS_SINAL;
				LOOP
					FETCH CRS_SINAL INTO WS_SINAL;
					EXIT WHEN CRS_SINAL%NOTFOUND;
					HTP.P('<tr>');
						HTP.P('<td><span id="'||WS_SINAL.CD_SINAL||'_sinal" title="'||WS_SINAL.CD_SINAL||'">'||FUN.UTRANSLATE('CD_SINAL', 'SINAIS', WS_SINAL.CD_SINAL, WS_PADRAO)||'</span><a style="margin-left: 3px;" class="fakelang" onclick="fakeLang(this.previousElementSibling.id, ''SINAIS|CD_SINAL|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
						HTP.P('<td><span id="'||WS_SINAL.CD_SINAL||'_desc" title="'||WS_SINAL.DS_SINAL||'">'||FUN.UTRANSLATE('DS_SINAL', 'SINAIS', WS_SINAL.DS_SINAL, WS_PADRAO)||'</span><a style="margin-left: 3px;" class="fakelang" onclick="fakeLang('''||WS_SINAL.CD_SINAL||'_desc'', ''SINAIS|DS_SINAL|''+this.previousElementSibling.title);">L</a></td>');
						
						HTP.P('<td>');
						
						    HTP.P('<a class="script" onclick="call(''update_sinal'', ''prm_sinal='||WS_SINAL.CD_SINAL||'&prm_tipo=tp_sinal&prm_valor=''+this.nextElementSibling.title).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></a>');
						    FCL.FAKEOPTION(''||WS_SINAL.CD_SINAL||'_fake', 'Escolha os icones', WS_SINAL.TP_SINAL, 'lista-sinais-opcoes', 'N', 'N', PRM_DESC => HTF.IMG(FUN.R_GIF('ind'||WS_SINAL.TP_SINAL||'_1', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||WS_SINAL.TP_SINAL||'_2', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||WS_SINAL.TP_SINAL||'_3', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||WS_SINAL.TP_SINAL||'_4', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||WS_SINAL.TP_SINAL||'_5', 'PNG' )));
						HTP.P('</td>');
						
						HTP.P('<td><input type="text" maxlength="40" value="'||WS_SINAL.FX_01||'" onblur="call(''update_sinal'', ''prm_sinal='||WS_SINAL.CD_SINAL||'&prm_tipo=fx_01&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						HTP.P('<td><input type="text" maxlength="40" value="'||WS_SINAL.FX_02||'" onblur="call(''update_sinal'', ''prm_sinal='||WS_SINAL.CD_SINAL||'&prm_tipo=fx_02&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						HTP.P('<td><input type="text" maxlength="40" value="'||WS_SINAL.FX_03||'" onblur="call(''update_sinal'', ''prm_sinal='||WS_SINAL.CD_SINAL||'&prm_tipo=fx_03&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						HTP.P('<td><input type="text" maxlength="40" value="'||WS_SINAL.FX_04||'" onblur="call(''update_sinal'', ''prm_sinal='||WS_SINAL.CD_SINAL||'&prm_tipo=fx_04&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						HTP.P('<td><input type="text" maxlength="40" value="'||WS_SINAL.FX_05||'" onblur="call(''update_sinal'', ''prm_sinal='||WS_SINAL.CD_SINAL||'&prm_tipo=fx_05&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''fail'') == -1){ alerta('''', TR_AL); } else { alerta('''', TR_ER); } });"></td>');
						
						IF WS_COUNT = 0 THEN
						    HTP.P('<td><a class="remove" title="'||FUN.LANG('Excluir')||'" onclick="if(confirm(TR_CE)){ var row = this.parentNode.parentNode; row.classList.add(''removing''); call(''dl_sn'', ''ws_par_sumary='||WS_SINAL.CD_SINAL||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ row.remove(); alerta(''feed-fixo'', TR_EX); } else { row.classList.remove(''removing''); alerta(''feed-fixo'', TR_ER); } }); }">X</a></td>');
					    ELSE
                            HTP.P('<td><a class="noremove" title="'||FUN.LANG('Imposs&iacute;vel Excluir')||'">X</a></td>');
						END IF;
					HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_SINAL;

			HTP.P('</tbody>');
			HTP.P('<tbody id="ajax_sinal"></tbody>');
			HTP.P('</table>');
  
		HTP.P('</li>');
		
		HTP.P('<li style="flex-basis: 100%; display: flex; flex-flow: row wrap;">');	
			HTP.P('<h2 style="width: 100%;">'||FUN.LANG('COLUNAS COM SINALIZADORES')||'</h2>');
				
				HTP.P('<table class="linha"><tbody>');
				HTP.P('<tr>');
					HTP.P('<th>'||FUN.LANG('USU&Aacute;RIO')||'</th>');
					HTP.P('<th>'||FUN.LANG('OBJETO')||'</th>');
					HTP.P('<th>'||FUN.LANG('COLUNA')||'</th>');
					HTP.P('<th>'||FUN.LANG('SINAL')||'</th>');
					HTP.P('<th></th>');
				HTP.P('</tr>');
				OPEN CRS_COLUNAS;
					LOOP
						FETCH CRS_COLUNAS INTO WS_COLUNA;
						EXIT WHEN CRS_COLUNAS%NOTFOUND;
							HTP.P('<tr>');
								HTP.P('<td>'||WS_COLUNA.CD_USUARIO||'</td>');
								HTP.P('<td>'||NVL(WS_COLUNA.COD, WS_COLUNA.CD_OBJETO)||' - '||WS_COLUNA.NM_OBJETO||'</td>');
								HTP.P('<td>'||WS_COLUNA.CD_COLUNA||'</td>');
								HTP.P('<td>'||FUN.UTRANSLATE('CD_SINAL', 'SINAIS', WS_COLUNA.CD_SINAL, WS_PADRAO)||'</td>');
								
								HTP.P('<td>');
								    FCL.BUTTON_LIXO('delete_csinal','d_usuario|d_pa|d_coluna|d_sinal', TRIM(WS_COLUNA.CD_USUARIO)||'|'||WS_COLUNA.CD_OBJETO||'|'||WS_COLUNA.CD_COLUNA||'|'||WS_COLUNA.CD_SINAL);
							    HTP.P('</td>');
								
								
							HTP.P('</tr>');
					END LOOP;
				CLOSE CRS_COLUNAS;
			HTP.P('</tbody>');
			HTP.P('<tbody id="ajax_csinal">');
			HTP.P('</tbody>');
			HTP.P('</table>');
		
        HTP.P('</li>');
		
	HTP.P('</ul>');
EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_SINAL;


PROCEDURE SAVE_SINAL ( PAR_NAME   VARCHAR2 DEFAULT 'Novo',
					   PAR_NAMEDS VARCHAR2 DEFAULT NULL,
					   PAR_SINAIS NUMBER   DEFAULT 1) AS
					   
	WS_COUNT NUMBER;
	WS_FAIL  EXCEPTION;
    
	WS_CONVERTE    VARCHAR2(800);
    WS_CONVERTE_NM VARCHAR2(800);

BEGIN
    
	WS_CONVERTE_NM   := FUN.CONVERTE(PAR_NAME);
    WS_CONVERTE      := FUN.CONVERTE(PAR_NAMEDS);
	
	INSERT INTO SINAIS VALUES (UPPER(TRIM(WS_CONVERTE_NM)), TRIM(WS_CONVERTE), PAR_SINAIS, '', '', '', '', '');
	
	WS_COUNT := SQL%ROWCOUNT;
        
	IF WS_COUNT <> 0 THEN
		COMMIT;
	ELSE
		RAISE WS_FAIL;
	END IF;
	
	INSERT INTO TRADUCAO_COLUNAS VALUES ('SINAIS', 'CD_SINAL', FUN.RET_VAR('LANG_SYS'), UPPER(TRIM(WS_CONVERTE_NM)), UPPER(TRIM(WS_CONVERTE_NM)), 'T', 'N');
	INSERT INTO TRADUCAO_COLUNAS VALUES ('SINAIS', 'DS_SINAL', FUN.RET_VAR('LANG_SYS'), TRIM(WS_CONVERTE), TRIM(WS_CONVERTE), 'T', 'N');

EXCEPTION
    WHEN WS_FAIL THEN
	    HTP.P('FAIL');
	WHEN OTHERS THEN
	    HTP.P('FAIL');
END SAVE_SINAL;

PROCEDURE DELETE_CSINAL( D_USUARIO VARCHAR2 DEFAULT NULL,
						D_PA VARCHAR2 DEFAULT NULL,
						D_COLUNA VARCHAR2 DEFAULT NULL,
						D_SINAL VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER;

BEGIN
    
    SELECT COUNT(*) INTO WS_COUNT FROM SINAL_COLUNA WHERE D_USUARIO = CD_USUARIO AND D_PA = CD_OBJETO AND D_COLUNA = CD_COLUNA AND D_SINAL = CD_SINAL;
	IF WS_COUNT = 1 THEN
	    DELETE FROM SINAL_COLUNA WHERE D_USUARIO = CD_USUARIO AND D_PA = CD_OBJETO AND D_COLUNA = CD_COLUNA AND D_SINAL = CD_SINAL;
	ELSIF WS_COUNT > 1 THEN
	    HTP.P('#alert '||FUN.LANG('Impossivel excluir, valor duplicado')||'!');
	ELSE
	    HTP.P('#alert '||FUN.LANG('Impossivel excluir, valor inexistente')||'!');
	END IF;

	EXCEPTION WHEN OTHERS THEN
	HTP.P(''||FUN.LANG('Sinal de coluna n&atilde;o foi excluido')||'.');

END DELETE_CSINAL;

PROCEDURE INSERT_CSINAL ( I_USUARIO VARCHAR2 DEFAULT NULL,
						  I_PA      VARCHAR2 DEFAULT NULL,
						  I_COLUNA  VARCHAR2 DEFAULT NULL,
						  I_SINAL   VARCHAR2 DEFAULT NULL ) AS
    WS_COUNT NUMBER;
	WS_FAIL  EXCEPTION;
BEGIN
    
	SELECT COUNT(*) INTO WS_COUNT FROM SINAL_COLUNA WHERE CD_USUARIO = TRIM(I_USUARIO) AND CD_OBJETO = TRIM(I_PA) AND CD_COLUNA = TRIM(I_COLUNA);
	IF WS_COUNT = 0 THEN
		INSERT INTO SINAL_COLUNA VALUES(TRIM(I_USUARIO), TRIM(I_PA), TRIM(I_COLUNA), TRIM(I_SINAL));
	END IF;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
    ELSE
        RAISE WS_FAIL;
    END IF;

EXCEPTION 
    WHEN WS_FAIL THEN
	    HTP.P('FAIL');
    WHEN OTHERS THEN
        HTP.P('FAIL');
END INSERT_CSINAL;

PROCEDURE FLOAT_MENU ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_ITENS(PRM_USUARIO VARCHAR2, PRM_ADMIN VARCHAR2) IS
		SELECT CD_OBJETO, COD, OBJETOS.CD_GRUPO, NM_GRUPO, NM_OBJETO, NVL(COR_FUNDO,'#FFFFFF') COR_FUNDO, URL_FUNDO, DISPOSITIVO,
       NVL(TRIM(OR_GRUPO),OBJETOS.CD_GRUPO) AS OR_GRUPO, NVL(TRIM(OR_ITEM),NM_OBJETO) AS OR_OBJETO
		FROM OBJETOS, ALL_SCREENS, GRUPOS_FUNCAO
		WHERE TP_OBJETO = 'SCREEN' AND
		ALL_SCREENS.PUBLICO = 'S' AND
        CD_OBJETO = SCREEN(+) AND
        OBJETOS.CD_GRUPO = GRUPOS_FUNCAO.CD_GRUPO AND
        (
			PRM_ADMIN = 'A' OR
			
			SCREEN IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO IN (SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = PRM_USUARIO) OR USUARIO = PRM_USUARIO)
		) 
    ORDER BY GRUPOS_FUNCAO.ORDEM, OR_GRUPO, OR_OBJETO;

	WS_ITENS	CRS_ITENS%ROWTYPE;

	WS_COUNT	  NUMBER		:= 0;
	WS_CGRUPO	  NUMBER		:= 0;
	WS_CITEM	  NUMBER		:= 1;
	WS_GRUPO_ANT  VARCHAR2(40)	:= 'FIRST_TIME';
	WS_SIZE       NUMBER;
	WS_SHOW_ONLY  VARCHAR2(1);
	WS_ADMIN      VARCHAR2(80);
	WS_USUARIO    VARCHAR2(80);
	WS_PADRAO     VARCHAR2(80) := 'PORTUGUESE';

BEGIN

    WS_ADMIN   := GBL.GETNIVEL;
    WS_USUARIO := GBL.GETUSUARIO;

    
    SELECT NVL(SHOW_ONLY, 'N') INTO WS_SHOW_ONLY FROM USUARIOS WHERE USU_NOME = WS_USUARIO;
	HTP.P('<iframe onload="go = (this.contentWindow || this.contentDocument); if(go.document.body.innerHTML != ''''){ document.getElementById(''content'').innerHTML = go.document.body.innerHTML; go.document.body.innerHTML = ''''; this.src=''''; }" name="workarea" id="frame" class="frame"></iframe>');
	HTP.P('<iframe onload="go = (this.contentWindow || this.contentDocument); if(go.document.body.innerHTML != ''''){ document.getElementById(''painel'').innerHTML = go.document.body.innerHTML; go.document.body.innerHTML = ''''; this.src=''''; }" name="workarea" id="newmenu" class="frame"></iframe>');
	HTP.P('<iframe id="noload" class="frame" onload=""></iframe>');
	HTP.P('<div id="layer2" onload="document.getElementsByTagName(''div'').style.visibility = ''hidden''"></div>');
	HTP.P('<div id="layer3">');
	HTP.P('</div>');

	HTP.P('<a id="prev" onclick="cycle(document.querySelector(''.scaled'').id, ''prev'');" title="'||FUN.LANG('anterior')||'"><</a>');
	HTP.P('<a id="next" onclick="cycle(document.querySelector(''.scaled'').id, ''next'');" title="'||FUN.LANG('pr&oacute;ximo')||'">></a>');

	HTP.P('<div id="starting">');
		IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
			HTP.P('<img style="margin-top: 11%; max-width: 44%;" src="'||FUN.R_GIF('logo_upquery','JPG')||'" />');
		ELSE
			HTP.P('<img style="margin-top: 11%; max-width: 44%;" src="'||FUN.R_GIF('logo_upquery','WEBP')||'" />');
		END IF;

		HTP.P('<small style="display: inline-block; font-size: 10px; width: 20px;">ver. ');
			GBL.GETVERSION;
		HTP.P('</small>');
		

		HTP.P('<div id="loading-bar">');
			HTP.P('<div class="container-bar">');
				HTP.P('<div class="progress-bar"></div>');
			HTP.P('</div>');
		HTP.P('</div>');

	HTP.P('</div>');


	HTP.P('<div id="donut">');
	    


		
		HTP.P('<a class="circle" title="'||FUN.LANG('Sincronizar objetos da tela')||'" onmousedown="shscr(document.getElementById(''current_screen'').value);" ontouchend="shscr(document.getElementById(''current_screen'').value);">');
		    HTP.P('<img style="margin-top: 4px; margin-left: -1px;" src="'||FUN.R_GIF('sinchronize','png')||'" />');
		    
			HTP.P('<span class="texto">'||FUN.LANG('SINCRONIZAR')||'</span>');
		HTP.P('</a>');
		
		SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE OWNER = WS_USUARIO AND CD_PROP = 'DRILL' AND PROPRIEDADE = 'CENTER';
		IF WS_COUNT = 1 THEN
		  	HTP.P('<a class="circle" title="'||FUN.LANG('Centralizar drill ao abrir')||'" onmousedown="this.classList.toggle(''select''); ajax(''fly'', ''alter_value'', ''prm_object=DEFAULT&prm_prop=DRILL&prm_valor1=CENTER&prm_valor2=LADDER&prm_screen=DEFAULT''); " style="font-size: 26px;" >');
			HTP.P('<span class="img">C</span>');
			HTP.P('<span class="texto">'||FUN.LANG('CENTRO')||'</span>');
			HTP.P('</a>');
		ELSE
		    HTP.P('<a class="circle select" title="'||FUN.LANG('Centralizar drill ao abrir')||'" onmousedown="this.classList.toggle(''select''); ajax(''fly'', ''alter_value'', ''prm_object=DEFAULT&prm_prop=DRILL&prm_valor1=CENTER&prm_valor2=LADDER&prm_screen=DEFAULT''); " style="font-size: 26px;" >');
			    HTP.P('<span class="img">C</span>');
			    HTP.P('<span class="texto">'||FUN.LANG('CENTRO')||'</span>');
			HTP.P('</a>');
		END IF;
		
		WS_COUNT := 0;
		
		IF WS_ADMIN = 'A' THEN
			HTP.P('<a class="circle" title="'||FUN.LANG('Excluir objetos da tela')||'" style="color: #444; font-size: 20px;" onmousedown="call_save(''''); titulo(this, ''c''); curtain(''enabled''); carrega(''obj_on_screen?prm_screen=''+document.getElementById(''current_screen'').value);">');
			HTP.P('<span class="img"><svg style="height: 24px; width: 24px; margin-top: 5px; opacity: 0.7;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"width="774.266px" height="774.266px" viewBox="0 0 774.266 774.266" style="enable-background:new 0 0 774.266 774.266;"xml:space="preserve"> <g> <g> <path d="M640.35,91.169H536.971V23.991C536.971,10.469,526.064,0,512.543,0c-1.312,0-2.187,0.438-2.614,0.875 C509.491,0.438,508.616,0,508.179,0H265.212h-1.74h-1.75c-13.521,0-23.99,10.469-23.99,23.991v67.179H133.916 c-29.667,0-52.783,23.116-52.783,52.783v38.387v47.981h45.803v491.6c0,29.668,22.679,52.346,52.346,52.346h415.703 c29.667,0,52.782-22.678,52.782-52.346v-491.6h45.366v-47.981v-38.387C693.133,114.286,670.008,91.169,640.35,91.169z M285.713,47.981h202.84v43.188h-202.84V47.981z M599.349,721.922c0,3.061-1.312,4.363-4.364,4.363H179.282 c-3.052,0-4.364-1.303-4.364-4.363V230.32h424.431V721.922z M644.715,182.339H129.551v-38.387c0-3.053,1.312-4.802,4.364-4.802 H640.35c3.053,0,4.365,1.749,4.365,4.802V182.339z"/> <rect x="475.031" y="286.593" width="48.418" height="396.942"/> <rect x="363.361" y="286.593" width="48.418" height="396.942"/> <rect x="251.69" y="286.593" width="48.418" height="396.942"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></span>');
			HTP.P('<span class="texto">'||FUN.LANG('EXCLUIR')||'</span>');
			HTP.P('</a>');
		END IF;
		
		IF WS_ADMIN = 'A' THEN
		    HTP.P('<a class="circle" title="'||FUN.LANG('Configura&ccedil;&otilde;es da tela')||'" onmousedown="carregaPainel(''''); if(document.getElementById(''current_screen'').value != ''SANDBOX''){ call_save(''savescr''); loadAttrib(''screen_prop'', ''ws_par_sumary=''+document.getElementById(''current_screen'').value); } else { alerta(''feed-fixo'', '''||FUN.LANG('op&ccedil;&atilde;o indispon&iacute;vel!')||'''); } "><img style="margin-top: 6px;" src="'||FUN.R_GIF('frame','png')||'" /><span class="texto">'||FUN.LANG('PROPRIEDADE')||'</span></a>');
		END IF;

		IF WS_ADMIN = 'A' THEN
		    HTP.P('<a class="circle" title="'||FUN.LANG('Inserir objeto')||'" onmousedown="closeSideBar(''attriblist''); document.getElementById(''attriblist'').classList.toggle(''open''); ajax(''list'', ''lista_objetos'', '''', false, ''attriblist'');"><img style="margin-top: 6px; margin-left: 1px;" src="'||FUN.R_GIF('folder','png')||'" /><span class="texto">'||FUN.LANG('OBJETOS')||'</span></a>');
		END IF;

		IF WS_ADMIN = 'A' THEN
		    HTP.P('<a class="circle" title="'||FUN.LANG('Filtro de tela')||'" onmousedown="titulo(this, ''n''); call_save(''''); carrega(''list_sfiltro?ws_par_sumary=''+document.getElementById(''current_screen'').value); curtain(''enabled''); carregaPainel(''filtro'');"><img style="margin-top: 8px;" src="'||FUN.R_GIF('filter_donut','png')||'" /><span class="texto">'||FUN.LANG('FILTRO')||'</span></a>');
		END IF;

		IF WS_ADMIN = 'A' THEN
		    HTP.P('<a class="circle" title="'||FUN.LANG('Novo objeto')||'" onmousedown="ajax(''quick'', ''quick_create'', ''prm_nome=&prm_tipo=OBJETO&prm_parametros=&prm_visao=&prm_coluna=&prm_grupo=&prm_obj_ant=&prm_filtro='', false);">');
			    HTP.P('<span class="img" style="color: #444; font-size: 42px; text-shadow: 0 0 1px #000;">+</span>');
				HTP.P('<span class="texto">'||FUN.LANG('CRIAR OBJETO')||'</span>');
			HTP.P('</a>');
			
		END IF;
		
		





		
		
		HTP.P('<a class="circle" title="'||FUN.LANG('Importar')||'" onmousedown="titulo(this, ''c''); call_save(''''); curtain(''enabled''); call(''main'', '''', ''imp'').then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; }); "><span class="img" style="color: #333; font-size: 34px; text-shadow: 0 0 1px #000;">');
			HTP.P('<svg style="height: 34px; width: 24px; fill: #333; margin-left: 2px;" version="1.1"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M495.343,45.601H221.818c-9.199,0-16.657,7.458-16.657,16.657V91.18H16.657C7.458,91.18,0,98.638,0,107.837v341.906 c0,9.199,7.458,16.657,16.657,16.657h341.918c9.199,0,16.657-7.458,16.657-16.657V261.25h120.112 c9.199,0,16.657-7.458,16.657-16.657V62.257C512,53.058,504.542,45.601,495.343,45.601z M341.918,433.086H33.313V124.493h171.847 v113.21l-40.56,40.56l-13.646-13.647c-9.057-9.059-24.555-4.896-27.867,7.467l-18.612,69.462 c-3.297,12.295,7.966,23.731,20.4,20.401l69.462-18.612c12.38-3.319,16.515-18.821,7.467-27.868l-13.647-13.647l40.565-40.565 h113.197V433.086z M478.687,227.936H238.48c0-101.027-0.006-146.919-0.006-149.022h240.212V227.936z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		HTP.P('</span><span class="texto">'||FUN.LANG('IMPORTAR')||'</span></a>');
		
		
		SELECT COUNT(*) INTO WS_COUNT FROM USUARIOS WHERE USU_NOME = WS_USUARIO AND UPLOAD = 'S';
		IF WS_COUNT = 1 OR WS_ADMIN = 'A' THEN
		    HTP.P('<a class="circle" title="Upload" onmousedown="document.getElementById(''titulo'').innerHTML = ''UPLOAD''; call_save(''''); curtain(''enabled''); carregaPainel(''upload''); carrega(''uploaded'');"><img style="margin-top: 6px; height: 22px;" src="'||FUN.R_GIF('upload','png')||'" /><span class="texto">UPLOAD</span></a>');
		END IF;
		
	HTP.P('</div>');

	IF WS_ADMIN = 'A'  THEN
 		
		HTP.P('<ul id="prefdrop" class="hidden" onmouseenter="this.focus();" onmouseleave="/*this.classList.remove(''hover'');*/">');

			HTP.P('<li><a title="'||fun.lang('Acessos')||'" data-menu="" data-refresh="acessos" data-carrega="acessos" data-attrib="" onclick="carregaPainel('''');" data-url="prm_completo=S">');
			    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="94px" height="82px" viewBox="0 0 94 82" style="enable-background:new 0 0 94 82;" xml:space="preserve"><path d="M53.131,0C30.902,0,12.832,17.806,12.287,39.976H0l18.393,20.5l18.391-20.5H22.506C23.045,23.468,36.545,10.25,53.131,10.25c16.93,0,30.652,13.767,30.652,30.75S70.061,71.75,53.131,71.75c-6.789,0-13.059-2.218-18.137-5.966l-7.029,7.521C34.904,78.751,43.639,82,53.131,82C75.703,82,94,63.645,94,41S75.703,0,53.131,0z M49.498,19v23.45l15.027,15.024l4.949-4.949L56.5,39.55V19H49.498z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>');
                HTP.P('<span>'||FUN.LANG('Acessos')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Colunas')||'" data-menu="list_crocks" data-refresh="" data-carrega="_" data-attrib="">');
				
				HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="35px" height="35px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35;" xml:space="preserve"> <g> <g> <rect width="6.119" height="35"/> <rect x="9.615" width="6.133" height="35"/> <rect x="19.245" width="6.116" height="35"/> <rect x="28.873" width="6.127" height="35"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('<span>'||FUN.LANG('Colunas')||'</span>');
			HTP.P('</a></li>');


			HTP.P('<li><a title="'||fun.lang('Destaques')||'" data-menu="efeito" data-refresh="" data-carrega="blink_coluna" data-attrib="">');
				HTP.P('<svg enable-background="new -1.23 -8.789 141.732 141.732" height="141.732px" version="1.1" viewBox="-1.23 -8.789 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_100"><path d="M139.273,49.088c0-3.284-2.75-5.949-6.146-5.949c-0.219,0-0.434,0.012-0.646,0.031l-42.445-1.001l-14.5-37.854   C74.805,1.824,72.443,0,69.637,0c-2.809,0-5.168,1.824-5.902,4.315L49.232,42.169L6.789,43.17c-0.213-0.021-0.43-0.031-0.646-0.031   C2.75,43.136,0,45.802,0,49.088c0,2.1,1.121,3.938,2.812,4.997l33.807,23.9l-12.063,37.494c-0.438,0.813-0.688,1.741-0.688,2.723   c0,3.287,2.75,5.952,6.146,5.952c1.438,0,2.766-0.484,3.812-1.29l35.814-22.737l35.812,22.737c1.049,0.806,2.371,1.29,3.812,1.29   c3.393,0,6.143-2.665,6.143-5.952c0-0.979-0.25-1.906-0.688-2.723l-12.062-37.494l33.806-23.9   C138.15,53.024,139.273,51.185,139.273,49.088"/></g><g/></svg>');
			    HTP.P('<span>'||FUN.LANG('Destaques')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="Etl" data-menu="etl" data-refresh="" data-carrega="etl" data-attrib="" data-package="etl">');
				HTP.P('<svg enable-background="new 0 0 500 500" height="500px"  version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M73.333,285.841c0,97.85,79.316,177.168,177.167,177.168  c97.846,0,177.168-79.318,177.168-177.168c0-79.497-52.332-146.731-124.475-169.172l-0.087-0.087  c-6.913-2.635-11.723-9.272-11.723-16.992c0-9.99,8.18-18.17,18.172-18.17h4.543c12.537,0,22.716-10.178,22.716-22.714  c0-12.538-10.179-22.715-22.716-22.715H186.901c-12.536,0-22.713,10.177-22.713,22.715c0,12.536,10.177,22.714,22.713,22.714h4.543  c9.996,0,18.173,8.18,18.173,18.17c0,7.906-5.09,14.632-12.086,17.177c-16.716,5.173-32.344,12.804-46.607,22.44l-16.717-16.727  c-6.272-6.264-16.626-6.264-22.898,0L87.143,146.66c-6.268,6.264-6.268,16.619,0,22.891l16.717,16.716  C84.601,214.702,73.333,248.95,73.333,285.841z M227.787,176.815c0-12.536,10.177-22.713,22.713-22.713  c12.537,0,22.715,10.177,22.715,22.713c0,12.539-10.178,22.716-22.715,22.716C237.964,199.531,227.787,189.354,227.787,176.815z   M118.761,285.841c0-12.535,10.177-22.711,22.713-22.711s22.713,10.176,22.713,22.711c0,12.537-10.177,22.716-22.713,22.716  S118.761,298.378,118.761,285.841z M336.814,285.841c0-12.535,10.175-22.711,22.712-22.711c12.535,0,22.715,10.176,22.715,22.711  c0,12.537-10.18,22.716-22.715,22.716C346.989,308.557,336.814,298.378,336.814,285.841z M227.787,394.867  c0-12.537,10.177-22.712,22.713-22.712c12.537,0,22.715,10.175,22.715,22.712c0,12.539-10.178,22.715-22.715,22.715  C237.964,417.582,227.787,407.406,227.787,394.867z M340.715,220.611l-73.678,73.687c-6.9,6.896-18.081,6.896-24.989,0  c-6.902-6.913-6.902-18.089,0-24.985l73.683-73.686c6.904-6.903,18.084-6.903,24.984,0  C347.62,202.529,347.62,213.709,340.715,220.611z"/></svg>');
			    HTP.P('<span>Etl</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Filtros De Usu&aacute;rios')||'" data-menu="filtrou" data-refresh="" data-carrega="filtro_geral" data-attrib="">');
				
				HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="971.986px" height="971.986px" viewBox="0 0 971.986 971.986" style="enable-background:new 0 0 971.986 971.986;" xml:space="preserve"> <g> <path d="M370.216,459.3c10.2,11.1,15.8,25.6,15.8,40.6v442c0,26.601,32.1,40.101,51.1,21.4l123.3-141.3 c16.5-19.8,25.6-29.601,25.6-49.2V500c0-15,5.7-29.5,15.8-40.601L955.615,75.5c26.5-28.8,6.101-75.5-33.1-75.5h-873 c-39.2,0-59.7,46.6-33.1,75.5L370.216,459.3z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('<span>'||FUN.LANG('Filtros')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Categorias')||'" data-menu="grupos" data-refresh="" data-carrega="grupos" data-attrib="">');
				HTP.P('<svg height="32px" style="enable-background:new 0 0 32 32;" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g/><g id="share"><path d="M28,24c-0.973,0-1.832,0.391-2.523,0.965l-6.098-4.352C19.766,19.816,20,18.941,20,18   c0-1.293-0.422-2.488-1.117-3.465l7.133-7.137C26.609,7.746,27.262,8,28,8c2.211,0,4-1.789,4-4s-1.789-4-4-4s-4,1.789-4,4   c0,0.738,0.254,1.391,0.602,1.984l-7.133,7.137C16.484,12.418,15.297,12,14,12c-2.289,0-4.258,1.301-5.27,3.191l-4.816-1.609   C3.719,12.684,2.957,12,2,12c-1.105,0-2,0.895-2,2s0.895,2,2,2c0.504,0,0.953-0.203,1.305-0.512l4.789,1.598   C8.047,17.387,8,17.688,8,18c0,3.312,2.688,6,6,6c1.648,0,3.145-0.668,4.23-1.746l6.059,4.324C24.117,27.023,24,27.496,24,28   c0,2.207,1.789,4,4,4s4-1.793,4-4S30.211,24,28,24z"/></g></svg>');
				HTP.P('<span>'||FUN.LANG('Categorias')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Grupos De Usu&aacute;rios')||'" data-menu="gusuarios" data-refresh="" data-carrega="gusuarios" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="group_x5F_full"><g><path d="M8,20c0-2,0-10,0-10s0.005-0.45,0.239-1C6.16,9,4,9,4,9s-2,0-2,2v7c0,2,2,2,2,2v10h6v-8C10,22,8,22,8,20z M8,8    c0.52,0,1.001-0.144,1.427-0.376c0.059-0.036,0.125-0.068,0.188-0.103C10.446,6.988,11,6.061,11,5c0-1.657-1.343-3-3-3    S5,3.343,5,5S6.343,8,8,8z M28,9h-4.238C23.995,9.55,24,10,24,10s0,8,0,10s-2,2-2,2v8h6V20c0,0,2,0,2-2s0-7,0-7S30,9,28,9z     M22.38,7.519c0.065,0.035,0.134,0.068,0.194,0.105C23,7.856,23.48,8,24,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3    C21,6.059,21.552,6.985,22.38,7.519z M16,8c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3S14.343,8,16,8z M22,11c0,0,0-2-2-2    c-0.5,0-8,0-8,0s-2,0-2,2v7c0,2,2,2,2,2v10h8V20c0,0,2,0,2-2S22,11,22,11z"/></g></g></svg>');
				HTP.P('<span>'||FUN.LANG('Grupos')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="Logs" data-menu="log" data-refresh="" data-carrega="logs" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M177.317,104.632c0,40.158,32.525,72.685,72.683,72.685  c40.158,0,72.685-32.527,72.685-72.685c0-40.158-32.526-72.683-72.685-72.683C209.842,31.949,177.317,64.474,177.317,104.632z   M177.317,259.086v163.538h-22.715c-12.536,0-22.713,10.175-22.713,22.716c0,12.536,10.177,22.711,22.713,22.711h190.794  c12.537,0,22.717-10.175,22.717-22.711c0-12.541-10.18-22.716-22.717-22.716h-22.711V233.648c0-11.083-8.91-19.991-19.991-19.991  H154.602c-12.536,0-22.713,10.177-22.713,22.713c0,12.538,10.177,22.715,22.713,22.715H177.317z" /></svg>');
			    HTP.P('<span>Logs</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="Lov" data-menu="lov" data-refresh="" data-carrega="list_cdesc" data-attrib="">');
			    HTP.P('<svg contentStyleType="text/css" enable-background="new 0 0 2048 2048" height="2048px" preserveAspectRatio="xMidYMid meet" version="1.1" viewBox="15.0 0 1777.0 2048" width="1777.0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" zoomAndPan="magnify"><path d="M381,1748c0,53.333-18.167,95.333-54.5,126s-81.5,46-135.5,46c-70.667,0-128-22-172-66l57-88c32.667,30,68,45,106,45  c19.333,0,36.167-4.833,50.5-14.5s21.5-23.833,21.5-42.5c0-42.667-35-61.333-105-56l-26-56c5.333-6.667,16.167-21.167,32.5-43.5  s30.5-40.333,42.5-54s24.333-26.5,37-38.5v-1c-10.667,0-26.833,0.333-48.5,1s-37.833,1-48.5,1v53H32v-152h333v88l-95,115  c34,8,61,24.333,81,49S381,1714,381,1748z M383,1121v159H21c-4-24-6-42-6-54c0-34,7.833-65,23.5-93s34.5-50.667,56.5-68  s44-33.167,66-47.5c22-14.333,40.833-28.833,56.5-43.5s23.5-29.667,23.5-45c0-16.667-4.833-29.5-14.5-38.5S203.667,877,187,877  c-30.667,0-57.667,19.333-81,58l-85-59c16-34,39.833-60.5,71.5-79.5S159.333,768,198,768c48.667,0,89.667,13.833,123,41.5  s50,65.167,50,112.5c0,33.333-11.333,63.833-34,91.5c-22.667,27.667-47.667,49.167-75,64.5s-52.5,32.167-75.5,50.5  s-34.833,35.833-35.5,52.5h127v-60H383z M1792,1440v192c0,8.667-3.167,16.167-9.5,22.5s-13.833,9.5-22.5,9.5H544  c-8.667,0-16.167-3.167-22.5-9.5s-9.5-13.833-9.5-22.5v-192c0-9.333,3-17,9-23s13.667-9,23-9h1216c8.667,0,16.167,3.167,22.5,9.5  S1792,1431.333,1792,1440z M384,541v99H49v-99h107c0-27.333,0.167-68,0.5-122s0.5-94.333,0.5-121v-12h-2  c-5.333,11.333-22,29.333-50,54l-71-76l136-127h106v404H384z M1792,928v192c0,8.667-3.167,16.167-9.5,22.5s-13.833,9.5-22.5,9.5H544  c-8.667,0-16.167-3.167-22.5-9.5s-9.5-13.833-9.5-22.5V928c0-9.333,3-17,9-23s13.667-9,23-9h1216c8.667,0,16.167,3.167,22.5,9.5  S1792,919.333,1792,928z M1792,416v192c0,8.667-3.167,16.167-9.5,22.5s-13.833,9.5-22.5,9.5H544c-8.667,0-16.167-3.167-22.5-9.5  S512,616.667,512,608V416c0-8.667,3.167-16.167,9.5-22.5s13.833-9.5,22.5-9.5h1216c8.667,0,16.167,3.167,22.5,9.5  S1792,407.333,1792,416z"/></svg>');
			    HTP.P('<span>Lov</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('M&aacute;scaras')||'" data-menu="mask" data-refresh="" data-carrega="mask" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 500 500" version="1.1" viewBox="0 0 500 500" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M36.992,416.569c0,20.078,16.262,36.344,36.34,36.344h118.111  c20.079,0,36.343-16.266,36.343-36.344V271.202c0-20.079-16.264-36.342-36.343-36.342h-58.328c-10.089,0-18.17-8.177-18.17-18.17  c0-3.271,0.815-5.542,0.815-5.542c13.264-43.977,46.785-79.227,89.762-94.852l0.18-0.182c12.997-5.54,22.083-18.445,22.083-33.437  c0-20.077-16.264-36.341-36.343-36.341c-4.906,0-9.536,0.998-13.804,2.723l-1.644,0.64C94.68,81.405,36.992,160.45,36.992,253.03  V416.569z M273.215,416.569c0,20.078,16.262,36.344,36.341,36.344h118.112c20.078,0,36.34-16.266,36.34-36.344V271.202  c0-20.079-16.262-36.342-36.34-36.342h-58.33c-10.088,0-18.169-8.177-18.169-18.17c0-3.362,0.813-5.542,0.813-5.542  c13.267-43.977,46.787-79.227,89.765-94.852l0.18-0.182c12.995-5.54,22.081-18.445,22.081-33.437  c0-20.077-16.262-36.341-36.34-36.341c-4.906,0-9.538,0.998-13.805,2.723l-1.644,0.64C330.903,81.405,273.215,160.45,273.215,253.03  V416.569z"/></svg>');
			    HTP.P('<span>'||FUN.LANG('M&aacute;scaras')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Objetos')||'" data-menu="objetos" data-refresh="" data-carrega="load_tipos" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M276.353,330.091l26.44,26.44c8.712,8.721,22.791,8.721,31.516,0  c8.729-8.723,8.729-22.814,0-31.526l-26.346-26.44l26.346-26.349c0,0-99.756-42.613-103.845-44.156  c-2.184-0.82-4.455-1.272-6.815-1.272c-10.54,0-19.075,8.45-19.075,18.898c0,2.453,0.45,4.725,1.276,6.814  c1.543,3.905,44.15,104.031,44.15,104.031L276.353,330.091z M31.949,417.582c0,20.079,16.264,36.341,36.34,36.341h363.421  c20.078,0,36.34-16.262,36.34-36.341V81.42c0-20.079-16.262-36.343-36.34-36.343H68.29c-20.077,0-36.34,16.264-36.34,36.343V417.582  z M97.367,172.274h305.267c11.084,0,19.99,8.903,19.99,19.989v196.24c0,11.085-8.906,19.992-19.99,19.992H97.367  c-11.083,0-19.991-8.907-19.991-19.992v-196.24C77.375,181.178,86.284,172.274,97.367,172.274z M77.375,113.219  c0-12.539,10.177-22.713,22.714-22.713c12.538,0,22.713,10.174,22.713,22.713c0,12.536-10.175,22.713-22.713,22.713  C87.553,135.932,77.375,125.755,77.375,113.219z M159.145,113.219c0-12.539,10.177-22.713,22.713-22.713  c12.539,0,22.716,10.174,22.716,22.713c0,12.536-10.177,22.713-22.716,22.713C169.322,135.932,159.145,125.755,159.145,113.219z   M240.914,113.219c0-12.539,10.177-22.713,22.715-22.713c12.537,0,22.712,10.174,22.712,22.713  c0,12.536-10.175,22.713-22.712,22.713C251.091,135.932,240.914,125.755,240.914,113.219z"/></svg>');
			    HTP.P('<span>'||FUN.LANG('Objetos')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Padr&atilde;o de Par&acirc;metros')||'" data-menu="param" data-refresh="" data-carrega="list_vpadrao" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M314.099,250H186.901c-12.536,0-22.713,10.175-22.713,22.715  c0,12.537,10.177,22.712,22.713,22.712h127.198c12.537,0,22.716-10.175,22.716-22.712C336.814,260.175,326.636,250,314.099,250z   M314.099,331.771H186.901c-12.536,0-22.713,10.175-22.713,22.711s10.177,22.716,22.713,22.716h127.198  c12.537,0,22.716-10.18,22.716-22.716S326.636,331.771,314.099,331.771z M73.333,431.711c0,20.078,16.264,36.34,36.343,36.34  h281.648c20.078,0,36.345-16.262,36.345-36.34V122.802c0-20.077-16.267-36.341-36.345-36.341h-74.049  c-6.263-31.071-33.797-54.512-66.774-54.512c-32.98,0-60.512,23.441-66.774,54.512h-74.051c-20.079,0-36.343,16.264-36.343,36.341  V431.711z M138.75,131.889h43.607v16.353c0,11.081,8.909,19.989,19.991,19.989h96.301c11.08,0,19.991-8.909,19.991-19.989v-16.353  h43.607c11.081,0,19.992,8.909,19.992,19.991v250.754c0,11.084-8.911,19.99-19.992,19.99H138.75  c-11.083,0-19.989-8.906-19.989-19.99V151.879C118.761,140.797,127.667,131.889,138.75,131.889z M227.787,100.089  c0-12.537,10.177-22.714,22.713-22.714c12.537,0,22.715,10.177,22.715,22.714c0,12.538-10.178,22.713-22.715,22.713  C237.964,122.802,227.787,112.627,227.787,100.089z"/></svg>');
			    HTP.P('<span>'||FUN.LANG('Padr&otilde;es')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Processos')||'" data-menu="" data-refresh="processos" data-carrega="processos" onclick="carregaPainel('''');" data-attrib="" data-url="prm_completo=S">');
			    HTP.P('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M349.938,127.345c0,12.539,10.18,22.715,22.717,22.715  c12.535,0,22.711-10.177,22.711-22.715c0-12.536-10.176-22.713-22.711-22.713C360.118,104.632,349.938,114.809,349.938,127.345z   M349.938,272.715c0,12.537,10.18,22.712,22.717,22.712c12.535,0,22.711-10.175,22.711-22.712c0-12.54-10.176-22.715-22.711-22.715  C360.118,250,349.938,260.175,349.938,272.715z M31.949,331.771c0,20.074,16.264,36.341,36.34,36.341h154.454v25.072  c-4.453,2.999-8.269,6.815-11.268,11.268H100.089c-12.537,0-22.714,10.179-22.714,22.716c0,12.535,10.177,22.711,22.714,22.711  h111.386c7.355,10.997,19.804,18.172,33.981,18.172c14.18,0,26.616-7.175,33.983-18.172h120.469  c12.54,0,22.715-10.176,22.715-22.711c0-12.537-10.175-22.716-22.715-22.716H279.44c-3-4.452-6.817-8.269-11.269-11.268v-25.072  h163.539c20.078,0,36.34-16.267,36.34-36.341V68.29c0-20.077-16.262-36.34-36.34-36.34H68.29c-20.077,0-36.34,16.264-36.34,36.34  V331.771z M97.367,77.375h305.267c11.084,0,19.99,8.905,19.99,19.991v59.959c0,11.086-8.906,19.991-19.99,19.991H97.367  c-11.083,0-19.991-8.905-19.991-19.991V97.367C77.375,86.28,86.284,77.375,97.367,77.375z M97.367,222.744h305.267  c11.084,0,19.99,8.904,19.99,19.989v59.961c0,11.081-8.906,19.991-19.99,19.991H97.367c-11.083,0-19.991-8.91-19.991-19.991v-59.961  C77.375,231.648,86.284,222.744,97.367,222.744z"/></svg>');
			    HTP.P('<span>'||FUN.LANG('Processos')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Sinalizador')||'" data-menu="sinal" data-refresh="" data-carrega="list_sinal" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M341.864,135.423c0,12.536,10.175,22.713,22.716,22.713  c12.536,0,22.711-10.177,22.711-22.713c0-12.538-10.175-22.715-22.711-22.715C352.039,112.708,341.864,122.885,341.864,135.423z   M183.045,456.5c14.002,14.092,36.716,14.092,50.788,0l222.051-220.592c8.902-8.904,13.354-20.625,13.179-32.346V76.002  c0-24.895-20.179-45.063-45.064-45.063h-127.56c-11.724-0.182-23.441,4.268-32.353,13.176L43.499,266.162  c-14.09,14.076-14.09,36.791,0,50.792L183.045,456.5z M305.524,135.423c0-32.615,26.437-59.056,59.056-59.056  c32.615,0,59.052,26.441,59.052,59.056s-26.437,59.055-59.052,59.055C331.961,194.478,305.524,168.038,305.524,135.423z"/></svg>');
			    HTP.P('<span>'||FUN.LANG('Sinalizador')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Usu&aacute;rios')||'" data-menu="usuarios" data-refresh="" data-carrega="list_users" data-attrib="">');
			    
			    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45.532px" height="45.532px" viewBox="0 0 45.532 45.532" style="enable-background:new 0 0 45.532 45.532;" xml:space="preserve"> <g> <path d="M22.766,0.001C10.194,0.001,0,10.193,0,22.766s10.193,22.765,22.766,22.765c12.574,0,22.766-10.192,22.766-22.765 S35.34,0.001,22.766,0.001z M22.766,6.808c4.16,0,7.531,3.372,7.531,7.53c0,4.159-3.371,7.53-7.531,7.53 c-4.158,0-7.529-3.371-7.529-7.53C15.237,10.18,18.608,6.808,22.766,6.808z M22.761,39.579c-4.149,0-7.949-1.511-10.88-4.012 c-0.714-0.609-1.126-1.502-1.126-2.439c0-4.217,3.413-7.592,7.631-7.592h8.762c4.219,0,7.619,3.375,7.619,7.592 c0,0.938-0.41,1.829-1.125,2.438C30.712,38.068,26.911,39.579,22.761,39.579z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('<span>'||FUN.LANG('Usu&aacute;rios')||'</span>');
			HTP.P('</a></li>');

			HTP.P('<li><a title="'||fun.lang('Vis&otilde;es')||'" data-menu="visoes" data-refresh="" data-carrega="load_tables" data-attrib="">');
			    HTP.P('<svg enable-background="new 0 0 500 500" height="500px" version="1.1" viewBox="0 0 500 500" width="500px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M195.448,250.001c0,30.078,24.434,54.513,54.513,54.513  c30.078,0,54.513-24.435,54.513-54.513v-0.453c-5.819,5.905-13.805,9.539-22.715,9.539c-17.539,0-31.798-14.264-31.798-31.799  c0-12.626,7.443-23.623,18.08-28.712c-5.631-1.997-11.718-3.087-18.08-3.087C219.882,195.488,195.448,219.926,195.448,250.001z   M455.839,219.017c-33.804-42.97-116.113-114.384-205.79-114.384c-89.762,0-172.162,71.415-205.967,114.384  c-7.63,9.814-11.809,20.444-12.083,30.984c0.275,10.541,4.453,21.171,12.083,30.983c33.806,42.979,116.115,114.383,205.879,114.383  s172.074-71.404,205.878-114.383c7.718-9.813,11.898-20.442,12.173-30.983C467.737,239.461,463.557,228.831,455.839,219.017z   M249.961,340.854c-50.147,0-90.855-40.703-90.855-90.853c0-50.151,40.708-90.855,90.855-90.855  c50.146,0,90.854,40.704,90.854,90.855C340.814,300.15,300.106,340.854,249.961,340.854z"/></svg>');
			    HTP.P('<span>'||FUN.LANG('Vis&otilde;es')||'</span>');
			HTP.P('</a></li>');
			
			HTP.P('<li><a title="'||fun.lang('Importar')||'" data-menu="import" data-refresh="" data-carrega="main" data-package="imp" data-attrib="">');
			    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M495.343,45.601H221.818c-9.199,0-16.657,7.458-16.657,16.657V91.18H16.657C7.458,91.18,0,98.638,0,107.837v341.906 c0,9.199,7.458,16.657,16.657,16.657h341.918c9.199,0,16.657-7.458,16.657-16.657V261.25h120.112 c9.199,0,16.657-7.458,16.657-16.657V62.257C512,53.058,504.542,45.601,495.343,45.601z M341.918,433.086H33.313V124.493h171.847 v113.21l-40.56,40.56l-13.646-13.647c-9.057-9.059-24.555-4.896-27.867,7.467l-18.612,69.462 c-3.297,12.295,7.966,23.731,20.4,20.401l69.462-18.612c12.38-3.319,16.515-18.821,7.467-27.868l-13.647-13.647l40.565-40.565 h113.197V433.086z M478.687,227.936H238.48c0-101.027-0.006-146.919-0.006-149.022h240.212V227.936z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			    HTP.P('<span>'||FUN.LANG('Importar')||'</span>');
			HTP.P('</a></li>');

			
			--COMENTADO , POSSÍVEL DESCONTINUÇÃO DO ATRIBUTO - 13/05/22

			--HTP.P('<li><a title="'||fun.lang('Edi&ccedil;&atilde;o de Views')||'" data-menu="editview" data-refresh="" data-carrega="edit_dado" data-attrib="" data-ace="edit-view">');
			  --  HTP.P('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="document_x5F_text_x5F_edit"><path d="M24,14.059V5.584L18.414,0H0v32h24v-0.059c4.499-0.5,7.998-4.309,8-8.941C31.998,18.366,28.499,14.556,24,14.059z    M17.998,2.413L21.586,6h-3.588V2.413z M2,30V1.998h14v6.001h6v6.06c-1.752,0.194-3.352,0.89-4.652,1.941H4v2h11.517   c-0.412,0.616-0.743,1.289-0.994,2H4v2h10.059C14.022,22.329,14,22.661,14,23c0,2.829,1.308,5.351,3.349,7H2z M23,29.883   c-3.801-0.009-6.876-3.084-6.885-6.883c0.009-3.801,3.084-6.876,6.885-6.885c3.799,0.009,6.874,3.084,6.883,6.885   C29.874,26.799,26.799,29.874,23,29.883z M20,12H4v2h16V12z"/><g><polygon points="22,27 19,27 19,24   "/><rect height="4.243" transform="matrix(-0.7071 0.7071 -0.7071 -0.7071 56.5269 20.5858)" width="7.071" x="20.464" y="19.879"/></g></g></svg>');
			    --HTP.P('<span>'||FUN.LANG('Edi&ccedil;&atilde;o')||'</span>');
			--HTP.P('</a></li>');
			

			HTP.P('<li><a title="SQL" data-menu="" data-refresh="" data-carrega="sqlparse" data-attrib="" data-ace="sqlquery">');
			    HTP.P('<svg enable-background="new 0 0 32 32" height="32px" version="1.1" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><g><rect fill="none" height="32" width="32"/></g><g id="database_x5F_run"><path d="M29.998,17.348V4.999c0.027-0.272-0.205-1.715-2.102-2.851C26.012,0.997,22.598,0.004,16.002,0   C9.403,0.004,5.989,0.997,4.103,2.148C2.208,3.283,1.975,4.726,2.002,4.999v22.74c-0.035,0.353,0.305,1.628,2.176,2.525   C6.045,31.19,9.417,31.994,16,32c1.978-0.002,3.66-0.076,5.104-0.204C21.716,31.927,22.349,32,22.999,32   c4.971-0.002,8.999-4.03,9.001-9.001C31.999,20.856,31.248,18.893,29.998,17.348z M16,30c-6.414,0.007-9.541-0.821-10.924-1.524   c-0.694-0.35-0.987-0.648-1.075-0.78c-0.018-0.027,0.009-0.047,0.002-0.062L4,7.783C4.037,7.806,4.065,7.83,4.103,7.852   C5.989,9.001,9.403,9.993,16.002,10c6.596-0.006,10.01-0.999,11.895-2.147C27.934,7.83,27.963,7.805,28,7.783v7.735   C26.569,14.561,24.85,14,22.999,14c-4.972,0.002-8.998,4.027-9,8.999c0.001,2.822,1.301,5.338,3.333,6.988   C16.902,29.995,16.465,30.001,16,30z M22.999,29.998c-3.865-0.006-6.992-3.133-7-6.999c0.008-3.865,3.135-6.991,7-7   c3.866,0.009,6.993,3.135,6.999,7C29.992,26.865,26.865,29.992,22.999,29.998z"/><polygon points="22,19 22,27 26,23  "/></g></svg>');
				HTP.P('<span>Sql</span>');
			HTP.P('</a></li>');

			SELECT INSTR(UPPER(BANNER), 'EXPRESS') INTO WS_COUNT FROM V$VERSION WHERE ROWNUM = 1;

            IF WS_COUNT = 0 THEN
				HTP.P('<li><a title="EMAIL" data-menu="report" data-refresh="" data-carrega="report" data-package="com" data-attrib="" data-ace="">');
					HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M467,80.609H45c-24.813,0-45,20.187-45,45v260.782c0,24.813,20.187,45,45,45h422c24.813,0,45-20.187,45-45V125.609 C512,100.796,491.813,80.609,467,80.609z M461.127,110.609l-6.006,5.001L273.854,266.551c-10.346,8.614-25.364,8.614-35.708,0 L56.879,115.61l-6.006-5.001H461.127z M30,132.267L177.692,255.25L30,353.543V132.267z M467,401.391H45 c-7.248,0-13.31-5.168-14.699-12.011l171.445-114.101l17.204,14.326c10.734,8.938,23.893,13.407,37.051,13.407 c13.158,0,26.316-4.469,37.051-13.407l17.204-14.326l171.444,114.1C480.31,396.224,474.248,401.391,467,401.391z M482,353.543 l-147.692-98.292L482,132.267V353.543z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					HTP.P('<span>Email</span>');
				HTP.P('</a></li>');
			END IF;

			IF INSTR(UPD.VALIDAR(FUN.RET_VAR('CLIENTE')), 'S') > 0 THEN

				HTP.P('<li><a title="UPDATE" data-menu="" data-refresh="" data-carrega="auto_update" data-attrib="" data-ace="">');
					HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <polygon points="371.425,135.5 371.425,60 141.425,60 141.425,135.5 60.212,135.5 256.425,331.713 452.639,135.5 		"/> </g> </g> <g> <g> <rect x="141.43" width="230" height="30"/> </g> </g> <g> <g> <rect x="319.78" y="392" width="112.65" height="120"/> </g> </g> <g> <g> <polygon points="154.286,302 1.212,302 61.212,362 214.286,362 		"/> </g> </g> <g> <g> <rect x="82.42" y="392" width="207.35" height="120"/> </g> </g> <g> <g> <polygon points="358.565,302 298.565,362 452.788,362 510.788,302 		"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					HTP.P('<span>Update</span>');
				HTP.P('</a></li>');
				
			END IF;

            























		HTP.P('</ul>');
		HTP.P('</div>'); 

	END IF;

	IF WS_SHOW_ONLY <> 'S' THEN

	HTP.P('<div id="pushsyncbg"><img id="pushsync" src="'||FUN.R_GIF('sinchronize','png')||'" /></div>');

	HTP.P('<div id="menup">');

	    IF NVL(PRM_SCREEN, 'N/A') = 'N/A' THEN
	
	        HTP.P('<a id="upquery" title="'||FUN.LANG('UpQuery')||'" onclick="closeSideBar(''popupmenu''); popupmenu(''screengroup'', '''');"><img src="'||FUN.R_GIF('ipad', 'PNG' )||'" /></a>');
            
		END IF;

		HTP.P('<div id="popupmenu"></div>');
		
		



		BEGIN
			SELECT CONTEUDO INTO WS_PADRAO
			FROM   PARAMETRO_USUARIO
			WHERE  CD_USUARIO = WS_USUARIO AND
				CD_PADRAO='CD_LINGUAGEM';
		EXCEPTION
			WHEN OTHERS THEN
				WS_PADRAO := 'PORTUGUESE';
		END;

		HTP.P('<a id="screens"><select id="floatops" onchange="changeScreen();">');
		    HTP.P('<option value="X" style="font-weight: bold; color: #000;" selected>MENU</option>');
		    OPEN CRS_ITENS(WS_USUARIO, WS_ADMIN);
		    LOOP
		        FETCH CRS_ITENS INTO WS_ITENS;
		        EXIT WHEN CRS_ITENS%NOTFOUND;
				IF ((INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') > 0 OR INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') > 0) AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'desktop' AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'nenhum') OR ((INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') = 0 AND INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') = 0) AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'mobile' AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'nenhum') OR WS_ADMIN = 'A' THEN
					IF  (WS_GRUPO_ANT <> WS_ITENS.CD_GRUPO OR WS_GRUPO_ANT='FIRST_TIME') THEN
						WS_CGRUPO := WS_CGRUPO + 1;
					    WS_CITEM  := 1;
					IF WS_ADMIN = 'A' THEN
						HTP.P('<optgroup label="'||WS_CGRUPO||'-'||FUN.UTRANSLATE('NM_GRUPO', 'GRUPOS_FUNCAO', WS_ITENS.NM_GRUPO, WS_PADRAO)||'"></optgroup>');
					ELSE
						HTP.P('<optgroup label="'||FUN.UTRANSLATE('NM_GRUPO', 'GRUPOS_FUNCAO', WS_ITENS.NM_GRUPO, WS_PADRAO)||'"></optgroup>');
					END IF;
					END IF;

					IF WS_ADMIN = 'A' THEN
						HTP.P('<option data-bg="'||WS_ITENS.COR_FUNDO||'" data-url="'||WS_ITENS.URL_FUNDO||'" data-size="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_SIZE')||'" data-pos="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_POS')||'" data-repeat="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'REPEAT')||'" value="'||WS_ITENS.CD_OBJETO||'">    '||WS_CGRUPO||'.'||TO_CHAR(WS_CITEM,'00')||'-'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', WS_ITENS.CD_OBJETO, WS_ITENS.NM_OBJETO, WS_PADRAO), WS_ITENS.CD_OBJETO)||'</option>');
					ELSE
						HTP.P('<option data-bg="'||WS_ITENS.COR_FUNDO||'" data-url="'||WS_ITENS.URL_FUNDO||'" data-size="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_SIZE')||'" data-pos="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_POS')||'" data-repeat="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'REPEAT')||'" value="'||WS_ITENS.CD_OBJETO||'"> - '||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', WS_ITENS.CD_OBJETO, WS_ITENS.NM_OBJETO, WS_PADRAO), WS_ITENS.CD_OBJETO)||'</option>');
					END IF;
				END IF;
				WS_CITEM := WS_CITEM + 1;
				WS_COUNT := WS_COUNT + 1;
		        WS_GRUPO_ANT := WS_ITENS.CD_GRUPO;
		    END LOOP;
		    CLOSE CRS_ITENS;
		    


		HTP.P('</select></a>');

	    HTP.P('<a id="float-filter" class="invisible" title="'||FUN.LANG('Filtros de usu&aacute;rio')||'"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"width="56.805px" height="56.805px" viewBox="0 0 56.805 56.805" style="enable-background:new 0 0 56.805 56.805;"xml:space="preserve"> <g> <g id="_x32_7"> <g> <path d="M56.582,4.352c-0.452-1.092-1.505-1.796-2.685-1.796H2.908c-1.18,0-2.233,0.704-2.685,1.796 c-0.451,1.091-0.204,2.336,0.63,3.171l20.177,20.21V53.02c0,0.681,0.55,1.229,1.229,1.229c0.68,0,1.229-0.549,1.229-1.229V27.223 c0-0.327-0.13-0.64-0.36-0.87L2.591,5.782c-0.184-0.185-0.14-0.385-0.098-0.487C2.537,5.19,2.646,5.019,2.908,5.019h50.99 c0.26,0,0.37,0.173,0.414,0.276c0.042,0.103,0.086,0.303-0.099,0.487L33.679,26.353c-0.23,0.23-0.36,0.543-0.36,0.87v18.412 c0,0.681,0.55,1.229,1.229,1.229c0.681,0,1.229-0.55,1.229-1.229V27.732l20.177-20.21C56.785,6.688,57.033,5.443,56.582,4.352z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');

	    
        HTP.P('<a id="call-menu" class="invisible" title="'||FUN.LANG('Menu')||'"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 24 24" enable-background="new 0 0 24 24" width="512px" height="512px"> <g> <path d="M24,3c0-0.6-0.4-1-1-1H1C0.4,2,0,2.4,0,3v2c0,0.6,0.4,1,1,1h22c0.6,0,1-0.4,1-1V3z" fill="#FFFFFF"/> <path d="M24,11c0-0.6-0.4-1-1-1H1c-0.6,0-1,0.4-1,1v2c0,0.6,0.4,1,1,1h22c0.6,0,1-0.4,1-1V11z" fill="#FFFFFF"/> <path d="M24,19c0-0.6-0.4-1-1-1H1c-0.6,0-1,0.4-1,1v2c0,0.6,0.4,1,1,1h22c0.6,0,1-0.4,1-1V19z" fill="#FFFFFF"/> </g> </svg></a>');

        HTP.P('<a id="favoritos" class="invisible" title="'||FUN.LANG('Favoritos')||'"><svg style="height: 26px; width: 26px; margin: 4px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="613.408px" height="613.408px" viewBox="0 0 613.408 613.408" style="enable-background:new 0 0 613.408 613.408;" 	 xml:space="preserve"> <g> 	<path d="M605.254,168.94L443.792,7.457c-6.924-6.882-17.102-9.239-26.319-6.069c-9.177,3.128-15.809,11.241-17.019,20.855 		l-9.093,70.512L267.585,216.428h-142.65c-10.344,0-19.625,6.215-23.629,15.746c-3.92,9.573-1.71,20.522,5.589,27.779 		l105.424,105.403L0.699,613.408l246.635-212.869l105.423,105.402c4.881,4.881,11.45,7.467,17.999,7.467 		c3.295,0,6.632-0.709,9.78-2.002c9.573-3.922,15.726-13.244,15.726-23.504V345.168l123.839-123.714l70.429-9.176 		c9.614-1.251,17.727-7.862,20.813-17.039C614.472,186.021,612.136,175.801,605.254,168.94z M504.856,171.985 		c-5.568,0.751-10.762,3.232-14.745,7.237L352.758,316.596c-4.796,4.775-7.466,11.242-7.466,18.041v91.742L186.437,267.481h91.68 		c6.757,0,13.243-2.669,18.04-7.466L433.51,122.766c3.983-3.983,6.569-9.176,7.258-14.786l3.629-27.696l88.155,88.114 		L504.856,171.985z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');

        HTP.P('<a id="eraser" class="visible" title="'||FUN.LANG('Limpar drills')||'" onclick="var drills = document.querySelectorAll(''.drill''); for(i=0;i<drills.length;i++){ drills[i].remove();  }">');
		    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"width="360px" height="360px" viewBox="0 0 360 360" style="enable-background:new 0 0 360 360;" xml:space="preserve"> <g> <g> <path d="M348.994,102.946L250.04,3.993c-5.323-5.323-13.954-5.324-19.277,0l-153.7,153.701l118.23,118.23l153.701-153.7 C354.317,116.902,354.317,108.271,348.994,102.946z"/> <path d="M52.646,182.11l-41.64,41.64c-5.324,5.322-5.324,13.953,0,19.275l98.954,98.957c5.323,5.322,13.954,5.32,19.277,0 l41.639-41.641L52.646,182.11z"/> <polygon points="150.133,360 341.767,360 341.767,331.949 182.806,331.949 		"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		HTP.P('</a>');
        
		
		
		SELECT COUNT(*) INTO WS_COUNT FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO;
		IF WS_COUNT > 0 THEN
            HTP.P('<a id="custom" class="visible" title="'||FUN.LANG('Gerar consulta')||'" data-menu="gerar" data-refresh="" data-carrega="conteudoCustomizado" data-attrib=""><svg style="margin: 2px 2px 2px 5px; height: 30px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M497.079 254.87c-8.128-8.117-18.339-12.904-28.925-14.374l-.002-179.133c0-9.864-7.997-17.86-17.86-17.86H17.861c-9.863 0-17.86 7.997-17.86 17.86v129.73l-.001.035v259.511c0 9.863 7.997 17.86 17.86 17.86h432.434c9.863 0 17.86-7.997 17.86-17.86V355.77l28.933-28.933c19.908-19.909 19.864-52.133-.008-71.967zM35.721 79.222H432.43v94.04H35.721v-94.04zm396.713 129.765v39.814c-5.179 3.537-2.881 1.641-55.467 54.228h-125.03v-94.041h180.497zM216.217 432.778H35.72v-94.029h180.497v94.029zm0-129.751H35.72v-94.04h180.497v94.04zm75.029 90.728l-5.689 39.023h-33.621v-94.029h89.31l-44.955 44.955a17.847 17.847 0 00-5.045 10.051zm141.188 39.023h-41.289l41.289-41.289v41.289zm-85.241-6.563l-25.115 3.664 3.66-25.108 86.732-86.732 21.449 21.449-86.726 86.727zm124.636-124.637l-12.653 12.653-21.449-21.449 12.647-12.647c5.894-5.894 15.544-5.904 21.467.012 5.876 5.866 5.94 15.479-.012 21.431z"/></svg></a>');
        END IF;

	




		HTP.P('<input type="hidden" id="tmpp" value="aba0" />');
		HTP.P('<input type="hidden" id="cort" value="" />');
		HTP.P('<input type="hidden" id="grupof" value="" />');

	    HTP.P('<div id="tela-atual">');
	    HTP.P('</div>');

	






	

		HTP.P('<a title="Entrada de Parametros" onclick="carregaPainel(''''); titulo(this, ''n''); curtain(''enabled''); savepar(); carrega('||CHR(39)||'get_par'||CHR(39)||'); ">');
		
		
		IF NVL(PRM_SCREEN, 'N/A') = 'N/A' THEN 
			HTP.P('<a id="verify-post" data-ajax="'||FUN.INIT_TEXT_POST||'" title="'||FUN.LANG('verificar mensagens')||'" onclick="closeSideBar(''text-talk''); openText();">');
				HTP.P('<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512.001 512.001" style="enable-background:new 0 0 512.001 512.001;" xml:space="preserve"> <g> <g> <g> <path d="M468.53,306.575c-4.14-10.239-15.798-15.188-26.038-11.046c-10.241,4.14-15.187,15.797-11.047,26.038L455,379.833 l-69.958-30.839c-5.064-2.232-10.827-2.267-15.917-0.095c-23.908,10.201-49.52,15.373-76.124,15.373 c-107.073,0-179-83.835-179-162.136c0-89.402,80.299-162.136,179-162.136s179,72.734,179,162.136 c0,6.975-0.65,15.327-1.781,22.913c-1.63,10.925,5.905,21.102,16.83,22.732c10.926,1.634,21.103-5.905,22.732-16.83 c1.431-9.59,2.219-19.824,2.219-28.815c0-54.33-23.006-105.308-64.783-143.543C405.936,20.809,351.167,0,293.001,0 S180.067,20.809,138.784,58.592c-37.332,34.168-59.66,78.516-63.991,126.335C27.836,216.023,0.001,265.852,0.001,319.525 c0,33.528,10.563,65.34,30.67,92.717L1.459,484.504c-3.051,7.546-1.224,16.189,4.621,21.855 c3.809,3.694,8.828,5.642,13.925,5.642c2.723-0.001,5.469-0.556,8.063-1.7l84.229-37.13c21.188,7.887,43.585,11.88,66.703,11.88 c0.5,0,0.991-0.039,1.482-0.075c33.437-0.253,65.944-9.048,94.098-25.507c25.218-14.744,45.962-34.998,60.505-58.917 c14.199-2.55,28.077-6.402,41.547-11.551l107.301,47.3c2.595,1.143,5.34,1.7,8.063,1.7c5.097-0.001,10.117-1.949,13.926-5.642 c5.845-5.666,7.672-14.308,4.621-21.855L468.53,306.575z M179.002,445c-0.273,0-0.539,0.03-0.81,0.041 c-20.422-0.104-40.078-4.118-58.435-11.95c-5.089-2.173-10.852-2.138-15.916,0.095l-46.837,20.646l15.109-37.375 c2.793-6.909,1.512-14.799-3.322-20.47c-18.835-22.097-28.79-48.536-28.79-76.462c0-31.961,13.445-62.244,36.969-85.206 c7.324,39.925,27.989,78.117,59.162,108.119c38.791,37.333,90.101,58.961,145.506,61.565 C255.626,429.608,218.402,445,179.002,445z"/> <circle cx="292.001" cy="203" r="20"/> <circle cx="372.001" cy="203" r="20"/> <circle cx="212.001" cy="203" r="20"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			HTP.P('</a>'); 
        END IF;

		
		
		HTP.P('<a class="info" onclick="closeSideBar(''perfil''); document.getElementById(''perfil'').classList.toggle(''open'');" title="'||WS_USUARIO||'">'||WS_USUARIO||'</a>');

		HTP.P('<a id="config" title="'||FUN.LANG('Configura&ccedil;&atilde;o')||'">');
			HTP.P('<svg style="height: 20px; width: 20px; margin: 8px;" enable-background="new 0 0 24 24" height="24px" version="1.1" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path clip-rule="evenodd" d="M21.521,10.146c-0.41-0.059-0.846-0.428-0.973-0.82l-0.609-1.481  c-0.191-0.365-0.146-0.935,0.1-1.264l0.99-1.318c0.246-0.33,0.227-0.854-0.047-1.162l-1.084-1.086  c-0.309-0.272-0.832-0.293-1.164-0.045l-1.316,0.988c-0.33,0.248-0.898,0.293-1.264,0.101l-1.48-0.609  c-0.395-0.126-0.764-0.562-0.82-0.971l-0.234-1.629c-0.057-0.409-0.441-0.778-0.85-0.822c0,0-0.255-0.026-0.77-0.026  c-0.514,0-0.769,0.026-0.769,0.026c-0.41,0.044-0.794,0.413-0.852,0.822l-0.233,1.629c-0.058,0.409-0.427,0.845-0.82,0.971  l-1.48,0.609C7.48,4.25,6.912,4.206,6.582,3.958L5.264,2.969c-0.33-0.248-0.854-0.228-1.163,0.045L3.017,4.1  C2.745,4.409,2.723,4.932,2.971,5.262l0.988,1.318C4.208,6.91,4.252,7.479,4.061,7.844L3.45,9.326  c-0.125,0.393-0.562,0.762-0.971,0.82L0.85,10.377c-0.408,0.059-0.777,0.442-0.82,0.853c0,0-0.027,0.255-0.027,0.77  s0.027,0.77,0.027,0.77c0.043,0.411,0.412,0.793,0.82,0.852l1.629,0.232c0.408,0.059,0.846,0.428,0.971,0.82l0.611,1.48  c0.191,0.365,0.146,0.936-0.102,1.264l-0.988,1.318c-0.248,0.33-0.308,0.779-0.132,0.994c0.175,0.217,0.677,0.752,0.678,0.754  s0.171,0.156,0.375,0.344s1.042,0.449,1.372,0.203l1.317-0.99c0.33-0.246,0.898-0.293,1.264-0.1l1.48,0.609  c0.394,0.125,0.763,0.562,0.82,0.971l0.233,1.629c0.058,0.408,0.441,0.779,0.852,0.822c0,0,0.255,0.027,0.769,0.027  c0.515,0,0.77-0.027,0.77-0.027c0.409-0.043,0.793-0.414,0.85-0.822l0.234-1.629c0.057-0.408,0.426-0.846,0.82-0.971l1.48-0.611  c0.365-0.191,0.934-0.146,1.264,0.102l1.318,0.99c0.332,0.246,0.854,0.227,1.164-0.047l1.082-1.084  c0.273-0.311,0.293-0.834,0.047-1.164l-0.99-1.318c-0.246-0.328-0.291-0.898-0.1-1.264l0.609-1.48  c0.127-0.393,0.562-0.762,0.973-0.82l1.627-0.232c0.41-0.059,0.779-0.441,0.822-0.852c0,0,0.027-0.255,0.027-0.77  s-0.027-0.77-0.027-0.77c-0.043-0.41-0.412-0.794-0.822-0.853L21.521,10.146z M12,15C10.343,15,9,13.656,9,12  C9,10.343,10.343,9,12,9c1.657,0,3,1.344,3,3C15,13.656,13.656,15,12,15z" fill-rule="evenodd"/></svg>');
		HTP.P('</a>');

        




        




		
		IF WS_ADMIN = 'A' THEN
		
			HTP.P('<a title="'||FUN.LANG('Configura&ccedil;&otilde;es')||'" onclick="closeSideBar(''prefdrop''); document.getElementById(''prefdrop'').classList.toggle(''hover'');">');
	            HTP.P('<svg style="height: 25px; width: 25px; margin: 5px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"/> <circle cx="256" cy="448" r="64"/> <circle cx="256" cy="64" r="64"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			HTP.P('</a>');
			
	    END IF;

		HTP.P('<a class="logout" title="Logoff" onclick="var loc = window.location.toString(); loc = loc.replace(loc.split(''.com'').pop(), ''''); if(confirm(TR_SS)){ call(''xlogout'', '''').then(function(){ alerta(''feed-fixo'', TR_SE); setTimeout(function(){ window.location.reload(true); }, 1000); }); }">');
			HTP.P('<svg style="height: 25px; width: 25px; margin: 5px;" enable-background="new 0 0 141.732 141.732" height="141.732px" version="1.1" viewBox="0 0 141.732 141.732" width="141.732px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Livello_34"><path d="M108.527,66.186l-42.209-42.21c-2.498-2.494-6.547-2.494-9.046,0c-2.495,2.498-2.495,6.547,0,9.045L88.996,64.74H6.365   c-3.532,0-6.398,2.869-6.398,6.398c0,3.53,2.867,6.396,6.398,6.396h82.629L57.7,108.829c-2.495,2.493-2.495,6.548,0,9.041   c2.499,2.498,6.55,2.498,9.046,0l42.208-42.21c0.149-0.147,0.291-0.305,0.425-0.468c0.064-0.071,0.11-0.147,0.169-0.229   c0.067-0.091,0.145-0.181,0.203-0.277c0.06-0.093,0.111-0.185,0.169-0.275c0.051-0.087,0.104-0.169,0.151-0.26   c0.05-0.095,0.094-0.192,0.139-0.289c0.045-0.093,0.091-0.184,0.13-0.277c0.039-0.095,0.068-0.191,0.104-0.283   c0.038-0.106,0.076-0.201,0.107-0.304c0.025-0.102,0.049-0.194,0.073-0.291c0.025-0.106,0.058-0.21,0.075-0.318   c0.021-0.108,0.035-0.225,0.054-0.339c0.015-0.094,0.03-0.186,0.041-0.276c0.041-0.42,0.041-0.842,0-1.261   c-0.011-0.096-0.026-0.188-0.041-0.278c-0.019-0.113-0.029-0.229-0.054-0.337c-0.021-0.108-0.05-0.212-0.075-0.319   c-0.024-0.097-0.048-0.191-0.073-0.291c-0.031-0.102-0.069-0.199-0.107-0.304c-0.029-0.095-0.062-0.191-0.104-0.286   c-0.04-0.095-0.085-0.186-0.13-0.277c-0.045-0.098-0.089-0.196-0.139-0.291c-0.051-0.089-0.105-0.172-0.151-0.258   c-0.058-0.094-0.109-0.187-0.169-0.278c-0.062-0.095-0.136-0.184-0.203-0.275c-0.059-0.077-0.104-0.154-0.169-0.228   c-0.197-0.243-0.423-0.466-0.657-0.678C108.659,66.333,108.595,66.257,108.527,66.186 M141.732,141.846V-0.001H65.353v10.912   h65.469v120.024H65.353v10.907h76.379V141.846z"/></g><g /></svg>');
		HTP.P('</a>');

	HTP.P('</div>');

	



	ELSE
	    HTP.P('<div id="show_only_screen" onclick="return false;">');
		    
		    HTP.P('<div id="show_only_bar"></div>');
		    
		    HTP.P('<div id="show_comandos">');
		        
		        HTP.P('<span class="backward">');
		            HTP.P('<?xml version="1.0" encoding="iso-8859-1"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 57 57" style="enable-background:new 0 0 57 57;" xml:space="preserve"> <path d="M56.461,8.625c-0.333-0.172-0.73-0.145-1.036,0.069L29,27.277V9.5c0-0.373-0.208-0.716-0.539-0.888 c-0.333-0.172-0.731-0.146-1.036,0.07l-27,19C0.158,27.869,0,28.175,0,28.5s0.158,0.631,0.425,0.817l27,19 C27.597,48.439,27.798,48.5,28,48.5c0.157,0,0.315-0.037,0.461-0.112C28.792,48.216,29,47.873,29,47.5V29.723l26.425,18.583 c0.172,0.12,0.373,0.182,0.575,0.182c0.157,0,0.315-0.037,0.461-0.112C56.792,48.203,57,47.86,57,47.487V9.513 C57,9.14,56.792,8.797,56.461,8.625z"/> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		        HTP.P('</span>');
		        
		        HTP.P('<span class="pause">');
		            HTP.P('<?xml version="1.0" encoding="iso-8859-1"?><svg style="height: 38px; margin-top: 2px;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 232.679 232.679" style="enable-background:new 0 0 232.679 232.679;" xml:space="preserve"> <g id="Pause"> <path style="fill-rule:evenodd;clip-rule:evenodd;" d="M80.543,0H35.797c-9.885,0-17.898,8.014-17.898,17.898v196.883 c0,9.885,8.013,17.898,17.898,17.898h44.746c9.885,0,17.898-8.013,17.898-17.898V17.898C98.44,8.014,90.427,0,80.543,0z M196.882,0 h-44.746c-9.886,0-17.899,8.014-17.899,17.898v196.883c0,9.885,8.013,17.898,17.899,17.898h44.746 c9.885,0,17.898-8.013,17.898-17.898V17.898C214.781,8.014,206.767,0,196.882,0z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		        HTP.P('</span>');
		        
		        


		        
		        HTP.P('<span class="forward">');
		            HTP.P('<?xml version="1.0" encoding="iso-8859-1"?><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 57 57" style="enable-background:new 0 0 57 57;" xml:space="preserve"> <path d="M56.575,27.683l-27-19c-0.306-0.216-0.703-0.242-1.036-0.07C28.208,8.784,28,9.127,28,9.5v17.777L1.575,8.694 C1.27,8.481,0.872,8.453,0.539,8.625C0.208,8.797,0,9.14,0,9.513v37.975c0,0.373,0.208,0.716,0.539,0.888 C0.685,48.45,0.843,48.487,1,48.487c0.202,0,0.403-0.062,0.575-0.182L28,29.723V47.5c0,0.373,0.208,0.716,0.539,0.888 C28.685,48.463,28.843,48.5,29,48.5c0.202,0,0.404-0.062,0.575-0.183l27-19C56.842,29.131,57,28.825,57,28.5 S56.842,27.869,56.575,27.683z"/> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		        HTP.P('</span>');
		        
		    HTP.P('</div>');
		    
		HTP.P('</div>');

	    HTP.P('<div style="display: none !important;" class="info">'||WS_USUARIO||'</div>');
	    HTP.P('<input type="hidden" id="floatops"/>');
		HTP.P('<input type="hidden" id="space"/>');
		HTP.P('<style>a#float-icon, a#float-icon-filter, span.closed, a.turn { display: none !important; } body { background: transparent !important; } html {  } </style>');

	    



	END IF;


	    HTP.P('<div id="telasup" data-visao="" data-objeto="">');
	
	    HTP.P('<ul id="abas">');
		    
		HTP.P('</ul>');

		HTP.P('<h1 id="titulo"></h1>');
        HTP.P('<h4 id="info" style="font-size: 10px;"></h4>');
		HTP.P('<div id="scroll">');
		    HTP.P('<div id="painel"></div>');
			HTP.P('<div id="content"></div>');
			HTP.P('<a id="fechar_sup" data-reloads="false" data-reloado="false" title="'||FUN.LANG('FECHAR')||'">');
			    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="612px" height="612px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;width: 18px;height: 18px;" xml:space="preserve"> <g> 	<g id="cross"> 		<g> 			<polygon points="612,36.004 576.521,0.603 306,270.608 35.478,0.603 0,36.004 270.522,306.011 0,575.997 35.478,611.397 				306,341.411 576.521,611.397 612,575.997 341.459,306.011 			"></polygon> 		</g> 	</g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
			HTP.P('</a>');
			HTP.P('<a id="salvar" title="'||FUN.LANG('Salvar')||'" onclick=" document.getElementById(''fakelist'').setAttribute(''class'', ''''); var iframe = document.getElementById(''content'').getElementsByTagName(''form''); var enviar = iframe[0]; var user = document.getElementById(''form-ajax''); if(user){ var nome = user.childNodes[1].childNodes[1].value; var completo = user.childNodes[3].childNodes[1].value; var status = user.childNodes[5].childNodes[1].value; var email = user.childNodes[7].childNodes[1].value; if(user.childNodes[9]){ var senha = user.childNodes[9].childNodes[1].value; } else { var senha = ''''; } ajax(''main'', ''save_user'', ''usu_nome_n=''+nome+''&usu_completo_n=''+completo+''&status_n=''+status+''&usu_email_n=''+email+''&usu_senha=''+senha+''&prm_permissao=none'', ''true'', ''ajax''); carrega(''list_users''); } else { if(enviar){ enviar.submit(); alerta(''msg'','''');  } else { alerta(''msg'','''||FUN.LANG('op&ccedil;&atilde;o salvar indispon&iacute;vel')||'!''); } } if(document.getElementById(''list_coluna'')){ alerta(''msg'', '''||FUN.LANG('Altera&ccedil;&atilde;o salva com sucesso')||'!''); } else { call_save(''''); } ">');
				HTP.P('<img alt="'||FUN.LANG('salvar')||'" src="'||FUN.R_GIF('disquete','gif')||'" />');
			HTP.P('</a>');
		HTP.P('</div>');
		HTP.P('<span id="progress-bar"></span>');
		HTP.P('<small id="msg"></small>');
	HTP.P('</div>');
	HTP.P('<div id="fakelist" data-campo="" onclick="if((event.offsetX < 300 && event.offsetX > 275) || (window.innerWidth < 500 && window.matchMedia(''(orientation: portrait)'').matches && event.offsetX < 221 && event.offsetX > 193)){ this.className=''''; /*document.querySelector(''.itens'').innerHTML = '''';*/  }" onmouseleave="" onblur="">');
	    FCL.CLOSER_MENU;
	HTP.P('</div>');
	HTP.P('<div id="attriblist" class="vertical" onclick="attribList('''||WS_ITENS.CD_OBJETO||''');">');
	HTP.P('</div>');
	HTP.P('<div id="floatlist" class="horizontal"></div>');
	
END FLOAT_MENU;

PROCEDURE CLOSER_MENU AS

BEGIN
    
	HTP.P('<span class="closer">');
	    HTP.P('<svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.0031 12.223L0.267578 6.49724L6.0031 0.771484L7.34139 2.10749L2.94416 6.49724L7.34139 10.887L6.0031 12.223Z" fill="#191147"/></svg>');
	HTP.P('</span>');
	
END CLOSER_MENU;


PROCEDURE CALL_LIST( PRM_CALL VARCHAR2 DEFAULT NULL,
		             PRM_POSICAO VARCHAR2 DEFAULT NULL,
			         PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_ITENS IS
		SELECT	CLL.CD_OBJETO,
			OBJ.NM_OBJETO    AS NM_OBJETO,
			OBJ.TP_OBJETO    AS TP_OBJETO,
			OBJ.ATRIBUTOS    AS ATTRIB,
			CALLNAME.NM_ITEM AS NM_ITEM
		FROM	CALL_LIST CLL
		LEFT JOIN
		OBJETOS OBJ ON OBJ.CD_OBJETO = CLL.CD_OBJETO
		LEFT JOIN
		CALL_NAME CALLNAME ON CALLNAME.CD_OBJETO = CLL.CD_OBJETO AND CALLNAME.SCREEN = TRIM(PRM_SCREEN)
		WHERE	CLL.CD_LIST = PRM_CALL AND (
			( 
				CLL.CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = USER AND ST_RESTRICAO = 'I' ) AND
			    CLL.CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = 'DWU' AND ST_RESTRICAO = 'X' )
			)
			OR
			( 
				CLL.CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = USER AND ST_RESTRICAO = 'I' ) AND
			    CLL.CD_OBJETO IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = 'DWU' AND ST_RESTRICAO = 'X' ) AND
				CLL.CD_OBJETO IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = USER AND ST_RESTRICAO = 'L' )
			)

		) AND CLL.CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJETOS OBJ WHERE OBJ.TP_OBJETO='SCRIPT' ) AND
		CLL.CD_OBJETO IN (SELECT CD_OBJETO FROM OBJETOS) AND
        ( OBJ.CD_USUARIO = USER OR OBJ.CD_USUARIO = 'DWU' OR USER = 'DWU' /*or cd_usuario=gbl.getUsuario*/)
		ORDER BY CLL.ORDEM, OBJ.NM_OBJETO;

	WS_ITENS	CRS_ITENS%ROWTYPE;

	CURSOR CRS_SCRIPTS IS
		SELECT	CD_OBJETO,
			(SELECT NM_OBJETO FROM OBJETOS OBJ WHERE OBJ.CD_OBJETO = REPLACE(CLLS.CD_OBJETO, '[SCRIPT]', '')) AS NM_OBJETO,
			(SELECT NM_ITEM FROM CALL_NAME NAME WHERE NAME.CD_OBJETO = REPLACE(CLLS.CD_OBJETO, '[SCRIPT]', '') AND NAME.SCREEN=TRIM(PRM_SCREEN)) AS NM_ITEM
		FROM	CALL_LIST CLLS
		WHERE	CD_LIST=PRM_CALL AND
		        (
		( CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = USER AND ST_RESTRICAO = 'I' ) AND
		CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = 'DWU' AND ST_RESTRICAO = 'X' )

		)
		OR
  		( CD_OBJETO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = USER AND ST_RESTRICAO = 'I' ) AND
		 CD_OBJETO IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = 'DWU' AND ST_RESTRICAO = 'X' ) AND
				  CD_OBJETO IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = USER AND ST_RESTRICAO = 'L' )
		)

		) AND CD_OBJETO IN ( SELECT CD_OBJETO FROM OBJETOS OBJ WHERE OBJ.TP_OBJETO='SCRIPT' )
		ORDER BY ORDEM ASC;

	WS_SCRIPT	CRS_SCRIPTS%ROWTYPE;

	WS_TITULO	VARCHAR2(400);
	WS_TIPO     VARCHAR2(40);
    
	WS_URL      VARCHAR2(60)  := '';
	WS_ALT      VARCHAR2(60)  := '';
	WS_ATT      VARCHAR2(200) := '';
	WS_PADRAO   VARCHAR2(80)  := 'PORTUGUESE';
	WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(20);

BEGIN
	SELECT NM_OBJETO INTO WS_TITULO
	FROM OBJETOS
	WHERE CD_OBJETO=PRM_CALL AND TP_OBJETO='CALL_LIST';

	WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
	
	IF WS_ADMIN = 'A' THEN
	    WS_URL := 'dwu.fcl.download?arquivo=';
		HTP.P('<span title="'||FUN.LANG('Op&ccedil;&otilde;es')||'" class="options closed" id="'||RTRIM(PRM_CALL)||'more">');
	   		HTP.P('<span class="preferencias" title="'||FUN.LANG('Propriedades')||'"></span>');
			HTP.P('<span class="lightbulb" title="'||FUN.LANG('Lista do Menu')||'"></span>');
			
			
			FCL.BUTTON_LIXO('dl_obj', PRM_OBJETO=> PRM_CALL);
			
		HTP.P('</span>');
		
		
	    HTP.P('<h2>'||FUN.UTRANSLATE('NM_OBJETO', PRM_CALL, WS_TITULO, WS_PADRAO)||'</h2>');
	ELSE
	    WS_URL := 'dwu.fcl.download_tab?prm_arquivo=';
		WS_ALT := '&prm_alternativo=';
	    HTP.P('<span title="'||FUN.LANG('Op&ccedil;&otilde;es')||'" class="options closed" id="'||RTRIM(PRM_CALL)||'more" style="max-width: 34px;">');
			HTP.P('<span class="lightbulb" title="'||FUN.LANG('Lista do Menu')||'"></span>');
		HTP.P('</span>');
		HTP.P('<h2>'||FUN.UTRANSLATE('NM_OBJETO', PRM_CALL, WS_TITULO, WS_PADRAO)||'</h2>');
	END IF;
		HTP.P('<ul id="space-options">');
		
		OPEN CRS_ITENS;
			LOOP
			FETCH CRS_ITENS INTO WS_ITENS;
			EXIT WHEN CRS_ITENS%NOTFOUND;
			    WS_TIPO := WS_ITENS.TP_OBJETO;
				
				IF WS_ITENS.ATTRIB <> 'N/A' AND WS_ITENS.TP_OBJETO <> 'RELATORIO' THEN
				    WS_ATT :=  'download="'||WS_ITENS.ATTRIB||'" href="'||WS_URL||WS_ITENS.ATTRIB||WS_ALT||'"';
				END IF;
				
				IF TRIM(NVL(WS_ITENS.NM_ITEM,'')) <> '''' THEN
				    HTP.P('<li class="'||WS_TIPO||'" id="'||WS_ITENS.CD_OBJETO||'menu"><a '||WS_ATT||'>'||FUN.SUBPAR(WS_ITENS.NM_ITEM, PRM_SCREEN)||'</a></li>');
				ELSE
				    HTP.P('<li class="'||WS_TIPO||'" id="'||WS_ITENS.CD_OBJETO||'menu"><a '||WS_ATT||'>'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', WS_ITENS.CD_OBJETO, WS_ITENS.NM_OBJETO, WS_PADRAO), PRM_SCREEN)||'</a></li>');
				END IF;
			END LOOP;
        CLOSE CRS_ITENS;
		OPEN CRS_SCRIPTS;
			LOOP
			    FETCH CRS_SCRIPTS INTO WS_SCRIPT;
			    EXIT WHEN CRS_SCRIPTS%NOTFOUND;
			    IF TRIM(WS_SCRIPT.NM_ITEM) <> '''' THEN
			    	HTP.P('<li class="SCRIPT" id="'||WS_SCRIPT.CD_OBJETO||'menu"><a onclick="appendar(''dwu.obj.show_objeto?prm_objeto='||WS_SCRIPT.CD_OBJETO||'&PRM_ZINDEX=2&prm_posx=100px&prm_posy=100px&prm_screen=''+tela, '''', false); setTimeout(function(){ remover(''script-load''); }, 10000);">'||WS_SCRIPT.NM_ITEM||'</a></li>');
				ELSE
				    HTP.P('<li class="SCRIPT" id="'||WS_SCRIPT.CD_OBJETO||'menu"><a onclick="appendar(''dwu.obj.show_objeto?prm_objeto='||WS_SCRIPT.CD_OBJETO||'&PRM_ZINDEX=2&prm_posx=100px&prm_posy=100px&prm_screen=''+tela, '''', false); setTimeout(function(){ remover(''script-load''); }, 10000);">'||WS_SCRIPT.NM_OBJETO||'</a></li>');
			    END IF;
			END LOOP;
	    CLOSE CRS_SCRIPTS;

		HTP.P('</ul>');
		
END CALL_LIST;


PROCEDURE DL_GADG ( PRM_OBJETO VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	BEGIN
	    DELETE FROM OBJETOS WHERE CD_OBJETO = PRM_OBJETO;
	    COMMIT;
	EXCEPTION WHEN OTHERS THEN
	    HTP.P(FUN.LANG('Objeto n&atilde;o foi excluido')||'.');
	END;
END DL_GADG;





PROCEDURE PONTO_AV ( PRM_MICRO_VISAO VARCHAR2 DEFAULT NULL,
			         WS_PAR_SUMARY 	VARCHAR2 DEFAULT NULL,
		             WS_PAR_TIPO	VARCHAR2 DEFAULT NULL,
		             WS_PAR_SEECOL	VARCHAR2 DEFAULT NULL,
		             PRM_ZINDEX     VARCHAR2 DEFAULT NULL,
		             WS_PAR_LINHAS	VARCHAR2 DEFAULT NULL,
		             WS_PAR_COLUNAS	VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_PONTO_AVALIACAO IS
			SELECT * FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND CD_USUARIO = 'DWU';

	WS_PAVL	CRS_PONTO_AVALIACAO%ROWTYPE;

	CURSOR CRS_OBJETOS IS
			SELECT * FROM OBJETOS WHERE RTRIM(CD_OBJETO) = TRIM(WS_PAR_SUMARY) AND TRIM(TP_OBJETO) = TRIM(WS_PAR_TIPO);

	WS_POBJ		CRS_OBJETOS%ROWTYPE;

	WS_GRUPO	VARCHAR2(40);

	WS_MICRO_VISAO	VARCHAR2(40);
	WS_PAR_SAIDA	LONG;
	WS_FUNCAO	    CHAR(1);
	WS_RETORNO	    VARCHAR2(30);
	WS_COUNT		NUMBER;

	WS_LISTA	DBMS_SQL.VARCHAR2_TABLE;

	WS_ACCESSO	EXCEPTION;
	WS_TABELA    VARCHAR2(40);
	WS_VALORES   VARCHAR2(2000) := '';
	WS_SCREEN  	 VARCHAR2(200);
	WS_AGRUPADOR VARCHAR2(200) := '';
	WS_COLUP     VARCHAR2(200) := '';
	WS_COLUNA    VARCHAR2(200) := '';
	WS_PADRAO    VARCHAR2(80)  := 'PORTUGUESE';

BEGIN
    
	OPEN CRS_OBJETOS;
	FETCH CRS_OBJETOS INTO WS_POBJ;
	CLOSE CRS_OBJETOS;

	IF  NVL(WS_POBJ.CD_OBJETO,'%#%') <> WS_PAR_SUMARY THEN
	    WS_FUNCAO       := 'G';
	    WS_PAR_SAIDA    := WS_PAR_SUMARY;
	    WS_MICRO_VISAO  := SUBSTR(WS_PAR_SAIDA, 1 ,INSTR(WS_PAR_SAIDA,'|')-1);
	    WS_PAR_SAIDA    := REPLACE(WS_PAR_SAIDA,WS_MICRO_VISAO||'|','');
	ELSE
	    OPEN CRS_PONTO_AVALIACAO;
	    FETCH CRS_PONTO_AVALIACAO INTO WS_PAVL;
	    CLOSE CRS_PONTO_AVALIACAO;
	    WS_FUNCAO      := 'R';
	    WS_MICRO_VISAO := WS_PAVL.CD_MICRO_VISAO;
	    WS_PAR_SAIDA   := WS_PAVL.PARAMETROS;
	END IF;


    BEGIN
		SELECT CS_COLUNA||'|'||CS_AGRUPADOR||'|'||CS_COLUP INTO WS_VALORES FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND CD_USUARIO = 'DWU';
		
		SELECT CS_AGRUPADOR INTO WS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND CD_USUARIO = 'DWU';
		
		SELECT CS_COLUP INTO WS_COLUP FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND CD_USUARIO = 'DWU';
		
		SELECT CS_COLUNA INTO WS_COLUNA FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY AND CD_USUARIO = 'DWU';
	END;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
	
	
	WS_VALORES := REPLACE(WS_VALORES, '||', '|');

	HTP.P('<div class="itens" style="width: 346px;" onmouseleave="if(event.relatedTarget != null){ save(''savepa''); }">');
		HTP.P('<h2 class="fixed">'||FUN.LANG('PROPRIEDADES')||'</h2>');

		HTP.FORMOPEN( CATTRIBUTES => 'name="pontoa" id="savepa" style="margin: 0;"', CURL =>'dwu.fcl.savepa', CMETHOD => 'post', CTARGET => '');
		HTP.P('<form name="pontoa" id="savepa" style="margin: 0;">');

			IF WS_PAR_SUMARY <> '''' THEN
				HTP.P('<input type="hidden" value="'||WS_PAR_SUMARY||'" class="p_parametros">');
			ELSE
				HTP.P('<input type="hidden" value="'||WS_PAR_SUMARY||'" class="p_parametros">');
			END IF;
			HTP.P('<input type="hidden" value="'||WS_FUNCAO||'" class="p_funcao">');

			HTP.P('<input type="hidden" value="" class="pcs_parametros">');
			IF  WS_PAR_TIPO NOT IN ('PIZZA','ROSCA', 'LINHAS','BARRAS', 'COLUNAS', 'MAPA') THEN
				HTP.P('<input type="hidden" value="'||WS_PAVL.CS_COLUNA||'" class="pcs_coluna">');
			END IF;
			IF  WS_PAR_TIPO IN ('PIZZA','ROSCA', 'LINHAS','BARRAS', 'COLUNAS', 'MAPA') THEN
				 HTP.P('<input type="hidden" value="'||WS_PAR_SUMARY||'" class="pcs_agrupador">');
			ELSE
				HTP.P('<input type="hidden" value="'||WS_PAVL.CS_AGRUPADOR||'" class="pcs_agrupador">');
			END IF;
			HTP.P('<input type="hidden" value="'||WS_PAVL.CS_RP||'" class="pcs_rp">');
			HTP.P('<input type="hidden" value="'||WS_PAVL.CS_COLUP||'" class="pcs_colup">');

		HTP.P('<ul class="form">');
			IF PRM_MICRO_VISAO <> '''' THEN
				SELECT NM_TABELA INTO WS_TABELA FROM MICRO_VISAO WHERE NM_MICRO_VISAO = PRM_MICRO_VISAO;
				HTP.P('<li class="readonly">');
				    HTP.P('<span class="before">'||FUN.LANG('Micro vis&atilde;o')||'</span>');
					HTP.P('<span class="after">');	
						IF (WS_FUNCAO = 'R') THEN
							HTP.P('<input type="text" readonly="true"id="ponto-visao" title="'||WS_MICRO_VISAO||'" class="p_cd_micro_visao" value="'||PRM_MICRO_VISAO||'" />');
						ELSE
							HTP.P('<input style="width: 200px;" type="text" readonly="true" id="ponto-visao" title="'||WS_MICRO_VISAO||'" class="p_cd_micro_visao" value="'||PRM_MICRO_VISAO||'" />');
						END IF;
					HTP.P('</span>');
					IF WS_FUNCAO = 'R' THEN
						
						HTP.P('<a title="'||FUN.LANG('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); curtain(''enabled''); titulo(this, ''n''); call_save(''''); carregaPainel(''list_crocks&prm_default='||WS_MICRO_VISAO||'''); telaSup(''visao'','''||PRM_MICRO_VISAO||''');">');
                            HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						HTP.P('</a>');
					ELSE
						
						HTP.P('<a title="'||FUN.LANG('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); call_save(''''); carregaPainel(''list_crocks&prm_default='||WS_MICRO_VISAO||'''); telaSup(''visao'','''||PRM_MICRO_VISAO||''');">');
						    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
                        HTP.P('</a>');
					END IF;
				HTP.P('</li>');
				HTP.P('<li class="readonly">');
				    HTP.P('<span class="before">'||FUN.LANG('Tabela')||'</span>');
					HTP.P('<span class="after">');
					    HTP.P('<input type="text" readonly="true" title="'||WS_TABELA||'" class="" value="'||WS_TABELA||'" />');
					HTP.P('</span>');
				HTP.P('</li>');
			ELSE
				SELECT NM_TABELA INTO WS_TABELA FROM MICRO_VISAO WHERE NM_MICRO_VISAO = WS_MICRO_VISAO;
					HTP.P('<li>');
					    HTP.P('<span class="before">'||FUN.LANG('Micro vis&atilde;o')||'</span>');
						HTP.P('<span class="after">');
							IF WS_FUNCAO = 'R' THEN
								HTP.P('<input type="text" readonly="true" id="ponto-visao" title="'||WS_MICRO_VISAO||'" class="p_cd_micro_visao" value="'||WS_MICRO_VISAO||'" />');
							ELSE
								HTP.P('<input style="width: 200px;" type="text" readonly="true" title="'||WS_MICRO_VISAO||'" id="ponto-visao" class="p_cd_micro_visao" value="'||WS_MICRO_VISAO||'" />');
							END IF;
						HTP.P('</span>');
						HTP.P('<a title="'||FUN.LANG('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); call_save(''''); carregaPainel(''list_crocks&prm_default='||WS_MICRO_VISAO||'''); ajax(''list'', ''load_crocks'', ''prm_visao='||WS_MICRO_VISAO||'&prm_valores='||WS_VALORES||''', true, ''ajax-lista''); telaSup(''visao'','''||PRM_MICRO_VISAO||''');">');
                            HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
						HTP.P('</a>');
				HTP.P('</li>');
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Tabela')||'</span>');
					HTP.P('<span class="after">');
					    HTP.P('<input type="text" readonly="true" title="'||WS_TABELA||'" class="" value="'||WS_TABELA||'" />');
					HTP.P('</span>');
				HTP.P('</li>');
			END IF;


			IF WS_POBJ.CD_OBJETO <> '''' THEN
				HTP.P('<li class="readonly">');
				    HTP.P('<span class="before">ID</span>');
					HTP.P('<span class="after">');		
						IF (WS_FUNCAO = 'R') THEN
							HTP.P('<input required="required" type="text" class="p_cd_ponto" name="" '||FPDATA(WS_FUNCAO,'R',' readonly="yes" ','')||' value="'||WS_POBJ.CD_OBJETO||'" size="30" maxlength="20" >');
						ELSE
							HTP.P('<input required="required" type="text" class="p_cd_ponto" name="" '||FPDATA(WS_FUNCAO,'R',' readonly="yes" ','')||' value="'||WS_POBJ.CD_OBJETO||'" size="30" maxlength="20" >');
						END IF;
					HTP.P('</span>');
				HTP.P('</li>');
			ELSE
				HTP.P('<li>');
				    HTP.P('<span class="before">ID</span>');
					HTP.P('<span class="after">');	
						IF (WS_FUNCAO = 'R') THEN
							HTP.P('<td class="readonly"><input required="required" type="text" class="p_cd_ponto" name="" '||FPDATA(WS_FUNCAO,'R',' ','')||' value="" size="30" maxlength="20" ></td>');
						ELSE
							HTP.P('<td><input required="required" type="text" class="p_cd_ponto" name="" '||FPDATA(WS_FUNCAO,'R',' ','')||' value="" size="30" maxlength="20" ></td>');
						END IF;
					HTP.P('</span>');
				HTP.P('</li>');
			END IF;

			HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('Nome')||'</span>');
			    HTP.P('<span class="after">');
				    HTP.P('<input required="required" type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''nome'', this.value);" title="'||WS_POBJ.NM_OBJETO||'" value="'||FUN.UTRANSLATE('NM_OBJETO', WS_PAR_SUMARY, WS_POBJ.NM_OBJETO, WS_PADRAO)||'" size="50" maxlength="80" />');
			    HTP.P('</span>');
				HTP.P('<a class="fakelang mini" onclick="fakeLang('''||WS_PAR_SUMARY||'_nome'', '''||WS_PAR_SUMARY||'|NM_OBJETO|''+this.previousElementSibling.children[0].title);">L</a>');
			HTP.P('</li>');

			HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('Subtitulo')||'</span>');
			    HTP.P('<span class="after">');    
					HTP.P('<input required="required" type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''subtitulo'', this.value);" title="'||WS_POBJ.SUBTITULO||'" value="'||FUN.UTRANSLATE('NM_OBJETO', WS_PAR_SUMARY, WS_POBJ.SUBTITULO, WS_PADRAO)||'" size="50" maxlength="200" />');
			    HTP.P('</span>');
				HTP.P('<a class="fakelang mini" onclick="fakeLang(''fake_atributo'', '''||WS_PAR_SUMARY||'|SUBTITULO|''+this.previousElementSibling.children[0].title);">L</a>');
			HTP.P('</li>');

            BEGIN
				SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = TRIM(WS_PAR_SUMARY);
				IF WS_COUNT = 1 THEN
					SELECT CD_GRUPO INTO WS_GRUPO FROM OBJETOS WHERE CD_OBJETO = TRIM(WS_PAR_SUMARY);
				ELSE
					WS_GRUPO := '';
				END IF;
			END;
			
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('Grupo')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''grupo'', this.nextElementSibling.title);"></a>');
		            FCL.FAKEOPTION('fake-grupo', FUN.LANG('Escolha um grupo'), WS_GRUPO, 'lista-grupos', 'N', 'N', '');
				HTP.P('</span>');
			HTP.P('</li>');
			
			IF WS_PAR_TIPO = 'CONSULTA' THEN
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Coluna')||'</span>');
					HTP.P('<span class="after">');
				        HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''coluna'', this.nextElementSibling.title);"></a>');
					    FCL.FAKEOPTION('coluna-principal', FUN.LANG('Escolha uma coluna'), WS_COLUNA, 'lista-pivot', 'N', 'S', 'ponto-visao');
				    HTP.P('</span>');
				HTP.P('</li>');
				
				IF WS_PAR_TIPO <> 'BROWSER' THEN
					HTP.P('<li>');
						HTP.P('<span class="before">'||FUN.LANG('Agrupador')||'</span>');
						HTP.P('<span class="after">');
							HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''agrupador'', this.nextElementSibling.title);"></a>');
							FCL.FAKEOPTION('coluna-agrupador', FUN.LANG('Escolha um agrupador'), WS_AGRUPADOR, 'lista-valor', 'N', 'S', 'ponto-visao');
						HTP.P('</span>');
					HTP.P('</li>');
				END IF;
				
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Pivot')||'</span>');
					HTP.P('<span class="after">');
					    HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''colup'', this.nextElementSibling.title);"></a>');
					    FCL.FAKEOPTION('coluna-pivot', FUN.LANG('Escolha um pivot'), WS_COLUP, 'lista-pivot', 'N', 'S', 'ponto-visao');
					HTP.P('</span>');
				HTP.P('</li>');
			END IF;

			IF WS_PAR_TIPO IN ('VALOR') THEN
				
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Colunas utilizadas')||'</span>');
					HTP.P('<span class="after">');
					    HTP.P('<a onclick="fakeOption(''fakecolumn'', '''||FUN.LANG('COLUNAS')||''', ''colunav'', '''||WS_PAR_SUMARY||''');" class="link">'||FUN.LANG('ALTERAR')||'</a>');
				    HTP.P('</span>');
				HTP.P('</li>');
			END IF;

			IF WS_PAR_TIPO IN ('PIZZA','ROSCA','LINHAS','BARRAS','COLUNAS','MAPA') THEN
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Coluna')||'</span>');
				    HTP.P('<span class="after">');
						HTP.P('<select class="pcs_coluna">');
							IF  WS_FUNCAO = 'R' THEN
								WS_RETORNO := FUN.RET_LIST(WS_PAVL.CS_COLUNA,WS_LISTA);
							ELSE
								WS_RETORNO := FUN.RET_LIST(WS_PAR_COLUNAS,WS_LISTA);
							END IF;
							FOR I IN WS_LISTA.FIRST..WS_LISTA.LAST
							LOOP
								FCL.FORMSELECTOPTION( FUN.CDESC(WS_LISTA(I),'MICRO_COLUNA'),WS_LISTA(I));
							END LOOP;
						HTP.FORMSELECTCLOSE;
					HTP.P('</span>');
				HTP.P('</li>');
			END IF;
            
			HTP.P('<li data-hint="'||FUN.LANG('Log Di&aacute;rio')||'" style="display: none;">');
				HTP.P(HTF.FORMCHECKBOX( '', CCHECKED=> FPDATA(WS_PAVL.AR_DIARIO,'S','CHECKED',''), CATTRIBUTES => 'class="p_ar_diario" style="font-size: 10px; width: 14px;"'));
			HTP.P('</li>');

			HTP.P('<li data-hint="'||FUN.LANG('Log Mensal')||'" style="display: none;">');
				HTP.P(HTF.FORMCHECKBOX( '', CCHECKED=> FPDATA(WS_PAVL.AR_MENSAL,'S','CHECKED',''), CATTRIBUTES => 'class="p_ar_mensal" style="font-size: 10px; width: 14px;"'));
			HTP.P('</li>');

			HTP.P('<li data-hint="'||FUN.LANG('Log Anual')||'" style="display: none;">');
				HTP.P(HTF.FORMCHECKBOX( '', CCHECKED=> FPDATA(WS_PAVL.AR_ANUAL,'S','CHECKED',''), CATTRIBUTES => 'class="p_ar_anual" style="font-size: 10px; width: 14px;"'));
			HTP.P('</li>');

			HTP.P('<li data-hint="View" style="display: none;">');
				HTP.FORMSELECTOPEN( CNAME => '', CATTRIBUTES => ' class="p_cd_visao"');
					FCL.FORMSELECTOPTION( FUN.LANG('Publica'),'T', FPDATA(WS_PAVL.CD_VISAO,'T','SELECTED',''));
					FCL.FORMSELECTOPTION( FUN.LANG('Privada'),'U', FPDATA(WS_PAVL.CD_VISAO,'U','SELECTED',''));
				HTP.FORMSELECTCLOSE;
			HTP.P('</li>');

			HTP.P('<li data-hint="'||FUN.LANG('Renova&ccedil;&atilde;o')||'" style="display: none;">');
				HTP.FORMSELECTOPEN( CNAME => '', CATTRIBUTES => ' class="p_tp_renovacao"');
					FCL.FORMSELECTOPTION( FUN.LANG('Online'),'O', FPDATA(WS_PAVL.TP_RENOVACAO,'O','SELECTED',''));
					FCL.FORMSELECTOPTION( FUN.LANG('Noturna'),'N', FPDATA(WS_PAVL.TP_RENOVACAO,'N','SELECTED',''));
				HTP.FORMSELECTCLOSE;
			HTP.P('</li>');


			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('Descritivo')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<textarea style="max-width: 180px; height: 36px;" onblur="update_prop('''||WS_PAR_SUMARY||''', ''descritivo'', this.value);">'||WS_PAVL.DS_PONTO||'</textarea>');
			    HTP.P('</span>');
			HTP.P('</li>');

			HTP.P('<li>');
                HTP.P('<span class="before">'||FUN.LANG('Tipo')||'</span>');
                HTP.P('<span class="after">');
			        HTP.FORMTEXT( CNAME => 'p_tipo', CSIZE => '12', CATTRIBUTES => 'class="p_tipo" readonly="yes" style="background: #BBB; width: 200px;"', CVALUE => WS_PAR_TIPO );
			    HTP.P('</span>');
			HTP.P('</li>');
            BEGIN
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Utilizado em')||'</span>');
					HTP.P('<span class="after">');
						HTP.P('<textarea disabled style="max-width: 220px; height: 45px; resize: none;">');
						BEGIN
							FOR I IN (SELECT SCREEN AS TELA FROM OBJECT_LOCATION WHERE OBJECT_ID = TRIM(WS_PAR_SUMARY)) LOOP
								IF INSTR(I.TELA, 'ARTICLE') > 0 THEN
									SELECT (SELECT SCREEN FROM OBJECT_LOCATION T2 WHERE T2.OBJECT_ID = T1.SCREEN) INTO WS_SCREEN FROM OBJECT_LOCATION T1 WHERE T1.OBJECT_ID = I.TELA;
								ELSE
									WS_SCREEN := I.TELA;
								END IF;
								SELECT NM_OBJETO INTO WS_SCREEN FROM OBJETOS WHERE CD_OBJETO = WS_SCREEN;
								HTP.P(WS_SCREEN);
							END LOOP;
						EXCEPTION WHEN OTHERS THEN
							HTP.P('');
						END;
						HTP.P('</textarea>');
					HTP.P('</span>');
			    HTP.P('</li>');
			END;

			

		HTP.P('</ul>');

		HTP.FORMCLOSE;

	HTP.P('</div>');
	
	FCL.CLOSER_MENU;

EXCEPTION WHEN OTHERS THEN
    HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END PONTO_AV;











































































































































































































PROCEDURE EDIT_VPADRAO ( WS_PAR_SUMARY 	VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_VPADRAO IS
		SELECT CD_PADRAO, NM_PADRAO, TP_PADRAO, CD_LIGACAO, STATUS, ORDEM FROM PARAMETRO_PADRAO
		WHERE CD_PADRAO = WS_PAR_SUMARY
		ORDER BY ORDEM;

	WS_VPADRAO	CRS_VPADRAO%ROWTYPE;

	CURSOR CRS_CDESC IS
		SELECT NDS_TABELA FROM CODIGO_DESCRICAO;

	WS_CDESC CRS_CDESC%ROWTYPE;

	WS_PAR_SAIDA LONG;
	WS_FUNCAO CHAR(1);
	WS_RETORNO VARCHAR2(30);
	WS_CONT NUMBER;

	WS_LISTA DBMS_SQL.VARCHAR2_TABLE;

	WS_ACCESSO EXCEPTION;

BEGIN
    
	OPEN CRS_VPADRAO;
	FETCH CRS_VPADRAO INTO WS_VPADRAO;
	CLOSE CRS_VPADRAO;

	IF  NVL(WS_VPADRAO.CD_PADRAO,'%#%') <> WS_PAR_SUMARY OR WS_PAR_SUMARY='NOVO' THEN
	    WS_FUNCAO := 'G';
	ELSE
	    WS_FUNCAO := 'R';
	END IF;

	HTP.FORMOPEN( CATTRIBUTES => 'name="pontoa" id="savevp"', CURL =>'dwu.fcl.savevp', CMETHOD => 'post', CTARGET => '');

	HTP.P('<table class="form">');
	HTP.P('<input type="hidden" class="p_funcao" value="'||WS_FUNCAO||'" />');

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('PADR&Atilde;O')||':</td>');
	    HTP.P('<td><input type="text" class="p_cd_padrao" '||FPDATA(WS_FUNCAO,'R',' readonly="yes" ','')||' value="'||WS_VPADRAO.CD_PADRAO||'" class="up" size="30" maxlength="20"></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('NOME')||':</td>');
	    HTP.P('<td><input type="text" class="p_nm_padrao" value="'||WS_VPADRAO.NM_PADRAO||'" size="30" maxlength="80"></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('TIPO')||':</td>');
	    HTP.P('<td>');
			HTP.FORMSELECTOPEN( CNAME => '', CATTRIBUTES => 'class="p_tp_padrao"');
			FCL.FORMSELECTOPTION(FUN.LANG('Sem'), 'SEM', FPDATA(WS_VPADRAO.TP_PADRAO,'SEM', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('Data'), 'DATA', FPDATA(WS_VPADRAO.TP_PADRAO,'DATA', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('M&ecirc;s'), 'MES', FPDATA(WS_VPADRAO.TP_PADRAO,'MES', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('Ano'), 'ANO', FPDATA(WS_VPADRAO.TP_PADRAO,'ANO', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('Texto'), 'TEXTO', FPDATA(WS_VPADRAO.TP_PADRAO,'TEXTO', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('Inteiro'),'INTEIRO', FPDATA(WS_VPADRAO.TP_PADRAO,'INTEIRO', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('Número'),	'NUMERO', FPDATA(WS_VPADRAO.TP_PADRAO,'NUMERO',	'SELECTED',''),'');
			HTP.FORMSELECTCLOSE;
	    HTP.P('</td>');
    HTP.TABLEROWCLOSE;

	HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('VIS&Iacute;VEL')||':</td>');
	    HTP.P('<td>');
			HTP.FORMSELECTOPEN( CNAME => '', CATTRIBUTES => 'class="p_status"');
			FCL.FORMSELECTOPTION(FUN.LANG('Sim'), 'A', FPDATA(WS_VPADRAO.TP_PADRAO,'A', 'SELECTED',''),'');
			FCL.FORMSELECTOPTION(FUN.LANG('N&atilde;o'), 'I', FPDATA(WS_VPADRAO.TP_PADRAO,'I', 'SELECTED',''),'');
			HTP.FORMSELECTCLOSE;
	    HTP.P('</td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||':</td>');
        HTP.P('<td>');
			HTP.FORMSELECTOPEN( CNAME => '', CATTRIBUTES => 'class="p_cd_ligacao"');
			  FCL.FORMSELECTOPTION(FUN.LANG('Sem Liga&ccedil;&atilde;o'),'SEM');
			  OPEN CRS_CDESC;
			  LOOP
				 FETCH CRS_CDESC INTO WS_CDESC;
				   EXIT WHEN CRS_CDESC%NOTFOUND;
						FCL.FORMSELECTOPTION( WS_CDESC.NDS_TABELA,WS_CDESC.NDS_TABELA, FPDATA(WS_VPADRAO.CD_LIGACAO,WS_CDESC.NDS_TABELA,'SELECTED',''));
				 END LOOP;
			  CLOSE CRS_CDESC;
			HTP.FORMSELECTCLOSE;
	    HTP.P('</td>');
    HTP.TABLEROWCLOSE;
	HTP.FORMCLOSE;
	HTP.TABLECLOSE;

	HTP.P('<div class="listar"><a onclick=" call_save(''''); carrega(''list_vpadrao''); ">'||FUN.LANG('Listar par&acirc;metros')||'</a></div>');

END EDIT_VPADRAO;



PROCEDURE ED_GADG ( WS_PAR_SUMARY VARCHAR2, 
                    PRM_TIPO      VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_OBJETOS IS
	SELECT * FROM OBJETOS WHERE CD_OBJETO = WS_PAR_SUMARY;

	WS_OBJ CRS_OBJETOS%ROWTYPE;

	CURSOR CRS_AGRUPADORES IS
	SELECT COLUMN_VALUE, (SELECT MAX(NM_ROTULO) FROM MICRO_COLUNA WHERE CD_COLUNA = COLUMN_VALUE) AS COLUNA FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY)));

	WS_AGRUPADOR CRS_AGRUPADORES%ROWTYPE;

	WS_MICRO_VISAO   VARCHAR2(80);
	WS_RONLY         VARCHAR2(40);
	WS_PAR_SAIDA     LONG;
	WS_FUNCAO        CHAR(1);
	WS_GRUPO         VARCHAR2(2000);
	WS_MICRO_COUNT   NUMBER;
	WS_COUNT         NUMBER;
	WS_TABELA        VARCHAR2(40);
	WS_VALOR         VARCHAR2(800);
	WS_SCREEN        VARCHAR2(2000);
	WS_CS_COLUNA     VARCHAR2(600);
	WS_CS_AGRUPADOR  VARCHAR2(600);
	WS_READY_COUNT   NUMBER;
	WS_COLUP         VARCHAR2(600);
	WS_PADRAO        VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO       VARCHAR2(40);
	WS_DESC			 VARCHAR2(40);		
	WS_NOUSER        EXCEPTION;
BEGIN
    
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	OPEN CRS_OBJETOS;
	FETCH CRS_OBJETOS INTO WS_OBJ;
	CLOSE CRS_OBJETOS;

	IF WS_OBJ.CD_OBJETO <> WS_PAR_SUMARY OR WS_PAR_SUMARY='NOVO' THEN
	    WS_FUNCAO := 'G';
	ELSE
	    WS_FUNCAO := 'R';
	END IF;

	HTP.P('<div class="itens" data-obj="'||WS_PAR_SUMARY||'" style="width: 346px;" onmouseleave="if(document.getElementById('''||WS_PAR_SUMARY||''')){ document.getElementById('''||WS_PAR_SUMARY||''').classList.remove(''destacada''); }" onmouseenter="if(document.getElementById('''||WS_PAR_SUMARY||''')){ document.getElementById('''||WS_PAR_SUMARY||''').classList.add(''destacada''); }">');

		HTP.P('<h2>'||FUN.LANG('PROPRIEDADES')||'</h2>');

		HTP.P('<ul class="form">');

		

		SELECT NVL(SIGN(LENGTH(MAX(CD_MICRO_VISAO))), 0) INTO WS_READY_COUNT FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY;

		IF WS_OBJ.TP_OBJETO NOT IN ('IMAGE', 'TEXTO', 'ICONE', 'BROWSER') THEN

			IF WS_READY_COUNT = 1 OR WS_OBJ.TP_OBJETO IN ('VALOR') THEN
				SELECT CD_MICRO_VISAO, CS_COLUNA||'|'||CS_AGRUPADOR||'|'||CS_COLUP, (SELECT NM_TABELA FROM MICRO_VISAO WHERE NM_MICRO_VISAO = CD_MICRO_VISAO), CS_COLUNA, CS_AGRUPADOR INTO WS_MICRO_VISAO, WS_VALOR, WS_TABELA, WS_CS_COLUNA, WS_CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY;

				IF LENGTH(WS_MICRO_VISAO) > 0 THEN
					HTP.P('<li class="readonly">');
				ELSE
					HTP.P('<li style="display: none;">');
				END IF;
				    HTP.P('<span class="before">'||FUN.LANG('MICRO VIS&Atilde;O')||'</span>');
					HTP.P('<span class="after">');     
						HTP.P('<input type="text" readonly="true" id="micro-visao" class="p_cd_micro_visao" title="'||WS_MICRO_VISAO||'" value="'||WS_MICRO_VISAO||'" />');
				    HTP.P('</span>'); 
					HTP.P('<a title="'||FUN.LANG('Colunas')||'" class="colunaprop" onclick="document.getElementById(''attriblist'').classList.remove(''open''); titulo(this, ''n''); curtain(''enabled''); call_save(''''); carregaPainel(''list_crocks'', '''||WS_PAR_SUMARY||'''); /*ajax(''list'', ''load_crocks'', ''prm_visao='||WS_MICRO_VISAO||'&prm_valores='||WS_VALOR||''', true, ''ajax-lista''); loader(''ajax-lista'');*/ telaSup(''visao'','''||WS_MICRO_VISAO||'''); ajax(''fly'', ''remove_coluna'', ''prm_visao='||WS_MICRO_VISAO||''', ''true'');">');
                        HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" xml:space="preserve"> <g> <g> <g> <circle cx="256" cy="256" r="64"></circle> <circle cx="256" cy="448" r="64"></circle> <circle cx="256" cy="64" r="64"></circle> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					HTP.P('</a>');
				HTP.P('</li>');
			ELSE

			    HTP.P('<li>');
					HTP.P('<span class="before">'||FUN.LANG('MICRO VIS&Atilde;O')||'</span>');
					HTP.P('<span class="after">');    
						HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''view'', this.nextElementSibling.title); document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
						FCL.FAKEOPTION('micro-visao', FUN.LANG('Escolha uma view'), WS_MICRO_VISAO, 'lista-views', 'N', 'N', '');						
					HTP.P('</span>');
				HTP.P('</li>');

			END IF;

			IF WS_OBJ.TP_OBJETO IN ('PIZZA', 'ROSCA', 'LINHAS', 'BARRAS','COLUNAS', 'CONSULTA') AND WS_READY_COUNT = 1 THEN
			    SELECT CD_MICRO_VISAO, CS_COLUNA, CS_AGRUPADOR INTO WS_MICRO_VISAO, WS_CS_COLUNA, WS_CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY;
			END IF;

		END IF;

		SELECT COUNT(*) INTO WS_MICRO_COUNT FROM MICRO_DATA WHERE NM_MICRO_DATA = WS_MICRO_VISAO;

		IF WS_MICRO_COUNT = 1 THEN
			SELECT NM_TABELA INTO WS_TABELA FROM MICRO_DATA WHERE NM_MICRO_DATA = WS_MICRO_VISAO;
			IF LENGTH(WS_TABELA) > 0 THEN
				HTP.P('<li class="readonly">');
			ELSE
				HTP.P('<li style="display: none;">');
			END IF;
			    HTP.P('<span class="before">'||FUN.LANG('Tabela')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<input type="text" readonly="true" title="'||WS_TABELA||'" value="'||WS_TABELA||'" />');
				HTP.P('</span>');
			HTP.P('</li>');
		END IF;

		SELECT COUNT(*) INTO WS_MICRO_COUNT FROM MICRO_VISAO WHERE NM_MICRO_VISAO = WS_MICRO_VISAO;

		IF WS_MICRO_COUNT = 1 THEN
			SELECT NM_TABELA INTO WS_TABELA FROM MICRO_VISAO WHERE NM_MICRO_VISAO = WS_MICRO_VISAO;
			IF LENGTH(WS_TABELA) > 0 THEN
				HTP.P('<li class="readonly">');
			ELSE
				HTP.P('<li style="display: none;">');
			END IF;
			    HTP.P('<span class="before">'||FUN.LANG('Tabela')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<input type="text" readonly="true" title="'||WS_TABELA||'" value="'||WS_TABELA||'" />');
				HTP.P('</span>');
			HTP.P('</li>');
		END IF;

		HTP.P('<li style="display: none;"><input type="hidden" class="p_funcao" value="'||WS_FUNCAO||'"/></li>');
 
        HTP.P('<li class="readonly">');
		    HTP.P('<span class="before">ID</span>');
			HTP.P('<span class="after">');
				HTP.P('<input type="text" readonly id="ident" data-default="'||WS_PAR_SUMARY||'" class="p_cd_objeto" value="'||WS_OBJ.CD_OBJETO||'" >');
			HTP.P('</span>');
		HTP.P('</li>');

		HTP.P('<li>');
		    HTP.P('<span class="before">COD</span>');
			HTP.P('<span class="after">');
			    HTP.P('<input id="'||WS_PAR_SUMARY||'cod" type="text" data-default="'||WS_OBJ.COD||'" onkeyup="if(this.value != this.getAttribute(''data-default'')){ ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=objetos'', true, '''||WS_PAR_SUMARY||'cod''); }" onblur="if(this.value != this.getAttribute(''data-default'')){ if(!this.classList.contains(''error'')){ update_prop('''||WS_PAR_SUMARY||''', ''COD'', this.value); this.setAttribute(''data-default'', this.value); this.classList.remove(''ok''); }}"  value="'||WS_OBJ.COD||'" maxlength="80" >');
			HTP.P('</span>');
		HTP.P('</li>');

		HTP.P('<li>');
			HTP.P('<span class="before">'||FUN.LANG('Nome')||'</span>');
			HTP.P('<span class="after">');
			    HTP.P('<textarea onkeypress="if(!input(event, ''nobr'')){ event.preventDefault(); }" onblur="update_prop(document.getElementById(''ident'').value, ''nome'', this.value);" title="'||WS_OBJ.NM_OBJETO||'" value="'||REPLACE(WS_OBJ.NM_OBJETO, '"', '&quot;')||'" size="50" maxlength="80">'||REPLACE(WS_OBJ.NM_OBJETO, '"', '&quot;')||'</textarea>');
		    HTP.P('</span>');
			HTP.P('<a class="fakelang mini" onclick="fakeLang('''||WS_OBJ.NM_OBJETO||'_nome'', '''||WS_PAR_SUMARY||'|NM_OBJETO|''+this.previousElementSibling.children[0].title);">L</a>');
		HTP.P('</li>');

		IF WS_OBJ.TP_OBJETO <> 'BROWSER' THEN

			HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('Subt&iacute;tulo')||'</span>');
				HTP.P('<span class="after">');
					HTP.P('<input type="text" onblur="update_prop(document.getElementById(''ident'').value, ''subtitulo'', this.value);" title="'||WS_OBJ.SUBTITULO||'" value="'||REPLACE(WS_OBJ.SUBTITULO, '"', '&quot;')||'" size="50" maxlength="80">');
			    HTP.P('</span>');
				HTP.P('<a class="fakelang mini" onclick="fakeLang(''fake_atributo'', '''||WS_PAR_SUMARY||'|SUBTITULO|''+this.previousElementSibling.children[0].title);">L</a>');
			HTP.P('</li>');

		END IF;

		IF WS_OBJ.TP_OBJETO IN ('FILE', 'ICONE', 'IMAGE') THEN
			HTP.P('<li data-hint="URL">');
			    HTP.P('<span class="before">'||FUN.LANG('URL')||'</span>');
			    HTP.P('<span class="after">');

					HTP.P('<a class="script" onclick="var url = ''dwu.fcl.download?arquivo=''+this.nextElementSibling.title; update_prop(document.getElementById(''ident'').value, ''atributos'', url); document.getElementById('''||WS_PAR_SUMARY||'_gr'').setAttribute(''src'', url);"></a>');
					FCL.FAKEOPTION('fake_img', 'Imagem ou arquivo', REPLACE(UPPER(WS_OBJ.ATRIBUTOS), 'dwu.fcl.download?arquivo=', ''), 'lista-arquivo', 'S', 'N');

					


				HTP.P('</span>');
			HTP.P('</li>');
		ELSIF WS_OBJ.TP_OBJETO IN ('TEXTO', 'MARQUEE') THEN
			
			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('Texto')||'</span>');
                HTP.P('<span class="after">');
					HTP.P('<textarea type="text" id="fake_atributo" onblur="update_prop(document.getElementById(''ident'').value, ''atributos'', encodeURIComponent(this.value));" class="p_atributos" title="'||WS_OBJ.ATRIBUTOS||'" size="80" maxlength="800">'||REPLACE(FUN.UTRANSLATE('ATRIBUTOS', WS_PAR_SUMARY, WS_OBJ.ATRIBUTOS, WS_PADRAO), '"', '&quot;')||'</textarea>');
			    HTP.P('</span>');
				HTP.P('<a class="fakelang mini" onclick="fakeLang(''fake_atributo'', '''||WS_PAR_SUMARY||'|ATRIBUTOS|''+this.previousElementSibling.children[0].title);">L</a>');
			HTP.P('</li>');
		ELSIF WS_OBJ.TP_OBJETO = 'RELATORIO' THEN
		    HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('CONSULTA')||'</span>');
				
				HTP.P('<span class="after">');
				    
				    BEGIN
						SELECT COD INTO WS_VALOR FROM OBJETOS WHERE CD_OBJETO = WS_OBJ.ATRIBUTOS;
					EXCEPTION WHEN OTHERS THEN
						WS_VALOR := '';
					END;

					HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''atributos'', this.nextElementSibling.title);"></a>');
		            FCL.FAKEOPTION('fake-consulta', 'Escolha a consulta', WS_OBJ.ATRIBUTOS, 'lista-consultas', 'N', 'N', '', PRM_DESC => WS_VALOR);
				HTP.P('</span>');
			HTP.P('</li>');
		END IF;

		HTP.P('<li>');
			
			IF WS_PAR_SUMARY <> 'NOVO' THEN
			  SELECT T1.CD_GRUPO, NM_GRUPO INTO WS_GRUPO, WS_DESC 
			  FROM OBJETOS T1
			  LEFT JOIN GRUPOS_FUNCAO T2 ON T2.CD_GRUPO = T1.CD_GRUPO
			  WHERE CD_OBJETO = TRIM(WS_PAR_SUMARY);
			ELSE
			  WS_GRUPO := '';
			END IF;

			HTP.P('<span class="before">'||FUN.LANG('Grupo')||'</span>');
			HTP.P('<span class="after">');
		        HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''grupo'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
		        FCL.FAKEOPTION('fake-grupo', FUN.LANG('Escolha um grupo'), WS_GRUPO, 'lista-grupos', 'N', 'N', '', PRM_DESC => WS_GRUPO||' - '||WS_DESC);
			HTP.P('</span>');
		HTP.P('</li>');

        HTP.P('<li>');
       
		    HTP.P('<span class="before">'||FUN.LANG('Tipo')||'</span>');
			HTP.P('<span class="after">');
				
				IF WS_OBJ.TP_OBJETO IN ('PIZZA', 'ROSCA', 'LINHAS', 'BARRAS','COLUNAS') OR (WS_OBJ.TP_OBJETO = 'OBJETO' AND PRM_TIPO = 'grafico') THEN
				    HTP.P('<select onchange="blockOptions(this)">');
                ELSE
				    HTP.P('<select class="readonly" readonly disabled>');
				END IF;
				
				IF WS_OBJ.TP_OBJETO IN ('PIZZA', 'ROSCA', 'LINHAS', 'BARRAS', 'COLUNAS', 'PONTEIRO') THEN
				    

					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE BARRAS'), 'BARRAS', FPDATA(WS_OBJ.TP_OBJETO,'BARRAS', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE COLUNAS'), 'COLUNAS', FPDATA(WS_OBJ.TP_OBJETO,'COLUNAS', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE LINHAS'), 'LINHAS', FPDATA(WS_OBJ.TP_OBJETO,'LINHAS', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE PIZZA'), 'PIZZA', FPDATA(WS_OBJ.TP_OBJETO,'PIZZA', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE PONTEIRO'), 'PONTEIRO', FPDATA(WS_OBJ.TP_OBJETO,'PONTEIRO', 'SELECTED',''));

	
				ELSIF WS_OBJ.TP_OBJETO = 'OBJETO' AND PRM_TIPO = 'grafico' THEN
				    UPDATE OBJETOS
					SET TP_OBJETO = UPPER(TRIM('BARRAS'))
					WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(WS_PAR_SUMARY));
					COMMIT;
					
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE BARRAS'), 'BARRAS', FPDATA(WS_OBJ.TP_OBJETO,'BARRAS', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE COLUNAS'), 'COLUNAS', FPDATA(WS_OBJ.TP_OBJETO,'COLUNAS', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE LINHAS'), 'LINHAS', FPDATA(WS_OBJ.TP_OBJETO,'LINHAS', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE PIZZA'), 'PIZZA', FPDATA(WS_OBJ.TP_OBJETO,'PIZZA', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('GR&Aacute;FICO DE PONTEIRO'), 'PONTEIRO', FPDATA(WS_OBJ.TP_OBJETO,'PONTEIRO', 'SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('MAPA GEOGR&Aacute;FICO'), 'MAPA', FPDATA(WS_OBJ.TP_OBJETO,'MAPA', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO =  'OBJETO' AND PRM_TIPO = 'consulta' THEN
				    UPDATE OBJETOS
					SET TP_OBJETO = UPPER(TRIM('CONSULTA'))
					WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(WS_PAR_SUMARY));
					COMMIT;
					FCL.FORMSELECTOPTION(FUN.LANG('CONSULTA'), 'CONSULTA', FPDATA(WS_OBJ.TP_OBJETO,'CONSULTA', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO = 'CONSULTA' THEN
				    FCL.FORMSELECTOPTION(FUN.LANG('CONSULTA'), 'CONSULTA', FPDATA(WS_OBJ.TP_OBJETO,'CONSULTA', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('MAPA') THEN
				    FCL.FORMSELECTOPTION(FUN.LANG('MAPA GEOGR&Aacute;FICO'), 'MAPA', FPDATA(WS_OBJ.TP_OBJETO,'MAPA', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('ORGANOGRAMA') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Organograma'), 'ORGANOGRAMA', FPDATA(WS_OBJ.TP_OBJETO,'ORGANOGRAMA', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('FILE') THEN
				    FCL.FORMSELECTOPTION( 'FileView', 'FILE', FPDATA(WS_OBJ.TP_OBJETO,'FILE', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('ICONE') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Icone'), 'ICONE', FPDATA(WS_OBJ.TP_OBJETO,'ICONE','SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('IMAGE') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Imagem'), 'IMAGE', FPDATA(WS_OBJ.TP_OBJETO,'IMAGE','SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('CALL_LIST') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Menu'), 'CALL_LIST', FPDATA(WS_OBJ.TP_OBJETO,'CALL_LIST', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('FLOAT_PAR') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Par&acirc;metro'), 'FLOAT_PAR', FPDATA(WS_OBJ.TP_OBJETO,'FLOAT_PAR', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('TEXTO') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Texto'), 'TEXTO', FPDATA(WS_OBJ.TP_OBJETO,'TEXTO','SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('FLOAT_FILTER') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Par&acirc;metro'), 'FLOAT_FILTER', FPDATA(WS_OBJ.TP_OBJETO,'FLOAT_FILTER', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('VALOR') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Valor'), 'VALOR', FPDATA(WS_OBJ.TP_OBJETO,'VALOR', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('RELATORIO') THEN
					FCL.FORMSELECTOPTION(FUN.LANG('Relat&oacute;rio'), 'RELATORIO', FPDATA(WS_OBJ.TP_OBJETO,'RELATORIO', 'SELECTED',''));
				ELSIF WS_OBJ.TP_OBJETO IN ('PONTEIRO') THEN
				    FCL.FORMSELECTOPTION(FUN.LANG('Ponteiro'), WS_OBJ.TP_OBJETO, FPDATA(WS_OBJ.TP_OBJETO,'PONTEIRO', 'SELECTED',''));
				ELSE
					FCL.FORMSELECTOPTION(FUN.LANG('Browser'), WS_OBJ.TP_OBJETO, FPDATA(WS_OBJ.TP_OBJETO,'BROWSER', 'SELECTED',''));
				END IF;
				HTP.FORMSELECTCLOSE;
			HTP.P('</span>');
		HTP.P('</li>');
		
		IF WS_OBJ.TP_OBJETO = 'CONSULTA' OR WS_OBJ.TP_OBJETO = 'OBJETO' OR ( WS_OBJ.TP_OBJETO IN ('LINHAS', 'BARRAS', 'COLUNAS', 'PIZZA', 'ROSCA', 'MAPA', 'OBJETO', 'CONSULTA') ) THEN
		
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('AGRUPADOR')||'</span>');
				HTP.P('<span class="after">');    
					HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''coluna'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
					IF WS_OBJ.TP_OBJETO IN ('LINHAS', 'BARRAS', 'PIZZA', 'ROSCA', 'MAPA', 'PONTEIRO', 'OBJETO') AND NVL(PRM_TIPO, 'N/A') <> 'consulta' THEN
					    FCL.FAKEOPTION('micro-coluna', 'Escolha uma coluna', WS_CS_COLUNA, 'lista-agrupador', 'N', 'N', 'micro-visao');
					ELSE
                        FCL.FAKEOPTION('micro-coluna', 'Escolha uma coluna', WS_CS_COLUNA, 'lista-agrupador', 'N', 'S', 'micro-visao');
					END IF;
				HTP.P('</span>');
			HTP.P('</li>');
			
		END IF;

		IF WS_OBJ.TP_OBJETO IN ('LINHAS', 'BARRAS', 'COLUNAS', 'PIZZA', 'ROSCA', 'MAPA', 'OBJETO', 'CONSULTA')  THEN
			HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('VALOR')||'</span>');
			    HTP.P('<span class="after">');
				    HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''agrupador'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
				    FCL.FAKEOPTION('micro-agrupador', 'Escolha um valor', WS_CS_AGRUPADOR, 'lista-valor', 'N', 'S', 'micro-visao');
				HTP.P('</span>');
			HTP.P('</li>');
		END IF;
		 

		IF WS_OBJ.TP_OBJETO IN ('LINHAS', 'BARRAS', 'COLUNAS', 'OBJETO', 'CONSULTA', 'PIZZA')  THEN
            BEGIN
			    SELECT CS_COLUP INTO WS_COLUP FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY;
			EXCEPTION WHEN OTHERS THEN
			    WS_COLUP := '';
			END;
			
			IF WS_OBJ.TP_OBJETO = 'PIZZA' THEN
                HTP.P('<li class="invisible">');
			ELSE
                HTP.P('<li>');
			END IF;
			
			    IF WS_OBJ.TP_OBJETO = 'CONSULTA' THEN
				    HTP.P('<span class="before">'||FUN.LANG('PIVOT')||'</span>');
					HTP.P('<span class="after">');
				        HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''colup'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
				        FCL.FAKEOPTION('coluna-pivot', FUN.LANG('Escolha um pivot'), WS_COLUP, 'lista-pivot', 'N', 'S', 'micro-visao');
				    HTP.P('</span>');
				ELSIF WS_OBJ.TP_OBJETO = 'BARRAS' OR WS_OBJ.TP_OBJETO = 'LINHAS' OR WS_OBJ.TP_OBJETO = 'PIZZA' OR WS_OBJ.TP_OBJETO = 'COLUNAS' THEN
				    
					HTP.P('<span class="before">'||FUN.LANG('AUXILIAR')||'</span>');
					HTP.P('<span class="after">');
				        HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''sec'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
				        FCL.FAKEOPTION('coluna-sec', FUN.LANG('Escolha o auxiliar'), FUN.GETPROP(WS_PAR_SUMARY, 'SEC'), 'lista-valor', 'N', 'S', 'micro-visao');
				    HTP.P('</span>');
					
				ELSE
				    IF PRM_TIPO <> 'grafico' THEN
							
						HTP.P('<span class="before">'||FUN.LANG('PIVOT')||'</span>');
						HTP.P('<span class="after">');
							HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''colup'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
							FCL.FAKEOPTION('coluna-pivot', FUN.LANG('Escolha um pivot'), WS_COLUP, 'lista-pivot', 'N', 'S', 'micro-visao');
						HTP.P('</span>');

					END IF;
					
					IF PRM_TIPO <> 'consulta' THEN

						HTP.P('<span class="before">'||FUN.LANG('AUXILIAR')||'</span>');
						HTP.P('<span class="after">');
							HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''sec'', this.nextElementSibling.title);  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
							FCL.FAKEOPTION('coluna-sec', FUN.LANG('Escolha o auxiliar'), FUN.GETPROP(WS_PAR_SUMARY, 'SEC'), 'lista-valor', 'N', 'S', 'micro-visao');
						HTP.P('</span>');

					END IF;
				END IF;
			   
			HTP.P('</li>');
		END IF;
		 
		









		
		IF WS_OBJ.TP_OBJETO = 'VALOR' OR WS_OBJ.TP_OBJETO = 'PONTEIRO' THEN
			







			SELECT REPLACE(NVL(PARAMETROS, CS_AGRUPADOR), '|', '') INTO WS_VALOR FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_PAR_SUMARY;

			HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('VALOR')||'</span>');
			    HTP.P('<span class="after">');
				    HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''parametros'', this.nextElementSibling.title+''|'');  document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
				    FCL.FAKEOPTION('micro-agrupador', 'Escolha um valor', WS_VALOR, 'lista-valor-simples', 'N', 'N', 'micro-visao');
				HTP.P('</span>');
			HTP.P('</li>');
		END IF;

        IF WS_OBJ.TP_OBJETO = 'BROWSER' THEN
            
			HTP.P('<li class="readonly">');
				HTP.P('<span class="before">'||FUN.LANG('TABELA')||'</span>');
			    HTP.P('<span class="after">');
				    SELECT NM_TABELA INTO WS_VALOR FROM MICRO_DATA WHERE NM_MICRO_DATA = WS_PAR_SUMARY;
				    HTP.P('<input type="text" readonly="true" value="'||WS_VALOR||'"/>');
				HTP.P('</span>');
			HTP.P('</li>');
			
			
			HTP.P('<li>');
				
				HTP.P('<span class="before">'||FUN.LANG('Upload')||'</span>');
				
				HTP.P('<span class="after">');
					
					
					HTP.P('<a class="script" onclick="ajax(''fly'', ''alter_attrib'', ''prm_objeto='||WS_PAR_SUMARY||'&prm_prop=UPLOAD&prm_value=''+this.nextElementSibling.title+''&prm_usuario=DWU'', true);"></a>');
					IF FUN.GETPROP(WS_PAR_SUMARY,'UPLOAD') = 'S' THEN
						HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||FUN.GETPROP(WS_PAR_SUMARY,'UPLOAD')||'"></span>');
					ELSE
						HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||FUN.GETPROP(WS_PAR_SUMARY,'UPLOAD')||'"></span>');
					END IF;
					
					








				HTP.P('</span>');
				
			HTP.P('</li>');
			
			HTP.P('<li>');
				
				HTP.P('<span class="before">'||FUN.LANG('Bloqueio de edi&ccedil;&atilde;o')||'</span>');
				HTP.P('<span class="after">');
				    
						HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''PERMISSAOED'', this.nextElementSibling.title);"></a>');
						
						BEGIN
						    SELECT PROPRIEDADE INTO WS_GRUPO FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(WS_PAR_SUMARY) AND CD_PROP = 'PERMISSAOED';
						EXCEPTION WHEN OTHERS THEN
							WS_GRUPO := '';
						END;

						FCL.FAKEOPTION('permissao-browser-ed', '', WS_GRUPO, 'lista-permissao-browser-op', 'N', 'S', WS_PAR_SUMARY, FUN.LANG('Lista de valores'), 'PERMISSAOED');
                   
				HTP.P('</span>');
			HTP.P('</li>');
			
			HTP.P('<li>');
				
				HTP.P('<span class="before">'||FUN.LANG('Bloqueio de exclus&atilde;o')||'</span>');
				HTP.P('<span class="after">');
					
						HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''PERMISSAOEX'', this.nextElementSibling.title);"></a>');
						BEGIN
						    SELECT PROPRIEDADE INTO WS_GRUPO FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(WS_PAR_SUMARY) AND CD_PROP = 'PERMISSAOEX';
						EXCEPTION WHEN OTHERS THEN
							WS_GRUPO := '';
						END;

						FCL.FAKEOPTION('permissao-browser-ex', '', WS_GRUPO, 'lista-permissao-browser-op', 'N', 'S', WS_PAR_SUMARY, FUN.LANG('Lista de valores'), 'PERMISSAOEX');

				HTP.P('</span>');
			HTP.P('</li>');
			
			HTP.P('<li>');

				HTP.P('<span class="before">'||FUN.LANG('Bloqueio de adi&ccedil;&atilde;o')||'</span>');
				HTP.P('<span class="after">');
				    
						HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''PERMISSAOAD'', this.nextElementSibling.title);"></a>');
						BEGIN
						    SELECT PROPRIEDADE INTO WS_GRUPO FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(WS_PAR_SUMARY) AND CD_PROP = 'PERMISSAOAD';
						EXCEPTION WHEN OTHERS THEN
							WS_GRUPO := '';
						END;

						FCL.FAKEOPTION('permissao-browser-ad', '', WS_GRUPO, 'lista-permissao-browser-op', 'N', 'S', WS_PAR_SUMARY, FUN.LANG('Lista de valores'), 'PERMISSAOAD');
					
				HTP.P('</span>');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('Bloqueio de filtro')||'</span>');
				HTP.P('<span class="after">');
						HTP.P('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''PERMISSAONOFILTER'', this.nextElementSibling.title);"></a>');
						BEGIN
						    SELECT PROPRIEDADE INTO WS_GRUPO FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(WS_PAR_SUMARY) AND CD_PROP = 'PERMISSAONOFILTER';
						EXCEPTION WHEN OTHERS THEN
							WS_GRUPO := '';
						END;
						FCL.FAKEOPTION('permissao-browser-filter', '', WS_GRUPO, 'lista-permissao-browser-op', 'N', 'S', WS_PAR_SUMARY, FUN.LANG('Lista de valores'), 'PERMISSAONOFILTER');
				HTP.P('</span>');
			HTP.P('</li>');

			htp.p('<li>');
				htp.p('<span class="before">'||fun.lang('Bloqueio de destaque')||'</span>');
				htp.p('<span class="after">');
					htp.p('<a class="script" onclick="update_prop(document.getElementById(''ident'').value, ''PERMISSAODESTAQUE'', this.nextElementSibling.title);document.querySelector(''.itens'').setAttribute(''data-alterado'', ''T'');"></a>');
					begin
						select propriedade into ws_grupo from object_attrib where cd_object = TRIM(WS_PAR_SUMARY) and cd_prop = 'PERMISSAODESTAQUE';
					exception when others then
						ws_grupo := '';
					end;
					fcl.fakeoption('permissao-browser-destaque', '', ws_grupo, 'lista-permissao-browser-op', 'N', 'S', WS_PAR_SUMARY, fun.lang('Lista de valores'), 'PERMISSAODESTAQUE');
				htp.p('</span>');
			htp.p('</li>');



        END IF;

		HTP.P('<li>');
		    HTP.P('<span class="before">'||FUN.LANG('Observa&ccedil;&atilde;o')||'</span>');
		    HTP.P('<span class="after">');
		       HTP.P('<textarea class="p_ds_objeto" onblur="update_prop(document.getElementById(''ident'').value, ''descritivo'', this.value);">'||WS_OBJ.DS_OBJETO||'</textarea>');
		    HTP.P('</span>');
		HTP.P('</li>');

        SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE OBJECT_ID = WS_OBJ.CD_OBJETO;

			IF WS_COUNT > 0 THEN

				HTP.P('<li>');
				    
					HTP.P('<span class="before">'||FUN.LANG('Utilizado em')||'</span>');
					
					HTP.P('<span class="after">');
					
						HTP.P('<textarea disabled style="max-width: 220px; height: 30px; resize: none;">');

						BEGIN

							FOR I IN (SELECT SCREEN AS TELA FROM OBJECT_LOCATION WHERE OBJECT_ID = WS_OBJ.CD_OBJETO) LOOP
								IF INSTR(I.TELA, 'ARTICLE') > 0 THEN
									SELECT NVL((SELECT SCREEN FROM OBJECT_LOCATION T2 WHERE T2.OBJECT_ID = T1.SCREEN), 'N/A') INTO WS_SCREEN FROM OBJECT_LOCATION T1 WHERE T1.OBJECT_ID = I.TELA;
								ELSE
									WS_SCREEN := I.TELA;
								END IF;
								IF WS_SCREEN <> 'N/A' THEN
									SELECT NM_OBJETO INTO WS_SCREEN FROM OBJETOS WHERE CD_OBJETO = WS_SCREEN;
									HTP.P(WS_SCREEN);
								END IF;
							END LOOP;
						EXCEPTION WHEN OTHERS THEN
							HTP.P('');
						END;
						HTP.P('</textarea>');
					
					HTP.P('</span>');
					
				HTP.P('</li>');
			END IF;

		HTP.P('</ul>');

	HTP.P('</div>');
	
	FCL.CLOSER_MENU;

	
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(SQLERRM);
END ED_GADG;


PROCEDURE ED_CALL ( PRM_OBJECT VARCHAR2,
                    PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS
 
	CURSOR CRS_OBJETOS IS
	SELECT * FROM OBJETOS WHERE CD_OBJETO = PRM_OBJECT AND CD_USUARIO = 'DWU'; 

	WS_OBJ		CRS_OBJETOS%ROWTYPE;

	CURSOR CRS_GRUPOS IS
    SELECT RTRIM(CD_GRUPO) AS CD_GRUPO,
	RTRIM(NM_GRUPO)	AS NM_GRUPO,
	RTRIM(STATUS)	AS STATUS,
	RTRIM(GIF)	AS GIF
    FROM GRUPOS_FUNCAO ORDER BY ORDEM, CD_GRUPO;

	WS_GRUPO	VARCHAR2(40);

	WS_MICRO_VISAO	VARCHAR2(40);
	WS_RONLY	VARCHAR2(40);
	WS_PAR_SAIDA	LONG;
	WS_FUNCAO	CHAR(1);
	WS_GRUPOF	VARCHAR2(40);
	WS_ZINDEX   VARCHAR2(10);
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO  VARCHAR2(80);

	WS_NOUSER   EXCEPTION;
BEGIN
    
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	OPEN CRS_OBJETOS;
	FETCH CRS_OBJETOS INTO WS_OBJ;
	CLOSE CRS_OBJETOS;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO = 'CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	IF  WS_OBJ.CD_OBJETO <> PRM_OBJECT OR PRM_OBJECT='NOVO' THEN
	    WS_FUNCAO      := 'G';
	ELSE
	    WS_FUNCAO      := 'R';
	END IF;

	HTP.P('<div class="itens" style="width: 346px;" onmouseleave="if(event.relatedTarget != null){ save(''savecall''); }">');

		HTP.P('<h2>'||FUN.LANG('PROPRIEDADES')||'</h2>');

        HTP.FORMOPEN( CATTRIBUTES => 'name="pontoa" id="saveap"', CURL =>'dwu.fcl.savecallist', CMETHOD => 'post', CTARGET => '');
		HTP.P('<ul class="form">');
		HTP.P('<input type="hidden" value="R" class="p_funcao"/>');

			HTP.P('<li class="invisible">');
				HTP.P('<input type="hidden" class="p_cd_objeto" value="'||WS_OBJ.CD_OBJETO||'">');
			HTP.P('</li>');
			
			HTP.P('<li data-hint="ID">');
				HTP.P('<span class="before">ID</span>');
				HTP.P('<span class="after">');
				    HTP.P('<input type="text" '||FPDATA(WS_FUNCAO,'R',' readonly="yes" ','')||' value="'||NVL(WS_OBJ.COD, WS_OBJ.CD_OBJETO)||'">');
			    HTP.P('</span>');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('Nome')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<input type="text" title="'||WS_OBJ.NM_OBJETO||'" id="'||PRM_OBJECT||'_nome" class="p_nm_objeto" value="'||FUN.UTRANSLATE('NM_OBJETO', PRM_OBJECT, WS_OBJ.NM_OBJETO, WS_PADRAO)||'" onblur="update_prop('''||PRM_OBJECT||''', ''nome'', this.value);" size="50" maxlength="40">');
			    HTP.P('</span>');
				HTP.P('<a class="fakelang mini" onclick="fakeLang('''||PRM_OBJECT||'_nome'', '''||PRM_OBJECT||'|NM_OBJETO|''+this.previousElementSibling.title);">L</a>');
			HTP.P('</li>');

			SELECT CD_GRUPO INTO WS_GRUPO FROM OBJETOS WHERE CD_OBJETO = TRIM(PRM_OBJECT);
				


				
				HTP.P('<li>');
				    HTP.P('<span class="before">'||FUN.LANG('Grupo')||'</span>');
				    HTP.P('<span class="after">');
					    HTP.P('<a class="script" onclick="update_prop('''||TRIM(PRM_OBJECT)||''', ''grupo'', this.nextElementSibling.title);"></a>');
				        FCL.FAKEOPTION('fake-grupo', WS_GRUPO, WS_GRUPO, 'lista-grupos', 'N', 'N');
				    HTP.P('</span>');
				HTP.P('</li>');

			BEGIN
				SELECT ZINDEX INTO WS_ZINDEX FROM OBJECT_LOCATION WHERE OBJECT_ID = PRM_OBJECT AND SCREEN = PRM_SCREEN;
			EXCEPTION WHEN OTHERS THEN
				WS_ZINDEX := '5';
			END;

				HTP.P('<li>');
					HTP.P('<span class="before">'||FUN.LANG('Ordem do menu')||'</span>');
				    HTP.P('<span class="after">');
						HTP.P('<select onchange="ajax(''pos'', ''salva_posicao'', ''prm_objeto='||PRM_OBJECT||'&prm_screen=''+document.getElementById(''current_screen'').value+''&prm_posx=&prm_posy=&prm_zindex=''+this.value+''&prm_tipo=posicao'', ''true'');">');
							FCL.NUMERICOPTIONS(5, WS_ZINDEX);
						HTP.P('</select>');
					HTP.P('</span>');
				HTP.P('</li>');

			HTP.P('<li>');
			    HTP.P('<span class="before">'||FUN.LANG('Descritivo')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<textarea onblur="update_prop('''||PRM_OBJECT||''', ''descritivo'', this.value);">'||WS_OBJ.DS_OBJETO||'</textarea>');
			    HTP.P('</span>');
			HTP.P('</li>');

		HTP.FORMCLOSE;
		HTP.P('</ul>');

	HTP.P('</div>');
	
	FCL.CLOSER_MENU;
EXCEPTION
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END ED_CALL;


















































































































PROCEDURE EDIT_SINAL ( WS_PAR_SUMARY 	VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_SINAL IS
			SELECT * FROM SINAIS
			WHERE CD_SINAL = WS_PAR_SUMARY;

	WS_SINAL	CRS_SINAL%ROWTYPE;

	WS_PAR_SAIDA	LONG;
	WS_FUNCAO	CHAR(1);
	WS_RETORNO	VARCHAR2(30);
	WS_CONT		NUMBER;

	WS_LISTA	DBMS_SQL.VARCHAR2_TABLE;

	WS_ACCESSO	EXCEPTION;

BEGIN

    
	OPEN CRS_SINAL;
	FETCH CRS_SINAL INTO WS_SINAL;
	CLOSE CRS_SINAL;

	IF  NVL(WS_SINAL.CD_SINAL,'%#%') <> WS_PAR_SUMARY OR WS_PAR_SUMARY='NOVO' THEN
	    WS_FUNCAO := 'G';
	ELSE
	    WS_FUNCAO := 'R';
	END IF;

	HTP.P( '<input type="hidden" name="xcaminho"     id="caminho"   value="'||FUN.R_GIF('path')||'">' );

	HTP.FORMOPEN( CATTRIBUTES => 'name="pontoa" id="savemvi"', CURL =>'dwu.fcl.savesign', CMETHOD => 'post', CTARGET => '');

	HTP.P('<h2>'||WS_PAR_SUMARY||'</h2>');

	HTP.P('<table class="form">');

	HTP.P('<input type="hidden" value="'||WS_FUNCAO||'" class="p_funcao"/>');

	HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('Sinal')||':</td>');
	    HTP.P('<td><input type="text" style="background: #BBB;" class="p_cd_sinal" '||FPDATA(WS_FUNCAO,'R',' readonly="yes" ','')||' value="'||WS_SINAL.CD_SINAL||'" size="30" maxlength="20" /></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||FUN.LANG('Descri&ccedil;&atilde;o')||':</td>');
	    HTP.P('<td><input type="text" style="background: #BBB;" class="p_ds_sinal" value="'||WS_SINAL.DS_SINAL||'" size="50" maxlength="80" readonly/></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
		HTP.P('<td>'||FUN.LANG('Imagem')||':</td>');
		HTP.P('<td>');
			HTP.FORMSELECTOPEN( CNAME => 'p_tp_sinal', CATTRIBUTES => 'class="p_tp_sinal" id="jnds_tipo" onchange=" document.getElementById(''sin1'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_1.png''; document.getElementById(''sin2'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_2.png''; document.getElementById(''sin3'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_3.png''; document.getElementById(''sin4'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_4.png''; document.getElementById(''sin5'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_5.png''; " ');
			FCL.FORMSELECTOPTION( '1', '1', '', FPDATA(WS_SINAL.TP_SINAL,'1', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '2', '2', '', FPDATA(WS_SINAL.TP_SINAL,'2', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '3', '3', '', FPDATA(WS_SINAL.TP_SINAL,'3', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '4', '4', '', FPDATA(WS_SINAL.TP_SINAL,'4', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '5', '5', '', FPDATA(WS_SINAL.TP_SINAL,'5', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '6', '6', '', FPDATA(WS_SINAL.TP_SINAL,'6', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '7', '7', '', FPDATA(WS_SINAL.TP_SINAL,'7', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '8', '8', '', FPDATA(WS_SINAL.TP_SINAL,'8', 'SELECTED',''));
			FCL.FORMSELECTOPTION( '9', '9', '', FPDATA(WS_SINAL.TP_SINAL,'9', 'SELECTED',''));
			HTP.FORMSELECTCLOSE;
		HTP.P('</td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||HTF.IMG(FUN.R_GIF('ind'||RTRIM(WS_SINAL.TP_SINAL)||'_1', 'PNG' ), CATTRIBUTES => 'id="sin1"')||FCL.HTEXTO('Faixa 1:','2', CATTRIBUTES => '')||'</td>');
	    HTP.P('<td><input type="text" class="p_fx_01" value="'||WS_SINAL.FX_01||'" size="30" maxlength="80" ></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||HTF.IMG(FUN.R_GIF('ind'||RTRIM(WS_SINAL.TP_SINAL)||'_2', 'PNG' ), CATTRIBUTES => 'id="sin2"')||FCL.HTEXTO('Faixa 2:','2', CATTRIBUTES => '')||'</td>');
	    HTP.P('<td><input type="text" class="p_fx_02" value="'||WS_SINAL.FX_02||'" size="30" maxlength="80" ></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||HTF.IMG(FUN.R_GIF('ind'||RTRIM(WS_SINAL.TP_SINAL)||'_3', 'PNG' ), CATTRIBUTES => 'id="sin3"')||FCL.HTEXTO('Faixa 3:','2', CATTRIBUTES => '')||'</td>');
	    HTP.P('<td><input type="text" class="p_fx_03" value="'||WS_SINAL.FX_03||'" size="30" maxlength="80" ></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||HTF.IMG(FUN.R_GIF('ind'||RTRIM(WS_SINAL.TP_SINAL)||'_4', 'PNG' ), CATTRIBUTES => 'id="sin4"')||FCL.HTEXTO('Faixa 4:','2', CATTRIBUTES => '')||'</td>');
	    HTP.P('<td><input type="text" class="p_fx_04" value="'||WS_SINAL.FX_04||'" size="30" maxlength="80" ></td>');
    HTP.TABLEROWCLOSE;

    HTP.TABLEROWOPEN;
	    HTP.P('<td>'||HTF.IMG(FUN.R_GIF('ind'||RTRIM(WS_SINAL.TP_SINAL)||'_5', 'PNG' ), CATTRIBUTES => 'id="sin5"')||FCL.HTEXTO('Faixa 5:','2', CATTRIBUTES => '')||'</td>');
	    HTP.P('<td><input type="text" class="p_fx_05" value="'||WS_SINAL.FX_05||'" size="30" maxlength="80" ></td>');
    HTP.TABLEROWCLOSE;

	HTP.FORMCLOSE;
	HTP.TABLECLOSE;

	HTP.P('<div class="listar"><a onclick=" carrega(''list_sinal''); call_save(''''); ">'||FUN.LANG('Listar sinais')||'</a></div>');

END EDIT_SINAL;





PROCEDURE SCREEN_PROP ( WS_PAR_SUMARY VARCHAR2 ) AS

	CURSOR CRS_ALL_SCREENS IS
	  SELECT * FROM ALL_SCREENS WHERE SCREEN = WS_PAR_SUMARY AND OWNER = 'DWU';

	WS_SCR CRS_ALL_SCREENS%ROWTYPE;

	WS_MICRO_VISAO VARCHAR2(80);
	WS_RONLY VARCHAR2(80);
	WS_PAR_SAIDA LONG;
	WS_FUNCAO CHAR(1);
	WS_GRUPOF VARCHAR2(40);
	WS_VALOR VARCHAR2(80);
	WS_COUNT NUMBER;
	WS_HIDDEN VARCHAR2(200);
    WS_REPEAT VARCHAR2(200);
	WS_MANUTENCAO  VARCHAR2(4);
	WS_ATUALIZANDO VARCHAR2(4);
    WS_POS    VARCHAR2(200);
    WS_SIZE   VARCHAR2(200);
    WS_LISTA  CLOB;
	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';
	WS_DESC   VARCHAR2(2000);
	WS_USUARIO VARCHAR2(80);
	WS_VIEW    VARCHAR2(80);

	WS_NOUSER  EXCEPTION;
	WS_TOKEN   VARCHAR2(80);

	WS_CD_PROP			DBMS_SQL.VARCHAR2_TABLE;
	WS_PROP				DBMS_SQL.VARCHAR2_TABLE;
	WS_ROTULO			DBMS_SQL.VARCHAR2_TABLE;
	WS_TIPO				DBMS_SQL.VARCHAR2_TABLE;
	WS_SUFIXO			DBMS_SQL.VARCHAR2_TABLE;
	WS_SCRIPT			DBMS_SQL.VARCHAR2_TABLE;
	WS_LIST				DBMS_SQL.VARCHAR2_TABLE;
	WS_GRUPO            DBMS_SQL.VARCHAR2_TABLE;
	WS_HINT			    DBMS_SQL.VARCHAR2_TABLE;
	WS_ORDEM            DBMS_SQL.NUMBER_TABLE;
BEGIN
    
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
            CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    IF WS_PAR_SUMARY <> 'DEFAULT' THEN
	    OPEN CRS_ALL_SCREENS;
	    FETCH CRS_ALL_SCREENS INTO WS_SCR;
	    CLOSE CRS_ALL_SCREENS;
	    SELECT CD_GRUPO, DS_OBJETO INTO WS_GRUPOF, WS_DESC FROM OBJETOS
	    WHERE CD_OBJETO=WS_PAR_SUMARY AND TP_OBJETO='SCREEN';
	ELSE
	    WS_SCR.SCREEN := 'DEFAULT';
	END IF;

	WS_FUNCAO := 'R';

	SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE SCREEN = WS_PAR_SUMARY;

	HTP.P('<div class="itens" style="width: 346px;">');

	HTP.P('<h2>'||FUN.LANG('PROPRIEDADES')||'</h2>');

	HTP.P('<input type="hidden" class="p_funcao" value="'||WS_FUNCAO||'"/>');

	HTP.P('<ul class="form">');

		HTP.P('<li class="readonly">');
		    HTP.P('<span class="before">ID</span>');
	        HTP.P('<span class="after">');
				IF WS_COUNT = 0 AND WS_PAR_SUMARY <> 'DEFAULT' THEN
				    FCL.BUTTON_LIXO('dl_object','prm_object', WS_PAR_SUMARY);
			    END IF;
				HTP.P('<input type="text" class="p_screen" readonly="true" value="'||WS_SCR.SCREEN||'" class="up" size="30" maxlength="20" >');
				HTP.P('<input type="hidden" class="act_screen" id="actual_screen" value="" >' );
			HTP.P('</span>');
			
		HTP.P('</li>');

		IF WS_PAR_SUMARY = 'DEFAULT' THEN
		    WS_HIDDEN := 'display: none;';
		END IF;

		HTP.P('<li style="'||WS_HIDDEN||'">');
	        HTP.P('<span class="before">'||FUN.LANG('Nome')||'</span>');
	        HTP.P('<span class="after">');
				IF WS_PAR_SUMARY = 'DEFAULT' THEN
					HTP.P('<input type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''nome_tela'', this.value);" title="'||WS_SCR.DESCRICAO||'" value="DEFAULT"/>');
				ELSE
					HTP.P('<input type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''nome_tela'', this.value);" title="'||WS_SCR.DESCRICAO||'" value="'||FUN.UTRANSLATE('NM_OBJETO', WS_PAR_SUMARY, WS_SCR.DESCRICAO, WS_PADRAO)||'" size="50" maxlength="80" />');
				END IF;
			HTP.P('</span>');
			
			IF WS_PAR_SUMARY = 'DEFAULT' THEN
				HTP.P('<a class="fakelang">L</a>');
			ELSE
				HTP.P('<a class="fakelang mini" onclick="fakeLang(''screen_nome'', '''||WS_PAR_SUMARY||'|NM_OBJETO|''+this.previousElementSibling.title);">L</a>');
			END IF;
			
		HTP.P('</li>');

		SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = TRIM(WS_PAR_SUMARY);
		IF WS_COUNT = 1 THEN
			SELECT CD_GRUPO INTO WS_GRUPOF FROM OBJETOS WHERE CD_OBJETO = TRIM(WS_PAR_SUMARY);
		ELSE
			WS_GRUPOF := '';
		END IF;

		HTP.P('<li style="'||WS_HIDDEN||'">');
			IF WS_PAR_SUMARY <> 'DEFAULT' THEN
			    HTP.P('<span class="before">'||FUN.LANG('Grupo')||'</span>');
		        HTP.P('<span class="after">');
				    HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''grupo'', this.nextElementSibling.title);"></a>');
		            FCL.FAKEOPTION('fake-grupo', FUN.LANG('Escolha um grupo'), WS_GRUPOF, 'lista-grupos', 'N', 'N', '');
				HTP.P('</span>');
		    END IF;
		HTP.P('</li>');

		HTP.P('<li style="display: none;">');
			HTP.P('<span class="before">'||FUN.LANG('View')||'</span>');
			HTP.P('<span class="after">');
				HTP.P('<select class="p_publico">');
					FCL.FORMSELECTOPTION(FUN.LANG('Publica'),'S', FPDATA(WS_SCR.PUBLICO,'S','SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('Privada'),'N', FPDATA(WS_SCR.PUBLICO,'N','SELECTED',''));
				HTP.FORMSELECTCLOSE;
			HTP.P('</span>');
		HTP.P('</li>');

		IF WS_PAR_SUMARY <> 'DEFAULT' THEN

			WS_VIEW := FUN.GETPROP(WS_PAR_SUMARY,'VIEW');

            HTP.P('<li style="'||WS_HIDDEN||'">');
	            HTP.P('<span class="before">'||FUN.LANG('View')||'</span>');
	            HTP.P('<span class="after">');
				    HTP.P('<input type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''view'', this.value);" value="'||WS_VIEW||'" size="80" maxlength="80" />');
		        HTP.P('</span>');
			HTP.P('</li>');

			WS_ATUALIZANDO := FUN.GETPROP(WS_PAR_SUMARY,'ATUALIZANDO');
			
			HTP.P('<li>');
				HTP.P('<span class="before">ATUALIZANDO DADOS</span>');
				HTP.P('<span class="after">');
					HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''atualizando'', this.nextElementSibling.title);"></a>');
					IF WS_ATUALIZANDO = 'S' THEN
						HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||WS_ATUALIZANDO||'"></span>');
					ELSE
						HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||WS_ATUALIZANDO||'"></span>');
					END IF;
				HTP.P('</span>');
			HTP.P('</li>');
		END IF;

		HTP.P('<li>');
		    HTP.P('<span class="before">'||FUN.LANG('Descritivo')||'</span>');
			HTP.P('<span class="after">');
                HTP.P('<textarea onblur="update_prop('''||WS_PAR_SUMARY||''', ''descritivo_tela'', this.value);">'||WS_SCR.DS_SCREEN||'</textarea>');
		    HTP.P('</span>');
		HTP.P('</li>');

		IF WS_PAR_SUMARY = 'DEFAULT' THEN
            BEGIN
			    IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
			        SELECT NVL(COR_FUNDO, '#FFFFFF'), NVL(URL_FUNDO, FUN.R_GIF('bg','JPG')) INTO WS_SCR.COR_FUNDO, WS_SCR.URL_FUNDO FROM ALL_SCREENS WHERE SCREEN = 'DEFAULT' AND ROWNUM = 1;
				ELSE
			        SELECT NVL(COR_FUNDO, '#FFFFFF'), NVL(URL_FUNDO, FUN.R_GIF('bg','WEBP')) INTO WS_SCR.COR_FUNDO, WS_SCR.URL_FUNDO FROM ALL_SCREENS WHERE SCREEN = 'DEFAULT' AND ROWNUM = 1;
		        END IF;
			EXCEPTION WHEN OTHERS THEN
				WS_SCR.COR_FUNDO := '#FFFFFF';
				IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
				    WS_SCR.URL_FUNDO := FUN.R_GIF('bg','JPG');
				ELSE
                    WS_SCR.URL_FUNDO := FUN.R_GIF('bg','WEBP');
                END IF;
			END;
		END IF;


		HTP.P('<li>');
			HTP.P('<span class="before">'||FUN.LANG('Cor Fundo')||'</span>');
			HTP.P('<span class="after">');
				HTP.P('<input type="color" value="'||WS_SCR.COR_FUNDO||'" onchange="update_prop('''||WS_PAR_SUMARY||''', ''cor_tela'', this.value); this.nextElementSibling.value = this.value;" oninput="document.getElementById(''main'').style.setProperty(''background-color'', this.value);" />');
				HTP.P('<input list="data-list" type="text" style="width: 70px;" onchange="update_prop('''||WS_PAR_SUMARY||''', ''cor_tela'', this.value); this.previousElementSibling.value = this.value;" oninput="document.getElementById(''main'').style.setProperty(''background-color'', this.value);" value="'||NVL(WS_SCR.COR_FUNDO, 'transparent')||'"/>');
				HTP.P('<datalist id="data-list">');
					HTP.P('<option value="transparent">transparent</option>');
				HTP.P('</datalist>');
			HTP.P('</span>');
		HTP.P('</li>');

        HTP.P('<li>');
		    HTP.P('<span class="before">URL</span>');
	        HTP.P('<span class="after">');
			    HTP.P('<a class="script" onclick="var tipo = ''''; var url = this.nextElementSibling.title; if(url.toUpperCase().indexOf(''EXT='') == -1){ tipo = ''dwu.fcl.download?arquivo=''; } update_prop('''||WS_PAR_SUMARY||''', ''url_tela'', tipo+url);"></a>');
				FCL.FAKEOPTION('fake_img', 'Imagem', REPLACE(WS_SCR.URL_FUNDO, 'dwu.fcl.download?arquivo=', ''), 'lista-arquivo', 'S', 'N');
				
            HTP.P('</span>');
		HTP.P('</li>');

        WS_POS := FUN.GETPROP(WS_PAR_SUMARY,'IMG_POS');

        HTP.P('<li>');
		    HTP.P('<span class="before">'||FUN.LANG('Alinhamento')||'</span>');
	        HTP.P('<span class="after">');
			    HTP.P('<input type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''alinhamento_tela'', this.value);" value="'||WS_POS||'" size="50" maxlength="200" />');
            HTP.P('</span>');
		HTP.P('</li>');

        WS_SIZE := FUN.GETPROP(WS_PAR_SUMARY,'IMG_SIZE');

        HTP.P('<li>');
		    HTP.P('<span class="before">'||FUN.LANG('Tamanho')||'</span>');
	        HTP.P('<span class="after">');
			    HTP.P('<input type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''tamanho_tela'', this.value);" value="'||WS_SIZE||'" size="50" maxlength="200" />');
            HTP.P('</span>');
		HTP.P('</li>');

        WS_REPEAT := FUN.GETPROP(WS_PAR_SUMARY,'REPEAT');

        HTP.P('<li>');
		    HTP.P('<span class="before">'||FUN.LANG('Repetir')||'</span>');
	        HTP.P('<span class="after">');
				HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''repetir_tela'', this.nextElementSibling.title);"></a>');
				IF WS_REPEAT = 'repeat' THEN
					HTP.P('<span class="checkbox checked" data-positive="repeat" data-negative="no-repeat" title="'||WS_REPEAT||'"></span>');
				ELSE
					HTP.P('<span class="checkbox" data-positive="repeat" data-negative="no-repeat" title="'||WS_REPEAT||'"></span>');
				END IF;
			HTP.P('</span>');
		HTP.P('</li>');

	    
        








        IF WS_PAR_SUMARY <> 'DEFAULT' THEN
            HTP.P('<li style="'||WS_HIDDEN||'">');
	            HTP.P('<span class="before">'||FUN.LANG('Ordem')||'</span>');
	            HTP.P('<span class="after">');
				    HTP.P('<input type="text" onblur="update_prop('''||WS_PAR_SUMARY||''', ''item_tela'', this.value);" value="'||WS_SCR.OR_ITEM||'" size="10" maxlength="10" />');
		        HTP.P('</span>');
			HTP.P('</li>');
		END IF;

		HTP.P('<li>');
			HTP.P('<span class="before">'||FUN.LANG('Dispositivo')||'</span>');
	        HTP.P('<span class="after">');
				HTP.P('<select onchange="update_prop('''||WS_PAR_SUMARY||''', ''dispositivo_tela'', this.value);">');
					HTP.P('<option value="">'||FUN.LANG('QUALQUER UM')||'</option>');
					IF WS_SCR.DISPOSITIVO = 'mobile' THEN
						HTP.P('<option value="desktop">DESKTOP</option>');
						HTP.P('<option value="mobile" selected>MOBILE</option>');
						HTP.P('<option value="nenhum">NENHUM</option>');
					ELSIF WS_SCR.DISPOSITIVO = 'desktop' THEN
						HTP.P('<option value="desktop" selected>DESKTOP</option>');
						HTP.P('<option value="mobile">MOBILE</option>');
						HTP.P('<option value="nenhum">NENHUM</option>');
					ELSIF WS_SCR.DISPOSITIVO = 'nenhum' THEN
						HTP.P('<option value="desktop">DESKTOP</option>');
						HTP.P('<option value="mobile">MOBILE</option>');
						HTP.P('<option value="nenhum" selected>NENHUM</option>');
					ELSE
						HTP.P('<option value="desktop">DESKTOP</option>');
						HTP.P('<option value="mobile">MOBILE</option>');
						HTP.P('<option value="nenhum">NENHUM</option>');
					END IF;
				HTP.P('</select>');
			HTP.P('</span>');
	    HTP.P('</li>');

		HTP.P('<li style="'||WS_HIDDEN||'">');
		    HTP.P('<span class="before">'||FUN.LANG('Alinhamento do dashboard')||'</span>');
	        HTP.P('<span class="after">');
				HTP.P('<select onchange="update_prop('''||WS_PAR_SUMARY||''', ''flex_tela'', this.value);">');
					FCL.FORMSELECTOPTION(FUN.LANG('Linhas'),'column', FPDATA(WS_SCR.FLEX_FLOW,'column','SELECTED',''));
					FCL.FORMSELECTOPTION(FUN.LANG('Colunas'),'row', FPDATA(WS_SCR.FLEX_FLOW,'row','SELECTED',''));
				HTP.FORMSELECTCLOSE;
			HTP.P('</span>');
	    HTP.P('</li>');

		HTP.P('<li style="'||WS_HIDDEN||'">');
			HTP.P('<span class="before">Time Refresh</span>');
	        HTP.P('<span class="after">');
				HTP.P('<select onchange="update_prop('''||WS_PAR_SUMARY||''', ''timer_tela'', this.value);">');
					IF WS_SCR.TIMER = '0' THEN
						HTP.P('<option value="0" selected="selected">'||FUN.LANG('nunca')||'</option>');
					ELSE
						HTP.P('<option value="0">'||FUN.LANG('nunca')||'</option>');
					END IF;
					IF WS_SCR.TIMER = '600000' THEN
						HTP.P('<option value="600000" selected="selected">10m</option>');
					ELSE
						HTP.P('<option value="600000">10m</option>');
					END IF;
					IF WS_SCR.TIMER = '1200000' THEN
						HTP.P('<option value="1200000" selected="selected">20m</option>');
					ELSE
						HTP.P('<option value="1200000">20m</option>');
					END IF;
					IF WS_SCR.TIMER = '1800000' THEN
						HTP.P('<option value="1800000" selected="selected">30m</option>');
					ELSE
						HTP.P('<option value="1800000">30m</option>');
					END IF;
					IF WS_SCR.TIMER = '3600000' THEN
						HTP.P('<option value="3600000" selected="selected">1h</option>');
					ELSE
						HTP.P('<option value="3600000">1h</option>');
					END IF;
					IF WS_SCR.TIMER = '7200000' THEN
						HTP.P('<option value="7200000" selected="selected">2h</option>');
					ELSE
						HTP.P('<option value="7200000">2h</option>');
					END IF;
				HTP.P('</select>');
			HTP.P('</span>');
		HTP.P('</li>');

		HTP.P('<li>');
		    HTP.P('<span class="before">'||FUN.LANG('Observa&ccedil;&atilde;o')||'</span>');
			HTP.P('<span class="after">');
                HTP.P('<textarea onblur="update_prop('''||WS_PAR_SUMARY||''', ''descritivo'', this.value);">'||WS_DESC||'</textarea>');
		    HTP.P('</span>');
		HTP.P('</li>');

		












	
	IF WS_PAR_SUMARY <> 'DEFAULT' THEN
		BEGIN
			



			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('PERMISS&Atilde;O')||'</span>');
				HTP.P('<span class="after">');
					
					FCL.FAKEOPTION('fake-usuarios', 'Permiss&otilde;es', '', 'lista-usuarios-grupos', 'N', 'S', '', FUN.LANG('PERMISS&Atilde;O DE USU&Aacute;RIOS'), WS_PAR_SUMARY);
				HTP.P('</span>');
			HTP.P('</li>');
		EXCEPTION WHEN OTHERS THEN
            HTP.P('');
		END;

	END IF;

	

		IF WS_PAR_SUMARY <> 'DEFAULT' THEN

			WS_MANUTENCAO := FUN.GETPROP(WS_PAR_SUMARY,'MANUTENCAO');
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||fun.lang('MANUTEN&Ccedil;&Atilde;O')||'</span>');
				HTP.P('<span class="after">');
					HTP.P('<a class="script" onclick="update_prop('''||WS_PAR_SUMARY||''', ''manutencao'', this.nextElementSibling.title);"></a>');
					IF WS_MANUTENCAO = 'S' THEN
						HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||WS_MANUTENCAO||'"></span>');
					ELSE
						HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||WS_MANUTENCAO||'"></span>');
					END IF;
				HTP.P('</span>');
			HTP.P('</li>');
			
			

			





		
			BEGIN
				SELECT CODE INTO WS_TOKEN FROM BI_TOKEN WHERE USUARIO = WS_USUARIO AND STATUS = 'D' AND TELA = WS_PAR_SUMARY;
			EXCEPTION WHEN OTHERS THEN
				WS_TOKEN := '0';
			END;
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||fun.lang('TOKEN')||'</span>');
				HTP.P('<span class="after">');
						
					HTP.P('<a onclick="call(''getToken'', ''prm_usuario='||WS_USUARIO||'&prm_screen='||WS_PAR_SUMARY||''', ''gbl'').then(function(res){ if(res != ''0''){ get(''screen-token'').value = res; alerta(''feed-fixo'', ''Token alterado!''); } });"><svg style="height: 18px;" version="1.1"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 612 612" style="enable-background:new 0 0 612 612;" xml:space="preserve"> <g> <g> <path d="M175.446,330.878l58.523-58.523c15.499-15.5,15.499-40.63,0-56.13c-15.502-15.499-40.628-15.499-56.13,0l-15.357,15.356 v-80.829c0-3.216,2.622-5.833,5.845-5.833h275.366c3.211,0,5.826,2.617,5.826,5.833v45.581c0,21.919,17.768,39.688,39.688,39.688 c21.919,0,39.688-17.768,39.688-39.688v-45.581c0-46.984-38.219-85.207-85.201-85.207H168.327 c-46.99,0-85.218,38.223-85.218,85.207v80.829l-15.356-15.356c-15.502-15.499-40.628-15.499-56.13,0 c-15.499,15.5-15.499,40.63,0,56.13l58.523,58.523c14.064,14.063,32.762,21.807,52.651,21.807 C142.688,352.685,161.387,344.939,175.446,330.878z"/> <path d="M600.376,339.641l-58.523-58.523c-14.064-14.063-32.762-21.807-52.652-21.807c-19.889,0-38.586,7.746-52.645,21.808 l-58.52,58.523c-15.499,15.502-15.499,40.63,0,56.128c7.751,7.749,17.907,11.625,28.065,11.623 c10.154,0,20.317-3.875,28.065-11.625l15.356-15.357v80.833c0,3.218-2.622,5.837-5.843,5.837H168.31 c-3.211,0-5.828-2.619-5.828-5.837v-45.581c0-21.919-17.766-39.688-39.686-39.688s-39.688,17.768-39.688,39.688v45.581 c0,46.986,38.219,85.211,85.2,85.211h275.366c46.99,0,85.218-38.225,85.218-85.211v-80.826l15.352,15.352 c15.502,15.499,40.628,15.499,56.13,0C615.875,380.271,615.875,355.143,600.376,339.641z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
					HTP.P('<input type="text" id="screen-token" readonly class="readonly" value="'||WS_TOKEN||'" style="width: 170px;"/>');
				HTP.P('</span>');
			HTP.P('</li>');
		
		
		END IF;

	HTP.P('</ul>');

	HTP.P('</div>');

	FCL.CLOSER_MENU;

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END SCREEN_PROP;


PROCEDURE SAVESCR ( P_SCREEN         VARCHAR2 DEFAULT NULL,
					P_DESCRICAO		 VARCHAR2 DEFAULT NULL,
					P_PUBLICO		 VARCHAR2 DEFAULT NULL,
					P_DS_SCREEN		 VARCHAR2 DEFAULT NULL,
					P_FUNCAO		 VARCHAR2 DEFAULT NULL,
					P_GRUPOF		 VARCHAR2 DEFAULT NULL,
					P_COR_FUNDO		 VARCHAR2 DEFAULT NULL,
					P_URL_FUNDO		 VARCHAR2 DEFAULT NULL,
					P_OR_GRUPO		 VARCHAR2 DEFAULT NULL,
					P_OR_ITEM		 VARCHAR2 DEFAULT 0,
					P_DISPOSITIVO    VARCHAR2 DEFAULT NULL,
					ACT_SCREEN		 VARCHAR2 DEFAULT NULL,
					P_TIMER          NUMBER,
					P_FLEX		     VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT      NUMBER;
	WS_TEXTO      VARCHAR2(200);
	WS_PADRAO     VARCHAR2(40);
	WS_DESC       VARCHAR2(400);
    WS_DESCRITIVO VARCHAR2(400);
	WS_USUARIO    VARCHAR2(80);
	
	WS_NOUSER     EXCEPTION;

BEGIN
	FCL.REFRESH_SESSION;

	WS_USUARIO    := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

    WS_DESC       := FUN.CONVERTE(P_DESCRICAO);
	WS_DESCRITIVO := FUN.CONVERTE(P_DS_SCREEN);

	SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO='CD_LINGUAGEM';

    IF WS_COUNT = 1 THEN
		SELECT CONTEUDO INTO WS_PADRAO
		FROM   PARAMETRO_USUARIO
		WHERE  CD_USUARIO = WS_USUARIO AND
		CD_PADRAO='CD_LINGUAGEM';
	ELSE
	    WS_PADRAO := 'PORTUGUESE';
	END IF;

	IF  ACT_SCREEN = 'DEFAULT' THEN
	    INSERT INTO OBJECT_LOCATION
		SELECT 'DWU', 'DEFAULT',UPPER(REPLACE(TRIM(P_SCREEN),' ','_')), OBJECT_ID, POSX, POSY, 'auto', '0'
		FROM	OBJECT_LOCATION
		WHERE	SCREEN = 'DEFAULT' AND
		NAVEGADOR = 'DEFAULT' AND
		OBJECT_ID NOT IN ('toolbar','newquery');
	END IF;

	IF  P_FUNCAO = 'G' THEN
	    SELECT COUNT(*) INTO WS_COUNT FROM ALL_SCREENS WHERE SCREEN = UPPER(TRIM(P_SCREEN));
		IF WS_COUNT = 0 THEN
		    INSERT INTO ALL_SCREENS
			    ( OWNER, SCREEN, DESCRICAO, DS_SCREEN, DT_CRIACAO, DT_ULTIMA_ALTERACAO, PUBLICO, COR_FUNDO, URL_FUNDO, OR_GRUPO, OR_ITEM, TIMER )
		    VALUES
			    ( 'DWU', UPPER(REPLACE(TRIM(P_SCREEN),' ','_')), WS_DESC, P_DS_SCREEN, SYSDATE, SYSDATE, P_PUBLICO, P_COR_FUNDO, P_URL_FUNDO, P_OR_GRUPO, P_OR_ITEM, (P_TIMER*1000) );
		    INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO)
			    VALUES ( UPPER(REPLACE(TRIM(P_SCREEN),' ','_')), P_GRUPOF, WS_DESC, '', 'SCREEN', GBL.GETUSUARIO, '', SYSDATE, P_DS_SCREEN );
			INSERT INTO USER_SCREENS VALUES('DWU', UPPER(REPLACE(TRIM(P_SCREEN),' ','_')), 'A');
		    COMMIT;
		ELSE
		    HTP.P('#alert '||FUN.LANG('J&aacute; existe uma tela com este nome')||'!');
	    END IF;
	ELSE

		SELECT COUNT(*) INTO WS_COUNT FROM TRADUCAO_COLUNAS
		WHERE CD_TABELA = P_SCREEN AND
		CD_COLUNA = 'NM_OBJETO';

		IF WS_COUNT = 1 THEN
			UPDATE TRADUCAO_COLUNAS
			SET TEXTO = WS_DESC
			WHERE CD_TABELA = P_SCREEN AND
			CD_COLUNA = 'NM_OBJETO' AND
			CD_LINGUAGEM = WS_PADRAO AND
			LANG_DEFAULT = (SELECT DESCRICAO FROM ALL_SCREENS WHERE SCREEN = UPPER(REPLACE(TRIM(P_SCREEN),' ','_')));

			IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
				UPDATE TRADUCAO_COLUNAS
				SET LANG_DEFAULT = WS_DESC
				WHERE CD_TABELA = P_SCREEN AND
				CD_COLUNA = 'NM_OBJETO' AND
				LANG_DEFAULT = (SELECT DESCRICAO FROM ALL_SCREENS WHERE SCREEN = UPPER(REPLACE(TRIM(P_SCREEN),' ','_')));
			END IF;
		ELSIF WS_COUNT = 0 THEN
			IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
				INSERT INTO TRADUCAO_COLUNAS VALUES (P_SCREEN, 'NM_OBJETO', WS_PADRAO, WS_DESC, WS_DESC, 'O', 'N');
			END IF;
		ELSE
		    HTP.P('N');
		END IF;

		UPDATE ALL_SCREENS SET
			DESCRICAO 		= WS_DESC,
			PUBLICO   		= P_PUBLICO,
			DS_SCREEN 		= P_DS_SCREEN,
			COR_FUNDO		= P_COR_FUNDO,
			URL_FUNDO		= P_URL_FUNDO,
			OR_GRUPO		= P_OR_GRUPO,
			OR_ITEM			= P_OR_ITEM,
			DT_ULTIMA_ALTERACAO	= SYSDATE,
			TIMER           = P_TIMER,
			DISPOSITIVO     = P_DISPOSITIVO,
			FLEX_FLOW       = P_FLEX
		WHERE OWNER = 'DWU' AND
		      SCREEN = P_SCREEN;
		UPDATE OBJETOS SET
			CD_GRUPO		= P_GRUPOF,
			NM_OBJETO 		= WS_DESC,
			DS_OBJETO 		= P_DS_SCREEN,
			DT_ULTIMA		= SYSDATE
		WHERE CD_OBJETO  = P_SCREEN AND
		      TP_OBJETO  = 'SCREEN';
		COMMIT;
	END IF;

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END SAVESCR;



PROCEDURE SAVEPA ( P_VL_SALVO       VARCHAR2 DEFAULT NULL,
				   P_CD_MICRO_VISAO	VARCHAR2 DEFAULT NULL,
				   P_PARAMETROS		VARCHAR2 DEFAULT NULL,
				   P_CD_PONTO		VARCHAR2 DEFAULT NULL,
				   P_NM_PONTO		VARCHAR2 DEFAULT NULL,
				   P_SUB_PONTO		VARCHAR2 DEFAULT NULL,
				   P_AR_DIARIO		VARCHAR2 DEFAULT NULL,
				   P_AR_MENSAL		VARCHAR2 DEFAULT NULL,
				   P_AR_ANUAL		VARCHAR2 DEFAULT NULL,
				   P_FILTROS		VARCHAR2 DEFAULT NULL,
				   P_CD_VISAO		VARCHAR2 DEFAULT NULL,
				   P_TP_RENOVACAO	VARCHAR2 DEFAULT NULL,
				   P_DS_PONTO		VARCHAR2 DEFAULT NULL,
				   P_TIPO		    VARCHAR2 DEFAULT NULL,
				   P_FUNCAO		    VARCHAR2 DEFAULT NULL,
				   FAKEOPTION		VARCHAR2 DEFAULT NULL,
				   PCS_PARAMETROS	VARCHAR2 DEFAULT '1|1',
				   PCS_COLUNA	 	VARCHAR2 DEFAULT NULL,
				   PCS_AGRUPADOR	VARCHAR2 DEFAULT NULL,
				   PCS_RP		    VARCHAR2 DEFAULT 'ROLL',
				   PCS_COLUP	 	VARCHAR2 DEFAULT NULL ) AS

	PRM_PONTO  VARCHAR2(20);
	PRM_NPONTO NUMBER;
	WS_COUNTER NUMBER;
	WS_TEXTO   VARCHAR2(200);
	WS_COUNT   NUMBER;
    WS_NOME    VARCHAR2(200);

	CURSOR CRS_FILTROS IS
	SELECT CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO
	FROM FILTROS
	WHERE MICRO_VISAO = P_CD_MICRO_VISAO AND CD_OBJETO = (SELECT CD_OBJETO FROM FILTROS WHERE MICRO_VISAO = P_CD_MICRO_VISAO AND ROWNUM = 1 AND TP_FILTRO = 'objeto')  AND TP_FILTRO = 'objeto';

	WS_FILTRO CRS_FILTROS%ROWTYPE;

	WS_PADRAO  VARCHAR2(40);
	WS_PONTO   VARCHAR2(800);
	WS_SUB     VARCHAR2(800);
    WS_DESC    VARCHAR2(800);
	WS_USUARIO VARCHAR2(80);

	WS_NOUSER  EXCEPTION;

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;
    
	WS_PONTO   := FUN.CONVERTE(P_NM_PONTO);
	WS_SUB     := FUN.CONVERTE(P_SUB_PONTO);
    WS_DESC    := FUN.CONVERTE(P_DS_PONTO);
	WS_NOME    := FUN.CONVERTE(WS_PONTO);

    SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO='CD_LINGUAGEM';

    IF WS_COUNT = 1 THEN
		SELECT CONTEUDO INTO WS_PADRAO
		FROM   PARAMETRO_USUARIO
		WHERE  CD_USUARIO = WS_USUARIO AND
		CD_PADRAO='CD_LINGUAGEM';
	ELSE
	    WS_PADRAO := 'PORTUGUESE';
	END IF;

	IF  P_FUNCAO = 'G' THEN

	    SELECT COUNT(*) INTO WS_COUNTER FROM PONTO_AVALIACAO WHERE CD_PONTO = UPPER(REPLACE(P_CD_PONTO,' ','_'));
		
		IF WS_COUNTER = 0 THEN
			IF  P_TIPO NOT IN ('ICONE','CALL_LIST','FILE','IMAGE','TEXTO') THEN
			INSERT INTO PONTO_AVALIACAO
				( VL_SALVO, CD_MICRO_VISAO, PARAMETROS, CD_PONTO, NM_PONTO, AR_DIARIO, AR_MENSAL, AR_ANUAL, CD_VISAO, TP_RENOVACAO, DS_PONTO, CD_USUARIO, DT_ULTIMA, DT_CRIACAO, ST_FILTROS, CS_PARAMETROS, CS_COLUNA, CS_AGRUPADOR, CS_RP, CS_COLUP )
			VALUES
				( TRIM(P_VL_SALVO), TRIM(P_CD_MICRO_VISAO), TRIM(P_PARAMETROS), UPPER(REPLACE(P_CD_PONTO,' ','_')), WS_PONTO, FCL.FPDATA(P_AR_DIARIO,'on','S','N'), FCL.FPDATA(P_AR_MENSAL,'on','S','N'), FCL.FPDATA(P_AR_ANUAL,'on','S','N'), TRIM(P_CD_VISAO), TRIM(P_TP_RENOVACAO), TRIM(P_DS_PONTO), 'DWU', SYSDATE, SYSDATE, 'A', PCS_PARAMETROS, PCS_COLUNA, PCS_AGRUPADOR, PCS_RP, PCS_COLUP );
			END IF;
			INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES ( UPPER(REPLACE(TRIM(P_CD_PONTO),' ','_')), FAKEOPTION, WS_PONTO, P_SUB_PONTO, P_TIPO, GBL.GETUSUARIO, '', SYSDATE, P_DS_PONTO );

			INSERT INTO OBJECT_ATTRIB SELECT 'DWU','DEFAULT','DEFAULT', UPPER(REPLACE(TRIM(P_CD_PONTO),' ','_')), CD_PROP, VL_DEFAULT FROM OBJECT_PADRAO WHERE TP_OBJETO = P_TIPO;
			COMMIT;
		ELSE
		    HTP.P('#alert '||FUN.LANG('Ponto de avalia&ccedil;&atilde;o j&aacute; existe')||'!');
		END IF;
	ELSE
	    IF P_TIPO NOT IN ('ICONE','CALL_LIST','FILE','IMAGE','TEXTO') THEN

			UPDATE TRADUCAO_COLUNAS
			SET TEXTO = WS_NOME
			WHERE CD_TABELA  = P_CD_PONTO AND
			CD_COLUNA   = 'NM_OBJETO' AND
			LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_PONTO) AND
			CD_LINGUAGEM = WS_PADRAO;

			IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
			    UPDATE TRADUCAO_COLUNAS
			    SET LANG_DEFAULT = WS_NOME
			    WHERE CD_TABELA  = P_CD_PONTO AND
			    CD_COLUNA   = 'NM_OBJETO' AND
			    LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_PONTO);

				BEGIN
					UPDATE PONTO_AVALIACAO SET
					VL_SALVO	 = TRIM(P_VL_SALVO),
					CD_MICRO_VISAO	 = TRIM(P_CD_MICRO_VISAO),
					NM_PONTO	 = WS_NOME,
					AR_DIARIO	 = FCL.FPDATA(P_AR_DIARIO,'on','S','N'),
					AR_MENSAL	 = FCL.FPDATA(P_AR_MENSAL,'on','S','N'),
					AR_ANUAL	 = FCL.FPDATA(P_AR_ANUAL,'on','S','N'),
					CD_VISAO	 = TRIM(P_CD_VISAO),
					TP_RENOVACAO	 = TRIM(P_TP_RENOVACAO),
					DS_PONTO	 = TRIM(P_DS_PONTO),
					DT_ULTIMA	 = SYSDATE,
					CS_PARAMETROS	 = PCS_PARAMETROS,
					CS_COLUNA	 = PCS_COLUNA,
					CS_AGRUPADOR	 = PCS_AGRUPADOR,
					CS_RP		 = PCS_RP,
					CS_COLUP	 = PCS_COLUP
					WHERE CD_USUARIO = 'DWU' AND CD_PONTO = P_CD_PONTO;
				EXCEPTION WHEN OTHERS THEN
					HTP.P(SQLERRM);
				END;

			ELSE
			    UPDATE PONTO_AVALIACAO SET
				VL_SALVO	 = TRIM(P_VL_SALVO),
				CD_MICRO_VISAO	 = TRIM(P_CD_MICRO_VISAO),
				NM_PONTO	 = WS_NOME,
				AR_DIARIO	 = FCL.FPDATA(P_AR_DIARIO,'on','S','N'),
				AR_MENSAL	 = FCL.FPDATA(P_AR_MENSAL,'on','S','N'),
				AR_ANUAL	 = FCL.FPDATA(P_AR_ANUAL,'on','S','N'),
				CD_VISAO	 = TRIM(P_CD_VISAO),
				TP_RENOVACAO	 = TRIM(P_TP_RENOVACAO),
				DS_PONTO	 = TRIM(P_DS_PONTO),
				DT_ULTIMA	 = SYSDATE,
				CS_PARAMETROS	 = PCS_PARAMETROS,
				CS_COLUNA	 = PCS_COLUNA,
				CS_AGRUPADOR	 = PCS_AGRUPADOR,
				CS_RP		 = PCS_RP,
				CS_COLUP	 = PCS_COLUP
				WHERE CD_USUARIO = 'DWU' AND CD_PONTO = P_CD_PONTO;
			END IF;
	    END IF;
		IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
	        UPDATE OBJETOS
			SET NM_OBJETO  = WS_NOME,
			CD_GRUPO   = TRIM(FAKEOPTION),
			DS_OBJETO  = TRIM(P_DS_PONTO),
			SUBTITULO  = TRIM(P_SUB_PONTO),
			DT_ULTIMA  = SYSDATE
			WHERE CD_USUARIO = 'DWU' AND CD_OBJETO = P_CD_PONTO; 
		ELSE
		    UPDATE OBJETOS
			SET CD_GRUPO = TRIM(FAKEOPTION),
			DS_OBJETO  = TRIM(P_DS_PONTO),
			SUBTITULO  = TRIM(P_SUB_PONTO),
			DT_ULTIMA  = SYSDATE
			WHERE CD_USUARIO = 'DWU' AND CD_OBJETO = P_CD_PONTO; 
		END IF;
	END IF;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END SAVEPA;

PROCEDURE SAVE_PWD ( PRM_SENHA  VARCHAR2 DEFAULT NULL,
		             
                     PRM_EMAIL  VARCHAR2 DEFAULT NULL,
					 PRM_NUMBER VARCHAR2 DEFAULT NULL,
					 PRM_USER   VARCHAR2 DEFAULT NULL,
					 PRM_NOME   VARCHAR2 DEFAULT NULL ) AS

	WS_ERRO             EXCEPTION;
	WS_CMD              VARCHAR2(4000);
	WS_NOKILL           EXCEPTION;
	WS_USUARIO          VARCHAR2(80);
	WS_VRF              VARCHAR2(10);

BEGIN
    

    WS_USUARIO := GBL.GETUSUARIO;

    IF LENGTH(TRIM(PRM_SENHA)) > 0 THEN
        
		IF NVL(FUN.RET_VAR('XE'), 'N') = 'S' THEN

			BEGIN
				WS_CMD := 'BEGIN execute immediate '''||FUN.RET_VAR('ALTER_USER')||' alter user '||CHR(34)||TRIM(UPPER(NVL(PRM_USER, WS_USUARIO)))||CHR(34)||' identified by '||CHR(34)||TRIM(PRM_SENHA)||CHR(34)||' ''; END ';
				FUN.EXECUTE_NOW(WS_CMD);
				WS_CMD := 'BEGIN execute immediate ''alter user '||CHR(34)||TRIM(UPPER(NVL(PRM_USER, WS_USUARIO)))||CHR(34)||' account unlock''; END ';
				FUN.EXECUTE_NOW(WS_CMD);
			EXCEPTION WHEN OTHERS THEN
				RAISE WS_ERRO;
			END;

		ELSE
		
			WS_VRF := FUN.DIGESTPASSWORD(PRM_USER, PRM_SENHA);
			
			IF WS_VRF <> 'Y' THEN
				RAISE WS_ERRO;
			END IF;

		END IF;
		

        BEGIN
			DELETE FROM BI_SESSAO WHERE VALOR = TRIM(UPPER(NVL(PRM_USER, WS_USUARIO)));
			COMMIT;
			
		EXCEPTION WHEN OTHERS THEN
		    RAISE WS_NOKILL;
		END;

	END IF;

	IF NVL(PRM_EMAIL, 'N/A') <> 'N/A' THEN
		UPDATE USUARIOS SET
		USU_EMAIL = TRIM(PRM_EMAIL)
		WHERE TRIM(USU_NOME) = WS_USUARIO;
	END IF;

	IF NVL(PRM_NUMBER, 'N/A') <> 'N/A' THEN
		UPDATE USUARIOS SET
		USU_NUMBER = TRIM(PRM_NUMBER)
		WHERE TRIM(USU_NOME) = WS_USUARIO;
	END IF;

	IF NVL(PRM_NOME, 'N/A') <> 'N/A' THEN
		UPDATE USUARIOS SET
		USU_COMPLETO = TRIM(PRM_NOME)
		WHERE TRIM(USU_NOME) = WS_USUARIO;
	END IF;

    insert into log_eventos values(sysdate, 'ATUALIZACAO USUARIO[save_pwd]', ws_usuario, 'TELA', 'USUARIO', '01');
    COMMIT;

    INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Altera&ccedil;&atilde;o de Senha do usu&aacute;rio '||NVL(PRM_USER, WS_USUARIO)||'', WS_USUARIO, 'EVENTO');
    COMMIT;

EXCEPTION

    WHEN WS_ERRO THEN
	    HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel alterar a senha, Erro de permiss&atilde;o !'));
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_PWD', WS_USUARIO, 'ERRO');
        COMMIT;

	WHEN WS_NOKILL THEN
	    HTP.P('#alert '||FUN.LANG('Senha alterada, mas n&atilde;o foi poss&iacute;vel derrubar a sess&atilde;o')||'!');
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - SAVE_PWD', WS_USUARIO, 'ERRO');
        COMMIT;

	WHEN OTHERS THEN
		IF SUBSTR(SQLERRM, 0, 9) = 'ORA-01031' THEN
		    HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel alterar a senha, usu&aacute;rio sem privil&eacute;gios para esta opera&ccedil;&atilde;o')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Erro ao alterar os dados')||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		END IF;

END SAVE_PWD;


PROCEDURE SAVECALC ( P_CD_COLUNA	VARCHAR2 DEFAULT NULL,
				     P_CD_GRUPO		VARCHAR2 DEFAULT NULL,
				     P_NM_ROTULO	VARCHAR2 DEFAULT NULL,
				     P_COLUNA		VARCHAR2 DEFAULT NULL,
				     P_OBJETO		VARCHAR2 DEFAULT NULL,
				     P_OPERACAO		VARCHAR2 DEFAULT NULL,
				     P_ST_FORMULA	VARCHAR2 DEFAULT NULL,
				     P_FUNCAO		VARCHAR2 DEFAULT NULL,
				     P_ST_AGRUPADOR	VARCHAR2 DEFAULT NULL,
				     P_MVISAO		VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	IF  P_FUNCAO = 'G' THEN
	    INSERT INTO MICRO_COLUNA
		( CD_MICRO_VISAO,	CD_COLUNA,	NM_ROTULO,
		  ST_GERA_REL,		ST_AGRUPADOR,	NM_MASCARA,
		  CD_LIGACAO,		ST_COM_CODIGO,	ST_ALINHAMENTO,
		  ST_RESUMIDO,		ST_NEGRITO,	ST_INVISIVEL,
		  HINT, NM_UNIDADE,		FORMULA,	TIPO,
          ROTULO_C, COLOR, FLEXCOL, LIMITE, URL, ANOTACAO)
	    VALUES
	        ( P_MVISAO,		P_CD_COLUNA,	P_NM_ROTULO,
	          'N',			P_ST_AGRUPADOR,	'VALOR',
	          'SEM',		'N',		'LEFT',
	          'N',			'N',		'N','',
	          ' ',			P_ST_FORMULA,	'C', '', '', '', '', '', '');
	ELSE
 	    UPDATE MICRO_COLUNA SET
		NM_ROTULO	= RTRIM(P_NM_ROTULO),
		ST_AGRUPADOR	= RTRIM(P_ST_AGRUPADOR),
		FORMULA		= P_ST_FORMULA
	    WHERE
	    	CD_MICRO_VISAO=P_MVISAO AND
	    	CD_COLUNA=P_CD_COLUNA;
	    COMMIT;
	END IF;

	FCL.LOAD_MVIEW(P_CD_GRUPO, P_MVISAO);

END SAVECALC;



PROCEDURE SAVEVP ( P_FUNCAO		VARCHAR2 DEFAULT NULL,
		   P_CD_PADRAO		VARCHAR2 DEFAULT NULL,
		   P_NM_PADRAO		VARCHAR2 DEFAULT NULL,
		   P_TP_PADRAO		VARCHAR2 DEFAULT NULL,
		   P_CD_LIGACAO		VARCHAR2 DEFAULT NULL,
           P_STATUS		    VARCHAR2 DEFAULT NULL,
           P_ORDEM          NUMBER DEFAULT 1 ) AS

	WS_TP_PADRAO		VARCHAR2(20);

BEGIN
    
	IF  P_CD_LIGACAO <> 'SEM' THEN
	    WS_TP_PADRAO := 'LIGACAO';
	ELSE
	    WS_TP_PADRAO := P_TP_PADRAO;
	END IF;

	IF  P_FUNCAO = 'G' THEN
	    INSERT INTO PARAMETRO_PADRAO
		   ( CD_PADRAO, NM_PADRAO, TP_PADRAO, CD_LIGACAO, STATUS, ORDEM )
	    VALUES
		   ( UPPER(P_CD_PADRAO), P_NM_PADRAO, WS_TP_PADRAO, P_CD_LIGACAO, 'A', P_ORDEM );
	    COMMIT;
	ELSE
	    UPDATE PARAMETRO_PADRAO SET
		   NM_PADRAO  = RTRIM(P_NM_PADRAO),
		   TP_PADRAO  = RTRIM(WS_TP_PADRAO),
		   CD_LIGACAO = RTRIM(P_CD_LIGACAO),
		   STATUS = RTRIM(P_STATUS),
		   ORDEM = RTRIM(P_ORDEM)
	    WHERE  CD_PADRAO = P_CD_PADRAO;
	    COMMIT;
	END IF;

END SAVEVP;



PROCEDURE SAVEGD ( P_CD_MICRO_VISAO VARCHAR2 DEFAULT NULL,
				   P_FUNCAO         VARCHAR2 DEFAULT NULL,
				   P_CD_OBJETO		VARCHAR2 DEFAULT NULL,
				   P_NM_OBJETO		VARCHAR2 DEFAULT NULL,
				   P_SUB_OBJETO		VARCHAR2 DEFAULT NULL,
				   P_ATRIBUTOS		VARCHAR2 DEFAULT NULL,
				   FAKEOPTION		VARCHAR2 DEFAULT NULL,
				   P_TP_OBJETO		VARCHAR2 DEFAULT NULL,
				   P_DS_OBJETO		VARCHAR2 DEFAULT NULL,
				   P_CS_COLUP       VARCHAR2 DEFAULT NULL ) AS

    TIPO           VARCHAR2(200);
    ALTURA         VARCHAR2(60);
    LARGURA        VARCHAR2(60);
    WS_COMB        VARCHAR2(2000);
    WS_COUNT       NUMBER;
    WS_TEXTO       VARCHAR2(200);
    WS_PADRAO      VARCHAR2(40);
    WS_LOOP1       VARCHAR2(50);
    WS_LOOP2       VARCHAR2(50);
	WS_CURSOR	   INTEGER;
	WS_SQL		   VARCHAR2(2000);
	WS_CODIGO      VARCHAR2(30);
	WS_LINHAS      INTEGER;
	WS_VALOR       VARCHAR2(2000);
	WS_3D          CHAR(1);
    WS_CONVERT     VARCHAR2(800);
    WS_CONVERT_DS  VARCHAR2(800);
	WS_SUB         VARCHAR2(800);
	WS_ATRIB       VARCHAR2(800);
	WS_USUARIO     VARCHAR2(80);
BEGIN

    

	WS_USUARIO    := GBL.GETUSUARIO;

	WS_CONVERT    := FUN.CONVERTE(P_NM_OBJETO);
    WS_CONVERT_DS := FUN.CONVERTE(P_DS_OBJETO);
	WS_SUB        := FUN.CONVERTE(P_SUB_OBJETO);
	WS_ATRIB      := FUN.CONVERTE(P_ATRIBUTOS);

    SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO='CD_LINGUAGEM';

    BEGIN
		IF WS_COUNT = 1 THEN
			SELECT CONTEUDO INTO WS_PADRAO
			FROM   PARAMETRO_USUARIO
			WHERE  CD_USUARIO = WS_USUARIO AND
			CD_PADRAO='CD_LINGUAGEM';
		ELSE
			WS_PADRAO := 'PORTUGUESE';
		END IF;
	END;

 IF P_FUNCAO = 'G' THEN
     SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO;
     IF WS_COUNT = 0 THEN
	    INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES ( UPPER(P_CD_OBJETO), FAKEOPTION, WS_CONVERT, P_SUB_OBJETO, P_TP_OBJETO, GBL.GETUSUARIO, WS_ATRIB, SYSDATE, WS_CONVERT_DS );

        
		
		BEGIN
			IF TRIM(P_TP_OBJETO) = 'FLOAT_FILTER' OR TRIM(P_TP_OBJETO) = 'FLOAT_PAR' THEN
				SELECT NDS_CD_CODIGO, NDS_TFISICA INTO WS_LOOP1, WS_LOOP2 FROM CODIGO_DESCRICAO WHERE NDS_TABELA = (SELECT CD_LIGACAO FROM PARAMETRO_PADRAO WHERE CD_PADRAO = REPLACE(P_CD_OBJETO, '_FILTER', ''));
				WS_SQL := 'select '||TRIM(WS_LOOP1)||' from '||TRIM(WS_LOOP2)||'';
				WS_CURSOR := DBMS_SQL.OPEN_CURSOR;
				DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 60);

				WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

				LOOP
					WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
					IF WS_LINHAS <> 1 THEN
						EXIT;
					END IF;

					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
					WS_VALOR := WS_VALOR||'|'||WS_CODIGO;
				END LOOP;

				INSERT INTO OBJECT_ATTRIB VALUES ('DWU','DEFAULT','DEFAULT', P_CD_OBJETO, 'LIMITADORES', WS_VALOR);
			END IF;
		EXCEPTION WHEN OTHERS THEN
			HTP.P('Limitadores não criados!');
		END;

	 ELSE
	     HTP.P('#alert '||FUN.LANG('Objeto j&aacute; existe!'));
	 END IF;
 ELSE
    
	IF P_TP_OBJETO = 'TEXTO' THEN

		SELECT ATRIBUTOS INTO WS_TEXTO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO;

		UPDATE TRADUCAO_COLUNAS SET
	    TEXTO = WS_ATRIB
	    WHERE CD_TABELA = P_CD_OBJETO AND
	    CD_LINGUAGEM = WS_PADRAO AND
	    CD_COLUNA = 'ATRIBUTOS' AND
	    LANG_DEFAULT = WS_TEXTO;

		IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
			UPDATE TRADUCAO_COLUNAS SET
			LANG_DEFAULT = WS_ATRIB
			WHERE CD_TABELA = P_CD_OBJETO AND
			CD_COLUNA = 'ATRIBUTOS' AND
			LANG_DEFAULT = WS_TEXTO;
		END IF;

	END IF;

    UPDATE TRADUCAO_COLUNAS SET
	TEXTO = WS_CONVERT
	WHERE CD_TABELA = P_CD_OBJETO AND
	CD_LINGUAGEM = WS_PADRAO AND
	CD_COLUNA = 'NM_OBJETO' AND
	LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO);

	IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
		UPDATE TRADUCAO_COLUNAS SET
		LANG_DEFAULT = WS_CONVERT
		WHERE CD_TABELA = P_CD_OBJETO AND
		CD_COLUNA = 'NM_OBJETO' AND
		LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO);

		UPDATE OBJETOS SET
		CD_GRUPO       = RTRIM(FAKEOPTION),
		NM_OBJETO      = WS_CONVERT,
		SUBTITULO      = WS_SUB,
		TP_OBJETO      = RTRIM(P_TP_OBJETO),
		CD_USUARIO   = 'DWU',
		DT_ULTIMA      = SYSDATE,
		ATRIBUTOS   = P_ATRIBUTOS,
		DS_OBJETO   = WS_CONVERT_DS
		WHERE  CD_OBJETO = P_CD_OBJETO;

		UPDATE PONTO_AVALIACAO SET
		CS_COLUP = P_CS_COLUP,
		NM_PONTO = WS_CONVERT
		WHERE CD_PONTO = P_CD_OBJETO;

	ELSE

		UPDATE OBJETOS SET
		CD_GRUPO       = RTRIM(FAKEOPTION),
		TP_OBJETO      = RTRIM(P_TP_OBJETO),
		CD_USUARIO   = 'DWU',
		DT_ULTIMA      = SYSDATE,
		ATRIBUTOS   = P_ATRIBUTOS,
		DS_OBJETO   = WS_CONVERT_DS
		WHERE  CD_OBJETO = P_CD_OBJETO;

		UPDATE PONTO_AVALIACAO SET
		CS_COLUP = P_CS_COLUP
		WHERE CD_PONTO = P_CD_OBJETO;

	    HTP.P('');
	END IF;

	COMMIT;

 END IF;

  IF RTRIM(P_TP_OBJETO) = 'VALOR' THEN
      HTP.P('<script> parent.chartPercent('''||UPPER(RTRIM(P_CD_OBJETO))||'''); </script>');
  END IF;

  IF RTRIM(P_TP_OBJETO) = 'PIZZA' THEN
      HTP.P('<script> parent.chartSlice('''||UPPER(RTRIM(P_CD_OBJETO))||'''); </script>');
  END IF;

  IF RTRIM(P_TP_OBJETO) = 'ROSCA' THEN
      HTP.P('<script> parent.chartDonut('''||UPPER(RTRIM(P_CD_OBJETO))||'''); </script>');
  END IF;

  IF RTRIM(P_TP_OBJETO) = 'BARRAS' THEN
      HTP.P('<script>parent.chart('''||UPPER(RTRIM(P_CD_OBJETO))||''');</script>');
  END IF;

  IF RTRIM(P_TP_OBJETO) = 'COLUNAS' THEN
      HTP.P('<script>parent.chart('''||UPPER(RTRIM(P_CD_OBJETO))||''');</script>');
  END IF;

  IF RTRIM(P_TP_OBJETO) = 'LINHAS' THEN
      HTP.P('<script>parent.chart('''||UPPER(RTRIM(P_CD_OBJETO))||''');</script>');
  END IF;

  IF RTRIM(P_TP_OBJETO) = 'PONTEIRO' THEN
    HTP.P('<script> parent.chartGauge('||CHR(39)||UPPER(RTRIM(P_CD_OBJETO))||CHR(39)||'); </script>');
    END IF;

EXCEPTION 
    WHEN OTHERS THEN
        HTP.P('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END SAVEGD;


PROCEDURE SAVECALLIST ( P_FUNCAO    VARCHAR2 DEFAULT NULL,
		                P_CD_OBJETO VARCHAR2 DEFAULT NULL,
		                FAKEOPTION	VARCHAR2 DEFAULT NULL,
		                P_NM_OBJETO	VARCHAR2 DEFAULT NULL,
		                P_DS_OBJETO	VARCHAR2 DEFAULT NULL ) AS


    WS_COUNT   NUMBER;
	WS_PADRAO  VARCHAR2(40);
	WS_ERRO    EXCEPTION;
	WS_NOME    VARCHAR2(800);
	WS_DESC    VARCHAR2(800);
    WS_USUARIO VARCHAR2(80);
BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	
	SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO='CD_LINGUAGEM';

	WS_NOME  := FUN.CONVERTE(P_NM_OBJETO);
	WS_DESC  := FUN.CONVERTE(P_DS_OBJETO);

    IF WS_COUNT = 1 THEN
		SELECT CONTEUDO INTO WS_PADRAO
		FROM   PARAMETRO_USUARIO
		WHERE  CD_USUARIO = WS_USUARIO AND
		CD_PADRAO='CD_LINGUAGEM';
	ELSE
	    WS_PADRAO := 'PORTUGUESE';
	END IF;

	IF  P_FUNCAO = 'G' THEN
	    INSERT INTO OBJETOS
		   (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO)
	    VALUES
		   ( P_CD_OBJETO, FAKEOPTION, WS_NOME, '', 'CALL_LIST', GBL.GETUSUARIO, '', SYSDATE, WS_DESC );
	    COMMIT;
	ELSE

	    SELECT COUNT(*) INTO WS_COUNT
          FROM   TRADUCAO_COLUNAS
          WHERE  CD_TABELA    = P_CD_OBJETO AND
                 CD_COLUNA    = 'NM_OBJETO' AND
                 CD_LINGUAGEM = WS_PADRAO AND
                 TIPO         = 'O' AND
                 LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO);

          IF  WS_COUNT = 1 THEN
              UPDATE TRADUCAO_COLUNAS SET TEXTO = WS_NOME
              WHERE  CD_TABELA    = P_CD_OBJETO AND
                     CD_COLUNA    = 'NM_OBJETO' AND
                     CD_LINGUAGEM = WS_PADRAO  AND
                     TIPO         = 'O' AND
                     LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO);
          ELSE
              IF  WS_COUNT = 0 THEN
                  INSERT INTO TRADUCAO_COLUNAS VALUES (P_CD_OBJETO, 'NM_OBJETO', WS_PADRAO, WS_NOME, (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO), 'O', 'N');
              ELSE
                  RAISE WS_ERRO;
              END IF;
         END IF;

		IF WS_PADRAO = FUN.RET_VAR('LANG_SYS') THEN
		    UPDATE TRADUCAO_COLUNAS
		    SET LANG_DEFAULT = WS_NOME
		    WHERE CD_TABELA = P_CD_OBJETO AND
		    CD_COLUNA = 'NM_OBJETO' AND
		    LANG_DEFAULT = (SELECT NM_OBJETO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO);

		    UPDATE OBJETOS SET
			CD_GRUPO = RTRIM(FAKEOPTION),
			NM_OBJETO = WS_NOME,
			TP_OBJETO = 'CALL_LIST',
			CD_USUARIO = 'DWU',
			DT_ULTIMA = SYSDATE,
			ATRIBUTOS = '',
			DS_OBJETO = WS_DESC
			WHERE CD_OBJETO = P_CD_OBJETO;

		ELSE
		   UPDATE OBJETOS SET
			CD_GRUPO = RTRIM(FAKEOPTION),
			TP_OBJETO = 'CALL_LIST',
			CD_USUARIO = 'DWU',
			DT_ULTIMA = SYSDATE,
			ATRIBUTOS = '',
			DS_OBJETO = WS_DESC
			WHERE CD_OBJETO = P_CD_OBJETO;
		END IF;

		COMMIT;
	END IF;
	EXCEPTION WHEN OTHERS THEN
	    HTP.P(SQLERRM);
END SAVECALLIST;





PROCEDURE SAVECD ( P_FUNCAO		        VARCHAR2 DEFAULT NULL,
		           P_NDS_TABELA		    VARCHAR2 DEFAULT NULL,
		           P_NDS_OWNER		    VARCHAR2 DEFAULT NULL,
		           P_NDS_TFISICA	    VARCHAR2 DEFAULT NULL,
		           P_NDS_CD_EMPRESA	    VARCHAR2 DEFAULT NULL,
		           P_NDS_CD_CODIGO	    VARCHAR2 DEFAULT NULL,
		           P_NDS_CD_DESCRICAO	VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER; 
	WS_CONVERTE VARCHAR2(800);

	WS_DUPLICADO EXCEPTION;

BEGIN

    

    WS_CONVERTE := FUN.CONVERTE(P_NDS_TABELA);

    SELECT COUNT(*) INTO WS_COUNT FROM CODIGO_DESCRICAO WHERE UPPER(TRIM(NDS_TABELA)) = UPPER(TRIM(WS_CONVERTE));
    
	IF WS_COUNT > 0 THEN
		RAISE WS_DUPLICADO;
	END IF;	
		
		IF  P_FUNCAO = 'G' AND WS_COUNT = 0 THEN
			INSERT INTO CODIGO_DESCRICAO
				( NDS_TABELA,   NDS_OWNER,   NDS_TFISICA,   NDS_CD_EMPRESA,   NDS_CD_CODIGO,   NDS_CD_DESCRICAO )
			VALUES
				( UPPER(TRIM(WS_CONVERTE)), TRIM(P_NDS_OWNER), TRIM(P_NDS_TFISICA), TRIM(P_NDS_CD_EMPRESA), TRIM(P_NDS_CD_CODIGO), TRIM(P_NDS_CD_DESCRICAO) );
			COMMIT;
		ELSE
			UPDATE CODIGO_DESCRICAO SET
				NDS_TABELA = UPPER(TRIM(WS_CONVERTE)),
				NDS_OWNER = TRIM(NDS_OWNER),
				NDS_TFISICA = TRIM(P_NDS_TFISICA),
				NDS_CD_EMPRESA = TRIM(P_NDS_CD_EMPRESA),
				NDS_CD_CODIGO = TRIM(P_NDS_CD_CODIGO),
				NDS_CD_DESCRICAO = TRIM(P_NDS_CD_DESCRICAO)
			WHERE NDS_TABELA = WS_CONVERTE;
			COMMIT;
		END IF;

		HTP.P('ok');
    EXCEPTION 
		WHEN WS_DUPLICADO THEN
			HTP.P('Erro, c&oacute;digo duplicado!');
			INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Erro ao criar LOV', GBL.GETUSUARIO, 'ERRO');
			COMMIT;
		WHEN OTHERS THEN
			HTP.P('ERRO '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
			INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Erro ao criar LOV', GBL.GETUSUARIO, 'ERRO');
			COMMIT;
END SAVECD;

PROCEDURE UPDATE_SINAL ( PRM_SINAL VARCHAR2 DEFAULT NULL,
                         PRM_TIPO  VARCHAR2 DEFAULT NULL,
						 PRM_VALOR VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER;

BEGIN

    CASE PRM_TIPO
	    WHEN 'fx_01' THEN
            UPDATE SINAIS SET FX_01 = PRM_VALOR WHERE CD_SINAL = PRM_SINAL;
		WHEN 'fx_02' THEN
            UPDATE SINAIS SET FX_02 = PRM_VALOR WHERE CD_SINAL = PRM_SINAL;
		WHEN 'fx_03' THEN
            UPDATE SINAIS SET FX_03 = PRM_VALOR WHERE CD_SINAL = PRM_SINAL;
		WHEN 'fx_04' THEN
            UPDATE SINAIS SET FX_04 = PRM_VALOR WHERE CD_SINAL = PRM_SINAL;
		WHEN 'fx_05' THEN
            UPDATE SINAIS SET FX_05 = PRM_VALOR WHERE CD_SINAL = PRM_SINAL;
		WHEN 'tp_sinal' THEN
            UPDATE SINAIS SET TP_SINAL = PRM_VALOR WHERE CD_SINAL = PRM_SINAL;
	END CASE;

	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
        HTP.P('OK');
		COMMIT;
	ELSE
        HTP.P('FAIL');
		ROLLBACK;
	END IF;
	
EXCEPTION WHEN OTHERS THEN
    HTP.P('FAIL');
END UPDATE_SINAL;

PROCEDURE SAVESIGN ( P_FUNCAO VARCHAR2 DEFAULT NULL,
		             P_CD_SINAL VARCHAR2 DEFAULT NULL,
		             P_DS_SINAL VARCHAR2 DEFAULT NULL,
		             P_TP_SINAL VARCHAR2 DEFAULT NULL,
		             P_FX_01 VARCHAR2 DEFAULT NULL,
		             P_FX_02 VARCHAR2 DEFAULT NULL,
		             P_FX_03 VARCHAR2 DEFAULT NULL,
		             P_FX_04 VARCHAR2 DEFAULT NULL,
		             P_FX_05 VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	IF  P_FUNCAO = 'G' THEN
	    INSERT INTO SINAIS
		   ( CD_SINAL, DS_SINAL, TP_SINAL, FX_01, FX_02, FX_03, FX_04, FX_05 )
	    VALUES
		   ( P_CD_SINAL, P_DS_SINAL, P_TP_SINAL, P_FX_01, P_FX_02, P_FX_03, P_FX_04, P_FX_05 );
	    COMMIT;
	ELSE
	    UPDATE SINAIS SET
	        DS_SINAL = RTRIM(P_DS_SINAL),
		    TP_SINAL = RTRIM(P_TP_SINAL),
		    FX_01 = RTRIM(P_FX_01),
		    FX_02 = RTRIM(P_FX_02),
		    FX_03 = RTRIM(P_FX_03),
		    FX_04 = RTRIM(P_FX_04),
		    FX_05 = RTRIM(P_FX_05)
	    WHERE  CD_SINAL = P_CD_SINAL;
	    COMMIT;
	END IF;

END SAVESIGN;


PROCEDURE DL_OBJ ( PRM_COD  CHAR     DEFAULT NULL,     
		           PRM_TELA CHAR     DEFAULT NULL, 
				   PRM_LIST VARCHAR2 DEFAULT NULL )  AS

	WS_CHAIN    VARCHAR2(100);
	WS_COUNT    NUMBER;
	WS_ERROR    EXCEPTION;
	WS_TIPO     VARCHAR2(100);
	WS_NOME     VARCHAR2(200);
	WS_CONVERTE VARCHAR2(800);
	WS_USUARIO  VARCHAR2(80);
	WS_TELA     VARCHAR2(80);

	WS_NOUSER   EXCEPTION;
BEGIN

	WS_USUARIO  := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;
    
    WS_CONVERTE := FUN.CONVERTE(PRM_COD);

	BEGIN
	    SELECT TP_OBJETO, NM_OBJETO INTO WS_TIPO, WS_NOME FROM OBJETOS WHERE CD_OBJETO = WS_CONVERTE;
	EXCEPTION WHEN OTHERS THEN
	    BEGIN 
		    SELECT SUBSTR(WS_CONVERTE, 0, INSTR(WS_CONVERTE, '_')-1) INTO WS_TIPO FROM DUAL;
		EXCEPTION WHEN OTHERS THEN
		    WS_TIPO := 'OBJETO';
		END;
	END;

	SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = WS_CONVERTE AND TP_OBJETO = 'FLOAT_FILTER';

	IF WS_COUNT > 0 THEN
	    DELETE FROM FLOAT_FILTER_ITEM WHERE CD_COLUNA = WS_CONVERTE AND SCREEN = PRM_TELA;
	END IF;

	WS_COUNT := 0;

	IF PRM_TELA <> 'NOSCREEN' THEN
		BEGIN
			DELETE OBJECT_LOCATION
			WHERE OWNER = 'DWU' AND
			NAVEGADOR = 'DEFAULT' AND
			SCREEN = PRM_TELA AND
			OBJECT_ID IN (WS_CONVERTE, WS_CONVERTE||'_FILTER');
		EXCEPTION WHEN OTHERS THEN
		    RAISE WS_ERROR;
		END;

		BEGIN
		    IF INSTR(WS_CONVERTE, 'ARTICLE') <> 0 THEN
			    
				DELETE FROM OBJETOS
				WHERE TP_OBJETO = 'TEXTO' AND
				CD_OBJETO IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = WS_CONVERTE);
				
				DELETE OBJECT_LOCATION
				WHERE OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				SCREEN = PRM_COD;
				
				DELETE OBJECT_LOCATION
				WHERE OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				SCREEN = PRM_TELA AND
				OBJECT_ID = PRM_COD;
				WS_COUNT := 0;
				
				FOR I IN(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_TELA AND OBJECT_ID LIKE 'ARTICLE_%' ORDER BY TO_NUMBER(POSX) ASC) LOOP
					WS_COUNT := WS_COUNT+1;
					UPDATE OBJECT_LOCATION SET POSX = WS_COUNT WHERE OBJECT_ID = I.OBJECT_ID AND SCREEN = PRM_TELA;
				END LOOP;
			END IF;
		EXCEPTION WHEN OTHERS THEN
		    RAISE WS_ERROR;
		END;

		BEGIN
			IF INSTR(PRM_COD, 'SECTION') <> 0 THEN
				
				FOR I IN(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_COD) LOOP
					DELETE FROM OBJETOS
					WHERE TP_OBJETO = 'TEXTO' AND
					CD_OBJETO IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = I.OBJECT_ID);

					DELETE OBJECT_LOCATION
					WHERE OWNER = 'DWU' AND
					NAVEGADOR = 'DEFAULT' AND
					SCREEN = I.OBJECT_ID;

					DELETE OBJECT_LOCATION
					WHERE OWNER = 'DWU' AND
					NAVEGADOR = 'DEFAULT' AND
					SCREEN = PRM_COD AND
					OBJECT_ID = I.OBJECT_ID;
				END LOOP;

				DELETE OBJECT_LOCATION
				WHERE OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				SCREEN = PRM_TELA AND
				OBJECT_ID = PRM_COD;
				WS_COUNT := 0;
				FOR I IN(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_TELA AND OBJECT_ID LIKE 'SECTION_%' ORDER BY POSX ASC) LOOP
					WS_COUNT := WS_COUNT+1;
					UPDATE OBJECT_LOCATION SET POSX = WS_COUNT WHERE OBJECT_ID = I.OBJECT_ID AND SCREEN = PRM_TELA;
				END LOOP;
			END IF;
		EXCEPTION WHEN OTHERS THEN
		    RAISE WS_ERROR;
		END;
		HTP.P('OK');
		COMMIT;


		IF NVL(PRM_TELA, 'DEFAULT') <> 'DEFAULT' THEN
		    IF INSTR(PRM_TELA, 'ARTICLE') > 0 THEN
                SELECT SCREEN INTO WS_TELA FROM OBJECT_LOCATION WHERE OBJECT_ID = PRM_TELA;
				SELECT SCREEN INTO WS_TELA FROM OBJECT_LOCATION WHERE OBJECT_ID = WS_TELA;
			ELSE
				WS_TELA := PRM_TELA;
			END IF;
			SELECT NM_OBJETO INTO WS_TELA FROM OBJETOS WHERE CD_OBJETO = WS_TELA;
		    INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Objeto "'||WS_NOME||'('||WS_CONVERTE||')" do tipo "'||WS_TIPO||'", excluido da tela "'||WS_TELA||'('||PRM_TELA||')"', WS_USUARIO, 'EVENTO');
		    COMMIT;
		ELSE	
			INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Objeto "'||WS_NOME||'('||WS_CONVERTE||')" do tipo "'||WS_TIPO||'", excluido', WS_USUARIO, 'EVENTO');
		    COMMIT;
		END IF;

	END IF;

EXCEPTION
    WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_ERROR THEN
	    ROLLBACK;
		HTP.P('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
    WHEN OTHERS THEN
	    ROLLBACK;
		HTP.P('FAIL '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END DL_OBJ;



PROCEDURE DL_VP ( WS_PAR_SUMARY	CHAR DEFAULT NULL ) AS

	WS_COUNT NUMBER;

	WS_NOADMIN EXCEPTION;
	WS_FAIL    EXCEPTION;

BEGIN
	
	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	
	DELETE PARAMETRO_PADRAO WHERE CD_PADRAO = WS_PAR_SUMARY;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
		
		DELETE FROM FLOAT_FILTER_ITEM WHERE CD_COLUNA = TRIM(WS_PAR_SUMARY);
		DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = 'PARAMETRO_PADRAO' AND CD_COLUNA = 'NM_PADRAO' AND LANG_DEFAULT = (SELECT NM_PADRAO FROM PARAMETRO_PADRAO WHERE CD_PADRAO = WS_PAR_SUMARY);
		DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = 'PARAMETRO_PADRAO' AND CD_COLUNA = 'CD_PADRAO' AND LANG_DEFAULT = WS_PAR_SUMARY;
		DELETE FROM PARAMETRO_USUARIO WHERE CD_PADRAO = TRIM(WS_PAR_SUMARY);
		DELETE FROM OBJECT_LOCATION WHERE OBJECT_ID = TRIM(WS_PAR_SUMARY);
		DELETE FROM OBJETOS WHERE CD_OBJETO = TRIM(WS_PAR_SUMARY);
		DELETE FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(WS_PAR_SUMARY);
		COMMIT;
    ELSE
        RAISE WS_FAIL;
    END IF;

EXCEPTION 
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
    WHEN WS_FAIL THEN
	    HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END DL_VP;


PROCEDURE DL_CD ( WS_PAR_SUMARY	CHAR DEFAULT NULL ) AS

    WS_COUNT   NUMBER;
	WS_FAIL    EXCEPTION;
	WS_CONVERT VARCHAR2(800);

BEGIN

    

	WS_CONVERT := FUN.CONVERTE(WS_PAR_SUMARY);
    
	DELETE CODIGO_DESCRICAO WHERE NDS_TABELA = WS_CONVERT;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
    ELSE
        RAISE WS_FAIL;
    END IF;

EXCEPTION 
    WHEN WS_FAIL THEN
	    HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END DL_CD;


PROCEDURE DL_SN ( WS_PAR_SUMARY	CHAR DEFAULT NULL ) AS

    WS_FAIL     EXCEPTION;
	WS_COUNT    NUMBER;
    WS_CONVERTE VARCHAR2(800);
BEGIN
    
	

    WS_CONVERTE := FUN.CONVERTE(WS_PAR_SUMARY);

	DELETE FROM SINAIS WHERE CD_SINAL = WS_CONVERTE;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
		
		DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = 'SINAIS' AND CD_COLUNA = 'DS_SINAL' AND LANG_DEFAULT = (SELECT DS_SINAL FROM SINAIS WHERE CD_SINAL = WS_PAR_SUMARY);
	    DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = 'SINAIS' AND CD_COLUNA = 'CD_SINAL' AND LANG_DEFAULT = WS_PAR_SUMARY;
	    COMMIT;
    ELSE
        RAISE WS_FAIL;
    END IF;
	
EXCEPTION 
    WHEN WS_FAIL THEN
        HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END DL_SN;



PROCEDURE DL_OFILTRO ( PRM_KEY NUMBER DEFAULT NULL ) AS

	WS_COUNT      NUMBER := 0;
	WS_OBJETO     VARCHAR2(40);
	WS_COLUNA     VARCHAR2(80);
	WS_CONTEUDO   VARCHAR2(200);
	WS_NOME       VARCHAR2(100);
	WS_USUARIO    VARCHAR2(80);

	WS_NOUSER     EXCEPTION;
	WS_FAIL       EXCEPTION;

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	SELECT CD_OBJETO, CD_COLUNA, CONTEUDO INTO WS_OBJETO, WS_COLUNA, WS_CONTEUDO FROM FILTROS WHERE CD_FILTRO = PRM_KEY;
    SELECT NM_OBJETO INTO WS_NOME FROM OBJETOS WHERE CD_OBJETO = WS_OBJETO;

	DELETE FILTROS
	WHERE CD_FILTRO = PRM_KEY;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
		
		INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Usuario excluiu o filtro #'||PRM_KEY||' do objeto '||WS_NOME||'('||WS_OBJETO||') com a coluna '||WS_COLUNA||' com o valor '||WS_CONTEUDO||'', WS_USUARIO, 'EVENTO');
		COMMIT;
	ELSE
	    RAISE WS_FAIL;
	END IF;
	
EXCEPTION 
    WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_FAIL THEN
        HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END DL_OFILTRO;












































PROCEDURE DL_CALL (	P_CD_OBJETO	VARCHAR2 DEFAULT NULL,
			        P_CD_OBJETO_GO	VARCHAR2 DEFAULT NULL ) AS

WS_COUNT NUMBER;
WS_TIPO VARCHAR2(20);
WS_ATT LONG;
BEGIN
    
    SELECT COUNT(*) INTO WS_COUNT FROM CALL_LIST WHERE CD_LIST=P_CD_OBJETO AND CD_OBJETO=P_CD_OBJETO_GO;
	IF WS_COUNT > 0 THEN
	    SELECT TP_OBJETO INTO WS_TIPO FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO_GO;
		IF WS_TIPO = 'FILE' THEN
		    SELECT ATRIBUTOS INTO WS_ATT FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO_GO;
			DELETE FROM OBJETOS WHERE CD_OBJETO = P_CD_OBJETO_GO;
			DELETE FROM OBJECT_LOCATION WHERE OBJECT_ID = P_CD_OBJETO_GO;
			DELETE FROM OBJECT_ATTRIB WHERE CD_OBJECT = P_CD_OBJETO_GO;
		END IF;
	    DELETE CALL_LIST WHERE CD_LIST = P_CD_OBJETO AND CD_OBJETO=P_CD_OBJETO_GO;
	ELSIF WS_COUNT = 0 THEN
        HTP.P('#alert '||FUN.LANG('Valor inexistente')||'!');
    END IF;
EXCEPTION WHEN OTHERS THEN
	HTP.P('FAIL');
END DL_CALL;


PROCEDURE AJSCREEN ( PRM_SCREEN CHAR DEFAULT NULL ) AS

	CURSOR CRS_OBJLOC IS
	SELECT * FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OWNER = 'DWU' AND NAVEGADOR = 'DEFAULT' AND OBJECT_ID NOT IN ('toolbar','newquery') AND OBJECT_ID IN (SELECT CD_OBJETO FROM OBJETOS);

	WS_OBJLOC CRS_OBJLOC%ROWTYPE;
	WS_TIPO  VARCHAR2(40);
	WS_COMB  VARCHAR2(2000) := '';
	WS_MULTI NUMBER;

	WS_3D CHAR(1);

BEGIN
    
	OPEN CRS_OBJLOC;
	    LOOP
	        FETCH CRS_OBJLOC INTO WS_OBJLOC;
	        EXIT WHEN CRS_OBJLOC%NOTFOUND;

			SELECT MAX(TP_OBJETO) INTO WS_TIPO
			FROM OBJETOS
			WHERE CD_OBJETO=WS_OBJLOC.OBJECT_ID AND CD_USUARIO=WS_OBJLOC.OWNER;

			SELECT COUNT(*) INTO WS_MULTI
			FROM TABLE(FUN.VPIPE(( SELECT MAX(CS_AGRUPADOR) FROM PONTO_AVALIACAO WHERE CD_PONTO=WS_OBJLOC.OBJECT_ID )))
			WHERE TRIM(COLUMN_VALUE) IS NOT NULL;

			SELECT MAX(CS_COLUP) INTO WS_COMB FROM PONTO_AVALIACAO WHERE CD_PONTO=WS_OBJLOC.OBJECT_ID;


			IF WS_TIPO='ORGANOGRAMA' THEN
				HTP.P('<script> parent.activeorga('||CHR(39)||WS_OBJLOC.OBJECT_ID||CHR(39)||','||CHR(39)||FUN.PUT_PAR(WS_OBJLOC.OBJECT_ID, 'ALTURA', WS_TIPO)||CHR(39)||','||CHR(39)||FUN.PUT_PAR(WS_OBJLOC.OBJECT_ID, 'LARGURA', WS_TIPO)||CHR(39)||'); </script>');
			END IF;

			IF WS_TIPO='MAPA' THEN
			    HTP.P('<script>parent.chartMap('''||WS_OBJLOC.OBJECT_ID||''');</script>');
			END IF;

			IF WS_TIPO='BARRAS' THEN
				HTP.P('<script>parent.chart('''||WS_OBJLOC.OBJECT_ID||''');</script>');
			END IF;

			IF WS_TIPO='COUNAS' THEN
				HTP.P('<script>parent.chart('''||WS_OBJLOC.OBJECT_ID||''');</script>');
			END IF;
			
			IF WS_TIPO='HEATMAP' THEN
				HTP.P('<script>parent.heatmap('''||WS_OBJLOC.OBJECT_ID||''');</script>');
			END IF;

			IF WS_TIPO='VALOR' THEN
				HTP.P('<script> parent.chartPercent('''||WS_OBJLOC.OBJECT_ID||'''); </script>');
			END IF;

			IF WS_TIPO='PIZZA' THEN
				HTP.P('<script> parent.chartSlice('''||WS_OBJLOC.OBJECT_ID||'''); </script>');
			END IF;

			IF WS_TIPO='ROSCA' THEN
				HTP.P('<script> parent.chartDonut('''||WS_OBJLOC.OBJECT_ID||'''); </script>');
			END IF;

			IF WS_TIPO='LINHAS' THEN
				HTP.P('<script> parent.chart('''||WS_OBJLOC.OBJECT_ID||'''); </script>');
			END IF;

			IF WS_TIPO='PONTEIRO' THEN
				HTP.P('<script> parent.chartGauge('||CHR(39)||WS_OBJLOC.OBJECT_ID||CHR(39)||'); </script>');
			END IF;
        END LOOP;
    CLOSE CRS_OBJLOC;

EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END AJSCREEN;

PROCEDURE AJOBJETO ( PRM_OBJETO CHAR DEFAULT NULL ) AS

    WS_TIPO  VARCHAR2(40);
    WS_COMB  VARCHAR2(2000);
    WS_MULTI NUMBER;
    WS_3D    CHAR(1);

BEGIN
    
	SELECT MAX(TP_OBJETO) INTO WS_TIPO
	FROM OBJETOS
	WHERE CD_OBJETO = REPLACE(PRM_OBJETO, 'trl', '') AND CD_USUARIO=FUN.WHO;

    SELECT COUNT(*) INTO WS_MULTI
	FROM TABLE(FUN.VPIPE((
		SELECT MAX(CS_AGRUPADOR)
		FROM PONTO_AVALIACAO
		WHERE CD_PONTO=PRM_OBJETO )))
	WHERE TRIM(COLUMN_VALUE) IS NOT NULL;

    IF WS_TIPO = 'ORGANOGRAMA' THEN
        HTP.P('<script> parent.activeorga('||CHR(39)||PRM_OBJETO||CHR(39)||','||CHR(39)||FUN.PUT_PAR(PRM_OBJETO, 'ALTURA', WS_TIPO)||CHR(39)||','||CHR(39)||FUN.PUT_PAR(PRM_OBJETO, 'LARGURA', WS_TIPO)||CHR(39)||'); </script>');
    END IF;

    IF  WS_TIPO = 'MAPA' THEN
        HTP.P('<script>parent.chartMap('''||PRM_OBJETO||''');</script>');
    END IF;

    IF WS_TIPO = 'BARRAS' THEN
        HTP.P('<script>parent.chart('''||PRM_OBJETO||''');</script>');
    END IF;

	IF WS_TIPO = 'COLUNAS' THEN
        HTP.P('<script>parent.chart('''||PRM_OBJETO||''');</script>');
    END IF;
	
	IF WS_TIPO='HEATMAP' THEN
		HTP.P('<script>parent.heatmap('''||PRM_OBJETO||''');</script>');
	END IF;

    IF WS_TIPO = 'VALOR' THEN
        HTP.P('<script> parent.chartPercent('''||PRM_OBJETO||'''); </script>');
    END IF;

    IF WS_TIPO = 'PIZZA' THEN
        HTP.P('<script> parent.chartSlice('''||PRM_OBJETO||'''); </script>');
    END IF;

    IF WS_TIPO = 'ROSCA' THEN
        HTP.P('<script> parent.chartDonut('''||PRM_OBJETO||'''); </script>');
    END IF;

    IF WS_TIPO = 'LINHAS' THEN
        HTP.P('<script> parent.chart('''||PRM_OBJETO||'''); </script>');
    END IF;

    IF WS_TIPO = 'PONTEIRO' THEN
        HTP.P('<script> parent.chartGauge('''||PRM_OBJETO||'''); </script>');
    END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END AJOBJETO;


PROCEDURE SHOW_SCREEN ( PRM_SCREEN	    VARCHAR2 DEFAULT NULL,
						PRM_CLEAR	    VARCHAR2 DEFAULT 'N',
						PRM_SCREEN_ANT	VARCHAR2 DEFAULT NULL,
						PRM_REFRESH     VARCHAR2 DEFAULT 'N',
						PRM_PARAMETRO   VARCHAR2 DEFAULT NULL,
						PRM_TIPO        VARCHAR2 DEFAULT NULL,
						PRM_TOKEN       VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_OBJLOC IS
		SELECT OBJECT_ID, POSX, POSY, SCREEN, ZINDEX, NVL(TRIM(T2.TP_OBJETO), 'SECTION') AS TIPO
		FROM OBJECT_LOCATION T1
		LEFT JOIN OBJETOS T2 ON T2.CD_OBJETO = T1.OBJECT_ID
		WHERE SCREEN = PRM_SCREEN AND
		OWNER = 'DWU' AND
		NAVEGADOR = 'DEFAULT' AND
		OBJECT_ID NOT IN ('toolbar','newquery') AND
		(TRIM(OBJECT_ID) IN (SELECT TRIM(CD_OBJETO) FROM OBJETOS) OR OBJECT_ID LIKE 'SECTION_%')
		ORDER BY ZINDEX;

	WS_OBJLOC	CRS_OBJLOC%ROWTYPE;

	WS_TIMER         NUMBER;
	WS_COUNT         NUMBER := 1;
    WS_MICRO_DATA    VARCHAR2(70);
	WS_DATA_COLUNA   VARCHAR2(500) := '';
	WS_SHOW_ACTIVE   VARCHAR2(2);
	WS_TEMPO         DATE;
	WS_DISPOSITIVO   VARCHAR2(20);
	WS_IPADDR        VARCHAR2(80);
	WS_EXIST         NUMBER;
	WS_SLIDE         VARCHAR2(20);
	WS_USUARIO       VARCHAR2(80);
	WS_ADMIN         VARCHAR2(80);
	WS_TOKEN         NUMBER := 1;
	WS_ID            VARCHAR2(80);
	WS_SHOW          VARCHAR2(20);
    ws_css           varchar2(1000) := ' ';
	ws_css_regular   varchar2(1000) := ' ';
	ws_css_before    varchar2(1000) := ' ';

	WS_NOTOKEN       EXCEPTION;
	WS_NOUSER        EXCEPTION;

BEGIN
    
		
	    IF PRM_CLEAR = 'R' THEN 
			BEGIN

				select count(*) into ws_count from bi_token where trim(code) = trim(prm_token) and to_char(dt_envio, 'DD/MM/YY') = to_char(sysdate, 'DD/MM/YY') and status = 'D';

				if ws_count = 0 then
					raise ws_notoken;
				end if;

				select usuario into ws_usuario from bi_token where trim(code) = trim(prm_token) and to_char(dt_envio, 'DD/MM/YY') = to_char(sysdate, 'DD/MM/YY') and status = 'D';
				
				UPDATE BI_TOKEN
				SET STATUS = 'F' 
				WHERE to_char(dt_envio, 'DD/MM/YY') <> to_char(sysdate, 'DD/MM/YY') and usuario = ws_usuario;
				COMMIT;
 

				SELECT SYS_CONTEXT('userenv','sid') INTO WS_ID FROM DUAL;

				
				

				GBL.SETUSUARIO('ANONYMOUS'||WS_ID, WS_USUARIO);
				WS_USUARIO := GBL.GETUSUARIO;
				WS_ADMIN   := 'N';

			END;

			SELECT SHOW_ONLY INTO WS_SHOW FROM USUARIOS WHERE USU_NOME = GBL.GETUSUARIO;

			IF FUN.CHECK_SCREEN_ACCESS(PRM_SCREEN, WS_USUARIO, WS_ADMIN) = 0 AND WS_SHOW <> 'A' THEN
				RAISE WS_NOUSER;
			END IF;

		ELSIF PRM_CLEAR = 'INFO' THEN 
			BEGIN

				select count(*) into ws_count from bi_token where trim(code) = trim(prm_token) and status = 'D';

				if ws_count = 0 then
					raise ws_notoken;
				end if;

				select usuario into ws_usuario from bi_token where trim(code) = trim(prm_token) and status = 'D';

				delete from bi_sessao where valor = ws_usuario and cod like ('ANONYMOUS%');
				commit;
 
				SELECT SYS_CONTEXT('userenv','sid') INTO WS_ID FROM DUAL;

				GBL.SETUSUARIO('ANONYMOUS'||WS_ID, WS_USUARIO);
				WS_USUARIO := GBL.GETUSUARIO;
				WS_ADMIN   := 'N';

			END;

			SELECT SHOW_ONLY INTO WS_SHOW FROM USUARIOS WHERE USU_NOME = GBL.GETUSUARIO;

			IF FUN.CHECK_SCREEN_ACCESS(PRM_SCREEN, WS_USUARIO, WS_ADMIN) = 0 AND WS_SHOW <> 'A' THEN
				RAISE WS_NOUSER;
			END IF;
		
		ELSIF PRM_CLEAR = 'F' THEN

			WS_TOKEN := 0;

			FOR I IN 1..OWA.NUM_CGI_VARS LOOP
				HTP.P(OWA.CGI_VAR_VAL(I)||'<br>');
				IF OWA.CGI_VAR_VAL(I) = 'AUTHORIZATION' THEN
				    WS_TOKEN := OWA.CGI_VAR_VAL(I);
					
				END IF;
			END LOOP;

			SELECT COUNT(*) INTO WS_COUNT FROM BI_TOKEN WHERE TRIM(UPPER(USUARIO)) = TRIM(UPPER(USER)) AND CODE = WS_TOKEN AND STATUS = 'S';

			WS_USUARIO := USER;
		    WS_ADMIN   := 'N';

		ELSE
	        WS_USUARIO := GBL.GETUSUARIO;
		    WS_ADMIN   := GBL.GETNIVEL;

		END IF;

		IF NVL(WS_USUARIO, 'NOUSER') = 'NOUSER' THEN
			RAISE WS_NOUSER;
		END IF;

		IF PRM_CLEAR = 'F' OR PRM_CLEAR = 'R' OR PRM_CLEAR = 'INFO' THEN

			IF WS_COUNT = 0 THEN
				RAISE WS_NOTOKEN;
			END IF;

			HTP.P('<html oncontextmenu="donut(event); return false;">');
				HTP.P('<head>');
					

					HTP.P('<input type="hidden" id="usuario" value="'||WS_USUARIO||'" />');
					HTP.P('<input type="hidden" id="admin" value="'||WS_ADMIN||'" />');

					FCL.KEYWORDS;

					
					HTP.P('<script src="dwu.fcl.download?arquivo=echarts.5.1.js"></script>');

					HTP.P('<link rel="stylesheet" href="dwu.fcl.downloadOpen?arquivo=tema">');
					HTP.P('<script src="dwu.fcl.downloadOpen?arquivo=js"></script>');
				    HTP.P('<link rel="stylesheet" href="dwu.fcl.downloadOpen?arquivo=css">');

					HTP.P('<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">');
					HTP.P('<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" type="text/css">');
					HTP.P('<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet" type="text/css">'); 
					HTP.P('<link rel="stylesheet" href="dwu.fcl.download?arquivo=bro.css">');

				HTP.P('</head>');

				HTP.P('<body id="princp" class="usuario" onload="chartAnimation = false; chartRenderer = ''canvas''; renderizaGraficos();">');

				HTP.P('<a class="info invisible">'||WS_USUARIO||'</a>');
				HTP.P('<div id="extra" class="slide-N">');
					HTP.P('<input type="hidden" name="moviment" id="movimento" value="yes" />');
					HTP.P('<input type="hidden" name="current_sc" id="current_screen" value="DEFAULT" />');
					HTP.P('<input type="hidden" id="usuario" value="'||WS_USUARIO||'" />');
					HTP.P('<input type="hidden" name="clear" id="clear" value="'||PRM_CLEAR||'" />');
					HTP.P('<input type="hidden" name="ndrobj" id="drill_obj" value="NOC" />');
					HTP.P('<input type="hidden" name="ndrtogo" id="drill_go" value="" />');
					HTP.P('<input type="hidden" name="ndrobjx" id="drill_x" value="" />');
					HTP.P('<input type="hidden" name="ndrobjy" id="drill_y" value="" />');
					HTP.P('<input type="hidden" name="ndrshow" id="drill_show" value="" />');
					HTP.P('<input type="hidden" name="data-json" id="data-json-C" value="'||FUN.R_GIF('brasil_completo','JSON')||'" />');
					HTP.P('<input type="hidden" name="data-json" id="data-json-E" value="'||FUN.R_GIF('brazil_geo','JSON')||'" />');
				HTP.P('</div>');

				HTP.P('<div id="layer">');
					HTP.P('<div class="layer-fundo"></div>');
					HTP.P('<div class="layer-spin spin5"></div>');
					HTP.P('<div class="layer-spin spin4"></div>');
					HTP.P('<div class="layer-spin spin3"></div>');
					HTP.P('<div class="layer-spin spin2"></div>');
					HTP.P('<div class="layer-spin spin1"></div>');
					HTP.P('<div class="layer-icon"></div>');

					HTP.P('<a title="'||FUN.LANG('Cancelar')||'" onclick=" try { window.stop(); var layer = document.getElementById(''layer''); layer.children[1].classList.remove(''visivel'');  layer.children[0].classList.remove(''open''); layer.children[2].classList.remove(''open''); alerta(''feed-fixo'', '''||FUN.LANG('Carregamento dos objetos foi interrompido!')||'''); if(document.getElementById(''layer'').className == ''ativo''){ loading(); } } catch(e){ document.execCommand(''Stop'', false); document.getElementById(''layer'').setAttribute(''class'',''''); } ">X</a>');
				HTP.P('</div>');

				HTP.P('<div id="donut">');

					WS_COUNT := 0;
					HTP.P('<a class="circle" title="'||FUN.LANG('Sincronizar objetos da tela')||'" onmousedown="shscr('''||PRM_SCREEN||''');" ontouchend="shscr(document.getElementById(''current_screen'').value);"><img style="margin-top: 4px;" src="'||FUN.R_GIF('sinchronize','png')||'" /><span class="texto">SINCRONIZAR</span></a>');
					HTP.P('<a class="circle" style="display: none;" title="'||FUN.LANG('Recarregar sem cache')||'" onmousedown="window.location.reload(true);" ontouchstart="window.location.reload(true);"><img style="margin-top: 5px;" src="'||FUN.R_GIF('home','png')||'" /><span class="texto">PRINCIPAL</span></a>');

				HTP.P('</div>');

				HTP.P('<ul id="feed-fixo"></ul>');

                -- Monta o CSS do backgound da SCREEN pra colocar no style do main 
				-----------------------------------------------------------------------------
				background_attrib_monta (prm_screen, ws_css); 
	            ws_css_regular := substr(ws_css,1,instr(ws_css,'|') - 1);
				ws_css_before  := substr(ws_css,instr(ws_css,'|')+1, length(ws_css) );

				htp.p('<div id="screen-props" style="display: none;">'); 
					--modificado essa linha de style por não aplicar o background no PAINEL removido o main:before e alterado o #main para o ws_css inteiro. 02/03/2022
					--htp.p('<style>div#main { padding: 0 !important; '||ws_css_regular||' }  div#main:before { '||ws_css_before||' } </style>'); 
										
					htp.p('<style>div#main { padding: 0 !important; '||ws_css||' }  </style>'); 

				htp.p('</div>'); 

			    -- Quando é executado através da chamada URL (Painel, email, etc), adiciona a tag MAIN 
				htp.p('<div id="main">');

		END IF;

		IF FUN.GETPROP(PRM_SCREEN, 'MANUTENCAO') = 'S' THEN
			HTP.P('<h3 class="maintenance">EM MANUTEN&Ccedil;&Atilde;O</h3>');
		END IF;

		IF FUN.GETPROP(PRM_SCREEN, 'ATUALIZANDO') = 'S' THEN
			HTP.P('<h3 class="updating" title="os dados desta tela est&atilde;o sendo atualizados!">!</h3>');
		END IF;

			WS_TEMPO := SYSDATE;

			IF LENGTH(PRM_PARAMETRO) > 0 AND (LENGTH(PRM_SCREEN_ANT) > 0 OR PRM_CLEAR = 'R') THEN
				
				DELETE FROM FLOAT_FILTER_ITEM FLIT
				WHERE FLIT.CD_COLUNA IN (SELECT DISTINCT CD_COLUNA FROM TABLE(FUN.VPIPE_PAR(PRM_PARAMETRO))) AND
				SCREEN=PRM_SCREEN AND CD_USUARIO = WS_USUARIO;
				
				INSERT INTO FLOAT_FILTER_ITEM 
				SELECT WS_USUARIO, PRM_SCREEN, CD_COLUNA, CD_CONTEUDO
			    FROM (SELECT CD_COLUNA, MAX(CD_CONTEUDO) AS CD_CONTEUDO FROM  (TABLE(FUN.VPIPE_PAR(PRM_PARAMETRO)))  GROUP BY CD_COLUNA)
			    WHERE CD_COLUNA IN (SELECT DISTINCT CD_COLUNA FROM TABLE(FUN.VPIPE_PAR(PRM_PARAMETRO)) GROUP BY CD_COLUNA) AND
				CD_COLUNA IN (SELECT REPLACE(OBJECT_ID,'_FILTER','') AS CD_COLUNA FROM OBJECT_LOCATION WHERE SCREEN=PRM_SCREEN AND (SELECT TP_OBJETO FROM OBJETOS WHERE CD_OBJETO=OBJECT_ID)='FLOAT_FILTER');
			    
				COMMIT;

			END IF;

			WS_COUNT := 0; 
	
			OPEN CRS_OBJLOC;
			LOOP
				FETCH CRS_OBJLOC INTO WS_OBJLOC;
				EXIT WHEN CRS_OBJLOC%NOTFOUND;

				WS_COUNT := WS_COUNT+1;

				IF PRM_TIPO = 'MENU' THEN
					IF WS_OBJLOC.TIPO = 'CALL_LIST' THEN
						OBJ.SHOW_OBJETO(WS_OBJLOC.OBJECT_ID, WS_OBJLOC.POSX, WS_OBJLOC.POSY, PRM_SCREEN => PRM_SCREEN, PRM_USUARIO => WS_USUARIO, PRM_ADMIN => WS_ADMIN);
					END IF;
				ELSIF PRM_TIPO = 'FLOAT' OR PRM_TIPO = 'FLOAT_FILTER' THEN
					IF WS_OBJLOC.TIPO = 'FLOAT_PAR' OR WS_OBJLOC.TIPO = 'FLOAT_FILTER' THEN
						OBJ.SHOW_OBJETO(WS_OBJLOC.OBJECT_ID, WS_OBJLOC.POSX, WS_OBJLOC.POSY, PRM_SCREEN => PRM_SCREEN, PRM_USUARIO => WS_USUARIO, PRM_ADMIN => WS_ADMIN);
					END IF;
				ELSE
					IF WS_OBJLOC.TIPO <> 'CALL_LIST' AND WS_OBJLOC.TIPO <> 'FLOAT_PAR' AND WS_OBJLOC.TIPO <> 'FLOAT_FILTER' THEN
						OBJ.SHOW_OBJETO(WS_OBJLOC.OBJECT_ID, WS_OBJLOC.POSX, WS_OBJLOC.POSY, PRM_SCREEN => PRM_SCREEN, PRM_ZINDEX => WS_OBJLOC.ZINDEX, PRM_USUARIO => WS_USUARIO, PRM_ADMIN => WS_ADMIN);
					END IF;
				END IF;
			END LOOP;
			CLOSE CRS_OBJLOC;

			SELECT NVL(SHOW_ONLY, 'N') INTO WS_SHOW_ACTIVE FROM USUARIOS WHERE TRIM(USU_NOME) = WS_USUARIO;

            IF PRM_CLEAR not in ('INFO', 'F', 'R') THEN
				IF PRM_REFRESH = 'N' AND WS_SHOW_ACTIVE <> 'S' AND NVL(PRM_TIPO, 'MAIN') = 'MAIN' THEN
					INSERT INTO LOG_EVENTOS VALUES(SYSDATE, 'accesso: ['||PRM_SCREEN||']', WS_USUARIO, 'TELA', 'ACESSO', '01');
				END IF;
			END IF;


	    IF PRM_CLEAR = 'F' OR PRM_CLEAR = 'R' THEN
						
						HTP.P('<ul style="display: none;" id="alerta-template"><li onclick="var template = this; template.classList.remove(''show''); setTimeout(function(){ template.parentNode.removeChild(template); }, 300);"></li></ul>');
					HTP.P('</div>');    -- Fecha a div MAIN
				HTP.P('</body>');
		    HTP.P('</html>');

		END IF;

		-- Quando a show_screen é chamada direto do navegador pela URL tem que executar a icarrega por aqui, quando é chamado pelo BI a icarrega já é executada pela shscr() do JS - 09/02/2022
		if prm_clear in ('INFO','R') then 
			htp.p('<script>const USUARIO = "'||ws_usuario||'", ADMIN = "'||ws_admin||'", LAYER = document.getElementById(''layer''), MAIN = document.getElementById(''main''), PRINCP = document.getElementById(''princp'');</script>');
			htp.p('<script>icarrega('''||prm_screen||''');</script>');
		end if;		

EXCEPTION 
	WHEN WS_NOTOKEN THEN
		HTP.P(FUN.LANG('Sem permiss&atilde;o de acesso, precisa de um token v&aacute;lido!'));
		GBL.SETUSUARIO(PRM_TOKEN);
		
		INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Tentativa de acesso direta sem token', USER, 'EVENTO');
	
	WHEN WS_NOUSER THEN
		GBL.SETUSUARIO(PRM_TOKEN);
		GBL.SETUSUARIO('ANONYMOUS'||WS_ID);
		HTP.P('Sem permiss&atilde;o de acesso!');
	WHEN OTHERS THEN
		IF GBL.GETUSUARIO = 'NOUSER' THEN
		    HTP.P('LOGOUT');
		END IF;
		HTP.P(FUN.LANG('Erro de Grava&ccedil;&atilde;o [show_screen]')||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END SHOW_SCREEN;



PROCEDURE LOAD_EXTERNAL( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

  WS_URL VARCHAR2(100);

BEGIN
	SELECT NVL(REPLACE(URL_FUNDO, 'EXT=', ''), '') INTO WS_URL FROM ALL_SCREENS WHERE SCREEN = PRM_SCREEN AND URL_FUNDO LIKE ('EXT=%') AND ROWNUM = 1;
    HTP.P(WS_URL);
EXCEPTION WHEN OTHERS THEN
	HTP.P('');
END LOAD_EXTERNAL;

PROCEDURE CLEAR_SCREEN( PRM_SCREEN  CHAR DEFAULT 'DEFAULT',
						PRM_NSCREEN CHAR DEFAULT NULL,
						PRM_VISAO   CHAR DEFAULT 'N' ) AS

	CURSOR CRS_OBJLOC IS
		SELECT * FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OWNER = 'DWU' AND NAVEGADOR = 'DEFAULT' AND OBJECT_ID NOT IN ('toolbar','newquery');

	WS_OBJLOC	CRS_OBJLOC%ROWTYPE;

BEGIN

	HTP.P('<script>');

		IF PRM_VISAO='S' THEN
			HTP.P('if  (parent.document.getElementById(''lockp'').value==''SIM'') {  ');
			HTP.P('parent.document.getElementById(''lockp'').value=''NAO'';');
		END IF;

		OPEN CRS_OBJLOC;
		LOOP
			FETCH CRS_OBJLOC INTO WS_OBJLOC;
				EXIT WHEN CRS_OBJLOC%NOTFOUND;

			HTP.P('var delfit=parent.document.getElementById("'||WS_OBJLOC.OBJECT_ID||'"); ');
			HTP.P('if(delfit){ delfit.parentNode.removeChild(delfit); }');

		END LOOP;
		CLOSE CRS_OBJLOC;

		IF PRM_VISAO = 'S' THEN
			HTP.P(' parent.document.getElementById(''current_screen'').value='||CHR(39)||PRM_NSCREEN||CHR(39)||';');
			HTP.P(' window.parent.apscreen(''dwu.fcl.show_screen?prm_screen='||PRM_NSCREEN||CHR(39)||','||CHR(39)||UPPER(REPLACE(TRIM(PRM_NSCREEN),' ','_'))||CHR(39)||'); } ');
		END IF;

 	HTP.P('</script>');
EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END CLEAR_SCREEN;


PROCEDURE INSERIR_OBJETO (	PRM_OBJETO     VARCHAR2 DEFAULT NULL, 
                            PRM_SCREEN     VARCHAR2 DEFAULT 'DEFAULT', 
							PRM_SCREEN_ANT VARCHAR2 DEFAULT 'DEFAULT' ) AS

	WS_ERRO			EXCEPTION;

	CURSOR CRS_OBJLOC IS
	SELECT * FROM OBJECT_LOCATION WHERE 
	SCREEN = PRM_SCREEN_ANT AND 
	OWNER = 'DWU' AND 
	NAVEGADOR = 'DEFAULT' AND 
	OBJECT_ID NOT IN ('toolbar','newquery');

	WS_OBJLOC	CRS_OBJLOC%ROWTYPE;

	WS_COUNT   NUMBER;
	WS_COUNTER NUMBER;
	WS_USUARIO VARCHAR2(80);
	WS_ID      VARCHAR2(600);
    WS_SUBID   VARCHAR2(600);

	WS_NOUSER  EXCEPTION;
	
BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

    WS_COUNT := 0;
	IF  PRM_SCREEN = 'SHOWSCREEN' THEN
	    OPEN CRS_OBJLOC;
	        LOOP
		        FETCH CRS_OBJLOC INTO WS_OBJLOC;
		        EXIT WHEN CRS_OBJLOC%NOTFOUND;
		    END LOOP;
	    CLOSE CRS_OBJLOC;
	ELSE
	    
        IF INSTR(PRM_OBJETO, 'SECTION') = 0 THEN
		    IF INSTR(PRM_OBJETO, 'ARTICLE') = 0 THEN
                
                SELECT COUNT(*) INTO WS_COUNT
                FROM OBJECT_LOCATION 
                WHERE OBJECT_ID = PRM_OBJETO AND 
                SCREEN = PRM_SCREEN;

                HTP.P(WS_COUNT);
				IF WS_COUNT = 0 THEN
				    SELECT COUNT(*)+1 INTO WS_COUNT
					FROM OBJECT_LOCATION 
					WHERE 
					SCREEN = PRM_SCREEN;
                    INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) VALUES 
					('DWU', 'DEFAULT', PRM_SCREEN, PRM_OBJETO, '100px', WS_COUNT, '2', '0');
                    COMMIT;
                END IF;
			ELSE

				SELECT 'ARTICLE_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||TO_CHAR(SYSDATE,'yymmddhhmiss')) INTO WS_ID FROM DUAL;
			    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE OBJECT_ID = WS_ID AND SCREEN = PRM_SCREEN;
				IF WS_COUNT = 0 THEN
				    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OBJECT_ID LIKE 'ARTICLE%';
			        WS_COUNT := WS_COUNT+1;
				    INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) VALUES 
					('DWU', 'DEFAULT', PRM_SCREEN, WS_ID, 'inherit', WS_COUNT, 'column', '100%');
			        COMMIT;

                    FCL.MONTA_ARTICLE(WS_ID, PRM_SCREEN, NVL(WS_COUNT, 1));

				END IF;
			END IF;
		ELSE
		    SELECT 'SECTION_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||TO_CHAR(SYSDATE,'yymmddhhmiss')) INTO WS_ID FROM DUAL;
		    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE OBJECT_ID = WS_ID AND SCREEN = PRM_SCREEN;
			IF WS_COUNT = 0 THEN
				SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OBJECT_ID LIKE 'SECTION_%';
				INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) VALUES 
				('DWU', 'DEFAULT', PRM_SCREEN, WS_ID, 'center', WS_COUNT+1, 'column', '0');
				COMMIT; 
                	HTP.P('<section class=""  id="'||WS_ID||'" style="flex-wrap: wrap; order: 1; flex-direction: column;">');
						HTP.P('<div class="submenu" onmousedown="event.stopPropagation();">');
							HTP.P('<a class="adddash" title="'||FUN.LANG('adicionar bloco')||'" onclick="dashboard('''', ''insert'', '''||WS_ID||''');">+</a>');
							HTP.P('<select onchange="dashboard(document.getElementById(''current_screen'').value, ''rowcolumn'', '''||WS_ID||''',  this.value);">');
								HTP.P('<optgroup label="Formato"></optgroup>');
								HTP.P('<option value="row">'||FUN.LANG('Horizontal')||'</option>');
								HTP.P('<option value="column" selected>'||FUN.LANG('Vertical')||'</option>');
							HTP.P('</select>');

						HTP.P(FUN.EXCLUIR_DASH(WS_ID));
						HTP.P('</div>');
                        
                        SELECT 'ARTICLE_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||TO_CHAR(SYSDATE,'yymmddhhmiss'))||'1' INTO WS_SUBID FROM DUAL;
                        INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) VALUES 
						('DWU', 'DEFAULT', WS_ID, WS_SUBID, 'inherit', 1, 'column', '100%');
				        COMMIT;

						FCL.MONTA_ARTICLE(WS_SUBID, WS_ID, 1);

                        SELECT 'ARTICLE_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||TO_CHAR(SYSDATE,'yymmddhhmiss'))||'2' INTO WS_SUBID FROM DUAL;
                        INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) VALUES 
						('DWU', 'DEFAULT', WS_ID, WS_SUBID, 'inherit', 2, 'column', '100%');
				        COMMIT;

                        FCL.MONTA_ARTICLE(WS_SUBID, WS_ID, 2);

				HTP.P('</section>');
			END IF;
		END IF;
	    COMMIT;
	END IF;

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END INSERIR_OBJETO;


PROCEDURE MONTA_ARTICLE ( PRM_ID      VARCHAR2 DEFAULT NULL,
                          PRM_SECTION VARCHAR2 DEFAULT NULL, 
						  PRM_COUNT   NUMBER   DEFAULT 1    ) AS

BEGIN

    HTP.P('<article id="'||PRM_ID||'" style="justify-content: inherit; align-items: inherit; flex-direction: column; order: '||NVL(PRM_COUNT, 1)||'; flex-basis: calc(100% - 6.4px);">');
		IF GBL.GETNIVEL = 'A' THEN
			HTP.P('<div class="articlemenu" onmousedown="event.stopPropagation();">');
				HTP.P(FUN.EXCLUIR_DASH(PRM_ID));
				HTP.P('<select onchange="dashboard('''||PRM_SECTION||''', ''align'', '''||PRM_ID||''', this.value);">');
					HTP.P('<optgroup label="Alinhamento"></optgroup>');
						HTP.P('<option value="flex-start">'||FUN.LANG('In&iacute;cio')||'</option>');
						HTP.P('<option value="flex-end">'||FUN.LANG('Fim')||'</option>');
						HTP.P('<option value="center">'||FUN.LANG('Centro')||'</option>');
						HTP.P('<option value="inherit" selected>'||FUN.LANG('Todo')||'</option>');
				HTP.P('</select>');
				HTP.P('<select onchange="dashboard('''||PRM_SECTION||''', ''rowcolumn'', '''||PRM_ID||''', this.value);">');
					HTP.P('<optgroup label="Formato"></optgroup>');
						HTP.P('<option value="row">'||FUN.LANG('Horizontal')||'</option>');
						HTP.P('<option value="column" selected>'||FUN.LANG('Vertical')||'</option>');
				HTP.P('</select>');
				HTP.P('<input onblur="dashboard('''||PRM_SECTION||''', ''porcentagem'', '''||PRM_ID||''', this.value);" value="100%" placeholder="'||FUN.LANG('medida')||'" title="'||FUN.LANG('MEDIDA')||'">');
				HTP.P('<input id="'||PRM_ID||'ordem" onblur="dashboard('''||PRM_SECTION||''', ''ordem'', '''||PRM_ID||''', this.value);" value="'||NVL(PRM_COUNT, 1)||'" placeholder="'||FUN.LANG('ordem')||'" title="'||FUN.LANG('ORDEM')||'">');
				
				HTP.P('<img title="'||FUN.LANG('Inserir objeto')||'" src="dwu.fcl.download?arquivo=folder.png" onclick="closeSideBar(''attriblist''); document.getElementById(''attriblist'').classList.toggle(''open''); ajax(''list'', ''lista_objetos'', '''', false, ''attriblist'');">');
			HTP.P('</div>');
		END IF;
	HTP.P('</article>');

END MONTA_ARTICLE;

PROCEDURE CALL_INSERT ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                        PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

BEGIN
    INSERT INTO OBJECT_LOCATION (OWNER, NAVEGADOR, SCREEN, OBJECT_ID, POSY, POSX, ZINDEX, PORCENTAGEM) VALUES ('DWU', 'DEFAULT', PRM_SCREEN, PRM_OBJETO, '100px', '100px', '2', '0');                
END;


PROCEDURE SAVE_POINTS (	PRM_OBJETO 	IN OWA_UTIL.IDENT_ARR,
						PRM_POSX	IN OWA_UTIL.IDENT_ARR,
						PRM_POSY	IN OWA_UTIL.IDENT_ARR,
						PRM_SCREEN	CHAR DEFAULT 'DEFAULT') AS

	WS_COUNT	NUMBER;

BEGIN
    
	FOR I IN PRM_OBJETO.FIRST..PRM_OBJETO.LAST LOOP
	    SELECT COUNT(*) INTO WS_COUNT
	    FROM   OBJECT_LOCATION
	    WHERE  OWNER = FUN.WHO AND
		   NAVEGADOR = 'DEFAULT' AND
		   SCREEN    = PRM_SCREEN AND
		   OBJECT_ID = TRIM(PRM_OBJETO(I));

	    IF  WS_COUNT < 2 THEN
	    
	        IF  WS_COUNT = 1 THEN
		    UPDATE OBJECT_LOCATION SET POSX = REPLACE(TRIM(PRM_POSX(I)),'-',''), POSY = REPLACE(TRIM(PRM_POSY(I)),'-','')
		    WHERE  OWNER = FUN.WHO AND
			   NAVEGADOR = 'DEFAULT' AND
			   SCREEN    = PRM_SCREEN AND
			   OBJECT_ID = TRIM(PRM_OBJETO(I));
		    COMMIT;
	        ELSE
		    INSERT INTO OBJECT_ATTRIB VALUES ('DWU', 'DEFAULT', PRM_SCREEN, PRM_OBJETO(I), REPLACE(TRIM(PRM_POSX(I)),'-',''), REPLACE(TRIM(PRM_POSY(I)),'-',''));
		    COMMIT;
	        END IF;
	    END IF;
	END LOOP;

EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END SAVE_POINTS;





PROCEDURE SAVE_PROP ( PRM_PROP        VARCHAR2 DEFAULT NULL,
			          PRM_VALOR       VARCHAR2 DEFAULT NULL,
			          PRM_OBJETO	  VARCHAR2 DEFAULT NULL,
			          PRM_URL_DEFAULT VARCHAR2 DEFAULT NULL,
			          PRM_SCREEN	  VARCHAR2 DEFAULT 'DEFAULT') AS

	WS_COUNT	   NUMBER;
	WS_POSX		   VARCHAR2(300);
	WS_POSY		   VARCHAR2(300);
	TIPO           VARCHAR2(300);
	ALTURA         VARCHAR2(60);
	LARGURA        VARCHAR2(60);
	WS_EXIST	   NUMBER;
    WS_CONVERTE    VARCHAR2(800);

BEGIN

    WS_CONVERTE := FUN.CONVERTE(PRM_VALOR);

	IF INSTR(PRM_PROP, 'DASH_MARGIN') > 0 THEN
		SELECT COUNT(*) INTO WS_COUNT
		FROM   OBJECT_ATTRIB
		WHERE  OWNER = 'DWU' AND
		NAVEGADOR = 'DEFAULT' AND
		CD_OBJECT = PRM_OBJETO AND
		CD_PROP   = PRM_PROP AND
		SCREEN = PRM_SCREEN;
	ELSE
		SELECT COUNT(*) INTO WS_COUNT
		FROM   OBJECT_ATTRIB
		WHERE  OWNER = 'DWU' AND
		NAVEGADOR = 'DEFAULT' AND
		CD_OBJECT = PRM_OBJETO AND
		CD_PROP   = PRM_PROP;
	END IF;

	IF  WS_COUNT < 2 THEN
	
		IF  WS_COUNT = 1 THEN
			IF INSTR(PRM_PROP, 'DASH_MARGIN') > 0 THEN
				UPDATE OBJECT_ATTRIB SET PROPRIEDADE = WS_CONVERTE
				WHERE  OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				CD_OBJECT = PRM_OBJETO AND
				CD_PROP   = PRM_PROP
				AND SCREEN = PRM_SCREEN;
				COMMIT;
			ELSE
				UPDATE OBJECT_ATTRIB SET PROPRIEDADE = WS_CONVERTE
				WHERE  OWNER = 'DWU' AND
				NAVEGADOR = 'DEFAULT' AND
				CD_OBJECT = PRM_OBJETO AND
				CD_PROP   = PRM_PROP AND
				SCREEN = 'DEFAULT';
				COMMIT;
			END IF;
		ELSE
			IF INSTR(PRM_PROP, 'DASH_MARGIN') > 0 THEN
				INSERT INTO OBJECT_ATTRIB VALUES ('DWU', 'DEFAULT', PRM_SCREEN, TRIM(PRM_OBJETO), PRM_PROP, WS_CONVERTE);
				COMMIT;
			ELSE
				INSERT INTO OBJECT_ATTRIB VALUES ('DWU', 'DEFAULT', 'DEFAULT', TRIM(PRM_OBJETO), PRM_PROP, WS_CONVERTE);
				COMMIT;
			END IF;
		END IF;
	END IF;

EXCEPTION 
	WHEN OTHERS THEN
		HTP.P('#alert '||SQLERRM);
END SAVE_PROP;


PROCEDURE SAVE_PA (	PRM_OBJETO	CHAR DEFAULT NULL,
			PRM_URL_DEFAULT CHAR DEFAULT NULL,
			PRM_SCREEN	CHAR DEFAULT 'DEFAULT') AS

	WS_COUNT	NUMBER;
	WS_POSX		VARCHAR2(200);
	WS_POSY		VARCHAR2(200);

BEGIN
    
	HTP.HTMLOPEN;
	HTP.BODYOPEN;

	HTP.P('<script> appendar('||CHR(39)||'dwu.obj.show_objeto?prm_objeto='||PRM_OBJETO||'&prm_posx='||WS_POSX||'&prm_posy='||WS_POSY||'&PRM_ZINDEX=''); </script>');

	HTP.BODYCLOSE;
	HTP.HTMLCLOSE;

EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END SAVE_PA;

PROCEDURE SAVE_PAR ( Y IN    OWA_UTIL.IDENT_ARR,
			         X IN    OWA_UTIL.IDENT_ARR,
			         WS_TYPE VARCHAR2 DEFAULT 'NOSUB') AS

	WS_COUNT	NUMBER;
	WS_CONTEUDO VARCHAR2(40);
	WS_USUARIO  VARCHAR2(80);

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	FOR I IN X.FIRST..X.LAST
	LOOP
	    SELECT COUNT(*) INTO WS_COUNT
	    FROM   PARAMETRO_USUARIO
	    WHERE  CD_USUARIO = WS_USUARIO AND
		   CD_PADRAO =  TRIM(Y(I));

		WS_CONTEUDO := REPLACE(X(I), '-SET-', '-SEP-');

	    IF  WS_COUNT < 2 THEN
	        IF  WS_COUNT = 1 THEN
		        UPDATE PARAMETRO_USUARIO SET CONTEUDO = TRIM(WS_CONTEUDO)
			    WHERE CD_USUARIO = WS_USUARIO AND
				CD_PADRAO =  TRIM(Y(I));
		        COMMIT;
	        ELSE
		        INSERT INTO PARAMETRO_USUARIO VALUES (WS_USUARIO, TRIM(Y(I)), TRIM(X(I)) , '');
		        COMMIT;
	        END IF;
	    END IF;
	END LOOP;

EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END SAVE_PAR;


PROCEDURE SAVE_FLOAT (	PRM_CONTEUDO VARCHAR2 DEFAULT NULL,
						PRM_PADRAO   VARCHAR2 DEFAULT NULL,
						PRM_SCREEN   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT    NUMBER;
    WS_COUNTROW NUMBER;
	WS_CONVERTE VARCHAR2(800);
	WS_USUARIO  VARCHAR2(80);

	WS_NOUSER   EXCEPTION;
	WS_FAIL     EXCEPTION;

BEGIN

	WS_USUARIO  := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	



    WS_CONVERTE := FUN.CONVERTE(PRM_CONTEUDO);
	
    DELETE FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO = PRM_PADRAO;

	
	DELETE FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(FUN.GETPROP(TRIM(UPPER(CD_COLUNA)), 'ENCADEADO'))) = TRIM(UPPER(PRM_PADRAO)) AND CD_USUARIO = WS_USUARIO;
	DELETE FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(FUN.GETPROP(TRIM(UPPER(CD_PADRAO)), 'ENCADEADO'))) = TRIM(UPPER(PRM_PADRAO)) AND CD_USUARIO = WS_USUARIO;


   



	IF NVL(TRIM(PRM_CONTEUDO), 'N/A') <> 'N/A' THEN
		INSERT INTO PARAMETRO_USUARIO (CD_USUARIO, CD_PADRAO, CONTEUDO, PRE_LOAD)
		SELECT WS_USUARIO, PRM_PADRAO, COLUMN_VALUE, '' FROM TABLE (FUN.VPIPE(WS_CONVERTE));
		
		WS_COUNTROW := SQL%ROWCOUNT;
		
		IF WS_COUNTROW <> 0 THEN
			COMMIT;

	
			
			UPDATE OBJECT_ATTRIB SET PROPRIEDADE = FUN.GETPROP(CD_OBJECT,'ORDEM',PRM_SCREEN,'DWU','CONSULTA') WHERE
			
			OWNER = WS_USUARIO AND
			CD_PROP = 'ORDEM' AND 
			(
				CD_OBJECT IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN)
				OR
				CD_OBJECT IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN IN 
					(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN IN
						(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OBJECT_ID LIKE ('SECTION_%'))
					)
				)
			) AND
			CD_OBJECT IN (SELECT CD_OBJETO FROM OBJETOS WHERE TP_OBJETO = 'CONSULTA') AND
			CD_OBJECT IN (SELECT CD_PONTO FROM PONTO_AVALIACAO WHERE LENGTH(CS_COLUP) > 0)
			AND CD_OBJECT NOT IN (SELECT CD_OBJECT FROM OBJECT_ATTRIB WHERE CD_PROP = 'REORDER' AND PROPRIEDADE <> 'S');
			COMMIT;

		ELSE
			RAISE WS_FAIL;
		END IF;
	END IF;
EXCEPTION 
    WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_FAIL THEN
        ROLLBACK;
        HTP.P('FAIL');
    WHEN OTHERS THEN
        ROLLBACK;
	    HTP.P('FAIL');
END SAVE_FLOAT;


PROCEDURE SAVE_FLOAT_FILTER ( PRM_CONTEUDO VARCHAR2 DEFAULT NULL,
						      PRM_COLUNA VARCHAR2 DEFAULT NULL,
						      PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT    NUMBER;
	WS_COUNTROW NUMBER;
    WS_USUARIO  VARCHAR2(80);
	WS_CONVERTE VARCHAR2(800);

	WS_NOUSER EXCEPTION;
	WS_FAIL  EXCEPTION;

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	WS_CONVERTE := FUN.CONVERTE(PRM_CONTEUDO);

	
		DELETE FROM FLOAT_FILTER_ITEM WHERE SCREEN = PRM_SCREEN AND CD_COLUNA = REPLACE(PRM_COLUNA, '_FILTER', '') AND CD_USUARIO = WS_USUARIO;
	
		
		
	IF LENGTH(WS_CONVERTE) > 0 AND WS_CONVERTE <> 'TODOS' THEN
		
		
		





        INSERT INTO FLOAT_FILTER_ITEM (CD_USUARIO, SCREEN, CD_COLUNA, CONTEUDO )
        SELECT WS_USUARIO, PRM_SCREEN, REPLACE(PRM_COLUNA, '_FILTER', ''), NVL(COLUMN_VALUE, 'n/a') FROM TABLE(FUN.VPIPE(WS_CONVERTE)) 
		WHERE NVL(COLUMN_VALUE, 'n/a') <> 'n/a';

	END IF;
		
	WS_COUNTROW := SQL%ROWCOUNT;
    
	IF WS_COUNTROW <> 0 THEN
	    COMMIT;

        
		UPDATE OBJECT_ATTRIB SET PROPRIEDADE = FUN.GETPROP(CD_OBJECT,'ORDEM',PRM_SCREEN,'DWU','CONSULTA') WHERE
		
		OWNER = WS_USUARIO AND
		CD_PROP = 'ORDEM' AND 
		(
			CD_OBJECT IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN)
			OR
			CD_OBJECT IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN IN 
				(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN IN
					(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OBJECT_ID LIKE ('SECTION_%'))
				)
			)
		) AND
		CD_OBJECT IN (SELECT CD_OBJETO FROM OBJETOS WHERE TP_OBJETO = 'CONSULTA') AND
		CD_OBJECT IN (SELECT CD_PONTO FROM PONTO_AVALIACAO WHERE LENGTH(CS_COLUP) > 0)
		AND CD_OBJECT NOT IN (SELECT CD_OBJECT FROM OBJECT_ATTRIB WHERE CD_PROP = 'REORDER' AND PROPRIEDADE <> 'S');
		COMMIT;

	ELSE
	    RAISE WS_FAIL;
	END IF;
	
EXCEPTION 
    WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_FAIL THEN
        ROLLBACK;
        HTP.P('FAIL');
    WHEN OTHERS  THEN
        ROLLBACK;
	    HTP.P('FAIL');
END SAVE_FLOAT_FILTER;


PROCEDURE SAVEMV (  P_FUNCAO VARCHAR2 DEFAULT NULL,
					P_NM_MICRO_VISAO	VARCHAR2 DEFAULT NULL,
					P_NM_TABELA VARCHAR2 DEFAULT NULL,
					P_DS_MICRO_VISAO	VARCHAR2 DEFAULT NULL,
					P_CD_GRUPO_FUNCAO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

BEGIN
    
	IF  P_FUNCAO = 'G' THEN
	    SELECT COUNT(*) INTO WS_COUNT FROM MICRO_VISAO WHERE NM_MICRO_VISAO = UPPER(P_NM_MICRO_VISAO);
		IF WS_COUNT = 0 THEN
		    INSERT INTO MICRO_VISAO
		       ( NM_MICRO_VISAO, NM_TABELA, DS_MICRO_VISAO, CD_GRUPO_FUNCAO , DT_ULTIMA_ALTERACAO, CD_USUARIO )
	        VALUES
		       ( UPPER(P_NM_MICRO_VISAO), P_NM_TABELA, P_DS_MICRO_VISAO, P_CD_GRUPO_FUNCAO, SYSDATE, 'DWU' );
	        COMMIT;
		ELSE
	        HTP.P('#alert '||FUN.LANG('Micro vis&atilde;o j&aacute; existe')||'!');
		END IF;
	ELSE
	    SELECT COUNT(*) INTO WS_COUNT FROM MICRO_VISAO WHERE NM_MICRO_VISAO = UPPER(P_NM_MICRO_VISAO);
		IF WS_COUNT = 1 THEN
	        UPDATE MICRO_VISAO SET
		       NM_MICRO_VISAO  = UPPER(RTRIM(P_NM_MICRO_VISAO)),
		       NM_TABELA       = RTRIM(P_NM_TABELA),
		       DS_MICRO_VISAO  = P_DS_MICRO_VISAO,
		       CD_GRUPO_FUNCAO = RTRIM(P_CD_GRUPO_FUNCAO),
		       DT_ULTIMA_ALTERACAO = SYSDATE
	        WHERE  NM_MICRO_VISAO = P_NM_MICRO_VISAO;
	        COMMIT;
		ELSE
		    HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel alterar micro vis&atilde;o, valor duplicado')||'!');
		END IF;
	END IF;

END SAVEMV;

PROCEDURE SAVEGO ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
		           PRM_GO     VARCHAR2 DEFAULT NULL,
				   PRM_ORDEM  VARCHAR2 DEFAULT NULL ) AS

	WS_CHECK  NUMBER;
	WS_TIPO   VARCHAR2(4000);
	WS_NOME   VARCHAR2(4000);
	WS_VISAO  VARCHAR2(4000);

BEGIN
    
    
    IF NVL(PRM_GO, 'N/A') <> 'N/A' THEN

		IF FUN.CHECK_ADMIN('DRILLS_ADD') THEN

			IF NVL(PRM_ORDEM, 'N/A') <> 'N/A' THEN
				UPDATE GOTO_OBJETO SET ORDEM = PRM_ORDEM WHERE CD_OBJETO = PRM_OBJETO AND CD_OBJETO_GO = PRM_GO;
			ELSE
	        
				FOR I IN(SELECT COLUMN_VALUE FROM TABLE((FUN.VPIPE(PRM_GO)))) LOOP
					SELECT COUNT(*) INTO WS_CHECK FROM GOTO_OBJETO WHERE CD_USUARIO = 'DWU' AND CD_OBJETO_GO = I.COLUMN_VALUE AND CD_OBJETO = PRM_OBJETO;
					IF WS_CHECK = 0 THEN
						
						INSERT INTO GOTO_OBJETO
						( CD_USUARIO, CD_OBJETO, CD_OBJETO_GO )
						VALUES
						( 'DWU', PRM_OBJETO, I.COLUMN_VALUE );
						
					END IF;
				END LOOP;

			END IF;
			
			COMMIT;
			HTP.P('ok');
			
		ELSE
		    HTP.P(FUN.LANG('Sem permiss&atilde;o')||'!');
		END IF;
	ELSE
	    HTP.P(FUN.LANG('Nenhum valor selecionado')||'!');
	END IF;
	
EXCEPTION WHEN OTHERS THEN
    ROLLBACK;
    HTP.P(FUN.LANG('Erro ao adicionar drills')||': '||SQLERRM);
END SAVEGO;

PROCEDURE SAVECALL ( PRM_OBJETO	     VARCHAR2 DEFAULT NULL,
		             PRM_OBJETO_GO	 VARCHAR2 DEFAULT NULL,
		             PRM_SCREEN      VARCHAR2 DEFAULT NULL ) AS


		
	WS_COUNT NUMBER;
	WS_FAIL EXCEPTION;

BEGIN

	INSERT INTO CALL_LIST (CD_LIST, CD_OBJETO, POSX, POSY)
	SELECT PRM_OBJETO, COLUMN_VALUE, '', '' FROM TABLE(FUN.VPIPE(PRM_OBJETO_GO));
    
    WS_COUNT := SQL%ROWCOUNT;
    
    IF WS_COUNT <> 0 THEN
        COMMIT;
    ELSE
        RAISE WS_FAIL;
    END IF;

EXCEPTION
    WHEN WS_FAIL THEN
        ROLLBACK;
        HTP.P('FAIL');
    WHEN OTHERS THEN
        ROLLBACK;
        HTP.P('FAIL');
END SAVECALL;


PROCEDURE SAVE_FORMULA( PRM_COLUNA  VARCHAR2 DEFAULT NULL,
			            PRM_FORMULA VARCHAR2 DEFAULT NULL,
			            PRM_TABELA  VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	UPDATE MICRO_COLUNA SET
	FORMULA	= PRM_FORMULA
	WHERE	TRIM(CD_MICRO_VISAO) = PRM_TABELA AND
	TRIM(CD_COLUNA)      = PRM_COLUNA;
	COMMIT;

EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END SAVE_FORMULA;

PROCEDURE SAVE_MVISAO (	P_CD_COLUNA		  IN OWA_UTIL.IDENT_ARR,
			            P_GRAVACAO		  IN OWA_UTIL.IDENT_ARR,
			            P_NM_ROTULO		  IN OWA_UTIL.IDENT_ARR,
			            P_ST_GERAR		  IN OWA_UTIL.IDENT_ARR,
			            P_ST_AGRUPADOR	  IN OWA_UTIL.IDENT_ARR,
			            P_NM_MASCARA	  IN OWA_UTIL.IDENT_ARR,
			            P_CD_LIGACAO	  IN OWA_UTIL.IDENT_ARR,
			            P_ST_COM_CODIGO	  IN OWA_UTIL.IDENT_ARR,
			            P_ST_ALINHAMENTO  IN OWA_UTIL.IDENT_ARR,
			            P_ST_RESUMIDO	  IN OWA_UTIL.IDENT_ARR,
			            P_ST_NEGRITO	  IN OWA_UTIL.IDENT_ARR,
			            P_ST_INVISIVEL	  IN OWA_UTIL.IDENT_ARR,
			            P_NM_UNIDADE	  IN OWA_UTIL.IDENT_ARR,
			            P_TABELA		  IN VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT	NUMBER;

BEGIN
    
	HTP.HTMLOPEN;
	HTP.BODYOPEN;

	FOR I IN P_CD_COLUNA.FIRST..P_CD_COLUNA.LAST LOOP
		IF  RTRIM(P_GRAVACAO(I)) = '##SEM_LINHA##' AND NVL(TRIM(P_NM_ROTULO(I)),'$%%$')<>'$%%$' THEN
			INSERT INTO MICRO_COLUNA VALUES ( TRIM(P_TABELA), TRIM(P_CD_COLUNA(I)), TRIM(P_NM_ROTULO(I)),
			FCL.FPDATA(TRIM(P_ST_GERAR(I)),'S','S','N'), TRIM(P_ST_AGRUPADOR(I)), TRIM(P_NM_MASCARA(I)),
			TRIM(P_CD_LIGACAO(I)), FCL.FPDATA(TRIM(P_ST_COM_CODIGO(I)),'S','S','N'), TRIM(P_ST_ALINHAMENTO(I)),
			FCL.FPDATA(TRIM(P_ST_RESUMIDO(I)),'S','S','N'), FCL.FPDATA(TRIM(P_ST_NEGRITO(I)),'S','S','N'),
			FCL.FPDATA(TRIM(P_ST_INVISIVEL(I)),'S','S','N'),
			TRIM(P_NM_UNIDADE(I)), '', 'T', '', '', '', '', '', '', '');
			COMMIT;
		END IF;

		IF  NVL(TRIM(P_NM_ROTULO(I)),'$%%$')<>'$%%$' AND RTRIM(P_GRAVACAO(I)) <> '##SEM_LINHA##' THEN
			UPDATE MICRO_COLUNA SET
				NM_ROTULO = TRIM(P_NM_ROTULO(I)),
				ST_GERA_REL = FCL.FPDATA(TRIM(P_ST_GERAR(I)),'S','S','N'),
				ST_AGRUPADOR = TRIM(P_ST_AGRUPADOR(I)),
				NM_MASCARA = TRIM(P_NM_MASCARA(I)),
				CD_LIGACAO = TRIM(P_CD_LIGACAO(I)),
				ST_COM_CODIGO = FCL.FPDATA(TRIM(P_ST_COM_CODIGO(I)),'S','S','N'),
				ST_ALINHAMENTO = TRIM(P_ST_ALINHAMENTO(I)),
				ST_RESUMIDO = FCL.FPDATA(TRIM(P_ST_RESUMIDO(I)),'S','S','N'),
				ST_NEGRITO = FCL.FPDATA(TRIM(P_ST_NEGRITO(I)),'S','S','N'),
				ST_INVISIVEL = FCL.FPDATA(TRIM(P_ST_INVISIVEL(I)),'S','S','N'),
				NM_UNIDADE = TRIM(P_NM_UNIDADE(I))
			WHERE TRIM(CD_MICRO_VISAO) = TRIM(P_TABELA) AND
				TRIM(CD_COLUNA)      = TRIM(P_GRAVACAO(I));
			COMMIT;
		END IF;
	END LOOP;

	HTP.P('<script>parent.history.back(); alerta(''msg'', '''||FUN.LANG('Alterado com sucesso')||'!'');</script>');

	HTP.BODYCLOSE;
	HTP.HTMLCLOSE;

EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END SAVE_MVISAO;



PROCEDURE LIST_CROCKS AS

	CURSOR CRS_TABELAS IS
		SELECT 	NM_MICRO_VISAO, NM_TABELA, CD_GRUPO_FUNCAO
		FROM MICRO_VISAO
		ORDER BY CD_GRUPO_FUNCAO, NM_MICRO_VISAO;

	WS_TABELAS	CRS_TABELAS%ROWTYPE;
	WS_TMP		LONG;
	WS_COUNT	NUMBER;
	WS_PRIMEIRO	VARCHAR2(60);
    WS_GRUPO    VARCHAR2(40) := '999999999';
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
BEGIN
    
	WS_COUNT := 0;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	HTP.P('<div style="display: block; width: 580px; margin-bottom: 4px; text-align: center;">
		<select id="list_coluna" style="width: 250px;" onchange=" if(this.options[this.selectedIndex].id != ''''){ loader(''ajax''); ajax(''main'', ''load_crocks'', ''prm_visao=''+this.value, ''true'', ''ajax''); telaSup(''visao'',this.options[this.selectedIndex].id); }">');
			HTP.P('<option>'||FUN.LANG('Escolha uma view')||'</option>');
			OPEN CRS_TABELAS;
				LOOP
					FETCH CRS_TABELAS INTO WS_TABELAS;
					EXIT WHEN CRS_TABELAS%NOTFOUND;
					IF WS_GRUPO <> WS_TABELAS.CD_GRUPO_FUNCAO THEN
						HTP.P('<optgroup label="'||FUN.UTRANSLATE('CD_GRUPO', 'GRUPOS_FUNCAO', WS_TABELAS.CD_GRUPO_FUNCAO, WS_PADRAO)||'"></optgroup>');
						WS_GRUPO := WS_TABELAS.CD_GRUPO_FUNCAO;
					END IF;
					HTP.P('<option id="'||WS_TABELAS.NM_MICRO_VISAO||'" value="'||WS_TABELAS.NM_MICRO_VISAO||'">['||FUN.UTRANSLATE('NM_MICRO_VISAO', 'MICRO_VISAO', WS_TABELAS.NM_MICRO_VISAO, WS_PADRAO)||'] '||WS_TABELAS.NM_TABELA||'</option>');
					IF  WS_PRIMEIRO = '%First%' THEN
						WS_PRIMEIRO := WS_TABELAS.NM_TABELA;
					END IF;
					WS_COUNT := WS_COUNT + 1;
				END LOOP;
			CLOSE CRS_TABELAS;
		HTP.P('</select>');

	HTP.P('<input id="add_coluna" maxlength="25" type="text" class="up" /><a class="add" style="float: none;" title="'||FUN.LANG('Inserir nova coluna')||'" onclick="coluna = document.getElementById(''add_coluna'').value; if(coluna.trim().length > 1){ visao = document.getElementById(''telasup'').getAttribute(''data-visao''); if(visao.trim().length != 0){ ajax(''fly'', ''savecolumn'', ''p_cd_coluna=''+coluna+''&p_visao=''+visao, false); noerror('''', '''||FUN.LANG('Coluna adicionada com sucesso')||'!'', ''msg''); ajax(''list'', ''load_crocks'', ''value1=''+document.getElementById(''telasup'').getAttribute(''data-visao''), ''true'', ''ajax''); } else { alerta(''msg'','''||FUN.LANG('Escolha uma vis&atilde;o')||'!''); }} else { alerta(''msg'','''||FUN.LANG('Nome da coluna não pode estar em branco')||'!''); }} else { alerta(''msg'','''||FUN.LANG('Valor inv&aacute;lido, somente letras, números e underscore s&atilde;o permitidos')||'!''); } ">+</a></div>');

	HTP.P('<div id="ajax" style="min-width: 195px; float: left; margin-top: 2px; width: 210px; overflow-x: hidden; height: 314px;"></div>');
	HTP.P('<div id="fields" class="disabled"></div>');
    HTP.P('<div class="listar">');
	HTP.P('<a onclick="call_save(''''); carrega(''load_tables''); carregaPainel(''visoes''); document.getElementById(''titulo'').innerHTML= '''||FUN.LANG('Lista de Views')||'''; ">'||FUN.LANG('Listar Views')||'</a>');
	HTP.P('</div>');


END LIST_CROCKS;


PROCEDURE LIST_USERS ( PRM_ORDER VARCHAR2 DEFAULT '1',
                       PRM_DIR   VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_LISTA IS
    SELECT USU_NOME, USU_COMPLETO, USU_EMAIL, 
	LISTAGG(CD_GROUP,'|') WITHIN GROUP (ORDER BY CD_GROUP) AS GRUPO 
	
    FROM USUARIOS T1
	LEFT JOIN GUSERS_ITENS ON TRIM(UPPER(CD_USUARIO)) = TRIM(UPPER(USU_NOME))
	WHERE STATUS = 'A'
	GROUP BY USU_NOME, USU_COMPLETO, USU_EMAIL
    ORDER BY 
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', T1.USU_NOME, '2', T1.USU_COMPLETO, '3', T1.USU_EMAIL, T1.USU_NOME) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', T1.USU_NOME, '2', T1.USU_COMPLETO, '3', T1.USU_EMAIL, T1.USU_NOME) END DESC;
 
    WS_LINHA CRS_LISTA%ROWTYPE;

	CURSOR CRS_INATIVOS IS
    SELECT USU_NOME, USU_COMPLETO, USU_EMAIL, 
	LISTAGG(CD_GROUP,'|') WITHIN GROUP (ORDER BY CD_GROUP) AS GRUPO 
	
    FROM USUARIOS T1
	LEFT JOIN GUSERS_ITENS ON TRIM(UPPER(CD_USUARIO)) = TRIM(UPPER(USU_NOME))
	WHERE STATUS = 'I'
	GROUP BY USU_NOME, USU_COMPLETO, USU_EMAIL
    ORDER BY 
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', T1.USU_NOME, '2', T1.USU_COMPLETO, '3', T1.USU_EMAIL, T1.USU_NOME) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', T1.USU_NOME, '2', T1.USU_COMPLETO, '3', T1.USU_EMAIL, T1.USU_NOME) END DESC;

    WS_INATIVO CRS_INATIVOS%ROWTYPE;

	WS_DIR NUMBER := 1;
    WS_LOCK VARCHAR2(80);

	WS_NOADMIN EXCEPTION;

BEGIN
	
	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	
	HTP.P('<table class="linha">');
		HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">EMAIL</a></th>');
				HTP.P('<th>PASSWORD</th>');
				HTP.P('<th>'||FUN.LANG('GRUPO')||'</th>');
				HTP.P('<th></th>');
				
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN
			WS_DIR := 2;
		END IF;

		HTP.P('<tbody id="ajax" class="usuarios" data-dir="'||WS_DIR||'">');

		OPEN CRS_LISTA;
			LOOP
				FETCH CRS_LISTA INTO WS_LINHA;
				EXIT WHEN CRS_LISTA%NOTFOUND;
				
				HTP.P('<tr>');
					HTP.P('<td>'||WS_LINHA.USU_NOME||'</td>');
					HTP.P('<td><div data-default="'||WS_LINHA.USU_COMPLETO||'" onblur="userEvent(this, '''||TRIM(WS_LINHA.USU_NOME)||''', ''blur'');" contenteditable="true" class="editable longname">'||WS_LINHA.USU_COMPLETO||'</div></td>');
					HTP.P('<td><div title="'||WS_LINHA.USU_EMAIL||'" data-default="'||WS_LINHA.USU_EMAIL||'" onblur="userEvent(this, '''||TRIM(WS_LINHA.USU_NOME)||''', ''email'');" contenteditable="true" class="editable longname" class="link">'||WS_LINHA.USU_EMAIL||'</div></td>');
					HTP.P('<td>');
						HTP.P('<input type="password" placeholder="PASSWORD" onkeypress="if(event.which == 13){ this.blur(); /*passChange(this, '''||UPPER(TRIM(WS_LINHA.USU_NOME))||''');*/ }" onblur="passChange(this, '''||UPPER(TRIM(WS_LINHA.USU_NOME))||''');"/>');
					HTP.P('</td>');
					HTP.P('<td>');
						HTP.P('<a class="script" onclick="userEvent(this.nextElementSibling, '''||TRIM(WS_LINHA.USU_NOME)||''', ''grupo'');"></a>');
						FCL.FAKEOPTION('usuario-grupo-'||TRIM(WS_LINHA.USU_NOME)||'', WS_LINHA.GRUPO, WS_LINHA.GRUPO, 'lista-gusers', 'N', 'S', '', PRM_DESC => REPLACE(WS_LINHA.GRUPO, '|', ', '));
					HTP.P('</td>');
					
					HTP.P('<td><a class="addpurple aduser" title="'||TRIM(WS_LINHA.USU_NOME)||'">'||FUN.LANG('MAIS OP&Ccedil;&Otilde;ES')||'</a></td>');

					IF UPPER(TRIM(WS_LINHA.USU_NOME)) = 'DWU' THEN
						HTP.P('<td><a class="noremove" title="'||FUN.LANG('Imposs&iacute;vel excluir DWU')||'" onclick=" alerta(''msg'', '''||FUN.LANG('Imposs&iacute;vel excluir DWU')||'!'');">X</a></td>');
					ELSE
						HTP.P('<td>');
							FCL.BUTTON_LIXO('delete_user', 'usu_nome_d', TRIM(WS_LINHA.USU_NOME));
						HTP.P('</td>');
					END IF;
					
				HTP.P('</tr>');
			END LOOP;
		CLOSE CRS_LISTA;
		HTP.P('</tbody>');
	HTP.P('</table>');

	HTP.P('<table class="linha">');
		HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''list_users'', ''prm_order=3&prm_dir=''+dir, false, ''content'');">EMAIL</a></th>');
				HTP.P('<th>PASSWORD</th>');
				HTP.P('<th>'||FUN.LANG('GRUPO')||'</th>');
				HTP.P('<th></th>');
				
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN
			WS_DIR := 2;
		END IF;

		HTP.P('<h2>'||FUN.LANG('USU&Aacute;RIOS DESATIVADOS')||'</h2>');

		HTP.P('<tbody class="usuarios" data-dir="'||WS_DIR||'">');

		OPEN CRS_INATIVOS;
			LOOP
				FETCH CRS_INATIVOS INTO WS_INATIVO;
				EXIT WHEN CRS_INATIVOS%NOTFOUND;
				
				HTP.P('<tr>');
					HTP.P('<td>'||WS_INATIVO.USU_NOME||'</td>');
					HTP.P('<td><div data-default="'||WS_INATIVO.USU_COMPLETO||'" onblur="userEvent(this, '''||TRIM(WS_INATIVO.USU_NOME)||''', ''blur'');" contenteditable="true" class="editable longname">'||WS_INATIVO.USU_COMPLETO||'</div></td>');
					HTP.P('<td><div title="'||WS_INATIVO.USU_EMAIL||'" data-default="'||WS_INATIVO.USU_EMAIL||'" onblur="userEvent(this, '''||TRIM(WS_INATIVO.USU_NOME)||''', ''email'');" contenteditable="true" class="editable longname" class="link">'||WS_INATIVO.USU_EMAIL||'</div></td>');
					HTP.P('<td>');
						HTP.P('<input type="password" placeholder="PASSWORD" onkeypress="if(event.which == 13){ this.blur();" onblur="passChange(this, '''||UPPER(TRIM(WS_INATIVO.USU_NOME))||''');"/>');
					HTP.P('</td>');
					HTP.P('<td>');
						HTP.P('<a class="script" onclick="userEvent(this.nextElementSibling, '''||TRIM(WS_INATIVO.USU_NOME)||''', ''grupo'');"></a>');
						FCL.FAKEOPTION('usuario-grupo-'||TRIM(WS_LINHA.USU_NOME)||'', WS_INATIVO.GRUPO, WS_INATIVO.GRUPO, 'lista-gusers', 'N', 'S', '', PRM_DESC => REPLACE(WS_INATIVO.GRUPO, '|', ', '));
					HTP.P('</td>');
					
					HTP.P('<td><a class="addpurple aduser" title="'||TRIM(WS_INATIVO.USU_NOME)||'">MAIS OP&Ccedil;&Otilde;ES</a></td>');

					IF UPPER(TRIM(WS_INATIVO.USU_NOME)) = 'DWU' THEN
						HTP.P('<td><a class="noremove" title="'||FUN.LANG('Imposs&iacute;vel excluir DWU')||'" onclick=" alerta(''msg'', '''||FUN.LANG('Imposs&iacute;vel excluir DWU')||'!'');">X</a></td>');
					ELSE
						HTP.P('<td>');
							FCL.BUTTON_LIXO('delete_user', 'usu_nome_d', TRIM(WS_INATIVO.USU_NOME));
						HTP.P('</td>');
					END IF;
					
				HTP.P('</tr>');
			END LOOP;
		CLOSE CRS_INATIVOS;
		HTP.P('</tbody>');
	HTP.P('</table>');
EXCEPTION
	WHEN WS_NOADMIN THEN
		HTP.P('Sem premiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_USERS;


PROCEDURE ADVANCEDUSERS ( PRM_USER VARCHAR2 ) AS

    CURSOR CRS_USUARIO IS
	SELECT STATUS, SHOW_ONLY, UPLOAD, EXCEL_OUT FROM USUARIOS
	WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_USER));

	WS_USUARIO CRS_USUARIO%ROWTYPE;

BEGIN

    OPEN CRS_USUARIO;
	    FETCH CRS_USUARIO INTO WS_USUARIO;
		
	CLOSE CRS_USUARIO;

    HTP.P('<div class="itens" style="width: 346px;" style="position: relative;">');

		HTP.P('<h2>'||FUN.LANG('OP&Ccedil;&Otilde;ES AVAN&Ccedil;ADAS')||'</h2>');

		HTP.P('<ul class="form">');
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('USU&Aacute;RIO')||'</span>');
				HTP.P('<span class="after">');
					HTP.P('<input type="text" readonly class="readonly" value="'||TRIM(PRM_USER)||'"/>');
				HTP.P('</span>');
			HTP.P('</li>');
		
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('TIPO')||'</span>');
				HTP.P('<span class="after">');
					HTP.P('<select onchange="call(''show_update'', ''prm_usuario='||TRIM(PRM_USER)||'&prm_screen=''+this.value+''&prm_time=&prm_ordem=&prm_tipo=show'').then(function(res){ if(res.indexOf(''fail'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
						IF WS_USUARIO.SHOW_ONLY = 'S' THEN
							HTP.P('<option value="N">Normal</option>');
							HTP.P('<option value="A">Admin</option>');
							HTP.P('<option value="S" selected>Slide</option>');
						ELSIF WS_USUARIO.SHOW_ONLY = 'A' THEN
							HTP.P('<option value="N">Normal</option>');
							HTP.P('<option value="A" selected>Admin</option>');
							HTP.P('<option value="S">Slide</option>');
						ELSE
							HTP.P('<option value="N" selected>Normal</option>');
							HTP.P('<option value="A">Admin</option>');
							HTP.P('<option value="S">Slide</option>');
						END IF;
						HTP.P('</select>');
					HTP.P('</select>');
				HTP.P('</span');
			HTP.P('</li>');

			IF GBL.GETUSUARIO <> PRM_USER THEN
			
				HTP.P('<li>');
					HTP.P('<span class="before">'||FUN.LANG('ATIVO')||'</span>');
					HTP.P('<span class="after">');
						HTP.P('<a class="script" onclick="userEvent(this.nextElementSibling, '''||TRIM(PRM_USER)||''', ''status'');"></a>');
						IF WS_USUARIO.STATUS = 'A' THEN
							HTP.P('<span class="checkbox checked" data-positive="A" data-negative="I" title="'||WS_USUARIO.STATUS||'"></span>');
						ELSE
							HTP.P('<span class="checkbox" data-positive="A" data-negative="I" title="'||WS_USUARIO.STATUS||'"></span>');
						END IF;
					HTP.P('</span>');
				HTP.P('</li>');

			END IF;
			
			HTP.P('<li>');
			    HTP.P('<span class="before">UPLOAD</span>');
				HTP.P('<span class="after">');
					HTP.P('<a class="script" onclick="userEvent(this.nextElementSibling, '''||TRIM(PRM_USER)||''', ''upload'');"></a>');
					IF WS_USUARIO.UPLOAD = 'S' THEN
						HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||WS_USUARIO.UPLOAD||'"></span>');
					ELSE
						HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||WS_USUARIO.UPLOAD||'"></span>');
					END IF;
			HTP.P('</li>');
		
			HTP.P('<li>');
				HTP.P('<span class="before">EXCEL</span>');
				HTP.P('<span class="after">');
					HTP.P('<a class="script" onclick="userEvent(this.nextElementSibling, '''||TRIM(PRM_USER)||''', ''excel'');"></a>');
						IF NVL(WS_USUARIO.EXCEL_OUT, 'S') = 'S' THEN
							HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||WS_USUARIO.EXCEL_OUT||'"></span>');
						ELSE
							HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||WS_USUARIO.EXCEL_OUT||'"></span>');
						END IF;
				HTP.P('</span>');
			HTP.P('</li>');
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('COPIAR REGRAS')||'</span>');
				HTP.P('<span class="after">');
				    HTP.P('<a class="link" onclick="copyListBtn('''||TRIM(PRM_USER)||''');">'||FUN.LANG('LISTAR USU&Aacute;RIOS')||'</a>');
				HTP.P('</span>');
			HTP.P('</li>');
			
			HTP.P('<li>');
				HTP.P('<span class="before">'||FUN.LANG('PERMISS&Otilde;ES')||'</span>');
				HTP.P('<span class="after">');
					HTP.P('<select onchange="userEvent(this, '''||TRIM(PRM_USER)||''', ''permissao'');">');
						HTP.P('<option value="n/a" disabled hidden selected></option>');
						HTP.P('<option value="column">'||FUN.LANG('BLOQUEIO DE COLUNA')||'</option>');
						HTP.P('<option value="object">'||FUN.LANG('BLOQUEIO DE OBJETO')||'</option>');
						--HTP.P('<option value="custom">'||FUN.LANG('CONSULTA CUSTOMIZADA')||'</option>'); ////REMOVIDO -- CONSULTA CUSTOMIZADA NÃO FUNCIONA NA 1.5.5 01/06/22
						HTP.P('<option value="td">NETWALL</option>');
						HTP.P('<option value="screen">'||FUN.LANG('TELAS DISPON&Iacute;VEIS')||'</option>');
					HTP.P('</select>');
				HTP.P('</span>');
			HTP.P('</li>');

		HTP.P('</ul>');

	HTP.P('</div>');

	FCL.CLOSER_MENU;

END;


PROCEDURE DELETE_USER ( USU_NOME_D VARCHAR2 DEFAULT NULL ) AS
	
    WS_USER      NUMBER;
	WS_LOGIN     VARCHAR2(80);
	WS_TEST      VARCHAR2(100);

	WS_NOADMIN   EXCEPTION;
	WS_EXCEPTION EXCEPTION;

BEGIN
		
	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	
	WS_LOGIN := UPPER(TRIM(USU_NOME_D));
		
    SELECT COUNT(*) INTO WS_USER FROM USUARIOS WHERE UPPER(TRIM(USU_NOME)) = WS_LOGIN;

    IF WS_USER <> 0 THEN

		WS_TEST := FUN.REMOVE_USER(WS_LOGIN);
				 
		IF WS_TEST = 'OK' THEN
			INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Usu&aacute;rio '||WS_LOGIN||' excluido do sistema', GBL.GETUSUARIO, 'EVENTO');
			COMMIT;	
		END IF;

	ELSE
		HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel excluir usu&aacute;rio, valor inexistente')||'!');
	END IF;

EXCEPTION
    WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_EXCEPTION THEN
	    HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel excluir usu&aacute;rio ')||'!');
    WHEN OTHERS THEN
		HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel excluir usu&aacute;rio')||'!');
END DELETE_USER;


procedure save_user ( prm_nome      varchar2 default null,
		              prm_completo  varchar2 default null,
		              prm_status    varchar2 default null,
		              prm_email     varchar2 default null,
		              prm_senha     varchar2 default null,
                      prm_permissao varchar2 default 'none',
					  prm_grupo     varchar2 default null ) as
	
	ws_user	     number;
    ws_count     number;
	ws_test      varchar2(10);
    ws_completo  varchar2(800);
	ws_usuario	 varchar2(100);
	ws_msg_erro  varchar2(100); 

	ws_noadmin   	exception;
	ws_noaction  	exception;
	ws_create    	exception;
	ws_raise        exception;

begin

	ws_usuario:=gbl.getUsuario;

	if gbl.getNivel <> 'A' then
		raise ws_noadmin;
	end if;

	select count(*) into ws_user 
	  from USUARIOS where upper(trim(usu_nome)) = upper(trim(prm_nome)); 
	if ws_user > 0 then
		ws_msg_erro := 'Usu&aacute;rio j&aacute; existe no sistema';  
		raise ws_raise; 
	end if; 

    if instr(nvl(prm_email,'N/A'),'@') = 0 then 
		ws_msg_erro := 'E-mail inv&aacute;lido ou n&atilde;o preenchido';  
		raise ws_raise; 
	else 
		select count(*) into ws_user 
	 	  from usuarios 
		 where upper(trim(usu_nome)) <> upper(trim(prm_nome))
		   and upper(trim(usu_email)) = upper(trim(prm_email)); 
		if ws_user > 0 then    
			ws_msg_erro := 'Endere&ccedil;o de e-mail j&aacute; utilizado em outro usu&aacute;rio';  
			raise ws_raise; 
		end if;	
	end if; 

	ws_completo := fun.converte(prm_completo);
	ws_test := fun.create_user(upper(trim(prm_nome)), prm_senha, prm_permissao, prm_email, ws_completo);

	if ws_test = 'ERRO' then
		raise ws_create;
	end if;
		
	if nvl(prm_grupo, 'N/A') <> 'N/A' then
		insert into gusers_itens ( cd_group, cd_usuario ) values (prm_grupo, trim(upper(prm_nome)));
		commit;
	end if;

	insert into bi_log_sistema values (sysdate,'USUARIO '||prm_nome||' DO GRUPO '||prm_grupo||' CRIADO COM SUCESSO!',ws_usuario,'EVENTO');
	commit;

exception
	when ws_noadmin then
		htp.p('Sem permiss&atilde;o!');
	when ws_create then
	    htp.p('FAIL '||fun.lang('Erro na cria&ccedil;&atilde;o do usu&aacute;rio! ===> ')||sqlerrm||'!');
	when ws_raise  then
	    htp.p('FAIL '||fun.lang(ws_msg_erro));
	when others then
	    htp.p(sqlerrm);
end save_user;


/*********************
PROCEDURE SAVE_USER ( PRM_NOME      VARCHAR2 DEFAULT NULL,
		              PRM_COMPLETO  VARCHAR2 DEFAULT NULL,
		              PRM_STATUS    VARCHAR2 DEFAULT NULL,
		              PRM_EMAIL     VARCHAR2 DEFAULT NULL,
		              PRM_SENHA     VARCHAR2 DEFAULT NULL,
                      PRM_PERMISSAO VARCHAR2 DEFAULT 'none',
					  PRM_GRUPO     VARCHAR2 DEFAULT NULL ) AS
	
	WS_USER	     NUMBER;
    WS_COUNT     NUMBER;
	WS_TEST      VARCHAR2(10);
    WS_COMPLETO  VARCHAR2(800);

	WS_NOADMIN   EXCEPTION;
	WS_NOACTION  EXCEPTION;
	WS_CREATE    EXCEPTION;

BEGIN
	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;
	WS_COMPLETO := FUN.CONVERTE(PRM_COMPLETO);
	SELECT COUNT(*) INTO WS_USER FROM (
		SELECT DISTINCT(USU_NOME) AS NOME FROM USUARIOS WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_NOME))
	);

	IF WS_USER = 0 THEN
		WS_TEST := FUN.CREATE_USER(UPPER(TRIM(PRM_NOME)), PRM_SENHA, PRM_PERMISSAO, PRM_EMAIL, WS_COMPLETO);
		IF WS_TEST = 'ERRO' THEN
			RAISE WS_CREATE;
		END IF;
		IF NVL(PRM_GRUPO, 'N/A') <> 'N/A' THEN
			INSERT INTO GUSERS_ITENS ( CD_GROUP, CD_USUARIO ) VALUES (PRM_GRUPO, TRIM(UPPER(PRM_NOME)));
			COMMIT;
		END IF;
	ELSE
		HTP.P('FAIL '||FUN.LANG('Usu&aacute;rio j&aacute; existe no sistema')||'!');
	END IF;
EXCEPTION
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_CREATE THEN
	    HTP.P('FAIL '||FUN.LANG('Erro na cria&ccedil;&atilde;o do usu&aacute;rio! ===> ')||SQLERRM||'!');
	WHEN OTHERS THEN
	    HTP.P(SQLERRM);
END SAVE_USER;
*******/ 

PROCEDURE ALTER_USER ( PRM_NOME VARCHAR2 DEFAULT NULL,
                       PRM_VALOR VARCHAR2 DEFAULT NULL,
					   PRM_TIPO VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT   NUMBER;

	WS_COMANDO      VARCHAR2(2000);
    JOB_ID          NUMBER;
    WS_OWNER        VARCHAR2(90);
    WS_NAME         VARCHAR2(90);
    WS_LINE         NUMBER;
    WS_CALLER       VARCHAR2(90);
	ws_email		VARCHAR2(500);
	
	WS_NOADMIN 			EXCEPTION;
	ws_raise_email  	exception;
	WS_RAISE_EMAIL_NULL	exception;

BEGIN

	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;

	IF PRM_TIPO = 'nome' THEN
		UPDATE USUARIOS
		SET USU_COMPLETO = TRIM(FUN.CONVERTE(REPLACE(REPLACE(TRIM(PRM_VALOR), CHR(34), ''), CHR(39), '')))
		WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_NOME));
	ELSIF PRM_TIPO = 'email' THEN
		ws_email := replace(replace(trim(prm_valor), chr(34), ''), chr(39), ''); 
		select count(*) into ws_count
		  from usuarios 
		 where upper(trim(usu_nome)) <> upper(trim(prm_nome)) 
		   and upper(trim(usu_email)) = upper(trim(ws_email)); 

		if ws_count <> 0 then
			raise ws_raise_email;
		else
			IF WS_EMAIL IS NULL THEN
				RAISE WS_RAISE_EMAIL_NULL;
			ELSE
				update usuarios
				set usu_email = ws_email 
				where upper(trim(usu_nome)) = upper(trim(prm_nome));

			-- utilizado o EXECUTE para casos em que o cliente ainda não tem o campo DT_ULTIMA_VALIDACAO (Somente na v155)
				begin 
					EXECUTE IMMEDIATE 'update usuarios set dt_ultima_validacao = null where upper(trim(usu_nome)) = :b1' USING upper(trim(prm_nome)); 	
				exception when others then
					null;
				end;
			end if;	

		end if;	
		-- UPDATE USUARIOS
		-- SET USU_EMAIL = REPLACE(REPLACE(TRIM(PRM_VALOR), CHR(34), ''), CHR(39), '')
		-- WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_NOME));
	ELSIF PRM_TIPO = 'grupo' THEN
		DELETE FROM GUSERS_ITENS WHERE CD_USUARIO = PRM_NOME;
		COMMIT;
		FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_VALOR))) LOOP
			INSERT INTO GUSERS_ITENS (CD_GROUP, CD_USUARIO) VALUES (I.COLUMN_VALUE, PRM_NOME);
			COMMIT;
		END LOOP;
	ELSIF PRM_TIPO = 'upload' THEN
		UPDATE USUARIOS
		SET UPLOAD = TRIM(PRM_VALOR)
		WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_NOME));
	ELSIF PRM_TIPO = 'excel_out' THEN
		UPDATE USUARIOS
		SET EXCEL_OUT = TRIM(PRM_VALOR)
		WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_NOME));
	ELSE
		UPDATE USUARIOS
		SET STATUS = TRIM(PRM_VALOR)
		WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_NOME));
	END IF;

	insert into log_eventos values(sysdate, 'ALTERACAO USUARIO ['||prm_tipo||']', prm_nome, 'TELA', 'USUARIO', '01');

EXCEPTION 
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	when ws_raise_email then
		htp.p('!alertEndere&ccedil;o de e-mail j&aacute; utilizado em outro usu&aacute;rio');
	WHEN WS_RAISE_EMAIL_NULL THEN
		htp.p('!alertEndere&ccedil;o de e-mail precisa ser preenchido');		
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END ALTER_USER;


PROCEDURE SCREEN_ACCESS ( PRM_USUARIO     VARCHAR2 DEFAULT NULL, 
                          PRM_CONTEUDO    VARCHAR2 DEFAULT 'FULL',
						  PRM_GRUPO       VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_USER IS
		SELECT NOME, GRUPO, TELA, TEMPO, ORDEM FROM(
			SELECT T1.NM_OBJETO NOME, T1.CD_GRUPO GRUPO, T2.SCREEN TELA, TIME TEMPO, T3.ORDEM ORDEM
			FROM USER_SCREENS T2
			LEFT JOIN USER_SEQUENCE T3 ON T3.USUARIO = T2.USUARIO AND T3.SCREEN = T2.SCREEN 
			LEFT JOIN OBJETOS T1 ON T1.CD_OBJETO = T2.SCREEN
			WHERE TRIM(T2.USUARIO) = TRIM(PRM_USUARIO) AND
			CD_GRUPO = NVL(PRM_GRUPO, CD_GRUPO)

			UNION ALL

			SELECT SCREEN NOME, '--' GRUPO, SCREEN TELA, 0 TEMPO, 0 ORDEM
			FROM USER_SCREENS 
			WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO) AND SCREEN IN (SELECT CD_GRUPO FROM GRUPOS_FUNCAO)

		)
		ORDER BY GRUPO, NOME;

		WS_LINHA CRS_USER%ROWTYPE;

	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN

    IF PRM_CONTEUDO = 'FULL' THEN

        HTP.P('<div class="searchbar">');
			HTP.P('<a class="script" onclick="userEvent(this.nextElementSibling, '''||PRM_USUARIO||''', ''permissao-fake'');"></a>');
			FCL.FAKEOPTION('lista-grupos', FUN.LANG('Busca por grupos'), '', 'lista-grupos', 'N', 'N', '', '', 'todos');
		HTP.P('</div>');

		HTP.P('<table class="linha">');
			HTP.P('<thead>');
				HTP.P('<th style="width: 20%;">'||FUN.LANG('GRUPO')||'</th>');
				HTP.P('<th style="width: 22%;">'||FUN.LANG('USU&Aacute;RIO')||'</th>');
				HTP.P('<th style="width: 34%;">'||FUN.LANG('TELA')||'</th>');
				HTP.P('<th style="width: 10%;">'||FUN.LANG('TEMPO')||'</th>');
				HTP.P('<th style="width: 10%;">'||FUN.LANG('ORDEM')||'</th>');
				HTP.P('<th style="width: 4%;"></th>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax">');

	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	OPEN CRS_USER;
		LOOP
			FETCH CRS_USER INTO WS_LINHA;
			EXIT WHEN CRS_USER%NOTFOUND;
			HTP.P('<tr id="screen_access_'||WS_LINHA.TELA||'">');
				HTP.P('<td class="up">'||WS_LINHA.GRUPO||'</td>');
				HTP.P('<td>'||UPPER(TRIM(PRM_USUARIO))||'</td>');
				HTP.P('<td>'||FUN.UTRANSLATE('NM_OBJETO', WS_LINHA.TELA, WS_LINHA.NOME, WS_PADRAO)||'</td>');

				HTP.P('<td>');
					HTP.P('<select title="'||FUN.LANG('tempo')||'" onchange="call(''screen_change'', ''prm_usuario='||PRM_USUARIO||'&prm_tela='||WS_LINHA.TELA||'&prm_tipo=time&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''OK'') != -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
						HTP.P('<option value="0"disabled hidden>TEMPO DE SLIDE</option>');
						HTP.P('<option value="0">0</option>');
						
						IF WS_LINHA.TEMPO = '10' THEN
							HTP.P('<option value="10" selected>10s</option>');
						ELSE
							HTP.P('<option value="10">10s</option>');
						END IF;

						IF WS_LINHA.TEMPO = '20' THEN
							HTP.P('<option value="20" selected>20s</option>');
						ELSE
							HTP.P('<option value="20">20s</option>');
						END IF;
			
						IF WS_LINHA.TEMPO = '30' THEN
							HTP.P('<option value="30" selected>30s</option>');
						ELSE
							HTP.P('<option value="30">30s</option>');
						END IF;

						IF WS_LINHA.TEMPO = '45' THEN
							HTP.P('<option value="45" selected>45s</option>');
						ELSE
							HTP.P('<option value="45">45s</option>');
						END IF;

						IF WS_LINHA.TEMPO = '60' THEN
							HTP.P('<option value="60" selected>1min</option>');
						ELSE
							HTP.P('<option value="60">1min</option>');
						END IF;

						IF WS_LINHA.TEMPO = '120' THEN
							HTP.P('<option value="120" selected>2min</option>');
						ELSE
							HTP.P('<option value="120">2min</option>');
						END IF;

						IF WS_LINHA.TEMPO = '300' THEN
							HTP.P('<option value="300" selected>5min</option>');
						ELSE
							HTP.P('<option value="300">5min</option>');
						END IF;

						IF WS_LINHA.TEMPO = '600' THEN
							HTP.P('<option value="600" selected>10min</option>');
						ELSE
							HTP.P('<option value="600">10min</option>');
						END IF;

						IF WS_LINHA.TEMPO = '900' THEN
							HTP.P('<option value="900" selected>15min</option>');
						ELSE
							HTP.P('<option value="900">15min</option>');
						END IF;

						
					HTP.P('</select>');

				HTP.P('</td>');

				




				HTP.P('<td>');
					HTP.P('<select title="'||FUN.LANG('ordem')||'" onchange="call(''screen_change'', ''prm_usuario='||PRM_USUARIO||'&prm_tela='||WS_LINHA.TELA||'&prm_tipo=ordem&prm_valor=''+this.value).then(function(resposta){ if(resposta.indexOf(''OK'') != -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });">');
						HTP.P('<option selected disabled hidden value="0">'||FUN.LANG('ORDEM DO SLIDE')||'</option>');
						FOR I IN 0..20 LOOP
							IF I = WS_LINHA.ORDEM THEN
								HTP.P('<option value="'||I||'" selected>'||I||'</option>');
							ELSE
								HTP.P('<option value="'||I||'">'||I||'</option>');
							END IF;
						END LOOP;
					HTP.P('</select>');
				HTP.P('</td>');

				HTP.P('<td>');
					FCL.BUTTON_LIXO('delete_screen_access','prm_usuario|prm_tela', UPPER(TRIM(PRM_USUARIO))||'|'||WS_LINHA.TELA);
				HTP.P('</td>');
				
			HTP.P('</tr>');
		END LOOP;
	CLOSE CRS_USER;

	IF PRM_CONTEUDO = 'FULL' THEN	
				HTP.P('</tbody>');
			HTP.TABLECLOSE;
			HTP.P('</div>');
		HTP.P('<div class="listar"><a onclick="carregaPainel(''usuarios'');  carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||FUN.LANG('Usu&aacute;rios')||''';">'||FUN.LANG('Listar usu&aacute;rios')||'</a></div>');
    END IF;
	
END SCREEN_ACCESS;


PROCEDURE SCREEN_CHANGE ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
                          PRM_TELA    VARCHAR2 DEFAULT NULL,
						  PRM_TIPO    VARCHAR2 DEFAULT 'time',
						  PRM_VALOR   NUMBER DEFAULT NULL ) AS

	WS_COUNT  NUMBER;
	WS_RCOUNT NUMBER;

BEGIN
    IF PRM_TIPO = 'time' THEN
	    SELECT COUNT(*) INTO WS_RCOUNT FROM USER_SEQUENCE WHERE USUARIO = PRM_USUARIO AND SCREEN = PRM_TELA;
		IF WS_RCOUNT = 0 THEN
            INSERT INTO USER_SEQUENCE (ORDEM, SCREEN, TIME, USUARIO) VALUES (0, PRM_TELA, PRM_VALOR, PRM_USUARIO);
		ELSE
			UPDATE USER_SEQUENCE SET TIME = PRM_VALOR 
			WHERE USUARIO = PRM_USUARIO AND SCREEN = PRM_TELA;
		END IF;
    ELSE
	    SELECT COUNT(*) INTO WS_RCOUNT FROM USER_SEQUENCE WHERE USUARIO = PRM_USUARIO AND SCREEN = PRM_TELA;
		IF WS_RCOUNT = 0 THEN
            INSERT INTO USER_SEQUENCE (ORDEM, SCREEN, TIME, USUARIO) VALUES (PRM_VALOR, PRM_TELA, 0, PRM_USUARIO);
		ELSE
			UPDATE USER_SEQUENCE SET ORDEM = PRM_VALOR 
			WHERE USUARIO = PRM_USUARIO AND SCREEN = PRM_TELA;
		END IF;
	END IF;

	WS_COUNT := SQL%ROWCOUNT;

    IF WS_COUNT <> 0 THEN

	    COMMIT;
        HTP.P('OK');

	END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('FAIL');
END SCREEN_CHANGE;


PROCEDURE LIST_SCREEN ( PRM_GRUPO VARCHAR2 DEFAULT 'all', 
	                    PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

    CURSOR SCR_ALL IS
	SELECT SCREEN, DESCRICAO, GRUPO FROM( SELECT SCREEN, DESCRICAO, (SELECT CD_GRUPO FROM OBJETOS WHERE TP_OBJETO = 'SCREEN' AND CD_OBJETO = T1.SCREEN) AS GRUPO
	FROM ALL_SCREENS T1)
	WHERE NVL(GRUPO, 'N/A') = DECODE(PRM_GRUPO, 'all', NVL(GRUPO, 'N/A'), PRM_GRUPO) AND 
	SCREEN NOT IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = PRM_USUARIO)
	ORDER BY DESCRICAO;

	WS_OPTION SCR_ALL%ROWTYPE;

	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    OPEN SCR_ALL;
		LOOP
			FETCH SCR_ALL INTO WS_OPTION;
			EXIT WHEN SCR_ALL%NOTFOUND;
			HTP.P('<option id="screens_'||WS_OPTION.SCREEN||'" value="'||WS_OPTION.SCREEN||'">'||FUN.UTRANSLATE('NM_OBJETO', WS_OPTION.SCREEN, WS_OPTION.DESCRICAO, WS_PADRAO)||'</option>');
		END LOOP;
	CLOSE SCR_ALL;

END LIST_SCREEN;


PROCEDURE ADD_SCREEN_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
				              PRM_TELA    VARCHAR2 DEFAULT NULL,
				              PRM_TEMPO   NUMBER DEFAULT 0,
				              PRM_ORDEM   NUMBER DEFAULT 0 ) AS

	WS_COUNT    NUMBER := 0;
    WS_URL      VARCHAR2(200);
	WS_USUARIO  VARCHAR2(80);

	WS_NOADMIN  EXCEPTION;

BEGIN

	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;

	FOR I IN(SELECT COLUMN_VALUE FROM TABLE((FUN.VPIPE(PRM_TELA)))) LOOP
				
		SELECT COUNT(*) INTO WS_COUNT
		FROM USER_SCREENS
		WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO) AND
		TRIM(SCREEN) = TRIM(I.COLUMN_VALUE);

		IF WS_COUNT = 0 THEN
			INSERT INTO USER_SCREENS
			(USUARIO, SCREEN, STATUS)
			VALUES
			(PRM_USUARIO, I.COLUMN_VALUE, 'A');
				
			WS_COUNT := SQL%ROWCOUNT;
			
			IF NVL(PRM_TEMPO, 0) <> 0 THEN
				INSERT INTO USER_SEQUENCE
				(ORDEM, SCREEN, TIME, USUARIO)
				VALUES
				(PRM_ORDEM, I.COLUMN_VALUE, PRM_TEMPO, PRM_USUARIO);
			END IF;
				
			COMMIT;

			BEGIN
				SELECT URL_FUNDO INTO WS_URL FROM ALL_SCREENS WHERE TRIM(SCREEN) = TRIM(I.COLUMN_VALUE);
				IF INSTR(WS_URL, 'EXT=') > 0 THEN
					EXECUTE IMMEDIATE 'grant execute on DWU.'||REPLACE(REPLACE(REPLACE(UPPER(WS_URL), 'EXT=', ''), '.MAIN', ''), 'DWU.', '')||' to "'||PRM_USUARIO||'" ';
					COMMIT;
					HTP.P(FUN.LANG('Permiss&atilde;o ao externo '||REPLACE(REPLACE(REPLACE(UPPER(WS_URL), 'EXT=', ''), '.MAIN', ''), 'DWU.', '')||' adicionado')||'!');
				END IF;
				
			EXCEPTION WHEN OTHERS THEN
				HTP.P(FUN.LANG('Erro ao adicionar externo')||'!');
			END;
			
			
			



			
			IF WS_COUNT <> 0 THEN
				HTP.P('[1]'||FUN.LANG('Permiss&atilde;o de tela adicionada')||'!');
				WS_USUARIO := GBL.GETUSUARIO;
				INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Tela '||I.COLUMN_VALUE||' adicionada para o usuário '||PRM_USUARIO, WS_USUARIO, 'EVENTO');
				COMMIT;
			ELSE
				HTP.P(FUN.LANG('Erro ao adicionar permiss&Atilde;£o de tela')||'!');
			END IF;
			
		ELSE
			HTP.P(FUN.LANG('Erro ao adicionar permiss&atilde;o de tela, usu&aacute;rio j&aacute; possui acesso')||'!');
		END IF;

	END LOOP;

EXCEPTION 
    WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
        HTP.P(SQLERRM);
END ADD_SCREEN_ACCESS;


PROCEDURE DELETE_SCREEN_ACCESS ( PRM_USUARIO  VARCHAR2 DEFAULT NULL,
					             PRM_TELA     VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER := 0;

	WS_NOADMIN EXCEPTION;

BEGIN

	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;

	
    
	SELECT COUNT(*) INTO WS_COUNT
	FROM USER_SCREENS
	WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO) AND
	TRIM(SCREEN) = TRIM(PRM_TELA);

    IF  WS_COUNT > 0 THEN
    	DELETE FROM USER_SCREENS
		WHERE TRIM(SCREEN) = TRIM(PRM_TELA) AND
		TRIM(USUARIO) = TRIM(PRM_USUARIO);
		
		WS_COUNT := SQL%ROWCOUNT;
		
		DELETE FROM USER_SEQUENCE
		WHERE TRIM(SCREEN) = TRIM(PRM_TELA) AND
		TRIM(USUARIO) = TRIM(PRM_USUARIO);
		
	    COMMIT;
	   
		IF WS_COUNT <> 0 THEN
		    HTP.P('[1]'||FUN.LANG('Tela excluida com sucesso'));
		ELSE
		    HTP.P(FUN.LANG('Erro ao excluir'));
		END IF;
	    
    ELSE
	    HTP.P(FUN.LANG('Erro ao excluir, permiss&atilde;o inexistente')||'!');
	END IF;
EXCEPTION 
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(FUN.LANG('Erro ao excluir'));
END DELETE_SCREEN_ACCESS;


PROCEDURE TD_ACCESS ( PRM_USUARIO  VARCHAR2 DEFAULT NULL,
	                  PRM_CONTEUDO VARCHAR2 DEFAULT 'FULL' ) AS

    CURSOR TR_LIST IS
    SELECT NOME_REGRA, TIPO_REGRA, NET_ADDRESS, HR_INICIO, HR_FINAL, DIA_SEMANA, DT_REGRA
	FROM USER_NETWALL
	WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO);

	WS_LINHA TR_LIST%ROWTYPE;

BEGIN
    

    IF PRM_CONTEUDO = 'FULL' THEN

	    HTP.P('<table class="linha">');
		    HTP.P('<thead>');
                HTP.P('<tr>');
                    HTP.P('<th>'||FUN.LANG('NOME DA REGRA')||'</td>');
                    HTP.P('<th>'||FUN.LANG('TIPO')||'</td>');
                    HTP.P('<th>'||FUN.LANG('ENDERE&Ccedil;O')||'</td>');
                    HTP.P('<th>'||FUN.LANG('COME&Ccedil;O')||'</td>');
                    HTP.P('<th>'||FUN.LANG('TERMINO')||'</td>');
                    HTP.P('<th>'||FUN.LANG('DIA')||'</td>');
                    HTP.P('<th></td>');
                HTP.P('</tr>');
            HTP.P('</thead>');
            HTP.P('<tbody id="ajax">');
    END IF;
    
	OPEN TR_LIST;
		LOOP
			FETCH TR_LIST INTO WS_LINHA;
			EXIT WHEN TR_LIST%NOTFOUND;
				HTP.P('<tr id="'||WS_LINHA.NOME_REGRA||'tr">');
				    HTP.P('<td>'||WS_LINHA.NOME_REGRA||'</td>');
					HTP.P('<td>'||WS_LINHA.TIPO_REGRA||'</td>');
					HTP.P('<td>'||WS_LINHA.NET_ADDRESS||'</td>');
					HTP.P('<td>'||WS_LINHA.HR_INICIO||':00</td>');
					HTP.P('<td>'||WS_LINHA.HR_FINAL||':00</td>');
					CASE WS_LINHA.DIA_SEMANA
		            WHEN '2' THEN
					    HTP.P('<td>'||FUN.LANG('SEGUNDA-FEIRA')||'</td>');
					WHEN '3' THEN
					    HTP.P('<td>'||FUN.LANG('TER&Ccedil;A-FEIRA')||'</td>');
					WHEN '4' THEN
					    HTP.P('<td>'||FUN.LANG('QUARTA-FEIRA')||'</td>');
					WHEN '5' THEN
					    HTP.P('<td>'||FUN.LANG('QUINTA-FEIRA')||'</td>');
					WHEN '6' THEN
					    HTP.P('<td>'||FUN.LANG('SEXTA-FEIRA')||'</td>');
					WHEN '7' THEN
					    HTP.P('<td>'||FUN.LANG('SABADO')||'</td>');
					WHEN '1' THEN
						HTP.P('<td>'||FUN.LANG('DOMNGO')||'</td>');
                    WHEN '8' THEN
					    HTP.P('<td>'||FUN.LANG('DIA &Uacute;TIL')||'</td>');
					WHEN '9' THEN
					    HTP.P('<td>'||FUN.LANG('FIM DE SEMANA')||'</td>');
					ELSE
					    HTP.P('<td>'||FUN.LANG('TODOS OS DIAS')||'</td>');
					END CASE;
					HTP.P('<td>');
						FCL.BUTTON_LIXO('dl_td_access','prm_usuario|prm_nome', PRM_USUARIO||'|'||WS_LINHA.NOME_REGRA);
					HTP.P('</td>');
					
				HTP.P('</tr>');
		END LOOP;
	CLOSE TR_LIST;
	
	IF PRM_CONTEUDO = 'FULL' THEN
	    HTP.P('</tbody></table>');

	    HTP.P('<div class="listar"><a title="'||FUN.LANG('ir para a lista de usu&aacute;rios')||'" onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||FUN.LANG('USU&Aacute;RIOS')||''';">'||FUN.LANG('Listar usu&aacute;rios')||'</a></div>');
    END IF;

END TD_ACCESS;


PROCEDURE ADD_TD_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
                          PRM_REGRA VARCHAR2 DEFAULT NULL,
                          PRM_TIPO VARCHAR2 DEFAULT NULL,
                          PRM_ADDRESS VARCHAR2 DEFAULT NULL,
                          PRM_HI NUMBER DEFAULT 8,
                          PRM_HF NUMBER DEFAULT 18,
                          PRM_SEMANA VARCHAR2 DEFAULT 'dia util' ) AS

	WS_COUNT NUMBER;

BEGIN

	
	INSERT INTO USER_NETWALL
	VALUES(PRM_USUARIO, UPPER(PRM_REGRA), PRM_TIPO, PRM_ADDRESS, PRM_HI, PRM_HF, PRM_SEMANA, SYSDATE);

	WS_COUNT := SQL%ROWCOUNT;	
    	
	COMMIT;
	    
    IF WS_COUNT <> 0 THEN
	    HTP.P('[1]'||FUN.LANG('Netwall adicionado'));
	ELSE
	    HTP.P(FUN.LANG('Erro ao adicionar netwall'));
	END IF;
	
EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END ADD_TD_ACCESS;


PROCEDURE DL_TD_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
                         PRM_NOME VARCHAR2 DEFAULT NULL	) AS

    WS_COUNT NUMBER;

BEGIN
    
    
    DELETE FROM USER_NETWALL 
    WHERE TRIM(USUARIO) = UPPER(TRIM(PRM_USUARIO)) AND NOME_REGRA = UPPER(TRIM(PRM_NOME));

    WS_COUNT := SQL%ROWCOUNT; 
    
    COMMIT;

	IF WS_COUNT <> 0 THEN
		HTP.P('[1]'||FUN.LANG('Netwall excluido com sucesso'));
	ELSE
		HTP.P(FUN.LANG('Erro ao excluir'));
	END IF;

END DL_TD_ACCESS;


PROCEDURE OBJECT_ACCESS ( PRM_USUARIO  VARCHAR2 DEFAULT NULL, 
                          PRM_CONTEUDO VARCHAR2 DEFAULT 'FULL' ) AS

    CURSOR OBJ_USER IS
    SELECT CD_OBJETO, (SELECT NM_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.CD_OBJETO) AS NOME
    FROM OBJECT_RESTRICTION T1
    WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO);

    WS_LINHA OBJ_USER%ROWTYPE;
    
    WS_COUNT	NUMBER;
	WS_GRUPO    VARCHAR2(40);

BEGIN
    
    
    WS_GRUPO := '999999999';

    IF PRM_CONTEUDO = 'FULL' THEN
	    HTP.P('<table class="linha">');
		    HTP.P('<thead>');
			    HTP.P('<tr>');
				    HTP.P('<th style="width: 25%;">'||FUN.LANG('USU&Aacute;RIO')||'</th>');
				    HTP.P('<th style="width: 20%;">ID</th>');
					HTP.P('<th style="width: 50%;">'||FUN.LANG('NOME')||'</th>');
					HTP.P('<th style="width: 5%;"></th>');
				HTP.P('</tr>');
			HTP.P('</thead>');
	        HTP.P('<tbody id="ajax">');
    END IF;
		OPEN OBJ_USER;
            LOOP
                FETCH OBJ_USER INTO WS_LINHA;
                EXIT WHEN OBJ_USER%NOTFOUND;
                HTP.P('<tr id="'||TRIM(WS_LINHA.CD_OBJETO)||'linha">');
                    HTP.P('<td style="width: 25%;">'||UPPER(TRIM(PRM_USUARIO))||'</td>');
					HTP.P('<td style="width: 20%;">'||WS_LINHA.CD_OBJETO||'</td>');
                    HTP.P('<td style="width: 50%;">'||WS_LINHA.NOME||'</td>');
                    HTP.P('<td>');
						FCL.BUTTON_LIXO('delete_object_access','prm_usuario|prm_obj', UPPER(TRIM(PRM_USUARIO))||'|'||WS_LINHA.CD_OBJETO);
					HTP.P('</td>');
					
                HTP.P('</tr>');
            END LOOP;
        CLOSE OBJ_USER;
    IF PRM_CONTEUDO = 'FULL' THEN
        HTP.TABLECLOSE;
	    HTP.P('<div class="listar"><a onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||FUN.LANG('USU&Aacute;RIOS')||''';">'||FUN.LANG('Listar usu&aacute;rios')||'</a></div>');
    END IF;

END OBJECT_ACCESS;


PROCEDURE OBJECT_ACCESS_LIST ( PRM_VISAO   VARCHAR2 DEFAULT NULL,
                               PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS 

    CURSOR OBJ_ALL IS
    SELECT CD_OBJETO, TP_OBJETO, NM_OBJETO, VISAO FROM
    ( SELECT CD_OBJETO, TP_OBJETO, NM_OBJETO, (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = CD_OBJETO) VISAO FROM OBJETOS)
    WHERE (VISAO = PRM_VISAO OR NVL(PRM_VISAO, 'N/A') = 'N/A') AND
    TRIM(CD_OBJETO) NOT IN (SELECT TRIM(CD_OBJETO) FROM OBJECT_RESTRICTION WHERE USUARIO = PRM_USUARIO)
    ORDER BY TP_OBJETO, NM_OBJETO;
    
    WS_OPTION OBJ_ALL%ROWTYPE;
    
    WS_GRUPO    VARCHAR2(40) := '999999999';
	WS_PADRAO	VARCHAR2(80) := 'PORTUGUESE';
BEGIN

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    OPEN OBJ_ALL;
        LOOP
            FETCH OBJ_ALL INTO WS_OPTION;
            EXIT WHEN OBJ_ALL%NOTFOUND;
			IF WS_GRUPO <> WS_OPTION.TP_OBJETO THEN
			    HTP.P('<optgroup label="'||WS_OPTION.TP_OBJETO||'"></optgroup>');
				WS_GRUPO := WS_OPTION.TP_OBJETO;
			END IF;
            HTP.P('<option value="'||WS_OPTION.CD_OBJETO||'">'||FUN.UTRANSLATE('NM_OBJETO', WS_OPTION.CD_OBJETO, WS_OPTION.NM_OBJETO, WS_PADRAO)||' - '||WS_OPTION.CD_OBJETO||'</option>');
        END LOOP;
    CLOSE OBJ_ALL;

END OBJECT_ACCESS_LIST;


PROCEDURE ADD_OBJECT_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
				              PRM_OBJ     VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT	NUMBER;

BEGIN
    
	SELECT COUNT(*) INTO WS_COUNT
	FROM OBJECT_RESTRICTION
	WHERE TRIM(CD_OBJETO) = TRIM(PRM_OBJ) AND
	TRIM(USUARIO) = TRIM(PRM_USUARIO);

    IF WS_COUNT = 0 THEN
    	INSERT INTO OBJECT_RESTRICTION
    	(USUARIO, CD_OBJETO, ST_RESTRICAO, DT_LAST)
    	VALUES
    	(PRM_USUARIO, PRM_OBJ, 'I', SYSDATE );
    		
    	WS_COUNT := SQL%ROWCOUNT;	
    	
	    COMMIT;
	    
        
        IF WS_COUNT = 1 THEN
		    HTP.P('[1]'||FUN.LANG('Bloqueio de objeto adicionado'));
		ELSE
		    HTP.P(FUN.LANG('Erro ao adicionar bloqueio de objeto'));
		END IF;
		
    ELSE
        HTP.P(FUN.LANG('Erro ao adicionar bloqueio de objeto, usu&aacute;rio j&aacute; possui'));
    END IF;
EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END ADD_OBJECT_ACCESS;



PROCEDURE DELETE_OBJECT_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
					             PRM_OBJ     VARCHAR2 DEFAULT NULL ) AS

	
	WS_COUNT NUMBER;

BEGIN
    
	SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_RESTRICTION  WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO) AND TRIM(CD_OBJETO) = TRIM(PRM_OBJ);

	IF  WS_COUNT = 1 THEN
    	DELETE FROM OBJECT_RESTRICTION
		WHERE TRIM(CD_OBJETO) = TRIM(PRM_OBJ) AND
		TRIM(USUARIO) = TRIM(PRM_USUARIO);
	    
		WS_COUNT := SQL%ROWCOUNT;
		
		COMMIT;
		
		IF WS_COUNT <> 0 THEN
		    HTP.P('[1]'||FUN.LANG('Bloqueio excluido com sucesso'));
		ELSE
		    HTP.P(FUN.LANG('Erro ao excluir'));
		END IF;
	    
    ELSE
	    HTP.P(FUN.LANG('Erro ao excluir, bloqueio inexistente')||'!');
	END IF;

END DELETE_OBJECT_ACCESS;


PROCEDURE COLUMN_ACCESS ( PRM_USUARIO  VARCHAR2 DEFAULT NULL, 
                          PRM_CONTEUDO VARCHAR2 DEFAULT 'FULL' ) AS

    CURSOR COL_USER IS
    SELECT CD_COLUNA, CD_MICRO_VISAO
    FROM COLUMN_RESTRICTION
    WHERE TRIM(USUARIO) = TRIM(PRM_USUARIO);

    




    WS_LINHA COL_USER%ROWTYPE;
    
	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
    
    IF PRM_CONTEUDO = 'FULL' THEN
        HTP.P('<table class="linha">');
			HTP.P('<thead>');
			    HTP.P('<tr>');
				    HTP.P('<th style="width: 25%;">'||FUN.LANG('USU&Aacute;RIO')||'</th>');
				    HTP.P('<th style="width: 25%;">'||FUN.LANG('COLUNA')||'</th>');
					HTP.P('<th style="width: 25%;">'||FUN.LANG('NOME')||'</th>');
					HTP.P('<th style="width: 20%;">'||FUN.LANG('MICRO VIS&Atilde;O')||'</th>');
					HTP.P('<th style="width: 5%;"></th>');
				HTP.P('</tr>');
			HTP.P('</thead>');
			HTP.P('<tbody id="ajax">');
	END IF;
	
    OPEN COL_USER;
        LOOP
            FETCH COL_USER INTO WS_LINHA;
            EXIT WHEN COL_USER%NOTFOUND;
            HTP.P('<tr id="'||TRIM(WS_LINHA.CD_COLUNA)||'linha">');
                HTP.P('<td style="width: 25%;">'||UPPER(TRIM(PRM_USUARIO))||'</td>');
				HTP.P('<td style="width: 25%;">'||WS_LINHA.CD_COLUNA||'</td>');
                HTP.P('<td style="width: 25%;">'||FUN.UTRANSLATE('NM_ROTULO', WS_LINHA.CD_MICRO_VISAO, FUN.CDESC(WS_LINHA.CD_COLUNA, 'MICRO_COLUNA'), WS_PADRAO)||'</td>');
                HTP.P('<td style="width: 20%;">'||WS_LINHA.CD_MICRO_VISAO||'</td>');
				HTP.P('<td>');
					FCL.BUTTON_LIXO('delete_column_access', 'prm_nome|prm_coluna|prm_visao', UPPER(TRIM(PRM_USUARIO))||'|'||WS_LINHA.CD_COLUNA||'|'||WS_LINHA.CD_MICRO_VISAO);
				HTP.P('</td>');
				
            HTP.P('</tr>');
        END LOOP;
    CLOSE COL_USER;
    
    IF PRM_CONTEUDO = 'FULL' THEN
		    HTP.P('</tbody>');
        HTP.TABLECLOSE;
		HTP.P('<div class="listar"><a onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||FUN.LANG('USU&Aacute;RIOS')||''';">'||FUN.LANG('Listar usu&aacute;rios')||'</a></div>');
    END IF;

END COLUMN_ACCESS;

PROCEDURE ADD_COLUMN_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
				       		  PRM_COLUNA  VARCHAR2 DEFAULT NULL,
							  PRM_VISAO   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER := 0;

BEGIN
    
    
    SELECT COUNT(*) INTO WS_COUNT
    FROM COLUMN_RESTRICTION
    WHERE TRIM(CD_COLUNA) = TRIM(PRM_COLUNA) AND
    TRIM(USUARIO) = TRIM(PRM_USUARIO) AND TRIM(CD_MICRO_VISAO) = TRIM(PRM_VISAO);

    IF WS_COUNT = 0 THEN
    
    	INSERT INTO COLUMN_RESTRICTION
    	(USUARIO, CD_MICRO_VISAO, CD_COLUNA, ST_RESTRICAO, DT_LAST)
    	VALUES
    	(PRM_USUARIO, PRM_VISAO, PRM_COLUNA, 'I', SYSDATE);
    	
    	WS_COUNT := SQL%ROWCOUNT;
    	
	    COMMIT;

	    IF WS_COUNT <> 0 THEN
	        HTP.P('[1]'||FUN.LANG('Bloqueio adicionado com sucesso'));
	    ELSE
	        HTP.P('FAIL');
	    END IF;
	    
	ELSE
        HTP.P('FAIL Coluna j&aacute; adicionada');
    END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('FAIL');
END ADD_COLUMN_ACCESS;

PROCEDURE DELETE_COLUMN_ACCESS ( PRM_NOME   VARCHAR2 DEFAULT NULL,
			                     PRM_COLUNA VARCHAR2 DEFAULT NULL,
			                     PRM_VISAO  VARCHAR2 DEFAULT NULL ) AS

    
    WS_COUNT NUMBER := 0;

BEGIN
    
    
    SELECT COUNT(*) INTO WS_COUNT FROM COLUMN_RESTRICTION  
    WHERE TRIM(USUARIO) = TRIM(PRM_NOME) AND 
    TRIM(CD_COLUNA) = TRIM(PRM_COLUNA) AND 
    CD_MICRO_VISAO = TRIM(PRM_VISAO);

	IF WS_COUNT = 1 THEN
    	DELETE FROM COLUMN_RESTRICTION
	    WHERE TRIM(CD_COLUNA) = TRIM(PRM_COLUNA) AND
	    TRIM(USUARIO) = TRIM(PRM_NOME) AND
	    CD_MICRO_VISAO = TRIM(PRM_VISAO);
	    
	    WS_COUNT := SQL%ROWCOUNT;
	    
	    COMMIT;
	
	    IF WS_COUNT <> 0 THEN
	        HTP.P('[1]'||FUN.LANG('Bloqueio excluido com sucesso'));
	    ELSE
	        HTP.P(FUN.LANG('Erro ao excluir'));
	    END IF;
	    
    END IF;
EXCEPTION WHEN OTHERS THEN
    HTP.P(FUN.LANG('Erro ao excluir'));
END DELETE_COLUMN_ACCESS;

PROCEDURE LIST_COLUMN_ACCESS ( PRM_VISAO    VARCHAR2 DEFAULT NULL, 
	                           PRM_USUARIO  VARCHAR2 DEFAULT NULL ) AS

    CURSOR COL_ALL IS
    SELECT CD_COLUNA, NM_ROTULO
    FROM MICRO_COLUNA
	WHERE CD_MICRO_VISAO = PRM_VISAO AND
	CD_COLUNA NOT IN (SELECT CD_COLUNA FROM COLUMN_RESTRICTION WHERE USUARIO = PRM_USUARIO AND CD_MICRO_VISAO = PRM_VISAO) AND
	ST_AGRUPADOR <> 'TPT' AND
	NM_ROTULO IS NOT NULL

    ORDER BY CD_COLUNA;

	WS_OPTION COL_ALL%ROWTYPE;

	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
    
    OPEN COL_ALL;
		LOOP
		    FETCH COL_ALL INTO WS_OPTION;
		    EXIT WHEN COL_ALL%NOTFOUND;
		    HTP.P('<option value="'||WS_OPTION.CD_COLUNA||'">'||WS_OPTION.CD_COLUNA||' - '||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), WS_OPTION.NM_ROTULO, WS_PADRAO)||'</option>');
		END LOOP;
    CLOSE COL_ALL;

END LIST_COLUMN_ACCESS;


PROCEDURE XLOGOUT ( PRM_SESSAO VARCHAR2 DEFAULT NULL ) AS

    JOB_ID         NUMBER;
	WS_ID_SESSION  VARCHAR2(80);
	WS_COOKIE      OWA_COOKIE.COOKIE;

BEGIN

    IF NVL(PRM_SESSAO, 'N/A') = 'N/A' THEN
		WS_COOKIE := OWA_COOKIE.GET('SESSION');
		WS_ID_SESSION := WS_COOKIE.VALS(1);
		OWA_UTIL.MIME_HEADER('text/html', FALSE, NULL);
		OWA_COOKIE.SEND(NAME=>'SESSION', VALUE=> WS_ID_SESSION, EXPIRES => SYSDATE - 9);
		OWA_UTIL.HTTP_HEADER_CLOSE;
	ELSE
        WS_ID_SESSION := PRM_SESSAO;
	END IF;

	





	

	


	UPDATE ACTIVE_SESSIONS
	SET STATUS = 'I'
	WHERE STATUS = 'A' AND ID_SESSION = GBL.GETUSUARIO()||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.');
	COMMIT;

	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Sess&atilde;o encerrada', GBL.GETUSUARIO(), 'SESSAO');
    COMMIT;

	GBL.SETUSUARIO(WS_ID_SESSION);

   

EXCEPTION WHEN OTHERS THEN
	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END XLOGOUT;

PROCEDURE ALTERORDER (  PRM_OBJETO VARCHAR2 DEFAULT NULL,
                        PRM_VALOR  VARCHAR2 DEFAULT NULL) AS

    WS_COUNT   NUMBER;
    WS_ORDEM   VARCHAR(40);
    WS_VALUE   VARCHAR(40);
	WS_USUARIO VARCHAR(80);

BEGIN
	WS_ORDEM   := PRM_VALOR;
    WS_USUARIO := GBL.GETUSUARIO;

    --TRATAMENTO PARA ORDENAÇÃO COM ERRO DE CALLMED. 22/12/21.
	if instr(UPPER(ws_ordem),'CALLMED')>0 then

		ws_ordem:=replace(UPPER(ws_ordem),',CALLMED','');
		ws_ordem:=replace(UPPER(ws_ordem),'CALLMED','');

	end if;

	if instr(UPPER(ws_ordem),'PRINT')>0 then
		

		ws_ordem:= replace(UPPER(ws_ordem),',PRINT','');
		ws_ordem:= replace(UPPER(ws_ordem),'PRINT','');

	end if;

	ws_ordem:=trim(ws_ordem);

	if ws_ordem like ',%' then

		ws_ordem :=substr(ws_ordem,2,1000);
	
	end if;
	

	SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_OBJETO AND CD_PROP = 'ORDEM' AND OWNER = WS_USUARIO;
	


    --TRATAMENTO PARA ORDENAÇÃO COM ERRO DE CALLMED. 22/12/21.
    IF  WS_COUNT < 2 THEN
        IF  WS_COUNT = 1 THEN
		    IF NVL(WS_ORDEM, 'N/A') = 'N/A' THEN
			    DELETE FROM OBJECT_ATTRIB
				WHERE  OWNER = WS_USUARIO AND
				NAVEGADOR = 'DEFAULT' AND
				CD_OBJECT = PRM_OBJETO AND
				CD_PROP   = 'ORDEM';
				COMMIT;
			ELSE
				UPDATE OBJECT_ATTRIB SET PROPRIEDADE = nvl(ws_ordem, '1')
				WHERE  OWNER = WS_USUARIO AND
				NAVEGADOR = 'DEFAULT' AND
				CD_OBJECT = PRM_OBJETO AND
				CD_PROP   = 'ORDEM';
				COMMIT;
			END IF;
        ELSE
            INSERT INTO OBJECT_ATTRIB VALUES (WS_USUARIO, 'DEFAULT', 'DEFAULT', TRIM(PRM_OBJETO), 'ORDEM', nvl(ws_ordem, '1'));
            COMMIT;
        END IF;
    END IF;
EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END ALTERORDER;





PROCEDURE SAVEVIEW ( PRM_VIEW VARCHAR2 DEFAULT NULL,
		             PRM_NOME VARCHAR2 DEFAULT NULL,
		             PRM_DESC VARCHAR2 DEFAULT NULL,
		             PRM_GRUPO VARCHAR2 DEFAULT NULL,
                     PRM_TIPO VARCHAR2 DEFAULT 'u' ) AS

    WS_COUNT 		 NUMBER;
	WS_COUNT_ATTRIB  NUMBER;
	WS_REPEATED 	 NUMBER;
	WS_NOADMIN       EXCEPTION;
BEGIN

	IF GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOADMIN;
	END IF;

    SELECT COUNT(*) INTO WS_COUNT FROM PONTO_AVALIACAO WHERE UPPER(CD_PONTO) = UPPER(PRM_NOME);
	IF WS_COUNT = 1 THEN
	    HTP.P('...');
    ELSIF WS_COUNT = 0 THEN
        INSERT INTO PONTO_AVALIACAO VALUES(UPPER(PRM_NOME), PRM_DESC, '', 'N', 'N', 'N', 'T', 'O', 'DWU', NULL, SYSDATE, PRM_VIEW, '', 'A', '', '1|1', '', '', '', '');
        INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES(UPPER(PRM_NOME), PRM_GRUPO, PRM_DESC, '', 'CONSULTA', GBL.GETUSUARIO, '', SYSDATE, '');
        INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', UPPER(PRM_NOME), 'TP_GRUPO', PRM_GRUPO);
		INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', UPPER(PRM_NOME), 'ORDEM', '1');
		INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', UPPER(PRM_NOME), 'FILTRO', 'PASSIVO');
        INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', UPPER(PRM_NOME), 'TIMER', '0');
        COMMIT;
	ELSE
	    HTP.P('#alert '||FUN.LANG('Erro na consulta')||'!');
    END IF;

EXCEPTION 
	WHEN WS_NOADMIN THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(SQLERRM);
END SAVEVIEW;



PROCEDURE SAVECOLUMN ( P_CD_COLUNA  VARCHAR2 DEFAULT NULL,
		               P_VISAO 		VARCHAR2 DEFAULT NULL,
					   PRM_TEMPLATE VARCHAR2 DEFAULT 'N') AS

WS_COUNT NUMBER;

BEGIN

	SELECT COUNT(*) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_COLUNA = UPPER(P_CD_COLUNA) AND CD_MICRO_VISAO = UPPER(P_VISAO);
	
	IF  WS_COUNT = 0 THEN
	    IF PRM_TEMPLATE = 'S' THEN
		    INSERT INTO MICRO_COLUNA
		    ( CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, ROTULO_C, COLOR, HINT, FLEXCOL, LIMITE, URL)
	        VALUES
	       ( UPPER(P_VISAO), UPPER(P_CD_COLUNA), UPPER(P_CD_COLUNA), 'S', 'TPT', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'C', '', '', '', '', '', '');
		ELSE
		    INSERT INTO MICRO_COLUNA
		    ( CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, ROTULO_C, COLOR, HINT, FLEXCOL, LIMITE, URL)
	        VALUES
	       ( UPPER(P_VISAO), UPPER(P_CD_COLUNA), '', 'S', 'SEM', 'SEM', 'SEM', 'N', 'LEFT', 'N', 'S', 'N', '', '', 'C', '', '', '', '', '', '');
	    END IF;
	ELSE
	    HTP.P(FUN.LANG('Coluna j&aacute; existe')||'!');
	END IF;

EXCEPTION WHEN OTHERS THEN
	HTP.P(FUN.LANG('Erro ao adicionar coluna'));
END SAVECOLUMN;



PROCEDURE FILTRO_GERAL  AS

	WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(20);
	WS_NOACCESS EXCEPTION;

BEGIN

	WS_ADMIN   := GBL.GETNIVEL;
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_ADMIN <> 'A' OR WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACCESS;
	END IF;

    HTP.P('<div class="searchbar">');
		HTP.P('<a class="script" onclick="var valor = this.nextElementSibling.title; call(''getfiltro'', ''prm_usuario=''+valor).then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = valor; });"></a>');
		FCL.FAKEOPTION('usuario-filtro-tela', FUN.LANG('Busca por usu&aacute;rios'), '', 'lista-usuarios-grupos', 'N', 'N');
	HTP.P('</div>');
		
	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=1&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=2&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('VIS&Atilde;O')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=3&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('COLUNA')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=4&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').value+''&prm_order=5&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('VALOR')||'</a></th>');
				HTP.P('<th>'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax" data-dir="1">');
		HTP.P('</tbody>');
	HTP.P('</table>');

EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END FILTRO_GERAL;

PROCEDURE GETCOLUMN( PRM_VISAO VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_COLUNAS IS
	SELECT CD_COLUNA, NM_ROTULO
	FROM MICRO_COLUNA
	WHERE CD_MICRO_VISAO = PRM_VISAO AND NM_ROTULO <> ''''
	ORDER BY CD_COLUNA ASC;

	WS_COLUNA CRS_COLUNAS%ROWTYPE;

	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN
    

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    HTP.FORMSELECTOPEN( CNAME => 'coluna', CATTRIBUTES => ' id="coluna"');
        OPEN CRS_COLUNAS;
            LOOP
                FETCH CRS_COLUNAS INTO WS_COLUNA;
                EXIT WHEN CRS_COLUNAS%NOTFOUND;
                FCL.FORMSELECTOPTION( '['||WS_COLUNA.CD_COLUNA||'] '||FUN.UTRANSLATE('NM_ROTULO', PRM_VISAO, WS_COLUNA.NM_ROTULO, WS_PADRAO),WS_COLUNA.CD_COLUNA, '','');
            END LOOP;
        CLOSE CRS_COLUNAS;
    HTP.FORMSELECTCLOSE;

END GETCOLUMN;

PROCEDURE GETFILTRO( PRM_USUARIO VARCHAR2 DEFAULT NULL,
                     PRM_ORDER VARCHAR2 DEFAULT '1',
					 PRM_DIR VARCHAR2 DEFAULT '1' ) AS

    CURSOR CRS_FILTROS IS
	SELECT CD_USUARIO, MICRO_VISAO, CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO, CD_FILTRO
	FROM FILTROS
	WHERE (TRIM(CD_USUARIO) = TRIM(PRM_USUARIO) OR CD_USUARIO IN (SELECT CD_USUARIO FROM GUSERS_ITENS WHERE CD_GROUP = PRM_USUARIO) OR PRM_USUARIO = 'TODOS')
	AND TP_FILTRO = 'geral'
	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_USUARIO, '2', MICRO_VISAO, '3', CD_COLUNA, '4', CONDICAO, '5', CONTEUDO, MICRO_VISAO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_USUARIO, '2', MICRO_VISAO, '3', CD_COLUNA, '4', CONDICAO, '5', CONTEUDO, MICRO_VISAO) END DESC;

	WS_FILTRO CRS_FILTROS%ROWTYPE;

	WS_COUNTER NUMBER := 0;
	WS_LIGACAO VARCHAR2(80);
	WS_DIR     NUMBER := 1;
	WS_PADRAO  VARCHAR2(80) := 'PORTUGUESE';

BEGIN
    

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    HTP.P('<div class="searchbar">');
		HTP.P('<a class="script" onclick="var valor = this.nextElementSibling.title; call(''getfiltro'', ''prm_usuario=''+valor).then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = valor; });"></a>');
	    FCL.FAKEOPTION('usuario-filtro-tela', NVL(PRM_USUARIO, 'Lista de usu&aacute;rios'), PRM_USUARIO, 'lista-usuarios-grupos', 'N', 'N');
	HTP.P('</div>');
	
	HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('VIS&Atilde;O')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=3&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('COLUNA')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''getfiltro'', ''prm_usuario=''+document.getElementById(''usuario-filtro-tela'').title+''&prm_order=5&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('VALOR')||'</a></th>');
				HTP.P('<th>'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		
		IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;
		
		HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
	
			OPEN CRS_FILTROS;
				LOOP
					FETCH CRS_FILTROS INTO WS_FILTRO;
					EXIT WHEN CRS_FILTROS%NOTFOUND;

					WS_COUNTER := WS_COUNTER+1;

					HTP.P('<tr>');
					    HTP.P('<td>'||WS_FILTRO.CD_USUARIO||'</td>');
						HTP.P('<td id="'||WS_COUNTER||'-visao" title="'||WS_FILTRO.MICRO_VISAO||'">'||FUN.UTRANSLATE('NM_MICRO_VISAO', 'MICRO_VISAO', WS_FILTRO.MICRO_VISAO, WS_PADRAO)||'</td>');
						
						HTP.P('<td>');
						    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-coluna-'||WS_COUNTER||''').title)+''&prm_tipo=COLUNA-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
						    FCL.FAKEOPTION('filtro-coluna-'||WS_COUNTER, '', WS_FILTRO.CD_COLUNA, 'lista-colunas', 'N', 'N', WS_COUNTER||'-visao', '');
						HTP.P('</td>');
						
							HTP.P('<td>');
							    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-condicao-'||WS_COUNTER||''').title)+''&prm_tipo=CONDICAO-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
							    FCL.FAKEOPTION('filtro-condicao-'||WS_COUNTER||'', '', WS_FILTRO.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', '', FUN.DCONDICAO(WS_FILTRO.CONDICAO));
							HTP.P('</td>');
							
							
							HTP.P('<td>');
							    
							    HTP.P('<a class="script" onclick="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+encodeURIComponent(document.getElementById(''filtro-conteudo-'||WS_COUNTER||''').title)+''&prm_tipo=CONTEUDO-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
								
								BEGIN
								
								    SELECT CD_LIGACAO INTO WS_LIGACAO FROM MICRO_COLUNA WHERE CD_COLUNA = WS_FILTRO.CD_COLUNA AND CD_MICRO_VISAO = WS_FILTRO.MICRO_VISAO;
								 
									IF WS_LIGACAO <> 'SEM' THEN
									    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', WS_COUNTER||'-visao', '', 'filtro-coluna-'||WS_COUNTER, FUN.CDESC(WS_FILTRO.CONTEUDO, WS_LIGACAO));
									ELSE
									    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', WS_COUNTER||'-visao', '', 'filtrou-coluna');
									END IF;
								
								EXCEPTION WHEN OTHERS THEN
								    
								    FCL.FAKEOPTION('filtro-conteudo-'||WS_COUNTER, '', WS_FILTRO.CONTEUDO, 'lista-valores', 'S', 'N', WS_COUNTER||'-visao', '', 'filtrou-coluna');
								
								END;
								
						    HTP.P('</td>');
							
							HTP.P('<td>');
								HTP.P('<select id="filtro-ligacao-'||WS_COUNTER||'" data-default="'||WS_FILTRO.LIGACAO||'" onchange="call(''edit_filtro'',''prm_key='||WS_FILTRO.CD_FILTRO||'&prm_valor=''+this.value+''&prm_tipo=LIGACAO-USER'').then(function(resposta){ if(resposta.indexOf(''Erro'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
									IF WS_FILTRO.LIGACAO = 'and' THEN
										HTP.P('<option value="and" selected>and</option>');
										HTP.P('<option value="or">or</option>');
									ELSE
										HTP.P('<option value="and">and</option>');
										HTP.P('<option value="or" selected>or</option>');
									END IF;
								HTP.P('</select>');
							HTP.P('</td>');
							HTP.P('<td>');
								FCL.BUTTON_LIXO('deletefiltro','prm_key', WS_FILTRO.CD_FILTRO);
							HTP.P('</td>');
						
					HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_FILTROS;
		HTP.P('</tbody>');
	HTP.P('</table>');

END GETFILTRO;



PROCEDURE SETFILTRO( PRM_USUARIO  VARCHAR2 DEFAULT NULL,
					 PRM_VISAO    VARCHAR2 DEFAULT NULL,
					 PRM_COLUNA   VARCHAR2 DEFAULT NULL,
					 PRM_CONDICAO VARCHAR2 DEFAULT NULL,
					 PRM_CONTEUDO VARCHAR2 DEFAULT NULL,
					 PRM_LIGACAO  VARCHAR2 DEFAULT 'and' ) AS


	WS_LAST     NUMBER;
	WS_COUNT    NUMBER := 0;
	WS_KEY      NUMBER := 0;
	WS_INC      NUMBER := 0;
	WS_CONVERTE VARCHAR2(800);
	WS_USUARIO  VARCHAR2(80);

	WS_NOUSER	EXCEPTION;

BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;
    
	WS_CONVERTE := FUN.CONVERTE(PRM_CONTEUDO);
 
	FOR I IN(SELECT COLUMN_VALUE AS USUARIO FROM TABLE((FUN.VPIPE(PRM_USUARIO)))) LOOP

	    SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

	    LOOP
    
			WS_INC := WS_INC+1;
		
			SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
		
			IF WS_COUNT > 0 THEN
				SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
			ELSE
				EXIT;
			END IF;
		END LOOP;
    
	    INSERT INTO FILTROS VALUES(I.USUARIO, '', PRM_VISAO, PRM_COLUNA, PRM_CONDICAO, WS_CONVERTE, PRM_LIGACAO, 'N', WS_KEY, 'geral', WS_USUARIO);
	    COMMIT;

	END LOOP;

    HTP.P('OK');

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(SQLERRM||' - '||WS_KEY);
    	HTP.P('FAIL');
END SETFILTRO;


PROCEDURE SETDESTAQUE ( PRM_USUARIO    VARCHAR2 DEFAULT NULL,
					   PRM_OBJETO     VARCHAR2 DEFAULT NULL,
					   PRM_COLUNA     VARCHAR2 DEFAULT NULL,
					   PRM_CONDICAO   VARCHAR2 DEFAULT NULL,
					   PRM_CONTEUDO   VARCHAR2 DEFAULT NULL,
					   PRM_FUNDO      VARCHAR2 DEFAULT NULL, 
					   PRM_FONTE      VARCHAR2 DEFAULT NULL, 
					   PRM_TIPO       VARCHAR2 DEFAULT NULL,
					   PRM_PRIORIDADE VARCHAR2 DEFAULT NULL ) AS


	WS_LAST     NUMBER;
	WS_COUNT    NUMBER := 0;
	WS_KEY      NUMBER := 0;
	WS_INC      NUMBER := 0;
	WS_CONVERTE VARCHAR2(800);

BEGIN
    

	WS_CONVERTE := FUN.CONVERTE(PRM_CONTEUDO);
    
    
    SELECT NVL2(MAX(CD_DESTAQUE), MAX(CD_DESTAQUE), 0)+1 INTO WS_KEY FROM DESTAQUE;
    
    LOOP
    
        WS_INC := WS_INC+1;
    
	    SELECT COUNT(*) INTO WS_COUNT FROM DESTAQUE WHERE CD_DESTAQUE = WS_KEY;
	
	    IF WS_COUNT > 0 THEN
	        SELECT WS_KEY+WS_INC INTO WS_KEY FROM DESTAQUE;
	    ELSE
	        EXIT;
	    END IF;
	END LOOP;
    

	INSERT INTO DESTAQUE VALUES(PRM_USUARIO, PRM_OBJETO, PRM_COLUNA, PRM_CONDICAO, WS_CONVERTE, PRM_FUNDO, PRM_FONTE, PRM_TIPO, PRM_PRIORIDADE, WS_KEY);
	COMMIT;

    EXCEPTION WHEN OTHERS THEN
        HTP.P(SQLERRM);
        HTP.P('#alert '||FUN.LANG('Erro ao adicionar')||'!');
END SETDESTAQUE;


PROCEDURE DELETEFILTRO ( PRM_KEY  NUMBER DEFAULT NULL ) AS

    WS_COUNT   NUMBER;
	WS_USUARIO VARCHAR2(80);

    WS_FAIL    EXCEPTION;
	WS_NOUSER  EXCEPTION;

BEGIN
   
    WS_USUARIO := GBL.GETUSUARIO;
	
	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;
    
    DELETE FROM FILTROS WHERE CD_FILTRO = PRM_KEY;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
		
		INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Filtro #'||PRM_KEY||' excluido', WS_USUARIO, 'EVENTO');
		COMMIT;
		
	ELSE
	    RAISE WS_FAIL;
	END IF;


EXCEPTION 
    WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN WS_FAIL THEN
        HTP.P('FAIL');
    WHEN OTHERS THEN
        HTP.P('FAIL');
END DELETEFILTRO;


PROCEDURE PREFERENCIAS( PRM_USUARIO VARCHAR2 DEFAULT NULL) AS

	WS_INLINE  NUMBER;
    WS_USUARIO VARCHAR2(80);
BEGIN
    
	SELECT COUNT(*) INTO WS_INLINE FROM PREFERENCIAS WHERE USU_NOME = PRM_USUARIO AND PROPRIEDADE = 'inline';

    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_INLINE = 1 THEN
		HTP.P(''||FUN.LANG('Posicionar menus na horizontal')||': <input type="checkbox" value="inline" checked="checked" onchange=" if(this.checked == false){ ajax(''fly'', ''a_preferencias'', ''prm_usuario='||WS_USUARIO||'&prm_propriedade=inline&prm_acao=d'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''''); } } else { ajax(''fly'', ''a_preferencias'', ''prm_usuario='||WS_USUARIO||'&prm_propriedade=inline&prm_acao=i'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''inline''); } }" />');
	ELSE
	    HTP.P(''||FUN.LANG('Posicionar menus na horizontal')||': <input type="checkbox" value="inline" onchange=" if(this.checked == true){ ajax(''fly'', ''a_preferencias'', ''prm_usuario='||WS_USUARIO||'&prm_propriedade=inline&prm_acao=i'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''inline''); } } else { ajax(''fly'', ''a_preferencias'', ''prm_usuario='||WS_USUARIO||'&prm_propriedade=inline&prm_acao=d'', ''true''); li = parent.document.getElementById(''pro6'').getElementsByTagName(''li''); for(i=0;i<li.length;i++){ li[i].setAttribute(''class'',''''); } }" />');
	END IF;

    EXCEPTION WHEN OTHERS THEN
        HTP.P(SQLERRM);
END PREFERENCIAS;

PROCEDURE A_PREFERENCIAS( PRM_USUARIO     VARCHAR2 DEFAULT NULL,
						  PRM_PROPRIEDADE VARCHAR2 DEFAULT NULL,
						  PRM_ACAO        VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	IF PRM_ACAO = 'd' THEN
	    DELETE FROM PREFERENCIAS WHERE USU_NOME = PRM_USUARIO AND PROPRIEDADE = PRM_PROPRIEDADE;
	END IF;

	IF PRM_ACAO = 'i' THEN
	    INSERT INTO PREFERENCIAS VALUES(PRM_USUARIO, PRM_PROPRIEDADE);
	END IF;

    EXCEPTION WHEN OTHERS THEN
        HTP.P(SQLERRM);
END A_PREFERENCIAS;


PROCEDURE BLINK ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                  PRM_VISAO  VARCHAR2 DEFAULT NULL,
				  PRM_ORDER  VARCHAR2 DEFAULT '1',
				  PRM_DIR    VARCHAR2 DEFAULT '1'  ) AS

	CURSOR CRS_EFEITOSB(PRM_USUARIO VARCHAR2) IS
	SELECT CD_USUARIO, CD_OBJETO, CD_COLUNA, CONDICAO, CONTEUDO, COR_FUNDO, COR_FONTE, TIPO_DESTAQUE, PRIORIDADE, CD_DESTAQUE
	FROM DESTAQUE
	WHERE CD_OBJETO = TRIM(PRM_OBJETO) AND (CD_USUARIO = PRM_USUARIO OR CD_USUARIO = 'DWU' OR GBL.GETNIVEL = 'A')
	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_USUARIO, '2', CD_COLUNA, '3', CONDICAO, '4', CONTEUDO, '5', TIPO_DESTAQUE, CD_USUARIO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_USUARIO, '2', CD_COLUNA, '3', CONDICAO, '4', CONTEUDO, '5', TIPO_DESTAQUE, CD_USUARIO) END DESC;

	WS_EFEITOB CRS_EFEITOSB%ROWTYPE;


	WS_COUNTER  NUMBER := 0;
	WS_DIR      NUMBER := 1;
	WS_TIPO     VARCHAR2(80);
    WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(80);
	WS_TPVALOR  VARCHAR2(100);

	WS_NOUSER   EXCEPTION;

BEGIN

	WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	SELECT TP_OBJETO INTO WS_TIPO FROM OBJETOS WHERE CD_OBJETO = PRM_OBJETO;

	HTP.P('<input type="hidden" id="destaque-visao" value="'||PRM_VISAO||'" title="'||PRM_VISAO||'"/>');

	HTP.P('<div style="margin-top: 10px;">');
		HTP.P('<table class="linha">');
			HTP.P('<thead>');
				HTP.P('<tr>');
					HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||PRM_OBJETO||'&prm_visao='||PRM_VISAO||'&prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
					HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||PRM_OBJETO||'&prm_visao='||PRM_VISAO||'&prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('COLUNA')||'</a></th>');
					HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||PRM_OBJETO||'&prm_visao='||PRM_VISAO||'&prm_order=3&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</a></th>');
					HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||PRM_OBJETO||'&prm_visao='||PRM_VISAO||'&prm_order=4&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('VALOR')||'</a></th>');
					
					IF WS_TIPO = 'CONSULTA' OR WS_TIPO = 'BROWSER' THEN
						
						HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''blink'', ''prm_objeto='||PRM_OBJETO||'&prm_visao='||PRM_VISAO||'&prm_order=5&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('TIPO')||'</a></th>');
					
					END IF;

					HTP.P('<th>'||FUN.LANG('COR DO FUNDO')||'</th>');

					IF WS_TIPO NOT IN ('BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') THEN
						
						HTP.P('<th>'||FUN.LANG('COR DA FONTE')||'</th>');
					
					END IF;

					HTP.P('<th>'||FUN.LANG('PRIORIDADE')||'</th>');
					HTP.P('<th></th>');
					HTP.P('<th></th>');
				HTP.P('<tr>');
			HTP.P('</thead>');

			IF TO_NUMBER(PRM_DIR) = 1 THEN 
				WS_DIR := 2; 
			END IF;

			HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');

				OPEN CRS_EFEITOSB(WS_USUARIO);
					LOOP
						FETCH CRS_EFEITOSB INTO WS_EFEITOB;
						EXIT WHEN CRS_EFEITOSB%NOTFOUND;

							IF WS_ADMIN = 'A' OR WS_EFEITOB.CD_USUARIO = WS_USUARIO THEN
								
								HTP.P('<tr>');
								
									IF WS_ADMIN = 'A' THEN
										HTP.P('<td>');
											HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-usuario-'||WS_COUNTER||''').title+''&prm_alter=USUARIO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											FCL.FAKEOPTION('destaque-usuario-'||WS_COUNTER, 'Lista de usuarios', WS_EFEITOB.CD_USUARIO, 'lista-usuarios-grupos', 'N', 'N', '', '');
										HTP.P('</td>');
									ELSE
										HTP.P('<td class="readonly"><input readonly type="text" id="destaque-usuario-'||WS_COUNTER||'" data-default="'||WS_EFEITOB.CD_USUARIO||'" value="'||WS_EFEITOB.CD_USUARIO||'" /></td>');
									END IF;

									IF WS_TIPO = 'BROWSER' THEN
										HTP.P('<td>');
											HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-coluna-'||WS_COUNTER||''').title+''&prm_alter=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											FCL.FAKEOPTION('destaque-coluna-'||WS_COUNTER, 'Lista de colunas', WS_EFEITOB.CD_COLUNA, 'lista-coluna', 'N', 'N', 'destaque-visao', '');											    
										HTP.P('</td>');
									ELSIF WS_TIPO = 'VALOR' THEN
										HTP.P('<td>');
											
											HTP.P('<input type="text" value="'||WS_EFEITOB.CD_COLUNA||'" class="readonly" readonly />');
										HTP.P('</td>');
									ELSE
										HTP.P('<td>');
											HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-coluna-'||WS_COUNTER||''').title+''&prm_alter=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											FCL.FAKEOPTION('destaque-coluna-'||WS_COUNTER, 'Lista de colunas', WS_EFEITOB.CD_COLUNA, 'lista-colunas', 'N', 'N', 'destaque-visao', '');
										HTP.P('</td>');
									END IF;

									HTP.P('<td>');
										HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-condicao-'||WS_COUNTER||''').title+''&prm_alter=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
										IF WS_TIPO NOT IN ('BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') THEN
											FCL.FAKEOPTION('destaque-condicao-'||WS_COUNTER, 'Lista de condi&ccedil;&otilde;es', WS_EFEITOB.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', 'normal');
										ELSE
											FCL.FAKEOPTION('destaque-condicao-'||WS_COUNTER, 'Lista de condi&ccedil;&otilde;es', WS_EFEITOB.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', 'graph');
										END IF;
									HTP.P('</td>');

									IF WS_TIPO = 'BROWSER' THEN
										HTP.P('<td>');
											HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+encodeURIComponent(document.getElementById(''destaque-conteudo-'||WS_COUNTER||''').title)+''&prm_alter=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											FCL.FAKEOPTION('destaque-conteudo-'||WS_COUNTER, FUN.LANG('Lista de valores'), WS_EFEITOB.CONTEUDO, 'lista-valores-browser', 'S', 'N', 'destaque-visao', '', 'destaque-coluna-'||WS_COUNTER);
										HTP.P('</td>');
									ELSE
										HTP.P('<td>');
											HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+encodeURIComponent(document.getElementById(''destaque-conteudo-'||WS_COUNTER||''').title)+''&prm_alter=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
											FCL.FAKEOPTION('destaque-conteudo-'||WS_COUNTER, FUN.LANG('Lista de valores'), WS_EFEITOB.CONTEUDO, 'lista-valores', 'S', 'N', 'destaque-visao', '', 'destaque-coluna-'||WS_COUNTER);
										HTP.P('</td>');
									END IF;
									
									IF WS_TIPO = 'CONSULTA' THEN
										HTP.P('<td><select id="destaque-tipo-'||WS_COUNTER||'" data-default="'||WS_EFEITOB.TIPO_DESTAQUE||'" onchange="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-tipo-'||WS_COUNTER||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
											IF WS_EFEITOB.TIPO_DESTAQUE = 'total' THEN
												HTP.P('<option value="total" selected>'||FUN.LANG('Total')||'</option>');
											ELSE
												HTP.P('<option value="total">'||FUN.LANG('Total')||'</option>');
											END IF;
											IF WS_EFEITOB.TIPO_DESTAQUE = 'normal' THEN
												HTP.P('<option value="normal" selected>'||FUN.LANG('Normal')||'</option>');
											ELSE
												HTP.P('<option value="normal">'||FUN.LANG('Normal')||'</option>');
											END IF;
											IF WS_EFEITOB.TIPO_DESTAQUE = 'linha' THEN
												HTP.P('<option value="linha" selected>'||FUN.LANG('Linha')||'</option>');
											ELSE
												HTP.P('<option value="linha">'||FUN.LANG('Linha')||'</option>');
											END IF;
										HTP.P('</select></td>');
									ELSIF WS_TIPO = 'BROWSER' THEN
											HTP.P('<td><select id="destaque-tipo-'||WS_COUNTER||'" data-default="'||WS_EFEITOB.TIPO_DESTAQUE||'" onchange="call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-tipo-'||WS_COUNTER||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
												IF WS_EFEITOB.TIPO_DESTAQUE = 'estrela' THEN
													HTP.P('<option value="estrela" selected>'||FUN.LANG('Estrela')||'</option>');
												ELSE
													HTP.P('<option value="estrela">'||FUN.LANG('Estrela')||'</option>');
												END IF;
												IF WS_EFEITOB.TIPO_DESTAQUE = 'linha' THEN
													HTP.P('<option value="linha" selected>'||FUN.LANG('Linha')||'</option>');
												ELSE
													HTP.P('<option value="linha">'||FUN.LANG('Linha')||'</option>');
												END IF;
											HTP.P('</select></td>');
										
									ELSE
										HTP.P('<input type="hidden" title="'||WS_EFEITOB.TIPO_DESTAQUE||'" value="'||WS_EFEITOB.TIPO_DESTAQUE||'" class="readonly" readonly />');

									END IF;

									HTP.P('<td>');
										HTP.P('<input style="width: 90px !important; min-width: 90px;" onchange="this.nextElementSibling.value = this.value; call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-icorfundo-'||WS_COUNTER||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" data-obj="'||PRM_OBJETO||'" data-counter="'||WS_COUNTER||'" data-tipo="CORFUNDO" title="cor de fundo" type="text" id="destaque-icorfundo-'||WS_COUNTER||'" placeholder="'||FUN.LANG('fundo')||'" value="'||WS_EFEITOB.COR_FUNDO||'" data-default="'||WS_EFEITOB.COR_FUNDO||'">');
										HTP.P('<input type="color" onchange="this.previousElementSibling.value = this.value; call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-icorfundo-'||WS_COUNTER||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"  value="'||WS_EFEITOB.COR_FUNDO||'" />');
									HTP.P('</td>');
									
									IF WS_TIPO NOT IN ('BARRAS', 'LINHAS', 'PIZZA', 'COLUNAS') THEN
										HTP.P('<td>');
											HTP.P('<input style="width: 90px !important; min-width: 90px;" onchange="this.nextElementSibling.value = this.value; call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-icorfonte-'||WS_COUNTER||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" data-obj="'||PRM_OBJETO||'" data-counter="'||WS_COUNTER||'" data-tipo="CORFONTE" title="cor da fonte"  type="text" id="destaque-icorfonte-'||WS_COUNTER||'" placeholder="'||FUN.LANG('fonte')||'" value="'||WS_EFEITOB.COR_FONTE||'" data-default="'||WS_EFEITOB.COR_FONTE||'">');
											HTP.P('<input type="color" onchange="this.previousElementSibling.value = this.value; call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-icorfonte-'||WS_COUNTER||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" value="'||WS_EFEITOB.COR_FONTE||'" />');
										HTP.P('</td>');
									ELSE
										HTP.P('<input type="hidden" id="destaque-icorfonte-'||WS_COUNTER||'" value="'||WS_EFEITOB.COR_FONTE||'" data-default="'||WS_EFEITOB.COR_FONTE||'">');
									END IF;
									

									HTP.P('<td><input id="destaque-prioridade-'||WS_COUNTER||'" type="number" value="'||NVL(WS_EFEITOB.PRIORIDADE, 0)||'" data-default="'||NVL(WS_EFEITOB.PRIORIDADE, 0)||'" onchange="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-prioridade-'||WS_COUNTER||''').value+''&prm_alter=PRIORIDADE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } }); }}" onblur="if(this.value.length > 0){ if(this.value != this.getAttribute(''data-default'')){ call(''edit_blink'',''prm_key='||WS_EFEITOB.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-prioridade-'||WS_COUNTER||''').value+''&prm_alter=PRIORIDADE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } }); }}"/></td>');
									HTP.P('<td>');
										FCL.BUTTON_LIXO('delete_blink','prm_key', WS_EFEITOB.CD_DESTAQUE, 1);
									HTP.P('</td>');
									
									HTP.P('<td><input style="display: none;" type="text" id="destaque-objeto-'||WS_COUNTER||'" data-default="'||PRM_OBJETO||'" value="'||PRM_OBJETO||'" /></td>');
								HTP.P('<tr>');

							ELSE

								HTP.P('<tr>');

									HTP.P('<td class="readonly"><input readonly type="text" id="destaque-usuario-'||WS_COUNTER||'" data-default="'||WS_EFEITOB.CD_USUARIO||'" value="'||WS_EFEITOB.CD_USUARIO||'" /></td>');

									HTP.P('<td class="readonly"><input readonly id="destaque-coluna-'||WS_COUNTER||'" data-default="'||WS_EFEITOB.CD_COLUNA||'" type="text" readonly value="'||WS_EFEITOB.CD_COLUNA||'"/></td>');

									HTP.P('<td class="readonly">');
										HTP.P('<input readonly type="text" value="'||WS_EFEITOB.CONDICAO||'" />');
									HTP.P('</td>');

									HTP.P('<td class="readonly">');
										HTP.P('<input readonly type="text" value="'||WS_EFEITOB.CONTEUDO||'" />');
									HTP.P('</td>');

									HTP.P('<td class="readonly">');
										HTP.P('<input readonly type="text" value="'||WS_EFEITOB.TIPO_DESTAQUE||'">');
									HTP.P('</td>');

									HTP.P('<td class="readonly">');
										HTP.P('<input readonly style="width: 90px !important; min-width: 90px;" value="'||WS_EFEITOB.COR_FUNDO||'" />');
										HTP.P('<input type="color" disabled readonly value="'||WS_EFEITOB.COR_FUNDO||'" />');
									HTP.P('</td>');
									HTP.P('<td class="readonly">');
										HTP.P('<input readonly style="width: 90px !important; min-width: 90px;" value="'||WS_EFEITOB.COR_FONTE||'" />');
										HTP.P('<input type="color" disabled readonly value="'||WS_EFEITOB.COR_FONTE||'" />');
									HTP.P('</td>');

									HTP.P('<td class="readonly"><input readonly value="'||NVL(WS_EFEITOB.PRIORIDADE, 0)||'" /></td>');

									HTP.P('<td></td>');
									HTP.P('<td></td>');
								HTP.P('<tr>');

							END IF;
						WS_COUNTER := WS_COUNTER+1;
					END LOOP;
				CLOSE CRS_EFEITOSB;

			HTP.P('</tbody>');
		HTP.P('</table>');
	HTP.P('</div>');

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P('!alert Erro ao carregar!'||SQLERRM);
END BLINK;

PROCEDURE BLINK_COLUNA AS

	WS_USUARIO  VARCHAR2(80);
	WS_NOACCESS EXCEPTION;

BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACCESS;
	END IF;

    HTP.P('<div class="searchbar">');
        HTP.P('<a class="script" onclick="var valor = document.getElementById(''destaque-usuario-search'').title; ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+valor+''&prm_order=1&prm_dir='', true, ''ajax''); document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = valor;"></a>');
		FCL.FAKEOPTION('destaque-usuario-search', FUN.LANG('Busca por usu&aacute;rios'), '', 'lista-usuarios-grupos', 'N', 'N');
	HTP.P('</div>');

	HTP.P('<div style="margin-top: 10px;">');
		HTP.P('<table class="linha">');
			HTP.P('<thead>');
				HTP.P('<tr>');
					HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=1&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
					HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=2&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('CONSULTA')||'</th>');
					HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=3&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('COLUNA')||'</th>');
					HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=4&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</th>');
					HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=5&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('VALOR')||'</th>');
					HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=6&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('TIPO')||'</th>');
					HTP.P('<th>'||FUN.LANG('COR FUNDO')||'</th>');
					HTP.P('<th>'||FUN.LANG('COR FONTE')||'</th>');
					HTP.P('<th>'||FUN.LANG('PRIORIDADE')||'</th>');
					HTP.P('<th></th>');
				HTP.P('<tr>');
			HTP.P('</thead>');
			HTP.P('<tbody id="ajax" data-dir="1"></tbody>');
		HTP.P('</table>');
	HTP.P('</div>');

EXCEPTION 
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END BLINK_COLUNA;

PROCEDURE EDIT_BLINK ( PRM_KEY      NUMBER   DEFAULT NULL,
					   PRM_VALOR    VARCHAR2 DEFAULT NULL,
					   PRM_ALTER    VARCHAR2 DEFAULT NULL ) AS

    WS_COUNTER NUMBER;

	WS_FORBIDDEN EXCEPTION;

	BEGIN
    

		BEGIN
			IF PRM_ALTER = 'USUARIO' THEN
				UPDATE DESTAQUE
				SET CD_USUARIO = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'COLUNA' THEN
				UPDATE DESTAQUE
				SET CD_COLUNA = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'CONDICAO' THEN
				UPDATE DESTAQUE
				SET CONDICAO = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'CONTEUDO' THEN
				UPDATE DESTAQUE
				SET CONTEUDO = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'TIPO' THEN
				UPDATE DESTAQUE
				SET TIPO_DESTAQUE = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'CORFUNDO' THEN
				UPDATE DESTAQUE
				SET COR_FUNDO = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'CORFONTE' THEN
				UPDATE DESTAQUE
				SET COR_FONTE = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'PRIORIDADE' THEN
				UPDATE DESTAQUE
				SET PRIORIDADE = PRM_VALOR
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Alterado com sucesso')||'!');
			ELSIF PRM_ALTER = 'DELETE' THEN
				DELETE FROM DESTAQUE
				WHERE CD_DESTAQUE = PRM_KEY;
				HTP.P(FUN.LANG('Destaque excluido com sucesso')||'!');
			ELSE
				HTP.P('msg');
			END IF;
			
			
		EXCEPTION WHEN OTHERS THEN
			HTP.P('FAIL '||SQLERRM);
		END;
EXCEPTION
    WHEN WS_FORBIDDEN THEN
	    HTP.P(FUN.LANG('Usu&aacute;rio sem permiss&atilde;o')||'!');
	WHEN OTHERS THEN
        HTP.P(SQLERRM);

END EDIT_BLINK;

PROCEDURE DELETE_BLINK( PRM_KEY NUMBER DEFAULT NULL ) AS

    WS_COUNTER NUMBER;
    WS_FAIL    EXCEPTION;
    WS_COUNT   NUMBER;

	BEGIN
    
	
	DELETE FROM DESTAQUE WHERE CD_DESTAQUE = PRM_KEY;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
	    COMMIT;
	ELSE
	    RAISE WS_FAIL;
	END IF;
	
EXCEPTION 
	WHEN WS_FAIL THEN
	    HTP.P('FAIL');
	WHEN OTHERS  THEN
	    HTP.P('FAIL');

END DELETE_BLINK;


PROCEDURE LIST_BLINK ( L_PA VARCHAR2 DEFAULT NULL ) AS

CURSOR CRS_MICROCOLUNAS IS

	SELECT CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, '#000000' AS COLOR
	FROM MICRO_COLUNA
	WHERE CD_COLUNA NOT IN (
	    SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = L_PA)))
	) AND CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = L_PA AND ROWNUM = 1)

	UNION ALL

	SELECT CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, '#CC0000' AS COLOR
	FROM MICRO_COLUNA
	WHERE CD_COLUNA IN (
	    SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = L_PA)))
	) AND CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = L_PA AND ROWNUM = 1)
	ORDER BY NM_ROTULO ASC;

	WS_MICRO CRS_MICROCOLUNAS%ROWTYPE;

    BEGIN
	
	HTP.FORMSELECTOPEN( CNAME=>'i_lista', CATTRIBUTES => ' id="i_lista" ');
		OPEN CRS_MICROCOLUNAS;
			LOOP
				FETCH CRS_MICROCOLUNAS INTO WS_MICRO;
				EXIT WHEN CRS_MICROCOLUNAS%NOTFOUND;
					HTP.P('<option style="color: '||WS_MICRO.COLOR||'" value="'||WS_MICRO.CD_COLUNA||'">['||WS_MICRO.CD_COLUNA||'] '||WS_MICRO.NM_ROTULO||'</option>');
			END LOOP;
		CLOSE CRS_MICROCOLUNAS;
	HTP.FORMSELECTCLOSE;

END LIST_BLINK;


PROCEDURE LIST_MBLINK ( PRM_OBJETO  VARCHAR2 DEFAULT NULL,
                        PRM_USUARIO VARCHAR2 DEFAULT 'N/A',
						PRM_ORDER   VARCHAR2 DEFAULT '1',
						PRM_DIR     VARCHAR2 DEFAULT '1' ) AS

    CURSOR CRS_COLUNAS IS
	SELECT CD_USUARIO, CD_OBJETO, CD_COLUNA, CONDICAO, CONTEUDO, COR_FUNDO, COR_FONTE, TIPO_DESTAQUE, PRIORIDADE, CD_DESTAQUE
	FROM DESTAQUE WHERE CD_OBJETO = TRIM(NVL(PRM_OBJETO, CD_OBJETO)) AND (CD_USUARIO = PRM_USUARIO OR CD_USUARIO IN (SELECT CD_USUARIO FROM GUSERS_ITENS WHERE CD_GROUP = PRM_USUARIO) OR PRM_USUARIO = 'TODOS')
	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_USUARIO, '2', CD_OBJETO, '3', CD_COLUNA, '4', CONDICAO, '5', CONTEUDO, '6', TIPO_DESTAQUE, CD_USUARIO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_USUARIO, '2', CD_OBJETO, '3', CD_COLUNA, '4', CONDICAO, '5', CONTEUDO, '6', TIPO_DESTAQUE, CD_USUARIO) END DESC;

	WS_COLUNA CRS_COLUNAS%ROWTYPE;

	WS_VISAO    VARCHAR2(80) := '';
	WS_LIGACAO  VARCHAR2(200);
	WS_COUNTER  NUMBER;
	

    BEGIN
    

	WS_COUNTER := 0;

	IF LENGTH(PRM_OBJETO) <> 0 THEN
	    SELECT CD_MICRO_VISAO INTO WS_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = TRIM(PRM_OBJETO);
	END IF;
    
	IF NVL(PRM_USUARIO, 'N/A') = 'N/A' THEN

		HTP.P('<div class="searchbar">');
            HTP.P('<a class="script" onclick="var valor = document.getElementById(''destaque-usuario-search'').title; ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+valor+''&prm_order=1&prm_dir='', true, ''ajax''); document.getElementById(''prm_usuario'').title = valor; document.getElementById(''prm_usuario'').children[0].innerHTML = valor;"></a>');
			FCL.FAKEOPTION('destaque-usuario-search', NVL(PRM_USUARIO, 'Lista de usu&aacute;rios'), PRM_USUARIO, 'lista-usuarios-grupos', 'N', 'N');
		HTP.P('</div>');


		
		HTP.P('<div style="margin-top: 10px;">');
			HTP.P('<table class="linha">');
				HTP.P('<thead>');
					HTP.P('<tr>');
						HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=1&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
						HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=2&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('CONSULTA')||'</th>');
						HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=3&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('COLUNA')||'</th>');
						HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=4&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('CONDI&Ccedil;&Atilde;O')||'</th>');
						HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=5&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('VALOR')||'</th>');
						HTP.P('<th><a class="red" onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''list_mblink'', ''prm_objeto=&prm_usuario=''+document.getElementById(''destaque-usuario-search'').title+''&prm_order=6&prm_dir=''+dir, false, ''ajax'');">'||FUN.LANG('TIPO')||'</th>');
						HTP.P('<th>'||FUN.LANG('COR FUNDO')||'</th>');
						HTP.P('<th>'||FUN.LANG('COR FONTE')||'</th>');
						HTP.P('<th>'||FUN.LANG('PRIORIDADE')||'</th>');
						HTP.P('<th></th>');
					HTP.P('<tr>');
				HTP.P('</thead>');
				HTP.P('<tbody id="ajax" data-dir="1">');

	END IF;
	

	OPEN CRS_COLUNAS;
		LOOP
			FETCH CRS_COLUNAS INTO WS_COLUNA;
			EXIT WHEN CRS_COLUNAS%NOTFOUND;
			
			WS_COUNTER := WS_COUNTER+1;
			
			HTP.P('<tr>');
			
			    BEGIN
					SELECT CD_MICRO_VISAO INTO WS_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = TRIM(WS_COLUNA.CD_OBJETO);
					HTP.P('<td style="display: none;"><input type="hidden" id="destaque-visao-'||WS_COUNTER||'" title="'||WS_VISAO||'" value="'||WS_VISAO||'" /></td>');
				EXCEPTION WHEN OTHERS THEN
				    HTP.P('<td style="display: none;"><input type="hidden" id="destaque-visao-'||WS_COUNTER||'" title="" value="" /></td>');
				END;
			
				HTP.P('<td>'||TRIM(WS_COLUNA.CD_USUARIO)||'</td>');
				HTP.P('<td>'||TRIM(WS_COLUNA.CD_OBJETO)||'</td>');
				
			
			    HTP.P('<td>');
					HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-coluna-'||WS_COUNTER||''').title+''&prm_alter=COLUNA'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
					FCL.FAKEOPTION('destaque-coluna-'||WS_COUNTER, '', WS_COLUNA.CD_COLUNA, 'lista-colunas', 'N', 'N', 'destaque-visao-'||WS_COUNTER, '');
				HTP.P('</td>');

				HTP.P('<td>');
					HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-condicao-'||WS_COUNTER||''').title+''&prm_alter=CONDICAO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
					FCL.FAKEOPTION('destaque-condicao-'||WS_COUNTER||'', '', WS_COLUNA.CONDICAO, 'lista-condicoes', 'N', 'N', '', '', '', FUN.DCONDICAO(WS_COLUNA.CONDICAO));
				HTP.P('</td>');


				
				HTP.P('<td>');
				    HTP.P('<a class="script" onclick="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-conteudo-'||WS_COUNTER||''').title+''&prm_alter=CONTEUDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });"></a>');
	                
					BEGIN
								
						SELECT CD_LIGACAO INTO WS_LIGACAO FROM MICRO_COLUNA WHERE CD_COLUNA = WS_COLUNA.CD_COLUNA AND CD_MICRO_VISAO = WS_VISAO;
						
						IF WS_LIGACAO <> 'SEM' THEN
						    FCL.FAKEOPTION('destaque-conteudo-'||WS_COUNTER, FUN.LANG('Lista de valores'), WS_COLUNA.CONTEUDO, 'lista-valores', 'S', 'N', 'destaque-visao-'||WS_COUNTER, '', 'destaque-coluna-'||WS_COUNTER, FUN.CDESC(WS_COLUNA.CONTEUDO, WS_LIGACAO));
						ELSE
							FCL.FAKEOPTION('destaque-conteudo-'||WS_COUNTER, FUN.LANG('Lista de valores'), WS_COLUNA.CONTEUDO, 'lista-valores', 'S', 'N', 'destaque-visao-'||WS_COUNTER, '', 'destaque-coluna-'||WS_COUNTER);
						END IF;
					
					EXCEPTION WHEN OTHERS THEN
						
						FCL.FAKEOPTION('destaque-conteudo-'||WS_COUNTER, FUN.LANG('Lista de valores'), WS_COLUNA.CONTEUDO, 'lista-valores', 'S', 'N', 'destaque-visao-'||WS_COUNTER, '', 'destaque-coluna-'||WS_COUNTER);
					
					END;
					
	            HTP.P('</td>');

				HTP.P('<td><select id="destaque-tipo-'||WS_COUNTER||'" data-default="'||WS_COLUNA.TIPO_DESTAQUE||'" onchange="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-tipo-'||WS_COUNTER||''').value+''&prm_alter=TIPO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">');
					IF WS_COLUNA.TIPO_DESTAQUE = 'total' THEN
						HTP.P('<option value="total" selected>'||FUN.LANG('Total')||'</option>');
					ELSE
						HTP.P('<option value="total">'||FUN.LANG('Total')||'</option>');
					END IF;
					IF WS_COLUNA.TIPO_DESTAQUE = 'normal' THEN
						HTP.P('<option value="normal" selected>'||FUN.LANG('Normal')||'</option>');
					ELSE
						HTP.P('<option value="normal">'||FUN.LANG('Normal')||'</option>');
					END IF;
					IF WS_COLUNA.TIPO_DESTAQUE = 'linha' THEN
						HTP.P('<option value="linha" selected>'||FUN.LANG('Linha')||'</option>');
					ELSE
						HTP.P('<option value="linha">'||FUN.LANG('Linha')||'</option>');
					END IF;
				HTP.P('</select></td>');

				HTP.P('<td>');
					HTP.P('<input style="width: 90px !important; min-width: 90px;" onchange="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-icorfundo-'||WS_COUNTER||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" title="cor de fundo" type="text" id="destaque-icorfundo-'||WS_COUNTER||'" placeholder="'||FUN.LANG('fundo')||'" value="'||WS_COLUNA.COR_FUNDO||'" data-default="'||WS_COLUNA.COR_FUNDO||'">');
					HTP.P('<input type="color" id="destaque-ccorfundo-'||WS_COUNTER||'" onchange="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-ccorfundo-'||WS_COUNTER||''').value+''&prm_alter=CORFUNDO'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" value="'||WS_COLUNA.COR_FUNDO||'"/>');
				HTP.P('</td>');
				HTP.P('<td>');
					HTP.P('<input style="width: 90px !important; min-width: 90px;" onchange="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-icorfonte-'||WS_COUNTER||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" data-tipo="CORFONTE" title="cor da fonte" type="text" id="destaque-icorfonte-'||WS_COUNTER||'" placeholder="'||FUN.LANG('fonte')||'" value="'||WS_COLUNA.COR_FONTE||'" data-default="'||WS_COLUNA.COR_FONTE||'">');
					HTP.P('<input type="color" onchange="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-ccorfonte-'||WS_COUNTER||''').value+''&prm_alter=CORFONTE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" id="destaque-ccorfonte-'||WS_COUNTER||'" value="'||WS_COLUNA.COR_FONTE||'"/>');
				HTP.P('</td>');
				
				HTP.P('<td>');
					HTP.P('<input type="number" style="width: 44px !important;" title="prioridade" type="text" id="destaque-prioridade-'||WS_COUNTER||'" onchange="call(''edit_blink'',''prm_key='||WS_COLUNA.CD_DESTAQUE||'&prm_valor=''+document.getElementById(''destaque-prioridade-'||WS_COUNTER||''').value+''&prm_alter=PRIORIDADE'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });" value="'||WS_COLUNA.PRIORIDADE||'"/>');
				HTP.P('</td>');
                HTP.P('<td>');
					FCL.BUTTON_LIXO('delete_blink','prm_key', WS_COLUNA.CD_DESTAQUE, 1);
				HTP.P('</td>');
				
			HTP.P('<tr>');


		END LOOP;
	CLOSE CRS_COLUNAS;

    IF NVL(PRM_USUARIO, 'N/A') = 'N/A' THEN
		        HTP.P('</tbody>');
			HTP.P('</table>');
		HTP.P('</div>');
	END IF;
	
EXCEPTION 
    WHEN OTHERS THEN
	    HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END LIST_MBLINK;

PROCEDURE LOAD_DADO ( PRM_NOME VARCHAR2 DEFAULT NULL,
                      PRM_TIPO VARCHAR2 DEFAULT NULL,
                      PRM_TIME NUMBER ) AS

  WS_CONTEUDO LONG;

BEGIN
    
    SELECT TEXT INTO WS_CONTEUDO FROM DBA_VIEWS WHERE OWNER = 'DWU' AND VIEW_NAME = UPPER(PRM_NOME) AND ROWNUM = 1;

	WS_CONTEUDO := SUBSTR(WS_CONTEUDO, (PRM_TIME*30000), 30000);
	HTP.P(WS_CONTEUDO);

END LOAD_DADO;

PROCEDURE EDIT_VIEW AS

BEGIN
    
    HTP.P('<html style="display: inline; float: left; font-family: arial; height: 415px; margin: 0; min-width: 720px;">');
		HTP.P('<head>');
		HTP.P('</head>');
		HTP.P('<body style="display: inline; float: left; font-family: arial; height: 415px; margin: 0; min-width: 720px;">');
			HTP.FORMSELECTOPEN( CNAME => '', CATTRIBUTES => ' style="display: block; margin-right: 300px;" onchange=" valor = this.value; if(valor != ''''){ document.getElementById(''valor'').value = valor; classe = this.options[this.selectedIndex].getAttribute(''class''); document.getElementById(''valor'').setAttribute(''class'',classe); nome = this.options[this.selectedIndex].getAttribute(''name''); document.getElementById(''titulo'').value= nome; } else { document.getElementById(''valor'').value = ''''; document.getElementById(''titulo'').value = ''''; document.getElementById(''valor'').setAttribute(''class'',''''); document.getElementById(''titulo'').setAttribute(''class'','''');} " ' );
				HTP.P('<option value="">'||FUN.LANG('Escolha uma op&ccedil;&atilde;o')||'</option>');
			HTP.FORMSELECTCLOSE;
			HTP.P('<input id="titulo" type="text" style="width: 700px; display: block; margin: 5px 0;" placeholder="'||FUN.LANG('T&iacute;tulo')||'" />');
			HTP.P('<textarea id="valor" class="" style="min-width: 720px; min-height: 320px; display: block;" ></textarea>');
			HTP.P('<input type="submit" onclick="" />');
		HTP.P('</body>');
	HTP.P('</head>');

END EDIT_VIEW;

PROCEDURE NEW_QUERY ( PRM_OBJ VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT   NUMBER;
    WS_SQL     DBMS_SQL.VARCHAR2A;
	WS_POINTER PLS_INTEGER;
	WS_ROWS    PLS_INTEGER;
BEGIN
    
    SELECT COUNT(*) INTO WS_COUNT FROM ALL_OBJECTS WHERE OBJECT_NAME = UPPER(TRIM(PRM_OBJ));
    IF WS_COUNT = 0 THEN
	    HTP.P('<option value="" id="'||UPPER(TRIM(PRM_OBJ))||'" class="view">[view] '||UPPER(TRIM(PRM_OBJ))||'</option>');
	    WS_SQL(1) := 'Create or replace view '||UPPER(TRIM(PRM_OBJ))||' as select * from log_eventos';
		WS_POINTER := DBMS_SQL.OPEN_CURSOR;
        DBMS_SQL.PARSE( C => WS_POINTER, STATEMENT => WS_SQL, LB => 1, UB => 1, LFFLG => FALSE, LANGUAGE_FLAG => DBMS_SQL.NATIVE);
		WS_ROWS := DBMS_SQL.EXECUTE(WS_POINTER);
        DBMS_SQL.CLOSE_CURSOR(WS_POINTER);
    ELSE
	    HTP.P('#alert '||FUN.LANG('Impossivel criar, valor j&aacute; existe')||'!');
	END IF;
EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END NEW_QUERY;

PROCEDURE REG_ONLINE ( PRM_TIPO     VARCHAR2 DEFAULT NULL,
                        PRM_EVENTO   VARCHAR2 DEFAULT NULL,
                        PRM_STATUS   VARCHAR2 DEFAULT NULL,
                        PRM_USUARIO  VARCHAR2 DEFAULT NULL,
                        PRM_QTDE     VARCHAR2 DEFAULT NULL ) AS

                CURSOR CRS_PENDINGS IS
                    SELECT   DT_REGISTRO, COMMAND, ROWID ID_LINHA
                    FROM     PENDING_REGS
                    WHERE    STATUS='P'
                    ORDER BY DT_REGISTRO DESC;

    WS_PENDINGS        CRS_PENDINGS%ROWTYPE;

    WS_COUNT        NUMBER;
    WS_PENDING      NUMBER;
    WS_STRING       VARCHAR2(4000);
    WS_COMMAND      VARCHAR2(4000);
	WS_ERROR_COUNT  NUMBER := 0;
	WS_ERROR        VARCHAR2(200);
	WS_ADDRESS      VARCHAR2(200);
	WS_USUARIO      VARCHAR2(80);

BEGIN

    WS_USUARIO := USER;

    

	

	
			WS_COUNT := 0;

			SELECT NVL((TRUNC(SYSDATE)-MIN(TRUNC(DT_REGISTRO))),0) INTO WS_PENDING
			FROM   PENDING_REGS
			WHERE  STATUS='P';

			IF  WS_PENDING > 30 THEN
				UPDATE OBJECT_LOCATION SET POSX='11px'   WHERE OWNER='DWU' AND
															NAVEGADOR='DEFAULT' AND
															OBJECT_ID='CONFIG';
				COMMIT;
			END IF;

			OPEN CRS_PENDINGS;
			    LOOP
				    FETCH CRS_PENDINGS INTO WS_PENDINGS;
					EXIT WHEN CRS_PENDINGS%NOTFOUND;

					BEGIN
						WS_STRING := UTL_HTTP.REQUEST(WS_PENDINGS.COMMAND);
						BEGIN
							UPDATE PENDING_REGS SET STATUS = 'K' WHERE ROWID=WS_PENDINGS.ID_LINHA;
							COMMIT;
							WS_COUNT := WS_COUNT+1;
						EXCEPTION
							WHEN OTHERS THEN
								INSERT INTO LOG_EVENTOS VALUES(SYSDATE, '[RO]-FALHA UNSET PENDING!', WS_USUARIO, 'REG_OFF', 'OFF', '01');
						END;
					EXCEPTION
						WHEN OTHERS THEN
							INSERT INTO LOG_EVENTOS VALUES(SYSDATE, '[RO]-FALHA UNSET PENDING!', WS_USUARIO, 'REG_OFF', 'OFF', '01');
					END;
			    END LOOP;
			CLOSE CRS_PENDINGS;

			IF  WS_COUNT > 0 THEN
				INSERT INTO LOG_EVENTOS VALUES(SYSDATE, '[RO]-OFFLINE REGS['||WS_COUNT||']!', WS_USUARIO, 'REG_OFF', 'OFF', '01');
			END IF;

			IF  PRM_TIPO='001' THEN
				BEGIN
					WS_COMMAND := 'http://'||FUN.RET_VAR('DOMINIO_REG')||'/update/dwu.renew?prm_par=TIPO|001|CLIENTE|'||FUN.RET_VAR('CLIENTE')||'|DATA|'||TO_CHAR(SYSDATE,'ddmmyyhh24mi')||'|EVENTO|'||PRM_EVENTO||'|STATUS|'||PRM_STATUS;
					BEGIN
						WS_STRING  := UTL_HTTP.REQUEST(WS_COMMAND);
					EXCEPTION
						WHEN OTHERS THEN
							INSERT INTO PENDING_REGS VALUES (SYSDATE,WS_COMMAND,'P');
							COMMIT;
					END;
				END;
			END IF;

			IF PRM_TIPO='002' THEN
				BEGIN
					WS_COMMAND := 'http://'||FUN.RET_VAR('DOMINIO_REG')||'/update/dwu.renew?prm_par=TIPO|002|CLIENTE|'||FUN.RET_VAR('CLIENTE')||'|DATA|'||TO_CHAR(TRUNC(SYSDATE-1),'ddmmyyhh24mi')||'|USUARIO|'||PRM_USUARIO||'|ACESSOS|'||PRM_STATUS;
					BEGIN
						WS_STRING  := UTL_HTTP.REQUEST(WS_COMMAND);
					EXCEPTION
						WHEN OTHERS THEN
							INSERT INTO PENDING_REGS VALUES (SYSDATE,WS_COMMAND,'P');
							COMMIT;
					END;
				END;
			END IF;

			IF PRM_TIPO='003' THEN
				BEGIN
					WS_COMMAND := 'http://'||FUN.RET_VAR('DOMINIO_REG')||'/update/dwu.renew?prm_par=TIPO|003|CLIENTE|'||FUN.RET_VAR('CLIENTE')||'|DATA|'||TO_CHAR(SYSDATE,'ddmmyyhh24mi')||'|EVENTO|'||PRM_EVENTO||'|STATUS|'||PRM_STATUS;
					BEGIN
						WS_STRING := UTL_HTTP.REQUEST(WS_COMMAND);
					EXCEPTION
						WHEN OTHERS THEN
							INSERT INTO PENDING_REGS VALUES (SYSDATE,WS_COMMAND,'P');
							COMMIT;
					END;
					IF TRIM(WS_STRING)='LOCK_SYS' THEN
						UPDATE OBJECT_LOCATION SET POSX='11px' WHERE OWNER='DWU' AND
							NAVEGADOR='DEFAULT' AND OBJECT_ID='CONFIG';
						COMMIT;
					END IF;
					IF TRIM(WS_STRING)='UNLOCK_SYS' THEN
						UPDATE OBJECT_LOCATION SET POSX='12px' WHERE OWNER='DWU' AND
						NAVEGADOR='DEFAULT' AND
						OBJECT_ID='CONFIG';
						COMMIT;
					END IF;
				END;
			END IF;

			IF  PRM_TIPO='004' THEN
				BEGIN
					WS_COMMAND := 'http://'||FUN.RET_VAR('DOMINIO_REG')||'/update/dwu.renew?prm_par=TIPO|004|CLIENTE|'||FUN.RET_VAR('CLIENTE')||'|DATA|'||TO_CHAR(SYSDATE,'ddmmyyhh24mi')||'|DS_EVENTO|'||PRM_EVENTO||'|STATUS|'||PRM_STATUS;
					BEGIN
						WS_STRING  := UTL_HTTP.REQUEST(WS_COMMAND);
					EXCEPTION
						WHEN OTHERS THEN
							INSERT INTO PENDING_REGS VALUES (SYSDATE,WS_COMMAND,'P');
							COMMIT;
					END;
				END;
			END IF;

			IF  PRM_TIPO='005' THEN
				BEGIN
					WS_COMMAND := 'http://'||FUN.RET_VAR('DOMINIO_REG')||'/update/dwu.renew?prm_par=TIPO|005|CLIENTE|'||FUN.RET_VAR('CLIENTE')||'|DATA|'||TO_CHAR(TRUNC(SYSDATE-1),'ddmmyyhh24mi')||'|USUARIO|'||PRM_USUARIO||'|ACESSOS|'||PRM_STATUS||'|QTDE|'||PRM_QTDE;
					BEGIN
						WS_STRING  := UTL_HTTP.REQUEST(WS_COMMAND);
					EXCEPTION
						WHEN OTHERS THEN
							INSERT INTO PENDING_REGS VALUES (SYSDATE,WS_COMMAND,'P');
							COMMIT;
					END;
				END;
			END IF;

			WS_STRING := TRIM(REPLACE(WS_STRING,CHR(10),''));

			IF  WS_STRING NOT IN ('OK REGISTRADO','UNLOCK_SYS','LOCK_SYS') THEN
				
				INSERT INTO LOG_EVENTOS VALUES(SYSDATE, '[RO]-FALHA REG.ONLINE SERVIDOR!', USER, 'REG_OFF', 'OFF', '01');
			END IF;

		
		
	
	

EXCEPTION WHEN OTHERS THEN
    
    INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - REG_ONLINE', WS_USUARIO, 'ERRO');
	UPDATE OBJECT_LOCATION SET POSX='11px' WHERE OWNER='DWU' AND NAVEGADOR='DEFAULT' AND OBJECT_ID='CONFIG';
    COMMIT;
END REG_ONLINE;

PROCEDURE STATUS_PROCESS ( PRM_CD_PROCESSO VARCHAR2,
                           PRM_DS_PROCESSO VARCHAR2,
                           PRM_COMANDO     VARCHAR2) AS

      WS_CHECK_RUN      NUMBER := 0;
      WS_SAIDA          VARCHAR2(40);

BEGIN

     SELECT COUNT(*) INTO WS_CHECK_RUN
     FROM   RUNNING_PROCESS
     WHERE  CD_PROCESSO = PRM_CD_PROCESSO AND
            LAST_STATUS = 'RUNNING';

     IF  PRM_COMANDO = 'START' THEN
         IF  WS_CHECK_RUN>0 THEN
             WS_SAIDA := 'RUNNING';
         ELSE
             INSERT INTO RUNNING_PROCESS VALUES (PRM_CD_PROCESSO,PRM_DS_PROCESSO,SYSDATE,NULL,'RUNNING');
             COMMIT;
             FCL.REG_ONLINE('004',PRM_DS_PROCESSO,PRM_COMANDO);
             WS_SAIDA := 'OK';
         END IF;
     ELSE
         IF  PRM_COMANDO = 'ERRO' THEN
             IF  WS_CHECK_RUN=0 THEN
                 WS_SAIDA := 'NO_SENSE';
             ELSE
                 UPDATE RUNNING_PROCESS SET DT_FINAL    = SYSDATE,
                                            LAST_STATUS = 'ERRO'
                 WHERE  CD_PROCESSO = PRM_CD_PROCESSO AND
                        LAST_STATUS = 'RUNNING';
                 COMMIT;
                 FCL.REG_ONLINE('004',PRM_DS_PROCESSO,PRM_COMANDO);
                 WS_SAIDA := 'OK';
             END IF;
         ELSE
             IF  WS_CHECK_RUN=0 THEN
                 WS_SAIDA := 'NO_SENSE';
             ELSE
                 UPDATE RUNNING_PROCESS SET DT_FINAL    = SYSDATE,
                                            LAST_STATUS = 'END'
                 WHERE  CD_PROCESSO = PRM_CD_PROCESSO AND
                        LAST_STATUS = 'RUNNING';
                 COMMIT;
                 FCL.REG_ONLINE('004',PRM_DS_PROCESSO,PRM_COMANDO);
                 WS_SAIDA := 'OK';
             END IF;
         END IF;
     END IF;

END STATUS_PROCESS;


PROCEDURE MASK ( PRM_ORDER VARCHAR2 DEFAULT '1',
                 PRM_DIR   VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_MASKS IS
	SELECT CD_MASCARA, DS_MASCARA FROM
    MASCARAS ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_MASCARA, '2', DS_MASCARA, CD_MASCARA) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_MASCARA, '2', DS_MASCARA, CD_MASCARA) END DESC;

	WS_MASK CRS_MASKS%ROWTYPE;
	WS_DIR     NUMBER := 1;
	WS_PADRAO  VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO VARCHAR2(80);
	WS_ADMIN   VARCHAR2(20);

	WS_NOACCESS EXCEPTION;

BEGIN

	WS_ADMIN   := GBL.GETNIVEL;
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' OR WS_ADMIN <> 'A' THEN
		RAISE WS_NOACCESS;
	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    
	HTP.P('<table class="linha">');
		HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th style="width: 20%"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''mask'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME')||'</a></th>');
				HTP.P('<th style="width: calc(80% - 22px);"><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''mask'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('VALOR')||'</a></th>');
				HTP.P('<th style="width: 22px;"></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		IF TO_NUMBER(PRM_DIR) = 1 THEN
			    WS_DIR := 2;
			END IF;

		HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
			OPEN CRS_MASKS;
				LOOP
					FETCH CRS_MASKS INTO WS_MASK;
					EXIT WHEN CRS_MASKS%NOTFOUND;
					HTP.P('<tr id="'||WS_MASK.CD_MASCARA||'-row">');
						HTP.P('<td style="width: 20%"><span id="'||WS_MASK.CD_MASCARA||'_id" title="'||FUN.UTRANSLATE('CD_MASCARA', 'MASCARAS', WS_MASK.CD_MASCARA, WS_PADRAO)||'">'||FUN.UTRANSLATE('CD_MASCARA', 'MASCARAS', WS_MASK.CD_MASCARA, WS_PADRAO)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||WS_MASK.CD_MASCARA||'_id'', ''MASCARAS|CD_MASCARA|'||WS_MASK.CD_MASCARA||''', ''cd'');">L</a></td>');
						
						HTP.P('<td style="width: calc(80% - 22px);"><input type="text" data-default="'||WS_MASK.DS_MASCARA||'" value="'||WS_MASK.DS_MASCARA||'" onblur="if(this.getAttribute(''data-default'') != this.value){ var celula = this;  call(''edit_mask'', ''prm_mask=''+encodeURIComponent('''||WS_MASK.CD_MASCARA||''')+''&prm_valor=''+encodeURIComponent(celula.value)).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ celula.setAttribute(''data-default'', celula.value); alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); }" /></td>');
						HTP.P('<td>');
							FCL.BUTTON_LIXO('dl_mask','prm_mask', WS_MASK.CD_MASCARA);
						HTP.P('</td>');
						
					HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_MASKS;
		HTP.P('</tbody>');
	HTP.P('</table>');
EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END MASK;


PROCEDURE DL_MASK ( PRM_MASK VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
	WS_FAIL  EXCEPTION;  

BEGIN
    
	
	DELETE FROM MASCARAS WHERE CD_MASCARA = TRIM(PRM_MASK);
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
		COMMIT;
		
		DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = 'MASCARAS' AND CD_COLUNA = 'CD_MASCARAS' AND LANG_DEFAULT = PRM_MASK;
		DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = 'MASCARAS' AND LANG_DEFAULT = PRM_MASK;
		COMMIT;
	ELSE
	    RAISE WS_FAIL;
	END IF;
	
EXCEPTION 
    WHEN WS_FAIL THEN
        HTP.P('FAIL');
    WHEN OTHERS THEN	
        HTP.P('FAIL');
END DL_MASK;


PROCEDURE EDIT_MASK ( PRM_MASK  VARCHAR2 DEFAULT NULL,
                      PRM_VALOR VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT    NUMBER;
	WS_FAIL     EXCEPTION;
    WS_CONVERTE VARCHAR2(800);
BEGIN

    

	WS_CONVERTE := FUN.CONVERTE(PRM_VALOR);
	
	UPDATE MASCARAS
	SET DS_MASCARA = TRIM(WS_CONVERTE)
	WHERE CD_MASCARA = PRM_MASK;
	
	WS_COUNT := SQL%ROWCOUNT;

	IF WS_COUNT <> 0 THEN
		COMMIT;
	ELSE
		RAISE WS_FAIL;
	END IF;

EXCEPTION
    WHEN WS_FAIL THEN
	    ROLLBACK;
	    HTP.P('FAIL');
    WHEN OTHERS THEN
        HTP.P('FAIL');
END EDIT_MASK;

PROCEDURE LOAD_MASK ( PRM_MASK VARCHAR2 DEFAULT NULL,
					  PRM_DESC VARCHAR2 DEFAULT NULL) AS


	WS_COUNT         NUMBER;
	WS_FAIL          EXCEPTION;
	WS_DOUBLE        EXCEPTION;
    WS_CONVERTE      VARCHAR2(800);
	WS_CONVERTE_DESC VARCHAR2(800);

BEGIN

    

    WS_CONVERTE      := FUN.CONVERTE(PRM_MASK);
	WS_CONVERTE_DESC := FUN.CONVERTE(PRM_DESC);

	SELECT COUNT(*) INTO WS_COUNT FROM MASCARAS WHERE CD_MASCARA = UPPER(WS_CONVERTE);

	IF WS_COUNT = 0 THEN
	    INSERT INTO MASCARAS VALUES(UPPER(WS_CONVERTE), UPPER(WS_CONVERTE_DESC));
		
		WS_COUNT := SQL%ROWCOUNT;
		
		IF WS_COUNT <> 0 THEN
			COMMIT;
			
			INSERT INTO TRADUCAO_COLUNAS VALUES('MASCARAS', 'CD_MASCARA', FUN.RET_VAR('LANG_SYS'), UPPER(WS_CONVERTE), UPPER(WS_CONVERTE), 'T', 'N');
			COMMIT;
		ELSE
			RAISE WS_FAIL;
		END IF;
		
	ELSE
		RAISE WS_DOUBLE;
	END IF;
EXCEPTION
    WHEN WS_DOUBLE THEN
	    HTP.P('DOUBLE');
    WHEN WS_FAIL THEN
	    HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END LOAD_MASK;











































































PROCEDURE LOAD_GOTO ( PRM_GRAFICO VARCHAR2 DEFAULT NULL,
					  PRM_DRILL   VARCHAR2 DEFAULT NULL) AS

	WS_COUNT NUMBER;
	WS_DESC  VARCHAR2(400);
	WS_VISAO VARCHAR2(400);
	WS_TIPO  VARCHAR2(400);
	WS_FAIL  EXCEPTION;

BEGIN
    

	IF FUN.CHECK_ADMIN('DRILLS_ADD') THEN
        



		INSERT INTO GOTO_OBJETO (CD_USUARIO, CD_OBJETO, CD_OBJETO_GO)
		SELECT 'DWU', UPPER(PRM_GRAFICO), UPPER(COLUMN_VALUE) FROM TABLE(FUN.VPIPE(PRM_DRILL));	

		WS_COUNT := SQL%ROWCOUNT;
		
		IF WS_COUNT <> 0 THEN
		    COMMIT;
		ELSE
		    RAISE WS_FAIL;
		END IF;
			
	ELSE
	    HTP.P('#alert Sem permiss&atilde;o!');
	END IF;

EXCEPTION 
    WHEN WS_FAIL THEN
        HTP.P('FAIL');
    WHEN OTHERS THEN
        HTP.P('FAIL');
END LOAD_GOTO;

PROCEDURE DL_GOTO ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                    PRM_DRILL   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
	WS_FAIL  EXCEPTION;

BEGIN
    

	IF FUN.CHECK_ADMIN('DRILLS_EX') THEN

		

		
		DELETE FROM GOTO_OBJETO WHERE CD_OBJETO = TRIM(PRM_OBJETO) AND CD_OBJETO_GO = TRIM(PRM_DRILL);
		
		WS_COUNT := SQL%ROWCOUNT;
		
		IF WS_COUNT <> 0 THEN
		    COMMIT;
		ELSE
		    RAISE WS_FAIL;
		END IF;
		
		
		
		
		
	ELSE
	    HTP.P('#alert '||FUN.LANG('Sem permiss&atilde;o')||'!');
	END IF;
 EXCEPTION
 	WHEN WS_FAIL THEN
    	HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END DL_GOTO;


PROCEDURE LOAD_DRILL ( PRM_OBJETO     VARCHAR2 DEFAULT NULL,
                       PRM_PARAMETROS VARCHAR2 DEFAULT NULL,
                       PRM_TRACK      VARCHAR2 DEFAULT NULL,
                       PRM_OBJETON    VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_DRILLS(PRM_USUARIO VARCHAR2) IS
    SELECT CD_OBJETO_GO, (SELECT TP_OBJETO FROM OBJETOS WHERE OBJETOS.CD_OBJETO = GOTO_OBJETO.CD_OBJETO_GO) AS TIPO, (SELECT NM_OBJETO FROM OBJETOS WHERE GOTO_OBJETO.CD_OBJETO_GO = OBJETOS.CD_OBJETO) AS NM_OBJETO
	FROM GOTO_OBJETO
	WHERE CD_OBJETO = REPLACE(PRM_OBJETO, 'trl', '') AND
	CD_OBJETO_GO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = PRM_USUARIO )
	ORDER BY TIPO, NM_OBJETO;

	WS_DRILL CRS_DRILLS%ROWTYPE;
	WS_TIPO    VARCHAR2(40) := 'N/A';
	WS_PADRAO  VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO VARCHAR2(80);

	WS_NOUSER  EXCEPTION;

BEGIN
    
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	HTP.P('<ul><li>');
		HTP.P('<select title="'||PRM_PARAMETROS||'" onchange="callDrill(this, this.title);">');
			HTP.P('<option value="" hidden disabled selected>'||FUN.LANG('ABRIR')||':</option>');

			BEGIN
				OPEN CRS_DRILLS(WS_USUARIO);
					LOOP
						FETCH CRS_DRILLS INTO WS_DRILL;
						EXIT WHEN CRS_DRILLS%NOTFOUND;
						
						IF WS_DRILL.TIPO <> WS_TIPO THEN
							HTP.P('<optgroup label="'||WS_DRILL.TIPO||'">'||WS_DRILL.TIPO||'</optgroup>');
							WS_TIPO := WS_DRILL.TIPO;
						END IF;
						
						HTP.P('<option value="'||WS_DRILL.CD_OBJETO_GO||'">'||FUN.UTRANSLATE('NM_OBJETO', WS_DRILL.CD_OBJETO_GO, WS_DRILL.NM_OBJETO, WS_PADRAO)||'</option>');
					END LOOP;
				CLOSE CRS_DRILLS;
			EXCEPTION WHEN OTHERS THEN
				HTP.P(SQLERRM);
			END;
		HTP.P('</select>');
	HTP.P('</li></ul>');
	HTP.P('<a class="fechartab" style="text-align: center;" onclick="remover(''jumpdrill'');">'||FUN.LANG('FECHAR')||'</td>');
EXCEPTION
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LOAD_DRILL;


PROCEDURE EX_OBJ( PRM_OBJETO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
	WS_FAIL  EXCEPTION;
	
BEGIN

    
    
	DELETE FROM OBJETOS WHERE CD_OBJETO = TRIM(PRM_OBJETO);
	
	WS_COUNT := SQL%ROWCOUNT;
		
	IF WS_COUNT <> 0 THEN
		
		COMMIT;
		
		DELETE FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(PRM_OBJETO);
	    DELETE FROM PONTO_AVALIACAO WHERE CD_PONTO = TRIM(PRM_OBJETO);
	    DELETE FROM FILTROS WHERE CD_OBJETO = TRIM(PRM_OBJETO) AND TP_FILTRO = 'objeto';
	    COMMIT;
		
	ELSE
		RAISE WS_FAIL;
	END IF;
    
EXCEPTION 
    WHEN WS_FAIL THEN
        HTP.P('FAIL');
    WHEN OTHERS THEN
        HTP.P('FAIL');	
END EX_OBJ;


PROCEDURE LIST_VCONTEUDO ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
                           PRM_TODO    VARCHAR2 DEFAULT 'S' ) AS

    CURSOR CRS_CONTEUDO(PRM_ADMIN VARCHAR2, PRM_USU VARCHAR2) IS
	SELECT VARIAVEL, CONTEUDO, LOCKED, USUARIO 
	FROM VAR_CONTEUDO 
	WHERE ( (USUARIO = PRM_USUARIO OR ((PRM_ADMIN = 'A' AND USUARIO = NVL(PRM_USUARIO, 'DWU') OR (PRM_ADMIN <> 'A' AND USUARIO = PRM_USU)) ) ) OR
	        USUARIO IN (SELECT CD_USUARIO FROM GUSERS_ITENS WHERE CD_GROUP = PRM_USUARIO AND CD_USUARIO = PRM_USUARIO)
	      ) 
	  and nvl(var_conteudo.locked,'X') <> 'O' 	 	 
	ORDER BY VARIAVEL ASC;

	WS_CONTEUDO CRS_CONTEUDO%ROWTYPE;

	






	WS_USUARIO_NOME VARCHAR2(80);
	WS_USUARIO      VARCHAR2(80);
	WS_ADMIN        VARCHAR2(80);
	WS_COUNT        NUMBER := 0;

	WS_NOUSER       EXCEPTION;

BEGIN
    

	WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;
	
	IF PRM_TODO = 'S' THEN
	
	    HTP.P('<div class="itens" data-save="false" style="width: 346px;">');
	    HTP.P('<h2 class="fixed">'||FUN.LANG('CONFIGURA&Ccedil;&Otilde;ES')||'</h2>');
		IF WS_ADMIN = 'A' THEN
			HTP.P('<ul class="conf">');
				HTP.P('<li>');
				    HTP.P('<a class="script" onclick="call(''list_vconteudo'', ''prm_usuario=''+this.nextElementSibling.title+''&prm_todo=N'').then(function(inside){ document.getElementById(''conf_ajax'').innerHTML = inside; });"></a>');
					FCL.FAKEOPTION('filtro-usuario', FUN.LANG('Usu&aacute;rio'), '', 'lista-usuarios-grupos', 'N', 'N');
				HTP.P('</li>');
				HTP.P('<li>');
					HTP.P('<input id="valor" type="text" placeholder="'||FUN.LANG('Nome do valor')||'" value="" class="up" style="float: right;"/>');
                HTP.P('</li>');
				HTP.P('<li>');	
					HTP.P('<select id="locked" style="float: right;">');
                        HTP.P('<option value="S" selected disabled>'||FUN.LANG('REMOV&Iacute;VEL')||'</option>');
                        HTP.P('<option value="N">'||FUN.LANG('N&Atilde;O')||'</option>');
                        HTP.P('<option value="X">'||FUN.LANG('N&Atilde;O e N&Atilde;O EDITAVEL')||'</option>');
                        HTP.P('<option value="S">'||FUN.LANG('SIM')||'</option>');
                    HTP.P('</select>');
				HTP.P('</li>');
			HTP.P('</ul>');

			HTP.P('<a class="addpurple block" onclick="addVarconteudo();">'||FUN.LANG('ADICIONAR')||'</a>');

		END IF;
		HTP.P('<ul class="form" id="conf_ajax" style="max-height: calc(100% - 236px);">');

	END IF;

		OPEN CRS_CONTEUDO(WS_ADMIN, WS_USUARIO);
			LOOP
				FETCH CRS_CONTEUDO INTO WS_CONTEUDO;
			    EXIT WHEN CRS_CONTEUDO%NOTFOUND;
				    WS_COUNT := WS_COUNT+1;
					HTP.P('<li title="'||WS_CONTEUDO.VARIAVEL||'" data-usuario="'||WS_CONTEUDO.USUARIO||'" data-default="'||WS_CONTEUDO.CONTEUDO||'">');
						HTP.P('<span class="before">'||WS_CONTEUDO.VARIAVEL||'</span>');
						HTP.P('<span class="after">');
							IF WS_CONTEUDO.LOCKED = 'X' THEN
								HTP.P('<input class="readonly" type="text" value="'||WS_CONTEUDO.CONTEUDO||'" readonly />');
							ELSE
								HTP.P('<input class="vsis-input" type="text" value="'||WS_CONTEUDO.CONTEUDO||'" />');
							END IF;
						HTP.P('</span>');

						IF WS_ADMIN = 'A' THEN
							IF WS_CONTEUDO.LOCKED <> 'N' AND WS_CONTEUDO.LOCKED <> 'X' THEN 
								FCL.BUTTON_LIXO('dl_vconteudo','prm_variavel|prm_usuario', WS_CONTEUDO.VARIAVEL||'|'||WS_CONTEUDO.USUARIO);
								
							ELSE 
								HTP.P('<a class="noremove" onclick="alerta(''msg'', '''||FUN.LANG('Valor n&atilde;o pode ser excluido')||''');" title="'||FUN.LANG('Valor n&atilde;o pode ser excluido')||'">X</a>');
							END IF;
						END IF;

					HTP.P('</li>');
			END LOOP;
		CLOSE CRS_CONTEUDO;

		IF WS_COUNT = 0 THEN
            HTP.P('<li><h2>'||FUN.LANG('NENHUMA VARI&Aacute;VEL')||'</h2></li>');
		END IF;

    IF PRM_TODO = 'S' THEN
		    HTP.P('</ul>');
	    HTP.P('</div>');

	    FCL.CLOSER_MENU;
	END IF;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LIST_VCONTEUDO;

PROCEDURE EDIT_VCONTEUDO( PRM_VARIAVEL VARCHAR2 DEFAULT NULL,
                          PRM_CONTEUDO VARCHAR2 DEFAULT NULL,
						  PRM_USUARIO  VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT    NUMBER;
    WS_CONVERTE VARCHAR2(800);
	WS_VARIAVEL VARCHAR2(800);

BEGIN

    WS_CONVERTE := FUN.CONVERTE(PRM_CONTEUDO);
	WS_VARIAVEL := FUN.CONVERTE(PRM_VARIAVEL);

    SELECT COUNT(*) INTO WS_COUNT FROM VAR_CONTEUDO WHERE VARIAVEL = UPPER(TRIM(WS_VARIAVEL)) AND USUARIO = PRM_USUARIO;

    IF WS_COUNT = 1 THEN
	    UPDATE VAR_CONTEUDO
	    SET CONTEUDO = WS_CONVERTE,
		DATA = SYSDATE
	    WHERE VARIAVEL = UPPER(TRIM(WS_VARIAVEL)) AND USUARIO = PRM_USUARIO;
	ELSIF WS_COUNT = 0 THEN
	    HTP.P('#alert '||FUN.LANG('Valor inexistente no banco')||'!');
	ELSE
	    HTP.P('#alert '||FUN.LANG('Impossivel alterar, valor duplicado')||'!');
	END IF;

EXCEPTION WHEN OTHERS THEN
	HTP.P('#alert '||FUN.LANG('Erro ao atualizar o valor')||'!');
END EDIT_VCONTEUDO;

PROCEDURE ADD_VCONTEUDO ( PRM_VARIAVEL VARCHAR2 DEFAULT NULL,
	                      PRM_USUARIO  VARCHAR2 DEFAULT 'DWU',
                          PRM_LOCK     VARCHAR2 DEFAULT 'N' ) AS

    WS_COUNT    NUMBER;
    WS_CONVERTE VARCHAR2(800);
BEGIN
    
	

	WS_CONVERTE := FUN.CONVERTE(PRM_VARIAVEL);

    
    SELECT COUNT(*) INTO WS_COUNT FROM GUSERS_ITENS WHERE CD_GROUP = PRM_USUARIO;

	IF WS_COUNT <> 0 THEN

	    FOR I IN(SELECT CD_USUARIO FROM GUSERS_ITENS WHERE CD_GROUP = PRM_USUARIO AND CD_USUARIO NOT IN (SELECT USUARIO FROM VAR_CONTEUDO WHERE VARIAVEL = UPPER(TRIM(WS_CONVERTE)) ) ) LOOP
            INSERT INTO VAR_CONTEUDO VALUES(I.CD_USUARIO, UPPER(TRIM(WS_CONVERTE)), SYSDATE, '', PRM_LOCK);
		END LOOP;

		WS_COUNT := SQL%ROWCOUNT;
		IF WS_COUNT <> 0 THEN
			HTP.P('OK');
			COMMIT;
		END IF;

	ELSE

		SELECT COUNT(*) INTO WS_COUNT FROM VAR_CONTEUDO WHERE VARIAVEL = UPPER(TRIM(WS_CONVERTE)) AND USUARIO = PRM_USUARIO;
		IF WS_COUNT = 0 THEN
			INSERT INTO VAR_CONTEUDO VALUES(PRM_USUARIO, UPPER(TRIM(WS_CONVERTE)), SYSDATE, '', PRM_LOCK);
			
			WS_COUNT := SQL%ROWCOUNT;
			IF WS_COUNT = 1 THEN
				HTP.P('OK');
				COMMIT;
			END IF;
		ELSIF WS_COUNT = 1 THEN
			HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel inserir, valor j&aacute; existe')||'!');
		ELSE
			HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel inserir, valor duplicado')||'!');
		END IF;
	END IF;

EXCEPTION WHEN OTHERS THEN
	HTP.P('#alert '||FUN.LANG('Erro ao adicionar o novo valor')||'!');
END ADD_VCONTEUDO;

PROCEDURE DL_VCONTEUDO ( PRM_VARIAVEL VARCHAR2 DEFAULT NULL,
                         PRM_USUARIO  VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT     NUMBER;
    WS_CONVERTE  VARCHAR2(800);
BEGIN

    

    WS_CONVERTE := FUN.CONVERTE(PRM_VARIAVEL);

	SELECT COUNT(*) INTO WS_COUNT FROM VAR_CONTEUDO WHERE VARIAVEL = UPPER(TRIM(WS_CONVERTE)) AND USUARIO = PRM_USUARIO;
	IF WS_COUNT > 0 THEN
	    
		DELETE FROM VAR_CONTEUDO WHERE VARIAVEL = UPPER(TRIM(WS_CONVERTE)) AND USUARIO = PRM_USUARIO;
        
		WS_COUNT := SQL%ROWCOUNT;
		
		IF WS_COUNT <> 0 THEN
		    HTP.P('OK');
			COMMIT;
		END IF;
		
	ELSE
	    HTP.P('#alert '||FUN.LANG('Imposs&iacute;vel excluir, valor inexistente')||'!');
	END IF;

    EXCEPTION WHEN OTHERS THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir o valor')||'!');
END DL_VCONTEUDO;


PROCEDURE ALTER_VALUE( PRM_OBJECT VARCHAR2 DEFAULT 'DEFAULT',
                       PRM_PROP   VARCHAR2 DEFAULT NULL,
                       PRM_VALOR1 VARCHAR2 DEFAULT NULL,
					   PRM_VALOR2 VARCHAR2 DEFAULT NULL,
					   PRM_SCREEN VARCHAR2 DEFAULT 'DEFAULT' ) AS

    WS_COUNT   NUMBER;
	WS_VALOR   VARCHAR2(4000);
	WS_USUARIO VARCHAR2(80);

	WS_NOUSER  EXCEPTION;

BEGIN
    WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

    
	IF PRM_VALOR1 = PRM_VALOR2 THEN
	    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_OBJECT AND OWNER = WS_USUARIO AND CD_PROP = PRM_PROP AND SCREEN = PRM_SCREEN;
	    IF WS_COUNT = 1 THEN
		    UPDATE OBJECT_ATTRIB
		    SET PROPRIEDADE = PRM_VALOR1
		    WHERE OWNER = WS_USUARIO AND
		    CD_PROP = PRM_PROP AND
			CD_OBJECT = PRM_OBJECT;
		ELSIF WS_COUNT = 0 THEN
		    INSERT INTO OBJECT_ATTRIB VALUES(WS_USUARIO, 'DEFAULT', PRM_SCREEN, PRM_OBJECT, PRM_PROP, PRM_VALOR1);
		END IF;
	ELSE
	    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_OBJECT AND OWNER = WS_USUARIO AND CD_PROP = PRM_PROP AND SCREEN = PRM_SCREEN;
		IF WS_COUNT = 1 THEN
			SELECT PROPRIEDADE INTO WS_VALOR FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_OBJECT AND OWNER = WS_USUARIO AND CD_PROP = PRM_PROP AND SCREEN = PRM_SCREEN;
			IF WS_VALOR = PRM_VALOR1 THEN
				UPDATE OBJECT_ATTRIB
				SET PROPRIEDADE = PRM_VALOR2
				WHERE OWNER = WS_USUARIO AND
				CD_PROP = PRM_PROP;
			ELSE
				UPDATE OBJECT_ATTRIB
				SET PROPRIEDADE = PRM_VALOR1
				WHERE OWNER = WS_USUARIO AND
				CD_PROP = PRM_PROP;
			END IF;
		ELSIF WS_COUNT = 0 THEN
		    INSERT INTO OBJECT_ATTRIB VALUES(WS_USUARIO, 'DEFAULT', 'DEFAULT', 'DEFAULT', 'DRILL', PRM_VALOR1);
		END IF;
	END IF;

EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(FUN.LANG('Erro ao realizar a altera&ccedil;&atilde;o')||'!'||USER);
END ALTER_VALUE;

PROCEDURE LIST_CALCULADA ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                           PRM_VISAO  VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_LINHAS IS
	SELECT CD_COLUNA, CD_COLUNA_SHOW, DS_COLUNA_SHOW, DS_FORMULA FROM LINHA_CALCULADA WHERE CD_OBJETO = PRM_OBJETO;

    WS_LINHA CRS_LINHAS%ROWTYPE;

	WS_ROTULO VARCHAR2(40);
	WS_AGRUPADOR VARCHAR2(40);
	WS_SELECTED VARCHAR2(40);

	WS_COUNT NUMBER;
	WS_COUNTS NUMBER;
BEGIN

    HTP.P('<table class="linha">');
		HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th>'||FUN.LANG('COLUNA')||'</th>');
				HTP.P('<th>ID</th>');
				HTP.P('<th>'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th>'||FUN.LANG('F&Oacute;RMULA')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax">');
			OPEN CRS_LINHAS;
				LOOP
					FETCH CRS_LINHAS INTO WS_LINHA;
					EXIT WHEN CRS_LINHAS%NOTFOUND;
					HTP.P('<tr>');
						HTP.P('<td>'||WS_LINHA.CD_COLUNA||'</td>');
						HTP.P('<td>'||WS_LINHA.CD_COLUNA_SHOW||'</td>');
						HTP.P('<td>'||WS_LINHA.DS_COLUNA_SHOW||'</td>');
						HTP.P('<td style="line-height: 16px;"><textarea id="'||WS_LINHA.CD_COLUNA_SHOW||'formula" placeholder="'||FUN.LANG('Digite a formula')||'" style="width: 600px; height: 20px; resize: vertical; padding: 2px; max-height: 100px;" onblur="if(this.value.trim().length > 0){ ajax(''fly'', ''create_linha'', ''prm_objeto='||PRM_OBJETO||'&prm_visao='||PRM_VISAO||'&prm_coluna='||WS_LINHA.CD_COLUNA||'&prm_show='||WS_LINHA.CD_COLUNA_SHOW||'&prm_desc='||WS_LINHA.CD_COLUNA_SHOW||'&prm_formula=''+encodeURIComponent(this.value), false); }">'||WS_LINHA.DS_FORMULA||'</textarea></td>');
						HTP.P('<td>');
							FCL.BUTTON_LIXO('dl_linha','prm_objeto|prm_visao|prm_coluna|prm_show', PRM_OBJETO||'|'||PRM_VISAO||'|'||WS_LINHA.CD_COLUNA||'|'||WS_LINHA.CD_COLUNA_SHOW);
						HTP.P('</td>');
						
					HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_LINHAS;
		HTP.P('</tbody>');
	HTP.P('</table>');
END LIST_CALCULADA;


PROCEDURE CREATE_LINHA( PRM_OBJETO  VARCHAR2 DEFAULT NULL,
                        PRM_VISAO   VARCHAR2 DEFAULT NULL,
                        PRM_COLUNA  VARCHAR2 DEFAULT NULL,
                        PRM_SHOW    VARCHAR2 DEFAULT NULL,
						PRM_DESC    VARCHAR2 DEFAULT NULL,
						PRM_FORMULA VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT   NUMBER;
    WS_CONVERT VARCHAR2(800);
	WS_ID      VARCHAR2(800);
	WS_FORMULA VARCHAR2(800);

BEGIN

    WS_CONVERT := FUN.CONVERTE(PRM_DESC);
    WS_ID      := FUN.CONVERTE(PRM_SHOW);
	WS_FORMULA := FUN.CONVERTE(PRM_FORMULA);

    SELECT COUNT(*) INTO WS_COUNT FROM LINHA_CALCULADA WHERE CD_OBJETO = TRIM(UPPER(PRM_OBJETO)) AND CD_MICRO_VISAO = TRIM(UPPER(PRM_VISAO)) AND CD_COLUNA = TRIM(UPPER(PRM_COLUNA)) AND CD_COLUNA_SHOW = TRIM(UPPER(WS_ID));
	IF WS_COUNT = 0 THEN
	    INSERT INTO LINHA_CALCULADA VALUES(TRIM(UPPER(PRM_OBJETO)), TRIM(UPPER(PRM_VISAO)), TRIM(UPPER(PRM_COLUNA)), TRIM(UPPER(WS_ID)), TRIM(WS_CONVERT), TRIM(WS_FORMULA));
	ELSE
		IF (NVL(TRIM(WS_FORMULA), 'N/A') <> 'N/A') THEN
		    UPDATE LINHA_CALCULADA SET DS_FORMULA = WS_FORMULA WHERE CD_OBJETO = TRIM(UPPER(PRM_OBJETO)) AND CD_MICRO_VISAO = TRIM(UPPER(PRM_VISAO)) AND CD_COLUNA_SHOW = UPPER(TRIM(WS_ID));
		    HTP.P('#alert '||FUN.LANG('Coluna alterada com sucesso')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Coluna j&aacute; existe')||'!');
		END IF;
	END IF;
EXCEPTION WHEN OTHERS THEN
    HTP.P('#alert '||FUN.LANG('Erro ao alterar a coluna')||'!');
END CREATE_LINHA;


PROCEDURE DL_LINHA ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                     PRM_VISAO  VARCHAR2 DEFAULT NULL,
					 PRM_COLUNA VARCHAR2 DEFAULT NULL,
					 PRM_SHOW   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
    WS_ID    VARCHAR2(800);
BEGIN

    WS_ID := FUN.CONVERTE(PRM_SHOW);

    SELECT COUNT(*) INTO WS_COUNT FROM LINHA_CALCULADA WHERE CD_OBJETO = TRIM(UPPER(PRM_OBJETO)) AND CD_MICRO_VISAO = TRIM(UPPER(PRM_VISAO)) AND CD_COLUNA = TRIM(UPPER(PRM_COLUNA)) AND CD_COLUNA_SHOW = TRIM(UPPER(WS_ID));

	IF WS_COUNT = 1 THEN
	    DELETE FROM LINHA_CALCULADA WHERE CD_OBJETO = TRIM(UPPER(PRM_OBJETO)) AND CD_MICRO_VISAO = TRIM(UPPER(PRM_VISAO)) AND CD_COLUNA = TRIM(UPPER(PRM_COLUNA)) AND CD_COLUNA_SHOW = TRIM(UPPER(WS_ID));
	    HTP.P('#alert '||FUN.LANG('Linha excluida com sucesso')||'');
	ELSIF WS_COUNT > 1 THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir, valor duplicado')||'!');
	ELSE
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir, valor inexistente')||'!');
	END IF;

END DL_LINHA;

PROCEDURE DRE AS

    CURSOR CRS_MAPS IS
	    SELECT CD_MAPA, DS_MAPA, CD_LIGACAO, DS_MASCARA, MASC_POINT, MASC_RIGHT, CD_MASC_COLUNA, CD_COLUNA_DEFF
	    FROM DEFINE_MAP;

	WS_MAP CRS_MAPS%ROWTYPE;

	CURSOR CRS_CDESC IS
		SELECT NDS_TABELA, NDS_OWNER, NDS_TFISICA, NDS_CD_EMPRESA, NDS_CD_CODIGO, NDS_CD_DESCRICAO
		FROM CODIGO_DESCRICAO ORDER BY NDS_TABELA;

	WS_CDESC	CRS_CDESC%ROWTYPE;

	CURSOR CRS_MASKS IS
	    SELECT CD_MASCARA, DS_MASCARA FROM
        MASCARAS ORDER BY CD_MASCARA ASC;

	WS_MASK CRS_MASKS%ROWTYPE;

BEGIN
	HTP.P('<div id="slidemenu" style="overflow: hidden; height: 50px; margin-bottom: 3px;">');
		HTP.P('<div id="dre-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			HTP.P('<a style="margin-bottom: 25px;" title="'||FUN.LANG('clique para criar dre')||'" class="add" onclick="mapa = document.getElementById(''cd_mapa'').value; if(mapa.length > 1){ fun.cdesc = document.getElementById(''cdesc'').getAttribute(''title''); if(cdesc.length > 1){ masc = document.getElementById(''masc'').getAttribute(''title''); if(masc != ''''){ point = document.getElementById(''point'').getAttribute(''title''); if(point != ''''){ right = document.getElementById(''right'').getAttribute(''title''); if(right != ''''){ ajax(''main'', ''new_dre'', ''prm_mapa=''+mapa+''&prm_dsmapa=''+document.getElementById(''ds_mapa'').value+''&prm_ligacao=&prm_dsmasc=''+cdesc+''&prm_point=''+point+''&prm_right=''+right+''&prm_masc_coluna=''+masc+''&prm_coluna_deff=''+document.getElementById(''coluna_deff'').value, false, ''ajax''); noerror('''', '''||FUN.LANG('DRE adicionado com sucesso')||'!'', ''msg''); } else { alerta(''msg'','''||FUN.LANG('Escolha uma valor de right')||'!''); } } else { alerta(''msg'','''||FUN.LANG('Escolha uma valor de point')||'!''); } } else { alerta(''msg'', '''||FUN.LANG('Escolha uma m&aacute;scara')||'!''); } } else { alerta(''msg'', '''||FUN.LANG('Escolha um valor')||'!''); } } else {  alerta(''msg'', '''||FUN.LANG('Campo cd_mapa precisa ser maior que 4')||'!''); }" >+</a>');

			HTP.P('<input id="cd_mapa" type="text" placeholder="cd_mapa" value="" style="display: inline; float: left; margin-right: 5px;" />');
			HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="cdesc" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=cdesc&prm_titulo=LOV&prm_campo=cdesc'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Escolha um valor')||'</span>');
			HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="masc" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=masc&prm_titulo=Mascara&prm_campo=masc'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Mascaras')||'</span>');

			HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="point" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=point&prm_titulo=Mascara Point&prm_campo=point'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Mascara Point')||'</span>');

			HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="right" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=right&prm_titulo=Mascara Right&prm_campo=point'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Mascara Right')||'</span>');
			HTP.P('<input id="ds_mapa" type="text" placeholder="ds_mapa" value="" />');
			HTP.P('<input id="coluna_deff" type="text" placeholder="cd_coluna_deff" value="" />');
		HTP.P('</div>');

		HTP.P('<div id="padrao-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			HTP.P('<a style="margin-bottom: 25px;" title="'||FUN.LANG('criar padr&atilde;o')||'" class="add" onclick="padrao = document.getElementById(''cd_padrao'').value; if(padrao.length > 1){ mapa = document.getElementById(''cd_mapa'').value; dspadrao = document.getElementById(''ds_padrao'').value; visao = document.getElementById(''micro-visao'').getAttribute(''title''); if(visao.length > 1){ ajax(''main'', ''new_padrao'', ''prm_mapa=''+mapa+''&prm_cdpadrao=''+padrao+''&prm_dspadrao=''+dspadrao+''&prm_visao=''+visao, false, ''padrao''); noerror('''', '''||FUN.LANG('Padr&atilde;o adicionado com sucesso')||'!'', ''msg''); } else { alerta(''msg'','''||FUN.LANG('Escolha uma view')||'!''); } } else { alerta(''msg'','''||FUN.LANG('Escolha o c&oacute;digo do padr&atilde;o')||'!''); }" >+</a>');
			HTP.P('<input id="cd_padrao" type="text" placeholder="cd_padrao" value="" style="display: inline; float: left; margin-right: 5px;" />');
			HTP.P('<input id="ds_padrao" type="text" placeholder="ds_padrao" value="" style="display: inline; float: left; margin-right: 5px;" />');
			HTP.P('<input id="cd_mapa" type="hidden" value="" />');
			HTP.P('<span class="fakeoption" title="" id="micro-visao" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=micro-visao&prm_titulo=MICRO VIS&Atilde;O&prm_campo=visao'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Escolha uma view')||'</span>');
		HTP.P('</div>');

		HTP.P('<div id="vazio-menu" style="display: inline; float: left; height: 50px; width: 100%; transition: margin 0.5s linear;"></div>');

		HTP.P('<div id="line-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			HTP.P('<a style="margin-bottom: 25px;" title="criar linha" class="add" onclick="defline = document.getElementById(''cd_defline'').value; if(defline.length > 1){ item = document.getElementById(''nr_item'').value; if(item.length > 0){ coluna = document.getElementById(''cd_coluna'').getAttribute(''title''); if(coluna.length > 1){ ajax(''main'', ''new_defline'', ''prm_mapa=''+document.getElementById(''cd_mapa'').value+''&prm_item=''+item+''&prm_padrao=''+document.getElementById(''padrao3'').value+''&prm_coluna=''+coluna+''&prm_defline=''+defline, false, ''line''); noerror('''', '''||FUN.LANG('Padr&atilde;o adicionado com sucesso')||'!'', ''msg''); ajax(''list'', ''dre_lines'', ''prm_map=''+document.getElementById(''cd_mapa'').value+''&prm_padrao=''+document.getElementById(''padrao3'').value, false, ''deff_lines''); } else { alerta(''msg'','''||FUN.LANG('Escolha uma coluna')||'!''); } } else { alerta(''msg'','''||FUN.LANG('Digite um numero de item!''); } } else {  alerta(''msg'',''Defline precisa ser maior que 4')||'!''); }" >+</a>');
			HTP.P('<input id="cd_defline" type="text" placeholder="cd_defline" value="" style="display: inline; float: left; margin-right: 5px;" />');
			HTP.P('<input id="nr_item" type="hidden" value=""/>');
			HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="cd_coluna" onclick="if(document.getElementById(''fakelist'').className == ''''){ visao = document.getElementById(''micro-visao'').getAttribute(''title''); ajax(''list'', ''fakelist'', ''prm_ident=cd_coluna&prm_titulo=COLUNA&prm_campo=coluna&prm_visao=''+visao, false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Escolha um valor')||'</span>');
		    HTP.P('<input id="padrao3" type="hidden" value="" />');
		HTP.P('</div>');

		HTP.P('<div id="filtro-menu" style="width: 100%; display: inline; float: left; transition: margin 0.5s linear; height: 50px;">');
			HTP.P('<a style="margin-bottom: 25px;" title="'||FUN.LANG('criar filtro')||'" class="add" onclick="coluna = document.getElementById(''cd_coluna_filtro'').getAttribute(''title''); condicao = document.getElementById(''condicao'').getAttribute(''title''); if(coluna.length > 1){ ajax(''main'', ''new_filtro'', ''prm_mapa=''+document.getElementById(''cd_mapa'').value+''&prm_padrao=''+document.getElementById(''padrao2'').value+''&prm_item=''+document.getElementById(''item'').value+''&prm_coluna=''+coluna+''&prm_condicao=''+condicao+''&prm_conteudo=''+document.getElementById(''conteudo'').value, false, ''filtro''); noerror('''', '''||FUN.LANG('Filtro adicionado com sucesso')||'!'', ''msg''); } else { alerta(''msg'','''||FUN.LANG('Escolha uma coluna')||'!''); }" >+</a>');

			HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="cd_coluna_filtro" onclick="if(document.getElementById(''fakelist'').className == ''''){ visao = document.getElementById(''micro-visao'').getAttribute(''title''); ajax(''list'', ''fakelist'', ''prm_ident=cd_coluna_filtro&prm_titulo=COLUNA&prm_campo=coluna&prm_visao=''+visao, false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.LANG('Escolha um valor')||'</span>'')');
		    HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="" id="'||FUN.LANG('condicao')||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=condicao&prm_titulo=CONDI&Ccedil;&Atilde;O&prm_campo=condicao'', false, ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">Escolha um valor</span>');
			HTP.P('<input id="conteudo" title="" placeholder="'||FUN.LANG('conteúdo')||'" type="text" value="" />');
			HTP.P('<input id="item" title="" placeholder="item" type="text" value="" />');
			HTP.P('<input id="padrao2" type="hidden" value="" />');
		HTP.P('</div>');
	HTP.P('</div>');

	HTP.P('<div class="slidebox">');
		HTP.P('<div id="dre" class="dre">');
			HTP.P('<h2>Lista de DRE</h2>');
			HTP.P('<table class="linha">');
				HTP.P('<tbody id="ajax">');
				    HTP.P('<tr>');
					    HTP.P('<th style="width: 30%;">'||FUN.LANG('C&oacute;digo')||'</th>');
					    HTP.P('<th style="width: 30%;">'||FUN.LANG('Descri&ccedil;&atilde;o')||'</th>');
					    HTP.P('<th style="width: 30%;">'||FUN.LANG('Deff_padr&atilde;o')||'</th>');
						HTP.P('<th style="width: 7%;"></th>');
						HTP.P('<th style="width: 3%;"></th>');
				    HTP.P('</tr>');
					OPEN CRS_MAPS;
						LOOP
							FETCH CRS_MAPS INTO WS_MAP;
							EXIT WHEN CRS_MAPS%NOTFOUND;
							HTP.P('<tr class="dashed">');
								HTP.P('<td style="width: 30%;">'||WS_MAP.CD_MAPA||'</td>');
								HTP.P('<td style="width: 30%;" id="dsmap-'||WS_MAP.CD_MAPA||'">'||WS_MAP.DS_MAPA||'</td>');
								HTP.P('<td style="width: 30%;"><a class="red" onclick="ajax(''list'', ''dre_padrao'', ''prm_map='||WS_MAP.CD_MAPA||''', ''false'', ''deff_padrao''); document.getElementById(''cd_mapa'').setAttribute(''value'', '''||WS_MAP.CD_MAPA||'''); document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML=''DEFF_PADR&Atilde;O'';">DEFF_PADRAO</a></td>');
							    HTP.P('<td style="width: 7%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML=''ALTERAR''; this.className='''';  ajax(''list'', ''dre_expand'', ''prm_mapa='||WS_MAP.CD_MAPA||''', false, '''||WS_MAP.CD_MAPA||'-expanded''); } else { this.style.color=''''; this.innerHTML='''||FUN.LANG('EDITAR')||'''; this.className=''red''; document.getElementById(''dsmap-'||WS_MAP.CD_MAPA||''').innerHTML = document.getElementById(''dsmapa-'||WS_MAP.CD_MAPA||''').value; ajax(''fly'', ''save_dre'', ''prm_mapa='||WS_MAP.CD_MAPA||'&prm_dsmapa=''+document.getElementById(''dsmapa-'||WS_MAP.CD_MAPA||''').value+''&prm_dsmasc=''+document.getElementById(''cdesc-'||WS_MAP.CD_MAPA||''').getAttribute(''title'')+''&prm_point=''+document.getElementById(''point-'||WS_MAP.CD_MAPA||''').getAttribute(''title'')+''&prm_right=''+document.getElementById(''right-'||WS_MAP.CD_MAPA||''').getAttribute(''title'')+''&prm_masc_coluna=''+document.getElementById(''masc-'||WS_MAP.CD_MAPA||''').getAttribute(''title''), false); document.getElementById('''||WS_MAP.CD_MAPA||'-expanded'').innerHTML = ''''; }" title="'||FUN.LANG('Editar/salvar op&ccedil;&otilde;es')||'">'||FUN.LANG('EDITAR')||'</a></td>');
							    FCL.BUTTON_LIXO('dl_dre','prm_mapa', WS_MAP.CD_MAPA);
								
							HTP.P('</tr>');
							HTP.P('<tr class="noborder"><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||WS_MAP.CD_MAPA||'-expanded"></td></tr>');
						END LOOP;
					CLOSE CRS_MAPS;
				HTP.P('</tbody>');
			HTP.P('</table>');
		HTP.P('</div>');
		HTP.P('<div id="deff_padrao" class="dre"></div>');
		HTP.P('<div id="deff_lines" class="dre"></div>');
		HTP.P('<div id="deff_line" class="dre"></div>');
	    HTP.P('<div id="deff_filtro" class="dre"></div>');

	HTP.P('</div>');
END DRE;

PROCEDURE DRE_EXPAND ( PRM_MAPA VARCHAR2 DEFAULT NULL ) AS

  WS_DSMAPA VARCHAR2(30);
  WS_MASCARA VARCHAR2(30);
  WS_POINT VARCHAR2(30);
  WS_RIGHT VARCHAR2(30);
  WS_COLUNA VARCHAR2(30);
  WS_COLUNA_MASC VARCHAR2(30);

BEGIN

    SELECT DS_MAPA, DS_MASCARA, MASC_POINT, MASC_RIGHT, CD_MASC_COLUNA, (SELECT CD_MASCARA FROM MASCARAS WHERE DS_MASCARA = CD_MASC_COLUNA AND ROWNUM = 1) AS MASCARA
	INTO WS_DSMAPA, WS_MASCARA, WS_POINT, WS_RIGHT, WS_COLUNA, WS_COLUNA_MASC
	FROM DEFINE_MAP
	WHERE CD_MAPA = PRM_MAPA;

	HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||WS_MASCARA||'" id="cdesc-'||PRM_MAPA||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=cdesc-'||PRM_MAPA||'&prm_titulo=LOV&prm_campo=cdesc'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||WS_MASCARA||'</span>');
    HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||WS_COLUNA||'" id="masc-'||PRM_MAPA||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=masc-'||PRM_MAPA||'&prm_titulo=Mascara&prm_campo=masc'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||WS_COLUNA_MASC||'</span>');
	HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||WS_POINT||'" id="point-'||PRM_MAPA||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=point-'||PRM_MAPA||'&prm_titulo=Mascara Point&prm_campo=point'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.EXT_MASC(WS_POINT)||'</span>');
    HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" class="fakeoption" title="'||WS_RIGHT||'" id="right-'||PRM_MAPA||'" onclick="if(document.getElementById(''fakelist'').className == ''''){ ajax(''list'', ''fakelist'', ''prm_ident=right-'||PRM_MAPA||'&prm_titulo=Mascara Right&prm_campo=point'', ''false'', ''fakelist''); } document.getElementById(''fakelist'').classList.toggle(''visible'');">'||FUN.EXT_MASC(WS_RIGHT)||'</span>');
    HTP.P('<input type="text" placeholder="ds_mapa" value="'||WS_DSMAPA||'" id="dsmapa-'||PRM_MAPA||'" style="display: inline; float: left; margin-right: 5px;" />');

END DRE_EXPAND;

PROCEDURE DRE_PADRAO ( PRM_MAP VARCHAR2 DEFAULT NULL ) AS

        CURSOR CRS_PADROES IS
	    SELECT CD_PADRAO, DS_PADRAO, CD_MICRO_VISAO
	    FROM DEFF_PADRAO WHERE CD_MAPA = PRM_MAP;

	    WS_PADRAO CRS_PADROES%ROWTYPE;

BEGIN
    HTP.P('<h2><a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||PRM_MAP||'</a> > <span style="font-size: 16px; font-weight: bold;">DEFF_PADRAO</span></h2>');
	HTP.P('<table class="linha">');
		HTP.P('<tbody id="padrao">');
		    HTP.P('<tr>');
				HTP.P('<th>'||FUN.LANG('Padr&atilde;o')||'</th>');
				HTP.P('<th>'||FUN.LANG('Descri&ccedil;&atilde;o')||'</th>');
				HTP.P('<th>'||FUN.LANG('Micro vis&atilde;o')||'</th>');
				HTP.P('<th>'||FUN.LANG('Linhas')||'</th>');
				HTP.P('<th>'||FUN.LANG('Filtros')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
			OPEN CRS_PADROES;
				LOOP
					FETCH CRS_PADROES INTO WS_PADRAO;
					EXIT WHEN CRS_PADROES%NOTFOUND;
					HTP.P('<tr class="dashed">');
						HTP.P('<td>'||WS_PADRAO.CD_PADRAO||'</td>');
						HTP.P('<td>'||WS_PADRAO.DS_PADRAO||'</td>');
						HTP.P('<td>'||WS_PADRAO.CD_MICRO_VISAO||'</td>');
						HTP.P('<td><a class="red" onclick="ajax(''list'', ''dre_lines'', ''prm_map='||PRM_MAP||'&prm_padrao='||WS_PADRAO.CD_PADRAO||''', ''false'', ''deff_lines''); document.getElementById(''padrao3'').value='''||UPPER(TRIM(WS_PADRAO.CD_PADRAO))||'''; document.getElementById(''dre'').style.marginTop=''-780px''; document.getElementById(''deff_padrao'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-100px''; document.getElementById(''padrao-menu'').style.marginTop=''-50px''; document.getElementById(''micro-visao'').setAttribute(''title'', '''||WS_PADRAO.CD_MICRO_VISAO||'''); document.getElementById(''titulo'').innerHTML = ''LINHAS'';">'||FUN.LANG('LINHA')||'</a></td>');
					    HTP.P('<td><a class="red" onclick="ajax(''list'', ''dre_filtro'', ''prm_map='||PRM_MAP||'&prm_padrao='||WS_PADRAO.CD_PADRAO||''', ''false'', ''deff_filtro''); document.getElementById(''padrao2'').value='''||UPPER(TRIM(WS_PADRAO.CD_PADRAO))||'''; document.getElementById(''dre'').style.marginTop=''-1560px''; document.getElementById(''deff_padrao'').style.marginTop=''-1170px''; document.getElementById(''deff_lines'').style.marginTop=''-780px''; document.getElementById(''deff_line'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-200px''; document.getElementById(''padrao-menu'').style.marginTop=''-150px''; document.getElementById(''vazio-menu'').style.marginTop=''-100px''; document.getElementById(''line-menu'').style.marginTop=''-50px''; document.getElementById(''micro-visao'').setAttribute(''title'', '''||WS_PADRAO.CD_MICRO_VISAO||'''); document.getElementById(''titulo'').innerHTML = ''DEFF_FILTRO'';">'||FUN.LANG('FILTROS')||'</a></td>');
					    FCL.BUTTON_LIXO('dl_padrao','prm_padrao', WS_PADRAO.CD_PADRAO);
						
					HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_PADROES;
        HTP.P('</tbody>');
	HTP.P('</table>');
END DRE_PADRAO;

PROCEDURE DRE_LINES ( PRM_MAP   VARCHAR2 DEFAULT NULL,
                      PRM_PADRAO VARCHAR2 DEFAULT NULL ) AS

        CURSOR CRS_LINES IS
	    SELECT NR_ITEM, COUNT(NR_ITEM) AS COUNTER
	    FROM DEFF_LINE WHERE CD_MAPA = PRM_MAP AND CD_PADRAO = PRM_PADRAO GROUP BY NR_ITEM ORDER BY NR_ITEM;

	    WS_LINE CRS_LINES%ROWTYPE;

		WS_NEW NUMBER;
		WS_REFERENCIA NUMBER;

BEGIN

	HTP.P('<h2><a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||PRM_MAP||'</a> > <a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DEFF_PADR&Atilde;O'';">'||PRM_PADRAO||'</a> > <span style="font-size: 16px; font-weight: bold;">DEFF_LINE</span></h2>');
	HTP.P('<table class="linha">');
	    HTP.P('<tbody id="lines">');
			HTP.P('<tr>');
				HTP.P('<th>'||FUN.LANG('Linha')||'</th>');
				HTP.P('<th>'||FUN.LANG('Quantidade')||'</th>');
				HTP.P('<th>'||FUN.LANG('Op&ccedil;&otilde;es')||'</th>');
			HTP.P('</tr>');
			WS_REFERENCIA := 0;
			OPEN CRS_LINES;
				LOOP
					FETCH CRS_LINES INTO WS_LINE;
					EXIT WHEN CRS_LINES%NOTFOUND;
					IF WS_REFERENCIA = 0 THEN
					    WS_REFERENCIA := WS_LINE.COUNTER;
					END IF;
					HTP.P('<tr class="dashed">');
			            HTP.P('<td>'||WS_LINE.NR_ITEM||'</td>');
						IF WS_LINE.COUNTER = WS_REFERENCIA THEN
						    HTP.P('<td style="color: #009900; font-weight: bold;">'||WS_LINE.COUNTER||'</td>');
						ELSE
						    HTP.P('<td style="color: #CC0000; font-weight: bold;" title="'||WS_REFERENCIA||'">'||WS_LINE.COUNTER||'</td>');
					    END IF;
						HTP.P('<td><a title="deff_line" class="red" onclick="ajax(''list'', ''dre_line'', ''prm_map='||PRM_MAP||'&prm_padrao='||PRM_PADRAO||'&prm_item='||WS_LINE.NR_ITEM||''', ''false'', ''deff_line''); document.getElementById(''nr_item'').value='''||WS_LINE.NR_ITEM||'''; document.getElementById(''dre'').style.marginTop=''-1170px''; document.getElementById(''deff_padrao'').style.marginTop=''-780px''; document.getElementById(''deff_lines'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-150px''; document.getElementById(''padrao-menu'').style.marginTop=''-100px''; document.getElementById(''vazio-menu'').style.marginTop=''-50px''; if(parseInt('||WS_REFERENCIA||') <= parseInt('||WS_LINE.COUNTER||')){ document.getElementById(''line-menu'').style.visibility=''hidden''; } else { document.getElementById(''line-menu'').style.visibility=''visible''; } document.getElementById(''titulo'').innerHTML = ''LINHA'';">'||FUN.LANG('EDITAR')||'</td>');
			        HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_LINES;
			SELECT MAX(NR_ITEM)+1 INTO WS_NEW FROM DEFF_LINE WHERE CD_MAPA = PRM_MAP AND CD_PADRAO = PRM_PADRAO;
			HTP.P('<tr class="dashed">');
			    HTP.P('<td>'||WS_NEW||'</td>');
				HTP.P('<td style="color: #CC0000; font-weight: bold;">0</td>');
				HTP.P('<td><a title="deff_line" class="red" onclick="ajax(''list'', ''dre_line'', ''prm_map='||PRM_MAP||'&prm_padrao='||PRM_PADRAO||'&prm_item='||WS_NEW||''', ''false'', ''deff_line''); if(('''||WS_NEW||''') != ''''){ document.getElementById(''nr_item'').value='''||WS_NEW||'''; } else { document.getElementById(''nr_item'').value=''1''; }document.getElementById(''dre'').style.marginTop=''-1170px''; document.getElementById(''deff_padrao'').style.marginTop=''-780px''; document.getElementById(''deff_lines'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-150px''; document.getElementById(''padrao-menu'').style.marginTop=''-100px''; document.getElementById(''vazio-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML = ''LINHA'';">'||FUN.LANG('ADICIONAR')||'</td>');
			HTP.P('</tr>');
		HTP.P('</tbody>');
	HTP.P('</table>');

END DRE_LINES;

PROCEDURE DRE_LINE ( PRM_MAP    VARCHAR2 DEFAULT NULL,
                     PRM_PADRAO VARCHAR2 DEFAULT NULL,
                     PRM_ITEM   VARCHAR2 DEFAULT NULL ) AS

        CURSOR CRS_LINES IS
	    SELECT CD_DEFLINE, INDICE, CD_COLUNA
	    FROM DEFF_LINE WHERE CD_MAPA = PRM_MAP AND CD_PADRAO = PRM_PADRAO AND NR_ITEM = PRM_ITEM ORDER BY INDICE;

	    WS_LINE CRS_LINES%ROWTYPE;

BEGIN

	HTP.P('<h2><a class="red" title="'||FUN.LANG('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||PRM_MAP||'</a> > <a class="red" title="'||FUN.LANG('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DEFF_PADR&Atilde;O'';">'||PRM_PADRAO||'</a> > <a class="red" title="'||FUN.LANG('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-780px''; document.getElementById(''deff_padrao'').style.marginTop=''-390px''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-100px''; document.getElementById(''padrao-menu'').style.marginTop=''-50px''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML='''||FUN.LANG('LINHA')||''';">'||FUN.LANG('LINHA')||' '||PRM_ITEM||'</a> > <small style="font-size: 16px; font-weight: bold;">'||FUN.LANG('LINHAS')||'</small></h2>');
	HTP.P('<table class="linha">');
		HTP.P('<tbody id="line">');
			HTP.P('<tr>');
				HTP.P('<th style="min-width: 15%;">'||FUN.LANG('&Iacute;ndice')||'</th>');
				HTP.P('<th style="min-width: 30%;">DEFF_LINE</th>');
				HTP.P('<th style="min-width: 30%;">'||FUN.LANG('Coluna')||'</th>');
				HTP.P('<th style="min-width: 15%;"></th>');
				HTP.P('<th style="min-width: 10%;"></th>');
			HTP.P('</tr>');
			OPEN CRS_LINES;
				LOOP
					FETCH CRS_LINES INTO WS_LINE;
					EXIT WHEN CRS_LINES%NOTFOUND;
					HTP.P('<tr class="dashed">');
			            HTP.P('<td style="min-width: 15%;">'||WS_LINE.INDICE||'</td>');
						HTP.P('<td style="min-width: 30%;">'||WS_LINE.CD_DEFLINE||'</td>');
				        HTP.P('<td style="min-width: 30%;">'||WS_LINE.CD_COLUNA||'</td>');
				        HTP.P('<td style="width: 15%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML='''||FUN.LANG('ALTERAR')||'''; this.className='''';  ajax(''list'', ''defline_expand'', ''prm_item='||PRM_ITEM||'&prm_coluna='||WS_LINE.CD_COLUNA||'&prm_padrao='||PRM_PADRAO||'&prm_mapa='||PRM_MAP||''', false, '''||WS_LINE.INDICE||'-'||WS_LINE.CD_COLUNA||'-expanded''); } else { this.style.color=''''; this.innerHTML='''||FUN.LANG('EDITAR')||'''; this.className=''red''; st_coluna = document.getElementById(''st_coluna'').value; sub_coluna = document.getElementById(''sub_coluna'').value; ajax(''fly'', ''save_defline'', ''prm_mapa='||PRM_MAP||'&prm_padrao='||PRM_PADRAO||'&prm_item='||PRM_ITEM||'&prm_indice='||WS_LINE.INDICE||'&prm_coluna='||WS_LINE.CD_COLUNA||'&prm_st_coluna=''+st_coluna+''&prm_sub_coluna=''+sub_coluna, false); document.getElementById('''||WS_LINE.INDICE||'-'||WS_LINE.CD_COLUNA||'-expanded'').innerHTML = ''''; }" title="'||FUN.LANG('Editar/salvar op&ccedil;&otilde;es')||'">'||FUN.LANG('EDITAR')||'</a></td>');
				        FCL.BUTTON_LIXO('dl_defline','prm_item|prm_coluna|prm_mapa|prm_padrao', PRM_ITEM||'|'||WS_LINE.CD_COLUNA||'|'||PRM_MAP||'|'||PRM_PADRAO);
			        HTP.P('</tr>');
			        HTP.P('<tr class="noborder"><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||WS_LINE.INDICE||'-'||WS_LINE.CD_COLUNA||'-expanded"></td></tr>');
				END LOOP;
			CLOSE CRS_LINES;
		HTP.P('</tbody>');
	HTP.P('</table>');

END DRE_LINE;

PROCEDURE DRE_FILTRO ( PRM_MAP    VARCHAR2 DEFAULT NULL,
                       PRM_PADRAO VARCHAR2 DEFAULT NULL ) AS

        CURSOR CRS_FILTROS IS
	    SELECT NR_ITEM, CD_COLUNA, CONDICAO, CONTEUDO
	    FROM DEFF_LINE_FILTRO WHERE CD_MAPA = PRM_MAP AND CD_PADRAO = PRM_PADRAO ORDER BY NR_ITEM;

	    WS_FILTRO CRS_FILTROS%ROWTYPE;

BEGIN
    
	HTP.P('<h2><a class="red" title="voltar" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''0''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''deff_line'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''0''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML=''DRE'';">'||PRM_MAP||'</a> > <a class="red" title="'||FUN.LANG('voltar')||'" style="font-size: 16px; font-weight: bold;" onclick="document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''deff_padrao'').style.marginTop=''0''; document.getElementById(''deff_lines'').style.marginTop=''0''; document.getElementById(''deff_line'').style.marginTop=''0''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''padrao-menu'').style.marginTop=''0''; document.getElementById(''vazio-menu'').style.marginTop=''0''; document.getElementById(''titulo'').innerHTML='''||FUN.LANG('DEFF_PADR&Atilde;O')||''';">'||PRM_PADRAO||'</a> > <small style="font-size: 16px; font-weight: bold;">'||FUN.LANG('DEFF_LINE_FILTRO')||'</small></h2>');
	    HTP.P('<table class="linha">');
			HTP.P('<tbody id="filtro">');
				HTP.P('<tr>');
					HTP.P('<th>'||FUN.LANG('Número')||'</th>');
					HTP.P('<th>'||FUN.LANG('Coluna')||'</th>');
					HTP.P('<th>'||FUN.LANG('Condi&ccedil;&atilde;o')||'</th>');
					HTP.P('<th>'||FUN.LANG('Conteudo')||'</th>');
					HTP.P('<th></th>');
				HTP.P('</tr>');
				OPEN CRS_FILTROS;
					LOOP
						FETCH CRS_FILTROS INTO WS_FILTRO;
						EXIT WHEN CRS_FILTROS%NOTFOUND;
						HTP.P('<tr class="dashed">');
							HTP.P('<td>'||WS_FILTRO.NR_ITEM||'</td>');
							HTP.P('<td>'||WS_FILTRO.CD_COLUNA||'</td>');
							HTP.P('<td>'||WS_FILTRO.CONDICAO||'</td>');
							HTP.P('<td>'||REPLACE(WS_FILTRO.CONTEUDO, '$[CONCAT]', '||')||'</td>');
						    FCL.BUTTON_LIXO('dl_filtro','prm_mapa|prm_padrao|prm_item', PRM_MAP||'|'||PRM_PADRAO||'|'||WS_FILTRO.NR_ITEM);
							
						HTP.P('</tr>');
					END LOOP;
				CLOSE CRS_FILTROS;
			HTP.P('</tbody>');
		HTP.P('</table>');

END DRE_FILTRO;

PROCEDURE NEW_DRE ( PRM_MAPA        VARCHAR2 DEFAULT NULL,
                    PRM_DSMAPA      VARCHAR2 DEFAULT NULL,
					PRM_LIGACAO     VARCHAR2 DEFAULT NULL,
					PRM_DSMASC      VARCHAR2 DEFAULT NULL,
					PRM_POINT       VARCHAR2 DEFAULT NULL,
					PRM_RIGHT       VARCHAR2 DEFAULT NULL,
					PRM_MASC_COLUNA VARCHAR2 DEFAULT NULL,
					PRM_COLUNA_DEFF VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

	BEGIN
	    SELECT COUNT(*) INTO WS_COUNT FROM DEFINE_MAP WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA));
        
		IF WS_COUNT = 0 THEN
			INSERT INTO DEFINE_MAP VALUES(UPPER(TRIM(PRM_MAPA)), PRM_DSMAPA, PRM_LIGACAO, PRM_DSMASC, PRM_POINT, PRM_RIGHT, PRM_MASC_COLUNA, PRM_COLUNA_DEFF);
			HTP.P('<tr class="dashed">');
				HTP.P('<td style="min-width: 30%;">'||UPPER(TRIM(PRM_MAPA))||'</td>');
				HTP.P('<td style="min-width: 30%;">'||PRM_DSMAPA||'</td>');
				HTP.P('<td style="min-width: 30%;"><a class="red" onclick="ajax(''list'', ''dre_padrao'', ''prm_map='||UPPER(TRIM(PRM_MAPA))||''', ''false'', ''deff_padrao''); document.getElementById(''cd_mapa'').setAttribute(''value'', '''||UPPER(TRIM(PRM_MAPA))||'''); document.getElementById(''dre'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML='''||FUN.LANG('DEFF_PADR&Atilde;O')||''';">'||FUN.LANG('DEFF_PADRAO')||'</a></td>');
				HTP.P('<td style="width: 7%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML='''||FUN.LANG('ALTERAR')||'''; this.className=''''; ajax(''list'', ''dre_expand'', ''prm_mapa='||UPPER(TRIM(PRM_MAPA))||''', false, '''||UPPER(TRIM(PRM_MAPA))||'-expanded''); } else { this.style.color=''''; this.innerHTML=''EDITAR''; this.className=''red''; ajax(''fly'', ''save_dre'', ''prm_mapa='||UPPER(PRM_MAPA)||'&prm_dsmapa=''+document.getElementById(''dsmapa-'||UPPER(PRM_MAPA)||''').value+''&prm_dsmasc=''+document.getElementById(''cdesc-'||UPPER(PRM_MAPA)||''').getAttribute(''title'')+''&prm_point=''+document.getElementById(''point-'||UPPER(PRM_MAPA)||''').getAttribute(''title'')+''&prm_right=''+document.getElementById(''right-'||UPPER(PRM_MAPA)||''').getAttribute(''title'')+''&prm_masc_coluna=''+document.getElementById(''masc-'||UPPER(PRM_MAPA)||''').getAttribute(''title''), false); document.getElementById('''||UPPER(PRM_MAPA)||'-expanded'').innerHTML = ''''; }">'||FUN.LANG('EDITAR')||'</a></td>');
                FCL.BUTTON_LIXO('dl_dre','prm_mapa', UPPER(TRIM(PRM_MAPA)));
				
			HTP.P('</tr>');
			HTP.P('<tr class="noborder"><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||UPPER(TRIM(PRM_MAPA))||'-expanded"></td></tr>');
		ELSIF WS_COUNT = 1 THEN
		    HTP.P('#alert '||FUN.LANG('Erro, DRE j&aacute; existe no sistema')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
		END IF;

END NEW_DRE;

PROCEDURE SAVE_DRE ( PRM_MAPA       VARCHAR2 DEFAULT NULL,
                    PRM_DSMAPA      VARCHAR2 DEFAULT NULL,
					PRM_DSMASC      VARCHAR2 DEFAULT NULL,
					PRM_POINT       VARCHAR2 DEFAULT NULL,
					PRM_RIGHT       VARCHAR2 DEFAULT NULL,
					PRM_MASC_COLUNA VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

	BEGIN

	    SELECT COUNT(*) INTO WS_COUNT FROM DEFINE_MAP WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA));
        
		IF WS_COUNT = 1 THEN
			UPDATE DEFINE_MAP
			SET DS_MASCARA = PRM_DSMASC, DS_MAPA = PRM_DSMAPA, MASC_POINT = PRM_POINT, MASC_RIGHT = PRM_RIGHT, CD_MASC_COLUNA = PRM_MASC_COLUNA
			WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA));
		ELSIF WS_COUNT = 0 THEN
		    HTP.P('#alert '||FUN.LANG('Erro, DRE n&atilde;o existe')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
		END IF;

END SAVE_DRE;

PROCEDURE DL_DRE ( PRM_MAPA VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

	BEGIN
		
		SELECT COUNT(*) INTO WS_COUNT FROM DEFF_PADRAO WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA));

		IF WS_COUNT > 0 THEN
	        HTP.P('#alert '||FUN.LANG('DRE possui niveis, imposs&iacute;vel excluir')||'!');
		ELSE
		    WS_COUNT := 0;
		    SELECT COUNT(*) INTO WS_COUNT FROM DEFINE_MAP WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA));
            IF WS_COUNT = 1 THEN
			    DELETE FROM DEFINE_MAP WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA));
		    ELSIF WS_COUNT = 0 THEN
		        HTP.P('#alert '||FUN.LANG('Erro, DRE n&atilde;o existe')||'!');
		    ELSE
		        HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
		    END IF;
		END IF;

END DL_DRE;

PROCEDURE NEW_PADRAO ( PRM_MAPA     VARCHAR2 DEFAULT NULL,
                       PRM_CDPADRAO VARCHAR2 DEFAULT NULL,
					   PRM_DSPADRAO VARCHAR2 DEFAULT NULL,
					   PRM_VISAO    VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

	BEGIN

	    SELECT COUNT(*) INTO WS_COUNT FROM DEFF_PADRAO WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_CDPADRAO));
        IF WS_COUNT = 0 THEN
			INSERT INTO DEFF_PADRAO VALUES(UPPER(TRIM(PRM_MAPA)), UPPER(TRIM(PRM_CDPADRAO)), PRM_DSPADRAO, PRM_VISAO);
			HTP.P('<tr class="dashed">');
				HTP.P('<td>'||UPPER(TRIM(PRM_CDPADRAO))||'</td>');
				HTP.P('<td>'||PRM_DSPADRAO||'</td>');
				HTP.P('<td>'||PRM_VISAO||'</td>');
				HTP.P('<td><a class="red" onclick="ajax(''list'', ''dre_line'', ''prm_map='||PRM_MAPA||'&prm_padrao='||UPPER(TRIM(PRM_CDPADRAO))||''', ''false'', ''deff_line''); document.getElementById(''padrao3'').value='''||UPPER(TRIM(PRM_CDPADRAO))||'''; document.getElementById(''dre'').style.marginTop=''-780px''; document.getElementById(''deff_padrao'').style.marginTop=''-390px''; document.getElementById(''dre-menu'').style.marginTop=''-100px''; document.getElementById(''padrao-menu'').style.marginTop=''-50px''; document.getElementById(''titulo'').innerHTML = ''DEFF_LINE''; ">DEFF_LINE</a></td>');
				HTP.P('<td><a class="red" onclick="ajax(''list'', ''dre_filtro'', ''prm_map='||PRM_MAPA||'&prm_padrao='||UPPER(TRIM(PRM_CDPADRAO))||''', ''false'', ''deff_filtro''); document.getElementById(''dre'').style.marginTop=''-1170px''; document.getElementById(''deff_padrao'').style.marginTop=''-780px''; document.getElementById(''deff_line'').style.marginTop=''-390px''; ">'||FUN.LANG('FILTROS')||'</a></td>');
			    FCL.BUTTON_LIXO('dl_padrao','prm_padrao', PRM_CDPADRAO);
				
			HTP.P('</tr>');
		ELSIF WS_COUNT = 1 THEN
		    HTP.P('#alert '||FUN.LANG('Erro, Padr&atilde;o j&aacute; existe no sistema')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
		END IF;

END NEW_PADRAO;

PROCEDURE DL_PADRAO ( PRM_PADRAO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

	BEGIN

		SELECT COUNT(*) INTO WS_COUNT FROM DEFF_LINE WHERE CD_PADRAO = UPPER(TRIM(PRM_PADRAO));

		IF WS_COUNT > 0 THEN
	        HTP.P('#alert '||FUN.LANG('Padr&atilde;o possui filtros/linhas, imposs&iacute;vel excluir')||'!');
		ELSE
		    WS_COUNT := 0;
		    SELECT COUNT(*) INTO WS_COUNT FROM DEFF_PADRAO WHERE CD_PADRAO = UPPER(TRIM(PRM_PADRAO));
            IF WS_COUNT = 1 THEN
			    DELETE FROM DEFF_PADRAO WHERE CD_PADRAO = UPPER(TRIM(PRM_PADRAO));
		    ELSIF WS_COUNT = 0 THEN
		        HTP.P('#alert '||FUN.LANG('Erro, Padr&atilde;o n&atilde;o existe')||'!');
		    ELSE
		        HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
		    END IF;
		END IF;

END DL_PADRAO;

PROCEDURE NEW_DEFLINE ( PRM_MAPA    VARCHAR2 DEFAULT NULL,
                        PRM_ITEM    VARCHAR2 DEFAULT NULL,
					    PRM_PADRAO  VARCHAR2 DEFAULT NULL,
					    PRM_COLUNA  VARCHAR2 DEFAULT NULL,
                        PRM_DEFLINE VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
	WS_INDICE NUMBER;

	BEGIN

	    SELECT COUNT(*) INTO WS_COUNT FROM DEFF_LINE WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND NR_ITEM = PRM_ITEM;
        SELECT MAX(NVL(INDICE, 0))+1 INTO WS_INDICE FROM DEFF_LINE WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND NR_ITEM = PRM_ITEM;
		IF WS_COUNT = 0 THEN
			INSERT INTO DEFF_LINE VALUES(WS_INDICE, UPPER(TRIM(PRM_MAPA)), PRM_ITEM, UPPER(TRIM(PRM_PADRAO)), '', UPPER(TRIM(PRM_COLUNA)), UPPER(TRIM(PRM_DEFLINE)), '');
			HTP.P('<tr>');
			    HTP.P('<td style="min-width: 15%;">'||WS_INDICE||'</td>');
				HTP.P('<td style="min-width: 30%;">'||UPPER(TRIM(PRM_DEFLINE))||'</td>');
				HTP.P('<td style="min-width: 30%;">'||PRM_COLUNA||'</td>');
				HTP.P('<td style="width: 15%;"><a class="red" onclick="if(this.className == ''red''){ this.style.color=''#009900''; this.innerHTML=''ALTERAR''; this.className='''';  ajax(''list'', ''defline_expand'', ''prm_item='||PRM_ITEM||'&prm_coluna='||PRM_COLUNA||'&prm_padrao='||PRM_PADRAO||'&prm_mapa='||PRM_MAPA||''', false, '''||WS_INDICE||'-'||PRM_COLUNA||'-expanded''); } else { this.style.color=''''; this.innerHTML=''EDITAR''; this.className=''red''; st_coluna = document.getElementById(''st_coluna'').value; sub_coluna = document.getElementById(''sub_coluna'').value; ajax(''fly'', ''save_defline'', ''prm_mapa='||PRM_MAPA||'&prm_padrao='||PRM_PADRAO||'&prm_item='||PRM_ITEM||'&prm_indice='||WS_INDICE||'&prm_coluna='||PRM_COLUNA||'&prm_st_coluna=''+st_coluna+''&prm_sub_coluna=''+sub_coluna, false); document.getElementById('''||WS_INDICE||'-'||PRM_COLUNA||'-expanded'').innerHTML = ''''; }" title="'||FUN.LANG('Editar/salvar op&ccedil;&otilde;es')||'">'||FUN.LANG('EDITAR')||'</a></td>');
				FCL.BUTTON_LIXO('dl_defline','prm_item|prm_coluna|prm_mapa|prm_padrao', PRM_ITEM||'|'||PRM_COLUNA||'|'||PRM_MAPA||'|'||PRM_PADRAO);
				
			HTP.P('</tr>');
			HTP.P('<tr><td colspan="4" style="width: 100%; padding: 0 0 2px 0;" id="'||WS_INDICE||'-'||PRM_COLUNA||'-expanded"></td></tr>');
		ELSIF WS_COUNT = 1 THEN
		    HTP.P('#alert '||FUN.LANG('Erro, DEFF_LINE j&aacute; existe no sistema')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
		END IF;

END NEW_DEFLINE;

PROCEDURE DEFLINE_EXPAND ( PRM_ITEM   VARCHAR2 DEFAULT NULL,
                           PRM_COLUNA VARCHAR2 DEFAULT NULL,
                           PRM_PADRAO VARCHAR2 DEFAULT NULL,
                           PRM_MAPA   VARCHAR2 DEFAULT NULL ) AS

  WS_COLUNA CHAR(1);
  WS_SUBCOLUNA VARCHAR2(2000);

BEGIN

    SELECT ST_COLUNA, CD_SUB_COLUNA
	INTO WS_COLUNA, WS_SUBCOLUNA
	FROM DEFF_LINE
	WHERE CD_MAPA = PRM_MAPA AND CD_PADRAO = PRM_PADRAO AND CD_COLUNA = PRM_COLUNA AND NR_ITEM = PRM_ITEM;

	HTP.P('<input title="st_coluna" id="st_coluna" type="text" value="'||WS_COLUNA||'" placeholder="st_coluna">');
	HTP.P('<input title="cd_sub_coluna" id="sub_coluna" type="text" value="'||WS_SUBCOLUNA||'" placeholder="cd_sub_coluna" style="width: 300px;">');

END DEFLINE_EXPAND;

PROCEDURE DL_DEFLINE ( PRM_ITEM   VARCHAR2 DEFAULT NULL,
                       PRM_COLUNA VARCHAR2 DEFAULT NULL,
                       PRM_MAPA   VARCHAR2 DEFAULT NULL,
                       PRM_PADRAO VARCHAR2 DEFAULT NULL ) AS

    	WS_COUNT NUMBER;

BEGIN

	SELECT COUNT(*) INTO WS_COUNT FROM DEFF_LINE WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND NR_ITEM = UPPER(TRIM(PRM_ITEM)) AND CD_COLUNA = UPPER(TRIM(PRM_COLUNA));
    IF WS_COUNT = 1 THEN
		DELETE FROM DEFF_LINE WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND NR_ITEM = UPPER(TRIM(PRM_ITEM)) AND CD_COLUNA = UPPER(TRIM(PRM_COLUNA));
	ELSIF WS_COUNT = 0 THEN
		HTP.P('#alert '||FUN.LANG('Erro, DEFF_LINE n&atilde;o existe')||'!');
	ELSE
		HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
	END IF;

END DL_DEFLINE;

PROCEDURE SAVE_DEFLINE ( PRM_MAPA       VARCHAR2 DEFAULT NULL,
						 PRM_PADRAO     VARCHAR2 DEFAULT NULL,
						 PRM_COLUNA     VARCHAR2 DEFAULT NULL,
						 PRM_ITEM       VARCHAR2 DEFAULT NULL,
						 PRM_INDICE     VARCHAR2 DEFAULT NULL,
						 PRM_ST_COLUNA  VARCHAR2 DEFAULT NULL,
						 PRM_SUB_COLUNA VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

BEGIN

	SELECT COUNT(*) INTO WS_COUNT FROM DEFF_LINE WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND CD_COLUNA = UPPER(TRIM(PRM_COLUNA)) AND NR_ITEM= UPPER(TRIM(PRM_ITEM));
	IF WS_COUNT = 1 THEN
		UPDATE DEFF_LINE
		SET ST_COLUNA = PRM_ST_COLUNA, CD_SUB_COLUNA = PRM_SUB_COLUNA
		WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND CD_COLUNA = UPPER(TRIM(PRM_COLUNA)) AND NR_ITEM= UPPER(TRIM(PRM_ITEM));
	ELSIF WS_COUNT = 0 THEN
		HTP.P('#alert '||FUN.LANG('Erro, DEFF_LINE n&atilde;o existe')||'!');
	ELSE
		HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
	END IF;

END SAVE_DEFLINE;

PROCEDURE NEW_FILTRO ( PRM_MAPA     VARCHAR2 DEFAULT NULL,
                       PRM_PADRAO   VARCHAR2 DEFAULT NULL,
                       PRM_ITEM     VARCHAR2 DEFAULT NULL,
                       PRM_COLUNA   VARCHAR2 DEFAULT NULL,
					   PRM_CONDICAO VARCHAR2 DEFAULT NULL,
					   PRM_CONTEUDO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

BEGIN

	SELECT COUNT(*) INTO WS_COUNT FROM DEFF_LINE_FILTRO 
	WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND 
	CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND 
	NR_ITEM = UPPER(TRIM(PRM_ITEM));
	
	IF WS_COUNT = 0 THEN
		INSERT INTO DEFF_LINE_FILTRO VALUES(UPPER(TRIM(PRM_MAPA)), UPPER(TRIM(PRM_ITEM)), '1', UPPER(TRIM(PRM_PADRAO)), UPPER(TRIM(PRM_COLUNA)), PRM_CONDICAO,  REPLACE(PRM_CONTEUDO, '||', '$[CONCAT]'), 'AND');
		HTP.P('<tr class="dashed">');
			HTP.P('<td>'||UPPER(TRIM(PRM_ITEM))||'</td>');
			HTP.P('<td>'||UPPER(TRIM(PRM_COLUNA))||'</td>');
			HTP.P('<td>'||PRM_CONDICAO||'</td>');
			HTP.P('<td>'||REPLACE(PRM_CONTEUDO, '$[CONCAT]', '||')||'</td>');
			FCL.BUTTON_LIXO('dl_filtro','prm_mapa|prm_padrao|prm_item', PRM_MAPA||'|'||PRM_PADRAO||'|'||PRM_ITEM);
			
		HTP.P('</tr>');
	ELSIF WS_COUNT = 1 THEN
		HTP.P('#alert '||FUN.LANG('Erro, Padr&atilde;o j&aacute; existe no sistema')||'!');
	ELSE
		HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
	END IF;

END NEW_FILTRO;

PROCEDURE DL_FILTRO ( PRM_MAPA   VARCHAR2 DEFAULT NULL,
                      PRM_PADRAO VARCHAR2 DEFAULT NULL,
                      PRM_ITEM   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

BEGIN

	SELECT COUNT(*) INTO WS_COUNT FROM DEFF_LINE_FILTRO WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND NR_ITEM = UPPER(TRIM(PRM_ITEM));
	IF WS_COUNT = 1 THEN
		DELETE FROM DEFF_LINE_FILTRO WHERE CD_MAPA = UPPER(TRIM(PRM_MAPA)) AND CD_PADRAO = UPPER(TRIM(PRM_PADRAO)) AND NR_ITEM = UPPER(TRIM(PRM_ITEM));
	ELSIF WS_COUNT = 0 THEN
		HTP.P('#alert '||FUN.LANG('Erro, filtro n&atilde;o existe')||'!');
	ELSE
		HTP.P('#alert '||FUN.LANG('Erro, valor duplicado')||'!');
	END IF;

END DL_FILTRO;

PROCEDURE DL_OBJECT ( PRM_OBJECT VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;

BEGIN
    
	BEGIN
		DELETE FROM TRADUCAO_COLUNAS WHERE CD_TABELA = PRM_OBJECT;
		DELETE FROM CALL_LIST WHERE CD_OBJETO = PRM_OBJECT OR CD_LIST = PRM_OBJECT;
		DELETE FROM FILTROS WHERE CD_OBJETO = PRM_OBJECT AND TP_FILTRO = 'objeto';
		DELETE FROM DESTAQUE WHERE CD_OBJETO = PRM_OBJECT;
		DELETE FROM GOTO_OBJETO WHERE CD_OBJETO = PRM_OBJECT OR CD_OBJETO_GO = PRM_OBJECT;
		DELETE FROM OBJETOS WHERE CD_OBJETO = PRM_OBJECT;
		DELETE FROM OBJECT_LOCATION WHERE OBJECT_ID = PRM_OBJECT OR SCREEN = PRM_OBJECT;
		DELETE FROM OBJECT_RESTRICTION WHERE CD_OBJETO = PRM_OBJECT;
		DELETE FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_OBJECT;
	    DELETE FROM ALL_SCREENS WHERE SCREEN = PRM_OBJECT;
		DELETE FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_OBJECT;
		DELETE FROM FLOAT_FILTER_ITEM WHERE TRIM(CD_COLUNA) = TRIM(PRM_OBJECT);
		DELETE FROM USER_SCREENS WHERE SCREEN = PRM_OBJECT;
		COMMIT;
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Objeto '||PRM_OBJECT||' excluido do sistema', GBL.GETUSUARIO, 'EVENTO');
        COMMIT;
	EXCEPTION WHEN OTHERS THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir o objeto')||'!');
		ROLLBACK;
	END;

END DL_OBJECT;

PROCEDURE GRUPOS ( PRM_ORDER VARCHAR2 DEFAULT '1',
                   PRM_DIR   VARCHAR2 DEFAULT '1' ) AS

    CURSOR CRS_GRUPOS IS
    SELECT CD_GRUPO, NM_GRUPO, STATUS, GIF, ORDEM, (SELECT COUNT(*) FROM OBJETOS WHERE OBJETOS.CD_GRUPO = GRUPOS_FUNCAO.CD_GRUPO) AS COBJETOS
	FROM GRUPOS_FUNCAO
	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', CD_GRUPO, '2', NM_GRUPO, CD_GRUPO) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', CD_GRUPO, '2', NM_GRUPO, CD_GRUPO) END DESC;

	WS_GRUPO CRS_GRUPOS%ROWTYPE;
    
	WS_DIR     NUMBER := 1;
	WS_PADRAO  VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO VARCHAR2(80);

	WS_NOUSER EXCEPTION;

BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''grupos'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('CATEGORIA')||'</a></th>');
				HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''grupos'', ''prm_order=2&prm_dir=''+dir, false, ''content'');">'||FUN.LANG('NOME')||'</a></th>');
				HTP.P('<th>'||FUN.LANG('ORDEM')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
			IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;

			HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
				OPEN CRS_GRUPOS;
					LOOP
						FETCH CRS_GRUPOS INTO WS_GRUPO;
						EXIT WHEN CRS_GRUPOS%NOTFOUND;
						HTP.P('<tr>');
							HTP.P('<td><span class="text lang" id="'||WS_GRUPO.CD_GRUPO||'_nome" title="'||WS_GRUPO.CD_GRUPO||'">'||FUN.UTRANSLATE('CD_GRUPO', 'GRUPOS_FUNCAO', WS_GRUPO.CD_GRUPO, WS_PADRAO)||'</span><a class="fakelang" onclick="fakeLang('''||WS_GRUPO.CD_GRUPO||'_nome'', ''GRUPOS_FUNCAO|CD_GRUPO|''+this.previousElementSibling.title, ''cd'');">L</a></td>');
							HTP.P('<td>');
							    HTP.P('<input maxlength="100" style="width: calc(100% - 16px) !important;" title="'||WS_GRUPO.NM_GRUPO||'" id="'||WS_GRUPO.CD_GRUPO||'_desc" value="'||WS_GRUPO.NM_GRUPO||'" onblur="var valor = this.value; if(valor.length > 0){ call(''edit_grupo'', ''prm_grupo='||WS_GRUPO.CD_GRUPO||'&prm_valor=''+this.value+''&prm_tipo=nome'', false).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } }); } else { alerta(''feed-fixo'', TR_BL); }" />');
							    HTP.P('<a class="fakelang" onclick="fakeLang('''||WS_GRUPO.CD_GRUPO||'_desc'', ''GRUPOS_FUNCAO|NM_GRUPO|''+this.previousElementSibling.title);">L</a>');
							HTP.P('</td>');
							HTP.P('<td>');
							    HTP.P('<input type="number" title="'||WS_GRUPO.ORDEM||'" id="'||WS_GRUPO.ORDEM||'_ordem" value="'||WS_GRUPO.ORDEM||'" oninput="call(''edit_grupo'', ''prm_grupo='||WS_GRUPO.CD_GRUPO||'&prm_valor=''+this.value+''&prm_tipo=ordem'', false).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });" />');
							HTP.P('</td>');
							IF WS_GRUPO.COBJETOS = 0 THEN
							    HTP.P('<td>');
									FCL.BUTTON_LIXO('edit_grupo','prm_grupo|prm_valor|prm_tipo', WS_GRUPO.CD_GRUPO||'|'||''||'|'||'delete');
								HTP.P('</td>');
								
							ELSE
							    HTP.P('<td><a title="'||FUN.LANG('imposs&iacute;vel remover')||'" class="noremove">X</a></td>');
							END IF;
						HTP.P('</tr>');
					END LOOP;
				CLOSE CRS_GRUPOS;
			HTP.P('</tbody>');
	    HTP.P('</thead>');
	HTP.P('</table>');

EXCEPTION
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END GRUPOS;

PROCEDURE CREATE_GRUPO( PRM_GRUPO VARCHAR2 DEFAULT NULL,
                        PRM_NOME  VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
    WS_GRUPO VARCHAR2(40);
	WS_NOME  VARCHAR2(120);
BEGIN

    WS_GRUPO := FUN.CONVERTE(PRM_GRUPO);
	WS_NOME  := FUN.CONVERTE(PRM_NOME);

    SELECT COUNT(*) INTO WS_COUNT FROM GRUPOS_FUNCAO
	WHERE CD_GRUPO = UPPER(TRIM(PRM_GRUPO));

	IF WS_COUNT = 0 THEN
	    INSERT INTO GRUPOS_FUNCAO VALUES(UPPER(TRIM(WS_GRUPO)), TRIM(WS_NOME), 'A', UPPER(TRIM(WS_GRUPO)), 0);
		INSERT INTO TRADUCAO_COLUNAS VALUES('GRUPOS_FUNCAO', 'CD_GRUPO', FUN.RET_VAR('LANG_SYS'), UPPER(TRIM(WS_GRUPO)), UPPER(TRIM(WS_GRUPO)), 'T', 'N');
		INSERT INTO TRADUCAO_COLUNAS VALUES('GRUPOS_FUNCAO', 'NM_GRUPO', FUN.RET_VAR('LANG_SYS'), TRIM(WS_NOME), TRIM(WS_NOME), 'T', 'N');
		COMMIT;
		HTP.P('ok');
	ELSE
	    HTP.P('Grupo j&aacute; existe!');
	END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('Erro ao cadastrar grupo');
END CREATE_GRUPO;

PROCEDURE EDIT_GRUPO( PRM_GRUPO VARCHAR2 DEFAULT NULL,
                      PRM_VALOR VARCHAR2 DEFAULT NULL,
					  PRM_TIPO  VARCHAR2 DEFAULT NULL ) AS
					  
	WS_FAIL  EXCEPTION;
	WS_COUNT NUMBER;

BEGIN

	IF PRM_TIPO = 'nome' THEN
		UPDATE GRUPOS_FUNCAO
		SET NM_GRUPO = TRIM(PRM_VALOR)
		WHERE CD_GRUPO = TRIM(PRM_GRUPO);
	ELSIF PRM_TIPO = 'ordem' THEN
		UPDATE GRUPOS_FUNCAO
		SET ORDEM = TRIM(PRM_VALOR)
		WHERE CD_GRUPO = TRIM(PRM_GRUPO);
	ELSIF PRM_TIPO = 'status' THEN
		UPDATE GRUPOS_FUNCAO
		SET STATUS = TRIM(PRM_VALOR)
		WHERE CD_GRUPO = TRIM(PRM_GRUPO);
	ELSIF PRM_TIPO = 'delete' THEN
		DELETE FROM GRUPOS_FUNCAO
		WHERE CD_GRUPO = TRIM(PRM_GRUPO);
	ELSE
		UPDATE GRUPOS_FUNCAO
		SET GIF = TRIM(PRM_VALOR)
		WHERE CD_GRUPO = TRIM(PRM_GRUPO);
	END IF;
	
	WS_COUNT := SQL%ROWCOUNT;
	
	IF WS_COUNT <> 0 THEN
		COMMIT;
	ELSE
		RAISE WS_FAIL;
	END IF;

EXCEPTION 
    WHEN WS_FAIL THEN
	    ROLLBACK;
        HTP.P('FAIL');
    WHEN OTHERS THEN
	    HTP.P('FAIL');
END EDIT_GRUPO;

PROCEDURE CONSULTA ( PRM_OBJETO      VARCHAR2 DEFAULT NULL,
                     PRM_VISAO       VARCHAR2 DEFAULT NULL,
					 PRM_NOME        VARCHAR2 DEFAULT NULL,
					 PRM_GRUPO       VARCHAR2 DEFAULT NULL,
					 PRM_AGRUPAMENTO VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_COLUNAS IS
	SELECT NVL(COLUMN_VALUE, 'n/a') AS ITEM FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA
	FROM PONTO_AVALIACAO
	WHERE CD_PONTO = PRM_OBJETO)))
	WHERE COLUMN_VALUE <> 'n/a';

	WS_COLUNA CRS_COLUNAS%ROWTYPE;

	CURSOR CRS_AGRUPADORES IS
	SELECT NVL(COLUMN_VALUE, 'n/a') AS ITEM FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR
	FROM PONTO_AVALIACAO
	WHERE CD_PONTO = PRM_OBJETO)))
	WHERE COLUMN_VALUE <> 'n/a';

	WS_AGRUPADOR CRS_AGRUPADORES%ROWTYPE;

	CURSOR CRS_COLUPS IS
	SELECT NVL(COLUMN_VALUE, 'n/a') AS ITEM FROM TABLE(FUN.VPIPE((SELECT CS_COLUP
	FROM PONTO_AVALIACAO
	WHERE CD_PONTO = PRM_OBJETO)))
	WHERE COLUMN_VALUE <> 'n/a';

	WS_COLUP CRS_COLUPS%ROWTYPE;

	WS_COUNT   NUMBER;
	WS_OK      NUMBER;
	WS_NOME    VARCHAR2(800);
	WS_ID      VARCHAR2(800);
	WS_PADRAO  VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO VARCHAR2(80);
	
	WS_NOUSER  EXCEPTION;
BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

    WS_NOME := FUN.CONVERTE(PRM_NOME);
	WS_ID   := FUN.CONVERTE(PRM_OBJETO);

    


    

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
    
	HTP.P('<input type="hidden" value="'||PRM_VISAO||'" id="prm_visao" />');
	HTP.P('<input type="hidden" value="'||WS_ID||'" id="prm_objeto" />');
	HTP.P('<input type="hidden" value="'||WS_NOME||'" id="nome_consulta" />');
	HTP.P('<input type="hidden" value="'||PRM_GRUPO||'" id="grupo_consulta" />');
	HTP.P('<input type="hidden" value="'||PRM_AGRUPAMENTO||'" id="agrupamento_consulta" />');

	HTP.P('<div style="display: flex;">');
        WS_OK := 0;
		HTP.P('<div style="height: 90%; float: left; margin-right: 10px;">');
			HTP.P('<h2 class="link" style="margin: 4px; cursor: pointer; font-size: 16px;" >'||FUN.LANG('DIMENS&Otilde;ES'));
			    
			HTP.P('</h2>');
			HTP.P('<ul id="coluna" data-tipo="coluna" class="dimensao" data-type="lista">');
				OPEN CRS_COLUNAS;
					LOOP
						FETCH CRS_COLUNAS INTO WS_COLUNA;
						EXIT WHEN CRS_COLUNAS%NOTFOUND;
						SELECT COUNT(*) INTO WS_OK FROM MICRO_COLUNA WHERE TRIM(CD_COLUNA) = TRIM(WS_COLUNA.ITEM) AND TRIM(CD_MICRO_VISAO) = TRIM(PRM_VISAO);
						IF WS_OK = 0 THEN
						    HTP.P('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||WS_COLUNA.ITEM||'" >'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_COLUNA.ITEM, PRM_VISAO), WS_PADRAO)||'<span class="alert" title="'||FUN.LANG('coluna n&atilde;o existe na tabela micro_coluna')||'">!</span></li>');
						ELSE
							HTP.P('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||WS_COLUNA.ITEM||'" >'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_COLUNA.ITEM, PRM_VISAO), WS_PADRAO)||'<span>X</span></li>');
						END IF;
						HTP.P('<li onclick="swapSquare(this);" class="square"></li>');
					END LOOP;
				CLOSE CRS_COLUNAS;
			HTP.P('</ul>');
		HTP.P('</div>');
        WS_OK := 0;
		HTP.P('<div style="height: 90%; float: left; margin-right: 10px;">');
		    HTP.P('<h2 class="link" style="margin: 4px; cursor: pointer; font-size: 16px;">'||FUN.LANG('MEDIDAS'));
			    
			HTP.P('</h2>');
			HTP.P('<ul id="colunac" data-tipo="pivot" class="medida" data-type="lista">');
				OPEN CRS_AGRUPADORES;
					LOOP
						FETCH CRS_AGRUPADORES INTO WS_AGRUPADOR;
						EXIT WHEN CRS_AGRUPADORES%NOTFOUND;
						SELECT COUNT(*) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_COLUNA = WS_AGRUPADOR.ITEM AND CD_MICRO_VISAO = PRM_VISAO AND ST_AGRUPADOR = 'TPT' AND ROWNUM = 1;
						IF WS_COUNT = 0 THEN
						    SELECT COUNT(*) INTO WS_OK FROM MICRO_COLUNA WHERE TRIM(CD_COLUNA) = TRIM(WS_AGRUPADOR.ITEM) AND TRIM(CD_MICRO_VISAO) = TRIM(PRM_VISAO);
						    IF WS_OK = 0 THEN
						        HTP.P('<li onclick="swapColumn(this);" data-type="medida" class="linha" title="'||WS_AGRUPADOR.ITEM||'">'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_AGRUPADOR.ITEM, PRM_VISAO))||'<span class="alert" title="'||FUN.LANG('coluna n&atilde;o existe na tabela micro_coluna')||'">!</span></li>');
						    ELSE
						        HTP.P('<li onclick="swapColumn(this);" data-type="medida" class="linha" title="'||WS_AGRUPADOR.ITEM||'">'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_AGRUPADOR.ITEM, PRM_VISAO))||'<span>X</span></li>');
						    END IF;
						ELSE
						    HTP.P('<li style="margin: 3px auto;" onclick="swapColumn(this);" data-type="medida" class="linha" title="'||WS_AGRUPADOR.ITEM||'">'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_AGRUPADOR.ITEM, PRM_VISAO), WS_PADRAO)||'<span>X</span></li>');
						END IF;
						HTP.P('<li onclick="swapSquare(this);" class="square"></li>');
					END LOOP;
				CLOSE CRS_AGRUPADORES;
			HTP.P('</ul>');
		HTP.P('</div>');
        WS_OK := 0;
		HTP.P('<div style="height: 90%; float: left; margin-right: 10px;">');
			HTP.P('<h2 class="link" style="margin: 4px; cursor: pointer; font-size: 16px;" >PIVOT');
			    
			HTP.P('</h2>');
			HTP.P('<ul id="colunas" data-tipo="group" class="dimensao" data-type="lista">');
				OPEN CRS_COLUPS;
					LOOP
						FETCH CRS_COLUPS INTO WS_COLUP;
						EXIT WHEN CRS_COLUPS%NOTFOUND;
						SELECT COUNT(*) INTO WS_OK FROM MICRO_COLUNA WHERE TRIM(CD_COLUNA) = TRIM(WS_COLUP.ITEM) AND TRIM(CD_MICRO_VISAO) = TRIM(PRM_VISAO);
						IF WS_OK = 0 THEN
						    HTP.P('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||WS_COLUP.ITEM||'">'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_COLUP.ITEM, PRM_VISAO), WS_PADRAO)||'<span class="alert" title="'||FUN.LANG('coluna n&atilde;o existe na tabela micro_coluna')||'">!</span></li>');
                        ELSE
                        	HTP.P('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||WS_COLUP.ITEM||'">'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(PRM_VISAO)), FUN.NOME_COL(WS_COLUP.ITEM, PRM_VISAO), WS_PADRAO)||'<span>X</span></li>');
                        END IF;
						
						
						HTP.P('<li onclick="swapSquare(this);" class="square"></li>');
					END LOOP;
				CLOSE CRS_COLUPS;
			HTP.P('</ul>');
		HTP.P('</div>');

	HTP.P('</div>');
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END CONSULTA;

PROCEDURE ALTER_CONSULTA ( PRM_NOME        VARCHAR2 DEFAULT NULL,
						   PRM_VALOR       VARCHAR2 DEFAULT NULL,
						   PRM_TIPO        VARCHAR2 DEFAULT NULL
						   ) AS
BEGIN
    CASE PRM_TIPO
	    WHEN 'coluna' THEN

			UPDATE PONTO_AVALIACAO
			SET CS_COLUNA = NVL2(CS_COLUNA, CS_COLUNA||'|'||PRM_VALOR, PRM_VALOR)
			WHERE CD_PONTO = UPPER(TRIM(PRM_NOME));

		WHEN 'agrupador' THEN

			UPDATE PONTO_AVALIACAO
			SET CS_AGRUPADOR = NVL2(CS_AGRUPADOR, CS_AGRUPADOR||'|'||PRM_VALOR, PRM_VALOR)
			WHERE CD_PONTO = UPPER(TRIM(PRM_NOME));

		WHEN 'pivot' THEN

			UPDATE PONTO_AVALIACAO
			SET CS_COLUP = NVL2(CS_COLUP, CS_COLUP||'|'||PRM_VALOR, PRM_VALOR)
			WHERE CD_PONTO = UPPER(TRIM(PRM_NOME));

	END CASE;
	
	UPDATE OBJECT_ATTRIB
	SET PROPRIEDADE = 1
	WHERE CD_PROP = 'ORDEM' AND
	CD_OBJECT = UPPER(TRIM(PRM_NOME));

END ALTER_CONSULTA;


PROCEDURE SAVE_CONSULTA ( PRM_VISAO       VARCHAR2 DEFAULT NULL,
                          PRM_NOME        VARCHAR2 DEFAULT NULL,
						  PRM_DESC        VARCHAR2 DEFAULT NULL,
						  PRM_COLUNA      VARCHAR2 DEFAULT NULL,
						  PRM_COLUP       VARCHAR2 DEFAULT NULL,
						  PRM_AGRUPADOR   VARCHAR2 DEFAULT NULL,
                          PRM_GRUPO       VARCHAR2 DEFAULT NULL,
                          PRM_RP          VARCHAR2 DEFAULT NULL,
						  PRM_FILTROS     VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT     NUMBER;
    WS_EXCEPTION EXCEPTION;
    WS_NOME      VARCHAR2(800);
    WS_DESC      VARCHAR2(800);
	WS_USUARIO   VARCHAR2(80);
	WS_ADMIN     VARCHAR2(80);
	WS_KEY       NUMBER := 0;
	WS_INC		 NUMBER := 0;
BEGIN
    BEGIN

		WS_USUARIO := GBL.GETUSUARIO;
		WS_ADMIN   := GBL.GETNIVEL;

        WS_NOME  := FUN.CONVERTE(PRM_NOME);
        WS_DESC  := FUN.CONVERTE(PRM_DESC);

		SELECT COUNT(*) INTO WS_COUNT FROM PONTO_AVALIACAO WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(WS_NOME));
		IF WS_COUNT = 1 THEN
            BEGIN
				UPDATE PONTO_AVALIACAO
				SET CS_COLUNA = PRM_COLUNA,
				CS_AGRUPADOR = PRM_AGRUPADOR,
				CS_COLUP = PRM_COLUP
				WHERE CD_PONTO = UPPER(TRIM(WS_NOME));
				UPDATE OBJECT_ATTRIB
				SET PROPRIEDADE = 1
				WHERE CD_PROP = 'ORDEM' AND
				CD_OBJECT = UPPER(TRIM(WS_NOME));
			EXCEPTION WHEN OTHERS THEN
			    RAISE WS_EXCEPTION;
			END;
		ELSIF WS_COUNT = 0 THEN
		    WS_NOME := REPLACE(UPPER(WS_NOME), ' ', '');
		    
			SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE UPPER(TRIM(CD_OBJETO)) = WS_NOME;

            IF WS_COUNT = 0 THEN
				BEGIN
					INSERT INTO PONTO_AVALIACAO VALUES(REPLACE(UPPER(WS_NOME), ' ', ''), WS_DESC, '', 'N', 'N', 'N', 'T', 'O', 'DWU', NULL, SYSDATE, PRM_VISAO, '', 'A', '', '1|1', PRM_COLUNA, PRM_AGRUPADOR, PRM_RP, PRM_COLUP);
					INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES (WS_NOME, PRM_GRUPO, WS_DESC, '', 'CONSULTA', WS_USUARIO, '', SYSDATE, '');
					INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', WS_NOME, 'TP_GRUPO', PRM_RP);
					INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', WS_NOME, 'ALTURA', '0');
					INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', WS_NOME, 'ORDEM', '1');
					INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', WS_NOME, 'FILTRO', 'PASSIVO');
					INSERT INTO OBJECT_ATTRIB VALUES('DWU', 'DEFAULT', 'DEFAULT', WS_NOME, 'TIMER', '0');

					IF NVL(PRM_FILTROS, 'N/A') <> 'N/A' THEN

					SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

					LOOP
					
						WS_INC := WS_INC+1;
					
						SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
					
						IF WS_COUNT > 0 THEN
							SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
						ELSE
							EXIT;
						END IF;
					END LOOP;
					
						FOR I IN(SELECT CD_COLUNA, CD_CONTEUDO, CD_CONDICAO FROM TABLE(FUN.VPIPE_PAR((PRM_FILTROS)))) LOOP
							
							INSERT INTO FILTROS (CD_USUARIO, CD_OBJETO, MICRO_VISAO, CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO, ST_AGRUPADO, CD_FILTRO, TP_FILTRO, CD_CRIADO)
							VALUES (WS_USUARIO, WS_NOME, PRM_VISAO, I.CD_COLUNA, I.CD_CONDICAO, I.CD_CONTEUDO, 'and', 'N', WS_KEY, 'objeto', WS_USUARIO);
							
							WS_KEY := WS_KEY+1;
						
						END LOOP;

					
					END IF;
				
				EXCEPTION WHEN OTHERS THEN
					RAISE WS_EXCEPTION;
				END;
			ELSE
                HTP.P('#alert ID j&aacute; existe!');
			END IF;
		ELSE
			HTP.P('#alert Erro ao inserir valores no ponto de avalia&ccedil;&atilde;o!');
		END IF;

	EXCEPTION
	WHEN WS_EXCEPTION THEN
	    ROLLBACK;
		HTP.P('#alert '||FUN.LANG('Erro ao salvar a consulta')||'!');
	WHEN OTHERS THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao salvar a consulta')||'!');
	END;
END SAVE_CONSULTA;


PROCEDURE REFRESH_SESSION AS

    WS_SESSION   OWA_COOKIE.COOKIE;
    WS_COUNT     NUMBER := 0;
	WS_LOGOUT    EXCEPTION;
	WS_SYSOUT    EXCEPTION;
	WS_USUARIO   VARCHAR2(80);

BEGIN
	
	IF NVL(FUN.RET_VAR('XE'), 'N') = 'N' THEN
		WS_SESSION := OWA_COOKIE.GET('SESSION');
		WS_USUARIO := FUN.GETSESSAO(WS_SESSION.VALS(1));
		
		

		IF NVL(WS_USUARIO, 'N/A') = 'N/A' THEN
			RAISE WS_LOGOUT;
		END IF;

		

		IF NOT FUN.CHECK_USER(WS_USUARIO) OR NOT FUN.CHECK_NETWALL(WS_USUARIO) OR FUN.CHECK_SYS <> 'OPEN' THEN
			RAISE WS_SYSOUT;
		END IF;

		UPDATE ACTIVE_SESSIONS T1 SET T1.DT_ATIVIDADE = SYSDATE 
		 WHERE T1.ID_SESSION = WS_USUARIO||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.') 
		   AND T1.STATUS 	 = 'A'; 
		IF SQL%NOTFOUND THEN 
			INSERT INTO ACTIVE_SESSIONS VALUES (WS_USUARIO||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.'), WS_USUARIO, SYSDATE, SYSDATE, 'A'); 
		END IF;    

		/* 
		MERGE INTO ACTIVE_SESSIONS T1
		USING (SELECT WS_USUARIO||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.') ID_SESSION FROM DUAL) T2 ON (T1.ID_SESSION = T2.ID_SESSION AND T1.STATUS = 'A')
		WHEN MATCHED THEN
			UPDATE SET DT_ATIVIDADE = SYSDATE WHERE T1.ID_SESSION = T2.ID_SESSION
		WHEN NOT MATCHED THEN
			INSERT VALUES (WS_USUARIO||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.'), WS_USUARIO, SYSDATE, SYSDATE, 'A'); 
		*/ 	
		COMMIT;
	END IF;

	HTP.P(99);

EXCEPTION 
	WHEN WS_SYSOUT THEN
		
		HTP.P('1');
		INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'FALHA DE ACESSO AO SISTEMA', WS_USUARIO, 'EVENTO');
		COMMIT;
		
		GBL.SETUSUARIO(TRIM(UPPER(WS_USUARIO)), '');
        
	WHEN WS_LOGOUT THEN
		
		HTP.P('0');
		INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'FIM DA SESS&Atilde;O', USER, 'EVENTO');
		COMMIT;
	WHEN OTHERS THEN
		HTP.P('0');
		

END REFRESH_SESSION;

PROCEDURE GUSUARIOS ( PRM_ORDER VARCHAR2 DEFAULT '1',
                      PRM_DIR   VARCHAR2 DEFAULT '1' ) AS

	CURSOR CRS_GRUPOS IS
	SELECT T1.CD_GROUP, T1.NM_GROUP, LISTAGG(T2.CD_USUARIO, '|') WITHIN GROUP (ORDER BY T1.CD_GROUP) GRUPO FROM GUSERS T1
	LEFT JOIN GUSERS_ITENS T2 ON T2.CD_GROUP = T1.CD_GROUP
	GROUP BY T1.CD_GROUP, T1.NM_GROUP
	ORDER BY
	    CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', T1.CD_GROUP, '2', T1.NM_GROUP, T1.CD_GROUP) END ASC,
		CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', T1.CD_GROUP, '2', T1.NM_GROUP, T1.CD_GROUP) END DESC;

	WS_GRUPO CRS_GRUPOS%ROWTYPE;
    WS_DIR      NUMBER := 1;
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
	WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(20);
	WS_NOACCESS EXCEPTION;

BEGIN

	WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	IF WS_ADMIN <> 'A' OR WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACCESS;
	END IF;

    HTP.P('<table class="linha">');
	HTP.P('<thead>');
	    HTP.P('<tr>');
			HTP.P('<th><a class="red" onclick="var dir = order('''', ''ajax''); ajax(''list'', ''gusuarios'', ''prm_order=1&prm_dir=''+dir, false, ''content'');">ID</a></th>');
			
			HTP.P('<th></th>');
			HTP.P('<th style="width: 12px;"></th>');
		HTP.P('</tr>');
	HTP.P('</thead>');

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

	IF TO_NUMBER(PRM_DIR) = 1 THEN WS_DIR := 2; END IF;

	HTP.P('<tbody id="ajax" data-dir="'||WS_DIR||'">');
		OPEN CRS_GRUPOS;
			LOOP
				FETCH CRS_GRUPOS INTO WS_GRUPO;
				EXIT WHEN CRS_GRUPOS%NOTFOUND;
				HTP.P('<tr>');
				    HTP.P('<td>'||FUN.UTRANSLATE('CD_GROUP', 'GUSERS', WS_GRUPO.CD_GROUP, WS_PADRAO)||'<a class="fakelang" onclick="/*fakeLang(this.previousElementSibling.id, ''GUSERS|CD_GROUP|''+this.previousElementSibling.title, ''cd'');*/">L</a></td>');
					
					
					


					HTP.P('<td style="padding-right: 8px;">');
						
					    HTP.P('<a class="script" onclick="call(''alter_gusuario'', ''prm_group='||WS_GRUPO.CD_GROUP||'&prm_usuario=''+document.getElementById(''lista-usuarios-'||WS_GRUPO.CD_GROUP||''').title).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
					     FCL.FAKEOPTION('lista-usuarios-'||WS_GRUPO.CD_GROUP, FUN.LANG('Usu&aacute;rios selecionados'), WS_GRUPO.GRUPO, 'lista-usuarios', 'N', 'S', '', FUN.LANG('Usu&aacute;rios selecionados'));
					HTP.P('</td>');
					HTP.P('<td>');
						FCL.BUTTON_LIXO('alter_gusuario','prm_group|prm_usuario', WS_GRUPO.CD_GROUP||'|'||'');	
					HTP.P('</td>');
					
				
				HTP.P('</tr>');
			END LOOP;
		CLOSE CRS_GRUPOS;
	HTP.P('</tbody>');

EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END GUSUARIOS;

PROCEDURE CREATE_GUSUARIOS( PRM_GRUPO VARCHAR2 DEFAULT NULL,
                            PRM_NOME  VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
    WS_FAIL  EXCEPTION;
	WS_GRUPO VARCHAR2(40);
	WS_NOME  VARCHAR2(80);

BEGIN
    
	WS_GRUPO := FUN.CONVERTE(PRM_GRUPO);
	WS_NOME  := FUN.CONVERTE(PRM_NOME);
    
    SELECT COUNT(*) INTO WS_COUNT FROM GUSERS
	WHERE CD_GROUP = UPPER(TRIM(WS_GRUPO));

	IF WS_COUNT = 0 THEN
	   
	    INSERT INTO GUSERS VALUES(UPPER(TRIM(WS_GRUPO)), TRIM(WS_NOME), SYSDATE);
	    
	    WS_COUNT := SQL%ROWCOUNT;	
	    	
	    IF WS_COUNT <> 0 THEN
	        
	        COMMIT;
	        
	        INSERT INTO TRADUCAO_COLUNAS VALUES('GUSERS', 'CD_GROUP', FUN.RET_VAR('LANG_SYS'), UPPER(TRIM(WS_GRUPO)), UPPER(TRIM(WS_GRUPO)), 'T', 'N');
		    INSERT INTO TRADUCAO_COLUNAS VALUES('GUSERS', 'NM_GROUP', FUN.RET_VAR('LANG_SYS'), TRIM(WS_NOME), TRIM(WS_NOME), 'T', 'N');
	        COMMIT;
	        
	    ELSE
	        RAISE WS_FAIL;
	    END IF;
		
	ELSE
	    RAISE WS_FAIL;
	END IF;

EXCEPTION 
    WHEN WS_FAIL THEN
        ROLLBACK;
        HTP.P('FAIL');
    WHEN OTHERS THEN
        ROLLBACK;
        HTP.P('FAIL');
END CREATE_GUSUARIOS;

PROCEDURE ALTER_GUSUARIO ( PRM_GROUP   VARCHAR2 DEFAULT NULL,
                           PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
	WS_GRUPO VARCHAR2(40);

BEGIN

	WS_GRUPO := FUN.CONVERTE(PRM_GROUP);
    
	IF NVL(PRM_USUARIO, 'N/A') = 'N/A' THEN
		
		DELETE FROM GUSERS_ITENS WHERE
		TRIM(CD_GROUP) = TRIM(WS_GRUPO);
		
		DELETE FROM GUSERS WHERE
		TRIM(CD_GROUP) = TRIM(WS_GRUPO);
		COMMIT; 
		
	ELSE
		
		DELETE FROM GUSERS_ITENS WHERE
		TRIM(CD_GROUP) = TRIM(WS_GRUPO);
		
		FOR I IN(SELECT COLUMN_VALUE FROM TABLE((FUN.VPIPE(PRM_USUARIO)))) LOOP
			INSERT INTO GUSERS_ITENS VALUES (WS_GRUPO, I.COLUMN_VALUE);
		END LOOP;
		COMMIT;
		
	END IF;
    
EXCEPTION WHEN OTHERS THEN
    HTP.P('FAIL');
    ROLLBACK;
END ALTER_GUSUARIO;

PROCEDURE ALTER_AGRUPADORES (  PRM_OBJETO      VARCHAR2 DEFAULT NULL,
                               PRM_AGRUPADORES VARCHAR2 DEFAULT NULL,
                               PRM_TIPO        VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT NUMBER;
BEGIN

    IF PRM_TIPO = 'AGRUPADORES' THEN
		SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_PROP = 'AGRUPADORES' AND CD_OBJECT = PRM_OBJETO;

		IF WS_COUNT = 1 THEN
			UPDATE OBJECT_ATTRIB SET PROPRIEDADE = PRM_AGRUPADORES WHERE CD_OBJECT = PRM_OBJETO AND CD_PROP = 'AGRUPADORES';
		ELSIF WS_COUNT = 0 THEN
			INSERT INTO OBJECT_ATTRIB VALUES ('DWU', 'DEFAULT', 'DEFAULT', PRM_OBJETO, 'AGRUPADORES', PRM_AGRUPADORES);
		ELSE
			HTP.P('#alerta Valores duplicados!');
		END IF;
	ELSIF PRM_TIPO = 'VISIVEL' THEN
	    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_PROP = 'VISIVEL' AND CD_OBJECT = PRM_OBJETO;

		IF WS_COUNT = 1 THEN
			UPDATE OBJECT_ATTRIB SET PROPRIEDADE = PRM_AGRUPADORES WHERE CD_OBJECT = PRM_OBJETO AND CD_PROP = 'VISIVEL';
		ELSIF WS_COUNT = 0 THEN
			INSERT INTO OBJECT_ATTRIB VALUES ('DWU', 'DEFAULT', 'DEFAULT', PRM_OBJETO, 'VISIVEL', PRM_AGRUPADORES);
		ELSE
			HTP.P('#alerta Valores duplicados!');
		END IF;
	ELSE
	    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_PROP = 'LIMITADORES' AND CD_OBJECT = PRM_OBJETO;

		IF WS_COUNT = 1 THEN
			UPDATE OBJECT_ATTRIB SET PROPRIEDADE = PRM_AGRUPADORES WHERE CD_OBJECT = PRM_OBJETO AND CD_PROP = 'LIMITADORES';
		ELSIF WS_COUNT = 0 THEN
			INSERT INTO OBJECT_ATTRIB VALUES ('DWU', 'DEFAULT', 'DEFAULT', PRM_OBJETO, 'LIMITADORES', PRM_AGRUPADORES);
		ELSE
			HTP.P('#alerta Valores duplicados!');
		END IF;
	END IF;

END ALTER_AGRUPADORES;

PROCEDURE TEXT_POST ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
				      PRM_LINE   VARCHAR2 DEFAULT NULL,
					  PRM_GROUP  VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT   NUMBER;
    WS_USUARIO VARCHAR2(80);

	WS_NOUSER  EXCEPTION;
BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	UPDATE CHECK_POST SET DT_CHECK = SYSDATE WHERE CD_USUARIO = WS_USUARIO AND NM_REMETENTE = PRM_GROUP;
    COMMIT;

		FOR I IN (SELECT TO_CHAR(RET_DATA,'DD/MM/YY HH24:MI') AS DT_MENSAGEM, RET_FROM AS FROM_USER, RET_TO AS TO_USER, DECRYPT(RET_MENSAGEM) AS TEXTO, RET_IDENT AS IDENT FROM TABLE(DECODE(PRM_OBJETO, NULL, FUN.LIST_ALL_POST, FUN.LIST_POST(PRM_OBJETO, PRM_LINE, PRM_GROUP))) WHERE RET_FROM <> 'SYS'
		AND 
			(RET_TO = PRM_GROUP AND RET_FROM = WS_USUARIO) OR (RET_FROM = PRM_GROUP AND RET_TO = WS_USUARIO) OR (TRIM(PRM_GROUP) IN (SELECT TRIM(CD_GROUP) FROM GUSERS_ITENS WHERE CD_USUARIO = WS_USUARIO) AND RET_TO = TRIM(PRM_GROUP))
		) LOOP
			

				IF TRIM(I.FROM_USER) = WS_USUARIO THEN
					HTP.P('<li class="user">');
					IF INSTR(I.TEXTO, 'jpg') <> 0 OR INSTR(I.TEXTO, 'png') <> 0 THEN
						HTP.P('<img class="texto" src="dwu.fcl.download?arquivo='||I.TEXTO||'" onclick="this.classList.toggle(''ex'');"/>');
					ELSE
						HTP.P('<span class="texto">'||I.TEXTO||'</span>');
					END IF;
					HTP.P('<span>'||WS_USUARIO||' '||I.DT_MENSAGEM||'</span>');
					
				ELSE
					HTP.P('<li class="other-user">');
					IF INSTR(I.TEXTO, 'jpg') <> 0 OR INSTR(I.TEXTO, 'png') <> 0 THEN
						HTP.P('<img class="texto" src="dwu.fcl.download?arquivo='||I.TEXTO||'" onclick="this.classList.toggle(''ex'');"/>');
					ELSE
						HTP.P('<span class="texto">'||I.TEXTO||'</span>');
					END IF;
					HTP.P('<span>'||TRIM(I.FROM_USER)||' '||I.DT_MENSAGEM||'</span>');
					
				END IF;

					FCL.BUTTON_LIXO('remove_post','prm_id', I.IDENT);	
				HTP.P('</li>');

		END LOOP;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
   		HTP.P('');
END TEXT_POST;

PROCEDURE INSERT_POST ( PRM_OBJETO  VARCHAR2 DEFAULT NULL,
                        PRM_SCREEN  VARCHAR2 DEFAULT NULL,
                        PRM_VISAO   VARCHAR2 DEFAULT NULL,
                        PRM_USUARIO VARCHAR2 DEFAULT NULL,
                        PRM_MSG     VARCHAR2 DEFAULT NULL,
                        PRM_TIME    NUMBER DEFAULT 30,
                        PRM_LINE    VARCHAR2 DEFAULT NULL,
                        PRM_EMAIL   CHAR DEFAULT 'N',
                        PRM_SMS     CHAR DEFAULT 'N',
                        PRM_FILTRO  VARCHAR2 DEFAULT NULL,
                        PRM_SHOW    VARCHAR2 DEFAULT 'Y',
                        PRM_ORIGEM  VARCHAR2 DEFAULT '$[NO_NAME]') AS

    WS_FILTRO  VARCHAR2(200);
    WS_COUNT   NUMBER;
    WS_ORIGEM  VARCHAR2(80);
	WS_EMAIL   VARCHAR2(80);

BEGIN

    FOR I IN( SELECT RTRIM(CD_COLUNA)||'|'||DECODE(RTRIM(CONDICAO),'IGUAL','$[IGUAL]','DIFERENTE','$[DIFERENTE]','MAIOR','$[MAIOR]','MENOR','$[MENOR]','MAIOROUIGUAL','$[MAIOROUIGUAL]','MENOROUIGUAL','$[MENOROUIGUAL]','LIKE','$[LIKE]','NOTLIKE','$[NOTLIKE]','$[IGUAL]')||RTRIM(CONTEUDO) AS FILTRO FROM FILTROS WHERE ((CD_OBJETO = PRM_OBJETO) OR (CD_OBJETO = PRM_SCREEN AND MICRO_VISAO = PRM_VISAO)) AND TP_FILTRO = 'objeto' ) LOOP
        WS_FILTRO := WS_FILTRO||'|'||I.FILTRO;
    END LOOP;

    WS_FILTRO := WS_FILTRO||'|'||TRIM(PRM_FILTRO);

    IF  PRM_ORIGEM = '$[NO_NAME]' THEN
        WS_ORIGEM := GBL.GETUSUARIO;
    ELSE
	    WS_ORIGEM := PRM_ORIGEM;
	END IF;

	SELECT COUNT_POST.NEXTVAL INTO WS_COUNT FROM DUAL;
	INSERT INTO TEXT_POST (OBJECT_ID, CD_USUARIO, CD_GROUP, DT_POST, TYPE_TEXT, TIME_LIVE, SELECT_LINE, BY_MAIL, BY_SMS, POST_ID, FILTRO) 
	VALUES (PRM_OBJETO, WS_ORIGEM, PRM_USUARIO, SYSDATE, ENCRYPT(FUN.CONVERTE(REPLACE(PRM_MSG, '(percent)', '%'))), NVL(PRM_TIME, 1), PRM_LINE, PRM_EMAIL, PRM_SMS, WS_COUNT, WS_FILTRO);
	FOR I IN(SELECT COLUMN_VALUE AS USUARIO FROM TABLE(FUN.VPIPE(PRM_USUARIO))) LOOP
		INSERT INTO CHECK_POST (ID_POST, CD_USUARIO, NM_REMETENTE) VALUES(WS_COUNT, I.USUARIO, WS_ORIGEM);
	END LOOP;
	COMMIT;

	/******* Desabilitado - opção de envio de email retirado da tela 
	IF PRM_EMAIL = 'S' THEN
	    IF PRM_USUARIO = 'todos' THEN
		    FOR I IN (SELECT USU_EMAIL FROM USUARIOS WHERE USU_NOME <> WS_ORIGEM) LOOP
				XSEND_MAIL('', I.USU_EMAIL,'TEXT-POST', FUN.CONVERTE(PRM_MSG));
			END LOOP;
		ELSE
		    SELECT COUNT(*) INTO WS_COUNT FROM USUARIOS WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_USUARIO));
			IF WS_COUNT = 0 THEN
			    FOR J IN (SELECT CD_USUARIO FROM GUSERS_ITENS WHERE UPPER(TRIM(CD_GROUP)) = UPPER(TRIM(PRM_USUARIO))) LOOP
				    SELECT USU_EMAIL INTO WS_EMAIL FROM USUARIOS WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(J.CD_USUARIO));
					XSEND_MAIL('', WS_EMAIL,'TEXT-POST', FUN.CONVERTE(PRM_MSG));
				END LOOP;
			ELSE
			    SELECT USU_EMAIL INTO WS_EMAIL FROM USUARIOS WHERE UPPER(TRIM(USU_NOME)) = UPPER(TRIM(PRM_USUARIO));
			    XSEND_MAIL('', WS_EMAIL,'TEXT-POST', FUN.CONVERTE(PRM_MSG));
			END IF;
		END IF;
	END IF;
	************************/

EXCEPTION WHEN OTHERS THEN
    HTP.P('FAIL');
END INSERT_POST;

PROCEDURE REMOVE_POST ( PRM_ID NUMBER DEFAULT NULL ) AS

WS_COUNT NUMBER;

BEGIN
    
    SELECT COUNT(*) INTO WS_COUNT FROM TEXT_POST WHERE POST_ID = PRM_ID;
    IF WS_COUNT = 1 THEN
        DELETE FROM TEXT_POST WHERE POST_ID = PRM_ID;
    ELSE
        HTP.P('!alert '||FUN.LANG('Imposs&iacute;vel excluir mensagem')||'!');
    END IF;
END REMOVE_POST;

PROCEDURE JS_LOG ( PRM_MSG VARCHAR2 DEFAULT NULL,
                   PRM_URL VARCHAR2 DEFAULT NULL,
                   PRM_LINE VARCHAR2 DEFAULT NULL,
                   PRM_TIPO VARCHAR2 DEFAULT 'ERRO' ) AS

BEGIN
    
    IF PRM_TIPO = 'ERRO' THEN
		IF INSTR(PRM_MSG, 'chartobject') = 0 THEN
			IF INSTR(PRM_MSG, 'TypeError:') = 0 THEN
				IF INSTR(PRM_MSG, 'InvalidStateError') = 0 THEN
					IF INSTR(PRM_MSG, 'INVALID_STATE_ERR: DOM Exception 11: An attempt was made to use an object that is not') = 0 THEN
                        INSERT INTO LOG_EVENTOS VALUES(SYSDATE, 'ERRO: '||PRM_MSG||' BROWSER: '||OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), USER, 'JS', PRM_TIPO, '01');
					END IF;
				END IF;
			END IF;
		END IF;
	ELSE
        INSERT INTO LOG_EVENTOS VALUES(SYSDATE, PRM_MSG, USER, 'JS', PRM_TIPO, '01');
	END IF;
END JS_LOG;

PROCEDURE LISTA_OBJETOS AS
  
  BEGIN

    HTP.P('<div class="itens">');
			
        HTP.P('<h2>'||FUN.LANG('LISTA DE OBJETOS')||'</h2>');

		HTP.P('<select style="max-width: calc(100% - 4px); width: calc(100% - 4px); margin: 2px;" id="obj_serch_tp" onchange="list_obj();">');
					HTP.P('<option value="N/A" selected disabled hidden>'||FUN.LANG('BUSCA POR TIPO')||'</option>');
					HTP.P('<option value="N/A">'||FUN.LANG('TODOS')||'</option>');
					HTP.P('<optgroup label="'||FUN.LANG('TIPOS')||'"/>');
					FOR I IN (SELECT TP_OBJETO AS TIPO, DECODE(TP_OBJETO, 'CALL_LIST', FUN.LANG('MENU'), 'IMAGE', FUN.LANG('IMAGEM'), 'SCREEN', FUN.LANG('TELA'), 'HEATMAP', FUN.LANG('MAPA DE CALOR'), TP_OBJETO) AS DESCRICAO FROM (SELECT DISTINCT(TP_OBJETO) FROM OBJETOS) WHERE TP_OBJETO <> 'SCRIPT' AND TP_OBJETO <> 'SCREEN' AND TP_OBJETO <> 'TEXTO' AND TP_OBJETO <> 'OBJETO' ORDER BY DESCRICAO ASC) LOOP
						HTP.P('<option value="'||I.TIPO||'">'||FUN.LANG(I.DESCRICAO)||'</option>');
					END LOOP;
				HTP.P('</select>');

				HTP.P('<select style="max-width: calc(100% - 4px); width: calc(100% - 4px); margin: 2px;" id="obj_serch_vw" onchange="list_obj();">');
					HTP.P('<option value="N/A" selected disabled hidden>'||FUN.LANG('BUSCAR PELA VIEW')||'</option>');
					HTP.P('<option value="N/A">'||FUN.LANG('TODOS')||'</option>');
					HTP.P('<optgroup label="VIEW"/>');
					FOR VISAO IN (SELECT NM_MICRO_VISAO FROM MICRO_VISAO ORDER BY NM_MICRO_VISAO ASC) LOOP
						HTP.P('<option value="'||VISAO.NM_MICRO_VISAO||'">'||VISAO.NM_MICRO_VISAO||'</option>');
					END LOOP;
				HTP.P('</select>');

				HTP.P('<select style="max-width: calc(100% - 4px); width: calc(100% - 4px); margin: 2px;" id="obj_serch_gp" onchange="list_obj();">');
					HTP.P('<option value="N/A" selected disabled hidden>'||FUN.LANG('BUSCAR PELO GRUPO')||'</option>');
					HTP.P('<option value="N/A">'||FUN.LANG('TODOS')||'</option>');
					HTP.P('<optgroup label="'||FUN.LANG('GRUPOS')||'"/>');
					FOR GRUPO IN (SELECT CD_GRUPO FROM GRUPOS_FUNCAO ORDER BY CD_GRUPO ASC) LOOP
						HTP.P('<option value="'||GRUPO.CD_GRUPO||'">'||GRUPO.CD_GRUPO||'</option>');
					END LOOP;
				HTP.P('</select>');

				HTP.P('<input style="max-width: calc(100% - 10px); width: calc(100% - 10px); margin: 2px;" type="text" value="" id="obj_serch_in" placeholder="'||FUN.LANG('BUSCAR PELA DESCRI&Ccedil;&Atilde;O')||'" onkeyup="list_obj();" />');


		HTP.P('<a class="addpurple" style="margin: 4px; width: calc(50% - 36px);" onclick="ajax(''quick'',''quick_create'',''prm_nome=TEXTO&prm_tipo=TEXTO&prm_parametros=&prm_visao=&prm_coluna=&prm_grupo=GERAL&prm_obj_ant=&prm_filtro='', false); noerror('''', TR_CR, ''feed-fixo'');" title="'||FUN.LANG('Novo texto')||'">'||FUN.LANG('TEXTO')||'</a>');
		HTP.P('<a class="addpurple" style="margin: 4px; width: calc(50% - 36px);" onclick="dashboard(document.getElementById(''current_screen'').value, ''newsection'');" id="section" title="'||FUN.LANG('Novo dashboard')||'">'||FUN.LANG('DASHBOARD')||'</a>');


		HTP.P('<ul id="ajax_obj"></ul>');

	HTP.P('</div>');

	FCL.CLOSER_MENU;

END LISTA_OBJETOS;



PROCEDURE FAKELIST ( PRM_IDENT  VARCHAR2 DEFAULT NULL,
                     PRM_TITULO VARCHAR2 DEFAULT NULL,
                     PRM_CAMPO  VARCHAR2 DEFAULT NULL,
                     PRM_VISAO  VARCHAR2 DEFAULT NULL,
					 PRM_REF    VARCHAR2 DEFAULT NULL ) AS

	WS_LOOP1      VARCHAR2(200);
	WS_LOOP2      VARCHAR2(200);
	WS_LOOP3      VARCHAR2(200);
	WS_TIPO       VARCHAR2(200);
	WS_TEXTO      VARCHAR2(200);
	WS_COUNT      NUMBER;
	WS_COUNTER    NUMBER;
	WS_FIXA       CHAR(1);
    WS_CURSOR	  INTEGER;
	WS_SQL		  VARCHAR2(2000);
	WS_CODIGO     VARCHAR2(2000);
	WS_DESCRICAO  VARCHAR2(2000);
	WS_LINHAS     INTEGER;
	WS_COR        VARCHAR2(400);
	PRM_CODIGO    VARCHAR2(200);
	PRM_DESCRICAO VARCHAR2(200);
	PRM_TABELA    VARCHAR2(200);
	WS_TABELA     VARCHAR2(200);
	WS_TITULO     VARCHAR2(800);
	WS_VISAO      VARCHAR2(800);
	WS_USUARIO    VARCHAR2(80);
	WS_PADRAO	  VARCHAR2(80) := 'PORTUGUESE';
	WS_NOUSER     EXCEPTION;

	BEGIN
	    
		WS_USUARIO := GBL.GETUSUARIO;

		IF WS_USUARIO = 'NOUSER' THEN
			RAISE WS_NOUSER;
		END IF;
        
        WS_TITULO  := FUN.CONVERTE(PRM_TITULO);
		WS_VISAO   := FUN.CONVERTE(PRM_VISAO);

		
        

		IF TRIM(PRM_CAMPO) = 'lang' THEN

			HTP.P('<div class="itens" data-save="false" style="width: 346px;">');
	    	HTP.P('<h2 class="fixed">'||FUN.LANG('LINGUAGEM')||'</h2>');
			HTP.P('<ul class="'||TRIM(PRM_CAMPO)||' form">');

		ELSE
        
			HTP.P('<ul class="'||TRIM(PRM_CAMPO)||'">');

		END IF;

		IF TRIM(PRM_CAMPO) = 'point' THEN

			HTP.P('<li>'||WS_TITULO||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title=".">'||FUN.LANG('ponto')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title=",">'||FUN.LANG('virgula')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="-">'||FUN.LANG('h&iacute;fen')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title=":">'||FUN.LANG('dois pontos')||'</li>');

		ELSIF TRIM(PRM_CAMPO) = 'consulta_dimensoes' THEN

		    BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;
			
			HTP.P('<ul id="coluna" data-tipo="coluna" class="dimensao" data-type="lista" style="float: left; background: #BBB; border: 1px solid #000; border-radius: 5px; padding: 3px; min-height: 38px; min-width: 116px;">');
				FOR I IN(SELECT NVL(COLUMN_VALUE, 'n/a') AS ITEM FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_IDENT))) WHERE COLUMN_VALUE <> 'n/a') LOOP
					HTP.P('<li onclick="swapColumn(this);" data-type="dimensao" class="linha" title="'||I.ITEM||'" >'||FUN.UTRANSLATE('NM_ROTULO', UPPER(TRIM(WS_VISAO)), FUN.NOME_COL(I.ITEM, PRM_VISAO), WS_PADRAO)||'<span>X</span></li>');
					HTP.P('<li onclick="swapSquare(this);" class="square"></li>');
				END LOOP;
			HTP.P('</ul>');
        ELSIF TRIM(PRM_CAMPO) = 'dashboards' THEN

		    HTP.P('<li style="font-size: 18px;">TELAS COM DASHBOARD</li>');
			FOR I IN(SELECT DISTINCT SCREEN FROM OBJECT_LOCATION T1 WHERE SCREEN LIKE ('SECTION_%') AND SCREEN NOT IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_VISAO)) LOOP
                
                SELECT SCREEN INTO WS_CODIGO FROM OBJECT_LOCATION WHERE OBJECT_ID = I.SCREEN AND ROWNUM = 1;
                SELECT NM_OBJETO INTO WS_DESCRICAO FROM OBJETOS WHERE CD_OBJETO = WS_CODIGO AND ROWNUM = 1;
                HTP.P('<li onclick="ajax(''fly'', ''dashboardcopy'', ''prm_dashboard=''+this.getAttribute(''data-screen'')+''&prm_actual='||PRM_IDENT||''', false); shscr(tela);" data-screen="'||I.SCREEN||'" title="'||FUN.LANG('Copiar dashboard desta tela')||'">'||WS_DESCRICAO||'</li>');
            END LOOP;

		ELSIF TRIM(PRM_CAMPO) = 'valoresbrowser' THEN

            HTP.P('<li>'||FUN.LANG('LISTA')||'</li>');
            SELECT NDS_CD_CODIGO, NDS_TFISICA, NDS_CD_DESCRICAO INTO WS_LOOP1, WS_LOOP2, WS_LOOP3 FROM CODIGO_DESCRICAO WHERE NDS_TABELA = UPPER(WS_VISAO) AND ROWNUM = 1;
            HTP.P('<li style="white-space: nowrap;"><input id="filter-value" placeholder="'||FUN.LANG('no m&iacute;nimo 3 caracteres para buscar')||'" type="text" style="width: 236px; max-width: 236px;" onkeyup="if(this.value.trim().length > 2 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||WS_LOOP1||'&prm_descricao='||WS_LOOP3||'&prm_tabela='||WS_LOOP2||'&prm_rownum=50&prm_text=''+this.value.trim()+''&prm_browser='||PRM_IDENT||''', true, ''fake_ajax'');}" /></li>');
			HTP.P('<li title="" onclick="document.getElementById('''||PRM_IDENT||''').parentNode.setAttribute(''data-v'', ''''); document.getElementById('''||PRM_IDENT||''').innerHTML = ''''; document.getElementById(''fakelist'').classList.toggle(''visible'');" >LIMPAR CAMPO</li>');
                HTP.P('<ul id="fake_ajax">');
                FCL.FAKEDATALIST(WS_LOOP1, WS_LOOP3, WS_LOOP2, 50, '', PRM_IDENT);
            HTP.P('</ul>');
		
		ELSIF TRIM(PRM_CAMPO) = 'favoritos' THEN

			HTP.P('<li>'||WS_TITULO||'</li>');
            HTP.P('<li class="nohover" style="height: 18px; margin-top: -22px;"><a class="fav closed" style="opacity: 1; right: 40px;" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); call_save(''''); curtain(''enabled''); document.getElementById(''titulo'').innerHTML = '''||PRM_TITULO||'''; call(''favoritar'', ''prm_objeto=&prm_nome=&prm_parametros=&prm_screen=''+tela+''&prm_acao=list'').then(function(resposta){document.getElementById(''content'').innerHTML = resposta; });"></a></li>');
			FOR I IN (SELECT CD_FAVORITO, DS_NOME, PARAMETROS, SCREEN, CD_OBJETO FROM FAVORITOS WHERE USUARIO = WS_USUARIO AND SCREEN = PRM_IDENT) LOOP
				HTP.P('<li class="fav" title="'||I.PARAMETROS||'" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); remover('''||I.CD_OBJETO||'trl''); appendar(''dwu.obj.show_objeto?prm_drill=Y&prm_objeto='||I.CD_OBJETO||'&prm_zindex=&prm_posx=''+cursorx+''px&prm_posy=''+cursory+''px&prm_screen='||I.SCREEN||'&prm_parametros='||I.PARAMETROS||''', '''', false); setTimeout(function(){ centerDrill('''||I.CD_OBJETO||'''); }, 200);">');
					
	                HTP.P('<a class="button">'||I.DS_NOME||'</a>');
	                
			    HTP.P('</li>');
            END LOOP;
            
		ELSIF TRIM(PRM_CAMPO) = 'condicao' THEN

			HTP.P('<li>'||WS_TITULO||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="IGUAL">'||FUN.LANG('igual')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="DIFERENTE">'||FUN.LANG('diferente')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="MAIOR">'||FUN.LANG('maior')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="MENOR">'||FUN.LANG('menor')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="MAIOROUIGUAL">'||FUN.LANG('maior ou igual')||'</li>');
			HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="MENOROUIGUAL">'||FUN.LANG('menor ou igual')||'</li>');

		ELSIF TRIM(PRM_CAMPO) = 'cdesc' THEN

			HTP.P('<li>'||WS_TITULO||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_cdesc''){ var ident = '''||REPLACE(PRM_IDENT, 'fake_cdesc_', '')||'''; document.getElementById(''fake_tipo_''+ident).setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo_''+ident).innerHTML=''LIGACAO''; call(''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=LIGACAO''); noerror('''', ''Campo alterado com sucesso!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_tipo'').setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo'').innerHTML=''LIGACAO''; if(document.getElementById(''ident'') && '''||PRM_IDENT||''' == ''fake_tipo''){ document.getElementById(''ident'').value = ''SEM''; } if(document.getElementById(ident+''_floatfilter'')){ document.getElementById(ident+''_floatfilter'').className = ''invisible''; }" title="SEM">SEM</li>');
			FOR I IN (SELECT NDS_TABELA, NDS_CD_CODIGO, NDS_CD_DESCRICAO FROM CODIGO_DESCRICAO ORDER BY NDS_TABELA ASC ) LOOP
				HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_cdesc''){ var ident = '''||REPLACE(PRM_IDENT, 'fake_cdesc_', '')||'''; document.getElementById(''fake_tipo_''+ident).setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo_''+ident).innerHTML=''LIGACAO''; call(''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor='||I.NDS_TABELA||'''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=LIGACAO''); noerror('''', ''Campo alterado com sucesso!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_tipo'').setAttribute(''title'', ''LIGACAO''); document.getElementById(''fake_tipo'').innerHTML=''LIGACAO''; if(document.getElementById(''ident'') && '''||PRM_IDENT||''' != ''fake_tipo''){ document.getElementById(''ident'').value = '''||I.NDS_CD_CODIGO||'''; } if(document.getElementById(ident+''_floatfilter'')){ if('''||I.NDS_CD_CODIGO||''' == ''SEM''){ document.getElementById(ident+''_floatfilter'').className = ''invisible''; } else { document.getElementById(ident+''_floatfilter'').className = ''link''; } }" title="'||I.NDS_TABELA||'">'||I.NDS_TABELA||'</li>');
			END LOOP;

		ELSIF TRIM(PRM_CAMPO) = 'cdesc2' THEN

			HTP.P('<li>Liga&ccedil;&atilde;o</li>');
			HTP.P('<li onclick="var ident = '''||REPLACE(PRM_IDENT, 'fake2_cdesc_value_', '')||'''; ajax(''fly'', ''save_column'', ''prm_visao='||PRM_TITULO||'&prm_name=''+ident+''&prm_campo=CD_LIGACAO&prm_valor=SEM''); fakeValue('''||PRM_IDENT||''', this); document.getElementById(ident).parentNode.parentNode.lastElementChild.children[0].click();" title="SEM">SEM</li>');
			FOR I IN (SELECT NDS_TABELA FROM CODIGO_DESCRICAO ORDER BY NDS_TABELA ASC ) LOOP
				HTP.P('<li onclick="var ident = '''||REPLACE(PRM_IDENT, 'fake2_cdesc_value_', '')||'''; ajax(''fly'', ''save_column'', ''prm_visao='||PRM_TITULO||'&prm_name=''+ident+''&prm_campo=CD_LIGACAO&prm_valor='||I.NDS_TABELA||'''); fakeValue('''||PRM_IDENT||''', this); document.getElementById(ident).parentNode.parentNode.lastElementChild.children[0].click();" title="'||I.NDS_TABELA||'">'||I.NDS_TABELA||'</li>');
			END LOOP;

		ELSIF TRIM(PRM_CAMPO) = 'section' THEN

		    HTP.P('<h2 class="fixed">'||WS_TITULO||'</h2>');
		    HTP.P('<ul class="form">');
			HTP.P('<li data-hint="Formato"><select onchange="dashboard(document.getElementById(''current_screen'').value, ''rowcolumn'', '''||PRM_IDENT||''',  this.value);">');
			    HTP.P('<option value="row" selected="">'||FUN.LANG('Horizontal')||'</option>');
			    HTP.P('<option value="column">'||FUN.LANG('Vertical')||'</option>');
			HTP.P('</select></li>');
			HTP.P('<a class="add" title="adicionar bloco" onclick="dashboard('''', ''insert'', '''||PRM_IDENT||''');">+</a>');
			
		    HTP.P(FUN.EXCLUIR_DASH(PRM_IDENT));

		ELSIF TRIM(PRM_CAMPO) = 'article' THEN

		    HTP.P('<li>'||WS_TITULO||'</li>');
			
		ELSIF TRIM(PRM_CAMPO) = 'visao' THEN
			
			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;
			
			HTP.P('<li>'||WS_TITULO||'</li>');
			FOR I IN (SELECT NM_MICRO_VISAO FROM MICRO_VISAO ORDER BY NM_MICRO_VISAO ASC ) LOOP
				HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="'||I.NM_MICRO_VISAO||'">'||FUN.UTRANSLATE('NM_MICRO_VISAO', 'MICRO_VISAO', I.NM_MICRO_VISAO, WS_PADRAO)||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'coluna' THEN
			HTP.P('<li>'||WS_TITULO||'</li>');
			FOR I IN (SELECT CD_COLUNA,NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VISAO ORDER BY NM_ROTULO ASC ) LOOP
				HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="'||I.CD_COLUNA||'">'||I.NM_ROTULO||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'template' THEN
			HTP.P('<li>'||FUN.LANG('Op&ccedil;&otilde;es do template')||'</li>');

			SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_PROP = 'TPT' AND OWNER = WS_USUARIO AND CD_OBJECT = PRM_IDENT;

			IF WS_COUNT = 0 THEN
				FOR I IN (SELECT COLUMN_VALUE AS VALOR, FUN.NOME_COL(COLUMN_VALUE, WS_VISAO, PRM_VISAO) AS NOME FROM TABLE(FUN.VPIPE((SELECT FORMULA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = WS_VISAO AND CD_COLUNA = PRM_IDENT)))) LOOP
					HTP.P('<li class="green" onclick="templateMarcado(this, '''||PRM_IDENT||''', '''||WS_VISAO||''');" title="'||I.VALOR||'">'||I.VALOR||' - '||I.NOME||'</li>');
				END LOOP;
			ELSE
				FOR I IN (SELECT COLUMN_VALUE AS VALOR, FUN.NOME_COL(COLUMN_VALUE, WS_VISAO, PRM_VISAO) AS NOME, DECODE((SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_PROP = 'TPT' AND OWNER = WS_USUARIO AND CD_OBJECT = PRM_IDENT AND SCREEN = PRM_VISAO))) WHERE COLUMN_VALUE = T1.COLUMN_VALUE), '', '', 'green') AS COLOR FROM TABLE(FUN.VPIPE((SELECT FORMULA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = WS_VISAO AND CD_COLUNA = PRM_IDENT))) T1) LOOP
					HTP.P('<li class="'||I.COLOR||'" onclick="templateMarcado(this, '''||PRM_IDENT||''', '''||WS_VISAO||''');" title="'||I.VALOR||'">'||I.VALOR||' - '||I.NOME||'</li>');
				END LOOP;
				


			END IF;

		ELSIF TRIM(PRM_CAMPO) = 'objetos' THEN
		    HTP.P('<div class="itens">');
			HTP.P('<li>'||WS_TITULO||'</li>');

			HTP.P('<li style="text-align: center; position: sticky; position: -webkit-sticky; top: 0; background-color: #CCC; width: auto; margin: 0; padding: 5px 0; cursor: default; border-radius: 0;">');
				HTP.P('<select style="max-width: 100%; width: 100%; margin: 2px;" id="obj_serch_tp" onchange="list_obj();">');
					HTP.P('<option value="N/A" selected disabled hidden>'||FUN.LANG('TIPOS')||'</option>');
					HTP.P('<option value="N/A">'||FUN.LANG('TODOS')||'</option>');
					HTP.P('<optgroup label="'||FUN.LANG('TIPOS')||'"/>');
					FOR I IN (SELECT TP_OBJETO AS TIPO, DECODE(TP_OBJETO, 'CALL_LIST', FUN.LANG('MENU'), 'IMAGE', FUN.LANG('IMAGEM'), 'SCREEN', FUN.LANG('TELA'), 'HEATMAP', FUN.LANG('MAPA DE CALOR'), TP_OBJETO) AS DESCRICAO FROM (SELECT DISTINCT(TP_OBJETO) FROM OBJETOS) WHERE TP_OBJETO <> 'SCRIPT' AND TP_OBJETO <> 'SCREEN' AND TP_OBJETO <> 'TEXTO' AND TP_OBJETO <> 'OBJETO' ORDER BY DESCRICAO ASC) LOOP
						
						HTP.P('<option value="'||I.TIPO||'">'||I.DESCRICAO||'</option>');
					END LOOP;
				HTP.P('</select>');

				HTP.P('<select style="max-width: 100%; width: 100%; margin: 2px;" id="obj_serch_vw" onchange="list_obj();">');
					HTP.P('<option value="N/A" selected disabled hidden>'||FUN.LANG('VIEW')||'</option>');
					HTP.P('<option value="N/A">'||FUN.LANG('TODOS')||'</option>');
					HTP.P('<optgroup label="VIEW"/>');
					FOR VISAO IN (SELECT NM_MICRO_VISAO FROM MICRO_VISAO ORDER BY NM_MICRO_VISAO ASC) LOOP
						HTP.P('<option value="'||VISAO.NM_MICRO_VISAO||'">'||VISAO.NM_MICRO_VISAO||'</option>');
					END LOOP;
				HTP.P('</select>');

				HTP.P('<select style="max-width: 100%; width: 100%; margin: 2px;" id="obj_serch_gp" onchange="list_obj();">');
					HTP.P('<option value="N/A" selected disabled hidden>'||FUN.LANG('GRUPOS')||'</option>');
					HTP.P('<option value="N/A">'||FUN.LANG('TODOS')||'</option>');
					HTP.P('<optgroup label="'||FUN.LANG('GRUPOS')||'"/>');
					FOR GRUPO IN (SELECT CD_GRUPO FROM GRUPOS_FUNCAO ORDER BY CD_GRUPO ASC) LOOP
						HTP.P('<option value="'||GRUPO.CD_GRUPO||'">'||GRUPO.CD_GRUPO||'</option>');
					END LOOP;
				HTP.P('</select>');

                









				HTP.P('<input style="max-width: 100%; width: 100%; margin: 2px; " type="text" value="" id="obj_serch_in" placeholder="'||FUN.LANG('Descri&ccedil;&atilde;o')||'" onkeyup="list_obj();" />');
			HTP.P('</li>');

			HTP.P('<li class="nohover" style="margin: 0; padding: 0; width: auto;">');

			HTP.P('<li class="addobj" onclick="ajax(''quick'',''quick_create'',''prm_nome=TEXTO&prm_tipo=TEXTO&prm_parametros=&prm_visao=&prm_coluna=&prm_grupo=GERAL&prm_obj_ant=&prm_filtro='', false); noerror('''', TR_CR, ''feed-fixo'');" title="Novo texto"><span class="newobj">'||FUN.LANG('TEXTO')||'</span></li>');
			HTP.P('<li class="addobj" onclick="dashboard(document.getElementById(''current_screen'').value, ''newsection'');" id="section" title="Novo dashboard"><span class="newobj">'||FUN.LANG('DASHBOARD')||'</span></li>');


			HTP.P('<ul id="ajax_obj"></ul>');
			HTP.P('</li>');

		ELSIF TRIM(PRM_CAMPO) = 'tabelas' THEN

			HTP.P('<li>'||WS_TITULO||'</li>');

            HTP.P('<li><input type="text" placeholder="'||FUN.LANG('NOME DA TABELA')||'" style="width: 180px; max-width: 180px;" /><a class="add" onclick="document.getElementById(''visao_tabela'').innerHTML = this.previousElementSibling.value; document.getElementById(''visao_tabela'').title = this.previousElementSibling.value;">+</a></li>');            

			WS_LOOP1 := 'never';
			FOR I IN (SELECT OBJECT_TYPE AS TIPO, OBJECT_NAME AS NOME FROM ALL_OBJECTS WHERE OWNER='DWU' AND (( UPPER(SUBSTR(OBJECT_NAME,1,3)) IN ('VM_','DW_', 'OPR', 'BI_')) OR (OBJECT_TYPE='VIEW' AND UPPER(SUBSTR(OBJECT_NAME,1,1))='V') OR (OBJECT_TYPE IN('TABLE','VIEW') AND UPPER(SUBSTR(OBJECT_NAME,1,5))='TAUX_'))  UNION ALL SELECT 'MICRO' AS TIPO, NM_MICRO_VISAO AS NOME FROM MICRO_VISAO ORDER BY TIPO, NOME ) LOOP
				IF WS_LOOP1 <> I.TIPO THEN
					WS_LOOP1 := I.TIPO;
					HTP.P('<li style="text-align: center; font-weight: bold; cursor: default; background: none !important;">'||WS_LOOP1||'</li>');
				END IF;
				HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''visao_tabela''){ ajax(''fly'', ''save_view'', ''prm_view='||PRM_IDENT||'&prm_valor='||I.NOME||'&prm_tipo=tabela''); noerror('''', ''Tabela alterada com sucesso!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this);" title="'||I.NOME||'">'||I.NOME||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'colunas-import' THEN

			HTP.P('<li>'||WS_TITULO||'</li>');

            HTP.P('<li><input type="text" placeholder="'||FUN.LANG('NOME DA COLUNA')||'" style="width: 180px; max-width: 180px;" /><a class="add" onclick="document.getElementById('''||WS_VISAO||'-coluna'').innerHTML = this.previousElementSibling.value; document.getElementById('''||WS_VISAO||'-coluna'').title = this.previousElementSibling.value;">+</a></li>');            

			FOR I IN ( SELECT COLUMN_NAME, DATA_TYPE FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = WS_VISAO ) LOOP
				HTP.P('<li onclick="document.getElementById('''||WS_VISAO||'-'||PRM_REF||'-'||PRM_TITULO||''').innerHTML = this.innerHTML; document.getElementById('''||WS_VISAO||'-'||PRM_REF||'-'||PRM_TITULO||''').title = this.innerHTML; call(''import_change'', ''prm_tabela='||WS_VISAO||'&prm_numero='||PRM_REF||'&prm_nome=''+document.getElementById('''||PRM_VISAO||'-'||PRM_REF||'-nome'').title+''&prm_destino=''+document.getElementById('''||WS_VISAO||'-'||PRM_REF||'-destino'').title+''&prm_tipo=''+document.getElementById('''||WS_VISAO||'-'||PRM_REF||'-tipo'').value+''&prm_trfs=''+document.getElementById('''||WS_VISAO||'-'||PRM_REF||'-trfs'').value+''&prm_op=UPDATE'', ''imp'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AL); } });">'||I.COLUMN_NAME||'</li>');
			END LOOP;	
		ELSIF TRIM(PRM_CAMPO) = 'grupo' THEN 
			
			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;
			
			HTP.P('<li>'||FUN.LANG('GRUPOS')||'</li>');
			FOR I IN (SELECT CD_GRUPO FROM GRUPOS_FUNCAO ORDER BY CD_GRUPO ASC) LOOP
				HTP.P('<li onclick="if(('''||PRM_IDENT||''' != ''fake_grupo'') && ('''||PRM_IDENT||''' != ''consulta_fake_grupo'')){ ajax(''fly'', ''save_view'', ''prm_view='||REPLACE(PRM_IDENT, '_grupo', '')||'&prm_valor='||I.CD_GRUPO||'&prm_tipo=grupo''); noerror('''', ''Grupo alterado com sucesso!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this);" title="'||I.CD_GRUPO||'">'||FUN.UTRANSLATE('CD_GRUPO', 'GRUPOS_FUNCAO', I.CD_GRUPO, WS_PADRAO)||'</li>');
			END LOOP;
			
		ELSIF TRIM(PRM_CAMPO) = 'tabs' THEN
			HTP.P('<li>'||WS_TITULO||'</li>');
			IF PRM_TITULO = 'EMPRESA' THEN
				HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="*">*</li>');
			END IF;
			FOR I IN (SELECT COLUMN_NAME FROM ALL_TAB_COLUMNS WHERE	OWNER='DWU' AND TABLE_NAME=PRM_VISAO ORDER BY COLUMN_NAME ) LOOP
				HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="'||I.COLUMN_NAME||'">'||I.COLUMN_NAME||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'tipo' THEN
			HTP.P('<li>'||WS_TITULO||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=SEM''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="SEM">'||FUN.LANG('Sem')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=ANO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="ANO">'||FUN.LANG('Ano')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=DATA''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="DATA">'||FUN.LANG('Data')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=DATA2''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="DATA2">'||FUN.LANG('Data sem calend&aacute;rio')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=INTEIRO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="INTEIRO">'||FUN.LANG('Inteiro')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=MES''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="MES">'||FUN.LANG('M&ecirc;s')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=NUMERICO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="NUMERICO">'||FUN.LANG('Numero')||'</li>');
			HTP.P('<li onclick="if('''||PRM_IDENT||''' != ''fake_tipo''){ ident = '''||REPLACE(PRM_IDENT, 'fake_tipo_', '')||'''; document.getElementById(''fake_cdesc_''+ident).setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc_''+ident).innerHTML=''SEM''; ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=tipo&prm_valor=TEXTO''); ajax(''fly'', ''alter_padrao'', ''prm_padrao=''+ident+''&prm_campo=ligacao&prm_valor=SEM''); noerror('''', '''||FUN.LANG('Campo alterado com sucesso')||'!'', ''msg''); } fakeValue('''||PRM_IDENT||''', this); document.getElementById(''fake_cdesc'').setAttribute(''title'', ''SEM''); document.getElementById(''fake_cdesc'').innerHTML=''SEM''; " title="TEXTO">'||FUN.LANG('Texto')||'</li>');
		ELSIF TRIM(PRM_CAMPO) = 'usuario' THEN
			HTP.P('<li>'||FUN.LANG('USU&Aacute;RIOS')||'</li>');
			
			WS_TIPO := 'N/A';
			
			FOR I IN (SELECT USU_NOME, USU_COMPLETO, STATUS, (SELECT COUNT(*) FROM GUSERS_ITENS WHERE CD_USUARIO = TRIM(USU_NOME) AND CD_GROUP = PRM_IDENT ) AS VALID FROM USUARIOS ORDER BY STATUS, USU_NOME ) LOOP
				
				IF WS_TIPO <> I.STATUS THEN
				    WS_TIPO := I.STATUS;
				    HTP.P('<li>'||I.STATUS||'</li>');
				END IF;
				
				IF I.VALID = 1 THEN
					HTP.P('<li id="'||I.USU_NOME||'_linha" class="green" onclick=" if(this.className == ''green''){ ajax(''fly'', ''alter_gusuario'', ''prm_group='||PRM_IDENT||'&prm_usuario='||TRIM(I.USU_NOME)||'&prm_tipo=d'', false); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } else { ajax(''fly'', ''alter_gusuario'', ''prm_group='||PRM_IDENT||'&prm_usuario='||TRIM(I.USU_NOME)||'&prm_tipo=u'', false); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } document.getElementById('''||I.USU_NOME||'_linha'').classList.toggle(''green'');" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				ELSE
					HTP.P('<li id="'||I.USU_NOME||'_linha" class="" onclick=" if(this.className != ''green''){ ajax(''fly'', ''alter_gusuario'', ''prm_group='||PRM_IDENT||'&prm_usuario='||TRIM(I.USU_NOME)||'&prm_tipo=u'', false); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } else { ajax(''fly'', ''alter_gusuario'', ''prm_group='||PRM_IDENT||'&prm_usuario='||TRIM(I.USU_NOME)||'&prm_tipo=d'', false); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } document.getElementById('''||I.USU_NOME||'_linha'').classList.toggle(''green'');" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				END IF;
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'img' THEN
			HTP.P('<li>'||FUN.LANG('ARQUIVOS')||'</li>');
			FOR I IN (SELECT NAME, DOC_SIZE FROM TAB_DOCUMENTOS WHERE USUARIO <> 'SYS' AND (NAME LIKE ('%.jp%') OR NAME LIKE ('%png')) ORDER BY NAME ASC, MIME_TYPE) LOOP
				HTP.P('<li id="'||I.NAME||'_linha" onclick="document.getElementById('''||PRM_IDENT||''').value = this.title; if('''||PRM_IDENT||'''.indexOf(''f-'') != -1){ objeto = '''||PRM_IDENT||'''.replace(''f-'', ''''); ajax(''fly'', ''update_file'', ''prm_objeto=''+objeto+''&prm_valor=''+this.title, false); noerror('''', ''Altera&ccedil;&atilde;o realizada com sucesso!'', ''msg''); } document.getElementById(''fakelist'').classList.toggle(''visible'');" title="dwu.fcl.download?arquivo='||I.NAME||'">'||I.NAME||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'hint' THEN
			HTP.P('<li>HINT</li>');
			FOR I IN (SELECT TP_OBJETO, CD_PROP, HINT FROM OBJECT_PADRAO ORDER BY TP_OBJETO, CD_PROP) LOOP
				HTP.P('<li id="'||I.TP_OBJETO||'-'||I.CD_PROP||'_linha" onclick="document.getElementById('''||PRM_IDENT||''').value = this.title; if('''||PRM_IDENT||'''.indexOf(''f-'') != -1){ objeto = '''||PRM_IDENT||'''.replace(''f-'', ''''); ajax(''fly'', ''update_file'', ''prm_objeto=''+objeto+''&prm_valor=''+this.title, false); noerror('''', ''Altera&ccedil;&atilde;o realizada com sucesso!'', ''msg''); } document.getElementById(''fakelist'').classList.toggle(''visible'');" title=""></li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'scolunas' THEN
			HTP.P('<li>'||FUN.LANG('COLUNAS')||'</li>');
			
			SELECT TP_OBJETO INTO WS_TIPO FROM OBJETOS WHERE CD_OBJETO = PRM_VISAO;
			
			FOR I IN (SELECT DISTINCT(NVL(COLUMN_VALUE, 'N/A')) AS COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO))) WHERE COLUMN_VALUE <> 'N/A' ORDER BY COLUMN_VALUE ASC) LOOP
				SELECT NM_ROTULO INTO WS_TEXTO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO AND ROWNUM = 1) AND CD_COLUNA = I.COLUMN_VALUE AND ROWNUM = 1;
				HTP.P('<li id="'||I.COLUMN_VALUE||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className == ''green''){ if(document.getElementById(''fakelist'').querySelectorAll(''.green'').length > 1){ document.getElementById('''||I.COLUMN_VALUE||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', '''||FUN.LANG('Coluna removida com sucesso')||'!'', ''msg'');} else { alerta(''msg'', '''||FUN.LANG('Gr&aacute;fico deve ter ao menos uma coluna')||'!''); } } else { document.getElementById('''||I.COLUMN_VALUE||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', ''Coluna adicionada com sucesso!'', ''msg''); }" title="'||I.COLUMN_VALUE||'">'||WS_TEXTO||' / '||I.COLUMN_VALUE||'');
				    





				HTP.P('</li>');
			END LOOP;
			FOR A IN (SELECT CD_COLUNA, NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO) AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR  FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO)))) AND ST_AGRUPADOR <> 'SEM' AND ST_AGRUPADOR <> 'TPT' ORDER BY CD_COLUNA ASC) LOOP
				HTP.P('<li id="'||A.CD_COLUNA||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className == ''green''){ if(document.getElementById(''fakelist'').querySelectorAll(''.green'').length > 1){ document.getElementById('''||A.CD_COLUNA||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', '''||FUN.LANG('Coluna removida com sucesso')||'!'', ''msg''); } else { alerta(''msg'', '''||FUN.LANG('Gr&aacute;fico deve ter ao menos uma coluna')||'!''); }} else { document.getElementById('''||A.CD_COLUNA||'_linha'').classList.toggle(''green''); agrupador = ''''; agrupadores = document.getElementById(''fakelist'').querySelectorAll(''.green''); for(i=0;i<agrupadores.length;i++){ agrupador = agrupador+agrupadores[i].title+''|''; } ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+agrupador+''&prm_tipo=objeto'', false); noerror('''', ''Coluna adicionada com sucesso!'', ''msg''); }" title="'||A.CD_COLUNA||'">'||A.NM_ROTULO||' / '||A.CD_COLUNA||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'scoluna' THEN
			HTP.P('<li>'||FUN.LANG('COLUNAS')||'</li>');
			FOR I IN (SELECT NVL(COLUMN_VALUE, 'N/A') AS COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO))) WHERE COLUMN_VALUE <> 'N/A' ORDER BY COLUMN_VALUE ASC) LOOP
				 SELECT NM_ROTULO INTO WS_TEXTO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO AND ROWNUM = 1) AND CD_COLUNA = I.COLUMN_VALUE AND ROWNUM = 1;
				HTP.P('<li id="'||I.COLUMN_VALUE||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+this.title+''|&prm_tipo=objeto'', false); }" title="'||I.COLUMN_VALUE||'">'||WS_TEXTO||' / '||I.COLUMN_VALUE||'</li>');
			END LOOP;
			FOR A IN (SELECT CD_COLUNA, NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO) AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO)))) AND ST_AGRUPADOR <> 'SEM' AND ST_AGRUPADOR <> 'TPT' ORDER BY CD_COLUNA ASC) LOOP
				HTP.P('<li id="'||A.CD_COLUNA||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+this.title+''|&prm_tipo=objeto'', false); }" title="'||A.CD_COLUNA||'">'||A.NM_ROTULO||' / '||A.CD_COLUNA||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'pcoluna' THEN
			HTP.P('<li>'||FUN.LANG('COLUNAS')||'</li>');
			FOR I IN (SELECT NVL(COLUMN_VALUE, 'N/A') AS COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT PARAMETROS FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO))) WHERE COLUMN_VALUE <> 'N/A' ORDER BY COLUMN_VALUE ASC) LOOP
				 SELECT NM_ROTULO INTO WS_TEXTO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO AND ROWNUM = 1) AND CD_COLUNA = I.COLUMN_VALUE AND ROWNUM = 1;
				HTP.P('<li id="'||I.COLUMN_VALUE||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+this.title+''|&prm_tipo='', false); }" title="'||I.COLUMN_VALUE||'">'||WS_TEXTO||' / '||I.COLUMN_VALUE||'</li>');
			END LOOP;
			FOR A IN (SELECT CD_COLUNA, NM_ROTULO FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO) AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE((SELECT PARAMETROS FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO)))) AND ST_AGRUPADOR <> 'SEM' AND ST_AGRUPADOR <> 'TPT' ORDER BY CD_COLUNA ASC) LOOP
				HTP.P('<li id="'||A.CD_COLUNA||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+this.title+''|&prm_tipo='', false); }" title="'||A.CD_COLUNA||'">'||A.NM_ROTULO||' / '||A.CD_COLUNA||'</li>');
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'colunav' THEN
			HTP.P('<li>'||FUN.LANG('COLUNAS')||'</li>');
			SELECT PARAMETROS INTO WS_LOOP1 FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO AND ROWNUM = 1;
			WS_LOOP1 := REPLACE(WS_LOOP1, '|', '');
			HTP.P('<li id="'||WS_LOOP1||'_linha" class="green" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+this.innerHTML+''|&prm_tipo=valor'', false); }" title="'||WS_LOOP1||'">'||WS_LOOP1||'</li>');

			FOR A IN (SELECT CD_COLUNA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO) AND ST_AGRUPADOR <> 'SEM' AND ST_AGRUPADOR <> 'TPT' AND CD_COLUNA <> WS_LOOP1) LOOP
				HTP.P('<li id="'||A.CD_COLUNA||'_linha" class="" onclick="document.getElementById(''fechar_sup'').setAttribute(''data-reloado'', '''||PRM_VISAO||'''); if(this.className != ''green''){ document.getElementById(''fakelist'').querySelector(''.green'').className = ''''; this.className = ''green''; ajax(''fly'', ''change_bar'', ''prm_obj='||PRM_VISAO||'&prm_agrupador=''+this.innerHTML+''|&prm_tipo=valor'', false); }" title="'||A.CD_COLUNA||'">'||A.CD_COLUNA||'</li>');
			END LOOP;
        ELSIF TRIM(PRM_CAMPO) = 'calculada' THEN

            HTP.P('<li class="fixed nohover">'||FUN.LANG('COLUNAS CALCULADAS')||'</li>');

            HTP.P('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''linha-dummy'').children[0].cloneNode(true); this.parentNode.parentNode.appendChild(linha); linha.children[0].className = ''calculos_n''; linha.children[1].className = ''calculos''; linha.children[2].className = ''remove''; linha.children[3].className = ''calculos_m''; ">'||FUN.LANG('ADICIONAR COLUNA')||'</a></li>');

            FOR I IN (SELECT COLUMN_VALUE AS VALOR, ROWNUM AS LINHA FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_VISAO,'CALCULADA'))))) LOOP 
                SELECT MASCARA INTO WS_LOOP2 FROM(SELECT COLUMN_VALUE AS MASCARA, ROWNUM AS LINHA FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_VISAO,'CALCULADA_M'))))) WHERE LINHA = I.LINHA;
                SELECT NOME INTO WS_LOOP3 FROM(SELECT COLUMN_VALUE AS NOME, ROWNUM AS LINHA FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_VISAO,'CALCULADA_N'))))) WHERE LINHA = I.LINHA;
                HTP.P('<li style="width: 94%; margin-bottom: 8px;">');
                    HTP.P('<input class="calculos_n" type="text" style="margin: 2px;" onblur="colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||''');" value="'||WS_LOOP3||'" placeholder="'||FUN.LANG('Nome')||'" />');
                    HTP.P('<input class="calculos" type="text" style="margin: 2px;" onblur="colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||''');" value="'||I.VALOR||'" placeholder="'||FUN.LANG('F&oacute;rmula')||'" />');
                    HTP.P('<a class="remove" onclick="if(confirm(TR_EX)){ this.parentNode.remove(); colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||'''); }">X</a>');
                    HTP.P('<input class="calculos_m" type="text" style="margin: 2px;" onblur="colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||''');" value="'||WS_LOOP2||'" placeholder="'||FUN.LANG('M&aacute;scara')||'" />');
                HTP.P('</li>');
            END LOOP;

            HTP.P('<span class="invisible" id="linha-dummy"><li style="width: 94%; margin-bottom: 8px;">');
                HTP.P('<input style="margin: 2px;" onblur="colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||''');" type="text" value="" placeholder="'||FUN.LANG('Nome')||'" />');
                HTP.P('<input style="margin: 2px;" onblur="colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||''');" type="text" value="" placeholder="'||FUN.LANG('F&oacute;rmula')||'" />');
                HTP.P('<a class="remove" onclick="if(confirm(TR_EX)){ this.parentNode.remove(); colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||'''); }">X</a>');
                HTP.P('<input style="margin: 2px;" onblur="colunasCalculo('''||PRM_VISAO||''', '''||WS_USUARIO||''');" type="text" value="" placeholder="'||FUN.LANG('M&aacute;scara')||'" />');
            HTP.P('</li></span>');
            
		ELSIF TRIM(PRM_CAMPO) = 'subquery' THEN

			HTP.P('<li class="fixed nohover">'||FUN.LANG('COLUNAS')||'</li>');

            HTP.P('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); this.parentNode.parentNode.insertBefore(linha, document.getElementById(''coress''));">'||FUN.LANG('ADICIONAR COLUNA')||'</a></li>');

			FOR I IN (SELECT COLUMN_VALUE AS COLUNA FROM TABLE(FUN.VPIPE((FUN.PUT_PAR(PRM_VISAO,'SUBQUERY', 'CONSULTA'))))) LOOP
				WS_COUNT := WS_COUNT+1;
				
				IF LENGTH(I.COLUNA) > 0 THEN
					HTP.P('<li class="nohover" data-counter="'||WS_COUNTER||'" title="'||WS_COUNT||'" id="'||I.COLUNA||'field" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
					    
	                    HTP.P('<select style="max-width: calc(100% - 34px); width: calc(100% - 34px);" onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''select''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].options[valores[i].selectedIndex].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=SUBQUERY&prm_value=''+total+''&prm_usuario='||WS_USUARIO||''', false);">');
							HTP.P('<option value="">-----</option>');
							FOR A IN (SELECT NM_ROTULO, CD_COLUNA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO) AND CD_COLUNA NOT IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO)))) AND ST_AGRUPADOR = 'SEM' ORDER BY CD_COLUNA) LOOP
								IF A.CD_COLUNA = I.COLUNA THEN
									HTP.P('<option selected onmouseover="document.getElementById(''fakelist'').className = ''visible'';" value="'||A.CD_COLUNA||'" title="'||A.CD_COLUNA||'">'||A.CD_COLUNA||' - '||A.NM_ROTULO||'</option>');
								ELSE
									HTP.P('<option onmouseover="document.getElementById(''fakelist'').className = ''visible'';" value="'||A.CD_COLUNA||'" title="'||A.CD_COLUNA||'">'||A.CD_COLUNA||' - '||A.NM_ROTULO||'</option>');
								END IF;
							END LOOP;
						HTP.P('</select>');
	                    FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'SUBQUERY'||'||'||USER);
					HTP.P('</li>');
                END IF;
			END LOOP;

            HTP.P('<li class="fixed nohover" id="coress" style="cursor: default; margin: 40px 6px 10px 6px; font-weight: bold; font-size: 18px; text-align: center; white-space: nowrap; color: var(--main-background); font-family: var(--fonte-primaria);">'||FUN.LANG('SEQU&Ecirc;NCIA DE CORES')||'</li>');
		    
            HTP.P('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-cor-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); linha.value = ''#FFFFFF''; this.parentNode.parentNode.insertBefore(linha, document.getElementById(''subquery-dummy-ul''));">'||FUN.LANG('ADICIONAR COR')||'</a></li>');

            WS_COUNT := 0;
            FOR A IN(SELECT COLUMN_VALUE AS COLUNA FROM TABLE(FUN.VPIPE((FUN.PUT_PAR(PRM_VISAO,'SUBQUERY-COR', 'CONSULTA'))))) LOOP
                WS_COUNT := WS_COUNT+1;
                WS_TEXTO := SUBSTR(A.COLUNA, 2, LENGTH(A.COLUNA)-1);
                IF LENGTH(A.COLUNA) > 0 THEN
	                HTP.P('<li class="nohover" data-counter="'||WS_COUNTER||'" title="'||WS_COUNT||'" id="'||A.COLUNA||'field" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
	                    HTP.P('<input style="max-width: calc(100% - 34px); width: calc(100% - 34px);" type="color" id="'||A.COLUNA||'_b" value="'||WS_TEXTO||'" onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''input''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].parentNode.title+valores[i].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=SUBQUERY-COR&prm_value=''+total+''&prm_usuario='||GBL.GETUSUARIO||''', false); ">');
	                    FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'SUBQUERY-COR'||'||'||USER);
	                HTP.P('</li>');
                END IF;
            END LOOP;

            HTP.P('<ul style="display: none;" id="subquery-dummy-ul">');
            
	            HTP.P('<li id="subquery-cor-dummy" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
		            HTP.P('<input style="max-width: calc(100% - 34px); width: calc(100% - 34px);" type="color"  onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''input''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].parentNode.title+valores[i].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=SUBQUERY-COR&prm_value=''+total+''&prm_usuario='||WS_USUARIO||''', false); ">');
		            FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'SUBQUERY-COR'||'||'||USER);
		        HTP.P('</li>');

                HTP.P('<li id="subquery-dummy" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
				   HTP.P('<select style="max-width: calc(100% - 34px); width: calc(100% - 34px);" onchange="var total = ''''; var valores = document.getElementById(''fakelist'').getElementsByTagName(''select''); for(i=0;i<valores.length-1;i++){ total = total+valores[i].options[valores[i].selectedIndex].value+''|''; } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=SUBQUERY&prm_value=''+total+''&prm_usuario='||WS_USUARIO||''', false);">');
						HTP.P('<option value="">-----</option>');
						FOR A IN (SELECT NM_ROTULO, CD_COLUNA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO) AND CD_COLUNA NOT IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_VISAO)))) AND ST_AGRUPADOR = 'SEM' ORDER BY CD_COLUNA) LOOP
							HTP.P('<option onmouseover="document.getElementById(''fakelist'').className = ''visible'';" value="'||A.CD_COLUNA||'" title="'||A.CD_COLUNA||'">'||A.CD_COLUNA||' - '||A.NM_ROTULO||'</option>');
						END LOOP;
					HTP.P('</select>');
	                FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'SUBQUERY'||'||'||USER);
				HTP.P('</li>');

            HTP.P('</ul>');

        ELSIF TRIM(PRM_CAMPO) = 'cor-coluna' THEN

			HTP.P('<li class="fixed nohover">'||FUN.LANG('COR DAS COLUNAS')||'</li>');

            HTP.P('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); linha.id = ''''; this.parentNode.parentNode.insertBefore(linha, document.getElementById(''coress''));">'||FUN.LANG('ADICIONAR LINHA')||'</a></li>');

			FOR I IN (SELECT COLUMN_VALUE AS COLUNA FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_VISAO,'COR-COLUNA'))))) LOOP
				WS_COUNT := WS_COUNT+1;
				
				IF LENGTH(I.COLUNA) > 0 THEN
					HTP.P('<li class="nohover" data-counter="'||WS_COUNTER||'" title="'||WS_COUNT||'" id="'||I.COLUNA||'field" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
	                    HTP.P('<input class="cor-coluna-valor" type="text" onblur="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-valor''); for(i=0;i<linhas.length;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=COR-COLUNA&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);" value="'||I.COLUNA||'"/>');
	                    HTP.P('<a class="remove" style="padding: 0; margin-top: -2px;" onclick="this.parentNode.remove(); var total = []; var linhas = document.getElementsByClassName(''cor-coluna-valor''); for(i=0;i<linhas.length;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=COR-COLUNA&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);">X</a>');
					HTP.P('</li>');
                END IF;
			END LOOP;

            HTP.P('<li class="fixed nohover" id="coress" style="cursor: default; margin: 40px 6px 10px 6px; font-weight: bold; font-size: 20px; text-align: center; white-space: nowrap;">'||FUN.LANG('SEQU&Ecirc;NCIA DE CORES')||'</li>');
		      
            HTP.P('<li style="text-align: center;" class="nohover"><a class="link" onclick="var linha = document.getElementById(''subquery-cor-dummy'').cloneNode(true); linha.setAttribute(''title'', document.getElementById(''fakelist'').children.length); linha.setAttribute(''data-counter'', document.getElementById(''fakelist'').children.length); linha.value = ''#FFFFFF''; this.parentNode.parentNode.insertBefore(linha, document.getElementById(''subquery-dummy-ul''));">'||FUN.LANG('ADICIONAR COR')||'</a></li>');

            FOR I IN (SELECT COLUMN_VALUE AS COLUNA FROM TABLE(FUN.VPIPE((FUN.GETPROP(PRM_VISAO,'COR-COLUNA-HEX'))))) LOOP
				WS_COUNT := WS_COUNT+1;
				
				IF LENGTH(I.COLUNA) > 0 THEN
					HTP.P('<li class="nohover" data-counter="'||WS_COUNTER||'" title="'||WS_COUNT||'" id="'||I.COLUNA||'field" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
	                    HTP.P('<input class="cor-coluna-cor" type="color" onblur="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-cor''); for(i=0;i<linhas.length-1;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=COR-COLUNA-HEX&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);" value="'||I.COLUNA||'"/>');
	                    FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'COR-COLUNA-HEX'||'|'||'+total.join(''|'')+'||'|'||USER);
					HTP.P('</li>');
                END IF;
			END LOOP;

            HTP.P('<ul style="display: none;" id="subquery-dummy-ul">');
            
	            HTP.P('<li id="subquery-cor-dummy" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
		            HTP.P('<input class="cor-coluna-cor" style="max-width: calc(100% - 34px); width: calc(100% - 34px);" type="color" onchange="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-cor''); for(i=0;i<linhas.length-1;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=COR-COLUNA-HEX&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false); " value="" />');
		            FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'COR-COLUNA-HEX'||'|'||'total'||'|'||USER);
		        HTP.P('</li>');

                HTP.P('<li id="subquery-dummy" data-visao="'||PRM_VISAO||'" style="width: 94%; margin-bottom: 8px;">');
				    HTP.P('<input class="cor-coluna-valor" type="text" onblur="var total = []; var linhas = document.getElementsByClassName(''cor-coluna-valor''); for(i=0;i<linhas.length-1;i++){ total.push(linhas[i].value); } ajax(''fly'', ''alter_attrib'', ''prm_objeto='||PRM_VISAO||'&prm_prop=COR-COLUNA&prm_value=''+total.join(''|'')+''&prm_usuario=DWU'', false);" value="" />');
				    FCL.BUTTON_LIXO('alter_attrib','prm_objeto|prm_prop|prm_value|prm_usuario', PRM_VISAO||'|'||'COR-COLUNA'||'|'||'+total+'||'|'||USER);
				HTP.P('</li>');

            HTP.P('</ul>');

		ELSIF TRIM(PRM_CAMPO) = 'lang' THEN
			WS_COUNT := 0;
			FOR A IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_VISAO))) LOOP
			  IF WS_COUNT = 0 THEN
				  WS_LOOP1 := A.COLUMN_VALUE;
			  ELSIF WS_COUNT = 1 THEN
				  WS_LOOP2 := A.COLUMN_VALUE;
			  ELSE
				  WS_LOOP3 := A.COLUMN_VALUE;
			  END IF;
			  WS_COUNT := WS_COUNT+1;
			END LOOP;

			SELECT COUNT(*) INTO WS_COUNT FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = WS_LOOP1 AND NM_ROTULO = WS_LOOP3;
			IF WS_COUNT = 1 THEN
				WS_TIPO := 'C';
			ELSE
				WS_TIPO := 'T';
			END IF;
			WS_COUNT := 0;
			SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = WS_LOOP1;
			IF WS_COUNT = 1 THEN
			  WS_TIPO := 'O';
			END IF;
			WS_COUNT := 0;

			HTP.P('<li id="default-local" data-value="'||WS_LOOP3||'" ></li>');
			BEGIN
			FOR I IN (SELECT CD_LANG, NM_LANG FROM LANGUAGE WHERE ATIVO = 'S') LOOP
				SELECT COUNT(*) INTO WS_COUNT FROM TRADUCAO_COLUNAS WHERE TRIM(CD_TABELA) = TRIM(WS_LOOP1) AND TRIM(CD_COLUNA) = TRIM(WS_LOOP2) AND TRIM(LANG_DEFAULT) = WS_LOOP3 AND TRIM(CD_LINGUAGEM) = TRIM(I.NM_LANG);
				
				IF WS_COUNT = 1 THEN
					SELECT TEXTO INTO WS_TEXTO FROM TRADUCAO_COLUNAS WHERE TRIM(CD_TABELA) = TRIM(WS_LOOP1) AND TRIM(CD_COLUNA) = TRIM(WS_LOOP2) AND TRIM(LANG_DEFAULT) = WS_LOOP3 AND TRIM(CD_LINGUAGEM) = TRIM(I.NM_LANG);
					SELECT FIXA INTO WS_FIXA FROM TRADUCAO_COLUNAS WHERE TRIM(CD_TABELA) = TRIM(WS_LOOP1) AND TRIM(CD_COLUNA) = TRIM(WS_LOOP2) AND TRIM(LANG_DEFAULT) = WS_LOOP3 AND TRIM(CD_LINGUAGEM) = TRIM(I.NM_LANG);
				ELSE
					WS_FIXA := 'E';
					WS_TEXTO := '';
				END IF;

				HTP.P('<li data-result="'||WS_COUNT||'" style="font-weight: bold;" class="nohover" data-attr="'||WS_LOOP1||'|'||WS_LOOP2||'|'||WS_LOOP3||'" id="'||I.CD_LANG||'">'||I.NM_LANG||'</li>');
				IF PRM_TITULO = 'cd' AND I.NM_LANG = FUN.RET_VAR('LANG_SYS') THEN
					HTP.P('<li class="nohover readonly"><input type="text" style="width: 155px; padding-right: 5px;" value="'||WS_TEXTO||'" readonly/>');
				ELSE
					HTP.P('<li class="nohover"><input type="text" style="width: 155px; padding-right: 5px;" onblur="" value="'||WS_TEXTO||'" /><a class="fakelang mini" onclick="var valor = this.previousElementSibling.value.trim(); valor = valor.replace(/\&#039;/g, ''''); valor = valor.replace(/&#034;/g, ''''); if(valor.length > 1){ ajax(''fly'', ''update_language'', ''prm_valor=''+valor+''&prm_tabela='||WS_LOOP1||'&prm_coluna='||WS_LOOP2||'&prm_linguagem='||I.NM_LANG||'&prm_default=''+document.getElementById(''default-local'').getAttribute(''data-value'')+''&prm_tipo='||WS_TIPO||''', false); noerror('''', ''Tradu&ccedil;&atilde;o alterada com sucesso!'', ''msg''); if(document.getElementById(''user-language'').value == '''||I.NM_LANG||'''){ if(document.getElementById('''||PRM_IDENT||''').tagName == ''INPUT''){ document.getElementById('''||PRM_IDENT||''').value = valor; } else { document.getElementById('''||PRM_IDENT||''').innerHTML = valor; }} if('''||I.NM_LANG||''' == '''||FUN.RET_VAR('LANG_SYS')||'''){ document.getElementById('''||PRM_IDENT||''').title = valor; document.getElementById(''default-local'').setAttribute(''data-value'', valor);} }">v</a>');
				END IF;
				IF WS_FIXA = 'S' THEN
					HTP.P('<input title="'||FUN.LANG('Fixar')||'" style="margin-left: 4px;" onchange="checkFix(''check'', this, '''||WS_LOOP1||''', '''||WS_LOOP2||''', '''||I.NM_LANG||''', document.getElementById(''default-local'').getAttribute(''data-value''), '''||WS_TIPO||''');" type="checkbox" checked/>');
				END IF;
				IF WS_FIXA = 'N' THEN
					HTP.P('<input title="'||FUN.LANG('Fixar')||'" style="margin-left: 4px;" onchange="checkFix(''check'', this, '''||WS_LOOP1||''', '''||WS_LOOP2||''', '''||I.NM_LANG||''', document.getElementById(''default-local'').getAttribute(''data-value''), '''||WS_TIPO||''');" type="checkbox" />');
				END IF;
				HTP.P('</li>');
			END LOOP;
			EXCEPTION WHEN OTHERS THEN
			HTP.P('Language '||SQLERRM);
			END;
		ELSIF TRIM(PRM_CAMPO) = 'agrupadores' THEN
			HTP.P('<li class="fixed">'||FUN.LANG('Agrupadores permitidos')||'</li>');
			FOR I IN(SELECT CD_COLUNA,NM_ROTULO FROM MICRO_COLUNA MC WHERE CD_MICRO_VISAO = PRM_VISAO AND ST_AGRUPADOR <> 'SEM' AND CD_COLUNA NOT IN(SELECT CD_COLUNA FROM COLUMN_RESTRICTION CR WHERE CR.CD_COLUNA = MC.CD_COLUNA AND USUARIO = WS_USUARIO AND CR.CD_MICRO_VISAO = PRM_VISAO)) LOOP
				WS_COUNT := 0;
				FOR B IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_IDENT AND CD_PROP = 'AGRUPADORES')))) LOOP
					IF B.COLUMN_VALUE = I.CD_COLUNA THEN
						WS_COUNT := WS_COUNT+1;
					END IF;
				END LOOP;
				IF WS_COUNT > 0 THEN
					HTP.P('<li id="'||I.CD_COLUNA||'_linha" data-valor="'||I.CD_COLUNA||'" class="green" onclick="document.getElementById('''||I.CD_COLUNA||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||I.CD_COLUNA||'">'||I.NM_ROTULO||'</li>');
				ELSE
					HTP.P('<li id="'||I.CD_COLUNA||'_linha" data-valor="'||I.CD_COLUNA||'" class="" onclick="document.getElementById('''||I.CD_COLUNA||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=AGRUPADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||I.CD_COLUNA||'">'||I.NM_ROTULO||'</li>');
				END IF;
			END LOOP;
		ELSIF TRIM(PRM_CAMPO) = 'visivel' THEN
			HTP.P('<li>'||FUN.LANG('Colunas invis&iacute;veis')||'</li>');
			FOR I IN(SELECT CD_COLUNA,NM_ROTULO FROM MICRO_COLUNA MC WHERE CD_MICRO_VISAO = PRM_VISAO  AND CD_COLUNA NOT IN(SELECT CD_COLUNA FROM COLUMN_RESTRICTION CR WHERE CR.CD_COLUNA = MC.CD_COLUNA AND USUARIO = WS_USUARIO AND CR.CD_MICRO_VISAO = PRM_VISAO) AND CD_COLUNA IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_IDENT))))) LOOP
				WS_COUNT := 0;
				FOR B IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_IDENT AND CD_PROP = 'VISIVEL')))) LOOP
					IF B.COLUMN_VALUE = I.CD_COLUNA THEN
						WS_COUNT := WS_COUNT+1;
					END IF;
				END LOOP;
				IF WS_COUNT <> 0 THEN
					HTP.P('<li id="'||I.CD_COLUNA||'_linha" data-valor="'||I.CD_COLUNA||'" class="green" onclick="document.getElementById('''||I.CD_COLUNA||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||I.NM_ROTULO||'">'||I.NM_ROTULO||'</li>');
				ELSE
					HTP.P('<li id="'||I.CD_COLUNA||'_linha" data-valor="'||I.CD_COLUNA||'" class="" onclick="document.getElementById('''||I.CD_COLUNA||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||I.NM_ROTULO||'">'||I.NM_ROTULO||'</li>');
				END IF;
			END LOOP;
		































		ELSIF TRIM(PRM_CAMPO) = 'limitadores' THEN
			HTP.P('<li>'||FUN.LANG('Valores bloqueados')||'</li>');
            BEGIN
				SELECT NDS_CD_CODIGO, NDS_TFISICA, NDS_CD_DESCRICAO INTO WS_LOOP1, WS_LOOP2, WS_LOOP3 FROM CODIGO_DESCRICAO WHERE (UPPER(NDS_TABELA) = UPPER(PRM_VISAO) OR UPPER(NDS_TFISICA) = UPPER(PRM_VISAO)) AND ROWNUM = 1;
				WS_SQL := 'select '||TRIM(WS_LOOP1)||', '||TRIM(WS_LOOP3)||' from '||TRIM(WS_LOOP2)||'';
				WS_CURSOR := DBMS_SQL.OPEN_CURSOR;
				DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);

				WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

				LOOP

					WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
					IF WS_LINHAS <> 1 THEN
						EXIT;
					END IF;

					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
					WS_COUNT := 0;
					SELECT COUNT(*) INTO WS_COUNT FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_PROP = 'LIMITADORES' AND CD_OBJECT = PRM_IDENT))) WHERE COLUMN_VALUE = WS_CODIGO;

					IF WS_COUNT > 0 THEN
						HTP.P('<li id="'||WS_CODIGO||'_linha" data-valor="'||WS_CODIGO||'" class="green" onclick="document.getElementById('''||WS_CODIGO||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||WS_DESCRICAO||'">'||WS_DESCRICAO||'</li>');
					ELSE
						HTP.P('<li id="'||WS_CODIGO||'_linha" data-valor="'||WS_CODIGO||'" class="" onclick="document.getElementById('''||WS_CODIGO||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=LIMITADORES'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||WS_DESCRICAO||'">'||WS_DESCRICAO||'</li>');
					END IF;

				END LOOP;
				DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - '||WS_SQL);
			END;
		ELSIF TRIM(PRM_CAMPO) = 'visivel' THEN
			HTP.P('<li class="fixed">'||FUN.LANG('Colunas invis&iacute;veis')||'</li>');
			FOR I IN(SELECT CD_COLUNA,NM_ROTULO FROM MICRO_COLUNA MC WHERE CD_MICRO_VISAO = PRM_VISAO  AND CD_COLUNA NOT IN(SELECT CD_COLUNA FROM COLUMN_RESTRICTION CR WHERE CR.CD_COLUNA = MC.CD_COLUNA AND USUARIO = WS_USUARIO AND CR.CD_MICRO_VISAO = PRM_VISAO) AND CD_COLUNA IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||'|'||CS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_IDENT))))) LOOP
				WS_COUNT := 0;
				FOR B IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_IDENT AND CD_PROP = 'VISIVEL')))) LOOP
					IF B.COLUMN_VALUE = I.CD_COLUNA THEN
						WS_COUNT := WS_COUNT+1;
					END IF;
				END LOOP;
				IF WS_COUNT <> 0 THEN
					HTP.P('<li id="'||I.CD_COLUNA||'_linha" data-valor="'||I.CD_COLUNA||'" class="green" onclick="document.getElementById('''||I.CD_COLUNA||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||I.NM_ROTULO||'">'||I.NM_ROTULO||'</li>');
				ELSE
					HTP.P('<li id="'||I.CD_COLUNA||'_linha" data-valor="'||I.CD_COLUNA||'" class="" onclick="document.getElementById('''||I.CD_COLUNA||'_linha'').classList.toggle(''green''); var agrupadores = ''''; var selecionados = this.parentNode.querySelectorAll(''.green''); for(a=0;a<selecionados.length;a++){ agrupadores = agrupadores+''|''+selecionados[a].getAttribute(''data-valor''); } if(this.className != ''green''){ ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna bloqueada!'', ''msg''); } else { ajax(''fly'', ''alter_agrupadores'', ''prm_objeto='||PRM_IDENT||'&prm_agrupadores=''+agrupadores+''&prm_tipo=VISIVEL'', false); noerror('''', ''Coluna desbloqueada!'', ''msg''); }" title="'||I.NM_ROTULO||'">'||I.NM_ROTULO||'</li>');
				END IF;
			END LOOP;

		ELSIF TRIM(PRM_CAMPO) = 'coluna-add' THEN
 
			CASE PRM_TITULO 
			WHEN 'coluna' THEN
				HTP.P('<li>COLUNA</li>');
				FOR A IN (SELECT DISTINCT(CD_COLUNA), NM_ROTULO FROM MICRO_COLUNA WHERE (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT') AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'n/a') AS CD_COLUNA FROM TABLE(FUN.VPIPE((PRM_IDENT)))) ORDER BY NM_ROTULO) LOOP
					HTP.P('<li title="'||A.CD_COLUNA||'" onclick="blocoConsulta(this, ''coluna'');">'||A.NM_ROTULO||'</li>');
				END LOOP;
			WHEN 'colunaa' THEN
				HTP.P('<li>OUTROS OBJETOS</li>');
				FOR A IN (SELECT DISTINCT(CD_COLUNA), NM_ROTULO FROM MICRO_COLUNA WHERE ST_AGRUPADOR = 'SEM' AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'n/a') AS CD_COLUNA FROM TABLE(FUN.VPIPE((PRM_IDENT)))) ORDER BY NM_ROTULO) LOOP
					HTP.P('<li title="'||A.CD_COLUNA||'" onclick="blocoConsulta(this);">'||A.NM_ROTULO||'</li>');
				END LOOP;
			WHEN 'group' THEN
				HTP.P('<li>COLUNAS</li>');
				FOR B IN (SELECT DISTINCT(CD_COLUNA), NM_ROTULO FROM MICRO_COLUNA WHERE (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT')  AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'n/a') AS CD_COLUNA FROM TABLE(FUN.VPIPE((PRM_IDENT)))) ORDER BY NM_ROTULO) LOOP
					HTP.P('<li title="'||B.CD_COLUNA||'" onclick="blocoConsulta(this, ''colunas'');">'||B.NM_ROTULO||'</li>');
				END LOOP;
			WHEN 'group-template' THEN
				HTP.P('<li>COLUNAS</li>');
				FOR B IN (SELECT DISTINCT(CD_COLUNA), NM_ROTULO FROM MICRO_COLUNA WHERE (ST_AGRUPADOR <> 'SEM' AND ST_AGRUPADOR <> 'TPT') AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'n/a') AS CD_COLUNA FROM TABLE(FUN.VPIPE((PRM_IDENT)))) ORDER BY NM_ROTULO) LOOP
					HTP.P('<li title="'||B.CD_COLUNA||'" onclick="this.style.setProperty(''display'', ''none''); var bloco = document.querySelector(''.medida''); var li = document.createElement(''li''); var span = document.createElement(''span''); span.innerHTML = ''X''; li.className = ''linha''; li.title=this.title; li.innerHTML = this.innerHTML; li.appendChild(span); li.setAttribute(''onclick'', ''swapColumn(this)''); li.style.setProperty(''margin'', ''3px auto''); bloco.appendChild(li); var square = document.createElement(''li''); square.className = ''square''; square.setAttribute(''onclick'', ''swapSquare(this)''); bloco.appendChild(square); var valores = document.querySelector(''.medida'').querySelectorAll(''.linha''); saveTpt(document.querySelector(''.medida''), '''||PRM_VISAO||''', '''||PRM_REF||''');">'||B.CD_COLUNA||' - '||B.NM_ROTULO||'</li>');
				END LOOP;
			ELSE
				HTP.P('<li>AGRUPADOR</li>');
				FOR I IN (SELECT DISTINCT(CD_COLUNA), NM_ROTULO FROM MICRO_COLUNA WHERE (ST_AGRUPADOR <> 'SEM' OR ST_AGRUPADOR = 'TPT') AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA NOT IN (SELECT NVL(COLUMN_VALUE, 'n/a') AS CD_COLUNA FROM TABLE(FUN.VPIPE((PRM_IDENT)))) ORDER BY NM_ROTULO) LOOP
					HTP.P('<li title="'||I.CD_COLUNA||'" onclick="blocoConsulta(this, ''colunac'');">'||I.NM_ROTULO||'</li>');
				END LOOP;
			END CASE;
		ELSIF TRIM(PRM_CAMPO) = 'browser-permissao' THEN
			HTP.P('<li>'||FUN.LANG('PERMISS&Atilde;O DE ESCRITA')||'</li>');
			BEGIN
				SELECT PERMISSAO INTO WS_SQL FROM DATA_COLUNA WHERE CD_MICRO_DATA = PRM_IDENT AND CD_COLUNA = PRM_TITULO ORDER BY PERMISSAO;
				FOR I IN ( SELECT USU_COMPLETO, USU_NOME FROM USUARIOS ORDER BY USU_NOME ) LOOP
				    BEGIN
				        SELECT COLUMN_VALUE INTO WS_TEXTO FROM TABLE(FUN.VPIPE((WS_SQL))) WHERE COLUMN_VALUE = I.USU_NOME;
				    EXCEPTION WHEN OTHERS THEN
				        WS_TEXTO := 'R'; 
				    END;
				    IF WS_TEXTO = 'R' THEN
					    HTP.P('<li id="'||I.USU_NOME||'_linha" class="" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''browser_permissao'', ''prm_micro_data='||PRM_IDENT||'&prm_coluna='||PRM_TITULO||'&prm_valor=''+arrl.join(''|''), ''BRO'').then(function(resposta){ console.log(''ok''); });" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				    ELSE
				        HTP.P('<li id="'||I.USU_NOME||'_linha" class="green" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''browser_permissao'', ''prm_micro_data='||PRM_IDENT||'&prm_coluna='||PRM_TITULO||'&prm_valor=''+arrl.join(''|''), ''BRO'').then(function(resposta){ console.log(''ok''); });" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				    END IF;
				END LOOP;
		    END;
		ELSIF TRIM(PRM_CAMPO) = 'browser-permissao-geral' THEN
			HTP.P('<li>'||FUN.LANG('BLOQUEIO DE A&Ccedil;&Otilde;ES')||'</li>');
			BEGIN
			    
			    BEGIN
				    SELECT PROPRIEDADE INTO WS_SQL FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_IDENT AND CD_PROP = 'PERMISSAO';
				EXCEPTION WHEN OTHERS THEN
				    WS_SQL := '';
				END;
				FOR I IN ( SELECT USU_COMPLETO, USU_NOME FROM USUARIOS ORDER BY USU_NOME ) LOOP
				    BEGIN
				        SELECT COLUMN_VALUE INTO WS_TEXTO FROM TABLE(FUN.VPIPE((WS_SQL))) WHERE COLUMN_VALUE = I.USU_NOME;
				    EXCEPTION WHEN OTHERS THEN
				        WS_TEXTO := 'R'; 
				    END;
				    IF WS_TEXTO = 'R' THEN
					    HTP.P('<li id="'||I.USU_NOME||'_linha" class="" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''alter_attrib'', ''prm_objeto='||PRM_IDENT||'&prm_prop=PERMISSAO&prm_value=''+arrl.join(''|'')+''&prm_usuario=DWU'', ''FCL'').then(function(resposta){ console.log(''ok''); });" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				    ELSE
				        HTP.P('<li id="'||I.USU_NOME||'_linha" class="green" onclick="this.classList.toggle(''green''); var lista = this.parentNode.querySelectorAll(''.green''); var arrl = []; for(i=0;i<lista.length;i++){ arrl.push(lista[i].innerHTML); } call(''alter_attrib'', ''prm_objeto='||PRM_IDENT||'&prm_prop=PERMISSAO&prm_value=''+arrl.join(''|'')+''&prm_usuario=DWU'', ''FCL'').then(function(resposta){ console.log(''ok''); });" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				    END IF;
				END LOOP;
		    EXCEPTION WHEN OTHERS THEN
		        HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		    END;
        ELSIF TRIM(PRM_CAMPO) = 'colunabrowser' THEN
            HTP.P('<li class="fixed">'||FUN.LANG('COLUNAS DISPONIVEIS')||'</li>');

            HTP.P('<li style="white-space: nowrap;"><input id="filter-value" placeholder="'||FUN.LANG('Digite para buscar ou inserir')||'" type="text" style="width: 180px; max-width: 180px;" onkeyup="if(this.value.trim().length < 1){ var valor = ''all'' } else { var valor = this.value.trim(); } ajax(''list'', ''fakedatalist'', ''prm_codigo=column_name&prm_descricao=column_name&prm_tabela='||PRM_VISAO||'&prm_rownum=&prm_text=''+valor, true, ''fake_ajax'');" />');
			HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');

           HTP.P('<ul id="fake_ajax">');

           BEGIN
               WS_SQL := 'select column_name from all_tab_columns where table_name = '''||PRM_VISAO||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||PRM_IDENT||''')';

               WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

               DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

               DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);

               WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

               LOOP
                   IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
                       EXIT;
                   END IF;

                   DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);

                   HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_CODIGO)||'</li>');

             END LOOP;

               DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
			EXCEPTION WHEN OTHERS THEN
			HTP.P(WS_SQL||' # '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
			END;

           HTP.P('</ul>');

        ELSIF TRIM(PRM_CAMPO) = 'browserdatalist' THEN
			HTP.P('<li class="fixed">'||WS_TITULO||'</li>');

				HTP.P('<li style="white-space: nowrap;"><input id="filter-value" type="text" style="width: 180px; max-width: 180px;" />');
			    HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');
                SELECT NM_TABELA INTO WS_LOOP3 FROM MICRO_DATA WHERE NM_MICRO_DATA = PRM_VISAO;
                BEGIN
                    SELECT TRIM(NDS_TFISICA) INTO WS_LOOP2 FROM CODIGO_DESCRICAO WHERE NDS_TABELA = WS_LOOP3;
	                IF LENGTH(WS_LOOP2) = 0 THEN
	                    WS_LOOP2 := WS_LOOP3;
	                END IF;
                EXCEPTION WHEN OTHERS THEN
                    WS_LOOP2 := WS_LOOP3;
                END;

                WS_SQL := 'select distinct '||PRM_IDENT||'  from '||WS_LOOP2||' order by '||PRM_IDENT||'';

				BEGIN

				HTP.P('<ul id="fake_ajax">');

					WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

					DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

					DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
					WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

					LOOP
						IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
							EXIT;
						END IF;
						WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
                        SELECT CD_LIGACAO INTO WS_LOOP1 FROM DATA_COLUNA WHERE CD_COLUNA = PRM_IDENT AND CD_MICRO_DATA = PRM_VISAO;
						DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
						IF TRIM(WS_CODIGO) = FUN.CDESC(TRIM(WS_CODIGO), WS_LOOP1) THEN
						    HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_CODIGO)||'</li>');
						ELSE
						    HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_CODIGO)||' - '||FUN.CDESC(TRIM(WS_CODIGO), WS_LOOP1)||'</li>');
						END IF;
					END LOOP;

					DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

				HTP.P('</ul>');

				EXCEPTION WHEN OTHERS THEN
					HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||WS_SQL);
				END;

		ELSIF TRIM(PRM_CAMPO) = 'datalist' THEN
			HTP.P('<li class="fixed">'||WS_TITULO||'</li>');

			SELECT CD_LIGACAO INTO WS_LOOP1 FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_IDENT AND CD_MICRO_VISAO = PRM_VISAO;

			IF WS_LOOP1 <> 'SEM' THEN

			SELECT NDS_TFISICA, NDS_CD_CODIGO, NDS_CD_DESCRICAO INTO PRM_TABELA, PRM_CODIGO, PRM_DESCRICAO FROM CODIGO_DESCRICAO WHERE NDS_TABELA = WS_LOOP1;

			HTP.P('<li style="white-space: nowrap;"><input id="filter-value" placeholder="'||FUN.LANG('no m&iacute;nimo 3 caracteres para buscar')||'" type="text" style="width: 180px; max-width: 180px;" onkeyup="if(this.value.trim().length > 2 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||PRM_CODIGO||'&prm_descricao='||PRM_DESCRICAO||'&prm_tabela='||PRM_TABELA||'&prm_rownum=&prm_text=''+this.value.trim(), true, ''fake_ajax'');} checkPar(this.id, '''||PRM_VISAO||''');" />');
			HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');

				WS_LOOP3 := '51';

				WS_SQL := 'select '||PRM_CODIGO||', '||PRM_DESCRICAO||', linha from (select '||PRM_CODIGO||', '||PRM_DESCRICAO||', rownum as linha from (select /*+ FIRST_ROWS(50) */ '||PRM_CODIGO||', '||PRM_DESCRICAO||' from '||PRM_TABELA||' order by '||PRM_DESCRICAO||' asc)) where linha < '||WS_LOOP3||'';

				BEGIN

				HTP.P('<ul id="fake_ajax">');

					WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

					DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

					DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
					DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);
					WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

					LOOP
						IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
							EXIT;
						END IF;
						WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
						DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
						DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
						HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_DESCRICAO)||'</li>');
					END LOOP;

					DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

					IF WS_COUNT = 50 THEN
						HTP.P('<li style="font-weight: bold !important; text-align: center !important;" id="load-more" class="link" title="'||FUN.LANG('Carregar mais 50')||'" onclick="remover(''load-more'', ''r''); var numero = parseInt(document.getElementById(''fake_ajax'').children.length)+50; ajax(''main'', ''fakedatalist'', ''prm_codigo='||PRM_CODIGO||'&prm_descricao='||PRM_DESCRICAO||'&prm_tabela='||PRM_TABELA||'&prm_rownum=''+numero+''&prm_text=N/A'', true, ''fake_ajax'');">'||FUN.LANG('carregar')||' mais 50</li>');
					END IF;
				HTP.P('</ul>');

				EXCEPTION WHEN OTHERS THEN
					HTP.P(DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||WS_SQL);
				END;

			ELSE
				HTP.P('<li style="white-space: nowrap;"><input type="text" style="width: 180px; max-width: 180px;" />');
				HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor; document.getElementById(''fakelist'').className = '''';">+</a></li>');
			END IF;

		ELSIF TRIM(PRM_CAMPO) = 'consultas' THEN
			HTP.P('<li>CONSULTAS</li>');
				FOR B IN (SELECT CD_OBJETO, NM_OBJETO, (SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = CD_OBJETO AND ROWNUM = 1) AS VISAO FROM OBJETOS WHERE TP_OBJETO = 'CONSULTA' ORDER BY NM_OBJETO ASC) LOOP
					HTP.P('<li title="'||B.CD_OBJETO||'" onclick=" if(document.getElementById(''id_CHAMADA1'')){ document.getElementById(''id_CHAMADA1'').value = this.title; } if(document.getElementById(''id_CHAMADA2'')){ document.getElementById(''id_CHAMADA2'').value = this.title; } document.getElementById('''||PRM_IDENT||''').title = this.title; document.getElementById('''||PRM_IDENT||''').innerHTML = this.innerHTML;">'||B.NM_OBJETO||' / '||B.VISAO||'</li>');
				END LOOP;

		ELSIF TRIM(PRM_CAMPO) = 'sinais' THEN
			HTP.P('<li class="fixed">'||WS_TITULO||'</li>');

			HTP.P('<li>');
				HTP.P(''||FUN.LANG('Imagem')||': <select class="p_tp_sinal" onchange=" document.getElementById(''sin1'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_1.png''; document.getElementById(''sin2'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_2.png''; document.getElementById(''sin3'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_3.png''; document.getElementById(''sin4'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_4.png''; document.getElementById(''sin5'').src=''dwu.fcl.download?arquivo=ind''+this.options[this.selectedIndex].value+''_5.png'';" >');
					FCL.NUMERICOPTIONS(9);
				HTP.P('</select>');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<img src="dwu.fcl.download?arquivo=ind1_1.png" />');
				HTP.P('<input type="text" value="" size="30" maxlength="80" >');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<img src="dwu.fcl.download?arquivo=ind1_2.png" />');
				HTP.P('<input type="text" value="" size="30" maxlength="80" >');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<img src="dwu.fcl.download?arquivo=ind1_3.png" />');
				HTP.P('<input type="text" value="" size="30" maxlength="80" >');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<img src="dwu.fcl.download?arquivo=ind1_4.png" />');
				HTP.P('<input type="text" value="" size="30" maxlength="80" >');
			HTP.P('</li>');

			HTP.P('<li>');
				HTP.P('<img src="dwu.fcl.download?arquivo=ind1_5.png" />');
				HTP.P('<input type="text" value="" size="30" maxlength="80" >');
			HTP.P('</li>');

		ELSIF TRIM(PRM_CAMPO) = 'screengroup' THEN
			
			FOR I IN(SELECT DISTINCT CD_GRUPO FROM OBJETOS WHERE TP_OBJETO='SCREEN' AND CD_GRUPO IN (SELECT CD_GRUPO FROM OBJETOS WHERE CD_OBJETO IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = USER)) ORDER BY CD_GRUPO) LOOP
                HTP.P('<li class="screeen group" onclick="fakeOption(''screenlist'', ''TABELAS'', ''screenlist'', '''||I.CD_GRUPO||''');">');
					HTP.P('<span>'||LOWER(I.CD_GRUPO)||'</span>');
	                HTP.P('<svg class="down" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" 	 width="292.362px" height="292.362px" viewBox="0 0 292.362 292.362" style="enable-background:new 0 0 292.362 292.362;" 	 xml:space="preserve"> <g> 	<path d="M286.935,69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952,0-9.233,1.807-12.85,5.424 		C1.807,72.998,0,77.279,0,82.228c0,4.948,1.807,9.229,5.424,12.847l127.907,127.907c3.621,3.617,7.902,5.428,12.85,5.428 		s9.233-1.811,12.847-5.428L286.935,95.074c3.613-3.617,5.427-7.898,5.427-12.847C292.362,77.279,290.548,72.998,286.935,69.377z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>'); 
				HTP.P('</li>');
			END LOOP;

        ELSIF TRIM(PRM_CAMPO) = 'screenlist' THEN

		    FOR I IN(SELECT CD_OBJETO, NM_OBJETO FROM OBJETOS WHERE CD_GRUPO = PRM_REF AND CD_OBJETO LIKE ('SRC_%') AND CD_OBJETO IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = WS_USUARIO)) LOOP
                HTP.P('<li class="screeen">');
					HTP.P('<span title="'||I.CD_OBJETO||'">'||LOWER(I.NM_OBJETO)||'</span>');
				HTP.P('</li>');
			END LOOP;

		ELSIF TRIM(PRM_CAMPO) = 'filelist' THEN
			HTP.P('<li>'||WS_TITULO||'</li>');
			HTP.P('<li style="white-space: nowrap;"><input placeholder="'||FUN.LANG('no m&iacute;nimo 3 caracteres para buscar')||'" type="text" style="width: 180px; max-width: 180px;" onkeyup="if(this.value.trim().length > 2 || this.value.trim().length == 0){ ajax(''list'', ''fakedatalist'', ''prm_codigo='||PRM_CODIGO||'&prm_descricao='||PRM_DESCRICAO||'&prm_tabela='||PRM_TABELA||'&prm_rownum=&prm_text=''+this.value, true, ''fake_ajax''); } " /><a title="'||FUN.LANG('Adicionar')||'" class="add" onclick="var span = document.getElementById(''fake_datalist''); var valor = this.previousElementSibling.value.trim(); span.title = valor; span.innerHTML = valor;">+</a></li>');

				HTP.P('<ul id="fake_ajax">');
					HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_DESCRICAO)||'</li>');
				HTP.P('</ul>');
		ELSIF TRIM(PRM_CAMPO) = 'usuarios-tela' THEN
            
			HTP.P('<li>'||FUN.LANG('USU&Aacute;RIOS')||'</li>');
			FOR I IN (SELECT USU_NOME, USU_COMPLETO, (SELECT COUNT(*) FROM USER_SCREENS WHERE USUARIO = TRIM(USU_NOME) AND SCREEN = PRM_IDENT ) AS VALID FROM USUARIOS ORDER BY USU_NOME ) LOOP
				IF I.VALID = 1 THEN
					HTP.P('<li id="'||I.USU_NOME||'_linha" class="green" onclick=" if(this.className == ''green''){ ajax(''fly'', ''delete_screen_access'', ''prm_usuario='||TRIM(I.USU_NOME)||'&prm_tela='||PRM_IDENT||'''); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } else { ajax(''fly'', ''add_screen_access'', ''prm_usuario='||TRIM(I.USU_NOME)||'&prm_tela='||PRM_IDENT||''', true); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } document.getElementById('''||I.USU_NOME||'_linha'').classList.toggle(''green'');" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				ELSE
					HTP.P('<li id="'||I.USU_NOME||'_linha" class="" onclick=" if(this.className != ''green''){ ajax(''fly'', ''add_screen_access'', ''prm_usuario='||TRIM(I.USU_NOME)||'&prm_tela='||PRM_IDENT||''', true); noerror('''', ''Usu&aacute;rio adicionado com sucesso!'', ''msg''); } else { ajax(''fly'', ''delete_screen_access'', ''prm_usuario='||TRIM(I.USU_NOME)||'&prm_tela='||PRM_IDENT||''', true); noerror('''', ''Usu&aacute;rio removido com sucesso!'', ''msg''); } document.getElementById('''||I.USU_NOME||'_linha'').classList.toggle(''green'');" title="'||I.USU_COMPLETO||'">'||I.USU_NOME||'</li>');
				END IF;
			END LOOP;
            HTP.P('<li onclick=""></li>');
        ELSE
			HTP.P('<li>'||WS_TITULO||'</li>');
			FOR I IN (SELECT CD_MASCARA, DS_MASCARA FROM MASCARAS ORDER BY CD_MASCARA DESC ) LOOP
				HTP.P('<li onclick="fakeValue('''||PRM_IDENT||''', this);" title="'||I.DS_MASCARA||'">'||I.CD_MASCARA||'</li>');
			END LOOP;
		END IF;
        HTP.P('</ul>');

		IF TRIM(PRM_CAMPO) = 'lang' THEN
			HTP.P('</div>');
			FCL.CLOSER_MENU;
		END IF;

EXCEPTION
	WHEN WS_NOUSER THEN
		HTP.P('Sem premiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END FAKELIST;


PROCEDURE FAKELISTOPTIONS ( PRM_IDENT     VARCHAR2 DEFAULT NULL,
		                    PRM_CAMPO     VARCHAR2 DEFAULT NULL,
		                    PRM_VISAO     VARCHAR2 DEFAULT NULL,
							PRM_REF       VARCHAR2 DEFAULT NULL,
							PRM_ADICIONAL VARCHAR2 DEFAULT NULL,
							PRM_SEARCH    VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT         NUMBER;
    WS_SELECTED      NUMBER;
	WS_REVERSE       NUMBER;
    WS_CURSOR        INTEGER;
    WS_LINHAS        INTEGER;
	WS_CHECK         VARCHAR2(80);
    WS_ORDER         VARCHAR2(80);
    WS_GRUPO         VARCHAR2(40);
    WS_TABELA        VARCHAR2(80);
    WS_CODIGO        VARCHAR2(80);
    WS_LIMITADOR     VARCHAR2(2000);
    WS_DESCRICAO     VARCHAR2(400);
    WS_LIGACAO       VARCHAR2(400);
    WS_SQL           VARCHAR2(12000);
	WS_SEARCH        VARCHAR2(1000);
	WS_ACUMULADO     VARCHAR2(12000);
	ws_erro          VARCHAR2(400);
	WS_CLASS         VARCHAR2(400);
	WS_VALUE         VARCHAR2(400);
	WS_ROTULO        VARCHAR2(200);
	WS_ENCADEADO_COL VARCHAR2(80);
	WS_ENCADEADO     VARCHAR2(80);
	WS_CONTEUDO      VARCHAR2(80);
	WS_USUARIO       VARCHAR2(80);
	WS_ADMIN         VARCHAR2(80);
	WS_PADRAO        VARCHAR2(80) := 'PORTUGUESE';

	WS_NOUSER		 EXCEPTION;

	PROCEDURE NESTED_TEST_LIST ( PRM_REF  VARCHAR2 DEFAULT NULL,
                                 PRM_ID   VARCHAR2 DEFAULT NULL,
						         PRM_NOME VARCHAR2 DEFAULT NULL,
								 PRM_FIXO VARCHAR2 DEFAULT NULL,
								 PRM_COD  VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT  NUMBER;
	WS_ROTULO VARCHAR2(200);



	
	BEGIN
		SELECT COUNT(*) INTO WS_COUNT FROM TABLE((FUN.VPIPE(PRM_REF))) WHERE '|'||TRIM(COLUMN_VALUE)||'|' = '|'||TRIM(PRM_ID)||'|';

		WS_ROTULO := PRM_NOME;

		IF NVL(PRM_FIXO, 'N/A') <> 'N/A' THEN
            WS_ROTULO := PRM_FIXO;
		ELSE
			IF PRM_ID <> PRM_NOME THEN
				WS_ROTULO := NVL(PRM_COD, PRM_ID)||' - '||PRM_NOME;
			END IF;
		END IF;

		IF WS_COUNT > 0 THEN
			HTP.P('<li title="'||PRM_ID||'" class="opt selected">'||WS_ROTULO||'</li>');
		ELSE
			HTP.P('<li title="'||PRM_ID||'" class="opt">'||WS_ROTULO||'</li>');
		END IF;

	END NESTED_TEST_LIST;

	PROCEDURE NESTED_LIST_NOT ( PRM_ADICIONAL VARCHAR2 DEFAULT NULL,
	                            PRM_REF       VARCHAR2 DEFAULT NULL,
								PRM_COLUNA    VARCHAR2 DEFAULT NULL,
								PRM_DESC      VARCHAR2 DEFAULT NULL ) AS

		WS_ROTULO   VARCHAR2(200);
		WS_COUNT    NUMBER;
		WS_SELECTED NUMBER;

	BEGIN
            
		SELECT COUNT(*) INTO WS_COUNT FROM TABLE(FUN.VPIPE(PRM_ADICIONAL)) WHERE COLUMN_VALUE = PRM_COLUNA;
		SELECT COUNT(*) INTO WS_SELECTED FROM TABLE(FUN.VPIPE(PRM_REF)) WHERE '|'||COLUMN_VALUE||'|' = '|'||PRM_COLUNA||'|';
				
		WS_ROTULO := PRM_DESC;

		IF PRM_COLUNA <> PRM_DESC THEN
            WS_ROTULO := PRM_COLUNA||' - '||PRM_DESC;
		END IF;
				
		IF WS_SELECTED <> 0 THEN
			HTP.P('<li class="opt selected" title="'||PRM_COLUNA||'">'||WS_ROTULO||'</li>');
		ELSIF TRIM(PRM_COLUNA) = '$[NOT]'||TRIM(PRM_REF) THEN
			HTP.P('<li class="opt reverse" title="'||PRM_COLUNA||'">'||WS_ROTULO||'</li>');
		ELSIF WS_COUNT > 0 THEN
			HTP.P('<li class="opt used" title="'||PRM_COLUNA||'">'||WS_ROTULO||'</li>');
		ELSE
			HTP.P('<li class="opt" title="'||PRM_COLUNA||'">'||WS_ROTULO||'</li>');
		END IF;

	END NESTED_LIST_NOT;

	PROCEDURE NESTED_LIST_ORDER ( PRM_REF    VARCHAR2 DEFAULT NULL,
	                              PRM_COLUNA VARCHAR2 DEFAULT NULL,
								  PRM_DESC   VARCHAR2 DEFAULT NULL,
								  PRM_PADRAO VARCHAR2 DEFAULT NULL ) AS

	    WS_ROTULO VARCHAR2(80);
		WS_ORDER  VARCHAR2(20);

	BEGIN

	    BEGIN
		SELECT ORDEM INTO WS_ORDER FROM (SELECT COLUMN_VALUE, ROWNUM AS ORDEM FROM TABLE((FUN.VPIPE(PRM_REF)))) WHERE TRIM(COLUMN_VALUE) = TRIM(PRM_COLUNA);
				    
			CASE WS_ORDER
				WHEN '10' THEN
					WS_ORDER := 'A';
				WHEN '11' THEN 
					WS_ORDER := 'B';
				WHEN '12' THEN
					WS_ORDER := 'C';
				WHEN '13' THEN
					WS_ORDER := 'D';
				WHEN '14' THEN
					WS_ORDER := 'E';
				WHEN '15' THEN
					WS_ORDER := 'F';
				ELSE
					WS_ORDER := WS_ORDER;
			END CASE;
		
		EXCEPTION WHEN OTHERS THEN
			WS_ORDER := '0';
		END;

		WS_ROTULO := PRM_DESC;

		IF PRM_COLUNA <> PRM_DESC THEN
			WS_ROTULO := PRM_COLUNA||' - '||PRM_DESC;
		END IF;
		
		IF NVL(WS_ORDER, '0') <> '0' THEN
			
			HTP.P('<li class="opt selected" data-ordem="'||WS_ORDER||'" title="'||PRM_COLUNA||'">'||FUN.UTRANSLATE('NM_OBJETO', PRM_COLUNA, WS_ROTULO, PRM_PADRAO)||'</li>');
		ELSE
			HTP.P('<li class="opt" data-ordem="0" title="'||PRM_COLUNA||'">'||FUN.UTRANSLATE('NM_OBJETO', PRM_COLUNA, WS_ROTULO, PRM_PADRAO)||'</li>');
		END IF;

	END NESTED_LIST_ORDER;

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF;

	WS_SEARCH := REPLACE(PRM_SEARCH, '$[NOT]', '');

		CASE PRM_CAMPO

		WHEN 'lista-drill' THEN

            WS_VALUE := REPLACE(REPLACE(PRM_VISAO, '##', ''), 'trl', '');

			SELECT TP_OBJETO INTO WS_CLASS FROM OBJETOS WHERE CD_OBJETO = WS_VALUE;
			
			IF WS_CLASS = 'CONSULTA' THEN
			
				HTP.P('<li class="opt" title="'||WS_VALUE||'">'||FUN.LANG('REABRIR')||'</li>');
            
			END IF;
			
			









			WS_PADRAO := GBL.GETLANG;
			
			WS_CHECK := 'N/A';  
				
			FOR I IN (
				SELECT CD_OBJETO_GO, T2.TP_OBJETO AS TIPO, T2.NM_OBJETO AS NOME
				FROM GOTO_OBJETO T1 
				LEFT JOIN OBJETOS T2 ON T2.CD_OBJETO = T1.CD_OBJETO_GO
				WHERE T1.CD_OBJETO = WS_VALUE AND
				FUN.CHECK_PERMISSAO(T1.CD_OBJETO_GO) = 'S' AND 
				T1.CD_OBJETO_GO NOT IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_ADICIONAL)) WHERE COLUMN_VALUE IS NOT NULL) AND 
				T1.CD_OBJETO_GO NOT IN ( SELECT CD_OBJETO FROM OBJECT_RESTRICTION WHERE USUARIO = WS_USUARIO )
				ORDER BY TIPO, NVL(ORDEM, 99), NOME
			) LOOP

				IF WS_CHECK <> I.TIPO THEN
					WS_CHECK := I.TIPO;
					HTP.P('<li class="group" title="'||I.TIPO||'">'||FUN.LANG(I.TIPO)||'</li>');
				END IF;

				HTP.P('<li class="opt" title="'||I.CD_OBJETO_GO||'">'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', I.CD_OBJETO_GO, I.NOME, WS_PADRAO))||'</li>');

			END LOOP;

	    WHEN 'lista-ligacao-browser' THEN

			FCL.FAKECUSTOM('add');
			FCL.FAKECUSTOM('search', PRM_SEARCH);

			BEGIN
				SELECT TRIM(NDS_TFISICA) INTO WS_GRUPO FROM CODIGO_DESCRICAO WHERE NDS_TABELA = PRM_VISAO;
				IF LENGTH(WS_GRUPO) = 0 THEN
					WS_GRUPO := PRM_VISAO;
				END IF;
			EXCEPTION WHEN OTHERS THEN
				WS_GRUPO := PRM_VISAO;
			END;

			SELECT CD_LIGACAO INTO WS_LIGACAO FROM DATA_COLUNA WHERE CD_COLUNA = PRM_IDENT AND CD_MICRO_DATA = PRM_ADICIONAL;

			IF NVL(PRM_SEARCH, 'N/A') <> 'N/A' THEN
				WS_SQL := 'select distinct '||PRM_IDENT||'  from '||WS_GRUPO||' where ('||PRM_IDENT||' like (''%'||PRM_SEARCH||'%'') or upper(trim(fun.cdesc('||PRM_IDENT||', '''||WS_LIGACAO||'''))) like (''%'||UPPER(TRIM(PRM_SEARCH))||'%'')) order by '||PRM_IDENT||'';
			ELSE
				WS_SQL := 'select distinct '||PRM_IDENT||'  from '||WS_GRUPO||' order by '||PRM_IDENT||'';
			END IF;

			BEGIN

				WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

				DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
				WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

				LOOP
					IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
						EXIT;
					END IF;
					WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
					
					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
					IF TRIM(WS_CODIGO) = FUN.CDESC(TRIM(WS_CODIGO), WS_LIGACAO) THEN
						HTP.P('<li class="opt" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_CODIGO)||'</li>');
					ELSE
						HTP.P('<li class="opt" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_CODIGO)||' - '||FUN.CDESC(TRIM(WS_CODIGO), WS_LIGACAO)||'</li>');
					END IF;
				END LOOP;

				DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

			EXCEPTION WHEN OTHERS THEN
				HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||WS_SQL);
			END;
	
	    WHEN 'lista-coluna-browser' THEN

		    BEGIN
                WS_SQL := 'select column_name from all_tab_columns where table_name = '''||UPPER(TRIM(PRM_VISAO))||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||REPLACE(PRM_IDENT, '_fake')||''')';

                WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

                DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

                DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);

                WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

                LOOP
                    IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
                        EXIT;
                    END IF;

                    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);

                    HTP.P('<li class="opt" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_CODIGO)||'</li>');

                END LOOP;

                DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

			EXCEPTION WHEN OTHERS THEN
			    HTP.P(WS_SQL||' # '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
			END;
		
		WHEN 'lista-sinais-opcoes' THEN

		    FOR I IN 1..9 LOOP
			    IF I = TRIM(PRM_REF) THEN
                    HTP.P('<li class="opt selected" title="'||I||'">'||HTF.IMG(FUN.R_GIF('ind'||I||'_1', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_2', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_3', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_4', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_5', 'PNG' ))||'</li>');
                ELSE
					HTP.P('<li class="opt" title="'||I||'">'||HTF.IMG(FUN.R_GIF('ind'||I||'_1', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_2', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_3', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_4', 'PNG' ))||HTF.IMG(FUN.R_GIF('ind'||I||'_5', 'PNG' ))||'</li>');
			    END IF;
			END LOOP;
		
		WHEN 'lista-sinais' THEN

		    FOR I IN (SELECT CD_SINAL, DS_SINAL, TP_SINAL, FX_01, FX_02, FX_03, FX_04, FX_05 FROM SINAIS ORDER BY CD_SINAL ASC) LOOP
                HTP.P('<li class="opt" title="'||I.CD_SINAL||'">'||I.CD_SINAL||' - '||I.DS_SINAL||'</li>');
			END LOOP;
		
		WHEN 'lista-horas' THEN
		    BEGIN

			FOR I IN(
			    SELECT TO_NUMBER(T1.COLUMN_VALUE) AS COD, NVL2(T2.COLUMN_VALUE, 'selected', '') AS CLASSE FROM TABLE(FUN.VPIPE('01|02|03|04|05|06|07|08|09|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24')) T1
                LEFT JOIN TABLE(FUN.VPIPE(PRM_REF)) T2 ON T2.COLUMN_VALUE = T1.COLUMN_VALUE ORDER BY COD) LOOP
			    
				HTP.P('<li title="'||TRIM(TO_CHAR(I.COD, '00'))||'" class="opt '||I.CLASSE||'">'||TO_CHAR(I.COD, '00')||':00h</li>');
			
			END LOOP;

			EXCEPTION WHEN OTHERS THEN
			    HTP.P(SQLERRM);
			
			END;
		
		WHEN 'lista-meses' THEN
		    
			FOR I IN(
			    SELECT CD_COLUNA AS COD, CD_CONTEUDO AS NOME, NVL2(COLUMN_VALUE, 'selected', '') AS CLASSE FROM TABLE(FUN.VPIPE_PAR('01|JANEIRO|02|FEVEREIRO|03|MAR&Ccedil;O|04|ABRIL|05|MAIO|06|JUNHO|07|JULHO|08|AGOSTO|09|SETEMBRO|10|OUTUBRO|11|NOVEMBRO|12|DEZEMBRO'))
                LEFT JOIN TABLE(FUN.VPIPE(PRM_REF)) ON COLUMN_VALUE = CD_COLUNA ORDER BY CD_COLUNA) LOOP
			    
				HTP.P('<li title="'||I.COD||'" class="opt '||I.CLASSE||'">'||FUN.LANG(I.NOME)||'</li>');
			END LOOP;
			
		WHEN 'lista-semanas' THEN
		    
			FOR I IN(
			    SELECT CD_COLUNA AS COD, CD_CONTEUDO AS NOME, NVL2(COLUMN_VALUE, 'selected', '') AS CLASSE FROM TABLE(FUN.VPIPE_PAR('1|DOMINGO|2|SEGUNDA-FEIRA|3|TER&Ccedil;A-FEIRA|4|QUARTA-FEIRA|5|QUINTA-FEIRA|6|SEXTA-FEIRA|7|SABADO'))
                LEFT JOIN TABLE(FUN.VPIPE(PRM_REF)) ON COLUMN_VALUE = CD_COLUNA ORDER BY CD_COLUNA) LOOP
			    
				HTP.P('<li title="'||I.COD||'" class="opt '||I.CLASSE||'">'||FUN.LANG(I.NOME)||'</li>');
			END LOOP;
	
	    WHEN 'lista-mascara' THEN
			
			HTP.P('<li title="SEM" class="opt">SEM</li>');
			FOR I IN (SELECT CD_MASCARA FROM MASCARAS ORDER BY CD_MASCARA ASC ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.CD_MASCARA, I.CD_MASCARA);
			END LOOP;
		WHEN 'lista-mascara-browser' THEN
		    
			FCL.FAKECUSTOM('add', PRM_REF);
			
			HTP.P('<li title="SEM" class="opt">SEM</li>');
			FOR I IN (SELECT CD_MASCARA FROM MASCARAS ORDER BY CD_MASCARA ASC ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.CD_MASCARA, I.CD_MASCARA);
			END LOOP;
	
	    WHEN 'lista-taux' THEN

			FCL.FAKECUSTOM('add');
			FCL.FAKECUSTOM('search', PRM_SEARCH);
		    
			HTP.P('<li title="SEM" class="opt">SEM</li>');
			FOR I IN (SELECT NDS_TABELA FROM CODIGO_DESCRICAO WHERE NDS_TABELA LIKE ('%'||NVL(UPPER(WS_SEARCH), NDS_TABELA)||'%') ORDER BY NDS_TABELA ASC ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.NDS_TABELA, I.NDS_TABELA);
			END LOOP;
    
	    WHEN 'lista-taux-fixa' THEN
		    
			HTP.P('<li title="SEM" class="opt">SEM</li>');
			FOR I IN (SELECT NDS_TABELA FROM CODIGO_DESCRICAO ORDER BY NDS_TABELA ASC ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.NDS_TABELA, I.NDS_TABELA);
			END LOOP;

		WHEN 'lista-jumpmed' THEN

			FOR I IN(SELECT CD_COLUNA, NM_ROTULO FROM MICRO_COLUNA MC WHERE CD_MICRO_VISAO = PRM_VISAO AND CD_COLUNA <> REPLACE(PRM_IDENT, 'ID_') AND ST_AGRUPADOR <> 'SEM' AND CD_COLUNA NOT IN(SELECT CD_COLUNA FROM COLUMN_RESTRICTION CR WHERE CR.CD_COLUNA = MC.CD_COLUNA AND USUARIO = WS_USUARIO AND CR.CD_MICRO_VISAO = PRM_VISAO) AND CD_COLUNA IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_ADICIONAL AND CD_PROP = 'AGRUPADORES'))))) LOOP
				NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.NM_ROTULO, I.NM_ROTULO);
			END LOOP;
		
		WHEN 'lista-tabelas' THEN

			FCL.FAKECUSTOM('add');

			FOR I IN (SELECT OBJECT_TYPE AS TIPO, OBJECT_NAME AS NOME FROM ALL_OBJECTS WHERE OWNER='DWU' AND ((UPPER(SUBSTR(OBJECT_NAME,1,3)) IN ('VM_','DW_', 'OPR', 'BI_')) OR (OBJECT_TYPE='VIEW' AND UPPER(SUBSTR(OBJECT_NAME,1,1))='V') OR (OBJECT_TYPE IN('TABLE','VIEW') AND UPPER(SUBSTR(OBJECT_NAME,1,5))='TAUX_')) AND OBJECT_NAME LIKE ('%'||NVL(UPPER(WS_SEARCH), OBJECT_NAME)||'%') ORDER BY OBJECT_NAME ASC) LOOP
				NESTED_TEST_LIST(PRM_REF, I.NOME, I.NOME);
			END LOOP;

		WHEN 'lista-gusers' THEN
            
			
		    FOR I IN (SELECT CD_GROUP FROM GUSERS ORDER BY CD_GROUP) LOOP
				NESTED_TEST_LIST(PRM_REF, I.CD_GROUP, I.CD_GROUP);
			END LOOP;

		WHEN 'lista-grupos' THEN 
			
			IF PRM_ADICIONAL = 'todos' THEN
                HTP.P('<li title="" class="opt">'||FUN.LANG('TODOS OS GRUPOS')||'</li>');
			END IF;

			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;

			FOR I IN (SELECT CD_GRUPO, NM_GRUPO FROM GRUPOS_FUNCAO ORDER BY ORDEM, CD_GRUPO ASC) LOOP
				NESTED_TEST_LIST(PRM_REF, I.CD_GRUPO, FUN.UTRANSLATE('CD_GRUPO', 'GRUPOS_FUNCAO' , I.NM_GRUPO, WS_PADRAO));
			END LOOP;

		WHEN 'lista-telas' THEN
		    
			WS_CHECK := 'N/A';

			FCL.FAKECUSTOM('search', PRM_SEARCH);
			
			FOR I IN(SELECT CD_OBJETO, NM_OBJETO, T2.NM_GRUPO AS NM_GRUPO, T2.CD_GRUPO AS GRUPO FROM OBJETOS T1
	            LEFT JOIN GRUPOS_FUNCAO T2 ON T2.CD_GRUPO = T1.CD_GRUPO 
				WHERE
	            CD_OBJETO NOT IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = PRM_ADICIONAL)
				AND (CD_OBJETO LIKE ('SRC_%') OR TP_OBJETO = 'SCREEN') AND
				(
					UPPER(TRIM(CD_OBJETO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
					UPPER(TRIM(NM_OBJETO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
					UPPER(TRIM(COD)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%')
				) 
				
	            ORDER BY T2.NM_GRUPO, NM_OBJETO) LOOP
                
				IF WS_CHECK <> I.GRUPO THEN
                    WS_CHECK := I.GRUPO;
                    HTP.P('<li class="opt selectablegroup" title="'||I.GRUPO||'">'||I.NM_GRUPO||'</li>');
                END IF;

				HTP.P('<li title="'||I.CD_OBJETO||'" class="opt">'||UPPER(I.NM_OBJETO)||'</li>');

			END LOOP;

		WHEN 'lista-telas-selecionadas' THEN
		    
			WS_CHECK := 'N/A';
			
			HTP.P('<li title="" class="opt">---</li>');
			
			FOR I IN(SELECT CD_OBJETO, NM_OBJETO, T2.NM_GRUPO AS NM_GRUPO, T2.CD_GRUPO AS GRUPO FROM OBJETOS T1
	            LEFT JOIN GRUPOS_FUNCAO T2 ON T2.CD_GRUPO = T1.CD_GRUPO 
				WHERE
	            CD_OBJETO NOT IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = PRM_ADICIONAL)
				AND (CD_OBJETO LIKE ('SRC_%') OR TP_OBJETO = 'SCREEN') AND
				(
					UPPER(TRIM(CD_OBJETO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
					UPPER(TRIM(NM_OBJETO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
					UPPER(TRIM(COD)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%')
				) 
				
	            ORDER BY T2.NM_GRUPO, NM_OBJETO) LOOP

					IF WS_CHECK <> I.GRUPO THEN
						WS_CHECK := I.GRUPO;
						HTP.P('<li class="opt selectablegroup" title="'||I.GRUPO||'">'||I.NM_GRUPO||'</li>');
					END IF;
                
					NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, UPPER(TRIM(I.NM_OBJETO)), UPPER(TRIM(I.NM_OBJETO)));
				END LOOP;

			

		WHEN 'lista-telas-todas' THEN

            WS_CHECK := 'N/A';
            IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') = 0 AND INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') = 0 THEN
                WS_ORDER := 'desktop';
            ELSE
                WS_ORDER := 'mobile';
            END IF;

            SELECT COUNT(DISTINCT CD_GRUPO) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = PRM_ADICIONAL  AND STATUS='A');
            
            IF WS_COUNT > 2 THEN
                WS_SEARCH := 'closed';
            END IF;

            WS_COUNT := 0;
			
			HTP.P('<li class="opt" onclick="setTimeout(function(){ document.getElementById(''main'').style.setProperty(''background-image'', ''url(dwu.fcl.download_tab?prm_arquivo=bg.jpg)''); document.getElementById(''main'').style.setProperty(''background-color'', ''transparent''); }, 700); shscr(''DEFAULT''); document.getElementById(''floatops'').innerHTML = '''||FUN.LANG('Tela principal')||''';">'||FUN.LANG('Tela principal')||'</li>');
			
			FOR I IN(SELECT CD_OBJETO, OBJETOS.CD_GRUPO AS CD_GRUPO, NM_GRUPO, NM_OBJETO, NVL(COR_FUNDO,'#FFFFFF') COR_FUNDO, URL_FUNDO, NVL(TRIM(OR_ITEM),99) AS OR_OBJETO, DISPOSITIVO, DS_SCREEN FROM OBJETOS, ALL_SCREENS, GRUPOS_FUNCAO WHERE TP_OBJETO='SCREEN' AND ALL_SCREENS.PUBLICO='S' AND CD_OBJETO=SCREEN(+) AND OBJETOS.CD_GRUPO=GRUPOS_FUNCAO.CD_GRUPO AND SCREEN IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = PRM_ADICIONAL AND STATUS='A') ORDER BY GRUPOS_FUNCAO.ORDEM, OBJETOS.CD_GRUPO, OR_OBJETO, OBJETOS.NM_OBJETO ) LOOP

				IF WS_CHECK <> I.CD_GRUPO THEN
                    WS_CHECK := I.CD_GRUPO;
                    HTP.P('<li class="opt group">'||I.NM_GRUPO||'</li>');
                END IF;

                IF (WS_ORDER = 'mobile' AND NVL(I.DISPOSITIVO, '0') <> 'desktop' AND NVL(I.DISPOSITIVO, '0') <> 'nenhum') OR (WS_ORDER = 'desktop' AND NVL(I.DISPOSITIVO, '0') <> 'mobile' AND NVL(I.DISPOSITIVO, '0') <> 'nenhum') OR WS_ADMIN = 'A' THEN
			        NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, UPPER(TRIM(I.NM_OBJETO)), UPPER(TRIM(I.NM_OBJETO)));
				END IF; 

            END LOOP;

		WHEN 'lista-tipos-obj' THEN
				
			




			
			IF TRIM(PRM_REF) = 'SCREEN' THEN
			    HTP.P('<li title="SCREEN" class="opt selected">TELA</li>');
			ELSE
			    HTP.P('<li title="SCREEN" class="opt">TELA</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'FILE' THEN
			    HTP.P('<li title="FILE" class="opt selected">FILEVIEW</li>');
			ELSE
			    HTP.P('<li title="FILE" class="opt">FILEVIEW</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'RELATORIO' THEN
			    HTP.P('<li title="RELATORIO" class="opt selected">'||FUN.LANG('RELAT&Oacute;RIO')||'</li>');
			ELSE
			    HTP.P('<li title="RELATORIO" class="opt">'||FUN.LANG('RELAT&Oacute;RIO')||'</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'ICONE' THEN
			    HTP.P('<li title="ICONE" class="opt selected">'||FUN.LANG('ICONE')||'</li>');
			ELSE
			    HTP.P('<li title="ICONE" class="opt">'||FUN.LANG('ICONE')||'</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'IMAGE' THEN
			    HTP.P('<li title="IMAGE" class="opt selected">'||FUN.LANG('IMAGEM')||'</li>');
			ELSE
			    HTP.P('<li title="IMAGE" class="opt">'||FUN.LANG('IMAGEM')||'</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'CALL_LIST' THEN
			    HTP.P('<li title="CALL_LIST" class="opt selected">MENU</li>');
			ELSE
			    HTP.P('<li title="CALL_LIST" class="opt">MENU</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'SCRIPT' THEN
			    HTP.P('<li title="SCRIPT" class="opt selected">SCRIPT</li>');
			ELSE
			    HTP.P('<li title="SCRIPT" class="opt">SCRIPT</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'BROWSER' THEN
                HTP.P('<li title="BROWSER" class="opt selected">BROWSER</li>');
            ELSE
                HTP.P('<li title="BROWSER" class="opt">BROWSER</li>');
            END IF;
			
			




			
	    WHEN 'lista-arquivo' THEN

			FCL.FAKECUSTOM('add');
			
			FOR I IN (SELECT NAME, DOC_SIZE FROM TAB_DOCUMENTOS WHERE UPPER(TRIM(NAME)) LIKE NVL(('%'||UPPER(TRIM(WS_SEARCH))||'%'), UPPER(TRIM(NAME))) ORDER BY NAME ASC, MIME_TYPE) LOOP
				NESTED_TEST_LIST(PRM_REF, TRIM(I.NAME), TRIM(I.NAME));
			END LOOP;
		
		WHEN 'lista-arquivo-user' THEN
			
			FOR I IN (SELECT NAME, DOC_SIZE FROM TAB_DOCUMENTOS WHERE USUARIO = GBL.GETUSUARIO or gbl.getnivel='A' ORDER BY NAME ASC, MIME_TYPE) LOOP
				NESTED_TEST_LIST(PRM_REF, TRIM(I.NAME), TRIM(I.NAME));
			END LOOP;
			
		WHEN 'lista-xls' THEN
			
			FOR I IN (SELECT NAME, DOC_SIZE FROM TAB_DOCUMENTOS WHERE UPPER(TRIM(NAME)) LIKE '%.XLSX' ORDER BY NAME ASC, MIME_TYPE) LOOP
				NESTED_TEST_LIST(PRM_REF, I.NAME, UPPER(TRIM(I.NAME)));
			END LOOP;

		WHEN 'lista-codigo-custom' THEN

			FCL.FAKECUSTOM('add');
			
			FOR I IN (SELECT COLUMN_NAME FROM ALL_TAB_COLUMNS WHERE	OWNER = 'DWU' AND TABLE_NAME = PRM_VISAO ORDER BY COLUMN_NAME ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.COLUMN_NAME, I.COLUMN_NAME);
			END LOOP;

		WHEN 'lista-realviews' THEN

			FCL.FAKECUSTOM('add');
			
			FOR I IN (SELECT OBJECT_NAME AS OBJETO, STATUS FROM ALL_OBJECTS WHERE OBJECT_TYPE = 'VIEW' AND OWNER = 'DWU' ORDER BY OBJECT_NAME ASC) LOOP
				NESTED_TEST_LIST(PRM_REF, I.OBJETO, I.OBJETO);
			END LOOP;
			
	    WHEN 'lista-views' THEN

            FCL.FAKECUSTOM('search', PRM_SEARCH);

	        WS_GRUPO := 'N/A';

			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;

			FOR I IN (SELECT NM_MICRO_VISAO, DS_MICRO_VISAO, CD_GRUPO_FUNCAO FROM MICRO_VISAO WHERE 
			(
				UPPER(TRIM(NM_MICRO_VISAO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
				UPPER(TRIM(DS_MICRO_VISAO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%')
			)
			ORDER BY CD_GRUPO_FUNCAO, NM_MICRO_VISAO) LOOP
			    IF(WS_GRUPO <> I.CD_GRUPO_FUNCAO) THEN
			        HTP.P('<li class="group">'||FUN.UTRANSLATE('CD_GRUPO', 'GRUPOS_FUNCAO', I.CD_GRUPO_FUNCAO, WS_PADRAO)||'</li>');
				    WS_GRUPO := I.CD_GRUPO_FUNCAO;
			    END IF;

                WS_ROTULO := FUN.UTRANSLATE('DS_MICRO_VISAO', 'MICRO_VISAO', I.DS_MICRO_VISAO, WS_PADRAO);

				IF WS_ROTULO <> I.NM_MICRO_VISAO THEN
                    WS_ROTULO := I.NM_MICRO_VISAO||' - '||WS_ROTULO;
				END IF;


			    IF '|'||TRIM(I.NM_MICRO_VISAO)||'|' = '|'||TRIM(PRM_REF)||'|' THEN
				    HTP.P('<li class="opt selected" title="'||I.NM_MICRO_VISAO||'">'||WS_ROTULO||'</li>');
				ELSE
			        HTP.P('<li class="opt" onclick="setMicroAgrupador()" title="'||I.NM_MICRO_VISAO||'">'||WS_ROTULO||'</li>');
			    END IF;
			END LOOP;

		WHEN 'lista-views-custom' THEN
	        WS_GRUPO := 'N/A';
			
			BEGIN
				SELECT CONTEUDO INTO WS_PADRAO
				FROM   PARAMETRO_USUARIO
				WHERE  CD_USUARIO = WS_USUARIO AND
					CD_PADRAO='CD_LINGUAGEM';
			EXCEPTION
				WHEN OTHERS THEN
					WS_PADRAO := 'PORTUGUESE';
			END;
			
			FOR I IN (SELECT NM_MICRO_VISAO, DS_MICRO_VISAO, CD_GRUPO_FUNCAO FROM MICRO_VISAO WHERE (NM_MICRO_VISAO IN (SELECT DISTINCT NM_VISAO FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO) OR WS_ADMIN = 'A') ORDER BY CD_GRUPO_FUNCAO, NM_MICRO_VISAO) LOOP
			    IF(WS_GRUPO <> I.CD_GRUPO_FUNCAO) THEN
			        HTP.P('<li class="group">'||FUN.UTRANSLATE('CD_GRUPO', 'GRUPOS_FUNCAO', I.CD_GRUPO_FUNCAO, WS_PADRAO)||'</li>');
				    WS_GRUPO := I.CD_GRUPO_FUNCAO;
			    END IF;
			    IF '|'||TRIM(I.NM_MICRO_VISAO)||'|' = '|'||TRIM(PRM_REF)||'|' THEN
				    HTP.P('<li class="opt selected" title="'||I.NM_MICRO_VISAO||'">'||FUN.UTRANSLATE('DS_MICRO_VISAO', 'MICRO_VISAO', I.DS_MICRO_VISAO, WS_PADRAO)||'</li>');
				ELSE
			        HTP.P('<li class="opt" onclick="setMicroAgrupador()" title="'||I.NM_MICRO_VISAO||'">'||FUN.UTRANSLATE('DS_MICRO_VISAO', 'MICRO_VISAO', I.DS_MICRO_VISAO, WS_PADRAO)||'</li>');
			    END IF;
			END LOOP;

		WHEN 'lista-medidas' THEN 
			
			FOR I IN (SELECT NVL(FUN.NOME_COL(CD_COLUNA, PRM_VISAO), CD_COLUNA) AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE CD_COLUNA NOT IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT NVL(CS_AGRUPADOR, 'N/A') FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_ADICIONAL)))) AND CD_MICRO_VISAO = PRM_VISAO AND (ST_AGRUPADOR <> 'SEM' OR ST_AGRUPADOR = 'TPT') AND NVL(NM_ROTULO, 'n/a') <> 'n/a' ORDER BY CD_COLUNA) LOOP
				NESTED_LIST_NOT( PRM_ADICIONAL, PRM_REF, I.CD_COLUNA, I.COLUNA);
			END LOOP;

		WHEN 'lista-colunas' THEN 

		    FCL.FAKECUSTOM('search', PRM_SEARCH);
			
			FOR I IN (SELECT NVL(FUN.NOME_COL(CD_COLUNA, PRM_VISAO), CD_COLUNA) AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE ST_AGRUPADOR <> 'TPT' AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND
			(
				UPPER(TRIM(CD_COLUNA)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
				UPPER(TRIM(NVL(FUN.NOME_COL(CD_COLUNA, PRM_VISAO), CD_COLUNA))) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%')
			)
			ORDER BY CD_COLUNA) LOOP
				NESTED_LIST_NOT( PRM_ADICIONAL, PRM_REF, I.CD_COLUNA, I.COLUNA);
			END LOOP;

		WHEN 'lista-colunas-custom' THEN 
			
			FOR I IN (SELECT NVL(FUN.NOME_COL(CD_COLUNA, PRM_VISAO), CD_COLUNA) AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE ST_AGRUPADOR <> 'TPT' AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'n/a') <> 'n/a' AND (CD_COLUNA IN (SELECT NM_COLUNA FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO AND NM_VISAO = PRM_VISAO) OR WS_ADMIN = 'A') ORDER BY CD_COLUNA) LOOP
				IF WS_ADMIN = 'A' THEN
				    NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA);
				ELSE
					NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA, I.COLUNA);
				END IF;
			END LOOP;

		WHEN 'lista-dimensoes' THEN 
			
			FOR I IN (SELECT NVL(FUN.NOME_COL(CD_COLUNA, PRM_VISAO), CD_COLUNA) AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE CD_COLUNA NOT IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA||CS_COLUP FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_ADICIONAL)))) AND ST_AGRUPADOR <> 'TPT' AND CD_MICRO_VISAO = PRM_VISAO AND (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT') AND NVL(NM_ROTULO, 'n/a') <> 'n/a' ORDER BY CD_COLUNA) LOOP
				NESTED_LIST_NOT( PRM_ADICIONAL, PRM_REF, I.CD_COLUNA, I.COLUNA);
			END LOOP;
		
        WHEN 'lista-agrupador' THEN 
			
			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT') AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' ORDER BY CD_COLUNA) LOOP
				NESTED_LIST_ORDER(PRM_REF, I.CD_COLUNA, I.COLUNA, WS_PADRAO);
			END LOOP;

		WHEN 'lista-agrupador-custom' THEN 
			
			HTP.P('<li class="group">LISTA DE AGRUPADORES</li>');
			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT') AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' AND (CD_COLUNA IN (SELECT NM_COLUNA FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO AND NM_VISAO = PRM_VISAO) OR WS_ADMIN = 'A') ORDER BY CD_COLUNA) LOOP
				IF WS_ADMIN = 'A' THEN
				    NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA);
				ELSE
					NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA, I.COLUNA);
				END IF;
			END LOOP;
		
	    WHEN 'lista-valor' THEN 
			
			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE ST_AGRUPADOR <> 'SEM' AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' ORDER BY CD_COLUNA) LOOP
				NESTED_LIST_ORDER(PRM_REF, I.CD_COLUNA, I.COLUNA, WS_PADRAO);
			END LOOP;

		WHEN 'lista-valor-usado' THEN 

		    WS_CODIGO := FUN.GETPROP(PRM_ADICIONAL, 'SEC');
			
			SELECT CS_AGRUPADOR, CD_MICRO_VISAO INTO WS_VALUE, WS_TABELA FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_ADICIONAL;
			FOR I IN (
				SELECT COLUMN_VALUE, NM_ROTULO FROM TABLE(FUN.VPIPE(WS_VALUE||'|'||WS_CODIGO)) T1
				LEFT JOIN MICRO_COLUNA T2 ON T2.CD_MICRO_VISAO = WS_TABELA AND T2.CD_COLUNA = T1.COLUMN_VALUE
			) LOOP
				IF NVL(I.NM_ROTULO, 'N/A') <> 'N/A' THEN
				    NESTED_LIST_ORDER(PRM_REF, REPLACE(REPLACE(I.NM_ROTULO, CHR(13), ' '), CHR(10), ' '), REPLACE(REPLACE(I.NM_ROTULO, CHR(13), ' '), CHR(10), ' '), REPLACE(REPLACE(I.NM_ROTULO, CHR(13), ' '), CHR(10), ' '));
				END IF;
			END LOOP;
			
		WHEN 'lista-valor-custom' THEN 
			HTP.P('<li class="group">'||FUN.LANG('LISTA DE VALORES')||'</li>');

			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE ST_AGRUPADOR <> 'SEM' AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' AND (CD_COLUNA IN (SELECT NM_COLUNA FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO AND NM_VISAO = PRM_VISAO) OR WS_ADMIN = 'A') ORDER BY CD_COLUNA) LOOP
				IF WS_ADMIN = 'A' THEN
				    NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA);
				ELSE
					NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA, I.COLUNA);
				END IF;
			END LOOP;

		WHEN 'lista-valor-simples' THEN 
			
			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE ST_AGRUPADOR <> 'SEM' AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' ORDER BY CD_COLUNA) LOOP
				NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, I.COLUNA);
			END LOOP;
		
		 WHEN 'lista-pivot' THEN 
			
			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT') AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' ORDER BY CD_COLUNA) LOOP
				NESTED_LIST_ORDER(PRM_REF, I.CD_COLUNA, I.COLUNA, WS_PADRAO);
			END LOOP;

		WHEN 'lista-pivot-custom' THEN 
			HTP.P('<li class="group">LISTA DE PIVOTS</li>');
			FOR I IN (SELECT NM_ROTULO AS COLUNA, CD_COLUNA FROM MICRO_COLUNA WHERE (ST_AGRUPADOR = 'SEM' OR ST_AGRUPADOR = 'EXT') AND CD_MICRO_VISAO = PRM_VISAO AND NVL(NM_ROTULO, 'N/A') <> 'N/A' AND (CD_COLUNA IN (SELECT NM_COLUNA FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO AND NM_VISAO = PRM_VISAO) OR WS_ADMIN = 'A') ORDER BY CD_COLUNA) LOOP
				IF WS_ADMIN = 'A' THEN
				    NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, TRIM(I.COLUNA));
				ELSE
					NESTED_TEST_LIST(PRM_REF, I.CD_COLUNA, TRIM(I.COLUNA), I.COLUNA);
				END IF;
			END LOOP;
		
		WHEN 'lista-custom-fav' THEN 

		    



			HTP.P('<li title="" class="opt">'||FUN.LANG('NOVA CONSULTA')||'</li>');
            WS_GRUPO := 'N/A';
			FOR I IN (SELECT CD_OBJETO, NM_OBJETO, CD_GRUPO FROM OBJETOS WHERE CD_OBJETO LIKE ('COBJ_%') AND CD_USUARIO = WS_USUARIO) LOOP
			
				
				IF UPPER(TRIM(WS_GRUPO)) <> UPPER(TRIM(I.CD_GRUPO)) THEN
					HTP.P('<li class="group">'||I.CD_GRUPO||'</li>');
					WS_GRUPO := I.CD_GRUPO;
				END IF;
				
				HTP.P('<li title="'||I.CD_OBJETO||'||'||I.CD_GRUPO||'" class="opt">'||I.NM_OBJETO||'');
				    
					
				    
				HTP.P('</li>');
			END LOOP;
		
		WHEN 'lista-objetos' THEN

			FCL.FAKECUSTOM('search', PRM_SEARCH);

	        WS_GRUPO := 'N/A';
			FOR I IN (SELECT CD_OBJETO, NM_OBJETO, TP_OBJETO, COD FROM OBJETOS WHERE CD_OBJETO IN 
			  (SELECT CD_PONTO FROM PONTO_AVALIACAO WHERE CD_MICRO_VISAO = PRM_VISAO AND (
			    CD_PONTO NOT IN (SELECT TRIM(CD_OBJETO_GO) FROM GOTO_OBJETO T2 WHERE UPPER(TRIM(T2.CD_OBJETO)) = UPPER(TRIM(PRM_ADICIONAL))) 
			  ) ) AND 
				UPPER(TRIM(CD_OBJETO)) <> UPPER(TRIM(NVL(PRM_ADICIONAL, 'N/A'))) AND
				(
					UPPER(TRIM(CD_OBJETO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
					UPPER(TRIM(NM_OBJETO)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%') OR 
					UPPER(TRIM(COD)) LIKE ('%'||UPPER(TRIM(PRM_SEARCH))||'%')
				)
				ORDER BY TP_OBJETO, NM_OBJETO) LOOP
			    
				IF (I.TP_OBJETO <> 'PONTEIRO' AND I.TP_OBJETO <> 'VALOR' AND I.TP_OBJETO <> 'GRAFICO' AND I.TP_OBJETO <> 'OBJETO') OR PRM_IDENT = 'destaque-objeto' THEN
				
					IF WS_GRUPO <> I.TP_OBJETO THEN
						HTP.P('<li class="group">'||I.TP_OBJETO||'</li>');
						WS_GRUPO := I.TP_OBJETO;
					END IF;

					NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, I.NM_OBJETO); 
					
				END IF;
			END LOOP;
			
		WHEN 'lista-objetos-fixo' THEN 
	        WS_GRUPO := 'N/A';
			FOR I IN (SELECT CD_OBJETO, NM_OBJETO, TP_OBJETO FROM OBJETOS WHERE CD_OBJETO IN 
			  (SELECT CD_PONTO FROM PONTO_AVALIACAO WHERE CD_MICRO_VISAO = PRM_VISAO AND (
			    CD_PONTO NOT IN (SELECT TRIM(CD_OBJETO_GO) FROM GOTO_OBJETO T2 WHERE UPPER(TRIM(T2.CD_OBJETO)) = UPPER(TRIM(PRM_ADICIONAL))) 
			  ) ) AND TP_OBJETO IN ('CONSULTA', 'VALOR') 




				ORDER BY TP_OBJETO, NM_OBJETO) LOOP
			    
			    
				IF (I.TP_OBJETO <> 'PONTEIRO' AND I.TP_OBJETO <> 'VALOR' AND I.TP_OBJETO <> 'GRAFICO' AND I.TP_OBJETO <> 'OBJETO') OR PRM_IDENT = 'destaque-objeto' THEN
				
					IF WS_GRUPO <> I.TP_OBJETO THEN
						HTP.P('<li class="group">'||I.TP_OBJETO||'</li>');
						WS_GRUPO := I.TP_OBJETO;
					END IF;
					
					NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, I.NM_OBJETO);
					
				END IF;
			END LOOP;
			
		WHEN 'lista-objetos-call' THEN 
	        WS_GRUPO := 'N/A';
			FOR I IN (SELECT CD_OBJETO, NM_OBJETO, TP_OBJETO FROM OBJETOS WHERE CD_OBJETO IN 
			  (SELECT CD_PONTO FROM PONTO_AVALIACAO WHERE CD_MICRO_VISAO = PRM_VISAO AND (
				CD_PONTO NOT IN (SELECT NVL(TRIM(CD_OBJETO), 'N/A') FROM CALL_LIST T3 WHERE UPPER(TRIM(T3.CD_LIST)) = UPPER(TRIM(PRM_ADICIONAL)))) ) AND 
				UPPER(TRIM(CD_OBJETO)) <> UPPER(TRIM(NVL(PRM_ADICIONAL, 'N/A'))) AND 
				(UPPER(CD_OBJETO) LIKE ('%'||UPPER(NVL(WS_SEARCH, CD_OBJETO))||'%') OR 
				UPPER(NM_OBJETO) LIKE ('%'||UPPER(NVL(WS_SEARCH, NM_OBJETO))||'%') OR
                UPPER(COD) LIKE ('%'||UPPER(NVL(WS_SEARCH, COD))||'%'))				
				ORDER BY TP_OBJETO, NM_OBJETO) LOOP
			    
			    IF WS_GRUPO <> I.TP_OBJETO THEN
			        HTP.P('<li class="group">'||I.TP_OBJETO||'</li>');
				    WS_GRUPO := I.TP_OBJETO;
			    END IF;
			    
				NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, I.NM_OBJETO);
			END LOOP;

			FOR I IN (SELECT CD_OBJETO, NM_OBJETO, TP_OBJETO FROM OBJETOS WHERE CD_OBJETO NOT IN 
			  (SELECT CD_PONTO FROM PONTO_AVALIACAO WHERE CD_MICRO_VISAO = PRM_VISAO AND (
				CD_PONTO NOT IN (SELECT NVL(TRIM(CD_OBJETO), 'N/A') FROM CALL_LIST T3 WHERE UPPER(TRIM(T3.CD_LIST)) = UPPER(TRIM(PRM_ADICIONAL)))) ) AND
				TP_OBJETO = 'RELATORIO' AND 
				UPPER(TRIM(CD_OBJETO)) <> UPPER(TRIM(NVL(PRM_ADICIONAL, 'N/A'))) AND 
				(UPPER(CD_OBJETO) LIKE ('%'||UPPER(NVL(WS_SEARCH, CD_OBJETO))||'%') OR 
				UPPER(NM_OBJETO) LIKE ('%'||UPPER(NVL(WS_SEARCH, NM_OBJETO))||'%') OR
                UPPER(COD) LIKE ('%'||UPPER(NVL(WS_SEARCH, COD))||'%'))				
				ORDER BY TP_OBJETO, NM_OBJETO) LOOP
			    
			    IF WS_GRUPO <> I.TP_OBJETO THEN
			        HTP.P('<li class="group">'||I.TP_OBJETO||'</li>');
				    WS_GRUPO := I.TP_OBJETO;
			    END IF;
			    
				NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, I.NM_OBJETO);
			END LOOP;
			
		WHEN 'lista-estados' THEN 
		    BEGIN
				SELECT PROPRIEDADE INTO WS_SQL FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_VISAO AND CD_PROP = 'ESTADOS';
			EXCEPTION WHEN OTHERS THEN
				WS_SQL := '';
			END;

	        WS_GRUPO := 'N/A';
			FOR I IN (SELECT DISTINCT CD_ESTADO FROM BI_ESTADOS_BRASIL ORDER BY CD_ESTADO ) LOOP
				NESTED_TEST_LIST(WS_SQL, I.CD_ESTADO, I.CD_ESTADO);
			END LOOP;
		
		WHEN 'lista-limitador' THEN

            BEGIN
				SELECT NDS_CD_CODIGO, NDS_TFISICA, NDS_CD_DESCRICAO INTO WS_CODIGO, WS_TABELA, WS_DESCRICAO FROM CODIGO_DESCRICAO WHERE (UPPER(NDS_TABELA) = UPPER(PRM_VISAO) OR UPPER(NDS_TFISICA) = UPPER(PRM_VISAO)) AND ROWNUM = 1;
				WS_SQL := 'select '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||' from '||TRIM(WS_TABELA)||'';
				WS_CURSOR := DBMS_SQL.OPEN_CURSOR;
				DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);

				WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

				LOOP

					WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
					IF WS_LINHAS <> 1 THEN
						EXIT;
					END IF;

					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
					WS_COUNT := 0;
					SELECT COUNT(*) INTO WS_COUNT FROM TABLE(FUN.VPIPE((SELECT PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_PROP = 'LIMITADORES' AND CD_OBJECT = PRM_IDENT))) WHERE COLUMN_VALUE = WS_CODIGO;

					IF WS_COUNT > 0 THEN
						HTP.P('<li class="opt selected" title="'||WS_CODIGO||'">'||WS_DESCRICAO||'</li>');
					ELSE
						HTP.P('<li class="opt" title="'||WS_CODIGO||'">'||WS_DESCRICAO||'</li>');
					END IF;

				END LOOP;
				DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - '||WS_SQL);
			END;

		WHEN 'lista-msg-tempo' THEN

            HTP.P('<li title="0" class="opt">'||FUN.LANG('Permanente')||'</li>');
			HTP.P('<li title="'||(LAST_DAY(TRUNC(SYSDATE))-TRUNC(SYSDATE))||'" class="opt">'||FUN.LANG('M&ecirc;s corrente')||'</li>');
			HTP.P('<li title="'||((TO_DATE(TO_CHAR(SYSDATE,'YYYY')||'1231','YYYYMMDD'))-TRUNC(SYSDATE))||'" class="opt">'||FUN.LANG('Ano corrente')||'</li>');
			HTP.P('<li title="15" class="opt">15 '||FUN.LANG('dias')||'</li>');
			HTP.P('<li title="30" class="opt">30 '||FUN.LANG('dias')||'</li>');
			HTP.P('<li title="60" class="opt">60 '||FUN.LANG('dias')||'</li>');
			HTP.P('<li title="90" class="opt">90 '||FUN.LANG('dias')||'</li>');

		WHEN 'lista-usuarios-grupos' THEN

			FCL.FAKECUSTOM('search', PRM_SEARCH, 'noscript');
		
		    SELECT COUNT(*) INTO WS_COUNT FROM GUSERS WHERE UPPER(CD_GROUP) IN (SELECT UPPER(CD_GROUP) FROM GUSERS_ITENS WHERE UPPER(CD_USUARIO) LIKE ('%'||UPPER(PRM_SEARCH)||'%'));

			IF WS_COUNT > 0 THEN
				HTP.P('<li class="group">'||FUN.LANG('GRUPOS')||'</li>');
				FOR I IN (SELECT CD_GROUP, NM_GROUP, T2.USUARIO
				FROM GUSERS T1
				LEFT JOIN USER_SCREENS T2 ON T2.USUARIO = T1.CD_GROUP AND SCREEN = PRM_ADICIONAL
				WHERE UPPER(CD_GROUP) IN (SELECT UPPER(CD_GROUP) FROM GUSERS_ITENS WHERE UPPER(CD_USUARIO) LIKE ('%'||UPPER(PRM_SEARCH)||'%')) ORDER BY NM_GROUP ) LOOP
					
					
					IF LENGTH(I.USUARIO) > 0 THEN
						HTP.P('<li title="'||I.CD_GROUP||'" class="opt selected" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||I.NM_GROUP||'</li>');
					ELSE
						HTP.P('<li title="'||I.CD_GROUP||'" class="opt" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||I.NM_GROUP||'</li>');
					END IF; 
					
				END LOOP;
			END IF;

			
			WS_DESCRICAO := 'USU&Aacute;RIOS ATIVOS';
			
			HTP.P('<li class="group">'||FUN.LANG('USU&Aacute;RIOS')||'</li>');
			
			IF NVL(PRM_ADICIONAL, 'N/A') <> 'N/A' THEN

                FOR I IN (
					SELECT T1.USU_NOME, T1.USU_COMPLETO, DECODE(T1.STATUS, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') AS STATUS, T2.USUARIO
					FROM USUARIOS T1 
					LEFT JOIN USER_SCREENS T2 ON T2.USUARIO = T1.USU_NOME AND SCREEN = PRM_ADICIONAL
					WHERE UPPER(USU_NOME) LIKE ('%'||UPPER(PRM_SEARCH)||'%') OR UPPER(USU_COMPLETO) LIKE ('%'||UPPER(PRM_SEARCH)||'%') ORDER BY STATUS, USU_NOME ASC) LOOP
				
					IF WS_DESCRICAO <> I.STATUS THEN
						WS_DESCRICAO := I.STATUS;
						HTP.P('<li class="group">'||WS_DESCRICAO||'</li>');
					END IF;
				
					


						IF LENGTH(I.USUARIO) > 0 THEN
							HTP.P('<li title="'||I.USU_NOME||'" class="opt selected" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||I.USU_NOME||'</li>');
						ELSE
							HTP.P('<li title="'||I.USU_NOME||'" class="opt" onmouseover="updatePermissao(this, ''over'');" onmousedown="updatePermissao(this);">'||I.USU_NOME||'</li>');
						END IF; 
				END LOOP;

			ELSE

                FOR I IN (
					SELECT T1.USU_NOME, T1.USU_COMPLETO, DECODE(T1.STATUS, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') AS STATUS
					FROM USUARIOS T1 
					WHERE UPPER(USU_NOME) LIKE ('%'||UPPER(PRM_SEARCH)||'%') OR UPPER(USU_COMPLETO) LIKE ('%'||UPPER(PRM_SEARCH)||'%') ORDER BY STATUS, USU_NOME ASC) LOOP
				
					IF WS_DESCRICAO <> I.STATUS THEN
						WS_DESCRICAO := I.STATUS;
						HTP.P('<li class="group">'||WS_DESCRICAO||'</li>');
					END IF;
				
					NESTED_TEST_LIST(PRM_REF, I.USU_NOME, I.USU_NOME);

                    	

				END LOOP;

			END IF;
			
			

		WHEN 'lista-usuarios-msgs' THEN
		
			HTP.P('<li class="group">'||FUN.LANG('GRUPOS')||'</li>');
			FOR I IN (SELECT CD_GROUP, NM_GROUP FROM GUSERS ORDER BY NM_GROUP ) LOOP

                SELECT COUNT(*) INTO WS_COUNT FROM TEXT_POST WHERE CD_GROUP IN (SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = WS_USUARIO);

				IF WS_COUNT = 1 THEN
				    NESTED_TEST_LIST(PRM_REF, I.CD_GROUP, TRIM(I.NM_GROUP)||' - 1 mensagem');
				ELSIF WS_COUNT <> 0 THEN
				    NESTED_TEST_LIST(PRM_REF, I.CD_GROUP, TRIM(I.NM_GROUP)||' - '||WS_COUNT||' mensagens');
				ELSE
                    NESTED_TEST_LIST(PRM_REF, I.CD_GROUP, TRIM(I.NM_GROUP));
				END IF;

			END LOOP;
			
			WS_DESCRICAO := 'USU&Aacute;RIOS ATIVOS';
			
			HTP.P('<li class="group">'||FUN.LANG('USU&Aacute;RIOS')||'</li>');
			FOR I IN (SELECT USU_NOME, USU_COMPLETO, DECODE(STATUS, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') AS STATUS FROM USUARIOS WHERE USU_NOME <> GBL.GETUSUARIO ORDER BY STATUS, USU_NOME ASC) LOOP
			
			    IF WS_DESCRICAO <> I.STATUS THEN
				    WS_DESCRICAO := I.STATUS;
					HTP.P('<li class="group">'||WS_DESCRICAO||'</li>');
				END IF;

				WS_COUNT := 0;
			    
				SELECT COUNT(*) INTO WS_COUNT FROM TEXT_POST WHERE CD_USUARIO = I.USU_NOME AND CD_GROUP = WS_USUARIO;
				
				IF WS_COUNT = 1 THEN
				    NESTED_TEST_LIST(PRM_REF, I.USU_NOME, I.USU_NOME||' - 1 mensagem');
				ELSIF WS_COUNT <> 0 THEN
				    NESTED_TEST_LIST(PRM_REF, I.USU_NOME, I.USU_NOME||' - '||WS_COUNT||' mensagens');
				ELSE
                    NESTED_TEST_LIST(PRM_REF, I.USU_NOME, I.USU_NOME);
				END IF;
			END LOOP;
			
		WHEN 'lista-usuarios' THEN
		
		    WS_DESCRICAO := 'USU&Aacute;RIOS ATIVOS';

			FCL.FAKECUSTOM('search', PRM_SEARCH);

            IF PRM_IDENT = 'fake-permissao' THEN
                HTP.P('<li title="" class="opt">NENHUMA PERMISS&Atilde;O</li>');
			END IF;

			FOR I IN (SELECT USU_NOME, USU_COMPLETO, DECODE(STATUS, 'A', 'USU&Aacute;RIOS ATIVOS', 'USU&Aacute;RIOS INATIVOS') AS STATUS FROM USUARIOS WHERE UPPER(USU_NOME) LIKE ('%'||UPPER(PRM_SEARCH)||'%') OR UPPER(USU_COMPLETO) LIKE ('%'||UPPER(PRM_SEARCH)||'%') ORDER BY STATUS, USU_NOME ASC) LOOP
			
			    IF WS_DESCRICAO <> I.STATUS THEN
				    WS_DESCRICAO := I.STATUS;
					HTP.P('<li class="group">'||WS_DESCRICAO||'</li>');
				END IF;

				NESTED_TEST_LIST(PRM_REF, I.USU_NOME, I.USU_NOME);
			END LOOP;

		WHEN 'lista-email' THEN
		
		    WS_DESCRICAO := 'USU&Aacute;RIOS ATIVOS';

			
			FCL.FAKECUSTOM('add', PRM_SEARCH);

            IF PRM_IDENT = 'fake-permissao' THEN
                HTP.P('<li title="" class="opt">NENHUMA PERMISS&Atilde;O</li>');
			END IF;

			FOR I IN (SELECT DISTINCT UPPER(USU_EMAIL) AS EMAIL FROM USUARIOS WHERE USU_EMAIL IS NOT NULL AND STATUS = 'A' ORDER BY UPPER(USU_EMAIL)) LOOP
			
			    




				NESTED_TEST_LIST(PRM_REF, I.EMAIL, I.EMAIL);
			END LOOP;

		WHEN 'lista-tipos' THEN
		    IF TRIM(PRM_REF) = 'SEM' THEN
		        HTP.P('<li title="SEM" class="opt selected">'||FUN.LANG('SEM')||'</li>');
		    ELSE
		        HTP.P('<li title="SEM" class="opt">'||FUN.LANG('SEM')||'</li>');
		    END IF;
			
			IF TRIM(PRM_REF) = 'DATA' THEN
			    HTP.P('<li title="DATA" class="opt selected">'||FUN.LANG('DATA')||'</li>');
			ELSE
			    HTP.P('<li title="DATA" class="opt">'||FUN.LANG('DATA')||'</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'DATA2 sem calend&aacute;rio' THEN
			    HTP.P('<li title="DATA2" class="opt selected">'||FUN.LANG('DATA SEM CALEND&Aacute;RIO')||'</li>');
			ELSE
			    HTP.P('<li title="DATA2" class="opt">'||FUN.LANG('DATA SEM CALEND&Aacute;RIO')||'</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'TEXTO' THEN
			    HTP.P('<li title="TEXTO" class="opt selected">'||FUN.LANG('TEXTO')||'</li>');
			ELSE
			    HTP.P('<li title="TEXTO" class="opt">'||FUN.LANG('TEXTO')||'</li>');
			END IF;
			
			IF TRIM(PRM_REF) = 'LIGACAO' THEN
			    HTP.P('<li title="LIGACAO" class="opt selected">'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||'</li>');
			ELSE
			    HTP.P('<li title="LIGACAO" class="opt">'||FUN.LANG('LIGA&Ccedil;&Atilde;O')||'</li>');
			END IF;
		WHEN 'lista-condicoes' THEN
		    IF TRIM(PRM_REF) = 'IGUAL' THEN
		        HTP.P('<li title="IGUAL" class="opt selected">'||FUN.LANG('IGUAL A')||'</li>');
		    ELSE
		        HTP.P('<li title="IGUAL" class="opt">'||FUN.LANG('IGUAL A')||'</li>');
		    END IF;
		    
		    IF TRIM(PRM_REF) = 'DIFERENTE' THEN
		        HTP.P('<li title="DIFERENTE" class="opt selected">'||FUN.LANG('DIFERENTE DE')||'</li>');
		    ELSE
		        HTP.P('<li title="DIFERENTE" class="opt">'||FUN.LANG('DIFERENTE DE')||'</li>');
		    END IF;
			
			IF TRIM(PRM_REF) = 'MAIOR' THEN
		        HTP.P('<li title="MAIOR" class="opt selected">'||FUN.LANG('MAIOR QUE')||'</li>');
		    ELSE
		        HTP.P('<li title="MAIOR" class="opt">'||FUN.LANG('MAIOR QUE')||'</li>');
		    END IF;
			
			IF TRIM(PRM_REF) = 'MENOR' THEN
		        HTP.P('<li title="MENOR" class="opt selected">'||FUN.LANG('MENOR QUE')||'</li>');
		    ELSE
		        HTP.P('<li title="MENOR" class="opt">'||FUN.LANG('MENOR QUE')||'</li>');
		    END IF;
		    
		    IF TRIM(PRM_REF) = 'MAIOROUIGUAL' THEN
		        HTP.P('<li title="MAIOROUIGUAL" class="opt selected">'||FUN.LANG('MAIOR OU IGUAL A')||'</li>');
		    ELSE
		        HTP.P('<li title="MAIOROUIGUAL" class="opt">'||FUN.LANG('MAIOR OU IGUAL A')||'</li>');
		    END IF;
		    
		    IF TRIM(PRM_REF) = 'MENOROUIGUAL' THEN
		        HTP.P('<li title="MENOROUIGUAL" class="opt selected">'||FUN.LANG('MENOR OU IGUAL A')||'</li>');
		    ELSE
		        HTP.P('<li title="MENOROUIGUAL" class="opt">'||FUN.LANG('MENOR OU IGUAL A')||'</li>');
		    END IF;
		    
			IF PRM_ADICIONAL = 'graph' THEN
                IF TRIM(PRM_REF) = 'COLUNA' THEN
					HTP.P('<li title="COLUNA" class="opt selected">'||FUN.LANG('COLUNA')||'</li>');
				ELSE
					HTP.P('<li title="COLUNA" class="opt">'||FUN.LANG('COLUNA')||'</li>');
				END IF; 
			ELSE
				IF TRIM(PRM_REF) = 'LIKE' THEN
					HTP.P('<li title="LIKE" class="opt selected">'||FUN.LANG('SEMELHANTE A(LIKE)')||'</li>');
				ELSE
					HTP.P('<li title="LIKE" class="opt">'||FUN.LANG('SEMELHANTE A(LIKE)')||'</li>');
				END IF;
				
				IF TRIM(PRM_REF) = 'NOTLIKE' THEN
					HTP.P('<li title="NOTLIKE" class="opt selected">'||FUN.LANG('DIFERENTE(NOT LIKE) DE')||'</li>');
				ELSE
					HTP.P('<li title="NOTLIKE" class="opt">'||FUN.LANG('DIFERENTE(NOT LIKE) DE')||'</li>');
				END IF;
				
				IF TRIM(PRM_REF) = 'NOFLOAT' THEN
					HTP.P('<li title="NOFLOAT" class="opt selected">'||FUN.LANG('IGNORAR FLOAT')||'</li>');
				ELSE
					HTP.P('<li title="NOFLOAT" class="opt">'||FUN.LANG('IGNORAR FLOAT')||'</li>');
				END IF;

				IF TRIM(PRM_REF) = 'NOFILTER' THEN
					HTP.P('<li title="NOFILTER" class="opt selected">'||FUN.LANG('IGNORAR FILTRO')||'</li>');
				ELSE
					HTP.P('<li title="NOFILTER" class="opt">'||FUN.LANG('IGNORAR FILTRO')||'</li>');
				END IF;
			END IF;
		  
		WHEN 'lista-coluna' THEN
		
			FOR I IN (SELECT COLUMN_NAME FROM ALL_TAB_COLUMNS WHERE	OWNER='DWU' AND TABLE_NAME = PRM_VISAO ORDER BY COLUMN_NAME ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.COLUMN_NAME, I.COLUMN_NAME); 
			END LOOP;
		
		WHEN 'lista-consultas' THEN
		    
			WS_DESCRICAO := 'N/A';

		    FCL.FAKECUSTOM('search', PRM_SEARCH);
		    
			FOR I IN (SELECT COD, CD_OBJETO, NM_OBJETO, CD_GRUPO FROM OBJETOS WHERE TP_OBJETO = 'CONSULTA' AND (UPPER(COD) LIKE ('%'||UPPER(NVL(PRM_SEARCH, COD))||'%') OR UPPER(NM_OBJETO) LIKE ('%'||UPPER(NVL(PRM_SEARCH, NM_OBJETO))||'%') ) ORDER BY CD_GRUPO ) LOOP
				
				IF WS_DESCRICAO <> I.CD_GRUPO THEN
				    WS_DESCRICAO := I.CD_GRUPO;
					HTP.P('<li class="group">'||WS_DESCRICAO||'</li>');
				END IF;

				NESTED_TEST_LIST(PRM_REF, I.CD_OBJETO, I.NM_OBJETO, I.COD);
			END LOOP;
		 
		WHEN 'lista-valores' THEN

			FCL.FAKECUSTOM('add', PRM_REF);
		
		    BEGIN
		    
			    SELECT CD_LIGACAO INTO WS_LIGACAO FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_ADICIONAL AND CD_MICRO_VISAO = PRM_VISAO;

				IF WS_LIGACAO <> 'SEM' THEN

				SELECT NDS_TFISICA, NDS_CD_CODIGO, NDS_CD_DESCRICAO INTO WS_TABELA, WS_CODIGO, WS_DESCRICAO FROM CODIGO_DESCRICAO WHERE NDS_TABELA = WS_LIGACAO OR NDS_TFISICA = WS_LIGACAO;

					IF NVL(WS_SEARCH, 'N/A') <> 'N/A' THEN
					
					    WS_SQL := 'select '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||', linha from (select '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||', rownum as linha from (select /*+ FIRST_ROWS(50) */ '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||' from '||WS_TABELA||' where '||TRIM(WS_CODIGO)||' like (''%'||UPPER(WS_SEARCH)||'%'') or '||TRIM(WS_DESCRICAO)||' like (''%'||UPPER(WS_SEARCH)||'%'') order by '||TRIM(WS_DESCRICAO)||' asc)) where linha < 51';

					ELSE
					
					    WS_SQL := 'select '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||', linha from (select '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||', rownum as linha from (select '||TRIM(WS_CODIGO)||', '||TRIM(WS_DESCRICAO)||' from '||WS_TABELA||' order by '||TRIM(WS_DESCRICAO)||' asc))';

					
					END IF;
					
					BEGIN


						WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

						DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

						DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
						DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);
						WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);


						LOOP
							IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
								EXIT;
							END IF;
							WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
							DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
							DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
							IF UPPER(TRIM(PRM_REF)) = UPPER(TRIM(WS_CODIGO)) OR UPPER(TRIM(PRM_REF)) = UPPER(TRIM(WS_DESCRICAO)) THEN
							    HTP.P('<li title="'||TRIM(WS_CODIGO)||'" class="opt selected">'||TRIM(WS_DESCRICAO)||'</li>');
							ELSE
							    HTP.P('<li title="'||TRIM(WS_CODIGO)||'" class="opt">'||TRIM(WS_DESCRICAO)||'</li>');
							END IF;
						END LOOP;

						DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);


					EXCEPTION WHEN OTHERS THEN
						HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'  -  '||WS_SQL);
					END;

				END IF;
				
		    END;
		WHEN 'lista-input-browser' THEN

			IF PRM_ADICIONAL = 'DATE' THEN
			
			    IF PRM_REF = 'data' THEN
					HTP.P('<li title="data"     class="opt selected">DATA</li>');
				ELSE
					HTP.P('<li title="data"     class="opt">DATA</li>');
				END IF;
				
				IF PRM_REF = 'datatime' THEN
					HTP.P('<li title="datatime"     class="opt selected">DATA E HORA</li>');
				ELSE
					HTP.P('<li title="datatime"     class="opt">DATA E HORA</li>');
				END IF;
			
			ELSE
			
				IF PRM_REF = 'text' THEN
					HTP.P('<li title="text"     class="opt selected">TEXTO</li>');
				ELSE
					HTP.P('<li title="text"     class="opt">TEXTO</li>');
				END IF;
				
				IF PRM_REF = 'textarea' THEN
					HTP.P('<li title="textarea" class="opt selected">TEXTO GRANDE</li>');
				ELSE
					HTP.P('<li title="textarea" class="opt">TEXTO GRANDE</li>');
				END IF;
				
				IF PRM_REF = 'number' THEN
					HTP.P('<li title="number"   class="opt selected">N&Uacute;MERO</li>');
				ELSE
					HTP.P('<li title="number"   class="opt">N&Uacute;MERO</li>');
				END IF;
				
				IF PRM_REF = 'ligacao' THEN
					HTP.P('<li title="ligacao"  class="opt selected">LIGA&Ccedil;&Atilde;O</li>');
				ELSE
					HTP.P('<li title="ligacao"  class="opt">LIGA&Ccedil;&Atilde;O</li>');
				END IF;

				IF PRM_REF = 'ligacaoc' THEN
					HTP.P('<li title="ligacaoc" class="opt selected">LIGA&Ccedil;&Atilde;O COM C&Oacute;DIGO</li>');
				ELSE
					HTP.P('<li title="ligacaoc" class="opt">LIGA&Ccedil;&Atilde;O COM C&Oacute;DIGO</li>');
				END IF;
				
				IF PRM_REF = 'listboxp' THEN
					HTP.P('<li title="listboxp" class="opt selected">LISTA PR&Eacute;-DEFINIDA</li>');
				ELSE
					HTP.P('<li title="listboxp" class="opt">LISTA PR&Eacute;-DEFINIDA</li>');
				END IF;
				
				IF PRM_REF = 'listboxt' THEN
					HTP.P('<li title="listboxt" class="opt selected">LISTA DA TABELA</li>');
				ELSE
					HTP.P('<li title="listboxt" class="opt">LISTA DA TABELA</li>');
				END IF;

				IF PRM_ADICIONAL = 'NUMBER' THEN
				
					IF PRM_REF = 'sequence' THEN
						HTP.P('<li title="sequence" class="opt selected">SEQUENCIA</li>');
					ELSE
						HTP.P('<li title="sequence" class="opt">SEQUENCIA</li>');
					END IF;

				END IF;
				
				IF PRM_REF = 'link' THEN
					HTP.P('<li title="link" class="opt selected">LINK</li>');
				ELSE
					HTP.P('<li title="link" class="opt">LINK</li>');
				END IF;
				
			END IF;

		WHEN 'lista-permissao-browser' THEN

			BEGIN
				SELECT TRIM(PERMISSAO) INTO WS_SQL FROM DATA_COLUNA WHERE TRIM(CD_MICRO_DATA) = TRIM(PRM_VISAO) AND TRIM(CD_COLUNA) = TRIM(PRM_ADICIONAL);
			EXCEPTION WHEN OTHERS THEN
				WS_SQL := '';
			END;
				
			FOR I IN ( SELECT USU_COMPLETO, USU_NOME FROM USUARIOS WHERE USU_NOME IN (SELECT USUARIO FROM USER_SCREENS WHERE SCREEN IN (SELECT SCREEN FROM OBJECT_LOCATION WHERE OBJECT_ID = PRM_VISAO)) ORDER BY USU_NOME ) LOOP
				NESTED_TEST_LIST(PRM_REF, I.USU_NOME, I.USU_NOME);
			END LOOP;

		WHEN 'lista-padroes-unicos' THEN

		    HTP.P('<li title="" class="opt">---</li>');

		    FOR I IN ( SELECT CD_PADRAO, NM_PADRAO FROM PARAMETRO_PADRAO ) LOOP
				NESTED_TEST_LIST(TRIM(UPPER(PRM_REF)), UPPER(TRIM(I.CD_PADRAO)), UPPER(TRIM(I.NM_PADRAO)));
			END LOOP;
		
		WHEN 'lista-permissao-browser-op' THEN 

			BEGIN
				SELECT TRIM(PROPRIEDADE) INTO WS_SQL FROM OBJECT_ATTRIB WHERE TRIM(CD_PROP) = PRM_ADICIONAL AND TRIM(CD_OBJECT) = TRIM(PRM_VISAO);
			EXCEPTION WHEN OTHERS THEN
				WS_SQL := '';
			END;
				
			FOR I IN ( SELECT USU_COMPLETO, USU_NOME FROM USUARIOS WHERE USU_NOME IN (SELECT USUARIO FROM USER_SCREENS WHERE SCREEN IN (SELECT SCREEN FROM OBJECT_LOCATION WHERE OBJECT_ID = PRM_VISAO)) ORDER BY USU_NOME ) LOOP
				NESTED_TEST_LIST(WS_SQL, I.USU_NOME, I.USU_NOME);
			END LOOP;
		
        WHEN 'lista-valores-browser' THEN 

			FCL.FAKECUSTOM('add', PRM_REF);
		
		    BEGIN
		    
			    WS_SQL := 'select distinct '||TRIM(PRM_ADICIONAL)||' from '||PRM_VISAO||' where '||TRIM(PRM_ADICIONAL)||' like (''%'||UPPER(PRM_SEARCH)||'%'')';

				BEGIN

					WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

					DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

					DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
					WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

					LOOP
						IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
							EXIT;
						END IF;
						WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
						DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
						IF UPPER(TRIM(PRM_REF)) = UPPER(TRIM(WS_CODIGO)) THEN
							HTP.P('<li title="'||TRIM(WS_CODIGO)||'" class="opt selected">'||TRIM(WS_CODIGO)||'</li>');
						ELSE
							HTP.P('<li title="'||TRIM(WS_CODIGO)||'" class="opt">'||TRIM(WS_CODIGO)||'</li>');
						END IF;
					END LOOP;

					DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

				END;

		    END;

        WHEN 'lista-lovs' THEN

		    HTP.P('<li title="" class="opt">---</li>');

		    FOR I IN(SELECT NDS_CD_CODIGO, NDS_CD_DESCRICAO, NDS_TFISICA, NDS_TABELA FROM CODIGO_DESCRICAO) LOOP
                IF UPPER(TRIM(PRM_REF)) = UPPER(TRIM(I.NDS_TABELA)) THEN
					HTP.P('<li title="'||TRIM(I.NDS_TABELA)||'" class="opt selected">'||TRIM(I.NDS_TABELA)||'</li>');
				ELSE
					HTP.P('<li title="'||TRIM(I.NDS_TABELA)||'" class="opt">'||TRIM(I.NDS_TABELA)||'</li>');
				END IF;
			END LOOP;
		   
		WHEN 'lista-padroes' THEN

			FCL.FAKECUSTOM('search', PRM_SEARCH);
		
			SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(REPLACE(PRM_IDENT, 'padrao_', '')) AND CD_PROP = 'LIMITADORES';
			
			WS_CHECK := FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'FORMATO');
			
			IF WS_COUNT <> 0 THEN
			
				BEGIN
					SELECT NVL(PROPRIEDADE, 'N/A') INTO WS_LIMITADOR FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(REPLACE(PRM_IDENT, 'padrao_', '')) AND CD_PROP = 'LIMITADORES';
				EXCEPTION WHEN OTHERS THEN
					WS_LIMITADOR := 'N/A';
				END;
				
			ELSE 
			    WS_LIMITADOR := 'N/A';
			END IF;
			
			WS_LIGACAO := PRM_VISAO;
			
			CASE FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'ORDEM')
				WHEN 1 THEN
					WS_ORDER := 'ORDER BY 1 ASC';
				WHEN 2 THEN
					WS_ORDER := 'ORDER BY 1 DESC';
				WHEN 3 THEN
					WS_ORDER := 'ORDER BY 2 ASC';
				WHEN 4 THEN
					WS_ORDER := 'ORDER BY 2 DESC';
				ELSE
					WS_ORDER := 'ORDER BY 1 ASC';
			END CASE;
			
			IF WS_LIMITADOR <> 'N/A' THEN
                SELECT LENGTH(PROPRIEDADE) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(REPLACE(PRM_IDENT, 'padrao_', '')) AND CD_PROP = 'LIMITADORES';
            END IF;

			FOR I IN(SELECT NDS_CD_CODIGO, NDS_CD_DESCRICAO, NDS_TFISICA FROM CODIGO_DESCRICAO WHERE UPPER(TRIM(NDS_TABELA)) = UPPER(TRIM(WS_LIGACAO))) LOOP

				IF WS_LIMITADOR = 'N/A' THEN
				    IF LENGTH(TRIM(PRM_SEARCH)) > 0 THEN
					    WS_SQL := ' where upper('||TRIM(I.NDS_CD_CODIGO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') or upper('||TRIM(I.NDS_CD_DESCRICAO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') ';
				    END IF;
				ELSE
				    IF LENGTH(TRIM(PRM_SEARCH)) > 0 THEN
					    IF WS_COUNT <> 0 THEN
						    WS_SQL := ' where (upper('||TRIM(I.NDS_CD_CODIGO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') or upper('||TRIM(I.NDS_CD_DESCRICAO)||') like (''%'||UPPER(PRM_SEARCH)||'%'')) and '||TRIM(I.NDS_CD_CODIGO)||' in (select trim(column_value) from table(fun.vpipe((select trim(propriedade) from object_attrib where trim(cd_object) = '''||REPLACE(TRIM(PRM_IDENT), 'padrao_', '')||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
				        ELSE
							WS_SQL := ' where (upper('||TRIM(I.NDS_CD_CODIGO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') or upper('||TRIM(I.NDS_CD_DESCRICAO)||') like (''%'||UPPER(PRM_SEARCH)||'%''))';
						END IF;
					ELSE
					    IF WS_COUNT <> 0 THEN
				            WS_SQL := ' where '||TRIM(I.NDS_CD_CODIGO)||' in (select column_value from table(fun.vpipe((select propriedade from object_attrib where cd_object = '''||REPLACE(TRIM(PRM_IDENT), 'padrao_', '')||''' and cd_prop = ''LIMITADORES'' and rownum = 1))))';
				        END IF;
					END IF;
				END IF;

				WS_ENCADEADO := FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'ENCADEADO');

				IF NVL(WS_ENCADEADO, 'N/A') <> 'N/A' THEN

                    


					
					
					SELECT CONTEUDO INTO WS_CONTEUDO FROM PARAMETRO_USUARIO WHERE 
					TRIM(UPPER(CD_PADRAO)) = TRIM(UPPER(WS_ENCADEADO)) AND CD_USUARIO = WS_USUARIO;

					
					WS_ENCADEADO_COL := FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'ENCADEADO_COL');

                    IF INSTR(WS_SQL, 'where') > 0 THEN
						WS_SQL := WS_SQL||' and '||NVL(WS_ENCADEADO_COL, WS_ENCADEADO)||' = '||CHR(39)||WS_CONTEUDO||CHR(39);
					ELSE
						WS_SQL := ' where '||NVL(WS_ENCADEADO_COL, WS_ENCADEADO)||' = '||CHR(39)||WS_CONTEUDO||CHR(39);
					END IF;
					
				END IF;
				
				

				WS_SQL := 'select DISTINCT '||TRIM(I.NDS_CD_CODIGO)||', '||TRIM(I.NDS_CD_DESCRICAO)||' from '||TRIM(I.NDS_TFISICA)||WS_SQL||' '||WS_ORDER;

				WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

				DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 60);
				DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 60);

				WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

				
				



				LOOP
						
					WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
					IF  WS_LINHAS <> 1 THEN
						EXIT;
					END IF;

					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);

                    WS_SELECTED := 0;

					SELECT COUNT(*) INTO WS_SELECTED FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND TRIM(CD_PADRAO) = REPLACE(TRIM(PRM_IDENT), 'padrao_', '') AND TRIM(CONTEUDO) = TRIM(WS_CODIGO);
					
					
					IF WS_CODIGO = WS_DESCRICAO OR NVL(WS_CHECK, '0') = '1' THEN
						WS_VALUE := WS_CODIGO;
					ELSIF NVL(WS_CHECK, '0') = '0' THEN
						WS_VALUE := WS_CODIGO||' - '||WS_DESCRICAO;
					ELSE
						WS_VALUE := WS_DESCRICAO;
					END IF;
					
					IF WS_SELECTED = 1 THEN
					    HTP.P('<li title="'||WS_CODIGO||'" class="opt selected">'||WS_VALUE||'</li>');
					ELSE
					    HTP.P('<li title="'||WS_CODIGO||'" class="opt">'||WS_VALUE||'</li>');
					END IF;

				END LOOP;
					DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

				SELECT COUNT(*) INTO WS_COUNT FROM TABLE(FUN.VPIPE(PRM_REF)) T1 WHERE T1.COLUMN_VALUE NOT IN (SELECT NVL(T2.COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE(SUBSTR(WS_ACUMULADO, 2, 12000))) T2 ) AND T1.COLUMN_VALUE NOT LIKE ('%[NOT]%');

                
				IF LENGTH(TRIM(PRM_SEARCH)) = 0 THEN
					IF WS_COUNT > 0 THEN
						HTP.P('<li class="group">N&Atilde;O ENCONTRADOS</li>');

						FOR N IN (SELECT T1.COLUMN_VALUE AS CONTEUDO FROM TABLE(FUN.VPIPE(PRM_REF)) T1 WHERE T1.COLUMN_VALUE NOT IN (SELECT NVL(T2.COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE(SUBSTR(WS_ACUMULADO, 2, 12000))) T2 ) AND T1.COLUMN_VALUE NOT LIKE ('%[NOT]%')) LOOP
							HTP.P('<li title="'||N.CONTEUDO||'" class="opt selected">'||N.CONTEUDO||'</li>');
						END LOOP;
					END IF;
				END IF;

			END LOOP;
			
		WHEN 'lista-padroes-filtros' THEN

			FCL.FAKECUSTOM('search', PRM_SEARCH);
			
		    BEGIN
				SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(REPLACE(PRM_IDENT, 'padrao_', '')) AND CD_PROP = 'LIMITADORES' AND PROPRIEDADE IS NOT NULL;
				
                WS_CHECK := FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'FORMATO');
				
				IF WS_COUNT <> 0 THEN
				
					BEGIN
						SELECT NVL(PROPRIEDADE, 'N/A') INTO WS_LIMITADOR FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(REPLACE(PRM_IDENT, 'padrao_', '')) AND CD_PROP = 'LIMITADORES'  AND PROPRIEDADE IS NOT NULL;
					EXCEPTION WHEN OTHERS THEN
						WS_LIMITADOR := 'N/A';
					END;
					
				ELSE 
					WS_LIMITADOR := 'N/A';
				END IF;

				
				WS_LIGACAO := PRM_VISAO;

				
				CASE FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'ORDEM')
					WHEN '1' THEN
						WS_ORDER := 'ORDER BY 1 ASC';
					WHEN '2' THEN
						WS_ORDER := 'ORDER BY 1 DESC';
					WHEN '3' THEN
						WS_ORDER := 'ORDER BY 2 ASC';
					WHEN '4' THEN
						WS_ORDER := 'ORDER BY 2 DESC';
					ELSE
						WS_ORDER := 'ORDER BY 1 ASC';
				END CASE;

				
				IF WS_LIMITADOR <> 'N/A' THEN
					SELECT LENGTH(PROPRIEDADE) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE CD_OBJECT = TRIM(REPLACE(PRM_IDENT, 'padrao_', '')) AND CD_PROP = 'LIMITADORES'  AND PROPRIEDADE IS NOT NULL;
				END IF;


				FOR I IN(SELECT NDS_CD_CODIGO, NDS_CD_DESCRICAO, NDS_TFISICA FROM CODIGO_DESCRICAO WHERE NDS_TABELA = (SELECT CD_LIGACAO FROM PARAMETRO_PADRAO WHERE UPPER(TRIM(CD_PADRAO)) = UPPER(TRIM(REPLACE(PRM_IDENT, 'padrao_', ''))) )) LOOP
	
					WS_SQL := '';
					
					IF LENGTH(TRIM(PRM_SEARCH)) > 0 THEN
						IF WS_COUNT = 0 THEN
							WS_SQL := ' where upper('||TRIM(I.NDS_CD_CODIGO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') or upper('||TRIM(I.NDS_CD_DESCRICAO)||') like (''%'||UPPER(PRM_SEARCH)||'%'')';
						ELSE
							WS_SQL := ' where upper('||TRIM(I.NDS_CD_CODIGO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') or upper('||TRIM(I.NDS_CD_DESCRICAO)||') like (''%'||UPPER(PRM_SEARCH)||'%'') and '||TRIM(I.NDS_CD_CODIGO)||' in (select column_value from table(fun.vpipe(('''||WS_LIMITADOR||'''))))';
						END IF;
					ELSE
						IF WS_COUNT <> 0 THEN
							WS_SQL := ' where trim('||TRIM(I.NDS_CD_CODIGO)||') in (select trim(column_value) from table(fun.vpipe(('''||WS_LIMITADOR||'''))))';
						END IF;
					END IF;

					WS_ENCADEADO := FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'ENCADEADO');

					IF NVL(WS_ENCADEADO, 'N/A') <> 'N/A' THEN

						
						SELECT CHR(39)||LISTAGG(CONTEUDO, CHR(39)||' , '||CHR(39)) WITHIN GROUP (ORDER BY CONTEUDO)||CHR(39) INTO WS_CONTEUDO FROM FLOAT_FILTER_ITEM WHERE 
						TRIM(UPPER(CD_COLUNA)) = TRIM(UPPER(WS_ENCADEADO)) AND CD_USUARIO = WS_USUARIO AND SCREEN IN (SELECT CD_CONTEUDO FROM TABLE(FUN.VPIPE_PAR(PRM_ADICIONAL)));

						
						WS_ENCADEADO_COL := FUN.GETPROP(TRIM(REPLACE(PRM_IDENT, 'padrao_', '')), 'ENCADEADO_COL');

                        IF INSTR(WS_SQL, 'where') > 0 THEN
						    WS_SQL := WS_SQL||' and '||NVL(WS_ENCADEADO_COL, WS_ENCADEADO)||' in ('||WS_CONTEUDO||')';
						ELSE
						    WS_SQL := ' where '||NVL(WS_ENCADEADO_COL, WS_ENCADEADO)||' in ('||WS_CONTEUDO||')';
						END IF;
						
					END IF;

					WS_SQL := 'select coluna, descricao from( select DISTINCT '||TRIM(I.NDS_CD_CODIGO)||' as coluna, '||TRIM(I.NDS_CD_DESCRICAO)||' as descricao from '||TRIM(I.NDS_TFISICA)||WS_SQL||') '||WS_ORDER;

                    
					WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

					DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
					DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 60);
					DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 60);

					WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

					LOOP
							
						WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
						IF  WS_LINHAS <> 1 THEN
							EXIT;
						END IF;

						DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
						DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);

						WS_SELECTED := 0;

						SELECT COUNT(*) INTO WS_SELECTED FROM FLOAT_FILTER_ITEM WHERE 
						CD_USUARIO = WS_USUARIO AND 
						SCREEN IN (SELECT CD_CONTEUDO FROM TABLE(FUN.VPIPE_PAR(PRM_ADICIONAL))) AND 
						TRIM(CONTEUDO) = TRIM(WS_CODIGO) AND 
						TRIM(CD_COLUNA) IN (SELECT CD_COLUNA FROM TABLE(FUN.VPIPE_PAR(PRM_ADICIONAL)));

						SELECT COUNT(*) INTO WS_REVERSE FROM FLOAT_FILTER_ITEM WHERE 
						CD_USUARIO = WS_USUARIO AND 
						SCREEN IN (SELECT CD_CONTEUDO FROM TABLE(FUN.VPIPE_PAR(PRM_ADICIONAL))) AND 
						TRIM(CONTEUDO) = '$[NOT]'||TRIM(WS_CODIGO) AND 
						TRIM(CD_COLUNA) IN (SELECT CD_COLUNA FROM TABLE(FUN.VPIPE_PAR(PRM_ADICIONAL)));


						WS_CLASS := 'opt'; 

						IF WS_SELECTED <> 0 THEN
							WS_CLASS := WS_CLASS||' selected';
						END IF;

						IF WS_REVERSE <> 0 THEN
							WS_CLASS := WS_CLASS||' reverse';
						END IF;

						IF WS_CODIGO = WS_DESCRICAO OR NVL(WS_CHECK, '0') = '1' THEN
                            WS_VALUE := WS_CODIGO;
						ELSIF NVL(WS_CHECK, '0') = '0' THEN
							WS_VALUE := WS_CODIGO||' - '||WS_DESCRICAO;
						ELSE
						    WS_VALUE := WS_DESCRICAO;
						END IF;

						HTP.P('<li title="'||WS_CODIGO||'" class="'||WS_CLASS||'">'||WS_VALUE||'</li>');

						BEGIN
							WS_ACUMULADO := WS_ACUMULADO||'|'||WS_CODIGO;
						EXCEPTION WHEN OTHERS THEN
							ws_erro := DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||WS_SQL;
						END;

					END LOOP;
					DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

				END LOOP;

				INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, ws_erro||' - ACUMULADO DO FLOAT', GBL.GETUSUARIO, 'ERRO');
				COMMIT;


				SELECT COUNT(*) INTO WS_COUNT FROM TABLE(FUN.VPIPE(FUN.CONVERTE(PRM_REF))) T1 WHERE T1.COLUMN_VALUE NOT IN (SELECT NVL(T2.COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE(SUBSTR(WS_ACUMULADO, 2, 12000))) T2 ) AND T1.COLUMN_VALUE NOT LIKE ('%[NOT]%');

                
				IF LENGTH(TRIM(PRM_SEARCH)) = 0 THEN
					IF WS_COUNT > 0 THEN
						HTP.P('<li class="group">N&Atilde;O ENCONTRADOS</li>');

						FOR N IN (SELECT T1.COLUMN_VALUE AS CONTEUDO FROM TABLE(FUN.VPIPE(PRM_REF)) T1 WHERE T1.COLUMN_VALUE NOT IN (SELECT NVL(T2.COLUMN_VALUE, 'N/A') FROM TABLE(FUN.VPIPE(SUBSTR(WS_ACUMULADO, 2, 12000))) T2 ) AND T1.COLUMN_VALUE NOT LIKE ('%[NOT]%')) LOOP
							HTP.P('<li title="'||N.CONTEUDO||'" class="opt selected">'||N.CONTEUDO||'</li>');
						END LOOP;
					END IF;
				END IF;

			EXCEPTION WHEN OTHERS THEN
                IF WS_ADMIN = 'A' THEN
				    INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||WS_SQL||' - ERRO NO FLOAT', GBL.GETUSUARIO, 'ERRO');
					COMMIT;
					
				END IF;
			END;

    END CASE;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(SQLERRM);
END FAKELISTOPTIONS;


PROCEDURE MENU ( PRM_MENU    VARCHAR2 DEFAULT NULL,
                 PRM_DEFAULT VARCHAR2 DEFAULT NULL ) AS

    WS_PRIMEIRO	VARCHAR2(60);
	WS_GRUPO    VARCHAR2(40)  := '999999999';
	WS_CODIGO   VARCHAR2(400);
	WS_VISAO    VARCHAR2(120);
	WS_DESC     VARCHAR2(120);
	WS_COLUNAS  VARCHAR2(800);
	WS_COUNT    NUMBER := 0;
	WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(80);
	WS_PADRAO   VARCHAR2(80)  := 'PORTUGUESE';
	WS_TIPOGRAFICO VARCHAR2(80);

	WS_NOUSER	EXCEPTION;
	

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;
    WS_ADMIN   := GBL.GETNIVEL;
	

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOUSER;
	END IF; 

    CASE PRM_MENU

	WHEN 'report_schedule' THEN

        HTP.P('<h4>'||FUN.LANG('HOR&Aacute;RIO DO REPORT')||'</h4>');
	    
		FCL.FAKEOPTION('prm_semana', FUN.LANG('Dias/semana'), '', 'lista-semanas', 'N', 'S', PRM_MIN => 1);

		FCL.FAKEOPTION('prm_mes', FUN.LANG('Meses'), '', 'lista-meses', 'N', 'S', PRM_MIN => 1);

		FCL.FAKEOPTION('prm_hora', FUN.LANG('Hora'), '', 'lista-horas', 'N', 'S', PRM_MIN => 1);

		HTP.P('<select id="prm_quarter" onchange="">');
			HTP.P('<option value="1">1m</option>');
			HTP.P('<option value="5">5m</option>');
			HTP.P('<option value="10">10m</option>');
			HTP.P('<option value="15">15m</option>');
			HTP.P('<option value="20">20m</option>');
			HTP.P('<option value="30">30m</option>');
			HTP.P('<option value="60">'||FUN.LANG('NA HORA')||'</option>');								
		HTP.P('</select>');

		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" id="adicionar-report-schedule" class="addpurple" data-req="addReportSchedule" data-par="prm_id|prm_semana|prm_mes|prm_hora|prm_quarter" data-children="" data-res="reportSchedule" data-res-par="prm_id" data-sup="" data-save="" data-msg="'||FUN.LANG('HOR&Aacute;RIO ADICIONADO')||'" data-pkg="com">'||FUN.LANG('ADICIONAR')||'</a></td>');
	
	WHEN 'report' THEN

	    HTP.P('<h4>'||FUN.LANG('REPORT')||'</h4>');

		FCL.FAKEOPTION('prm_email', 'Email', '', 'lista-email', 'N', 'S', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_usuario', FUN.LANG('Usu&aacute;rio'), '', 'lista-usuarios', 'N', 'N', PRM_MIN => 1);

        HTP.P('<input type="text" id="prm_assunto" placeholder="'||FUN.LANG('Assunto')||'" />');

        HTP.P('<textarea id="prm_msg" placeholder="'||FUN.LANG('Mensagem')||'"></textarea>');

		FCL.FAKEOPTION('prm_tela', FUN.LANG('Escolha uma tela'), '', 'lista-telas-todas', 'N', 'N', PRM_ADICIONAL => 'prm_usuario');

		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" id="adicionar-report" class="addpurple" data-req="addReport" data-par="prm_usuario|prm_assunto|prm_msg|prm_tela|prm_email" data-children="" data-res="report" data-res-par="" data-sup="" data-save="" data-msg="'||FUN.LANG('ADICIONADO COM SUCESSO')||'" data-pkg="com">'||FUN.LANG('ADICIONAR')||'</a></td>');

	WHEN 'add_custom' THEN

	    HTP.P('<h4>'||FUN.LANG('PERMISS&Atilde;O DE CUSTOMIZA&Ccedil;&Atilde;O')||'</h4>');

		HTP.P('<input type="hidden" id="prm_usuario" value="'||PRM_DEFAULT||'">');

		FCL.FAKEOPTION('prm_visao', FUN.LANG('Lista de views'), '', 'lista-views', 'N', 'N', PRM_CHILDREN => 'prm_colunas', PRM_MIN => 1);

		FCL.FAKEOPTION('prm_colunas', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'S', 'prm_visao', PRM_MIN => 1);

		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" id="adicionar-custom" class="addpurple" data-req="addCustomizado" data-par="prm_usuario|prm_visao|prm_colunas" data-children="" data-res="listaCustomizado" data-res-par="prm_usuario" data-sup="add_custom&prm_default='||PRM_DEFAULT||'" data-save="" data-msg="'||FUN.LANG('Permiss&atilde;o adicionada')||'">'||FUN.LANG('ADICIONAR')||'</a></td>');
	
	WHEN 'gerar' THEN

	    

		HTP.P('<h4>'||FUN.LANG('GERAR CONSULTA')||'</h4>');

		SELECT COUNT(DISTINCT NM_VISAO) INTO WS_COUNT FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO;

		IF WS_COUNT > 1 THEN
		    HTP.P('<a class="script" onclick="call(''conteudoCustomizado'', '''').then(function(res){ get(''content'').innerHTML = res; });"></a>');
			FCL.FAKEOPTION('prm_visao', FUN.LANG('Lista de tabelas'), '', 'lista-views-custom', 'N', 'N', PRM_CHILDREN => 'prm_coluna_agrup|prm_coluna_valor|prm_coluna_pivot|filtroc-coluna|prm_coluna_tipo|prm_limite|lista-custom-fav', PRM_MIN => 1);
		ELSE
		    SELECT NM_MICRO_VISAO, DS_MICRO_VISAO INTO WS_VISAO, WS_DESC FROM MICRO_VISAO WHERE NM_MICRO_VISAO IN(SELECT NM_VISAO FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = WS_USUARIO);
            HTP.P('<input type="text" value="'||WS_DESC||'" title="'||WS_VISAO||'" id="prm_visao" readonly style="text-transform: uppercase; font-size: 13px;"/>');
		END IF;
 
		FCL.FAKEOPTION('prm_coluna_agrup', FUN.LANG('Lista de agrupadores'), '', 'lista-agrupador-custom', 'N', 'S', 'prm_visao', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_coluna_valor', FUN.LANG('Lista de valores'), '', 'lista-valor-custom', 'N', 'S', 'prm_visao', PRM_MIN => 1);

		FCL.FAKEOPTION('prm_coluna_pivot', FUN.LANG('Lista de pivots'), '', 'lista-pivot-custom', 'N', 'S', 'prm_visao');

		

		

		HTP.P('<a title="'||FUN.LANG('Gerar')||'" id="gerar-custom" class="addpurple" data-req="geraCustomizado" data-par="prm_visao|prm_coluna_agrup|prm_coluna_valor|prm_coluna_pivot|prm_coluna_tipo|prm_limite|filtropipe" data-children="" data-res-tar="custom-conteudo" data-save="arrGerarCustom" data-msg="Consulta gerada" data-load="content">'||FUN.LANG('GERAR CONSULTA')||'</a></td>');
     
		

		HTP.P('<h4>'||FUN.LANG('ADICIONAR FILTRO')||'</h4>');

		HTP.P('<span id="filtropipe" title="" class="invisible">'||FUN.LANG('filtros')||'</span>');
				
		FCL.FAKEOPTION('filtroc-coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas-custom', 'N', 'N', 'prm_visao', PRM_CHILDREN => 'filtroc-condicao|filtroc-valores');
		
		FCL.FAKEOPTION('filtroc-condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), FUN.LANG('IGUAL A'), '$condicoesSimples', 'N', 'N', '', '');
		
		FCL.FAKEOPTION('filtroc-valores', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'filtroc-coluna', PRM_MIN => 1);
		
		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="addpurple" onclick="montaCustom();">'||FUN.LANG('ADICIONAR FILTRO')||'</a>');

	WHEN 'data_table' THEN

	    HTP.P('<h4>'||FUN.LANG('COLUNAS DISPON&Iacute;VEIS')||'</h4>');

		SELECT CD_COLUNA, CD_CONTEUDO INTO WS_VISAO, WS_CODIGO FROM TABLE(FUN.VPIPE_PAR((PRM_DEFAULT)));

        FCL.FAKEOPTION('prm_coluna', FUN.LANG('Lista de colunas'), '', 'lista-dimensoes', 'N', 'S', WS_VISAO, PRM_ADICIONAL => WS_CODIGO);

		HTP.P('<a class="addpurple followed" onclick="var objeto = document.getElementById(''prm_objeto'').value; call(''alter_consulta'', ''prm_nome=''+objeto+''&prm_valor=''+this.previousElementSibling.title+''&prm_tipo=coluna'').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AD); carrega(''consulta?prm_objeto=''+objeto+''&prm_visao='||WS_VISAO||'''); carregaPainel(''data_table'', '''||PRM_DEFAULT||''');  } else { alerta(''feed-fixo'', TR_ES); } });">'||FUN.LANG('ADICIONAR DIMENS&Atilde;O')||'</a>');

		FCL.FAKEOPTION('prm_medida', FUN.LANG('Lista de medidas'), '', 'lista-medidas', 'N', 'S', WS_VISAO, PRM_ADICIONAL => WS_CODIGO);

		HTP.P('<a class="addpurple followed" onclick="var objeto = document.getElementById(''prm_objeto'').value; call(''alter_consulta'', ''prm_nome=''+objeto+''&prm_valor=''+this.previousElementSibling.title+''&prm_tipo=agrupador'').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AD); carrega(''consulta?prm_objeto=''+objeto+''&prm_visao='||WS_VISAO||'''); carregaPainel(''data_table'', '''||PRM_DEFAULT||'''); } else { alerta(''feed-fixo'', TR_ES); } });">'||FUN.LANG('ADICIONAR MEDIDA')||'</a>');

		FCL.FAKEOPTION('prm_pivot', FUN.LANG('Lista de pivots'), '', 'lista-dimensoes', 'N', 'S', WS_VISAO, PRM_ADICIONAL => WS_CODIGO);

		HTP.P('<a class="addpurple" onclick="var objeto = document.getElementById(''prm_objeto'').value; call(''alter_consulta'', ''prm_nome=''+objeto+''&prm_valor=''+this.previousElementSibling.title+''&prm_tipo=pivot'').then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', TR_AD); carrega(''consulta?prm_objeto=''+objeto+''&prm_visao='||WS_VISAO||'''); carregaPainel(''data_table'', '''||PRM_DEFAULT||'''); } else { alerta(''feed-fixo'', TR_ES); } });">'||FUN.LANG('ADICIONAR PIVOT')||'</a>');

    WHEN 'calculada' THEN

	    HTP.P('<h4>'||FUN.LANG('LINHA CALCULADA')||'</h4>');

		SELECT CD_MICRO_VISAO INTO WS_VISAO FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_DEFAULT;

		HTP.P('<input id="prm_visao" type="hidden" value="'||WS_VISAO||'" />');

		HTP.P('<input id="prm_objeto" type="hidden" value="'||PRM_DEFAULT||'" />');
	    
		HTP.P('<select title="'||FUN.LANG('COLUNA')||'" id="prm_coluna">');
			HTP.P('<option selected disabled hidden value="N/A">'||FUN.LANG('COLUNA')||'</option>');
			FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((SELECT CS_COLUNA FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_DEFAULT)))) LOOP
				HTP.P('<option value="'||I.COLUMN_VALUE||'">'||I.COLUMN_VALUE||'</option>');
			END LOOP;
		HTP.P('</select>');

		HTP.P('<input type="text" id="prm_show" placeholder="ID" value="" data-min="2">');
		HTP.P('<input type="text" id="prm_desc" placeholder="'||FUN.LANG('Descri&ccedil;&atilde;o')||'" value="" data-min="2" data-encode="S">');
		
		HTP.P('<a class="addpurple" data-req="create_linha" data-par="prm_objeto|prm_visao|prm_coluna|prm_show|prm_desc" data-res="list_calculada" data-res-par="prm_objeto|prm_visao"  data-sup="calculada&prm_default='||PRM_DEFAULT||'">'||FUN.LANG('ADICIONAR CALCULADA')||'</a>');

    WHEN 'editview' THEN

        HTP.P('<h4>'||FUN.LANG('EDI&Ccedil;&Atilde;O DE VIEWS')||'</h4>');

        HTP.P('<a class="script" onclick="edit_view();"></a>');
		FCL.FAKEOPTION('view_list', FUN.LANG('Escolha uma op&ccedil;&atilde;o'), '', 'lista-realviews', 'N', 'N', '');
		
		HTP.P('<a class="addpurple" onclick="mostrak(''N'');">'||FUN.LANG('COMPILAR')||'</a>');

    WHEN 'import' THEN

		HTP.P('<h4>'||FUN.LANG('IMPORTA&Ccedil;&Atilde;O DE EXCEL')||'</h4>');
		
		HTP.P('<input type="text" placeholder="'||FUN.LANG('NOME DA IMPORTA&Ccedil;&Atilde;O')||'" id="import-modelo" />');
		
		FCL.FAKEOPTION('import-arquivo', FUN.LANG('ARQUIVO'), '', 'lista-xls', 'S', 'N');
		
        FCL.FAKEOPTION('visao_tabela', FUN.LANG('Escolha a tabela'), '', 'lista-tabelas', 'S', 'N', '');
			
		




			
		HTP.P('<select id="import-acao">');
			HTP.P('<option value="ADD" selected disabled hidden>'||FUN.LANG('A&Ccedil;&Atilde;O')||'</option>');
			HTP.P('<option value="ADD">'||FUN.LANG('ADICIONAR A TABELA')||'</option>');
			HTP.P('<option value="DELETE">'||FUN.LANG('LIMPAR TABELA E ADICIONAR')||'</option>');
		HTP.P('</select>');

		HTP.P('<a class="addpurple" title="'||FUN.LANG('adicionar')||'" onclick="importAddModel()">'||FUN.LANG('ADICIONAR MODELO')||'</a>');

        






    WHEN 'list_ofiltro' THEN

        IF FUN.CHECK_ADMIN('FILTERS_ADD') THEN
		
			HTP.P('<h4>'||FUN.LANG('ADICIONAR FILTRO')||'</h4>');
			
			SELECT CD_CONTEUDO, CD_COLUNA INTO WS_VISAO, WS_CODIGO FROM TABLE(FUN.VPIPE_PAR(PRM_DEFAULT));
			
			HTP.P('<a class="script" id="filtro-visao" title="'||WS_VISAO||'"></a>');
			
			FCL.FAKEOPTION('filtro-coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'filtro-visao', '', ''||WS_CODIGO||'');
			
			FCL.FAKEOPTION('filtro-condicao', '', FUN.LANG('Lista de condi&ccedil;&otilde;es'), 'lista-condicoes', 'N', 'N', '', '');
			
			FCL.FAKEOPTION('filtro-valores', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'filtro-visao', '', 'filtro-coluna', '', '', '');
			
			HTP.P('<select id="p_agrupado">');
				HTP.P('<option value="N">'||FUN.LANG('N&atilde;o agrupado')||'</option>');
				HTP.P('<option value="S">'||FUN.LANG('Agrupado')||'</option>');
			HTP.P('</select>');

		    HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="addpurple" onclick="var agrupado = document.getElementById(''p_agrupado'').value; var coluna = document.getElementById(''filtro-coluna'').title; var condicao = document.getElementById(''filtro-condicao'').title; var valores = document.getElementById(''filtro-valores'').title; var ligacao = ''and''; valores = encodeURIComponent(valores); if(valores.length > 0){ call(''edit_ofiltro'', ''new_cd_objeto='||WS_CODIGO||'&new_cd_coluna=''+coluna+''&new_condicao=''+condicao+''&new_conteudo=''+valores+''&prm_ligacao=''+ligacao+''&prm_visao='||WS_VISAO||'&prm_agrupado=''+agrupado).then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ reload('''||WS_CODIGO||'''); alerta(''feed-fixo'', '''||FUN.LANG('Filtro adicionado com sucesso')||'!''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||WS_CODIGO||'&prm_visao='||WS_VISAO||''', false, ''content''); reload('''||WS_CODIGO||'''); } else { alerta(''feed-fixo'', TR_ES); } }); }">'||FUN.LANG('ADICIONAR FILTRO')||'</a>');
        END IF;

    WHEN 'prefixo' THEN
        
		HTP.P('<input type="text" placeholder="'||FUN.LANG('PREFIXO')||'">');
        HTP.P('<input type="text" placeholder="'||FUN.LANG('TIPO LOV')||'">');
        HTP.P('<input type="text" placeholder="'||FUN.LANG('PREFIXO LOV')||'">');
        HTP.P('<input type="text" placeholder="'||FUN.LANG('AGRUPADOR')||'">');
        HTP.P('<input type="text" placeholder="'||FUN.LANG('M&Aacute;SCARA')||'">');
        HTP.P('<select>');
            HTP.P('<option value="LEFT">'||FUN.LANG('esquerda')||'</option>');
            HTP.P('<option value="CENTER">'||FUN.LANG('centro')||'</option>');
            HTP.P('<option value="RIGHT">'||FUN.LANG('direita')||'</option>');
        HTP.P('</select>');
		HTP.P('<a class="add" onclick="savePrefixo(this, ''add'');" title="'||FUN.LANG('ADICIONAR')||'">+</a>');

    WHEN 'browserfiltro' THEN

        HTP.P('<h4>'||FUN.LANG('FILTROS DO BROWSER')||'</h4>');
			
			IF WS_ADMIN = 'A' THEN
			    FCL.FAKEOPTION('filtro-usuario', FUN.LANG('Usu&aacute;rio'), '', 'lista-usuarios', 'N', 'N');
			ELSE
			    HTP.P('<input type="hidden" id="filtro-usuario" title="'||WS_USUARIO||'" />');
			END IF;
			
			FCL.FAKEOPTION('filtro-coluna', '', FUN.LANG('COLUNA'), 'lista-coluna', 'N', 'N', 'filtro-visao', '');

			FCL.FAKEOPTION('filtro-condicao', '', FUN.LANG('CONDI&Ccedil;&Atilde;O'), 'lista-condicoes', 'N', 'N', '', '', '', '');

			FCL.FAKEOPTION('filtro-conteudo', FUN.LANG('VALOR'), '', 'lista-valores-browser', 'S', 'N', 'filtro-visao', '', 'filtro-coluna');
			
			HTP.P('<input type="hidden" id="p_ligacao" value="and" />');
			HTP.P('<input type="hidden" id="p_agrupado" value="N" />');

			HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="addpurple" onclick="var datalist = encodeURIComponent(document.getElementById(''filtro-conteudo'').title); if(datalist.length > 0){ call(''edit_ofiltro'', ''new_cd_objeto='||PRM_DEFAULT||'&new_cd_coluna=''+document.getElementById(''filtro-coluna'').title+''&new_condicao=''+document.getElementById(''filtro-condicao'').title+''&new_conteudo=''+datalist+''&prm_ligacao=''+document.getElementById(''p_ligacao'').value+''&prm_visao='||WS_CODIGO||'&prm_agrupado=''+document.getElementById(''p_agrupado'').value+''&prm_usuario=''+document.getElementById(''filtro-usuario'').title).then(function(resposta){ if(resposta.indexOf(''#alert'') == -1){ alerta(''feed-fixo'', '''||FUN.LANG('Filtro adicionado com sucesso')||'!''); ajax(''list'', ''list_ofiltro'', ''ws_par_sumary='||PRM_DEFAULT||'&prm_visao=''+document.getElementById(''filtro-visao'').title, false, ''content''); } else { alerta(''msg'', TR_ES); } }); }">'||FUN.LANG('ADICIONAR FILTRO')||'</a>');
	
	        

        


        
	WHEN 'browser' THEN

	    SELECT CD_COLUNA, CD_CONTEUDO INTO WS_CODIGO, WS_VISAO FROM TABLE(FUN.VPIPE_PAR(PRM_DEFAULT));
		
		HTP.P('<h4>'||FUN.LANG('COLUNAS DO BROWSER')||'</h4>');

		SELECT CD_COLUNA, CD_CONTEUDO INTO WS_CODIGO, WS_VISAO FROM TABLE(FUN.VPIPE_PAR(PRM_DEFAULT));

		HTP.P('<input type="hidden" value="'||WS_CODIGO||'"/>');

        FCL.FAKEOPTION(WS_CODIGO||'_fake', FUN.LANG('Escolha a coluna'), '', 'lista-coluna-browser', 'N', 'N', WS_VISAO);


		HTP.P('<input type="text" placeholder="'||FUN.LANG('R&Oacute;TULO')||'">');

		HTP.P('<a class="addpurple" onclick=" var dados = this.parentNode; if(dados.children[2].title.length > 0){ ajax(''return'', ''browserConfig_alter'', ''prm_microdata=''+dados.children[1].value+''&prm_coluna=''+dados.children[2].title+''&prm_rotulo=''+dados.children[3].value+''&prm_mascara=&prm_ligacao=SEM&prm_chave=&prm_branco=&prm_default=&prm_alinhamento=left&prm_invisivel=N&prm_formula=&prm_tipo=&prm_alignds=left&prm_tipoinput=text&prm_tamanho=&prm_validacao=&prm_ordem=''+document.getElementById(''browserconfig'').children.length+''&prm_permissao=W&prm_acao=insert'', false, '''', '''', '''', ''BRO''); if(respostaAjax == ''OK''){ reload(); alerta(''msg'', TR_AD); carregaPainel(''browser'', '''||PRM_DEFAULT||'''); ajax(''list'', ''browserConfig'', ''prm_microdata='||WS_CODIGO||''', false, ''content'', '''', '''', ''BRO''); } else { alerta(''msg'', TR_ER); } }">'||FUN.LANG('ADICIONAR COLUNA')||'</a>');

	WHEN 'list_call' THEN
        
		IF WS_ADMIN = 'A' THEN

		    HTP.P('<h4>'||FUN.LANG('ADICIONAR OBJETO')||'</h4>');

			FCL.FAKEOPTION('micro-visao', FUN.LANG('Escolha uma view'), '', 'lista-views', 'N', 'N', '');
			
			FCL.FAKEOPTION('objeto-drill', FUN.LANG('Escolha os objetos'), '', 'lista-objetos-call', 'N', 'S', 'micro-visao', '', PRM_DEFAULT);

			HTP.P('<a class="addpurple" onclick="var objeto = document.getElementById(''objeto-drill'').title; if(objeto.trim().length > 0){ call(''savecall'', ''prm_objeto='||PRM_DEFAULT||'&prm_objeto_go=''+objeto+''&prm_screen=''+tela).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AD); ajax(''list'', ''list_call'', ''prm_objeto='||PRM_DEFAULT||'&prm_screen=''+tela, true, ''content''); carregaPainel(''list_call'', '''||PRM_DEFAULT||'''); } else { alerta(''feed-fixo'', TR_ER); } }); } else { alerta(''feed-fixo'', TR_TC) }">ADICIONAR OBJETO</a>');
          
           
            HTP.P('<h4>'||FUN.LANG('ADICIONAR ARQUIVO')||'</h4>');
			
			HTP.P('<input type="text" value="" placeholder="'||FUN.LANG('NOME')||'" id="nome_call" />');

			FCL.FAKEOPTION('call-arquivo', '', '', 'lista-arquivo-user', 'N', 'N');
			
			HTP.P('<a class="addpurple" onclick="var nome = document.getElementById(''nome_call'').value; if(nome.length < 3){ alerta(''msg'', '''||FUN.LANG('Nome precisa ter mais de 2 caracteres')||'!''); } else { call(''save_obj'', ''prm_nome=''+encodeURIComponent(nome)+''&prm_atributo=''+encodeURIComponent(document.getElementById(''call-arquivo'').title)+''&prm_grupo=GERAL&prm_tipo=FILE&prm_visao='||PRM_DEFAULT||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') != -1){ alerta(''feed-fixo'', TR_ER); } else { if(resposta.indexOf(''ERROCOLUNA'') != -1){ alerta(''feed-fixo'', '''||FUN.LANG('Erro nas colunas autom&aacute;ticas')||'!''); } else { alerta(''feed-fixo'', TR_AL); ajax(''list'', ''list_call'', ''prm_objeto='||PRM_DEFAULT||'&prm_screen=''+tela, true, ''content''); carregaPainel(''list_call'', '''||PRM_DEFAULT||'''); } } }); }" title="'||FUN.LANG('Criar novo arquivo')||'" class="add">ADICIONAR OBJETO</a>');

		ELSE

            HTP.P('<h4>'||FUN.LANG('ADICIONAR ARQUIVO')||'</h4>');

            HTP.P('<input type="text" value="" placeholder="'||FUN.LANG('NOME')||'" id="nome_call" />');
			
			FCL.FAKEOPTION('call-arquivo', '', '', 'lista-arquivo-user', 'N', 'N');

			HTP.P('<a class="addpurple" onclick="var nome = document.getElementById(''nome_call'').value; if(nome.length < 3){ alerta(''msg'', '''||FUN.LANG('Nome precisa ter mais de 2 caracteres')||'!''); } else { call(''save_obj'', ''prm_nome=''+encodeURIComponent(nome)+''&prm_atributo=''+encodeURIComponent(document.getElementById(''call-arquivo'').title)+''&prm_grupo=GERAL&prm_tipo=FILE&prm_visao='||PRM_DEFAULT||''').then(function(resposta){ if(resposta.indexOf(''FAIL'') != -1){ alerta(''feed-fixo'', TR_ER); } else { if(resposta.indexOf(''ERROCOLUNA'') != -1){ alerta(''feed-fixo'', '''||FUN.LANG('Erro nas colunas autom&aacute;ticas')||'!''); } else { alerta(''feed-fixo'', TR_AL); carrega(''list_call_end?prm_objeto='||PRM_DEFAULT||'&prm_screen=''+tela); } } }); }" title="'||FUN.LANG('Criar novo arquivo')||'" class="add">ADICIONAR OBJETO</a>');
		    
		END IF;
	
	WHEN 'list_go' THEN

	    HTP.P('<h4>'||FUN.LANG('ADICIONAR DRILL')||'</h4>');

         IF FUN.CHECK_ADMIN('DRILLS_ADD') THEN
			
			FCL.FAKEOPTION('micro-visao', FUN.LANG('Escolha uma view'), '', 'lista-views', 'N', 'N', '');
		    HTP.P('<input type="hidden" value="'||PRM_DEFAULT||'" style="display: none;" id="prm_objeto">');
			FCL.FAKEOPTION('prm_go', FUN.LANG('Escolha os objetos'), '', 'lista-objetos', 'N', 'S', 'micro-visao', '', PRM_DEFAULT);
			HTP.P('<input type="text" palceholder="ORDEM" value="" id="prm_ordem">');

			HTP.P('<a class="addpurple" title="'||FUN.LANG('Adicionar')||'" data-req="savego" data-par="prm_objeto|prm_go|prm_ordem" data-res="list_go" data-res-par="prm_objeto" data-sup="list_go&prm_default='||PRM_DEFAULT||'" data-reload="'||PRM_DEFAULT||'">'||FUN.LANG('ADICIONAR DRILL')||'</a>');
	    END IF;
	











	WHEN 'upload' THEN

	    HTP.P('<h4>'||FUN.LANG('UPLOAD DE ARQUIVOS')||'</h4>');

	    HTP.P('<a class="addpurple" onclick="getFileName(this);" data-default="ESCOLHER ARQUIVO...">ESCOLHER ARQUIVO...</a>');

		HTP.P('<a class="addpurple" onclick="document.getElementById(''painel'').querySelector(''iframe'').contentWindow.document.body.children[0].submit(); this.previousElementSibling.innerHTML = this.previousElementSibling.getAttribute(''data-default'');">ENVIAR</a>');
        
		FCL.UPLOAD(PRM_DEFAULT);

	WHEN 'usuarios' THEN
		
		HTP.P('<h4>'||FUN.LANG('USU&Aacute;RIOS')||'</h4>');
		
		HTP.P('<input type="text" maxlength="40" value="" placeholder="login" id="login" onkeypress="return input(event, ''login'');" class="up"/>');
		
		HTP.P('<input type="text" maxlength="60" value="" placeholder="'||FUN.LANG('NOME')||'" id="nome" />');
		
		HTP.P('<input type="email" maxlength="60" value="" placeholder="E-MAIL" id="email_usuario" onkeypress="return input(event, ''email'');" />');

		FCL.FAKEOPTION('usuario-grupo', FUN.LANG('Escolha o grupo'), '', 'lista-gusers', 'N', 'S', '');
		
		HTP.P('<input type="password" value="" placeholder="PASSWORD" id="senha" />');
		 
		FCL.FAKEOPTION('fake-permissao', FUN.LANG('Copiar a permiss&atilde;o'), '', 'lista-usuarios', 'N', 'N');
		
		WS_COUNT := 0;

        BEGIN
			SELECT COUNT(*) INTO WS_COUNT
				FROM USER_SYS_PRIVS
				WHERE USERNAME = 'DWU' AND PRIVILEGE = 'CREATE USER';
		END;

        IF WS_COUNT = 0 THEN
		    HTP.P('<a title="'||FUN.LANG('Sem grant de CREATE USER')||'" class="addpurple readonly">'||FUN.LANG('ADICIONAR USU&Aacute;RIO')||'</a>');
		ELSE
		    HTP.P('<a title="'||FUN.LANG('Novo usu&aacute;rio')||'" onclick="createUser();" class="addpurple">'||FUN.LANG('ADICIONAR USU&Aacute;RIO')||'</a>');
	    END IF;
	WHEN 'sqlparse' THEN
	   
	   HTP.P('<h4>SQL</h4>');
	   
            HTP.P('<select onchange="ace_editor.setValue(''select * from ''+this.value); /*document.getElementById(''sqlquery'').value = ''select * from ''+this.value;*/" style="width: calc(17% - 16px);">');
			    HTP.P('<option selected hidden disabled>select * from</option>');
				FOR I IN (SELECT TABLE_NAME AS TABELA FROM ALL_TABLES WHERE OWNER = UPPER(WS_USUARIO) ORDER BY TABLE_NAME) LOOP
				    HTP.P('<option value="'||I.TABELA||'">'||I.TABELA||'</option>');
				END LOOP;
			HTP.P('</select>');

		    HTP.P('<a class="addpurple" onclick="execute_sql(''N'', ''11'');" title="10 primeiras linhas">EXECUTAR</a>');
            HTP.P('<a class="addpurple" onclick="execute_sql(''N'', ''999999999'');" title="tudo">'||FUN.LANG('EXECUTAR COMPLETO')||'</a>');
			HTP.P('<input type="text" style="display: none;" id="selecionado" value="">');
	WHEN 'objetos' THEN

	    HTP.P('<h4>'||FUN.LANG('OBJETOS')||'</h4>');

			HTP.P('<input type="text" value="" maxlength="80" placeholder="'||FUN.LANG('NOME DO OBJETO')||'" id="nome" />');
            HTP.P('<span style="background: url('||FUN.R_GIF('seta', 'PNG')||') no-repeat scroll 98% 6px #FFF;" data-hint="'||FUN.LANG('TABELA')||'" onclick="fakeOption(''visao_tabela'', '''||FUN.LANG('TABELA')||''', ''tabelas'', '''');" id="visao_tabela" title="" class="fakeoption invisible">'||FUN.LANG('Escolha um valor')||'</span>');
			
			HTP.P('<a class="script" onclick="if(this.nextElementSibling.title == ''CALL_LIST'' || this.nextElementSibling.title == ''SCRIPT'' || this.nextElementSibling.title == ''TEXTO'' || this.nextElementSibling.title == ''BROWSER'' || this.nextElementSibling.title == ''RELATORIO''){ document.getElementById(''fake_img'').parentNode.classList.add(''invisible'');  } else { document.getElementById(''fake_img'').parentNode.classList.remove(''invisible''); } if(this.nextElementSibling.title == ''BROWSER'' || this.nextElementSibling.title == ''CONSULTA''){ document.getElementById(''lista-tabelas'').parentNode.classList.remove(''invisible''); } else { document.getElementById(''lista-tabelas'').parentNode.classList.add(''invisible''); }"></a>');
			FCL.FAKEOPTION('tipo', FUN.LANG('Escolha o tipo'), '', 'lista-tipos-obj', 'N', 'N', '', PRM_CHILDREN => 'fake_img');
			
			HTP.P('<span class="invisible propagate">');
			    FCL.FAKEOPTION('lista-tabelas', FUN.LANG('Escolha a tabela'), '', 'lista-tabelas', 'S', 'N', '');
			HTP.P('</span>');
			
			
			HTP.P('<span class="invisible propagate">');
			    FCL.FAKEOPTION('fake_img', FUN.LANG('Imagem ou arquivo'), '', 'lista-arquivo', 'S', 'N');
			HTP.P('</span>');
			
			FCL.FAKEOPTION('fake_grupo', FUN.LANG('Escolha o grupo'), '', 'lista-grupos', 'N', 'N');
			HTP.P('<a onclick="addObjeto()" title="'||FUN.LANG('Adicionar')||'" class="addpurple">'||FUN.LANG('ADICIONAR OBJETO')||'</a>');

	WHEN 'lov' THEN

	    HTP.P('<h4>'||FUN.LANG('LISTA DE VALORES')||'</h4>');
		
		HTP.P('<input type="text" maxlength="40" class="up" value="" placeholder="'||FUN.LANG('nome')||'" id="nome_lov" />');
		
		FCL.FAKEOPTION('lista-tabelas', FUN.LANG('Escolha a tabela'), '', 'lista-tabelas', 'S', 'N', PRM_CHILDREN => 'lista-codigo|lista-descricao');
	    
	    
	    


        
        FCL.FAKEOPTION('lista-codigo', FUN.LANG('Escolha o c&oacute;digo'), '', 'lista-codigo-custom', 'S', 'N', 'lista-tabelas');
        FCL.FAKEOPTION('lista-descricao', FUN.LANG('Escolha a descri&ccedil;&atilde;o'), '', 'lista-codigo-custom', 'S', 'N', 'lista-tabelas');
        
        



		
		HTP.P('<a onclick="addLov()" title="'||FUN.LANG('Adicionar')||'" class="addpurple">'||FUN.LANG('ADICIONAR LOV')||'</a>');
	
	WHEN 'sinal' THEN

	    HTP.P('<h4>'||FUN.LANG('SINALIZADORES')||'</h4>');

		HTP.P('<input type="text" maxlength="40" id="par_name" data-min="2" placeholder="'||FUN.LANG('Nome do sinal')||'" class="up" />');

		HTP.P('<input type="text" maxlength="40" id="par_nameds" data-min="2" placeholder="'||FUN.LANG('DESCRI&Ccedil;&Atilde;O DO SINAL')||'">');

		

		FCL.FAKEOPTION('par_sinais', FUN.LANG('Escolha os icones'), '', 'lista-sinais-opcoes', 'N', 'N', PRM_MIN => 1);

		HTP.P('<a title="Adicionar" data-par="par_name|par_nameds|par_sinais" data-req="save_sinal" data-res="list_sinal" data-sup="sinal" class="addpurple followed">'||FUN.LANG('CRIAR SINALIZADOR')||'</a>');
        
  
		FCL.FAKEOPTION('i_usuario', FUN.LANG('Lista de usuarios'), '', 'lista-usuarios-grupos', 'N', 'N', '', '', PRM_MIN => 1);
				
		FCL.FAKEOPTION('micro-visao', FUN.LANG('Escolha uma view'), '', 'lista-views', 'N', 'N', PRM_CHILDREN => 'i_pa|i_coluna', PRM_MIN => 1);
		    
		FCL.FAKEOPTION('i_pa', FUN.LANG('Escolha os objetos'), '', 'lista-objetos', 'N', 'N', 'micro-visao', PRM_CHILDREN => 'i_coluna', PRM_MIN => 1);

		FCL.FAKEOPTION('i_coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'micro-visao', PRM_MIN => 1);
		
		FCL.FAKEOPTION('i_sinal', FUN.LANG('Escolha um sinal'), '', 'lista-sinais', 'N', 'N', PRM_MIN => 1);
				
		

		








		
		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" data-par="i_usuario|i_pa|i_coluna|i_sinal" data-req="insert_csinal" data-res="list_sinal" data-sup="sinal" class="addpurple">'||FUN.LANG('APLICAR SINALIZADOR')||'</a>');

		
	
	WHEN 'param' THEN

	    HTP.P('<h4>'||FUN.LANG('PADR&Otilde;ES')||'</h4>');

		HTP.P('<input type="text" maxlength="40" value="" class="up" id="prm_padrao" data-encode="S" data-min="2" placeholder="'||FUN.LANG('c&oacute;digo')||'" onkeydown="var regex = new RegExp(''^[a-zA-Z0-9_]+$''); if(!regex.test(event.key)){ return false; }" title="Somente letras n&uacute;meros e _">');

		HTP.P('<input type="text" maxlength="40" value="" id="prm_nome" data-encode="S" data-min="2" placeholder="'||FUN.LANG('NOME')||'">');

		
		FCL.FAKEOPTION('prm_tipo', FUN.LANG('Escolha o tipo'), '', 'lista-tipos', 'N', 'N', '');
		FCL.FAKEOPTION('prm_ligacao', FUN.LANG('Escolha o lov'), '', 'lista-lovs', 'N', 'N', '');

        HTP.P('<input type="hidden" value="A" id="prm_status" />');

		HTP.P('<select id="prm_float">');
		    HTP.P('<option selected="" disabled="" hidden="">'||FUN.LANG('GERAR FLOAT')||'</option>');
			HTP.P('<option value="FLOAT_FILTER">FILTER</option>');
			HTP.P('<option value="FLOAT_PAR">PAR</option>');
		HTP.P('</select>');

		


		


 

		HTP.P('<a data-req="add_padrao" data-par="prm_padrao|prm_nome|prm_tipo|prm_ligacao|prm_status|prm_float" data-res="list_vpadrao" data-sup="param" title="'||FUN.LANG('Adicionar')||'" class="addpurple">'||FUN.LANG('ADICIONAR PADR&Atilde;O')||'</a>');
		
		

	WHEN 'blink' THEN

	    HTP.P('<h4>'||FUN.LANG('DESTAQUES')||'</h4>');

        IF WS_ADMIN = 'A' THEN
			FCL.FAKEOPTION('prm_usuario', FUN.LANG('Lista de usu&aacute;rios'), '', 'lista-usuarios-grupos', 'N', 'N', PRM_MIN => '1');
        ELSE
            HTP.P('<input id="prm_usuario" title="'||WS_USUARIO||'" style="display: none;" value="'||WS_USUARIO||'">');
        END IF;

        SELECT CD_COLUNA, CD_CONTEUDO INTO WS_CODIGO, WS_VISAO FROM TABLE(FUN.VPIPE_PAR(PRM_DEFAULT));

		SELECT CS_COLUNA||'|'||CS_AGRUPADOR INTO WS_COLUNAS FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_CODIGO;

        HTP.P('<input id="prm_objeto" style="display: none;" title="'||WS_CODIGO||'" value="'||WS_CODIGO||'">');
        HTP.P('<input id="prm_visao" style="display: none;" title="'||WS_VISAO||'" value="'||WS_VISAO||'">');

        SELECT TP_OBJETO INTO WS_PRIMEIRO FROM OBJETOS WHERE CD_OBJETO = WS_CODIGO;

        IF WS_PRIMEIRO <> 'VALOR' THEN
            FCL.FAKEOPTION('prm_coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', '', WS_COLUNAS, PRM_MIN => '1');
        ELSE
            SELECT PARAMETROS INTO WS_PRIMEIRO FROM PONTO_AVALIACAO WHERE CD_PONTO = WS_CODIGO;
            HTP.P('<input id="prm_coluna" readonly class="readonly" type="text" title="'||REPLACE(WS_PRIMEIRO, '|', '')||'" value="'||REPLACE(WS_PRIMEIRO, '|', '')||'" />');
        END IF;

        FCL.FAKEOPTION('prm_condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', PRM_MIN => '1', PRM_ADICIONAL => 'graph');
        FCL.FAKEOPTION('prm_conteudo', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', PRM_MIN => '1');

        IF WS_PRIMEIRO NOT IN ('BARRAS', 'PIZZA', 'LINHAS', 'COLUNAS') THEN
			HTP.P('<span class="inputcolor">');
				HTP.P('<input autocomplete="on" type="text" data-min="1" placeholder="'||FUN.LANG('COR DA FONTE')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fonte" value="" oninput="this.nextElementSibling.value = this.value;">');
				HTP.P('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
			HTP.P('</span>');
		ELSE
            HTP.P('<input type="hidden" id="prm_fonte" value="">');
		END IF;

		HTP.P('<span class="inputcolor">');
			HTP.P('<input autocomplete="on" type="text" data-min="1" placeholder="'||FUN.LANG('COR DO FUNDO')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fundo" value="" oninput="this.nextElementSibling.value = this.value;">');
			HTP.P('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		HTP.P('</span>');

        IF WS_PRIMEIRO = 'CONSULTA' THEN
            HTP.P('<select id="prm_tipo">');
                HTP.P('<option value="normal" selected disabled hidden>'||FUN.LANG('Tipo')||':</option>');
                HTP.P('<option value="total">'||FUN.LANG('Total')||'</option>');
                HTP.P('<option value="normal">'||FUN.LANG('Normal')||'</option>');
                HTP.P('<option value="linha">'||FUN.LANG('Linha')||'</option>');
            HTP.P('</select>');
        ELSE
            HTP.P('<input type="hidden" id="prm_tipo" title="normal" value="normal" />');
        END IF;
        
        HTP.P('<input type="number" id="destaque-prioridade" value="0" style="display: none;"/>');

        

		HTP.P('<a title="Adicionar" data-req="setdestaque" data-par="prm_usuario|prm_coluna|prm_objeto|prm_condicao|prm_conteudo|prm_fundo|prm_fonte|prm_tipo" data-res="blink" data-res-par="prm_objeto|prm_visao" data-sup="blink&prm_default='||PRM_DEFAULT||'" class="addpurple">'||FUN.LANG('ADICIONAR DESTAQUE')||'</a>');

    WHEN 'efeito' THEN 

	    HTP.P('<h4>'||FUN.LANG('DESTAQUES')||'</h4>');
  
		FCL.FAKEOPTION('prm_usuario', FUN.LANG('Lista de usu&aacute;rios'), '', 'lista-usuarios-grupos', 'N', 'N', PRM_CHILDREN =>  'prm_visao|prm_coluna|prm_objeto|prm_condicao|prm_conteudo', PRM_MIN => 1);
		FCL.FAKEOPTION('prm_visao',   FUN.LANG('Lista de views'), '', 'lista-views', 'N', 'N', '', '', PRM_CHILDREN => 'prm_coluna|prm_objeto|prm_condicao|prm_conteudo', PRM_MIN => 1);
		FCL.FAKEOPTION('prm_coluna',  FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', PRM_CHILDREN => 'prm_objeto|prm_condicao|prm_conteudo', PRM_MIN => 1);
		FCL.FAKEOPTION('prm_objeto', FUN.LANG('Lista de objetos'), '', 'lista-objetos-fixo', 'N', 'N', 'prm_visao', PRM_CHILDREN => 'prm_condicao|prm_conteudo', PRM_MIN => 1);
		FCL.FAKEOPTION('prm_condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', PRM_MIN => 1);
        FCL.FAKEOPTION('prm_conteudo', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', PRM_ENCODE => 'S', PRM_MIN => 1);

		HTP.P('<span class="inputcolor">');
		    HTP.P('<input autocomplete="on" type="text" data-min="1" placeholder="'||FUN.LANG('COR DA FONTE')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fonte" value="" oninput="this.nextElementSibling.value = this.value;">');
		    HTP.P('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		HTP.P('</span>');

		HTP.P('<span class="inputcolor">');
			HTP.P('<input autocomplete="on" type="text" data-min="1" placeholder="'||FUN.LANG('COR DO FUNDO')||'" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fundo" value="" oninput="this.nextElementSibling.value = this.value;">');
			HTP.P('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		HTP.P('</span>');

		HTP.P('<select id="destaque-tipo" style="display: none;">');
			HTP.P('<option value="linha" selected disabled hidden>'||FUN.LANG('Tipo')||':</option>');
			HTP.P('<option value="total">'||FUN.LANG('Total')||'</option>');
			HTP.P('<option value="normal">'||FUN.LANG('Normal')||'</option>');
			HTP.P('<option value="linha">'||FUN.LANG('Linha')||'</option>');
		HTP.P('</select>');
		
		HTP.P('<input type="number" value="0" id="destaque-prioridade" style="display: none;" />');

		

		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" data-req="setdestaque" data-par="prm_usuario|prm_coluna|prm_objeto|prm_condicao|prm_conteudo|prm_fundo|prm_fonte" data-res="list_mblink" data-sup="efeito" data-res-par="prm_usuario" data-res-tar="ajax" class="addpurple">'||FUN.LANG('ADICIONAR DESTAQUE')||'</a>');
	WHEN 'blinkbrowser' THEN

	    HTP.P('<h4>'||FUN.LANG('ADICIONAR DESTAQUE')||'</h4>');

        IF WS_ADMIN = 'A' THEN
			FCL.FAKEOPTION('destaque-usuario', 'Usu&aacute;rio', '', 'lista-usuarios', 'N', 'N');
        ELSE
            HTP.P('<input id="destaque-usuario" style="display: none;" value="'||WS_USUARIO||'" title="'||WS_USUARIO||'">');
        END IF;

        HTP.P('<input id="i_pa" style="display: none;" value="'||PRM_DEFAULT||'">');

        




		
		FCL.FAKEOPTION('destaque-coluna', '', 'COLUNA', 'lista-coluna', 'N', 'N', 'destaque-visao', '');
       

        


		
		FCL.FAKEOPTION('destaque-condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', '', '');


        

        FCL.FAKEOPTION('destaque-conteudo', 'VALOR', '', 'lista-valores-browser', 'S', 'N', 'destaque-visao', '', 'destaque-coluna');
		
		HTP.P('<span class="inputcolor">');
		    HTP.P('<input autocomplete="on" type="text" data-min="1" placeholder="COR DA FONTE" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fonte" value="" oninput="this.nextElementSibling.value = this.value;">');
		    HTP.P('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		HTP.P('</span>');

		HTP.P('<span class="inputcolor">');
			HTP.P('<input autocomplete="on" type="text" data-min="1" placeholder="COR DO FUNDO" title="ex: transparent, rgb(0, 0, 0), #FFFFFF" id="prm_fundo" value="" oninput="this.nextElementSibling.value = this.value;">');
			HTP.P('<input type="color" value="#111111" oninput="this.previousElementSibling.value = this.value; ">');
		HTP.P('</span>');

        HTP.P('<select id="tipo">');
            HTP.P('<option value="estrela" selected disabled hidden>'||FUN.LANG('Tipo')||':</option>');
            HTP.P('<option value="estrela">'||FUN.LANG('Estrela')||'</option>');
            HTP.P('<option value="linha">'||FUN.LANG('Linha')||'</option>');
        HTP.P('</select>');
            
        HTP.P('<input id="prioridade" value="0" type="number" />');
       
        HTP.P('<a title="'||FUN.LANG('Adicionar')||'" onclick="var visao = document.getElementById(''destaque-visao'').title; var usuario = document.getElementById(''destaque-usuario'').title; var objeto = document.getElementById(''i_pa'').value; if(document.getElementById(''destaque-coluna'')){ var coluna = document.getElementById(''destaque-coluna'').title; var condicao = document.getElementById(''destaque-condicao'').title; var conteudo = document.getElementById(''destaque-conteudo'').title; conteudo = encodeURIComponent(conteudo); var fundo = document.getElementById(''prm_fundo'').value; var fonte = document.getElementById(''prm_fonte'').value; var tipo = document.getElementById(''tipo'').value; var prioridade = document.getElementById(''prioridade'').value; if(usuario != '''' && conteudo != '''' && fundo != '''' && fonte != '''' && prioridade != ''''){  call(''setdestaque'', ''prm_usuario=''+usuario+''&prm_objeto=''+objeto+''&prm_coluna=''+coluna+''&prm_condicao=''+condicao+''&prm_conteudo=''+conteudo+''&prm_fundo=''+fundo+''&prm_fonte=''+fonte+''&prm_tipo=''+tipo+''&prm_prioridade=''+prioridade).then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', TR_AD); call(''blink'', ''prm_objeto=''+objeto+''&prm_visao=''+visao).then(function(resposta){ document.getElementById(''content'').innerHTML = resposta; }); } else { alerta(''feed-fixo'', TR_ER); }  }); } else { alerta(''feed-fixo'','''||FUN.LANG('preencha todos os campos')||'!''); }} " class="addpurple">'||FUN.LANG('ADICIONAR EFEITO')||'</a>');

    WHEN 'filtro' THEN

	    HTP.P('<h4>'||FUN.LANG('FILTROS')||'</h4>');
		
		HTP.P('<a class="script" onclick="var clear = document.getElementById(''filtrou-coluna''); clear.title=''''; clear.setAttribute(''data-default'', ''''); clear.children[0].innerHTML = ''Lista de colunas''; clear = document.getElementById(''filtrou-condicao''); clear.title=''IGUAL''; clear.setAttribute(''data-default'', ''IGUAL''); clear.children[0].innerHTML = ''IGUAL''; clear = document.getElementById(''filtrou-valores''); clear.title=''''; clear.setAttribute(''data-default'', ''''); clear.children[0].innerHTML = ''Lista de valores'';"></a>');
		FCL.FAKEOPTION('filtrou-visao', FUN.LANG('Lista de views'), '', 'lista-views', 'N', 'N', '', '');
		
		FCL.FAKEOPTION('filtrou-coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'filtrou-visao', '');
		
		FCL.FAKEOPTION('filtrou-condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', '', '');
		
		FCL.FAKEOPTION('filtrou-valores', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'filtrou-visao', '', 'filtrou-coluna');
		
		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="addpurple" onclick=" if(document.getElementById(''filtrou-coluna'').title.length > 0){ var coluna = document.getElementById(''filtrou-coluna'').title; var visao = document.getElementById(''filtrou-visao'').title; var condicao = document.getElementById(''filtrou-condicao'').title; var valor = document.getElementById(''filtrou-valores'').title; valor = encodeURIComponent(valor); call(''edit_sfiltro'', ''new_cd_objeto=''+tela+''&new_micro_visao=''+visao+''&new_cd_coluna=''+coluna+''&new_condicao=''+condicao+''&new_conteudo=''+valor+''&new_ligacao=and'').then(function(resposta){ if(resposta.indexOf(''FAIL'') == -1){ alerta(''feed-fixo'', '''||FUN.LANG('Filtro de tela adicionado com sucesso')||'!''); reload(); ajax(''list'', ''list_sfiltro'', ''ws_par_sumary=''+tela, true, ''content''); } }); } else { alerta(''msg'', '''||FUN.LANG('Favor escolher uma op&ccedil;&atilde;o de view')||'!''); }">'||FUN.LANG('ADICIONAR FILTRO')||'</a>');

	WHEN 'filtrou' THEN

	    HTP.P('<h4>'||FUN.LANG('FILTROS')||'</h4>');
		  
		
		
		FCL.FAKEOPTION('prm_usuario', FUN.LANG('Lista de usu&aacute;rios'), '', 'lista-usuarios-grupos', 'N', 'S', PRM_CHILDREN => 'prm_visao|prm_coluna|prm_condicao|prm_conteudo', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_visao', FUN.LANG('Lista de views'), '', 'lista-views', 'N', 'N', PRM_CHILDREN => 'prm_coluna|prm_condicao|prm_conteudo', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', PRM_CHILDREN => 'prm_condicao|prm_conteudo', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_conteudo', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', PRM_MIN => 1, PRM_ENCODE => 'S');

		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="addpurple" data-req="setfiltro" data-par="prm_usuario|prm_visao|prm_coluna|prm_condicao|prm_conteudo" data-res="getfiltro" data-res-par="prm_usuario" data-sup="filtrou">'||FUN.LANG('ADICIONAR FILTRO')||'</a></td>');

    WHEN 'filtror' THEN

	    HTP.P('<h4>'||FUN.LANG('FILTROS')||'</h4>');
		  
		
		
		SELECT CD_COLUNA, CD_CONTEUDO INTO WS_CODIGO, WS_VISAO FROM TABLE(FUN.VPIPE_PAR(PRM_DEFAULT));
		
		HTP.P('<input type="hidden" id="prm_id" value="'||WS_CODIGO||'">');

		HTP.P('<input type="hidden" id="prm_usuario" value="'||WS_VISAO||'">');
		
		
		
		FCL.FAKEOPTION('prm_visao', FUN.LANG('Lista de views'), '', 'lista-views', 'N', 'N', PRM_CHILDREN => 'prm_coluna|prm_condicao|prm_conteudo', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', PRM_CHILDREN => 'prm_condicao|prm_conteudo', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_condicao', FUN.LANG('Lista de condi&ccedil;&otilde;es'), '', 'lista-condicoes', 'N', 'N', PRM_MIN => 1);
		
		FCL.FAKEOPTION('prm_conteudo', FUN.LANG('Lista de valores'), '', 'lista-valores', 'S', 'N', 'prm_visao', '', 'prm_coluna', PRM_MIN => 1, PRM_ENCODE => 'S');

		HTP.P('<a title="'||FUN.LANG('Adicionar')||'" class="addpurple" data-req="addReportFilter" data-par="prm_id|prm_usuario|prm_visao|prm_coluna|prm_condicao|prm_conteudo" data-res="reportFilter" data-sup="filtror" data-pkg="COM">'||FUN.LANG('ADICIONAR FILTRO')||'</a></td>');

	WHEN 'mask' THEN

	    HTP.P('<h4>'||FUN.LANG('M&Aacute;SCARAS')||'</h4>');
	    
		HTP.P('<input id="prm_mask" maxlength="80" class="up" type="text" placeholder="'||FUN.LANG('NOME DA M&Aacute;SCARA')||'" data-min="1" data-encode="S" />');
		
		HTP.P('<input id="prm_desc" maxlength="300" class="up" type="text" placeholder="'||FUN.LANG('VALOR DA M&Aacute;SCARA')||'" data-min="1" data-encode="S" />');
			
		HTP.P('<a title="'||FUN.LANG('ADICIONAR M&Aacute;SCARA')||'" class="addpurple" data-req="load_mask" data-par="prm_mask|prm_desc" data-res="mask" data-sup="mask">'||FUN.LANG('ADICIONAR M&Aacute;SCARA')||'</a></td>');

	WHEN 'consulta' THEN

		HTP.P('<input type="text" id="consulta_nome" value="" onkeypress="return input(event, ''ID'');" onkeyup="ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=objetos'', true, ''consulta_nome'');" class="up" placeholder="ID"/>');
		HTP.P('<input type="text" id="consulta_desc" value="" placeholder="'||FUN.LANG('Descri&ccedil;&atilde;o')||'"/>');

		FCL.FAKEOPTION('consulta_grupo', 'Lista de grupos', '', 'lista-grupos', 'N', 'N', '');

		
        HTP.P('<select id="consulta_prm">');
            HTP.P('<option value="ROLL">ROLL</option>');
            HTP.P('<option value="GROUP">GROUP</option>');
            HTP.P('<option value="CUBE">CUBE</option>');
        HTP.P('</select>');

		



        FCL.FAKEOPTION('consulta_visao', FUN.LANG('Lista de views'), '', 'lista-views', 'N', 'N', '', '');

		HTP.P('<a class="add" title="'||FUN.LANG('alterar a tabela de consulta')||'" onclick="getlist(); ">+</a>');

	WHEN 'visoes' THEN
	    HTP.P('<h4>VIEW</h4>');
		
		HTP.P('<input type="text" maxlength="80" placeholder="'||FUN.LANG('nome')||'" value="" id="visao_nome" class="up" onkeyup="ajax(''input'', ''check_data'', ''prm_valor=''+this.value+''&prm_tabela=visao'', true, ''visao_nome'');">');
	    
	    FCL.FAKEOPTION('visao_tabela', FUN.LANG('Escolha uma tabela'), '', 'lista-tabelas', 'S', 'N');
	    
	    HTP.P('<input type="text" maxlength="60" placeholder="'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'" value="" id="visao_desc">');
	    
	    FCL.FAKEOPTION('fake_grupo', FUN.LANG('Escolha o grupo'), '', 'lista-grupos', 'N', 'N');
	    
	    
	    HTP.P('<a title="'||FUN.LANG('Adicionar view')||'" class="addpurple" onclick="createView();">'||FUN.LANG('ADICIONAR VIEW')||'</a>');

	



	WHEN 'grupos' THEN

	    HTP.P('<h4>'||FUN.LANG('CATEGORIAS')||'</h4>');
		
		HTP.P('<input type="text" maxlength="40" value="" placeholder="'||FUN.LANG('CATEGORIA')||'" id="prm_grupo" class="up" data-encode="S" data-min="2" />');
	    
		HTP.P('<input type="text" maxlength="100" value="" placeholder="'||FUN.LANG('NOME')||'" id="prm_nome" data-encode="S" data-min="2" />');
		
		
	
		HTP.P('<a title="'||FUN.LANG('ADICIONAR CATEGORIA')||'" data-req="create_grupo" data-par="prm_grupo|prm_nome" data-res="grupos" data-sup="grupos" class="addpurple">'||FUN.LANG('ADICIONAR CATEGORIA')||'</a>');


	WHEN 'gusuarios' THEN

	    HTP.P('<h4>'||FUN.LANG('GRUPOS')||'</h4>');
	    
		HTP.P('<input type="text" maxlength="40" value="" placeholder="ID" id="prm_grupo" class="up" data-encode="S" data-min="2" />');
	    
		HTP.P('<input type="text" maxlength="40" value="" placeholder="'||FUN.LANG('NOME')||'" id="prm_nome" data-encode="S" data-min="2" />');
		
		
	
		HTP.P('<a title="'||FUN.LANG('ADICIONAR GRUPO')||'" data-req="create_gusuarios" data-par="prm_grupo|prm_nome" data-res="gusuarios" data-sup="gusuarios" class="addpurple">'||FUN.LANG('ADICIONAR GRUPO')||'</a>');

	WHEN 'notify' THEN

		HTP.P('<input id="valor-coluna" readonly="true" type="text" value="" style="cursor: default; background: #999; padding: 0 2px;" />');
		HTP.FORMSELECTOPEN( CNAME => 'condicao', CATTRIBUTES => 'id="condicao"');
            FCL.CONDICOES('simple');
		HTP.FORMSELECTCLOSE;
		HTP.P('<input type="text" value="" placeholder="'||FUN.LANG('conte&uacute;do')||'" id="conteudo">');

		HTP.P('<a class="add" title="'||FUN.LANG('Adicionar filtro')||'" onclick="ajax(''main'', ''alter_filtro_notify'', ''prm_item=&prm_notify=''+document.getElementById(''cd_notify'').value+''&prm_visao=''+document.getElementById(''micro_visao'').value+''&prm_coluna=''+document.getElementById(''coluna'').value+''&prm_condicao=''+document.getElementById(''condicao'').value+''&prm_conteudo=''+document.getElementById(''conteudo'').value+''&prm_ligacao=AND&prm_action=add'', false, ''ajax''); noerror('''', '''||FUN.LANG('Filtro adicionado com sucesso')||'!'', ''msg'');">+</a>');
	
	WHEN 'log' THEN

	    HTP.P('<h4>LOGS</h4>');

		HTP.P('<select id="log-tipo">');
			HTP.P('<option value="">'||FUN.LANG('TIPO')||'</option>');
			HTP.P('<option value="EVENTO">'||FUN.LANG('EVENTO')||'</option>');
			HTP.P('<option value="ERRO">'||FUN.LANG('ERRO')||'</option>');
			HTP.P('<option value="OUTROS">'||FUN.LANG('OUTROS')||'</option>');
			HTP.P('<option value="SESSAO">'||FUN.LANG('SESS&Atilde;O')||'</option>');
		HTP.P('</select>');

		HTP.P('<select id="log-usuario">');
			HTP.P('<option value="">'||FUN.LANG('USU&Aacute;RIO')||'</option>');
			FOR I IN(SELECT DISTINCT(NM_USUARIO) FROM BI_LOG_SISTEMA ORDER BY NM_USUARIO ASC) LOOP
				HTP.P('<option value="'||I.NM_USUARIO||'">'||I.NM_USUARIO||'</option>');
			END LOOP;
		HTP.P('</select>');

		HTP.P('<input type="number" id="log-linha" style="width: 60px;" placeholder="'||FUN.LANG('LINHAS')||'"/>');

		HTP.P('<a class="addpurple" style="line-height: 32px;" onclick="ajax(''list'', ''logs_lista'', ''prm_tipo=''+document.getElementById(''log-tipo'').value+''&prm_usuario=''+document.getElementById(''log-usuario'').value+''&prm_linha=''+document.getElementById(''log-linha'').value, false, ''ajax'');">'||FUN.LANG('FILTRAR')||'</a>');

	WHEN 'list_crocks' THEN

	    HTP.P('<h4>'||FUN.LANG('MAPEAR COLUNAS')||'</h4>');

		WS_COLUNAS := '';

		IF NVL(PRM_DEFAULT, 'N/A') <> 'N/A' THEN

		    SELECT COUNT(*) INTO WS_COUNT FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_DEFAULT;

			IF WS_COUNT <> 0 THEN
				
				SELECT TP_OBJETO INTO WS_TIPOGRAFICO FROM OBJETOS WHERE CD_OBJETO=PRM_DEFAULT;
				
				IF WS_TIPOGRAFICO <> 'PONTEIRO' THEN

			    	SELECT CD_MICRO_VISAO, CS_COLUNA||'|'||NVL(PARAMETROS,CS_AGRUPADOR)||'|'||CS_COLUP INTO WS_VISAO, WS_COLUNAS FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_DEFAULT;
				ELSE
					SELECT CD_MICRO_VISAO, NVL(PARAMETROS,CS_AGRUPADOR)||'|'||CS_COLUP INTO WS_VISAO, WS_COLUNAS FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_DEFAULT;
				END IF;

			ELSE
                WS_VISAO := PRM_DEFAULT;
			END IF;
		END IF;

		HTP.P('<a class="script" onclick="document.getElementById(''content'').innerHTML = ''''; loader(''painel-colunas''); call(''load_crocks'', ''prm_visao=''+this.nextElementSibling.title).then(function(resposta){ document.getElementById(''painel-colunas'').innerHTML = resposta; }); telaSup(''visao'', this.nextElementSibling.title);"></a>');
		FCL.FAKEOPTION('micro-visao', NVL(WS_VISAO, FUN.LANG('Escolha uma view')), WS_VISAO, 'lista-views', 'N', 'N', '');
		
        HTP.P('<div id="painel-colunas" data-colunas="'||WS_COLUNAS||'">');
		    FCL.LOAD_CROCKS(WS_VISAO, WS_COLUNAS, '', 'S');
		HTP.P('</div>');

		HTP.P('<input id="add_coluna" type="text" class="up" placeholder="'||FUN.LANG('NOVA COLUNA OU TEMPLATE')||'" />');
		HTP.P('<div style="padding: 0 20px; display: flex;">');
		    HTP.P('<a class="addpurple f_addcoluna" data-template="N" style="flex-grow: 1;" title="'||FUN.LANG('Nova coluna')||'">'||FUN.LANG('ADICIONAR COLUNA')||'</a>');
		    HTP.P('<a class="addpurple f_addcoluna" data-template="S" style="flex-grow: 1; margin-left: 15px;" title="'||FUN.LANG('Novo template')||'">'||FUN.LANG('ADICIONAR TEMPLATE')||'</a>');
        HTP.P('</div>');
		

	WHEN 'add_show' THEN

		HTP.P('<select title="'||FUN.LANG('ordem')||'" id="show_only_ordem">');
			HTP.P('<option selected disabled hidden value="1">'||FUN.LANG('ordem')||'</option>');
			FOR I IN 1..20 LOOP
				HTP.P('<option value="'||I||'">'||I||'</option>');
			END LOOP;
		HTP.P('</select>');

		HTP.P('<select title="'||FUN.LANG('tempo')||'" id="show_only_tempo">');

			HTP.P('<option value="10">10s</option>');
			HTP.P('<option value="20">20s</option>');
			HTP.P('<option value="30" selected>30s</option>');
			HTP.P('<option value="45">45s</option>');
			HTP.P('<option value="60">1min</option>');
			HTP.P('<option value="120">2min</option>');
			HTP.P('<option value="300">5min</option>');
			HTP.P('<option value="600">10min</option>');
			HTP.P('<option value="900">15min</option>');
		HTP.P('</select>');
		HTP.P('<select id="show_only_screen">');
			FOR I IN (SELECT SCREEN, DESCRICAO FROM ALL_SCREENS WHERE SCREEN NOT IN (SELECT SCREEN FROM USER_SEQUENCE WHERE USUARIO = PRM_DEFAULT)) LOOP
				HTP.P('<option value="'||I.SCREEN||'">['||I.SCREEN||'] '||I.DESCRICAO||'</option>');
			END LOOP;
		HTP.P('</select>');
		HTP.P('<a class="add" onclick="ajax(''main'', ''show_update'', ''prm_usuario='||PRM_DEFAULT||'&prm_screen=''+document.getElementById(''show_only_screen'').value+''&prm_time=''+document.getElementById(''show_only_tempo'').value+''&prm_ordem=''+document.getElementById(''show_only_ordem'').value+''&prm_tipo='', false, ''ajax'');">+</a>');

	WHEN 'object_padrao' THEN

		HTP.P('<select id="op_obj">');
		    FOR I IN(SELECT DISTINCT(TP_OBJETO) FROM BI_OBJECT_PADRAO ORDER BY TP_OBJETO ASC) LOOP
			    HTP.P('<option value="'||I.TP_OBJETO||'">'||I.TP_OBJETO||'</option>');
			END LOOP;
		HTP.P('</select>');
		HTP.P('<input type="text" id="op_prop" placeholder="'||FUN.LANG('PROPRIEDADE')||'" class="up" />');

		
		HTP.P('<input type="text" id="op_default" placeholder="'||FUN.LANG('DEFAULT')||'"/>');
		



	    HTP.P('<a class="add" onclick="var prop = encodeURIComponent(document.getElementById(''op_prop'').value); var label = ''''; if(prop.length > 0){ call(''add_object_padrao'', ''prm_obj=''+document.getElementById(''op_obj'').value+''&prm_propriedade=''+prop+''&prm_tipo=&prm_label=&prm_default=&prm_sufixo=&prm_script=&prm_validacao=&prm_grupo='').then(function(resposta){ if(resposta == ''OK''){ alerta(''msg'', TR_AD); ajax(''list'', ''object_padrao'', '''', true, ''content''); } else { alerta(''msg'', TR_ER); } }); }">+</a>');
    
	WHEN 'tela_adicional' THEN

        BEGIN
			SELECT CONTEUDO INTO WS_PADRAO
			FROM   PARAMETRO_USUARIO
			WHERE  CD_USUARIO = WS_USUARIO AND
				CD_PADRAO='CD_LINGUAGEM';
		EXCEPTION
			WHEN OTHERS THEN
				WS_PADRAO := 'PORTUGUESE';
		END;

		HTP.P('<select onchange="ajax(''list'', ''list_screen'', ''prm_grupo=''+this.value+''&prm_usuario='', false, ''tela_adicional'');">');
			HTP.P('<option value="all" selected>'||FUN.LANG('TODOS OS GRUPOS')||'</option>');
			FOR I IN (SELECT CD_GRUPO, NM_GRUPO FROM GRUPOS_FUNCAO ORDER BY ORDEM, CD_GRUPO) LOOP
					HTP.P('<option value="'||I.CD_GRUPO||'">'||I.CD_GRUPO||' - '||I.NM_GRUPO||'</option>');
			END LOOP;
		HTP.P('</select>');

		HTP.P('<select id="tela_adicional">');
			FOR A IN (SELECT SCREEN, DESCRICAO FROM ALL_SCREENS WHERE SCREEN NOT IN (SELECT SCREEN FROM USER_SCREENS WHERE TRIM(USUARIO) = TRIM(PRM_DEFAULT)) ORDER BY DESCRICAO) LOOP
				HTP.P('<option id="screens_'||A.SCREEN||'" value="'||A.SCREEN||'">'||FUN.UTRANSLATE('NM_OBJETO', A.SCREEN, A.DESCRICAO, WS_PADRAO)||'</option>');
			END LOOP;
		HTP.P('</select>');

		HTP.P('<a class="add" title="'||FUN.LANG('Adicionar')||'" onclick="var tela_adicional = document.getElementById(''tela_adicional'').value; var sa = document.getElementById(''screen_access_''+tela_adicional); if(tela_adicional.length > 0){ call(''add_screen_access'', ''prm_usuario='||TRIM(PRM_DEFAULT)||'&prm_tela=''+tela_adicional).then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ call(''screen_access'', ''prm_usuario='||TRIM(PRM_DEFAULT)||'&prm_conteudo=LISTA'').then(function(resposta){ document.getElementById(''ajax'').innerHTML = resposta; }); call(''menu_screen_access'', ''prm_usuario='||TRIM(PRM_DEFAULT)||''').then(function(resposta){ document.getElementById(''painel'').innerHTML = resposta; }); } }); } else { alerta(''msg'','''||FUN.LANG('Escolher um valor')||'!''); }">+</a>');
	ELSE
	    HTP.P('');
	END CASE;
EXCEPTION 
	WHEN WS_NOUSER THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(SQLERRM);
END MENU;

PROCEDURE MENU_SCREEN_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_GRUPOS IS
	SELECT CD_GRUPO, NM_GRUPO, ORDEM
	FROM GRUPOS_FUNCAO
	ORDER BY CD_GRUPO;

	WS_GRUPO CRS_GRUPOS%ROWTYPE;

BEGIN

	HTP.P('<h4>'||FUN.LANG('TELAS DISPON&Iacute;VEIS')||'</h4>');

	HTP.P('<input type="hidden" id="prm_usuario" title="'||PRM_USUARIO||'" value="'||PRM_USUARIO||'">');
	HTP.P('<input type="hidden" id="prm_conteudo" title="" value="FULL">');
	
	FCL.FAKEOPTION('prm_tela', FUN.LANG('Escolha uma tela'), '', 'lista-telas', 'N', 'S', '', '', PRM_USUARIO, PRM_MIN => 1);
	
	HTP.P('<select title="'||FUN.LANG('tempo')||'" id="prm_tempo">');
	    HTP.P('<option value="0" selected disabled hidden>'||FUN.LANG('TEMPO DE SLIDE')||'</option>');
	    HTP.P('<option value="0">0</option>');
		HTP.P('<option value="10">10s</option>');
        HTP.P('<option value="20">20s</option>');
		HTP.P('<option value="30">30s</option>');
		HTP.P('<option value="45">45s</option>');
		HTP.P('<option value="60">1min</option>');
		HTP.P('<option value="120">2min</option>');
		HTP.P('<option value="300">5min</option>');
		HTP.P('<option value="600">10min</option>');
		HTP.P('<option value="900">15min</option>');
	HTP.P('</select>');

    HTP.P('<select title="'||FUN.LANG('ordem')||'" id="prm_ordem">');
	    HTP.P('<option selected disabled hidden value="0">'||FUN.LANG('ORDEM DO SLIDE')||'</option>');
		FOR I IN 0..20 LOOP
		    HTP.P('<option value="'||I||'">'||I||'</option>');
		END LOOP;
	HTP.P('</select>');
	
	HTP.P('<a class="addpurple" title="'||FUN.LANG('Adicionar')||'" data-children="prm_tela" data-req="add_screen_access" data-par="prm_usuario|prm_tela|prm_tempo|prm_ordem" data-res="screen_access" data-res-par="prm_usuario|prm_conteudo">'||FUN.LANG('ADICIONAR TELA')||'</a>');

EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END MENU_SCREEN_ACCESS;

PROCEDURE MENU_COLUMN_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

BEGIN

    HTP.P('<h4>'||FUN.LANG('BLOQUEIO DE COLUNA')||'</h4>');

	HTP.P('<input type="hidden" id="prm_usuario" title="'||PRM_USUARIO||'" value="'||PRM_USUARIO||'">');
	HTP.P('<input type="hidden" id="prm_conteudo" title="FULL" value="FULL">');

	FCL.FAKEOPTION('prm_visao', FUN.LANG('Escolha uma view'), '', 'lista-views', 'N', 'N', PRM_CHILDREN => 'prm_coluna', PRM_MIN => 1);
	FCL.FAKEOPTION('prm_coluna', FUN.LANG('Lista de colunas'), '', 'lista-colunas', 'N', 'N', 'prm_visao', PRM_MIN => 1);
    
	HTP.P('<a class="addpurple" title="'||FUN.LANG('Adicionar')||'" data-req="add_column_access" data-par="prm_usuario|prm_coluna|prm_visao" data-res="column_access" data-res-par="prm_usuario|prm_conteudo">'||FUN.LANG('ADICIONAR BLOQUEIO')||'</a>');
            
END MENU_COLUMN_ACCESS;


PROCEDURE MENU_OBJECT_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

BEGIN

	HTP.P('<h4>'||FUN.LANG('BLOQUEIO DE OBJETO')||'</h4>');

	HTP.P('<input type="hidden" id="prm_usuario" title="'||PRM_USUARIO||'" value="'||PRM_USUARIO||'">');
	HTP.P('<input type="hidden" id="prm_conteudo" title="FULL" value="FULL">');

	FCL.FAKEOPTION('prm_visao', FUN.LANG('Escolha uma view'), '', 'lista-views', 'N', 'N', PRM_CHILDREN => 'prm_obj', PRM_MIN => 1);
	FCL.FAKEOPTION('prm_obj', FUN.LANG('Lista de objetos'), '', 'lista-objetos', 'N', 'N', 'prm_visao', PRM_MIN => 1);
    
	HTP.P('<a class="addpurple" title="'||FUN.LANG('Adicionar')||'" data-req="add_object_access" data-par="prm_usuario|prm_obj" data-res="object_access" data-res-par="prm_usuario|prm_conteudo">'||FUN.LANG('ADICIONAR BLOQUEIO')||'</a>');

END MENU_OBJECT_ACCESS;

PROCEDURE MENU_TD_ACCESS ( PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

BEGIN

    HTP.P('<h4>NETWALL</h4>');
    
    HTP.P('<input id="tr_regra" placeholder="'||FUN.LANG('Nome da regra')||'" title="'||FUN.LANG('Nome da regra')||'" class="up" />');
		HTP.P('<select id="tr_tipo" title="Tipo">');
		    HTP.P('<option value="B">'||FUN.LANG('Bloqueado')||'</option>');
			HTP.P('<option value="L">'||FUN.LANG('Liberado')||'</option>');
		HTP.P('</select>');

		HTP.P('<input id="TR_ADdress" placeholder="'||FUN.LANG('endere&ccedil;o')||'" title="'||FUN.LANG('endere&ccedil;o')||'"/>');
		
		HTP.P('<select title="'||FUN.LANG('escolha o hor&aacute;rio de inicio')||'" id="tr_hi" onchange="if(this.value == 99){ document.getElementById(''tr_hf'').selectedIndex = 0; document.getElementById(''tr_hf'').disabled = true; } else { if(document.getElementById(''tr_hf'').value == 99){ document.getElementById(''tr_hf'').disabled = false; document.getElementById(''tr_hf'').selectedIndex = 1; } }">');
		    HTP.P('<option value="99">'||FUN.LANG('SEM HOR&Aacute;RIO')||'</option>');
			HTP.P('<option value="0" selected>00:00h</option>');
			HTP.P('<option value="1">01:00h</option>');
			HTP.P('<option value="2">02:00h</option>');
			HTP.P('<option value="3">03:00h</option>');
			HTP.P('<option value="4">04:00h</option>');
			HTP.P('<option value="5">05:00h</option>');
			HTP.P('<option value="6">06:00h</option>');
			HTP.P('<option value="7">07:00h</option>');
			HTP.P('<option value="8">08:00h</option>');
			HTP.P('<option value="9">09:00h</option>');
			HTP.P('<option value="10">10:00h</option>');
			HTP.P('<option value="11">11:00h</option>');
			HTP.P('<option value="12">12:00h</option>');
			HTP.P('<option value="13">13:00h</option>');
			HTP.P('<option value="14">14:00h</option>');
			HTP.P('<option value="15">15:00h</option>');
			HTP.P('<option value="16">16:00h</option>');
			HTP.P('<option value="17">17:00h</option>');
			HTP.P('<option value="18">18:00h</option>');
			HTP.P('<option value="19">19:00h</option>');
			HTP.P('<option value="20">20:00h</option>');
			HTP.P('<option value="21">21:00h</option>');
			HTP.P('<option value="22">22:00h</option>');
			HTP.P('<option value="23">23:00h</option>');
			HTP.P('<option value="24">24:00h</option>');
		HTP.P('</select>');
		
		HTP.P('<select title="'||FUN.LANG('escolha o hor&aacute;rio de termino')||'" id="tr_hf" onchange="if(this.value == 99){ document.getElementById(''tr_hi'').selectedIndex = 0; document.getElementById(''tr_hi'').disabled = true; } else { if(document.getElementById(''tr_hi'').value == 99){ document.getElementById(''tr_hi'').disabled = false; document.getElementById(''tr_hi'').selectedIndex = 1; } }">');
		    HTP.P('<option value="99">'||FUN.LANG('SEM HOR&Aacute;RIO')||'</option>');
		    HTP.P('<option value="0">00:00h</option>');
			HTP.P('<option value="1">01:00h</option>');
			HTP.P('<option value="2">02:00h</option>');
			HTP.P('<option value="3">03:00h</option>');
			HTP.P('<option value="4">04:00h</option>');
			HTP.P('<option value="5">05:00h</option>');
			HTP.P('<option value="6">06:00h</option>');
			HTP.P('<option value="7">07:00h</option>');
			HTP.P('<option value="8">08:00h</option>');
			HTP.P('<option value="9">09:00h</option>');
			HTP.P('<option value="10">10:00h</option>');
			HTP.P('<option value="11">11:00h</option>');
			HTP.P('<option value="12">12:00h</option>');
			HTP.P('<option value="13">13:00h</option>');
			HTP.P('<option value="14">14:00h</option>');
			HTP.P('<option value="15">15:00h</option>');
			HTP.P('<option value="16">16:00h</option>');
			HTP.P('<option value="17">17:00h</option>');
			HTP.P('<option value="18">18:00h</option>');
			HTP.P('<option value="19">19:00h</option>');
			HTP.P('<option value="20">20:00h</option>');
			HTP.P('<option value="21">21:00h</option>');
			HTP.P('<option value="22">22:00h</option>');
			HTP.P('<option value="23">23:00h</option>');
			HTP.P('<option value="24" selected>24:00h</option>');
		HTP.P('</select>');

		HTP.P('<select title="'||FUN.LANG('dia da semana')||'" id="tr_semana">');
		    HTP.P('<option value="2">'||FUN.LANG('segunda-feira')||'</option>');
            HTP.P('<option value="3">'||FUN.LANG('ter&ccedil;a-feira')||'</option>');
            HTP.P('<option value="4">'||FUN.LANG('quarta-feira')||'</option>');
            HTP.P('<option value="5">'||FUN.LANG('quinta-feira')||'</option>');
            HTP.P('<option value="6">'||FUN.LANG('sexta-feira')||'</option>');
            HTP.P('<option value="7">'||FUN.LANG('sabado')||'</option>');
            HTP.P('<option value="1">'||FUN.LANG('domingo')||'</option>');
            HTP.P('<option value="8">'||FUN.LANG('dia &ugrave;til')||'</option>');
            HTP.P('<option value="9">'||FUN.LANG('fim de semana')||'</option>');
			HTP.P('<option value="0">'||FUN.LANG('todos os dias')||'</option>');
		HTP.P('</select>');

		HTP.P('<a class="addpurple" title="'||FUN.LANG('adicionar nova regra')||'" onclick="var regra = document.getElementById(''tr_regra'').value; var tipo = document.getElementById(''tr_tipo'').value; var address = document.getElementById(''TR_ADdress'').value;  if(regra == '''' || tipo == '''' ){ alerta(''msg'','''||FUN.LANG('Favor preencher todos os campos')||'!''); } else { if(document.getElementById(regra+''tr'')){ alerta(''msg'', '''||FUN.LANG('regra j&aacute; existe')||'!''); } else { var hi = document.getElementById(''tr_hi'').value; var hf = document.getElementById(''tr_hf'').value; var semana = document.getElementById(''tr_semana'').value; call(''add_td_access'', ''prm_usuario='||PRM_USUARIO||'&prm_regra=''+regra+''&prm_tipo=''+tipo+''&prm_address=''+address+''&prm_hi=''+hi+''&prm_hf=''+hf+''&prm_semana=''+semana).then(function(resposta){ alerta(''feed-fixo'', resposta.replace(''[1]'', '''')); if(resposta.indexOf(''[1]'') != -1){ call(''td_access'', ''prm_usuario='||PRM_USUARIO||'&prm_conteudo=LISTA'').then(function(resposta){ document.getElementById(''ajax'').innerHTML = resposta; });  } }); alerta(''msg'','''||FUN.LANG('regra adicionada com sucesso')||'!''); }} ">'||FUN.LANG('ADICIONAR NETWALL')||'</a>');

END MENU_TD_ACCESS;


PROCEDURE REMOVE_LOCATION ( PRM_OBJ    VARCHAR2 DEFAULT NULL,
                            PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

BEGIN

    DELETE FROM OBJECT_LOCATION WHERE
    OBJECT_ID = PRM_OBJ AND
	SCREEN = PRM_SCREEN;
    
	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Objeto '||PRM_OBJ||' excluido da tela '||PRM_SCREEN||'', GBL.GETUSUARIO, 'EVENTO');
    COMMIT;
	
END REMOVE_LOCATION;

PROCEDURE ALTER_ORDEM_GERAL ( PRM_VALOR VARCHAR2 DEFAULT NULL,
                              PRM_OBJETO VARCHAR2 DEFAULT NULL ) AS
ws_count   integer; 
BEGIN

    -- Cria a propriedade ORDEM para o usuário DWU (se não ouver)
	select count(*) into ws_count 
	 from object_attrib 
	where screen    = 'DEFAULT'
	  and cd_prop   = 'ORDEM' 
	  and cd_object = prm_objeto
	  and owner     = 'DWU';    
	if ws_count = 0 then 
    	insert into object_attrib  ( owner, navegador, screen, cd_object, cd_prop, propriedade) values ('DWU', 'DEFAULT', 'DEFAULT', prm_objeto, 'ORDEM', prm_valor); 	
	end if; 

    -- Atualiza a propriedade ORDEM de todos os usuários 
	UPDATE OBJECT_ATTRIB SET PROPRIEDADE = PRM_VALOR WHERE CD_PROP = 'ORDEM' AND CD_OBJECT = PRM_OBJETO;

    COMMIT;
END ALTER_ORDEM_GERAL;

PROCEDURE ALTER_ORDEM_PADRAO ( PRM_ORDEM VARCHAR2 DEFAULT NULL,
                               PRM_TIPO VARCHAR2 DEFAULT NULL,
                               PRM_PROP VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
    UPDATE OBJECT_PADRAO SET ORDEM = PRM_ORDEM WHERE TP_OBJETO = PRM_TIPO AND CD_PROP = PRM_PROP;
END ALTER_ORDEM_PADRAO;

PROCEDURE EXEC_SCRIPT ( PRM_OBJETO     VARCHAR2 DEFAULT NULL,
                        PRM_PARAMETROS VARCHAR2 DEFAULT NULL) AS

   CURSOR CRS_PARAMETROS IS

          












    SELECT TRIM(COLUMN_VALUE) AS VALOR FROM TABLE(FUN.VPIPE(PRM_PARAMETROS));

   WS_PARAMETRO     CRS_PARAMETROS%ROWTYPE;

    WS_ERRO             VARCHAR2(4000);
    WS_PARAMETROS       VARCHAR2(4000);
    WS_COMANDO          VARCHAR2(4000);
    WS_VIRGULA          CHAR(1)         := ' ';
    WS_JOB_ID           NUMBER;
    WS_NOEXEC           EXCEPTION;
    WS_EXECUTANDO       EXCEPTION;
    WS_NOACT            EXCEPTION;
    WS_NOWAIT           EXCEPTION;
    WS_TIMEOUT          EXCEPTION;
    WS_TRY              NUMBER;
    WS_CHECK            NUMBER          := 0;

    V_INTCUR            PLS_INTEGER;
    WS_RET              NUMBER;

BEGIN
    WS_TRY   := 60;
    WS_CHECK := 1;
    LOOP
       EXIT WHEN WS_CHECK=0;

         SELECT COUNT(*) INTO WS_CHECK
         FROM   RUNNING_PROCESS
         WHERE LAST_STATUS='RUNNING' AND
               DS_PROCESSO IN ((SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(FUN.GETPROP(PRM_OBJETO, 'EM_ESPERA')))));
         WS_TRY := WS_TRY - 1;
         IF  WS_TRY=0 AND WS_CHECK<>0 THEN
             RAISE WS_TIMEOUT;
         END IF;

         IF  WS_CHECK<>0 THEN
             DBMS_LOCK.SLEEP(15);
         END IF;
    END LOOP;

    IF  FUN.GETPROP(PRM_OBJETO, 'EXECUCAO')='EXCLUSIVA' THEN
        SELECT COUNT(*) INTO WS_CHECK
        FROM   RUNNING_SCRIPTS
        WHERE  STATUS = 'RUNNING' AND
               SCRIPT_NAME = PRM_OBJETO;
        IF  WS_CHECK > 0 THEN
            RAISE WS_EXECUTANDO;
        END IF;
    END IF;

    SELECT COUNT(*) INTO WS_CHECK
    FROM   RUNNING_SCRIPTS
    WHERE  STATUS = 'WAITING' AND
           SCRIPT_NAME = PRM_OBJETO;

    IF  WS_CHECK <> 1 THEN
        RAISE WS_EXECUTANDO;
    END IF;

    SELECT JOB_ID INTO WS_JOB_ID
    FROM   RUNNING_SCRIPTS
    WHERE  STATUS = 'WAITING' AND
           SCRIPT_NAME = PRM_OBJETO;

    UPDATE RUNNING_SCRIPTS
    SET    STATUS = 'RUNNING'
    WHERE SCRIPT_NAME = PRM_OBJETO AND
          STATUS = 'WAITING' AND
          JOB_ID = WS_JOB_ID;
    COMMIT;


    BEGIN
        OPEN CRS_PARAMETROS;
            LOOP
                FETCH CRS_PARAMETROS INTO WS_PARAMETRO;
                EXIT WHEN CRS_PARAMETROS%NOTFOUND;
                WS_PARAMETROS := WS_PARAMETROS||WS_VIRGULA||CHR(39)||TRIM(WS_PARAMETRO.VALOR)||CHR(39);
                WS_VIRGULA    := ',';
            END LOOP;
        CLOSE CRS_PARAMETROS;

        WS_COMANDO := FUN.GETPROP(PRM_OBJETO, 'COMANDO');
        IF  NVL(TRIM(WS_PARAMETROS),'SEM_PARAMETROS') <> 'SEM_PARAMETROS' THEN
            WS_COMANDO := WS_COMANDO||'('||WS_PARAMETROS||')';
        END IF;


        V_INTCUR := DBMS_SQL.OPEN_CURSOR;

        DBMS_SQL.PARSE(V_INTCUR, 'begin '||WS_COMANDO||'; end;', DBMS_SQL.NATIVE);
        WS_RET := DBMS_SQL.EXECUTE(V_INTCUR);
        DBMS_SQL.CLOSE_CURSOR(V_INTCUR);

    EXCEPTION
          WHEN OTHERS THEN
               RAISE WS_NOEXEC;
    END;


    UPDATE RUNNING_SCRIPTS
    SET    STATUS = 'END', DT_FINAL = SYSDATE, MENSAGEM_FINAL = WS_COMANDO||';'
    WHERE  SCRIPT_NAME = PRM_OBJETO AND
           STATUS = 'RUNNING' AND
           JOB_ID = WS_JOB_ID;
    COMMIT;

EXCEPTION
    WHEN WS_NOWAIT THEN
        INSERT INTO LOG_EVENTOS VALUES(SYSDATE, 'Script ['||PRM_OBJETO||'] Sem WAIT!',GBL.GETUSUARIO, 'OBJ', 'SCRIPT', '01');
    WHEN WS_TIMEOUT THEN
         UPDATE RUNNING_SCRIPTS
         SET    STATUS = 'ERRO', DT_FINAL = SYSDATE, MENSAGEM_FINAL = 'Time OUT por espera!'
         WHERE  SCRIPT_NAME = PRM_OBJETO AND
                STATUS IN ('RUNNING', 'WAITING') AND
                JOB_ID = WS_JOB_ID;
         INSERT INTO LOG_EVENTOS VALUES(SYSDATE, 'Script ['||PRM_OBJETO||'] Time Out!',GBL.GETUSUARIO, 'OBJ', 'SCRIPT', '01');
    WHEN WS_EXECUTANDO THEN
       INSERT INTO LOG_EVENTOS VALUES (SYSDATE, 'Script ['||PRM_OBJETO||'] '||FUN.LANG('J&aacute; Executando'),GBL.GETUSUARIO, 'OBJ', 'SCRIPT', '03');
    WHEN WS_NOEXEC THEN
         WS_ERRO := SQLERRM;
         UPDATE RUNNING_SCRIPTS
         SET    STATUS='ERRO', DT_FINAL = SYSDATE, MENSAGEM_FINAL = WS_ERRO
         WHERE  SCRIPT_NAME = PRM_OBJETO AND
                STATUS IN ('RUNNING', 'WAITING') AND
                JOB_ID = WS_JOB_ID;
       INSERT INTO LOG_EVENTOS VALUES (SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' Script ['||PRM_OBJETO||'] '||WS_COMANDO||'  '||FUN.LANG('Erro Execu&ccedil;&atilde;o'),GBL.GETUSUARIO, 'OBJ', 'SCRIPT', '04');
    WHEN OTHERS THEN
         WS_ERRO := SQLERRM;
         UPDATE RUNNING_SCRIPTS
         SET    STATUS = 'ERRO', DT_FINAL=SYSDATE, MENSAGEM_FINAL = WS_ERRO
         WHERE  SCRIPT_NAME = PRM_OBJETO AND
                STATUS IN ('RUNNING', 'WAITING') AND
                JOB_ID = WS_JOB_ID;
      INSERT INTO LOG_EVENTOS VALUES (SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,GBL.GETUSUARIO, 'OBJ', 'SCRIPT', '05');
END EXEC_SCRIPT;

PROCEDURE PROGRAMA_EXECUCAO ( PRM_OBJETO     VARCHAR2 DEFAULT NULL,
                              PRM_PARAMETROS VARCHAR2 DEFAULT NULL,
                              PRM_SCREEN     VARCHAR2 DEFAULT NULL ) AS

    WS_ERRO             VARCHAR2(4000)  := 'Execu&ccedil;&atilde;o do SCRIPT Solicitada.';
    WS_PARAMETROS       VARCHAR2(4000)  := '';
    WS_COMANDO          VARCHAR2(4000);
    WS_VIRGULA          CHAR(1)         := ' ';
    WS_JOB_ID           NUMBER;
    WS_NOEXEC           EXCEPTION;
    WS_EXECUTANDO       EXCEPTION;
    WS_CHECK            NUMBER          := 0;
    WS_PIPE             VARCHAR2(1) := '';


BEGIN

    BEGIN
        IF  FUN.GETPROP(PRM_OBJETO, 'EXECUCAO')='EXCLUSIVA' THEN
            SELECT COUNT(*) INTO WS_CHECK
            FROM   RUNNING_SCRIPTS
            WHERE  STATUS IN ('RUNNING','WAITING') AND
                   SCRIPT_NAME=PRM_OBJETO;
            IF  WS_CHECK > 0 THEN
                RAISE WS_EXECUTANDO;
            END IF;
        END IF;

        FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(TRIM(PRM_PARAMETROS)))) LOOP
            WS_PARAMETROS := WS_PARAMETROS||WS_PIPE||FUN.GPARAMETRO(I.COLUMN_VALUE, '', PRM_SCREEN);
            WS_PIPE := '|';
        END LOOP;

        BEGIN
            DBMS_JOB.SUBMIT(JOB => WS_JOB_ID,WHAT => 'FCL.EXEC_SCRIPT('||CHR(39)||PRM_OBJETO||CHR(39)||','||CHR(39)||WS_PARAMETROS||CHR(39)||');',NEXT_DATE => SYSDATE+((1/4)/(24*60)),INTERVAL => NULL);
            INSERT INTO RUNNING_SCRIPTS VALUES (PRM_OBJETO,SYSDATE,'',USER,(FUN.GETPROP(PRM_OBJETO, 'PARAMETROS')),'WAITING','', WS_JOB_ID);
            COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
                 RAISE WS_NOEXEC;
        END;

        EXCEPTION
           WHEN WS_EXECUTANDO THEN
                WS_ERRO := 'J&aacute; executando!';
           WHEN WS_NOEXEC THEN
                WS_ERRO := SQLERRM;
           WHEN OTHERS THEN
                WS_ERRO := SQLERRM;
    END;

    HTP.P(WS_ERRO);

END PROGRAMA_EXECUCAO;

PROCEDURE CHECK_TEXT_POST AS

    WS_COUNT         NUMBER;
    WS_NOSESSION     EXCEPTION;
	WS_USUARIO       VARCHAR2(80); 

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

      IF  FUN.CHECK_SESSION = 'NO_S' THEN
          RAISE WS_NOSESSION;
      ELSE

		  SELECT COUNT(*) INTO WS_COUNT
		  FROM   TEXT_POST
		  WHERE (CD_GROUP = WS_USUARIO OR CD_GROUP = 'todos' OR
				 CD_GROUP IN (SELECT CD_GROUP FROM GUSERS_ITENS T1 WHERE T1.CD_USUARIO = WS_USUARIO)) AND
				 CD_USUARIO <> USER AND
				 CD_USUARIO <> 'SYS' AND
				 POST_ID NOT IN (SELECT ID_POST FROM CHECK_POST WHERE CD_USUARIO = WS_USUARIO) AND
				 TRUNC(TO_DATE(SYSDATE, 'DD-MM-YY'))-TRUNC(TO_DATE(DT_POST, 'DD-MM-YY')) <= TIME_LIVE AND
				 NVL(TRIM(SELECT_LINE), '999999999') = '999999999';

		  HTP.P(WS_COUNT);
	  END IF;

EXCEPTION
      WHEN WS_NOSESSION THEN
           HTP.P('LOGOFF');
	  WHEN OTHERS THEN
           HTP.P('LOGOFF');
END CHECK_TEXT_POST;

PROCEDURE COUNTCHECKPOST AS

    WS_COUNT NUMBER;

BEGIN

    SELECT COUNT(*) INTO WS_COUNT FROM CHECK_POST WHERE CD_USUARIO = GBL.GETUSUARIO AND DT_CHECK IS NULL;
	HTP.P(WS_COUNT);
EXCEPTION WHEN OTHERS THEN
    HTP.P('0');
END COUNTCHECKPOST;

PROCEDURE NOTIFY_ME ( PRM_NOTIFY VARCHAR2 DEFAULT NULL,
                      PRM_PONTO VARCHAR2 DEFAULT NULL,
                      PRM_VISAO VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_USUARIOS IS SELECT USU_NOME, USU_COMPLETO
    FROM USUARIOS
    ORDER BY USU_NOME;

	WS_USUARIO CRS_USUARIOS%ROWTYPE;

	CURSOR CRS_GRUPOS IS SELECT CD_GROUP, NM_GROUP
    FROM GUSERS
    ORDER BY NM_GROUP;

	WS_GRUPO CRS_GRUPOS%ROWTYPE;

	CURSOR CRS_NOTIFY IS
	SELECT CD_NOTIFY, DS_NOTIFY, CD_GRUPO, CD_PONTO, MICRO_VISAO FROM NOTIFY_ME
	WHERE CD_USUARIO = GBL.GETUSUARIO
	ORDER BY CD_NOTIFY;

	WS_NOTIFY CRS_NOTIFY%ROWTYPE;

	WS_VALOR    VARCHAR2(40);
	WS_COUNT    NUMBER;
	WS_DESC     VARCHAR2(2000) := '';
	WS_TEXTO    VARCHAR2(2000) := '';
	WS_RECEIVER VARCHAR2(2000) := '';
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
BEGIN
    
    
	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;
	
	HTP.P('<div style="display: inline-flex; height: 25px; line-height: 25px;">');
		HTP.P('<input type="hidden" id="cd_ponto" value="'||PRM_PONTO||'" />');
		HTP.P('<input type="hidden" id="micro_visao" value="'||PRM_VISAO||'" />');
		IF NVL(TRIM(PRM_NOTIFY), '999999999') <> '999999999' THEN
			SELECT DS_NOTIFY INTO WS_DESC FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
			SELECT TYPE_TEXT INTO WS_TEXTO FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
			SELECT CD_GRUPO INTO WS_RECEIVER FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
			HTP.P('<input style="background: #BBB;" class="up" readonly="true" type="text" placeholder="'||FUN.LANG('c&oacute;digo')||'" id="cd_notify" value="'||PRM_NOTIFY||'">');
		ELSE
			HTP.P('<input type="text" placeholder="'||FUN.LANG('c&oacute;digo')||'" id="cd_notify" class="up" style="float: left;">');
		END IF;
		IF LENGTH(WS_DESC) > 3 THEN
			HTP.P('<input style="background: #BBB;" readonly="true" type="text" title="'||WS_DESC||'" id="ds_notify" value="'||FUN.UTRANSLATE('DS_NOTIFY', 'NOTIFY_ME', WS_DESC, WS_PADRAO)||'" />');
			HTP.P('<a style="height: 18px; margin: 3px 0;" class="fakelang" onclick="fakeLang(''ds_notify'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a>');
		ELSE
			HTP.P('<input type="text" style="float: left;" placeholder="'||FUN.LANG('descri&ccedil;&atilde;o')||'" id="ds_notify" value="'||WS_DESC||'">');
		END IF;

		IF NVL(TRIM(PRM_NOTIFY), '999999999') = '999999999' THEN
		    HTP.P('<select id="receiver" style="float: left;" >');
		ELSE
		    HTP.P('<select id="receiver" onchange="ajax(''fly'', ''save_notify'', ''prm_notify='||PRM_NOTIFY||'&prm_dsnotify=''+document.getElementById(''ds_notify'').value+''&prm_ponto='||PRM_PONTO||'&prm_receiver=''+this.value+''&prm_texto=''+document.getElementById(''type_text'').value+''&prm_visao='||PRM_VISAO||'&prm_update=S'', false); noerror('''', TR_CR, ''msg'');">');
		END IF;

		HTP.P('<option value="todos">'||FUN.LANG('Todos')||'</option>');
		HTP.P('<optgroup label="'||FUN.LANG('GRUPOS')||'" style="font-weight: bold; font-size: 14px;">'||FUN.LANG('GRUPOS')||'</optgroup>');
		OPEN CRS_GRUPOS;
			LOOP
				FETCH CRS_GRUPOS INTO WS_GRUPO;
				EXIT WHEN CRS_GRUPOS%NOTFOUND;
				IF WS_RECEIVER = WS_GRUPO.CD_GROUP THEN
					HTP.P('<option selected="selected" value="'||WS_GRUPO.CD_GROUP||'" title="'||WS_GRUPO.NM_GROUP||'">'||WS_GRUPO.NM_GROUP||'</option>');
				ELSE
					HTP.P('<option value="'||WS_GRUPO.CD_GROUP||'" title="'||WS_GRUPO.NM_GROUP||'">'||WS_GRUPO.NM_GROUP||'</option>');
				END IF;
			END LOOP;
		CLOSE CRS_GRUPOS;
		HTP.P('<optgroup label="'||FUN.LANG('USU&Aacute;RIOS')||'" style="font-weight: bold; font-size: 14px;">'||FUN.LANG('USU&Aacute;RIOS')||'</optgroup>');
		OPEN CRS_USUARIOS;
			LOOP
				FETCH CRS_USUARIOS INTO WS_USUARIO;
				EXIT WHEN CRS_USUARIOS%NOTFOUND;
					IF WS_RECEIVER = WS_USUARIO.USU_NOME THEN
						HTP.P('<option selected="selected" value="'||TRIM(WS_USUARIO.USU_NOME)||'" title="'||TRIM(WS_USUARIO.USU_COMPLETO)||'">'||TRIM(WS_USUARIO.USU_NOME)||'</option>');
					ELSE
						HTP.P('<option value="'||TRIM(WS_USUARIO.USU_NOME)||'" title="'||TRIM(WS_USUARIO.USU_COMPLETO)||'">'||TRIM(WS_USUARIO.USU_NOME)||'</option>');
					END IF;
			END LOOP;
		CLOSE CRS_USUARIOS;
		HTP.P('</select>');
		IF NVL(TRIM(PRM_NOTIFY), '999999999') = '999999999' THEN
		    HTP.P('<textarea class="retracted" type="text" onblur="this.className = ''retracted'';" id="type_text" onfocus="this.className = ''retracted expand'';" placeholder="'||FUN.LANG('Observa&ccedil;&atilde;o')||'">'||WS_TEXTO||'</textarea>');
		    HTP.P('<a class="add" onclick="if(document.getElementById(''cd_notify'').value.trim().length > 1){ if(document.getElementById(''type_text'').value.trim().length > 0){ ajax(''main'', ''save_notify'', ''prm_notify=''+document.getElementById(''cd_notify'').value+''&prm_dsnotify=''+document.getElementById(''ds_notify'').value+''&prm_ponto=''+document.getElementById(''cd_ponto'').value+''&prm_receiver=''+document.getElementById(''usuario-msg'').title+''&prm_texto=''+document.getElementById(''type_text'').value+''&prm_visao=''+document.getElementById(''micro_visao'').value, false, ''ajax''); noerror('''', TR_AD, ''msg''); } else { alerta(''msg'', TR_BL); } } else { alerta(''msg'', TR_CD_LE); }">+</a>');
	    ELSE
		    HTP.P('<textarea class="retracted" type="text" onblur="this.className = ''retracted''; ajax(''fly'', ''save_notify'', ''prm_notify='||PRM_NOTIFY||'&prm_dsnotify=''+document.getElementById(''ds_notify'').value+''&prm_ponto='||PRM_PONTO||'&prm_receiver=''+document.getElementById(''usuario-msg'').title+''&prm_texto=''+this.value+''&prm_visao='||PRM_VISAO||'&prm_update=S'', false); noerror('''', TR_CR, ''msg'');" id="type_text" onfocus="this.className = ''retracted expand'';" placeholder="'||FUN.LANG('Observa&ccedil;&atilde;o')||'">'||WS_TEXTO||'</textarea>');
		END IF;
	HTP.P('</div>');

    HTP.P('<h2>'||FUN.LANG('Lista de notifica&ccedil;&otilde;es')||'</h2>');

    HTP.P('<table class="linha">');
	HTP.P('<thead>');
	    HTP.P('<tr>');
		    HTP.P('<th>'||FUN.LANG('C&oacute;digo')||'</th>');
			HTP.P('<th>'||FUN.LANG('Descri&ccedil;&atilde;o')||'</th>');
			HTP.P('<th>'||FUN.LANG('Grupo')||'</th>');
			HTP.P('<th></th>');
			HTP.P('<th></th>');
			HTP.P('<th></th>');
		HTP.P('</tr>');
	HTP.P('</thead>');
	HTP.P('<tbody id="ajax">');
	    OPEN CRS_NOTIFY;
		    LOOP
			    FETCH CRS_NOTIFY INTO WS_NOTIFY;
				EXIT WHEN CRS_NOTIFY%NOTFOUND;
				HTP.P('<tr>');
					HTP.P('<td>'||WS_NOTIFY.CD_NOTIFY||'</td>');
					HTP.P('<td><span title="'||WS_NOTIFY.DS_NOTIFY||'" id="'||WS_NOTIFY.CD_NOTIFY||'_desc">'||FUN.UTRANSLATE('DS_NOTIFY', 'NOTIFY_ME', WS_NOTIFY.DS_NOTIFY, WS_PADRAO)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||WS_NOTIFY.CD_NOTIFY||'_desc'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a></td>');
					HTP.P('<td>'||WS_NOTIFY.CD_GRUPO||'</td>');
					HTP.P('<td><a class="link" onclick=" carrega(''notify_me?prm_notify='||WS_NOTIFY.CD_NOTIFY||'&prm_ponto='||WS_NOTIFY.CD_PONTO||'''); call_save('''');">'||FUN.LANG('ALTERAR')||'</a></td>');

					SELECT * INTO WS_VALOR FROM TABLE(FUN.VPIPE(WS_NOTIFY.CD_PONTO)) WHERE ROWNUM = 1;

					HTP.P('<td><a class="link" onclick="carregaPainel(''notify''); looping = setInterval(function(){ if(document.getElementById(''valor-coluna'')){ document.getElementById(''valor-coluna'').value='''||WS_VALOR||'''; clearInterval(looping); } }, 100); call_save(''''); carrega(''list_filtro_notify?prm_notify='||WS_NOTIFY.CD_NOTIFY||'&prm_limitado=S'');  document.getElementById(''titulo'').innerHTML=''Filtro da notifica&ccedil;&atilde;o '||WS_NOTIFY.CD_NOTIFY||''' ;">'||FUN.LANG('FILTROS')||'</a></td>');
					FCL.BUTTON_LIXO('dl_notify','prm_notify', WS_NOTIFY.CD_NOTIFY);
					
				HTP.P('</tr>');
			END LOOP;
		CLOSE CRS_NOTIFY;
	HTP.P('</tbody>');
	HTP.P('</table>');

END NOTIFY_ME;

PROCEDURE SAVE_NOTIFY ( PRM_NOTIFY VARCHAR2 DEFAULT NULL,
                        PRM_DSNOTIFY VARCHAR2 DEFAULT NULL,
						PRM_PONTO VARCHAR2 DEFAULT NULL,
						PRM_RECEIVER VARCHAR2 DEFAULT NULL,
						PRM_TEXTO VARCHAR2 DEFAULT NULL,
						PRM_VISAO VARCHAR2 DEFAULT NULL,
						PRM_UPDATE CHAR DEFAULT 'N' ) AS

	WS_COUNT   NUMBER;
	WS_PADRAO  VARCHAR2(80) := 'PORTUGUESE';

BEGIN
    
	SELECT COUNT(*) INTO WS_COUNT FROM NOTIFY_ME WHERE UPPER(TRIM(CD_NOTIFY)) = UPPER(TRIM(PRM_NOTIFY));

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    IF WS_COUNT = 0 THEN
		INSERT INTO NOTIFY_ME VALUES (UPPER(TRIM(PRM_NOTIFY)), PRM_DSNOTIFY, PRM_PONTO,GBL.GETUSUARIO, PRM_RECEIVER, PRM_TEXTO, SYSDATE, '', PRM_VISAO);
		INSERT INTO TRADUCAO_COLUNAS VALUES('NOTIFY_ME', 'DS_NOTIFY', FUN.RET_VAR('LANG_SYS'), PRM_DSNOTIFY, PRM_DSNOTIFY, 'T', 'N');
		HTP.P('<tr>');
			HTP.P('<td>'||UPPER(TRIM(PRM_NOTIFY))||'</td>');
			HTP.P('<td><span title="'||PRM_DSNOTIFY||'" id="'||UPPER(TRIM(PRM_NOTIFY))||'_desc">'||FUN.UTRANSLATE('DS_NOTIFY', 'NOTIFY_ME', PRM_DSNOTIFY, WS_PADRAO)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||UPPER(TRIM(PRM_NOTIFY))||'_desc'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a></td>');
			HTP.P('<td>'||PRM_RECEIVER||'</td>');
			HTP.P('<td><a class="link" onclick="carrega(''notify_me?prm_notify='||UPPER(TRIM(PRM_NOTIFY))||'&prm_ponto='||PRM_PONTO||'''); call_save('''');">'||FUN.LANG('ALTERAR')||'</a></td>');
			HTP.P('<td><a class="link" onclick="carregaPainel(''notify''); looping = setInterval(function(){ if(document.getElementById(''valor-coluna'')){ document.getElementById(''valor-coluna'').value='''||PRM_TEXTO||'''; clearInterval(looping); } }, 100); carrega(''list_filtro_notify?prm_notify='||UPPER(TRIM(PRM_NOTIFY))||'&prm_limitado=S'');  document.getElementById(''titulo'').innerHTML=''Filtro da notifica&ccedil;&atilde;o '||UPPER(TRIM(PRM_NOTIFY))||''' ;">'||FUN.LANG('FILTROS')||'</a></td>');
			FCL.BUTTON_LIXO('dl_notify','prm_notify', UPPER(TRIM(PRM_NOTIFY)));
			
		HTP.P('</tr>');
	ELSIF WS_COUNT > 1 THEN
		HTP.P('#alert '||FUN.LANG('notifica&ccedil;&atilde;o duplicada no sistema')||'!');
	ELSE
	    IF PRM_UPDATE = 'S' THEN
		   UPDATE NOTIFY_ME
		   SET DS_NOTIFY = PRM_DSNOTIFY,
		   CD_GRUPO = PRM_RECEIVER,
		   TYPE_TEXT = PRM_TEXTO,
		   DT_ULTIMA = SYSDATE
		   WHERE CD_NOTIFY = PRM_NOTIFY;
		ELSE
		    HTP.P('#alert '||FUN.LANG('notifica&ccedil;&atilde;o j&aacute; existe no sistema')||'!');
		END IF;
	END IF;

END SAVE_NOTIFY;

PROCEDURE NOTIFY_LIST AS

    CURSOR CRS_NOTIFY IS
	SELECT CD_NOTIFY, DS_NOTIFY, CD_USUARIO, CD_GRUPO, CD_PONTO, MICRO_VISAO, TYPE_TEXT FROM NOTIFY_ME
	ORDER BY CD_USUARIO, CD_NOTIFY;

	WS_NOTIFY CRS_NOTIFY%ROWTYPE;

	WS_VALOR  VARCHAR2(40);
	WS_PADRAO VARCHAR2(80) := 'PORTUGUESE';

BEGIN
    

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = GBL.GETUSUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    HTP.P('<table class="linha">');
	HTP.P('<thead>');
	    HTP.P('<tr>');
		    HTP.P('<th>'||FUN.LANG('Usu&aacute;rio')||'</th>');
		    HTP.P('<th>'||FUN.LANG('C&oacute;digo')||'</th>');
			HTP.P('<th>'||FUN.LANG('Descri&ccedil;&atilde;o')||'</th>');
			HTP.P('<th>'||FUN.LANG('Grupo')||'</th>');
			HTP.P('<th></th>');
			HTP.P('<th></th>');
			HTP.P('<th></th>');
		HTP.P('</tr>');
	HTP.P('</thead>');
	HTP.P('<tbody>');
	    OPEN CRS_NOTIFY;
		    LOOP
			    FETCH CRS_NOTIFY INTO WS_NOTIFY;
				EXIT WHEN CRS_NOTIFY%NOTFOUND;
				HTP.P('<tr>');
				    HTP.P('<td>'||WS_NOTIFY.CD_USUARIO||'</td>');
					HTP.P('<td>'||WS_NOTIFY.CD_NOTIFY||'</td>');
					HTP.P('<td><span title="'||WS_NOTIFY.DS_NOTIFY||'" id="'||WS_NOTIFY.CD_NOTIFY||'_desc">'||FUN.UTRANSLATE('DS_NOTIFY', 'NOTIFY_ME', WS_NOTIFY.DS_NOTIFY, WS_PADRAO)||'</span><a class="fakelang" style="margin-left: 3px;" onclick="fakeLang('''||WS_NOTIFY.CD_NOTIFY||'_desc'', ''NOTIFY_ME|DS_NOTIFY|''+this.previousElementSibling.title);">L</a></td>');
					HTP.P('<td>'||WS_NOTIFY.CD_GRUPO||'</td>');
					HTP.P('<td><a class="link" onclick="carrega(''notify_me?prm_notify='||WS_NOTIFY.CD_NOTIFY||'&prm_ponto='||WS_NOTIFY.CD_PONTO||'''); call_save('''');">'||FUN.LANG('ALTERAR')||'</a></td>');
					SELECT * INTO WS_VALOR FROM TABLE(FUN.VPIPE(WS_NOTIFY.CD_PONTO)) WHERE ROWNUM = 1;

					HTP.P('<td><a class="link" onclick="carregaPainel(''notify''); looping = setInterval(function(){ if(document.getElementById(''valor-coluna'')){ document.getElementById(''valor-coluna'').value='''||WS_VALOR||'''; clearInterval(looping); } }, 100); carrega(''list_filtro_notify?prm_notify='||WS_NOTIFY.CD_NOTIFY||'&prm_limitado=N'');  document.getElementById(''titulo'').innerHTML=''Filtro da notifica&ccedil;&atilde;o '||WS_NOTIFY.CD_NOTIFY||''' ;">'||FUN.LANG('FILTROS')||'</a></td>');
					FCL.BUTTON_LIXO('dl_notify','prm_notify', WS_NOTIFY.CD_NOTIFY);
					
				HTP.P('</tr>');
			END LOOP;
		CLOSE CRS_NOTIFY;
	HTP.P('</tbody>');
	HTP.P('</table>');
END NOTIFY_LIST;

PROCEDURE DL_NOTIFY ( PRM_NOTIFY VARCHAR2 DEFAULT NULL ) AS

WS_COUNT NUMBER;

BEGIN
    
    SELECT COUNT(*) INTO WS_COUNT FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
	IF WS_COUNT = 1 THEN
	    DELETE FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
		DELETE FROM FILTROS_NOTIFY WHERE CD_NOTIFY = PRM_NOTIFY;
	ELSIF WS_COUNT = 0 THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir, notifica&ccedil;&atilde;os n&atilde;o existe no sistema')||'!');
	ELSE
	    HTP.P('#alert '||FUN.LANG('Erro ao excluir, valor duplicado no sistema')||'!');
	END IF;

END DL_NOTIFY;

PROCEDURE LIST_FILTRO_NOTIFY ( PRM_NOTIFY VARCHAR2 DEFAULT NULL,
                               PRM_LIMITADO VARCHAR2 DEFAULT 'N' ) AS

    CURSOR CRS_FILTROS IS
	SELECT MICRO_VISAO, CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO, ROWNUM AS ITEM
	FROM FILTROS_NOTIFY
	WHERE CD_NOTIFY = PRM_NOTIFY;

	WS_FILTRO CRS_FILTROS%ROWTYPE;

    WS_COUNT NUMBER;
    WS_VISAO VARCHAR2(40);
	WS_COLUNA VARCHAR2(40);
BEGIN
    
    SELECT MICRO_VISAO INTO WS_VISAO FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
	SELECT CD_PONTO INTO WS_COLUNA FROM NOTIFY_ME WHERE CD_NOTIFY = PRM_NOTIFY;
	HTP.P('<input type="hidden" value="'||PRM_NOTIFY||'" id="cd_notify">');
    HTP.P('<input type="hidden" value="'||WS_VISAO||'" id="micro_visao">');
	HTP.P('<input type="hidden" value="'||WS_COLUNA||'" id="coluna">');
    HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th>'||FUN.LANG('Condi&ccedil;&atilde;o')||'</th>');
				HTP.P('<th>'||FUN.LANG('Conteudo')||'</th>');
				HTP.P('<th>'||FUN.LANG('Liga&ccedil;&atilde;o')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody id="ajax">');
			OPEN CRS_FILTROS;
				LOOP
					FETCH CRS_FILTROS INTO WS_FILTRO;
					EXIT WHEN CRS_FILTROS%NOTFOUND;
				    HTP.P('<tr>');
					    HTP.P('<td>');
						    HTP.P('<select id="'||WS_FILTRO.ITEM||'-condicao" onchange="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||WS_FILTRO.ITEM||'&prm_notify='||PRM_NOTIFY||'&prm_visao='||WS_FILTRO.MICRO_VISAO||'&prm_condicao=''+this.value+''&prm_conteudo=''+document.getElementById('''||WS_FILTRO.ITEM||'-conteudo'').value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');">');
							    
                                FCL.CONDICOES('selected', WS_FILTRO.CONDICAO);
			                HTP.P('</select>');
						HTP.P('</td>');
						HTP.P('<td><input onblur="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||WS_FILTRO.ITEM||'&prm_notify='||PRM_NOTIFY||'&prm_visao='||WS_FILTRO.MICRO_VISAO||'&prm_condicao=''+document.getElementById('''||WS_FILTRO.ITEM||'-condicao'').value+''&prm_conteudo=''+this.value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');" id="'||WS_FILTRO.ITEM||'-conteudo" type="text" value="'||WS_FILTRO.CONTEUDO||'" /></td>');
						HTP.P('<td>'||WS_FILTRO.LIGACAO||'</td>');
						HTP.P('<td>');
						    FCL.BUTTON_LIXO('alter_filtro_notify', 'prm_item', WS_FILTRO.ITEM, PRM_TAG => 'a');
						HTP.P('</td>');
						
					HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_FILTROS;
		HTP.P('</tbody>');
	HTP.P('</table>');
	IF PRM_LIMITADO = 'S' THEN
	    HTP.P('<div class="listar"><a onclick="if(document.getElementById(''drill_go'')){ var go = document.getElementById(''drill_go'').value; } else { go = ''''; } if(document.getElementById(''jumpdrill'').getAttribute(''class'')){ var jump = document.getElementById(''jumpdrill'').getAttribute(''class''); } else { var jump = ''''; } document.getElementById(''painel'').innerHTML = ''''; call_save(''''); document.getElementById(''titulo'').innerHTML=''notifica&ccedil;&atilde;o de Filtro''; curtain(''enabled'') ; carrega(''notify_me?prm_visao='||WS_VISAO||'&prm_ponto=''+jump+''|''+go+''&''); ">'||FUN.LANG('Voltar as notifica&ccedil;&otilde;es')||'</a></div>');
	ELSE

	    HTP.P('<div class="listar"><a onclick="call_save(''''); carrega(''notify_list''); document.getElementById(''painel'').innerHTML = ''''; document.getElementById(''titulo'').innerHTML='''||FUN.LANG('notifica&ccedil;&atilde;o de Filtro')||''';">'||FUN.LANG('Listar notifica&ccedil;&otilde;es')||'</a></div>');
    END IF;
END LIST_FILTRO_NOTIFY;

PROCEDURE ALTER_FILTRO_NOTIFY ( PRM_ITEM VARCHAR2 DEFAULT NULL,
                              PRM_NOTIFY VARCHAR2 DEFAULT NULL,
                              PRM_VISAO VARCHAR2 DEFAULT NULL,
							  PRM_COLUNA VARCHAR2 DEFAULT NULL,
							  PRM_CONDICAO VARCHAR2 DEFAULT NULL,
							  PRM_CONTEUDO VARCHAR2 DEFAULT NULL,
							  PRM_LIGACAO VARCHAR2 DEFAULT NULL,
                              PRM_ACTION VARCHAR2 DEFAULT 'del' ) AS

	WS_COUNT NUMBER;
	WS_ITEM  NUMBER;
BEGIN
    
    IF PRM_ACTION = 'add' THEN
	    SELECT COUNT_NOTIFY.NEXTVAL INTO WS_ITEM FROM DUAL;
        INSERT INTO FILTROS_NOTIFY VALUES(WS_ITEM,GBL.GETUSUARIO, PRM_NOTIFY, PRM_VISAO, PRM_COLUNA, PRM_CONDICAO, PRM_CONTEUDO, PRM_LIGACAO);
		HTP.P('<tr>');
			 HTP.P('<td>');
			     HTP.P('<select id="'||WS_ITEM||'-condicao" onchange="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||WS_ITEM||'&prm_notify='||PRM_NOTIFY||'&prm_visao='||PRM_VISAO||'&prm_condicao=''+this.value+''&prm_conteudo=''+document.getElementById('''||WS_ITEM||'-conteudo'').value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');">');
                    FCL.CONDICOES('selected', PRM_CONDICAO);
				HTP.P('</select>');
			HTP.P('</td>');
			HTP.P('<td><input id="'||WS_ITEM||'-conteudo" onblur="ajax(''fly'', ''alter_filtro_notify'', ''prm_item='||WS_ITEM||'&prm_notify='||PRM_NOTIFY||'&prm_visao='||PRM_VISAO||'&prm_condicao=''+document.getElementById('''||WS_ITEM||'-condicao'').value+''&prm_conteudo=''+this.value+''&prm_ligacao=AND&prm_action=alter'', false); noerror('''', ''Filtro alterado com sucesso!'', ''msg'');" type="text" value="'||PRM_CONTEUDO||'" /></td>');
			HTP.P('<td>'||PRM_LIGACAO||'</td>');
			HTP.P('<td>');
			    FCL.BUTTON_LIXO('alter_filtro_notify','prm_item', WS_ITEM, PRM_TAG => 'a');
			HTP.P('</td>');
			
		HTP.P('</tr>');
    ELSIF PRM_ACTION = 'alter' THEN
	    UPDATE FILTROS_NOTIFY
		SET CONDICAO = PRM_CONDICAO,
		CONTEUDO = PRM_CONTEUDO
		WHERE ITEM = PRM_ITEM;
	ELSE
	    SELECT COUNT(*) INTO WS_COUNT FROM FILTROS_NOTIFY WHERE ITEM = PRM_ITEM;
		IF WS_COUNT = 1 THEN
		    DELETE FROM FILTROS_NOTIFY WHERE ITEM = PRM_ITEM;
		ELSIF WS_COUNT = 0 THEN
		    HTP.P('#alert '||FUN.LANG('Erro ao excluir, valor inexistente')||'!');
		ELSE
		    HTP.P('#alert '||FUN.LANG('Erro ao excluir, notifica&ccedil;&atilde;o duplicada')||'!');
		END IF;
	END IF;
END ALTER_FILTRO_NOTIFY;

PROCEDURE EXEC_QUERY ( P_QUERY  IN VARCHAR2 DEFAULT NULL,
                       P_PARSE  IN VARCHAR2 DEFAULT NULL,
                       P_LINHAS IN VARCHAR2 DEFAULT '11') IS

  V_SQL       VARCHAR2(32767) := P_QUERY;
  V_CURSOR    NUMBER;
  COL_CNT     INTEGER;
  V_N_VAL     NUMBER;
  V_V_VAL     VARCHAR2(4000);
  V_L_VAL     LONG;
  V_D_VAL     DATE;
  REC_TAB     DBMS_SQL.DESC_TAB;
  DUMMY       NUMBER;
  V_RET       NUMBER;
  V_FINALTXT  VARCHAR2(100);
  COL_NUM     NUMBER;
  WS_CAB      VARCHAR2(32767);
  WS_CONTEUDO LONG;
  WS_LOC      NUMBER;
  WS_COUNT    NUMBER;
  WS_TIPOLOG  VARCHAR2(25);
  WS_LOG	  VARCHAR2(4000);
  WS_PARSE    EXCEPTION;
  WS_TIPO     VARCHAR2(40) := '';
  WS_ERRORQUERY VARCHAR2(40);

BEGIN
    
  IF  P_LINHAS <> 0 THEN
      V_SQL := 'select * from ('||V_SQL||') where rownum<'||P_LINHAS;
  END IF;

  BEGIN
     V_CURSOR := DBMS_SQL.OPEN_CURSOR;
     DBMS_SQL.PARSE(V_CURSOR, V_SQL, DBMS_SQL.NATIVE);
     IF  P_PARSE = 'S' THEN
         DBMS_SQL.CLOSE_CURSOR(V_CURSOR);
         RAISE WS_PARSE;
     END IF;
  END;


  DBMS_SQL.DESCRIBE_COLUMNS(V_CURSOR, COL_CNT, REC_TAB);
  FOR J IN 1..COL_CNT
  LOOP

    BEGIN
	CASE REC_TAB(J).COL_TYPE
        WHEN 1 THEN
	        WS_TIPO := 'Varchar2';
            BEGIN
			    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,J,V_V_VAL,REC_TAB(J).COL_MAX_LEN);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P('');
			END;
        WHEN 96 THEN
            BEGIN
			    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,J,V_V_VAL,REC_TAB(J).COL_MAX_LEN);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P('');
			END;
        WHEN 2 THEN
	        WS_TIPO := 'Number';
            BEGIN
			    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,J,V_N_VAL);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P('');
			END;
        WHEN 12 THEN
            BEGIN
			    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,J,V_D_VAL);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P('');
			END;
        
	    WHEN 999 THEN
			WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'CLOB'||('</td>');
	    
	    WHEN 999 THEN
            WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'BLOB'||('</td>');
        
	    WHEN 999 THEN
            WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||''||('</td>');
	    WHEN 8 THEN
	        WS_TIPO := 'Long';
	        BEGIN
			    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,J,V_L_VAL,REC_TAB(J).COL_MAX_LEN);
			EXCEPTION WHEN OTHERS THEN
			    HTP.P('');
			END;
    ELSE
        WS_LOC := 0;
    END CASE;
	EXCEPTION WHEN OTHERS THEN
	  WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'ERRO'||('</td>');
	END;

	IF INSTR(WS_TIPO, 'char') > 0 THEN
	    WS_TIPO := WS_TIPO||'('||REC_TAB(J).COL_MAX_LEN||')';
	END IF;

    WS_CAB := WS_CAB||('<th title="'||WS_TIPO||'" style="cursor: pointer;" onclick="document.getElementById(''sqlquery'').value = document.getElementById(''sqlquery'').value+'' ''+'''||LOWER(REC_TAB(J).COL_NAME)||''';">')||UPPER(REC_TAB(J).COL_NAME)||('</th>');

  END LOOP;
  HTP.P('<thead>');
  HTP.P('<tr class="">');
      HTP.P(WS_CAB);
  HTP.P('</tr>');
  HTP.P('</thead>');

  DUMMY := DBMS_SQL.EXECUTE(V_CURSOR);




























  WS_LOC := 0;
  WS_COUNT := 0;
  HTP.P('<tbody>');
  LOOP
    WS_COUNT := WS_COUNT+1;
    V_RET := DBMS_SQL.FETCH_ROWS(V_CURSOR);
          EXIT WHEN V_RET = 0;

    WS_CONTEUDO := NULL;

    FOR J IN 1..COL_CNT
    LOOP
      CASE REC_TAB(J).COL_TYPE
        WHEN 1 THEN
             BEGIN
			     DBMS_SQL.COLUMN_VALUE(V_CURSOR,J,V_V_VAL);
                 WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||TRIM(V_V_VAL)||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		WHEN 96 THEN
		     BEGIN
                 DBMS_SQL.COLUMN_VALUE(V_CURSOR,J,V_V_VAL);
                 WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||TRIM(V_V_VAL)||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		WHEN 2 THEN
             BEGIN
				 DBMS_SQL.COLUMN_VALUE(V_CURSOR,J,V_N_VAL);
				 IF  REC_TAB(J).COL_SCALE=-127 THEN
					 WS_CONTEUDO := WS_CONTEUDO||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||TO_CHAR(V_N_VAL)||' '||('</td>');
				 ELSE
	                 WS_CONTEUDO := WS_CONTEUDO||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||TO_CHAR(V_N_VAL)||' '||('</td>');
				 END IF;
			 EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||('<td></td>');
			 END;
        WHEN 12 THEN
             BEGIN
			     DBMS_SQL.COLUMN_VALUE(V_CURSOR,J,V_D_VAL);
                 WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||LTRIM(TO_CHAR(V_D_VAL,'DD/MM/YYYY HH24:MI:SS'))||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		
		 WHEN 999 THEN
             BEGIN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'C_OBJETO(CLOB)'||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		
		 WHEN 999 THEN
             BEGIN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'B_OBJETO(BLOB)'||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		
		  WHEN 999 THEN
             BEGIN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: right;">')||'B_FILE(BFILE)'||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		WHEN 8 THEN
             BEGIN
			     DBMS_SQL.COLUMN_VALUE(V_CURSOR,J,V_L_VAL);
                 WS_CONTEUDO := WS_CONTEUDO||' '||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||TRIM(V_L_VAL)||('</td>');
		     EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
		ELSE
             BEGIN
                  DBMS_SQL.COLUMN_VALUE(V_CURSOR,J,V_V_VAL);
             EXCEPTION
                  WHEN OTHERS THEN
                      V_V_VAL := NULL;
             END;
             BEGIN
			     WS_CONTEUDO := WS_CONTEUDO||('<td onclick="this.parentNode.classList.toggle(''selected'');" style="text-align: left;">')||'##'||REC_TAB(J).COL_TYPE||'##'||('</td>');
             EXCEPTION WHEN OTHERS THEN
			     WS_CONTEUDO := WS_CONTEUDO||' '||('<td></td>');
			 END;
	  END CASE;
    END LOOP;
    HTP.P('<tr class="">');
        HTP.P(WS_CONTEUDO);
    HTP.P('</tr>');
  END LOOP;
    WS_COUNT := WS_COUNT-1;
    HTP.P('<tr style="display: none;" id="count-result"><td style="border: none;">'||FUN.LANG('N&uacute;mero de linhas')||': '||WS_COUNT||'</td></tr>');
  HTP.P('</tbody>');


  DBMS_SQL.CLOSE_CURSOR(V_CURSOR);
	IF INSTR(UPPER(P_QUERY),'BI_LOG_QUERY') = 0 THEN
		INSERT INTO BI_LOG_QUERY VALUES( SYSDATE, UPPER(P_QUERY), 'EXECUTADO');
	END IF;
  EXCEPTION
     WHEN WS_PARSE THEN
           HTP.P(FUN.LANG('Verifica&ccedil;&atilde;o OK!'));
     WHEN OTHERS THEN
           HTP.P(FUN.LANG('Erro na query')||'!  '||SQLERRM);
           WS_ERRORQUERY := SQLERRM;
		    IF INSTR(UPPER(P_QUERY),'BI_LOG_QUERY') = 0 THEN
				INSERT INTO BI_LOG_QUERY VALUES( SYSDATE, UPPER(P_QUERY), UPPER('ERRO - '||WS_ERRORQUERY) );
			END IF;
END EXEC_QUERY;

PROCEDURE UPLOAD ( PRM_ALTERNATIVO VARCHAR2 DEFAULT NULL ) AS
  L_NOME_REAL  VARCHAR2(1000);
BEGIN
    
    HTP.P('<iframe src="dwu.upload.main?prm_alternativo='||PRM_ALTERNATIVO||'" style="width: 100%; height: 50px; display: block;"></iframe>');
END UPLOAD;

PROCEDURE DOWNLOAD IS
  L_NOME  VARCHAR2(255);
BEGIN
    
  L_NOME := SUBSTR(OWA_UTIL.GET_CGI_ENV('PATH_INFO'), 2);
  WPG_DOCLOAD.DOWNLOAD_FILE(L_NOME);
EXCEPTION
  WHEN OTHERS THEN
    HTP.HTMLOPEN;
    HTP.HEADOPEN;
    HTP.TITLE(FUN.LANG('Arquivo Carregado.'));
    HTP.HEADCLOSE;
    HTP.BODYOPEN;
    HTP.HEADER(1, 'STATUS');
    HTP.PRINT('Carregado ' || L_NOME || ' ERRO.');
    HTP.PRINT(SQLERRM);
    HTP.BODYCLOSE;
    HTP.HTMLCLOSE;
END DOWNLOAD;

PROCEDURE DOWNLOAD ( ARQUIVO  IN  VARCHAR2 ) AS
  L_BLOB_CONTENT  TAB_DOCUMENTOS.BLOB_CONTENT%TYPE;
  L_MIME_TYPE     TAB_DOCUMENTOS.MIME_TYPE%TYPE;

  N_NAME          VARCHAR2(4000);
  WS_USUARIO      VARCHAR2(80);
  WS_NUM          NUMBER;
  

BEGIN

	
    
    

    
  	SELECT /*+ cardinality(1) */ BLOB_CONTENT,
        MIME_TYPE,
		NAME
  	INTO   L_BLOB_CONTENT,
        L_MIME_TYPE,
		N_NAME
  	FROM TAB_DOCUMENTOS
  	WHERE NAME = ARQUIVO AND (USUARIO = 'DWU' OR USUARIO = 'SYS');

  	OWA_UTIL.MIME_HEADER(L_MIME_TYPE, FALSE);
  	HTP.P('Content-Length: ' || DBMS_LOB.GETLENGTH(L_BLOB_CONTENT));
  	HTP.P('Content-Disposition: attachment; filename="'||N_NAME||'"');
  	OWA_UTIL.HTTP_HEADER_CLOSE;

  	WPG_DOCLOAD.DOWNLOAD_FILE(L_BLOB_CONTENT);
EXCEPTION
	WHEN OTHERS THEN
		HTP.HTMLOPEN;
		HTP.HEADOPEN;
		HTP.TITLE('ARQUIVO');
		HTP.HEADCLOSE;
		HTP.BODYOPEN;
		HTP.HEADER(1, 'ERRO');
		HTP.PRINT(SQLERRM);
		HTP.BODYCLOSE;
		HTP.HTMLCLOSE;
END DOWNLOAD;

PROCEDURE DOWNLOADOPEN ( ARQUIVO  IN  VARCHAR2 ) AS
  
	L_BLOB_CONTENT  TAB_DOCUMENTOS.BLOB_CONTENT%TYPE;
	L_MIME_TYPE     TAB_DOCUMENTOS.MIME_TYPE%TYPE;

	N_NAME          VARCHAR2(4000);
	WS_USUARIO      VARCHAR2(80);
	ws_imglogin	  varchar2(100);
  	ws_logocount	  number;

BEGIN

	

	CASE ARQUIVO
		
		WHEN 'css' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			WHERE NAME = 'default-min.css' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');
		
		WHEN 'js' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			WHERE NAME = 'default-min.js' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');
		
		WHEN 'tema' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			WHERE NAME = 'ideativo.css' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');
		
		WHEN 'logo' THEN
			select count(*) into ws_logocount from TAB_DOCUMENTOS where NAME = 'loginup.webp' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');
			
			if ws_logocount > 0 then
				ws_imglogin :='loginup.webp';
			else
				ws_imglogin:= 'bg.webp';
			end if;

				SELECT BLOB_CONTENT,
					MIME_TYPE,
					NAME
				INTO   L_BLOB_CONTENT,
					L_MIME_TYPE,
					N_NAME
				FROM TAB_DOCUMENTOS
				
				WHERE NAME = ws_imglogin AND (USUARIO = 'DWU' OR USUARIO = 'SYS');			


		WHEN 'unlock' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			WHERE NAME = 'unlock.svg' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');

		WHEN 'sinchronize' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			WHERE NAME = 'sinchronize.png' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');

		WHEN 'background' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			
			WHERE NAME = 'fundo_login.webp' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');

		WHEN 'manifest' THEN
			SELECT BLOB_CONTENT,
				MIME_TYPE,
				NAME
			INTO   L_BLOB_CONTENT,
				L_MIME_TYPE,
				N_NAME
			FROM TAB_DOCUMENTOS
			WHERE NAME = 'manifest.json' AND (USUARIO = 'DWU' OR USUARIO = 'SYS');

	END CASE;

	OWA_UTIL.MIME_HEADER(L_MIME_TYPE, FALSE);
  	HTP.P('Content-Length: ' || DBMS_LOB.GETLENGTH(L_BLOB_CONTENT));
  	HTP.P('Content-Disposition: attachment; filename="'||N_NAME||'"');
  	OWA_UTIL.HTTP_HEADER_CLOSE;

  	WPG_DOCLOAD.DOWNLOAD_FILE(L_BLOB_CONTENT);
EXCEPTION
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END DOWNLOADOPEN;

PROCEDURE DOWNLOAD_TAB (  PRM_ARQUIVO     VARCHAR2 DEFAULT NULL,
                          PRM_ALTERNATIVO VARCHAR2 DEFAULT NULL ) AS
  
L_BLOB_CONTENT  TAB_DOCUMENTOS.BLOB_CONTENT%TYPE;
L_MIME_TYPE     TAB_DOCUMENTOS.MIME_TYPE%TYPE;

  N_NAME          VARCHAR2(4000);

BEGIN
  SELECT BLOB_CONTENT,
         MIME_TYPE,
		 NAME
  INTO   L_BLOB_CONTENT,
         L_MIME_TYPE,
		 N_NAME
  FROM   TAB_DOCUMENTOS
  WHERE  NAME = PRM_ARQUIVO AND (USUARIO = NVL(PRM_ALTERNATIVO, GBL.GETUSUARIO) OR USUARIO = 'DWU') AND ROWNUM = 1;


  OWA_UTIL.MIME_HEADER(L_MIME_TYPE, FALSE);
  HTP.P('Content-Length: ' || DBMS_LOB.GETLENGTH(L_BLOB_CONTENT));
  HTP.P('Content-Disposition: attachment; filename="'||N_NAME||'"');
  OWA_UTIL.HTTP_HEADER_CLOSE;

  WPG_DOCLOAD.DOWNLOAD_FILE(L_BLOB_CONTENT);
EXCEPTION
  WHEN OTHERS THEN
    HTP.HTMLOPEN;
    HTP.HEADOPEN;
    HTP.TITLE('ARQUIVO');
    HTP.HEADCLOSE;
    HTP.BODYOPEN;
    HTP.HEADER(1, 'ERRO');
    HTP.PRINT(SQLERRM);
    HTP.BODYCLOSE;
    HTP.HTMLCLOSE;
END DOWNLOAD_TAB;

PROCEDURE UPLOADED ( PRM_CHAVE VARCHAR2 DEFAULT NULL ) AS

  WS_USUARIO VARCHAR2(80);
  WS_ADMIN   VARCHAR2(80);
  WS_SIZE    VARCHAR2(200);

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

    





    HTP.P('<table class="linha">');

		IF WS_ADMIN = 'A' THEN
			HTP.P('<thead>');
				HTP.P('<tr>');
					HTP.P('<th>USU&Aacute;RIO</th>');
					HTP.P('<th>NOME</th>');
					HTP.P('<th>TAMANHO</th>');
					HTP.P('<th></th>');
				HTP.P('</tr>');
			HTP.P('</thead>');
			HTP.P('<tbody id="ajax">');
		    FOR I IN (SELECT NAME, DOC_SIZE, USUARIO FROM TAB_DOCUMENTOS WHERE USUARIO NOT LIKE ('CHAMADO%') ORDER BY USUARIO ASC, NAME DESC) LOOP

				IF (I.NAME = 'default.js' OR I.NAME = 'default.css' OR I.NAME = 'default-min.js' OR I.NAME = 'default-min.css') THEN
				    HTP.P('<tr style="display: none;">');
				ELSE
				    HTP.P('<tr>'); 
				END IF;

				HTP.P('<td><a >'||I.USUARIO||'</a></td>');

				HTP.P('<td><a class="link" href="dwu.fcl.download_tab?prm_arquivo='||I.NAME||'&prm_alternativo='||PRM_CHAVE||'">'||I.NAME||'</a></td>');

				WS_SIZE := TO_CHAR(I.DOC_SIZE/1024, '9999')||'KB';
				HTP.P('<td>'||WS_SIZE||'</td>');
				HTP.P('<td>');
					FCL.BUTTON_LIXO('remove_image','prm_img|prm_user', I.NAME||'|'||I.USUARIO, PRM_TAG => 'a');
				HTP.P('</td>');
				

               HTP.P('</tr>');

            END LOOP;
		ELSE
			HTP.P('<thead>');
				HTP.P('<tr>');
					HTP.P('<th>NOME</th>');
					HTP.P('<th>TAMANHO</th>');
					HTP.P('<th></th>');
				HTP.P('</tr>');
			HTP.P('</thead>');
			HTP.P('<tbody id="ajax">');
		    FOR I IN (SELECT NAME, DOC_SIZE, USUARIO FROM TAB_DOCUMENTOS WHERE USUARIO <> 'DWU' AND USUARIO <> 'SYS' AND USUARIO = NVL(PRM_CHAVE, WS_USUARIO) ORDER BY NAME DESC) LOOP
				HTP.P('<tr>');
					HTP.P('<td><a class="link" href="dwu.fcl.download_tab?prm_arquivo='||I.NAME||'&prm_alternativo='||PRM_CHAVE||'">'||I.NAME||'</a></td>');
					WS_SIZE := TO_CHAR(I.DOC_SIZE/1024, '9999')||'KB';
					HTP.P('<td>'||WS_SIZE||'</td>');
					HTP.P('<td>');
						FCL.BUTTON_LIXO('remove_image','prm_img|prm_user', I.NAME||'|'||I.USUARIO, PRM_TAG => 'a');
					HTP.P('</td>');
					
                HTP.P('</tr>');
            END LOOP;
		END IF;


		HTP.P('</tbody>');
	HTP.P('</ul>');

END UPLOADED;

PROCEDURE REMOVE_IMAGE ( PRM_IMG VARCHAR2 DEFAULT NULL, PRM_USER VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	DELETE FROM TAB_DOCUMENTOS WHERE NAME = PRM_IMG AND USUARIO = PRM_USER AND ROWNUM = 1;
    INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Arquivo '''||PRM_IMG||''' excluido', GBL.GETUSUARIO, 'EVENTO');
    COMMIT;
	

EXCEPTION WHEN OTHERS THEN

    HTP.P('#error '||FUN.LANG('Imposs&iacute;vel excluir, valor inexistente')||'!');

END REMOVE_IMAGE;

PROCEDURE SAVE_POS_ORG ( PRM_OBJ VARCHAR2 DEFAULT NULL,
                          PRM_POSX VARCHAR2 DEFAULT 50,
                          PRM_POSY VARCHAR2 DEFAULT 50 ) AS

WS_COUNT NUMBER;

BEGIN
  
  SELECT COUNT(*) INTO WS_COUNT FROM GRID_COOR WHERE TRIM(CD_DEPTO) = TRIM(PRM_OBJ);

  IF WS_COUNT = 0 THEN
      INSERT INTO GRID_COOR VALUES(PRM_OBJ, PRM_POSX, PRM_POSY, '065182');
  ELSIF WS_COUNT = 1 THEN
      UPDATE GRID_COOR SET
      POS_X = PRM_POSX,
      POS_Y = PRM_POSY
      WHERE TRIM(CD_DEPTO) = TRIM(PRM_OBJ);
  ELSE
      HTP.P('#alert '||FUN.LANG('Erro, valor duplicado no banco')||'!');
  END IF;

END SAVE_POS_ORG;

PROCEDURE FAVORITOS ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS


BEGIN
    HTP.P('<div class="itens">');
	    HTP.P('<div class="fav-box">');
			HTP.P('<a class="fav closed" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); document.getElementById(''attriblist'').querySelector(''.closer'').click(); call_save(''''); curtain(''enabled''); document.getElementById(''titulo'').innerHTML = ''FAVORITOS''; call(''favoritar'', ''prm_objeto=&prm_nome=&prm_parametros=&prm_screen=''+tela+''&prm_acao=list'').then(function(resposta){document.getElementById(''content'').innerHTML = resposta; });"></a>');
			HTP.P('<h2>'||FUN.LANG('FAVORITOS')||'</h2>');
			HTP.P('<ul class="fav">');
				FOR I IN (SELECT CD_FAVORITO, DS_NOME, PARAMETROS, SCREEN, CD_OBJETO FROM FAVORITOS WHERE USUARIO = GBL.GETUSUARIO AND SCREEN = PRM_SCREEN) LOOP
					HTP.P('<li title="'||I.PARAMETROS||'" onclick="document.getElementById(''fakelist'').classList.remove(''visible''); remover('''||I.CD_OBJETO||'trl''); appendar(''prm_drill=Y&prm_objeto='||I.CD_OBJETO||'&prm_zindex=&prm_posx=''+cursorx+''px&prm_posy=''+cursory+''px&prm_screen='||I.SCREEN||'&prm_parametros='||I.PARAMETROS||''', '''', false); setTimeout(function(){ centerDrill('''||I.CD_OBJETO||'''); }, 200);">');
						
						HTP.P('<a class="button">'||I.DS_NOME||'</a>');
						
					HTP.P('</li>');
				END LOOP;
			HTP.P('</ul>');
		HTP.P('</div>');
	HTP.P('</div>');

	FCL.CLOSER_MENU;

END FAVORITOS;

PROCEDURE DATALIST ( PRM_COLUNA VARCHAR2 DEFAULT NULL,
                     PRM_VISAO VARCHAR2 DEFAULT NULL ) AS

    WS_SQL           VARCHAR2(32767);
    WS_CURSOR        NUMBER;
	WS_DESCRICAO     VARCHAR2(200);
	WS_CODIGO        VARCHAR2(200);
	WS_TABELA        VARCHAR2(200);
	WS_LINHAS        NUMBER;
	WS_SEM 			 VARCHAR2(290);

BEGIN
    
    SELECT CD_LIGACAO INTO WS_SEM FROM MICRO_COLUNA WHERE CD_COLUNA = PRM_COLUNA AND CD_MICRO_VISAO = PRM_VISAO;

	IF WS_SEM <> 'SEM' THEN

		SELECT NDS_TFISICA, NDS_CD_CODIGO, NDS_CD_DESCRICAO INTO WS_TABELA, WS_CODIGO, WS_DESCRICAO FROM CODIGO_DESCRICAO WHERE NDS_TABELA = WS_SEM;

		WS_SQL := 'select '||WS_CODIGO||', '||WS_DESCRICAO||' from '||WS_TABELA||'';

		WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

		BEGIN
	        DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);

			WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

	        LOOP
			    IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
	                EXIT;
	            END IF;
	            DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
				HTP.P('<option value="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_DESCRICAO)||'</option>');
			END LOOP;

	        DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
		    
		    EXCEPTION WHEN OTHERS THEN
		        DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
	    END;

	END IF;
	
END DATALIST;


PROCEDURE UPDATE_FILE ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                        PRM_VALOR VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
    UPDATE OBJETOS
	SET ATRIBUTOS = PRM_VALOR
	WHERE CD_OBJETO = PRM_OBJETO;

END UPDATE_FILE;

PROCEDURE CLONE_SCREEN (PRM_OBJETO VARCHAR2 DEFAULT NULL) AS
	
	WS_USUARIO 		VARCHAR2(80);
	WS_CODIGO 		VARCHAR2(80);
	WS_GRUPO 		VARCHAR2(14);
	WS_NOME 		VARCHAR2(80);
	WS_TIPO 		VARCHAR2(40);
	WS_ATRIBUTO 	VARCHAR2(4000);
	WS_DESCRICAO 	VARCHAR2(2000);
	WS_SUBTITULO 	VARCHAR2(200);
	WS_OWNER		VARCHAR2(10);
	WS_NAVEGADOR	VARCHAR2(100);
	WS_SCREEN		VARCHAR2(60);
	WS_OBJECTID		VARCHAR2(60);
	WS_POSX			VARCHAR2(10);
	WS_POSY			VARCHAR2(10);
	WS_ZINDEX		VARCHAR2(10);
	WS_PORCENTAGEM	VARCHAR2(10);
	WS_COD 			VARCHAR2(80);
	WS_DASH			VARCHAR2(80);
	WS_TELA         VARCHAR2(80);
	WS_BLOCO		VARCHAR2(80);
	WS_DATA			DATE;
	WS_KEY			NUMBER:=0;
	WS_INC			NUMBER:=0;
	WS_CONTAR		NUMBER:=0;
	WS_COUNT		NUMBER;
	WS_FUNCLONE		VARCHAR2 (200);
	WS_DESC			VARCHAR2 (800);


BEGIN

	WS_USUARIO := GBL.GETUSUARIO;
	WS_DATA := SYSDATE;
	WS_TELA := PRM_OBJETO;

	SELECT 'SRC_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
	(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
	TO_CHAR(SYSDATE,'yymmddhhmiss'))||'_CLN' INTO WS_CODIGO FROM DUAL;

	SELECT CD_GRUPO,NM_OBJETO,TP_OBJETO,CD_USUARIO,ATRIBUTOS,DS_OBJETO,SUBTITULO,COD,T2.DS_SCREEN 
	  INTO WS_GRUPO,WS_NOME,WS_TIPO,WS_USUARIO,WS_ATRIBUTO,WS_DESCRICAO,WS_SUBTITULO,WS_COD,WS_DESC 
	  FROM OBJETOS T1
	  LEFT JOIN ALL_SCREENS T2 ON T2.SCREEN = T1.CD_OBJETO
	  WHERE CD_OBJETO = WS_TELA;

	INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) 
	  VALUES (WS_CODIGO, WS_GRUPO, '(c)'||WS_NOME, '', 'SCREEN', WS_USUARIO, '', WS_DATA, '');
	INSERT INTO OBJECT_ATTRIB SELECT 'DWU','DEFAULT','DEFAULT', WS_CODIGO, CD_PROP, VL_DEFAULT FROM OBJECT_PADRAO WHERE TP_OBJETO = 'SCREEN';

	INSERT INTO ALL_SCREENS( OWNER, SCREEN, DESCRICAO,DS_SCREEN, DT_CRIACAO, PUBLICO, TIMER, FLEX_FLOW, URL_FUNDO )VALUES( 'DWU', WS_CODIGO, '(c)'||WS_NOME,WS_DESC,WS_DATA, 'S', 0, 'column',  WS_ATRIBUTO);

	COMMIT;

	FOR T IN (SELECT OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = WS_TELA AND OBJECT_ID NOT IN (SELECT CD_OBJETO FROM OBJETOS WHERE TP_OBJETO IN ('CALL_LIST', 'FLOAT_PAR', 'FLOAT_FILTER')))

		LOOP
			WS_CONTAR:=WS_CONTAR+1;

			SELECT 'SECTION_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
			(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
			TO_CHAR(SYSDATE,'yymmddhhmiss'))||WS_CONTAR||'_CLN' INTO WS_DASH FROM DUAL;

			INSERT INTO OBJECT_LOCATION (OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM) VALUES (T.OWNER,T.NAVEGADOR,WS_CODIGO,WS_DASH,T.POSX,T.POSY,T.ZINDEX,T.PORCENTAGEM);
			
			COMMIT;

			FOR B IN (SELECT OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = T.OBJECT_ID)
				LOOP
					WS_CONTAR:=WS_CONTAR+1;

					SELECT 'ARTICLE_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
					(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
					TO_CHAR(SYSDATE,'yymmddhhmiss'))||WS_CONTAR||'_CLN' INTO WS_BLOCO FROM DUAL;
					
					INSERT INTO OBJECT_LOCATION (OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM) VALUES (B.OWNER,B.NAVEGADOR,WS_DASH,WS_BLOCO,B.POSX,B.POSY,B.ZINDEX,B.PORCENTAGEM);
					COMMIT;
					
					FOR O IN (SELECT OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = B.OBJECT_ID)
						LOOP
							WS_CONTAR:=WS_CONTAR+1;
							WS_FUNCLONE := FCL.CLONE_OBJECT(O.OBJECT_ID,WS_CONTAR);
							
							IF WS_FUNCLONE <> 'FAIL' THEN

								INSERT INTO OBJECT_LOCATION (OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM) VALUES (O.OWNER,O.NAVEGADOR,WS_BLOCO,WS_FUNCLONE,O.POSX,O.POSY,O.ZINDEX,O.PORCENTAGEM);						
								COMMIT;
							ELSE

								HTP.P('Erro ao clonar objeto.');

							END IF;

						END LOOP;

				END LOOP;

		END LOOP;
		
		FOR M IN (SELECT OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = WS_TELA AND OBJECT_ID IN (SELECT CD_OBJETO FROM OBJETOS WHERE TP_OBJETO IN ('CALL_LIST')))
			LOOP
				WS_CONTAR:=WS_CONTAR+1;
				WS_FUNCLONE := FCL.CLONE_OBJECT(M.OBJECT_ID,WS_CONTAR);

				IF WS_FUNCLONE <> 'FAIL' THEN

					INSERT INTO OBJECT_LOCATION (OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM) VALUES (M.OWNER,M.NAVEGADOR,WS_CODIGO,WS_FUNCLONE,M.POSX,M.POSY,M.ZINDEX,M.PORCENTAGEM);						
					COMMIT;

				ELSE

					HTP.P('Erro ao clonar objeto.');

				END IF;
	
			END LOOP;

		FOR F IN (SELECT OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = WS_TELA AND OBJECT_ID IN (SELECT CD_OBJETO FROM OBJETOS WHERE TP_OBJETO IN ('FLOAT_PAR', 'FLOAT_FILTER')))
			LOOP
				WS_CONTAR:=WS_CONTAR+1;
				WS_FUNCLONE := FCL.CLONE_OBJECT(F.OBJECT_ID,WS_CONTAR);

				IF WS_FUNCLONE <> 'FAIL' THEN

					INSERT INTO OBJECT_LOCATION (OWNER,NAVEGADOR,SCREEN,OBJECT_ID,POSX,POSY,ZINDEX,PORCENTAGEM) VALUES (F.OWNER,F.NAVEGADOR,WS_CODIGO,F.OBJECT_ID,F.POSX,F.POSY,F.ZINDEX,F.PORCENTAGEM);						
					COMMIT;

				ELSE

					HTP.P('Erro ao clonar objeto.');

				END IF;

			END LOOP;

		HTP.P('Tela Clonada: '||WS_CODIGO||' Section: '||WS_DASH||' Article: '||WS_BLOCO);

EXCEPTION	WHEN OTHERS THEN

	ROLLBACK;
	HTP.P('Erro ao tentar clonar o objeto.');
	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CLONE_OBJECT', WS_USUARIO, 'ERRO');
	COMMIT;

END CLONE_SCREEN;

FUNCTION CLONE_OBJECT (PRM_OBJETO 	VARCHAR2 DEFAULT NULL, PRM_CODIGO NUMBER DEFAULT NULL) RETURN VARCHAR2 AS
	
	
	WS_USUARIO 		VARCHAR2(80);
	WS_CODIGO 		VARCHAR2(80);
	WS_GRUPO 		VARCHAR2(14);
	WS_NOME 		VARCHAR2(80);
	WS_TIPO 		VARCHAR2(40);
	WS_ATRIBUTO 	VARCHAR2(4000);
	WS_DESCRICAO 	VARCHAR2(2000);
	WS_SUBTITULO 	VARCHAR2(200);
	WS_COD 			VARCHAR2(80);
	WS_DATA			DATE;
	WS_KEY			NUMBER:=0;
	WS_INC			NUMBER:=0;
	WS_COUNT		NUMBER;

BEGIN


	WS_USUARIO := GBL.GETUSUARIO;
	WS_DATA := SYSDATE;
	


	
	SELECT 'OBJ_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
	(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
	TO_CHAR(SYSDATE,'yymmddhhmiss'))||PRM_CODIGO||'_CLN' INTO WS_CODIGO FROM DUAL;

		
		SELECT CD_GRUPO,NM_OBJETO,TP_OBJETO,CD_USUARIO,ATRIBUTOS,DS_OBJETO,SUBTITULO,COD INTO WS_GRUPO,WS_NOME,WS_TIPO,WS_USUARIO,WS_ATRIBUTO,WS_DESCRICAO,WS_SUBTITULO,WS_COD FROM OBJETOS WHERE CD_OBJETO = PRM_OBJETO;
		
		INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES (WS_CODIGO, WS_GRUPO, '(c)'||WS_NOME, '', WS_TIPO, WS_USUARIO, '', WS_DATA, '');
		COMMIT;
		
		
		FOR I IN (SELECT CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,CD_FILTRO,TP_FILTRO,CD_CRIADO FROM FILTROS WHERE CD_OBJETO = PRM_OBJETO) 
			LOOP

				SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

					LOOP
					
						WS_INC := WS_INC+1;
					
						SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
					
						IF WS_COUNT > 0 THEN

							SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;

						ELSE

							EXIT;

						END IF;

					END LOOP;

				INSERT INTO FILTROS (CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,CD_FILTRO,TP_FILTRO,CD_CRIADO) VALUES (WS_USUARIO,WS_CODIGO,I.MICRO_VISAO,I.CD_COLUNA,I.CONDICAO,I.CONTEUDO,I.LIGACAO,I.ST_AGRUPADO,WS_KEY,I.TP_FILTRO,I.CD_CRIADO);
				COMMIT;

			END LOOP;

		
		WS_INC:=0;	
		FOR I IN (SELECT CD_USUARIO,CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE,CD_DESTAQUE FROM DESTAQUE WHERE CD_OBJETO = PRM_OBJETO) 
			LOOP

				SELECT NVL2(MAX(CD_DESTAQUE), MAX(CD_DESTAQUE), 0)+1 INTO WS_KEY FROM DESTAQUE;

					LOOP

						WS_INC := WS_INC+1;

						SELECT COUNT(*) INTO WS_COUNT FROM DESTAQUE WHERE CD_DESTAQUE = WS_KEY;

						IF WS_COUNT > 0 THEN

							SELECT WS_KEY+WS_INC INTO WS_KEY FROM DESTAQUE;

						ELSE

							EXIT;

						END IF;

					END LOOP;

				INSERT INTO DESTAQUE (CD_USUARIO,CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE,CD_DESTAQUE) VALUES	(WS_USUARIO,WS_CODIGO,I.CD_COLUNA,I.CONDICAO,I.CONTEUDO,I.COR_FUNDO,I.COR_FONTE,I.TIPO_DESTAQUE,I.PRIORIDADE,WS_KEY);
				COMMIT;

			END LOOP;

		
		INSERT INTO OBJECT_ATTRIB (SELECT OWNER,NAVEGADOR,SCREEN,WS_CODIGO,CD_PROP,PROPRIEDADE FROM OBJECT_ATTRIB WHERE CD_OBJECT = PRM_OBJETO );
		COMMIT;

		
		INSERT INTO GOTO_OBJETO (SELECT WS_USUARIO,WS_CODIGO,CD_OBJETO_GO,ORDEM FROM GOTO_OBJETO WHERE CD_OBJETO = PRM_OBJETO);
		COMMIT;		

		
		INSERT INTO PONTO_AVALIACAO (SELECT WS_CODIGO,NM_PONTO,DS_PONTO,AR_DIARIO,AR_MENSAL,AR_ANUAL,CD_VISAO,TP_RENOVACAO,CD_USUARIO,WS_DATA,WS_DATA,CD_MICRO_VISAO,PARAMETROS,ST_FILTROS,NULL,CS_PARAMETROS,CS_COLUNA,CS_AGRUPADOR,CS_RP,CS_COLUP FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_OBJETO);		
		COMMIT;

		
		INSERT INTO OBJECT_RESTRICTION (SELECT WS_USUARIO,WS_CODIGO,ST_RESTRICAO,WS_DATA FROM OBJECT_RESTRICTION WHERE CD_OBJETO = PRM_OBJETO);
		COMMIT;

		
		FOR M IN (SELECT CD_LIST,CD_OBJETO,POSX,POSY,ORDEM FROM CALL_LIST WHERE CD_LIST = PRM_OBJETO) 
			LOOP

				INSERT INTO CALL_LIST (CD_LIST,CD_OBJETO,POSX,POSY,ORDEM) VALUES (WS_CODIGO,M.CD_OBJETO,M.POSX,M.POSY,M.ORDEM);
				COMMIT;

			END LOOP;

		INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE,'Objeto clonado com sucesso. - CLONE_OBJECT', WS_USUARIO, 'EVENTO');
		COMMIT;
		RETURN WS_CODIGO;

EXCEPTION	WHEN OTHERS THEN

	ROLLBACK;
	RETURN 'FAIL';
	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CLONE_OBJECT', WS_USUARIO, 'ERRO');
	COMMIT;

END CLONE_OBJECT;

PROCEDURE QUICK_CREATE ( PRM_NOME       VARCHAR2 DEFAULT NULL,
                         PRM_TIPO       VARCHAR2 DEFAULT NULL,
                         PRM_PARAMETROS VARCHAR2 DEFAULT NULL,
                         PRM_VISAO      VARCHAR2 DEFAULT NULL,
                         PRM_COLUNA     VARCHAR2 DEFAULT NULL,
						 PRM_GRUPO      VARCHAR2 DEFAULT NULL,
						 PRM_OBJ_ANT    VARCHAR2 DEFAULT NULL,
                         PRM_FILTRO     VARCHAR2 DEFAULT NULL
 ) AS

	WS_CODIGO          VARCHAR2(40);
	WS_PARAMETRO       VARCHAR2(2000);
	WS_VALOR           VARCHAR2(2000);
	WS_NOME            VARCHAR2(80);
	WS_FILTRO_COLUNA   VARCHAR2(80);
	WS_FILTRO_CONTEUDO VARCHAR2(80);
	WS_USUARIO         VARCHAR2(80);
	WS_GRUPO		   VARCHAR2(80);
	WS_COUNT           NUMBER;
	WS_EXCEPTION       EXCEPTION;
	WS_KEY             NUMBER := 0;
	WS_INC             NUMBER := 0;

	WS_EXIST 		   EXCEPTION;
	

BEGIN
    

	WS_USUARIO := GBL.GETUSUARIO;

	SELECT 'OBJ_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
	(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||
	TO_CHAR(SYSDATE,'yymmddhhmiss')) INTO WS_CODIGO FROM DUAL;

	SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE CD_OBJETO = WS_CODIGO;

	

	IF WS_COUNT = 0 THEN
		
		IF PRM_TIPO = 'OBJETO' THEN
		
			INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) VALUES (WS_CODIGO, '', PRM_NOME, '', 'OBJETO', WS_USUARIO, '', SYSDATE, '');
			HTP.P(WS_CODIGO);
		
		ELSE
		
			WS_PARAMETRO := SUBSTR(PRM_PARAMETROS, 1, INSTR(PRM_PARAMETROS, '@')-1);
			WS_VALOR := REPLACE(PRM_PARAMETROS, WS_PARAMETRO||'@', '');

			WS_VALOR := REPLACE(WS_VALOR, '1|1', '');

			WS_NOME := FUN.CONVERTE(PRM_NOME);

			IF NVL(GBL.GETNIVEL, 'N') <> 'A' THEN
				WS_CODIGO := REPLACE(WS_USUARIO, '.', '_')||'_temp';
				WS_NOME := FUN.CHECK_ROTULOC(WS_PARAMETRO, PRM_VISAO)||'/'||FUN.CHECK_ROTULOC(PRM_COLUNA, PRM_VISAO);
			END IF;

			IF PRM_TIPO = 'PONTEIRO' OR PRM_TIPO = 'VALOR' THEN
				INSERT INTO PONTO_AVALIACAO VALUES
				(WS_CODIGO, TRIM(WS_NOME), '', 'N', 'N', 'N', 'T', 'O', 'DWU', SYSDATE, SYSDATE, PRM_VISAO, WS_PARAMETRO||'|', 'A', '', '', '', '', '', '' );
			ELSE 
				INSERT INTO PONTO_AVALIACAO VALUES
				(WS_CODIGO, TRIM(WS_NOME), '', 'N', 'N', 'N', 'T', 'O', 'DWU', SYSDATE, SYSDATE, PRM_VISAO, '', 'A', '', '1|1', PRM_COLUNA, WS_PARAMETRO, '', '' );
			END IF;

			FOR ARROW IN(SELECT CD_COLUNA, CD_CONTEUDO, CD_CONDICAO FROM TABLE(FUN.VPIPE_PAR(WS_VALOR))) LOOP
			
					SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

					LOOP
					
						WS_INC := WS_INC+1;
					
						SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
					
						IF WS_COUNT > 0 THEN
							SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
						ELSE
							EXIT;
						END IF;
					END LOOP;
			
					INSERT INTO FILTROS VALUES('DWU', WS_CODIGO, PRM_VISAO, ARROW.CD_COLUNA, ARROW.CD_CONDICAO, ARROW.CD_CONTEUDO, 'and', 'N', WS_KEY, 'objeto', WS_USUARIO);
					COMMIT;
			END LOOP;
			
			FOR I IN(SELECT CD_COLUNA, CD_CONTEUDO, CD_CONDICAO FROM TABLE(FUN.VPIPE_PAR(PRM_FILTRO))) LOOP
			
					SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

					LOOP
					
						WS_INC := WS_INC+1;
					
						SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
					
						IF WS_COUNT > 0 THEN
							SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
						ELSE
							EXIT;
						END IF;
					END LOOP;
			
					INSERT INTO FILTROS VALUES('DWU', WS_CODIGO, PRM_VISAO, I.CD_COLUNA, I.CD_CONDICAO, I.CD_CONTEUDO, 'and', 'N', WS_KEY, 'objeto', WS_USUARIO);
					COMMIT;
			END LOOP;

			BEGIN
				INSERT INTO OBJETOS (CD_OBJETO, CD_GRUPO, NM_OBJETO, SUBTITULO, TP_OBJETO, CD_USUARIO, ATRIBUTOS, DT_ULTIMA, DS_OBJETO) 
				VALUES 
					(WS_CODIGO, PRM_GRUPO, WS_NOME, '', PRM_TIPO, WS_USUARIO, '', SYSDATE, '');
			EXCEPTION WHEN OTHERS THEN
				RAISE WS_EXIST;
			END;

			INSERT INTO OBJECT_ATTRIB SELECT 'DWU','DEFAULT','DEFAULT', WS_CODIGO, CD_PROP, VL_DEFAULT FROM OBJECT_PADRAO WHERE TP_OBJETO = PRM_TIPO;

			IF PRM_TIPO = 'TEXTO' THEN
				UPDATE OBJETOS SET ATRIBUTOS = 'TEXTO' WHERE CD_OBJETO = WS_CODIGO AND NM_OBJETO = 'TEXTO' AND TP_OBJETO = 'TEXTO';
			END IF;

			INSERT INTO TRADUCAO_COLUNAS VALUES(WS_CODIGO, 'NM_OBJETO', FUN.RET_VAR('LANG_SYS'), WS_NOME, WS_NOME, 'O', 'N');
			
			WS_KEY := 0;
			WS_INC := 0;
			
			FOR I IN (SELECT CD_USUARIO, CD_OBJETO, MICRO_VISAO, CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO, ST_AGRUPADO FROM FILTROS WHERE CD_OBJETO = REPLACE(PRM_OBJ_ANT, 'trl', '') AND TP_FILTRO = 'objeto') LOOP
				
				SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

				LOOP
				
					WS_INC := WS_INC+1;
				
					SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
				
					IF WS_COUNT > 0 THEN
						SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
					ELSE
						EXIT;
					END IF;
				END LOOP;
				
				INSERT INTO FILTROS VALUES(I.CD_USUARIO, WS_CODIGO, I.MICRO_VISAO, I.CD_COLUNA, I.CONDICAO, I.CONTEUDO, I.LIGACAO, I.ST_AGRUPADO, WS_KEY, 'objeto', WS_USUARIO);
				COMMIT;
			END LOOP;
			
			WS_KEY := 0;
			WS_INC := 0;
			
			FOR Z IN (SELECT CD_COLUNA, CD_CONTEUDO, CD_CONDICAO FROM TABLE(FUN.VPIPE_PAR((PRM_FILTRO))) WHERE NVL(TRIM(CD_CONDICAO), 'N/A') <> 'N/A') LOOP
				
				SELECT NVL2(MAX(CD_FILTRO), MAX(CD_FILTRO), 0)+1 INTO WS_KEY FROM FILTROS;

				LOOP
				
					WS_INC := WS_INC+1;
				
					SELECT COUNT(*) INTO WS_COUNT FROM FILTROS WHERE CD_FILTRO = WS_KEY;
				
					IF WS_COUNT > 0 THEN
						SELECT WS_KEY+WS_INC INTO WS_KEY FROM FILTROS;
					ELSE
						EXIT;
					END IF;
				END LOOP;
				
				INSERT INTO FILTROS VALUES('DWU', WS_CODIGO, PRM_VISAO, Z.CD_COLUNA, Z.CD_CONDICAO, Z.CD_CONTEUDO, 'and', 'N', WS_KEY, 'objeto', WS_USUARIO);
				COMMIT;
			END LOOP;
			HTP.P(WS_CODIGO);
			COMMIT;
		END IF;
	ELSE
		HTP.P('NONE');
	END IF;

EXCEPTION 
	WHEN WS_EXIST THEN
		HTP.P('duplicado');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END QUICK_CREATE;

PROCEDURE CHANGE_BAR ( PRM_OBJ       VARCHAR2 DEFAULT NULL,
                       PRM_AGRUPADOR VARCHAR2 DEFAULT NULL,
					   PRM_TIPO      VARCHAR2 DEFAULT 'objeto' ) AS

	WS_AGRUPADOR VARCHAR2(2000);

BEGIN
    
    WS_AGRUPADOR := SUBSTR(PRM_AGRUPADOR, 0, LENGTH(PRM_AGRUPADOR)-1);
	IF LENGTH(WS_AGRUPADOR) > 1 THEN
		IF PRM_TIPO = 'objeto' THEN
			UPDATE PONTO_AVALIACAO
			SET CS_AGRUPADOR = WS_AGRUPADOR
			WHERE CD_PONTO = PRM_OBJ;
		ELSE
		    UPDATE PONTO_AVALIACAO
			SET PARAMETROS = PRM_AGRUPADOR
			WHERE CD_PONTO = PRM_OBJ;
		END IF;
	ELSE
	    HTP.P('#alert '||FUN.LANG('Ao menos uma coluna deve ser escolhida')||'!');
	END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('#alert '||FUN.LANG('Erro ao alterar os dados')||'!');
END CHANGE_BAR;

PROCEDURE COUNTDOWN ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

  WS_SCREEN NUMBER;

BEGIN
    SELECT TIMER INTO WS_SCREEN FROM ALL_SCREENS WHERE SCREEN = PRM_SCREEN;
    HTP.P(TRIM(WS_SCREEN));

END COUNTDOWN;


procedure background_attrib_monta ( prm_screen  in     varchar2 default null,
                                    prm_valores in out varchar2  ) as  
    ws_valores varchar2(800);
    ws_fundo   varchar2(200);
	ws_background varchar2(800);
begin
    SELECT FUN.SUBPAR(URL_FUNDO, PRM_SCREEN) INTO WS_FUNDO FROM ALL_SCREENS WHERE SCREEN = PRM_SCREEN;
	
	IF INSTR(WS_FUNDO, 'EXT') > 0 THEN
	    WS_VALORES := WS_FUNDO;
	ELSE
		SELECT 'background-repeat: '||NVL(FUN.GETPROP(PRM_SCREEN,'REPEAT'), 'no-repeat')||'; background-position: '||NVL(FUN.GETPROP(PRM_SCREEN,'IMG_POS'), 'center')||'; background-size: '||NVL(FUN.GETPROP(PRM_SCREEN,'IMG_SIZE'), 'auto')||'; background-color: '||NVL(COR_FUNDO, 'transparent')||'; background-image: url('||FUN.SUBPAR(URL_FUNDO, PRM_SCREEN)||'); '
		INTO WS_VALORES FROM ALL_SCREENS WHERE SCREEN = PRM_SCREEN;
	END IF;

	prm_valores := nvl(ws_valores,'');

end background_attrib_monta;


PROCEDURE BACKGROUND_ATTRIB ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS
    WS_VALORES VARCHAR2(800);
BEGIN

	background_attrib_monta ( prm_screen, ws_valores ) ;
    htp.p(trim(nvl(ws_valores,' ')) );

END BACKGROUND_ATTRIB;
 

/*** Alterado para chamar a background_attrib_MONTA   
PROCEDURE BACKGROUND_ATTRIB ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

    WS_VALORES VARCHAR2(800);
    WS_FUNDO   VARCHAR2(200);
BEGIN

    SELECT FUN.SUBPAR(URL_FUNDO, PRM_SCREEN) INTO WS_FUNDO FROM ALL_SCREENS WHERE SCREEN = PRM_SCREEN;
	
	IF INSTR(WS_FUNDO, 'EXT') > 0 THEN
	    WS_VALORES := WS_FUNDO;
	ELSE
		SELECT 'background-repeat: '||NVL(FUN.GETPROP(PRM_SCREEN,'REPEAT'), 'no-repeat')||'; background-position: '||NVL(FUN.GETPROP(PRM_SCREEN,'IMG_POS'), 'center')||'; background-size: '||NVL(FUN.GETPROP(PRM_SCREEN,'IMG_SIZE'), 'auto')||'; background-color: '||NVL(COR_FUNDO, 'transparent')||'; background-image: url('||FUN.SUBPAR(URL_FUNDO, PRM_SCREEN)||'); '
		INTO WS_VALORES FROM ALL_SCREENS WHERE SCREEN = PRM_SCREEN;
	END IF;
	
    HTP.P(TRIM(WS_VALORES));

END BACKGROUND_ATTRIB;
******/ 



PROCEDURE UPDATE_LANGUAGE ( PRM_VALOR       VARCHAR2 DEFAULT NULL,
                            PRM_TABELA      VARCHAR2 DEFAULT NULL,
                            PRM_COLUNA      VARCHAR2 DEFAULT NULL,
                            PRM_LINGUAGEM   VARCHAR2 DEFAULT NULL,
                            PRM_DEFAULT     VARCHAR2 DEFAULT NULL,
                            PRM_TIPO        VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT         NUMBER;
    WS_DEFAULT       VARCHAR2(4000);
    WS_ERRO          EXCEPTION;

BEGIN

    
    WS_DEFAULT := PRM_DEFAULT;

    BEGIN
          SELECT COUNT(*) INTO WS_COUNT
          FROM   TRADUCAO_COLUNAS
          WHERE  CD_TABELA    = PRM_TABELA AND
                 CD_COLUNA    = PRM_COLUNA AND
                 CD_LINGUAGEM = PRM_LINGUAGEM AND
                 TIPO         = PRM_TIPO AND
                 LANG_DEFAULT = WS_DEFAULT;

          IF  WS_COUNT = 1 THEN
              UPDATE TRADUCAO_COLUNAS SET TEXTO = PRM_VALOR
              WHERE  CD_TABELA    = UPPER(PRM_TABELA) AND
                     CD_COLUNA    = UPPER(PRM_COLUNA) AND
                     CD_LINGUAGEM = PRM_LINGUAGEM  AND
                     TIPO         = PRM_TIPO AND
                     LANG_DEFAULT = WS_DEFAULT;
          ELSE
              IF  WS_COUNT = 0 THEN
                  INSERT INTO TRADUCAO_COLUNAS VALUES (UPPER(PRM_TABELA), UPPER(PRM_COLUNA), PRM_LINGUAGEM, PRM_VALOR, WS_DEFAULT, PRM_TIPO, 'N');
              ELSE
                  RAISE WS_ERRO;
              END IF;
         END IF;

		  IF  PRM_LINGUAGEM = FUN.RET_VAR('LANG_SYS') THEN
              WS_DEFAULT := PRM_VALOR;
			  UPDATE TRADUCAO_COLUNAS SET LANG_DEFAULT = PRM_VALOR
              WHERE  CD_TABELA    = PRM_TABELA AND
                  CD_COLUNA    = PRM_COLUNA AND
                  TIPO         = PRM_TIPO AND
                  LANG_DEFAULT = PRM_DEFAULT;
			   IF PRM_TIPO = 'T' THEN
			       UPDATE MICRO_VISAO SET DS_MICRO_VISAO = PRM_VALOR
                   WHERE  DS_MICRO_VISAO = WS_DEFAULT;
			  END IF;
			  IF PRM_TIPO = 'O' THEN
			      IF PRM_COLUNA = 'ATRIBUTOS' THEN
			          UPDATE OBJETOS SET ATRIBUTOS = PRM_VALOR
                      WHERE  CD_OBJETO = PRM_TABELA;
				  ELSIF PRM_COLUNA = 'SUBTITULO' THEN
				      UPDATE OBJETOS SET SUBTITULO = PRM_VALOR
                      WHERE  CD_OBJETO = PRM_TABELA;
				  ELSE
				      UPDATE OBJETOS SET NM_OBJETO = PRM_VALOR
                      WHERE  CD_OBJETO = PRM_TABELA;
					  UPDATE PONTO_AVALIACAO SET NM_PONTO = PRM_VALOR
                      WHERE  CD_PONTO = PRM_TABELA;
				  END IF;
			  END IF;
			  IF PRM_TABELA = 'PARAMETRO_PADRAO' THEN
			      UPDATE PARAMETRO_PADRAO SET NM_PADRAO = PRM_VALOR
                  WHERE NM_PADRAO = PRM_DEFAULT;
			  END IF;
			  IF PRM_TABELA = 'GRUPOS_FUNCAO' THEN
			      UPDATE GRUPOS_FUNCAO SET NM_GRUPO = PRM_VALOR
                  WHERE NM_GRUPO = PRM_DEFAULT;
			  END IF;
			  IF PRM_TABELA = 'GUSERS' AND PRM_COLUNA = 'NM_GROUP' THEN
			      UPDATE GUSERS SET NM_GROUP = PRM_VALOR
                  WHERE NM_GROUP = PRM_DEFAULT;
			  END IF;
			  IF PRM_TABELA = 'NOTIFY_ME' AND PRM_COLUNA = 'DS_NOTIFY' THEN
			      UPDATE NOTIFY_ME SET DS_NOTIFY = PRM_VALOR
                  WHERE DS_NOTIFY = PRM_DEFAULT;
			  END IF;
			  IF PRM_TABELA = 'ALL_SCREENS' AND PRM_COLUNA = 'DESCRICAO' THEN
			      UPDATE ALL_SCREENS SET DESCRICAO = PRM_VALOR
                  WHERE DESCRICAO = PRM_DEFAULT;
			  END IF;
          END IF;

         COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            HTP.P('!alert '||FUN.LANG('Erro ao alterar/incluir tradu&ccedil;&atilde;o')||'!');
    END;

END UPDATE_LANGUAGE;

PROCEDURE SCREEN_LIST ( PRM_OBJETO VARCHAR2 DEFAULT 'N/A' ) AS

    WS_COUNT	  NUMBER		:= 0;
	WS_COUNT1	  NUMBER		:= 0;
	WS_COUNT2	  NUMBER		:= 0;
	WS_CGRUPO	  NUMBER		:= 0;
	WS_CITEM	  NUMBER		:= 1;
	WS_GRUPO_ANT  VARCHAR2(40)	:= 'FIRST_TIME';

    CURSOR CRS_ITENS(PRM_USUARIO VARCHAR2) IS
		SELECT	CD_OBJETO, OBJETOS.CD_GRUPO, NM_GRUPO, NM_OBJETO, NVL(COR_FUNDO,'#FFFFFF') COR_FUNDO, URL_FUNDO, DISPOSITIVO
		FROM	OBJETOS, ALL_SCREENS, GRUPOS_FUNCAO
		WHERE	TP_OBJETO='SCREEN'  AND
			ALL_SCREENS.PUBLICO='S' AND
		        CD_OBJETO=SCREEN(+) AND 
		        OBJETOS.CD_GRUPO=GRUPOS_FUNCAO.CD_GRUPO AND
		        SCREEN IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = PRM_USUARIO AND STATUS='A')
		ORDER BY GRUPOS_FUNCAO.ORDEM, OR_GRUPO, CD_GRUPO, TO_NUMBER(OR_ITEM), NM_OBJETO;

	WS_ITENS	CRS_ITENS%ROWTYPE;
	WS_USUARIO  VARCHAR2(80);
	WS_ADMIN    VARCHAR2(80);
	WS_PADRAO   VARCHAR2(80) := 'PORTUGUESE';
BEGIN

    WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;

    
    HTP.P('<option value="X" style="font-weight: bold; color: #000;" selected>MENU</option>');
	OPEN CRS_ITENS(WS_USUARIO);
	    LOOP
	        FETCH CRS_ITENS INTO WS_ITENS;
	        EXIT WHEN CRS_ITENS%NOTFOUND;

	        IF ((INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') > 0 OR INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') > 0) AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'desktop' AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'nenhum') OR ((INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') = 0 AND INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') = 0) AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'mobile' AND NVL(WS_ITENS.DISPOSITIVO, '0') <> 'nenhum') OR WS_ADMIN = 'A' THEN

				IF (WS_GRUPO_ANT <> WS_ITENS.CD_GRUPO OR WS_GRUPO_ANT='FIRST_TIME') THEN
					WS_CGRUPO := WS_CGRUPO + 1;
				WS_CITEM  := 1;
				HTP.P('<optgroup label="'||WS_CGRUPO||'-'||FUN.UTRANSLATE('nm_grupo', WS_ITENS.CD_GRUPO, WS_ITENS.NM_GRUPO, WS_PADRAO)||'"></optgroup>');
				END IF;

				SELECT (SELECT COUNT(*) FROM OBJECT_LOCATION WHERE SCREEN = WS_ITENS.CD_OBJETO AND OBJECT_ID = UPPER(PRM_OBJETO)) AS WS_COUNT1, (SELECT COUNT(*) FROM CALL_LIST WHERE CD_OBJETO = UPPER(PRM_OBJETO) AND CD_LIST IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = WS_ITENS.CD_OBJETO)) AS WS_COUNT2 INTO WS_COUNT1, WS_COUNT2 FROM DUAL;
				WS_COUNT := WS_COUNT1+WS_COUNT2;
				IF WS_COUNT > 0 THEN
					HTP.P('<option class="green" data-bg="'||WS_ITENS.COR_FUNDO||'" data-url="'||WS_ITENS.URL_FUNDO||'" data-size="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_SIZE')||'" data-pos="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_POS')||'" data-repeat="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'REPEAT')||'" onclick="this.className=''''; " value="'||WS_ITENS.CD_OBJETO||'">    '||WS_CGRUPO||'.'||TO_CHAR(WS_CITEM,'00')||'-'||FUN.UTRANSLATE('NM_OBJETO', WS_ITENS.CD_OBJETO, WS_ITENS.NM_OBJETO, WS_PADRAO)||'</option>');
				ELSE
					HTP.P('<option data-bg="'||WS_ITENS.COR_FUNDO||'" data-url="'||WS_ITENS.URL_FUNDO||'" data-size="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_SIZE')||'" data-pos="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'IMG_POS')||'" data-repeat="'||FUN.GETPROP(WS_ITENS.CD_OBJETO,'REPEAT')||'" value="'||WS_ITENS.CD_OBJETO||'">    '||WS_CGRUPO||'.'||TO_CHAR(WS_CITEM,'00')||'-'||FUN.UTRANSLATE('NM_OBJETO', WS_ITENS.CD_OBJETO, WS_ITENS.NM_OBJETO, WS_PADRAO)||'</option>');
				END IF;

			END IF;

	        WS_GRUPO_ANT := WS_ITENS.CD_GRUPO;
			WS_CITEM := WS_CITEM + 1;
	    END LOOP;
	CLOSE CRS_ITENS;

    IF WS_ADMIN = 'A' AND OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT') NOT LIKE '%Trident%' THEN
		HTP.P('<option value="SANDBOX" style="font-weight: bold; color: #065182; display: none;" data-bg="#efefdf">SANDBOX</option>');
	END IF;

END SCREEN_LIST;


PROCEDURE LINGUAGEM_PADRAO ( PRM_UPDATE CHAR DEFAULT 'N',
                             PRM_TABELA VARCHAR2 DEFAULT NULL,
							 PRM_COLUNA VARCHAR2 DEFAULT NULL,
							 PRM_LINGUAGEM VARCHAR2 DEFAULT NULL,
							 PRM_DEFAULT VARCHAR2 DEFAULT NULL,
                             PRM_FIXA CHAR DEFAULT NULL ) AS

    CURSOR CRS_PADROES IS
	SELECT CD_TABELA, CD_COLUNA, CD_LINGUAGEM, TEXTO, LANG_DEFAULT, TIPO, FIXA
	FROM TRADUCAO_COLUNAS
	WHERE CD_LINGUAGEM = FUN.RET_VAR('LANG_SYS')
	ORDER BY TIPO, CD_TABELA, CD_COLUNA, TEXTO;

	WS_LANG    VARCHAR2(60);
    WS_PADRAO  CRS_PADROES%ROWTYPE;
	WS_TIPO    VARCHAR2(30) := '999999999';
	WS_COUNT   NUMBER;
	WS_USUARIO VARCHAR2(80);

BEGIN
    WS_USUARIO := GBL.GETUSUARIO;
    
    SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_USUARIO WHERE CD_USUARIO = WS_USUARIO AND CD_PADRAO='CD_LINGUAGEM';

    IF WS_COUNT = 1 THEN
		SELECT CONTEUDO INTO WS_LANG
		FROM   PARAMETRO_USUARIO
		WHERE  CD_USUARIO = WS_USUARIO AND
		CD_PADRAO='CD_LINGUAGEM';
	ELSE
	    WS_LANG := 'PORTUGUESE';
	END IF;

    IF PRM_UPDATE = 'N' THEN
		HTP.P('<table class="linha" style="min-width: 600px; margin: 0 auto;">');
		   HTP.P('<thead>');
		   HTP.P('<tr>');
		       HTP.P('<th style="width: 55%;">DEFAULT</th>');
			   HTP.P('<th style="width: 10%;">'||FUN.LANG('TIPO')||'</th>');
			   HTP.P('<th style="width: 35%;"></th>');
		   HTP.P('</tr>');
		   HTP.P('</thead>');
		   HTP.P('<tbody>');
		OPEN CRS_PADROES;
			LOOP
				FETCH CRS_PADROES INTO WS_PADRAO;
				EXIT WHEN CRS_PADROES%NOTFOUND;
				IF WS_PADRAO.TIPO = 'C' THEN
				    WS_TIPO := FUN.LANG('Coluna');
				ELSIF WS_PADRAO.TIPO = 'O' THEN
				    WS_TIPO := FUN.LANG('Objeto');
				ELSIF WS_PADRAO.TIPO = 'T' THEN
				    WS_TIPO := FUN.LANG('Tabela');
				ELSE
				    WS_TIPO := '';
				END IF;

				HTP.P('<tr style="margin: 5px 0; line-height: 30px;">');
				    HTP.P('<td style="width: 55%; white-space: nowrap;">'||WS_PADRAO.LANG_DEFAULT||'</td>');
					HTP.P('<td style="width: 10%">'||WS_TIPO||'</td>');
					HTP.P('<td style="width: 35%;">');
					    HTP.P('<input type="text" value="'||FUN.UTRANSLATE(WS_PADRAO.CD_COLUNA, WS_PADRAO.CD_TABELA, WS_PADRAO.LANG_DEFAULT, WS_LANG)||'"/>');
					    HTP.P('<a title="'||FUN.LANG('Alterar')||'" style="line-height: 14px; height: 18px; width: 14px; position: relative; display: inline-block; float: none;" class="save" onclick="checkFix(''input'', this, '''||WS_PADRAO.CD_TABELA||''', '''||WS_PADRAO.CD_COLUNA||''', '''||WS_LANG||''', '''||WS_PADRAO.LANG_DEFAULT||''', '''||WS_PADRAO.TIPO||''');">v</a>');
					    IF WS_PADRAO.FIXA = 'S' THEN
					        HTP.P('<input title="'||FUN.LANG('Fixar')||'" onchange="checkFix(''check'', this, '''||WS_PADRAO.CD_TABELA||''', '''||WS_PADRAO.CD_COLUNA||''', '''||WS_LANG||''', '''||WS_PADRAO.LANG_DEFAULT||''', '''||WS_PADRAO.TIPO||''');" type="checkbox" checked/>');
					    ELSE
					        HTP.P('<input title="'||FUN.LANG('Fixar')||'" onchange="checkFix(''check'', this, '''||WS_PADRAO.CD_TABELA||''', '''||WS_PADRAO.CD_COLUNA||''', '''||WS_LANG||''', '''||WS_PADRAO.LANG_DEFAULT||''', '''||WS_PADRAO.TIPO||''');" type="checkbox" />');
						END IF;
					HTP.P('</td>');
				HTP.P('</tr>');
			END LOOP;
		CLOSE CRS_PADROES;
		HTP.P('</tbody>');
		HTP.P('</table>');
	ELSE
	    UPDATE TRADUCAO_COLUNAS SET FIXA = PRM_FIXA
        WHERE  CD_TABELA    = UPPER(PRM_TABELA) AND
        CD_COLUNA    = UPPER(PRM_COLUNA) AND
        CD_LINGUAGEM = PRM_LINGUAGEM  AND
        LANG_DEFAULT = PRM_DEFAULT;
		HTP.P('#alert '||FUN.LANG('Tradu&ccedil;&atilde;o fixada')||'!');
	END IF;

END LINGUAGEM_PADRAO;

PROCEDURE PASS_LANG AS

   CURSOR CRS_SEQ IS
                      SELECT CD_TABELA, CD_COLUNA, TIPO
                      FROM   TRADUCOES_PASSIVAS
                      ORDER BY TIPO;

        WS_SEQ     CRS_SEQ%ROWTYPE;

        V_SQL         VARCHAR2(32767);
        V_CURSOR      NUMBER;
        WS_CODIGO     VARCHAR2(4000);
        WS_TEXTO      VARCHAR2(4000);
        WS_STEXTO     VARCHAR2(4000);
        WS_OBJETO     VARCHAR2(4000);

        DUMMY         NUMBER;
        V_RET         NUMBER;
        WS_CHECK_PT   NUMBER;
        WS_CHECK_IT   NUMBER;
        WS_CHECK_EN   NUMBER;
        WS_CHECK_ES   NUMBER;
        WS_CHECK_GE   NUMBER;

        WS_CONVERSAO  VARCHAR2(4000);

BEGIN
    
    OPEN CRS_SEQ;
    LOOP
        FETCH CRS_SEQ INTO WS_SEQ;
        EXIT WHEN CRS_SEQ%NOTFOUND;

	    IF  WS_SEQ.TIPO IN ('O') THEN
		    V_SQL := 'select cd_objeto, '||WS_SEQ.CD_COLUNA||' from OBJETOS where nvl(trim('||WS_SEQ.CD_COLUNA||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||CHR(39)||'%NOREG%'||CHR(39);
	    END IF;

	    IF  WS_SEQ.TIPO IN ('T','F') THEN
		    V_SQL := 'select 0 as dado, '||WS_SEQ.CD_COLUNA||' from '||WS_SEQ.CD_TABELA||' where nvl(trim('||WS_SEQ.CD_COLUNA||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||CHR(39)||'%NOREG%'||CHR(39);
	    END IF;

	    IF  WS_SEQ.TIPO IN ('C') THEN
		    V_SQL := 'select cd_micro_visao as dado, '||WS_SEQ.CD_COLUNA||' from MICRO_COLUNA where nvl(trim('||WS_SEQ.CD_COLUNA||'),'||CHR(39)||'%NOREG%'||CHR(39)||')<>'||CHR(39)||'%NOREG%'||CHR(39);
	    END IF;

	    V_CURSOR := DBMS_SQL.OPEN_CURSOR;
	    DBMS_SQL.PARSE(V_CURSOR, V_SQL, DBMS_SQL.NATIVE);
	    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,1,WS_CODIGO, 4000);
	    DBMS_SQL.DEFINE_COLUMN(V_CURSOR,2,WS_TEXTO,  4000);

	    DUMMY := DBMS_SQL.EXECUTE(V_CURSOR);
            LOOP
                V_RET := DBMS_SQL.FETCH_ROWS(V_CURSOR);
                    EXIT WHEN V_RET = 0;
                    DBMS_SQL.COLUMN_VALUE(V_CURSOR,1,WS_CODIGO);
                    DBMS_SQL.COLUMN_VALUE(V_CURSOR,2,WS_TEXTO);

                    WS_STEXTO := TRIM(REPLACE(TRIM(CONVERT(REPLACE(REPLACE(REPLACE(REPLACE(WS_TEXTO,'&Atilde;','A'),'&aacute;','a'),'&oacute;','o'),'&Oacute;','O'), 'US7ASCII', 'WE8ISO8859P1')),' ','+'));

                    SELECT NVL(SUM(DECODE(CD_LINGUAGEM,'PORTUGUESE',1,DECODE(FIXA,'S',1,0))),0),
                           NVL(SUM(DECODE(CD_LINGUAGEM,'ENGLISH',   1,DECODE(FIXA,'S',1,0))),0),
                           NVL(SUM(DECODE(CD_LINGUAGEM,'SPANISH',   1,DECODE(FIXA,'S',1,0))),0),
                           NVL(SUM(DECODE(CD_LINGUAGEM,'ITALIAN',   1,DECODE(FIXA,'S',1,0))),0),
                           NVL(SUM(DECODE(CD_LINGUAGEM,'GERMAN',    1,DECODE(FIXA,'S',1,0))),0)
                           INTO WS_CHECK_PT,
                                WS_CHECK_EN,
                                WS_CHECK_ES,
                                WS_CHECK_IT,
                                WS_CHECK_GE
                    FROM   TRADUCAO_COLUNAS
                    WHERE  CD_TABELA    = WS_SEQ.CD_TABELA AND
                           CD_COLUNA    = WS_SEQ.CD_COLUNA AND
                           LANG_DEFAULT = WS_TEXTO         AND
                           TIPO         = WS_SEQ.TIPO;

                    IF  WS_SEQ.TIPO IN ('O','C') THEN
                        WS_OBJETO := WS_CODIGO;
                    ELSE
                        WS_OBJETO := WS_SEQ.CD_TABELA;
                    END IF;

                    IF  WS_CHECK_PT = 0 THEN
                        INSERT INTO TRADUCAO_COLUNAS VALUES (WS_OBJETO,WS_SEQ.CD_COLUNA,'PORTUGUESE', WS_TEXTO, WS_TEXTO,WS_SEQ.TIPO,'N');
                    END IF;
                    IF  WS_CHECK_EN = 0 THEN
                        INSERT INTO TRADUCAO_COLUNAS VALUES (WS_OBJETO,WS_SEQ.CD_COLUNA,'ENGLISH', FUN.GET_TRANSLATOR(WS_STEXTO,'pt','en'),WS_TEXTO,WS_SEQ.TIPO,'N');
                    END IF;
                    IF  WS_CHECK_ES = 0 THEN
                        INSERT INTO TRADUCAO_COLUNAS VALUES (WS_OBJETO,WS_SEQ.CD_COLUNA,'SPANISH', FUN.GET_TRANSLATOR(WS_STEXTO,'pt','es'),WS_TEXTO,WS_SEQ.TIPO,'N');
                    END IF;
                    IF  WS_CHECK_IT = 0 THEN
                        INSERT INTO TRADUCAO_COLUNAS VALUES (WS_OBJETO,WS_SEQ.CD_COLUNA,'ITALIAN', FUN.GET_TRANSLATOR(WS_STEXTO,'pt','it'),WS_TEXTO,WS_SEQ.TIPO,'N');
                    END IF;
                    IF  WS_CHECK_GE = 0 THEN
                        INSERT INTO TRADUCAO_COLUNAS VALUES (WS_OBJETO,WS_SEQ.CD_COLUNA,'GERMAN', FUN.GET_TRANSLATOR(WS_STEXTO,'pt','de'),WS_TEXTO,WS_SEQ.TIPO,'N');
                    END IF;

                    COMMIT;

            END LOOP;
            DBMS_SQL.CLOSE_CURSOR(V_CURSOR);

        END LOOP;
    CLOSE CRS_SEQ;

END PASS_LANG;

PROCEDURE CLEARLOG ( PRM_PROGRAMA VARCHAR2 DEFAULT 'JS' ) AS

BEGIN
    
    IF UPPER(PRM_PROGRAMA) = 'JS' THEN
	  DELETE FROM LOG_EVENTOS WHERE TIPO = 'ERRO' AND PROGRAMA = 'JS';
	END IF;
	IF UPPER(PRM_PROGRAMA) = 'EL' THEN
	  DELETE FROM LOG_EVENTOS WHERE TIPO = 'ERRORLINE';
	END IF;
	IF UPPER(PRM_PROGRAMA) = 'PAR' THEN
	  DELETE FROM LOG_EVENTOS WHERE TIPO = 'PARAMETRO';
	END IF;
END CLEARLOG;

PROCEDURE PROCESSOS ( PRM_COMPLETO VARCHAR2 DEFAULT 'N' ) AS

    CURSOR CRS_PROCESSOS IS
	SELECT SID, SERIAL#, USERNAME AS USUARIO, SECONDS_IN_WAIT AS ESPERA, PROGRAM AS APLICACAO, EVENT AS DESCRICAO_EVENTO, TO_CHAR(LOGON_TIME,'DD/MM/YY HH:MI') AS HORARIO_CONEXAO,
	NVL((SELECT MAX(SQL_TEXT) FROM V$SQL WHERE V$SESSION.SQL_ADDRESS = V$SQL.ADDRESS),'SEM SQL') AS COMANDO_SQL, STATUS, MACHINE AS MAQUINA
	FROM V$SESSION
	WHERE (V$SESSION.USERNAME = 'DWU' OR  PROGRAM = FUN.RET_VAR('PROGRAM') OR (V$SESSION.USERNAME = 'ANONYMOUS' AND 
	EVENT <> 'virtual circuit wait' AND EVENT <> 'virtual circuit next request'
	)) AND
	AUDSID <> USERENV('SESSIONID');

	WS_PROCESSO CRS_PROCESSOS%ROWTYPE;

	WS_USUARIO  VARCHAR2(80);
	WS_NOACCESS EXCEPTION;

BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACCESS;
	END IF;

    IF PRM_COMPLETO = 'S' THEN
		HTP.P('<table class="linha">');
			HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th><img class="recarregar-tela" title="Refresh" src="'||FUN.R_GIF('sinchronize','png')||'" onclick="ajax(''list'', ''processos'', ''prm_completo=N'', true, ''processos'');"/></th>');
				HTP.P('<th>SID</th>');
				HTP.P('<th>SERIAL</th>');
				HTP.P('<th>USER</th>');
				HTP.P('<th>'||FUN.LANG('TEMPO')||'</th>');
				HTP.P('<th>'||FUN.LANG('EVENTO')||'</th>');
				HTP.P('<th>'||FUN.LANG('M&Aacute;QUINA')||'</th>');
				HTP.P('<th>'||FUN.LANG('APLICA&Ccedil;&Atilde;O')||'</th>');
			HTP.P('</tr>');
			HTP.P('</thead>');
			HTP.P('<tbody id="processos">');
	END IF;

	OPEN CRS_PROCESSOS;
	    LOOP
		    FETCH CRS_PROCESSOS INTO WS_PROCESSO;
			EXIT WHEN CRS_PROCESSOS%NOTFOUND;
			    HTP.P('<tr title="'||WS_PROCESSO.COMANDO_SQL||'">');
				    IF WS_PROCESSO.STATUS = 'INACTIVE' THEN
					    HTP.P('<td><a onclick="if(confirm(''Derrubar o processo?'')){ ajax(''fly'', ''kill'', ''prm_sid='||WS_PROCESSO.SID||'&prm_serial='||WS_PROCESSO.SERIAL#||''', false); noerror(this, '''||FUN.LANG('Processo adicionado ao job para ser derrubado')||'!'', ''msg''); }" class="dot"></a></td>');
					ELSE
					    HTP.P('<td><a onclick="if(confirm(''Derrubar o processo?'')){ ajax(''fly'', ''kill'', ''prm_sid='||WS_PROCESSO.SID||'&prm_serial='||WS_PROCESSO.SERIAL#||''', false); noerror(this, '''||FUN.LANG('Processo adicionado ao job para ser derrubado')||'!'', ''msg''); }" class="dot active"></a></td>');
					END IF;
					HTP.P('<td>'||WS_PROCESSO.SID||'</td>');
					HTP.P('<td>'||WS_PROCESSO.SERIAL#||'</td>');
					HTP.P('<td>'||WS_PROCESSO.USUARIO||'</td>');
					HTP.P('<td>'||WS_PROCESSO.ESPERA||'</td>');
					HTP.P('<td>'||HTF.ESCAPE_SC(WS_PROCESSO.DESCRICAO_EVENTO)||'</td>');
					HTP.P('<td>'||WS_PROCESSO.MAQUINA||'</td>');
					HTP.P('<td>'||WS_PROCESSO.APLICACAO||'</td>');
				HTP.P('</tr>');
		END LOOP;
	CLOSE CRS_PROCESSOS;
	
	IF PRM_COMPLETO = 'S' THEN
		HTP.P('</tbody>');
		HTP.P('</table>');
	END IF;

EXCEPTION 
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END PROCESSOS;

PROCEDURE KILL ( PRM_SID VARCHAR2 DEFAULT NULL,
                 PRM_SERIAL VARCHAR2 DEFAULT NULL ) AS

    WS_COMANDO      VARCHAR2(2000);
    JOB_ID          NUMBER;
    WS_OWNER        VARCHAR2(90);
    WS_NAME         VARCHAR2(90);
    WS_LINE         NUMBER;
    WS_CALLER       VARCHAR2(90);

BEGIN
    

    IF GBL.GETNIVEL = 'A' THEN
    
	    OWA_UTIL.WHO_CALLED_ME(WS_OWNER, WS_NAME, WS_LINE, WS_CALLER);

	    BEGIN
		    WS_COMANDO := 'alter system kill session '||CHR(39)||PRM_SID||','||PRM_SERIAL||CHR(39)||'';
            FUN.EXECUTE_NOW(WS_COMANDO);
	    EXCEPTION WHEN OTHERS THEN
	        HTP.P(SQLERRM);
	    END;

	END IF;

END KILL;

PROCEDURE ACESSOS ( PRM_COMPLETO VARCHAR2 DEFAULT 'N' ) AS

    CURSOR CRS_ACESSOS IS
	   
	   SELECT COD AS ID, VALOR AS USUARIO, DECODE(SHOW_ONLY, 'S', TO_CHAR(DT_ACESSO-7, 'DD/MM/YY HH24:MI'), TO_CHAR(DT_ACESSO-0.5, 'DD/MM/YY HH24:MI')) AS ENTROU, 
	   TO_CHAR(DT_ACESSO, 'DD/MM/YY HH24:MI') AS DATA, 
	   DECODE(decode(sign(instr(cod, 'ANONYMOUS')), 1, 'E', SHOW_ONLY), 'A', 'Admin', 'S', 'Slideshow', 'E', 'Email', 'Normal') AS PERMISSAO
	   FROM BI_SESSAO
	   LEFT JOIN USUARIOS ON USU_NOME = VALOR
	   WHERE
	   DT_ACESSO > SYSDATE
	   ORDER BY VALOR DESC;

	   WS_ACESSO CRS_ACESSOS%ROWTYPE;

	   WS_USUARIO VARCHAR2(80);

	   WS_NOACESS EXCEPTION;

BEGIN
    
	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACESS;
	END IF;
    
	IF PRM_COMPLETO = 'S' THEN
		HTP.P('<table class="linha">');
			HTP.P('<thead>');
				HTP.P('<tr>');
					
					HTP.P('<th>'||FUN.LANG('USU&Aacute;RIO')||'</th>');
					HTP.P('<th>'||FUN.LANG('TIPO')||'</th>');
					HTP.P('<th>'||FUN.LANG('ENTROU')||'</th>');
					HTP.P('<th>'||FUN.LANG('SESS&Atilde;O EXPIRA')||'</th>');
					HTP.P('<th></th>');
				HTP.P('</tr>');
			HTP.P('</thead>');
			HTP.P('<tbody id="acessos">');
	END IF;

	OPEN CRS_ACESSOS;
		LOOP
			FETCH CRS_ACESSOS INTO WS_ACESSO;
			EXIT WHEN CRS_ACESSOS%NOTFOUND;
				HTP.P('<tr title="'||WS_ACESSO.ID||'">');
					
					HTP.P('<td>'||WS_ACESSO.USUARIO||'</td>');
					HTP.P('<td>'||WS_ACESSO.PERMISSAO||'</td>');
					HTP.P('<td>'||WS_ACESSO.ENTROU||'</td>');
					HTP.P('<td>'||WS_ACESSO.DATA||'</td>');
					HTP.P('<td>');
						FCL.BUTTON_LIXO('xlogout','prm_sessao', WS_ACESSO.ID, PRM_TAG => 'a');
					HTP.P('<td>');
				HTP.P('</tr>');
		END LOOP;
	CLOSE CRS_ACESSOS;

    IF PRM_COMPLETO = 'S' THEN
		HTP.P('</tbody>');
		HTP.P('</table>');
	END IF;
	
EXCEPTION 
	WHEN WS_NOACESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END ACESSOS;

PROCEDURE LOGS AS

    CURSOR CRS_LOGS IS
	   SELECT * FROM(
	       SELECT DT_LOG, DS_LOG, NM_USUARIO, NM_PROCEDURE
	       FROM BI_LOG_SISTEMA
		   WHERE NM_PROCEDURE = 'EVENTO'
	       ORDER BY DT_LOG DESC
	   ) WHERE ROWNUM < 30;
	   WS_LOG CRS_LOGS%ROWTYPE;

	   WS_EVENTO   VARCHAR2(800);
	   WS_USUARIO  VARCHAR2(80);
	   WS_NOACCESS EXCEPTION;
BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' THEN
		RAISE WS_NOACCESS;
	END IF;

	WS_EVENTO := 'onclick="var dir = order(''notsame'', ''ajax''); ajax(''list'', ''logs_lista'', ''prm_tipo=''+document.getElementById(''log-tipo'').value+''&prm_usuario=''+document.getElementById(''log-usuario'').value+''&prm_linha=''+document.getElementById(''log-linha'').value+''&prm_order=''+this.title+''&prm_dir=''+dir, false, ''ajax'');"';

    HTP.P('<table class="linha">');
        
		HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th><a title="1" class="red" '||WS_EVENTO||'>'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</a></th>');
				HTP.P('<th><a title="3" class="red" '||WS_EVENTO||'>'||FUN.LANG('USU&Aacute;RIO')||'</a></th>');
				HTP.P('<th><a title="2" class="red" '||WS_EVENTO||'>DATA</a></th>');
				
				
			HTP.P('</tr>');
		HTP.P('</thead>');
		
		HTP.P('<tbody id="ajax" data-dir="1">');
			OPEN CRS_LOGS;
				LOOP
					FETCH CRS_LOGS INTO WS_LOG;
					EXIT WHEN CRS_LOGS%NOTFOUND;
						HTP.P('<tr>');
							HTP.P('<td title="'||REPLACE(WS_LOG.DS_LOG, '"', '')||'" style="max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'||REPLACE(WS_LOG.DS_LOG, '"', '')||'</td>');
							HTP.P('<td>'||WS_LOG.NM_USUARIO||'</td>');
							HTP.P('<td>'||TO_CHAR(WS_LOG.DT_LOG, 'DD/MM/YY HH24:MI')||'</td>');
							
						HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_LOGS;
	    HTP.P('</tbody>');
	HTP.P('</table>');

EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END LOGS;

PROCEDURE LOGS_LISTA ( PRM_TIPO VARCHAR2 DEFAULT NULL,
                       PRM_USUARIO VARCHAR2 DEFAULT NULL,
                       PRM_LINHA NUMBER DEFAULT 30,
					   PRM_ORDER VARCHAR2 DEFAULT '2',
					   PRM_DIR VARCHAR2 DEFAULT '2') AS

    CURSOR CRS_LOGS IS
	   SELECT DT_LOG, DS_LOG, NM_USUARIO, NM_PROCEDURE FROM (
	        SELECT DT_LOG, DS_LOG, NM_USUARIO, NM_PROCEDURE
	        	FROM BI_LOG_SISTEMA
	        WHERE NM_USUARIO = NVL(TRIM(PRM_USUARIO), NM_USUARIO) 
				AND
				DECODE(NM_PROCEDURE, 'EVENTO', 'EVENTO', 'ERRO', 'ERRO','SESSAO','SESSAO', 'OUTROS') = NVL(TRIM(PRM_TIPO), NM_PROCEDURE)
		    ORDER BY
		    	CASE WHEN PRM_DIR = '1' THEN DECODE(PRM_ORDER, '1', DS_LOG, '2', TO_CHAR(DT_LOG, 'YYMMDDHH24MI'), '3', NM_USUARIO, '4', NM_PROCEDURE, TO_CHAR(DT_LOG, 'YYMMDDHH24MI')) END ASC,
		    	CASE WHEN PRM_DIR = '2' THEN DECODE(PRM_ORDER, '1', DS_LOG, '2', TO_CHAR(DT_LOG, 'YYMMDDHH24MI'), '3', NM_USUARIO, '4', NM_PROCEDURE, TO_CHAR(DT_LOG, 'YYMMDDHH24MI')) END DESC
	   ) WHERE ROWNUM < NVL(PRM_LINHA, 30)+1;
	   WS_LOG CRS_LOGS%ROWTYPE;

BEGIN
    
    OPEN CRS_LOGS;
	LOOP
		FETCH CRS_LOGS INTO WS_LOG;
		EXIT WHEN CRS_LOGS%NOTFOUND;
			HTP.P('<tr>');
				HTP.P('<td title="'||REPLACE(WS_LOG.DS_LOG, '"', '')||'" style="max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'||REPLACE(WS_LOG.DS_LOG, '"', '')||'</td>');
				HTP.P('<td>'||WS_LOG.NM_USUARIO||'</td>');
				HTP.P('<td>'||TO_CHAR(WS_LOG.DT_LOG, 'DD/MM/YY HH24:MI')||'</td>');
				
			HTP.P('</tr>');
		END LOOP;
	CLOSE CRS_LOGS;

END LOGS_LISTA;

PROCEDURE XSEND_MAIL (  PRM_SENDER       IN VARCHAR2,
                        PRM_RECIPIENT    IN VARCHAR2,
                        PRM_SUBJECT      IN VARCHAR2,
                        PRM_MESSAGE      IN VARCHAR2,
						Prm_erro_envio in out Varchar2 ) AS

    MAIL_CONN      UTL_SMTP.CONNECTION;
    CRLF           VARCHAR2(2)  := CHR(13) || CHR(10);
    WS_MESG        CLOB;

    WS_SENDER      VARCHAR2(40);
    WS_RECIPIENT   VARCHAR2(40);
    WS_TITLE       VARCHAR2(120);
    L_BOUNDARY     VARCHAR2(50) := '----=*#abc1234321cba#*=';

BEGIN
	
	Prm_erro_envio := null; 

	xsend_mail_upquery('999|'||trim(prm_recipient)||'|'||trim(prm_subject)||'|'||trim(prm_message), prm_erro_envio ); 

	/*** Alterado para sempre enviar email com a XSEND_MAIL_UPQUERY 
	if nvl(trim(upper(fun.ret_var('CORREIO_USER'))),'N/A')  IN  ('N/A','DWU@UPQUERY.COM') then 
		xsend_mail_upquery('999|'||trim(prm_recipient)||'|'||trim(prm_subject)||'|'||trim(prm_message), prm_erro_envio ); 
	else

		IF LENGTH(TRIM(FUN.RET_VAR('CORREIO_TITLE'))) > 0 THEN
			WS_TITLE := TRIM(FUN.RET_VAR('CORREIO_TITLE'));
		ELSE
			WS_TITLE := 'Upquery msg';
		END IF;

		BEGIN
			WS_SENDER    := TRIM(PRM_SENDER);
			WS_RECIPIENT := TRIM(PRM_RECIPIENT);

			MAIL_CONN := UTL_SMTP.OPEN_CONNECTION(TRIM(FUN.RET_VAR('CORREIO')), TRIM(FUN.RET_VAR('CORREIO_PORT')));
			UTL_SMTP.HELO(MAIL_CONN, TRIM(FUN.RET_VAR('CORREIO')));

			UTL_SMTP.COMMAND( MAIL_CONN, 'AUTH LOGIN');
			UTL_SMTP.COMMAND( MAIL_CONN, UTL_RAW.CAST_TO_VARCHAR2( UTL_ENCODE.BASE64_ENCODE( UTL_RAW.CAST_TO_RAW(TRIM(FUN.RET_VAR('CORREIO_USER'))))) );
			UTL_SMTP.COMMAND( MAIL_CONN, UTL_RAW.CAST_TO_VARCHAR2( UTL_ENCODE.BASE64_ENCODE( UTL_RAW.CAST_TO_RAW(TRIM(FUN.RET_VAR('CORREIO_PASS'))))) );

			WS_MESG:= 'Date: ' || TO_CHAR( SYSDATE, 'dd Mon yy hh24:mi:ss' ) || CRLF ||  'From: '||WS_TITLE||' <'||TRIM(FUN.RET_VAR('CORREIO_USER'))||'>'||CRLF ||  'Subject: '||PRM_SUBJECT || CRLF ||  'To: <'||WS_RECIPIENT||'>'||
						'MIME-Version: 1.0'||CRLF
						||'Content-Type: multipart/alternative; boundary="'||L_BOUNDARY ||'"'||CRLF||CRLF
						||'--' ||L_BOUNDARY ||CRLF||'Content-Type: text/html; charset=iso-8859-1"'||CRLF||CRLF
						||PRM_MESSAGE||CRLF||'--' ||L_BOUNDARY|| '--'||CRLF;

			UTL_SMTP.HELO(MAIL_CONN, TRIM(FUN.RET_VAR('CORREIO')));
			UTL_SMTP.MAIL(MAIL_CONN, '<'||TRIM(FUN.RET_VAR('CORREIO_USER'))||'>');
			UTL_SMTP.RCPT(MAIL_CONN, '<'||WS_RECIPIENT||'>');
			UTL_SMTP.DATA(MAIL_CONN, WS_MESG);

			UTL_SMTP.QUIT(MAIL_CONN);
		
		EXCEPTION WHEN OTHERS THEN
			Prm_erro_envio := 'Erro no envio do email, entre em contato com o administrador do sistema para confer&ecirc;ncia das configura&ccedil;&otilde;es de email';
			INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Erro XSEND_MAIL:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE , gbl.getUsuario, 'ERRO');
			commit; 
			FCL.INSERT_POST('','','','DWU','ERRO EMAIL='||WS_RECIPIENT,'1',PRM_SHOW => 'N', PRM_ORIGEM => 'SYS');
		END;
	end if;
	****/ 
EXCEPTION WHEN OTHERS THEN
    Prm_erro_envio := 'Erro no envio do email, entre em contato com o administrador do sistema';
	INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Erro XSEND_MAIL:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE , gbl.getUsuario, 'ERRO');
	COMMIT; 
    --HTP.P(SQLERRM);
END XSEND_MAIL;


----------------------------------------------------------------------------------------------------------
-- Envia o email através da base Upquery utilizando o serviço de email da Upquery.
----------------------------------------------------------------------------------------------------------
Procedure xsend_mail_upquery ( prm_param       in     varchar2,
						  	   Prm_erro_envio  in out Varchar2) as 
ws_command varchar2(32000);
ws_string  varchar2(500);
ws_param   varchar2(32000);
Begin

	Prm_erro_envio := null; 
	ws_string      := null; 
    ws_param       := utl_url.escape(prm_param, true, 'ISO-8859-1'); 
    
	ws_command := 'http://'||fun.ret_var('DOMINIO_REG')||'/update/dwu.beup.xsend_mail_upquery?prm_param='||ws_param;
insert into err_txt values ('ws_command:'||ws_command); 
commit; 
    begin
    	ws_string := utl_http.request(ws_command);
    exception when others then
    	Prm_erro_envio := fun.lang('Erro na chamada de serviço de email, entre em contato com o administrador do sistema');
	    insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - XSEND_MAIL_UPQUERY - 1', gbl.getUsuario, 'ERRO');
    	commit;	
    end;
	if nvl(ws_string,'NA') <> 'NA' then 
	    Prm_erro_envio := fun.lang('Erro na chamada de serviço de email, entre em contato com o administrador do sistema');
		insert into bi_log_sistema values(sysdate, 'XSEND_MAIL_UPQUERY - Erro em utl_http.request <'||ws_string, gbl.getUsuario||'>', 'ERRO');
    	commit;	
	end if; 
exception when others then 
    Prm_erro_envio := fun.lang('Erro na chamada de serviço de email, entre em contato com o administrador do sistema');
    insert into bi_log_sistema values(sysdate, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - XSEND_MAIL_UPQUERY - 2', gbl.getUsuario, 'ERRO');
    commit;	
end xsend_mail_upquery; 









PROCEDURE EDIT_FILTRO ( PRM_KEY NUMBER DEFAULT NULL,
	                    PRM_VALOR VARCHAR2 DEFAULT NULL,
						PRM_TIPO VARCHAR2 DEFAULT NULL) AS

    WS_FAIL     EXCEPTION;
    WS_COUNT    NUMBER;
	WS_CONVERTE VARCHAR2(800);

BEGIN

    WS_CONVERTE  := FUN.CONVERTE(PRM_VALOR);

    BEGIN

        CASE PRM_TIPO
		WHEN 'CONDICAO' THEN
			UPDATE FILTROS
			SET CONDICAO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN 'COLUNA' THEN
			UPDATE FILTROS
			SET CD_COLUNA = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN 'LIGACAO' THEN
			UPDATE FILTROS
			SET LIGACAO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN 'AGRUPADO' THEN
			UPDATE FILTROS
			SET ST_AGRUPADO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN 'CONDICAO-USER' THEN
			UPDATE FILTROS
			SET CONDICAO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN 'COLUNA-USER' THEN
			UPDATE FILTROS
			SET CD_COLUNA = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN  'CONTEUDO-USER' THEN
			UPDATE FILTROS
			SET CONTEUDO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN 'LIGACAO-USER' THEN
			UPDATE FILTROS
			SET LIGACAO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN  'CONTEUDO' THEN
			UPDATE FILTROS
			SET CONTEUDO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		WHEN  'USUARIO' THEN
			UPDATE FILTROS
			SET CD_USUARIO = WS_CONVERTE
			WHERE CD_FILTRO = PRM_KEY
			;
		ELSE
			RAISE WS_FAIL;
		END CASE;

        WS_COUNT := SQL%ROWCOUNT;
        
        IF WS_COUNT <> 0 THEN
            COMMIT;
        ELSE
            RAISE WS_FAIL;
        END IF;

	EXCEPTION 
	    WHEN WS_FAIL THEN
	        HTP.P('FAIL');
	    WHEN OTHERS THEN
	        HTP.P('FAIL');
	END;

END EDIT_FILTRO;

PROCEDURE EDIT_DESTAQUE ( PRM_KEY      NUMBER DEFAULT NULL,
                          PRM_VALOR    VARCHAR2 DEFAULT NULL,
						  PRM_ACAO     VARCHAR2 DEFAULT NULL ) AS

	WS_CONVERTE VARCHAR2(800);

BEGIN

    

    WS_CONVERTE := FUN.CONVERTE(PRM_VALOR);

    BEGIN
		IF PRM_ACAO = 'CONDICAO' THEN
		    UPDATE DESTAQUE
		    SET CONDICAO = WS_CONVERTE
			WHERE CD_DESTAQUE = PRM_KEY;
		ELSIF PRM_ACAO = 'COLUNA' THEN
		    UPDATE DESTAQUE
		    SET CD_COLUNA = WS_CONVERTE
			WHERE CD_DESTAQUE = PRM_KEY;
		ELSIF PRM_ACAO = 'CONTEUDO' THEN
		    UPDATE DESTAQUE
		    SET CONTEUDO = WS_CONVERTE
			WHERE CD_DESTAQUE = PRM_KEY;
		ELSIF PRM_ACAO = 'COR_FUNDO' THEN
		    UPDATE DESTAQUE
		    SET COR_FUNDO = WS_CONVERTE
			WHERE CD_DESTAQUE = PRM_KEY;
        ELSIF PRM_ACAO = 'COR_FONTE' THEN
		    UPDATE DESTAQUE
		    SET COR_FONTE = WS_CONVERTE
			WHERE CD_DESTAQUE = PRM_KEY;
		ELSE
		    UPDATE DESTAQUE
		    SET TIPO_DESTAQUE = WS_CONVERTE
			WHERE CD_DESTAQUE = PRM_KEY;

		END IF;

	EXCEPTION WHEN OTHERS THEN
	    HTP.P(SQLERRM);
	END;

END EDIT_DESTAQUE;

PROCEDURE OBJ_ON_SCREEN ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS


		WS_ROOT VARCHAR2(80);
		WS_COUNT NUMBER;

		PROCEDURE NESTED_REMOVE_OBJ ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
	                                  PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

		BEGIN
            
			HTP.P('<td>');
				FCL.BUTTON_LIXO('dl_obj','prm_cod|prm_tela', PRM_OBJETO||'|'||PRM_SCREEN, PRM_TAG => 'a');
			HTP.P('<td>');
			

		END NESTED_REMOVE_OBJ;

BEGIN
    
    SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OBJECT_ID LIKE 'SECTION_%';

	HTP.P('<table class="linha">');
		HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th>ID</th>');
				HTP.P('<th>'||FUN.LANG('NOME')||'</th>');
				HTP.P('<th>'||FUN.LANG('TIPO')||'</th>');
				HTP.P('<th></th>');
				HTP.P('<th></th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody>');
		    IF WS_COUNT = 0 THEN
				FOR I IN(SELECT T1.OBJECT_ID, (SELECT COD FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS COD, (SELECT NM_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS NOME, (SELECT TP_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS TIPO,(SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO T3 WHERE T3.CD_PONTO = T1.OBJECT_ID) AS VISAO FROM OBJECT_LOCATION T1 WHERE SCREEN = PRM_SCREEN AND OBJECT_ID NOT LIKE ('SECTION_%') ORDER BY TIPO DESC) LOOP
					HTP.P('<tr>');
						HTP.P('<td>'||NVL(I.COD, I.OBJECT_ID)||'</td>');
						HTP.P('<td>'||I.NOME||'</td>');
						HTP.P('<td>'||I.TIPO||'</td>');
						HTP.P('<td><a title="'||FUN.LANG('FILTROS')||'" class="link" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''list_ofiltro'', '''||I.OBJECT_ID||'|'||I.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||I.OBJECT_ID||'&prm_visao='||I.VISAO||'''); curtain(''enabled'');">FILTRO</a></td>');
						
						NESTED_REMOVE_OBJ(I.OBJECT_ID, PRM_SCREEN);

					HTP.P('</tr>');
				END LOOP;
			ELSE
			    FOR A IN(SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = PRM_SCREEN AND OBJECT_ID LIKE 'SECTION_%') LOOP
					FOR B IN(SELECT T1.OBJECT_ID, (SELECT COD FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS COD, (SELECT NM_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS NOME, (SELECT TP_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS TIPO,(SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO T3 WHERE T3.CD_PONTO = T1.OBJECT_ID) AS VISAO, T1.SCREEN FROM OBJECT_LOCATION T1 WHERE T1.SCREEN IN (SELECT OBJECT_ID FROM OBJECT_LOCATION WHERE SCREEN = A.OBJECT_ID) ORDER BY TIPO DESC) LOOP
						HTP.P('<tr>');
							HTP.P('<td>'||NVL(B.COD, B.OBJECT_ID)||'</td>');
							HTP.P('<td>'||B.NOME||'</td>');
							HTP.P('<td>'||B.TIPO||'</td>');
							IF B.TIPO IN ('PIZZA', 'ROSCA', 'CONSULTA', 'BARRAS', 'COLUNAS', 'LINHAS', 'VALOR', 'PONTEIRO', 'MAPA') THEN
							    HTP.P('<td><a title="'||FUN.LANG('FILTROS')||'" class="link" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''list_ofiltro'', '''||B.OBJECT_ID||'|'||B.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||B.OBJECT_ID||'&prm_visao='||B.VISAO||'''); curtain(''enabled'');">FILTRO</a></td>');
							ELSE
							    HTP.P('<td></td>');
							END IF;

							HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||B.OBJECT_ID||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    		HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||B.OBJECT_ID||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			    	
							NESTED_REMOVE_OBJ(B.OBJECT_ID, B.SCREEN);

						HTP.P('</tr>');
					END LOOP;
				END LOOP;
				FOR I IN(SELECT T1.OBJECT_ID, (SELECT COD FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS COD, (SELECT NM_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS NOME, (SELECT TP_OBJETO FROM OBJETOS T2 WHERE T2.CD_OBJETO = T1.OBJECT_ID) AS TIPO,(SELECT CD_MICRO_VISAO FROM PONTO_AVALIACAO T3 WHERE T3.CD_PONTO = T1.OBJECT_ID) AS VISAO FROM OBJECT_LOCATION T1 WHERE SCREEN = PRM_SCREEN AND OBJECT_ID NOT LIKE ('SECTION_%') ORDER BY TIPO DESC) LOOP
					HTP.P('<tr>');
						HTP.P('<td>'||NVL(I.COD, I.OBJECT_ID)||'</td>');
						HTP.P('<td>'||I.NOME||'</td>');
						HTP.P('<td>'||I.TIPO||'</td>');
						IF I.TIPO IN ('PIZZA', 'ROSCA', 'CONSULTA', 'BARRAS', 'COLUNAS', 'LINHAS', 'VALOR', 'PONTEIRO', 'MAPA') THEN
						    HTP.P('<td><a title="'||FUN.LANG('FILTROS')||'" class="link" onclick="titulo(this, ''c''); call_save(''''); carregaPainel(''list_ofiltro'', '''||I.OBJECT_ID||'|'||I.VISAO||'''); carrega(''list_ofiltro?ws_par_sumary='||I.OBJECT_ID||'&prm_visao='||I.VISAO||'''); curtain(''enabled'');">FILTRO</a></td>');
						ELSE
						    HTP.P('<td></td>');
						END IF;

						HTP.P('<td><a class="link" title="'||FUN.LANG('Atributos')||'" onclick="loadAttrib(''av_prop'', ''ws_par_sumary='||I.OBJECT_ID||'&prm_screen='||PRM_SCREEN||''');">'||FUN.LANG('ATRIBUTOS')||'</a></td>');
				    	HTP.P('<td><a class="link" title="'||FUN.LANG('Propriedades')||'" onclick="loadAttrib(''ed_gadg'', ''ws_par_sumary='||I.OBJECT_ID||''');">'||FUN.LANG('PROPRIEDADES')||'</a></td>');
			    	

						NESTED_REMOVE_OBJ(I.OBJECT_ID, PRM_SCREEN);

					HTP.P('</tr>');
				END LOOP;
			END IF;
		HTP.P('</tbody>');
	HTP.P('</table>');

END OBJ_ON_SCREEN;

PROCEDURE CLEAR_SANDBOX AS

BEGIN
    
    
	DELETE FROM FILTROS WHERE CD_OBJETO = 'SANDBOX' AND TP_FILTRO = 'objeto';
	DELETE FROM OBJECT_LOCATION WHERE SCREEN = 'SANDBOX';

END CLEAR_SANDBOX;

PROCEDURE DASHBOARDMOVE ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                          PRM_TARGET VARCHAR2 DEFAULT NULL,
						  PRM_LAST   VARCHAR2 DEFAULT NULL ) AS

	WS_ORDER1 VARCHAR2(10);
	WS_ORDER2 VARCHAR2(10);
	WS_COUNT NUMBER;
BEGIN
    
	IF INSTR(PRM_OBJETO, 'SECTION') = 0 THEN
        IF INSTR(PRM_OBJETO, 'ARTICLE') <> 0 AND INSTR(PRM_TARGET, 'ARTICLE') <> 0 THEN
		    SELECT POSX INTO WS_ORDER1 FROM OBJECT_LOCATION WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_OBJETO;
		    SELECT POSX INTO WS_ORDER2 FROM OBJECT_LOCATION WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_TARGET;
		    UPDATE OBJECT_LOCATION SET POSX = WS_ORDER1 WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_TARGET;
		    UPDATE OBJECT_LOCATION SET POSX = WS_ORDER2 WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_OBJETO;
		ELSE
		    SELECT COUNT(*) INTO WS_COUNT
			FROM OBJECT_LOCATION
			WHERE OBJECT_ID = PRM_OBJETO AND
			SCREEN = PRM_LAST;

			UPDATE OBJECT_LOCATION
			SET SCREEN = PRM_TARGET,
			POSX = WS_COUNT
			WHERE OBJECT_ID = PRM_OBJETO AND
			SCREEN = PRM_LAST;
		END IF;
	ELSE
	    SELECT POSX INTO WS_ORDER1 FROM OBJECT_LOCATION WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_OBJETO;
		SELECT POSX INTO WS_ORDER2 FROM OBJECT_LOCATION WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_TARGET;
		UPDATE OBJECT_LOCATION SET POSX = WS_ORDER1 WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_TARGET;
		UPDATE OBJECT_LOCATION SET POSX = WS_ORDER2 WHERE SCREEN = PRM_LAST AND OBJECT_ID = PRM_OBJETO;
	END IF;

END DASHBOARDMOVE;

PROCEDURE EXECUTAR( PRM_ACAO VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
	BEGIN
		EXECUTE IMMEDIATE PRM_ACAO;
		HTP.P('!alert '||SQLERRM);
	EXCEPTION WHEN OTHERS THEN
		HTP.P('!alert '||SQLERRM);
	END;

END EXECUTAR;

PROCEDURE CHANGE_PASS (USUARIO     VARCHAR2,
                       SENHA       VARCHAR2 )
AS

   WS_SESSION     VARCHAR2(100);
   WS_TXT         VARCHAR2(2000);
   JOB_ID         NUMBER;

BEGIN
    
   SELECT SID||','||SERIAL# INTO WS_SESSION
   FROM V$SESSION
   WHERE AUDSID = USERENV('SESSIONID');

   BEGIN
        DBMS_JOB.SUBMIT(JOB => JOB_ID,WHAT => 'dwu.exec_pass('||CHR(39)||USUARIO||CHR(39)||','||CHR(39)||SENHA||CHR(39)||','||CHR(39)||WS_SESSION||CHR(39)||');',NEXT_DATE => SYSDATE+((1/10)/(24*60)),INTERVAL => NULL);
   EXCEPTION
        WHEN OTHERS THEN
             WS_TXT := SQLERRM;
   END;
   COMMIT;

END CHANGE_PASS;

PROCEDURE SHOW_UPDATE ( PRM_USUARIO VARCHAR2 DEFAULT NULL,
                        PRM_SCREEN  VARCHAR2 DEFAULT NULL,
						PRM_TIME    VARCHAR2 DEFAULT NULL,
						PRM_ORDEM   VARCHAR2 DEFAULT '1',
						PRM_TIPO    VARCHAR2 DEFAULT 'all' ) AS

	WS_TEMPO     VARCHAR2(5);
	WS_DESCRICAO VARCHAR2(600);
    WS_COUNT     NUMBER := 0;

BEGIN
    
    CASE PRM_TIPO

	WHEN 'time' THEN
	    UPDATE USER_SEQUENCE
		SET TIME = PRM_TIME
		WHERE SCREEN = PRM_SCREEN AND
		USUARIO = PRM_USUARIO AND
		ORDEM = PRM_ORDEM AND
		ROWNUM = 1;
	WHEN 'screen' THEN
	    UPDATE USER_SEQUENCE
		SET SCREEN = PRM_SCREEN
		WHERE TIME = PRM_TIME AND
		USUARIO = PRM_USUARIO AND
		ORDEM = PRM_ORDEM AND
		ROWNUM = 1;
	WHEN 'ordem' THEN
	    UPDATE USER_SEQUENCE
		SET ORDEM = PRM_ORDEM
		WHERE TIME = PRM_TIME AND
		USUARIO = PRM_USUARIO AND
		SCREEN = PRM_SCREEN AND
		ROWNUM = 1;
	WHEN 'show' THEN
	    UPDATE USUARIOS
		SET SHOW_ONLY = PRM_SCREEN
		WHERE TRIM(USU_NOME) = PRM_USUARIO;

		insert into log_eventos values(sysdate, 'ALTERACAO TIPO[show_only]', prm_usuario, 'TELA', 'USUARIO', '01');  
		commit;		

	WHEN 'delete' THEN
	    DELETE FROM USER_SEQUENCE
		WHERE ORDEM = PRM_ORDEM AND
		USUARIO = PRM_USUARIO AND
		SCREEN = PRM_SCREEN AND
		TIME = PRM_TIME;
		COMMIT;
		
		HTP.P('[1]'||FUN.LANG('Removido com sucesso'));
		
	ELSE
	    INSERT INTO USER_SEQUENCE (ORDEM, SCREEN, TIME, USUARIO) 
	    VALUES (PRM_ORDEM, PRM_SCREEN, PRM_TIME, PRM_USUARIO);
	    COMMIT; 
	    
	    SELECT COUNT(*) INTO WS_COUNT FROM USER_SEQUENCE 
	    WHERE ORDEM = PRM_ORDEM AND
	    SCREEN = PRM_SCREEN AND
	    TIME = PRM_TIME AND
	    USUARIO = PRM_USUARIO;
	    
	    IF WS_COUNT <> 0 THEN
            HTP.P('[1]'||FUN.LANG('Adicionado com sucesso'));
        ELSE
            HTP.P(FUN.LANG('Erro ao adicionar'));
        END IF;
	END CASE;

EXCEPTION WHEN OTHERS THEN
	HTP.P('!alert erro ao alterar');
END SHOW_UPDATE;

PROCEDURE FAKEDATALIST ( PRM_CODIGO     VARCHAR2 DEFAULT NULL,
                         PRM_DESCRICAO  VARCHAR2 DEFAULT NULL,
						 PRM_TABELA     VARCHAR2 DEFAULT NULL,
                         PRM_ROWNUM     NUMBER DEFAULT 50,
						 PRM_TEXT       VARCHAR2 DEFAULT 'N/A',
                         PRM_BROWSER    VARCHAR2 DEFAULT 'N/A' ) AS

	WS_CURSOR	        INTEGER;
	WS_SQL		        VARCHAR2(2000);
	WS_CODIGO           VARCHAR2(2000);
	WS_DESCRICAO        VARCHAR2(2000);
	WS_LINHAS           INTEGER;
    WS_COUNT            NUMBER;

BEGIN
    
	IF PRM_TEXT = 'N/A' AND PRM_BROWSER = 'N/A' THEN
		WS_COUNT := PRM_ROWNUM-49;
		WS_SQL := 'select '||PRM_CODIGO||', '||PRM_DESCRICAO||' from (select '||PRM_CODIGO||', '||PRM_DESCRICAO||', rownum as linha from (select '||PRM_CODIGO||', '||PRM_DESCRICAO||' from '||PRM_TABELA||' order by '||PRM_DESCRICAO||' asc)) where linha between '||WS_COUNT||' and '||PRM_ROWNUM||'';

		BEGIN
		WS_CURSOR := DBMS_SQL.OPEN_CURSOR;


			DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);

			WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);
			LOOP
				IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
					EXIT;
				END IF;
				WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
				HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||TRIM(WS_DESCRICAO)||'</li>');
			END LOOP;

			DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

			IF WS_COUNT >= 50 THEN
				HTP.P('<li style="font-weight: bold !important; text-align: center !important;" id="load-more" class="link" title="'||FUN.LANG('Carregar mais 50')||'" onclick="remover(''load-more'', ''r''); var numero = parseInt(document.getElementById(''fake_ajax'').children.length)+50; ajax(''main'', ''fakedatalist'', ''prm_codigo='||PRM_CODIGO||'&prm_descricao='||PRM_DESCRICAO||'&prm_tabela='||PRM_TABELA||'&prm_rownum=''+numero+''&prm_text=N/A&prm_browser='||PRM_BROWSER||''', true, ''fake_ajax'');">'||FUN.LANG('carregar')||' mais 50</li>');
			END IF;

		EXCEPTION WHEN OTHERS THEN
			HTP.P('');
		END;
	ELSE

        WS_COUNT := PRM_ROWNUM-49;

        IF TRIM(PRM_CODIGO) = 'column_name' THEN
            IF PRM_TEXT = 'all' THEN
                WS_SQL := 'select column_name, column_name from all_tab_columns where table_name = '''||PRM_TABELA||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||PRM_TABELA||''')';
            ELSE
                WS_SQL := 'select column_name, column_name from all_tab_columns where table_name = '''||PRM_TABELA||''' and column_name not in (select cd_coluna from data_coluna where cd_micro_data = '''||PRM_TABELA||''') and upper(column_name) like (''%'||UPPER(TRIM(PRM_TEXT))||'%'')';
            END IF;
        ELSE
            IF NVL(PRM_TEXT, 'N/A') <> 'N/A' THEN
	            BEGIN
                    WS_SQL := 'select '||PRM_CODIGO||', '||PRM_DESCRICAO||', linha from (select '||PRM_CODIGO||', '||PRM_DESCRICAO||', rownum as linha from '||TRIM(PRM_TABELA)||' where upper('||TRIM(PRM_DESCRICAO)||') like (''%'||UPPER(TRIM(PRM_TEXT))||'%'') or upper('||TRIM(PRM_CODIGO)||') like (''%'||UPPER(TRIM(PRM_TEXT))||'%'')) where linha between '||WS_COUNT||' and '||PRM_ROWNUM||' order by 2 asc';
                EXCEPTION WHEN OTHERS THEN
                    WS_SQL := 'select '||PRM_CODIGO||', '||PRM_DESCRICAO||' from '||TRIM(PRM_TABELA)||' where upper('||TRIM(PRM_DESCRICAO)||') like (''%'||UPPER(TRIM(PRM_TEXT))||'%'') or or upper('||TRIM(PRM_CODIGO)||') like (''%'||UPPER(TRIM(PRM_TEXT))||'%'')order by 2 asc';
                END;
            ELSE
	            WS_SQL := 'select '||PRM_CODIGO||', '||PRM_DESCRICAO||', linha from (select '||PRM_CODIGO||', '||PRM_DESCRICAO||', rownum as linha from '||TRIM(PRM_TABELA)||') where linha between '||WS_COUNT||' and '||PRM_ROWNUM||' order by 2 asc';
            END IF;
        END IF;

		BEGIN
		WS_CURSOR := DBMS_SQL.OPEN_CURSOR;


			DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CODIGO, 200);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_DESCRICAO, 200);

			WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);
			LOOP
				IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
					EXIT;
				END IF;
				WS_COUNT := DBMS_SQL.LAST_ROW_COUNT;
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CODIGO);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_DESCRICAO);
                IF LENGTH(TRIM(PRM_BROWSER)) > 0 THEN
                    HTP.P('<li title="'||WS_CODIGO||'" onclick="document.getElementById('''||PRM_BROWSER||''').parentNode.setAttribute(''data-v'', this.title); document.getElementById('''||PRM_BROWSER||''').innerHTML = this.innerHTML.trim(); document.getElementById(''fakelist'').classList.toggle(''visible'');" >'||WS_CODIGO||' - '||UPPER(WS_DESCRICAO)||'</li>');
                ELSE
				    HTP.P('<li onclick="fakeValue(''fake_datalist'', this);" title="'||TRIM(WS_CODIGO)||'">'||WS_CODIGO||' - '||TRIM(WS_DESCRICAO)||'</li>');
                END IF;
			END LOOP;

            IF WS_COUNT >= 50 THEN
                HTP.P('<li style="font-weight: bold !important; text-align: center !important;" id="load-more" class="link" title="'||FUN.LANG('Carregar mais 50')||'" onclick="remover(''load-more'', ''r''); var numero = parseInt(document.getElementById(''fake_ajax'').children.length)+50; ajax(''main'', ''fakedatalist'', ''prm_codigo='||PRM_CODIGO||'&prm_descricao='||PRM_DESCRICAO||'&prm_tabela='||PRM_TABELA||'&prm_rownum=''+numero+''&prm_text=''+document.getElementById(''filter-value'').value+''&prm_browser='||PRM_BROWSER||''', true, ''fake_ajax'');">'||FUN.LANG('carregar')||' mais 50</li>');
			END IF;

			DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
		EXCEPTION WHEN OTHERS THEN
			HTP.P('');
            INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||WS_SQL||' - FAKEDATALIST', GBL.GETUSUARIO, 'ERRO');
            COMMIT;
		END;
	END IF;

END FAKEDATALIST;

PROCEDURE DL_VIEW ( PRM_VIEW VARCHAR2 DEFAULT NULL )  AS

    WS_ERRORMSG VARCHAR2(400);
	WS_FAIL EXCEPTION;

BEGIN
    
	BEGIN
		DELETE FROM MICRO_VISAO WHERE NM_MICRO_VISAO = PRM_VIEW;
		DELETE FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_VIEW;
		DELETE FROM PONTO_AVALIACAO WHERE CD_MICRO_VISAO = PRM_VIEW;
		DELETE FROM FILTROS WHERE MICRO_VISAO = PRM_VIEW AND TP_FILTRO = 'geral';
		DELETE FROM FILTROS_NOTIFY WHERE MICRO_VISAO = PRM_VIEW;
		DELETE FROM FILTROS WHERE MICRO_VISAO = PRM_VIEW AND TP_FILTRO = 'objeto';
		DELETE FROM LINHA_CALCULADA WHERE CD_MICRO_VISAO = PRM_VIEW;
		DELETE FROM COLUMN_RESTRICTION WHERE CD_MICRO_VISAO = PRM_VIEW;
		COMMIT;

    EXCEPTION
	WHEN WS_FAIL THEN
	    HTP.P('!alert '||WS_ERRORMSG);
	WHEN OTHERS THEN
	    HTP.P('!alert Erro ao excluir');
	END;
END DL_VIEW;

PROCEDURE SEND_SMS ( PRM_ORIGEM  VARCHAR2 DEFAULT NULL,
                     PRM_MSG     VARCHAR2 DEFAULT NULL,
                     PRM_FONE    VARCHAR2 DEFAULT NULL,
                     PRM_COUNT   VARCHAR2 DEFAULT 'NO_NUM' ) AS

    WS_ID      VARCHAR2(20);
    WS_URL     VARCHAR2(2000);
    WS_STATUS  VARCHAR2(2000);
    WS_STRING  VARCHAR2(2000);
    WS_ERRO    EXCEPTION;

BEGIN
    
    WS_STATUS := 'OK';

    BEGIN
        IF  PRM_COUNT = 'NO_NUM' THEN
            SELECT TRIM(SID||SERIAL#||'.'||TO_CHAR(SYSDATE,'DDMMYYHHMISS')) INTO WS_ID
            FROM SYS.V_$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid') AND ROWNUM=1;
        ELSE
            WS_ID := PRM_COUNT||TO_CHAR(SYSDATE,'DDMMYYHHMISS');
        END IF;

		WS_URL := TRIM(FUN.RET_VAR('SMS_URL'));
		WS_URL := REPLACE(WS_URL,'$[ORIGEM]',PRM_ORIGEM);
		WS_URL := REPLACE(WS_URL,'$[FONE]',PRM_FONE);
		WS_URL := REPLACE(WS_URL,'$[ID]',WS_ID);
		WS_URL := REPLACE(WS_URL,'$[MSG]',PRM_MSG);

		

		BEGIN
				WS_STRING  := UTL_HTTP.REQUEST(WS_URL);
		EXCEPTION
				WHEN OTHERS THEN WS_STATUS := 'ERRO 1';
		END;

		IF  SUBSTR(WS_STRING,1,3) <> '000' THEN
			WS_STATUS := WS_STRING;
		END IF;

    EXCEPTION
        WHEN OTHERS THEN WS_STATUS := 'ERRO 3';
    END;


    INSERT INTO SENT_SMS VALUES (USER,PRM_ORIGEM,SYSDATE,PRM_FONE,WS_STATUS);
    COMMIT;

    IF  WS_STATUS <> 'OK' THEN
        RAISE WS_ERRO;
    END IF;

END SEND_SMS;

PROCEDURE HTML_CONSULTA ( PRM_VISAO VARCHAR2 DEFAULT NULL,
                          PRM_OBJID VARCHAR2 DEFAULT NULL,
						  PRM_SCREEN VARCHAR2 DEFAULT NULL,
                          PRM_DRILL VARCHAR2 DEFAULT 'Y',
  						  PRM_ORDEM NUMBER DEFAULT 1,
						  PRM_POSX VARCHAR2 DEFAULT NULL,
                          PRM_POSY VARCHAR2 DEFAULT NULL,
						  PRM_DASHBOARD VARCHAR2 DEFAULT NULL) AS

	WS_OBJID       VARCHAR2(80);
    WS_TITULO      VARCHAR2(300);
	WS_PROPAGATION VARCHAR2(2000);
	WS_POSX        VARCHAR2(30);
	WS_POSY        VARCHAR2(30);
	WS_POSICAO     VARCHAR2(80);
	WS_ORDER       VARCHAR2(100);
	WS_ISOLADO     VARCHAR2(60);
	WS_CTEMP       VARCHAR2(40);
	WS_NOME        VARCHAR2(400);
	WS_USUARIO     VARCHAR2(80);
	WS_ADMIN       VARCHAR2(80);
	WS_PADRAO      VARCHAR2(80) := 'PORTUGUESE';
BEGIN

    WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;
    

    SELECT NM_OBJETO INTO WS_NOME FROM OBJETOS WHERE CD_OBJETO = PRM_OBJID;

	BEGIN
        SELECT CONTEUDO INTO WS_PADRAO
        FROM   PARAMETRO_USUARIO
        WHERE  CD_USUARIO = WS_USUARIO AND
               CD_PADRAO='CD_LINGUAGEM';
    EXCEPTION
        WHEN OTHERS THEN
            WS_PADRAO := 'PORTUGUESE';
    END;


    
    BEGIN
		IF INSTR(PRM_POSX, '-') = 1 THEN
			WS_POSX := '5px';
		ELSE
			WS_POSX := PRM_POSX;
		END IF;

		IF INSTR(PRM_POSY, '-') = 1 THEN
			WS_POSY := '65px';
		ELSE
			WS_POSY := PRM_POSY;
		END IF;

		IF PRM_DASHBOARD <> 'false' THEN
			WS_ORDER := 'order: '||WS_POSX||';';
		ELSE
			WS_ORDER := 'left: '||WS_POSX||';';
		END IF;

		IF  NVL(PRM_POSX,'NOLOC') <> 'NOLOC' THEN
			WS_POSICAO := 'position: absolute; top:'||WS_POSY||'; '||WS_ORDER||' ';
		ELSE
			IF PRM_DRILL = 'O' THEN
				WS_POSICAO := ' position: absolute; top: 8px; left: 8px; ';
			ELSE
				WS_POSICAO := ' position: absolute; top: 110px; left: 7px; ';
			END IF;
		END IF;

		IF PRM_DASHBOARD <> 'N' THEN
			WS_POSICAO := WS_POSICAO||' margin-right:   '||FUN.GETPROP(PRM_OBJID,'DASH_MARGIN_RIGHT', PRM_SCREEN)||';';
			WS_POSICAO := WS_POSICAO||' margin-left:    '||FUN.GETPROP(PRM_OBJID,'DASH_MARGIN_LEFT',  PRM_SCREEN)||';';
			WS_POSICAO := WS_POSICAO||' margin-top:     '||FUN.GETPROP(PRM_OBJID,'DASH_MARGIN_TOP',   PRM_SCREEN)||';';
			WS_POSICAO := WS_POSICAO||' margin-bottom:  '||FUN.GETPROP(PRM_OBJID,'DASH_MARGIN_BOT',   PRM_SCREEN)||';';
		END IF;

		IF PRM_DASHBOARD <> 'false' THEN
			WS_PROPAGATION := 'event.stopPropagation();';
		ELSE
			WS_PROPAGATION := '';
		END IF;

		IF NVL(PRM_OBJID,'%?%')<>'%?%' THEN
			WS_TITULO := WS_NOME;
		ELSE
			WS_TITULO := '';
		END IF;

		IF PRM_DRILL = 'Y' THEN
			WS_OBJID := PRM_OBJID||'trl';
		ELSE
			WS_OBJID := PRM_OBJID;
		END IF;

		WS_ISOLADO := FUN.PUT_PAR(PRM_OBJID, 'FILTRO', 'CONSULTA');

		IF  PRM_DRILL='Y' THEN
			WS_OBJID := WS_OBJID||'trl';
			HTP.P('<div id="'||WS_OBJID||'" data-cell="'||PRM_ORDEM||'" data-track="" data-left="'||WS_POSX||'" data-top="'||WS_POSY||'" data-fixed="'||NVL(FUN.GETPROP(PRM_OBJID, 'FIXED-N'), '0')||'" onmousedown="'||WS_PROPAGATION||'" onmouseout="" class="dragme front drill" style="'||WS_POSICAO||' width: 300px; height: 200px;">');
		ELSE
			WS_OBJID := WS_OBJID;
			IF WS_ADMIN = 'A' THEN
				HTP.P('<div id="'||WS_OBJID||'" data-refresh="12000" data-cell="'||PRM_ORDEM||'" data-track="" data-left="'||WS_POSX||'" data-top="'||WS_POSY||'" data-fixed="'||NVL(FUN.GETPROP(PRM_OBJID, 'FIXED-N'), '0')||'" data-swipe="" ontouchstart="swipeStart('''||WS_OBJID||''', event); selectmouse(event);" ontouchmove="swipe('''||WS_OBJID||''', event);" ontouchend="swipe('''||WS_OBJID||''', event);" onmousedown="'||WS_PROPAGATION||'" class="dragme front" style="'||WS_POSICAO||' ">');
			ELSE
				HTP.P('<div id="'||WS_OBJID||'" data-refresh="12000" data-cell="'||PRM_ORDEM||'" data-track="" data-left="'||WS_POSX||'" data-top="'||WS_POSY||'" data-fixed="'||NVL(FUN.GETPROP(PRM_OBJID, 'FIXED-N'), '0')||'" data-swipe="" ontouchstart="swipeStart('''||WS_OBJID||''', event); selectmouse(event);" ontouchmove="swipe('''||WS_OBJID||''', event);" ontouchend="swipe('''||WS_OBJID||''', event);" onmousedown="'||WS_PROPAGATION||'" class="dragme front" style="'||WS_POSICAO||' width: 300px; height: 200px;">');
			END IF;
		END IF;

		HTP.P('<style>div#'||WS_OBJID||' table, div#'||WS_OBJID||'fixed, div#'||WS_OBJID||'fixed { font-size: '||FUN.PUT_PAR(PRM_OBJID,'FONT_SIZE', 'CONSULTA')||'; }</style>');

		IF WS_ADMIN = 'A' THEN
			HTP.P('<span title="'||FUN.LANG('Op&ccedil;&otilde;es')||'" class="options closed" id="'||WS_OBJID||'more">');
				HTP.P(FUN.SHOWTAG(PRM_OBJID, 'atrib', PRM_SCREEN));
				HTP.P(FUN.SHOWTAG(PRM_OBJID, 'post'));
				HTP.P('<span class="preferencias" title="'||FUN.LANG('Propriedades')||'" onclick="titulo(this, ''c''); call_save(''savepa''); ajax(''list'', ''ponto_av'', ''prm_micro_visao='||PRM_VISAO||'&ws_par_sumary='||PRM_OBJID||'&ws_par_tipo=CONSULTA&ws_par_seecol='||PRM_OBJID||''', ''false'', ''content''); curtain(''enabled'');"></span>');
				HTP.P(FUN.SHOWTAG(PRM_OBJID, 'filter', PRM_VISAO));
				HTP.P('<span class="sigma" title="'||FUN.LANG('Coluna Calculada')||'"></span>');
				HTP.P('<span class="lightbulb" title="Drill '||PRM_OBJID||'"></span>');
				HTP.P(FUN.SHOWTAG(WS_OBJID||'c', 'excel'));
				HTP.P('<span class="data_table" title="'||FUN.LANG('Alterar Consulta')||'" onclick="titulo(this, ''n''); call_save(''consulta''); carrega(''consulta?prm_obj='||PRM_OBJID||'&prm_visao='||PRM_VISAO||CHR(39)||'); curtain(''enabled'');"></span>');
				HTP.P('<span class="star" title="'||FUN.LANG('Alterar Destaque')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''visao'', '''||PRM_VISAO||'''); telaSup(''objeto'', '''||PRM_OBJID||'''); carregaPainel(''blink&prm_default='||PRM_OBJID||'|'||PRM_VISAO||'''); carrega(''blink?prm_objeto='||PRM_OBJID||'&prm_visao='||PRM_VISAO||'''); curtain(''enabled'');"></span>');
			HTP.P('</span>');
			HTP.P('<a class="fechar" id="'||WS_OBJID||'fechar" title="'||FUN.LANG('Fechar')||'">X</a>');
		ELSE
			HTP.P('<span title="'||FUN.LANG('Op&ccedil;&otilde;es')||'" class="options closed" id="'||WS_OBJID||'more" style="max-width: 94px;">');
				HTP.P('<span class="lightbulb" title="Drill '||PRM_OBJID||'"></span>');
				HTP.P(FUN.SHOWTAG(PRM_OBJID, 'post'));
				HTP.P(FUN.SHOWTAG(WS_OBJID||'c', 'excel'));
				HTP.P('<span class="star" title="'||FUN.LANG('Alterar Destaque')||'" onclick="titulo(this, ''c''); call_save(''''); telaSup(''visao'', '''||PRM_VISAO||'''); telaSup(''objeto'', '''||PRM_OBJID||'''); carregaPainel(''blink&prm_default='||PRM_OBJID||'|'||PRM_VISAO||'''); carrega(''blink?prm_objeto='||PRM_OBJID||'&prm_visao='||PRM_VISAO||'''); curtain(''enabled'');"></span>');
			HTP.P('</span>');
			IF PRM_DRILL='Y' THEN
				HTP.P('<a class="fechar" id="'||WS_OBJID||'fechar" title="'||FUN.LANG('Fechar')||'">X</a>');
			END IF;
		END IF;

		IF  PRM_DRILL='Y' THEN
			IF  WS_ADMIN = 'A' THEN
				HTP.P('<span id="'||WS_OBJID||'_ds" title="'||WS_OBJID||'" class="wd_move">'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', PRM_OBJID, WS_TITULO, WS_PADRAO), PRM_SCREEN)||'</span>');
			ELSE
				HTP.P('<span id="'||WS_OBJID||'_ds" title="'||FUN.LANG('clique e arraste para mover')||'" class="wd_move">'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', PRM_OBJID, WS_TITULO, WS_PADRAO), PRM_SCREEN)||'</span>');
			END IF;
		ELSE
			IF WS_ADMIN = 'A' THEN
				HTP.P('<span id="'||WS_OBJID||'_ds" data-touch="0" title="'||WS_OBJID||'" class="wd_move" >'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', PRM_OBJID, WS_TITULO, WS_PADRAO), PRM_SCREEN)||'</span>');
			ELSE
				HTP.P('<span id="'||WS_OBJID||'_ds" data-touch="0" class="no_move">'||FUN.SUBPAR(FUN.UTRANSLATE('NM_OBJETO', PRM_OBJID, WS_TITULO, WS_PADRAO), PRM_SCREEN)||'</span>');
			END IF;
		END IF;

		HTP.P('<div id="'||WS_OBJID||'fixed" data-number="'||NVL(FUN.PUT_PAR(PRM_OBJID, 'FIXED-N', 'CONSULTA'), '9999')||'" style="margin: 6px 0 0 6px; position: absolute; transition: width 0.2s linear 0s; width: 0; border-top: 2px solid #000; border-bottom: 0; border-right: 1px solid #000; border-left: 0 solid #000; overflow: hidden; z-index: 5;"></div>');

	EXCEPTION WHEN OTHERS THEN
		HTP.P(SQLERRM);
	END;

END HTML_CONSULTA;

PROCEDURE CHECK_DATA ( PRM_VALOR VARCHAR2 DEFAULT NULL,
                       PRM_TABELA VARCHAR2 DEFAULT NULL,
					   PRM_TRUE VARCHAR2 DEFAULT 'ok',
					   PRM_FALSE VARCHAR2 DEFAULT 'error' ) AS

WS_COUNT NUMBER;
BEGIN
    
	CASE PRM_TABELA
	    WHEN 'objetos' THEN
	        SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE UPPER(TRIM(COD)) = UPPER(TRIM(PRM_VALOR));
		WHEN 'visao' THEN
		    SELECT COUNT(*) INTO WS_COUNT FROM MICRO_VISAO WHERE UPPER(TRIM(NM_MICRO_VISAO)) = UPPER(TRIM(PRM_VALOR));
			HTP.P('fail');
		WHEN 'main' THEN
		    SELECT COUNT(*) INTO WS_COUNT FROM ALL_SCREENS WHERE SCREEN = PRM_VALOR AND FLEX_FLOW = 'row';
		WHEN 'lov' THEN
		    SELECT COUNT(*) INTO WS_COUNT FROM CODIGO_DESCRICAO WHERE UPPER(TRIM(NDS_TABELA)) = UPPER(TRIM(PRM_VALOR));
		ELSE
		    SELECT COUNT(*) INTO WS_COUNT FROM OBJETOS WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_VALOR));
	END CASE;

	IF WS_COUNT = 0 THEN HTP.P(PRM_TRUE); ELSE HTP.P(PRM_FALSE); END IF;
END CHECK_DATA;

PROCEDURE OBJECT_PADRAO AS

    CURSOR CRS_PADROES IS
	    SELECT T1.TP_OBJETO, T1.CD_PROP, T1.CD_TIPO, T1.LABEL, T2.VL_DEFAULT, T1.SUFIXO, T1.SCRIPT, T2.GRUPO, T2.HINT, T2.ORDEM
		FROM BI_OBJECT_PADRAO T1
		LEFT JOIN OBJECT_PADRAO T2 ON T1.TP_OBJETO = T2.TP_OBJETO AND T1.CD_PROP = T2.CD_PROP
		AND NVL(T1.SUFIXO, 'N/A') <> 'N/A'
		ORDER BY TP_OBJETO, ORDEM, CD_PROP;

	WS_PADRAO CRS_PADROES%ROWTYPE;

BEGIN
    HTP.P('<table class="linha">');
		HTP.P('<thead>');
		    HTP.P('<tr>');
			    HTP.P('<th>'||FUN.LANG('TIPO')||'</th>');
				HTP.P('<th>'||FUN.LANG('PROPRIEDADE')||'</th>');
				HTP.P('<th>'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</th>');
				HTP.P('<th>DEFAULT</th>');
				



			HTP.P('</tr>');
		HTP.P('</thead>');
		HTP.P('<tbody>');
			OPEN CRS_PADROES;
				LOOP
					FETCH CRS_PADROES INTO WS_PADRAO;
					EXIT WHEN CRS_PADROES%NOTFOUND;
						HTP.P('<tr>');
						    HTP.P('<td>'||WS_PADRAO.TP_OBJETO||'</td>');
							HTP.P('<td>'||WS_PADRAO.CD_PROP||'</td>');
							HTP.P('<td>'||WS_PADRAO.LABEL||'</td>');
							HTP.P('<td><input type="text" data-default="'||WS_PADRAO.VL_DEFAULT||'" onblur="if(this.value != this.getAttribute(''data-default'')){ ajax(''fly'', ''update_padrao'', ''prm_tipo='||WS_PADRAO.TP_OBJETO||'&prm_propriedade='||WS_PADRAO.CD_PROP||'&prm_coluna=default&prm_valor=''+this.value); alerta(''msg'', TR_AL); }" value="'||WS_PADRAO.VL_DEFAULT||'" /></td>');

						HTP.P('</tr>');
				END LOOP;
			CLOSE CRS_PADROES;
		HTP.P('</tbody>');
	HTP.P('</table>');
END OBJECT_PADRAO;

PROCEDURE ADD_OBJECT_PADRAO (  PRM_OBJ         VARCHAR2 DEFAULT NULL,
							   PRM_PROPRIEDADE VARCHAR2 DEFAULT NULL,
							   PRM_TIPO        VARCHAR2 DEFAULT NULL,
							   PRM_LABEL       VARCHAR2 DEFAULT NULL,
							   PRM_DEFAULT     VARCHAR2 DEFAULT NULL,
							   PRM_SUFIXO      VARCHAR2 DEFAULT 'gr',
							   PRM_SCRIPT      VARCHAR2 DEFAULT 'rtl',
							   PRM_VALIDACAO   VARCHAR2 DEFAULT NULL,
							   PRM_GRUPO       VARCHAR2 DEFAULT 'VISUAL' ) AS

	WS_ERRO EXCEPTION;

BEGIN

    BEGIN
	    INSERT INTO OBJECT_PADRAO (TP_OBJETO, CD_PROP, CD_TIPO, LABEL, VL_DEFAULT, SUFIXO, SCRIPT, VALIDACAO, ST_PERSONALIZADO, ORDEM, GRUPO, HINT) VALUES (TRIM(PRM_OBJ), UPPER(TRIM(PRM_PROPRIEDADE)), TRIM(PRM_TIPO), TRIM(PRM_LABEL), TRIM(PRM_DEFAULT), TRIM(PRM_SUFIXO), TRIM(PRM_SCRIPT), TRIM(PRM_VALIDACAO), 'N', 0, TRIM(PRM_GRUPO), '');
        COMMIT;
        HTP.P('OK');
	EXCEPTION WHEN OTHERS THEN
	    ROLLBACK;
	    RAISE WS_ERRO;
	END;

EXCEPTION
    WHEN WS_ERRO THEN
	    HTP.P('#alert Erro ao adicionar');
	WHEN OTHERS THEN
        HTP.P('#alert Erro ao adicionar');
END;

PROCEDURE UPDATE_PADRAO ( PRM_TIPO VARCHAR2 DEFAULT NULL,
                          PRM_PROPRIEDADE VARCHAR2 DEFAULT NULL,
						  PRM_COLUNA VARCHAR2 DEFAULT NULL,
						  PRM_VALOR VARCHAR2 DEFAULT NULL ) AS

BEGIN
	CASE PRM_COLUNA
	    WHEN 'default' THEN
	        MERGE INTO OBJECT_PADRAO T1
			USING (SELECT PRM_TIPO AS TIPO, PRM_PROPRIEDADE PROPRIEDADE FROM DUAL) T2
			ON (T1.TP_OBJETO = T2.TIPO AND T1.CD_PROP = T2.PROPRIEDADE)
			WHEN MATCHED THEN UPDATE SET VL_DEFAULT = PRM_VALOR
			WHEN NOT MATCHED THEN INSERT (TP_OBJETO, CD_PROP, VL_DEFAULT) VALUES (PRM_TIPO, PRM_PROPRIEDADE, PRM_VALOR);
	    WHEN 'hint' THEN
	        UPDATE OBJECT_PADRAO
			SET HINT = PRM_VALOR
			WHERE TP_OBJETO = PRM_TIPO AND
			CD_PROP = PRM_PROPRIEDADE;
		WHEN 'grupo' THEN
	        UPDATE OBJECT_PADRAO
			SET GRUPO = PRM_VALOR
			WHERE TP_OBJETO = PRM_TIPO AND
			CD_PROP = PRM_PROPRIEDADE;
		WHEN 'ordem' THEN
	        UPDATE OBJECT_PADRAO
			SET ORDEM = PRM_VALOR
			WHERE TP_OBJETO = PRM_TIPO AND
			CD_PROP = PRM_PROPRIEDADE;
		WHEN 'delete' THEN
		    DELETE FROM OBJECT_PADRAO
			WHERE TP_OBJETO = PRM_TIPO AND
			CD_PROP = PRM_PROPRIEDADE AND ROWNUM = 1;
			INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Padr&atilde;o '''||PRM_PROPRIEDADE||''' excluido', GBL.GETUSUARIO, 'EVENTO');
            COMMIT;
			HTP.P('EX');
    END CASE;
	
EXCEPTION WHEN OTHERS THEN
    HTP.P('#alert '||FUN.LANG('Erro na altera&ccedil;&atilde;o')||'!');
END UPDATE_PADRAO;



/************  Alterado em 18/04/2022 - Ivanor   
PROCEDURE LANG_TABLE AS

    CURSOR CRS_PADROES IS
    SELECT CD_TABELA, CD_COLUNA, CD_LINGUAGEM, TEXTO, (SELECT TEXTO
    FROM   TRADUCAO_COLUNAS ING
    WHERE  ING.CD_LINGUAGEM='ENGLISH' AND
           ING.LANG_DEFAULT=PTG.LANG_DEFAULT AND
           ING.CD_TABELA=PTG.CD_TABELA AND
           ING.CD_COLUNA=PTG.CD_COLUNA AND ROWNUM = 1) AS INGLES
    FROM TRADUCAO_COLUNAS PTG WHERE CD_LINGUAGEM='PORTUGUESE'
    ORDER BY TIPO, CD_TABELA, CD_COLUNA, TEXTO;
	WS_PADRAO CRS_PADROES%ROWTYPE;
	WS_COUNT NUMBER;

	BEGIN

	HTP.P('<table class="linha">');
	   HTP.P('<thead>');
	   HTP.P('<tr>');
	       HTP.P('<th style="width: 50%;">PORTUG&Ecirc;S</th>');
		   HTP.P('<th style="width: 50%;">INGL&Ecirc;S</th>');
	   HTP.P('</tr>');
	   HTP.P('</thead>');
	   HTP.P('<tbody>');
			OPEN CRS_PADROES;
				LOOP
					FETCH CRS_PADROES INTO WS_PADRAO;
					EXIT WHEN CRS_PADROES%NOTFOUND;

					HTP.P('<tr>');
						HTP.P('<td style="width: 50%; white-space: nowrap; max-width: 300px; text-overflow: ellipsis; overflow: hidden;" title="'||WS_PADRAO.TEXTO||'">'||WS_PADRAO.TEXTO||'</td>');
						HTP.P('<td style="width: 50%"><input type="text" class="'||WS_PADRAO.INGLES||'" value="'||WS_PADRAO.INGLES||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||WS_PADRAO.TEXTO||'&prm_texto=''+this.value+''&prm_linguagem=ENGLISH''); noerror(''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!'', '''||WS_PADRAO.TEXTO||'-alert''); this.setAttribute(''class'', this.value); } else { alerta('''||WS_PADRAO.TEXTO||'-alert'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');
					HTP.P('</tr>');

					HTP.P('<tr><td></td><td class="alert" id="'||WS_PADRAO.TEXTO||'-alert"></td></tr>');
				END LOOP;
			CLOSE CRS_PADROES;
			HTP.P('</tbody>');
			HTP.P('</table>');

END LANG_TABLE;
*********************/ 


procedure lang_table as

ws_lang_usuario  			varchar2(100);
ws_lang_sistema  			varchar2(100);
ws_texto_original_escape 	varchar2(1000);

cursor crs_traducao_colunas is
	select DISTINCT texto as texto_original , 
    	   ((SELECT TEXTO 
        	  FROM TRADUCAO_COLUNAS ING
         	 WHERE ING.CD_LINGUAGEM   = ws_lang_usuario
           	   AND ING.LANG_DEFAULT   = PTG.LANG_DEFAULT 
               AND ING.CD_TABELA      = PTG.CD_TABELA 
               AND ING.CD_COLUNA      = PTG.CD_COLUNA 
               and rownum = 1
           )) AS texto_traduzido
     from traducao_colunas PTG 
    where CD_LINGUAGEM = ws_lang_sistema
    order by 1 ;   
begin

	ws_lang_sistema := 'PORTUGUESE';
	ws_lang_usuario := gbl.getlang;
	--
	htp.p('<table class="linha">');
		htp.p('<thead>');
	    htp.p('<tr>');
	    	htp.p('<th style="width: 50%;">'||ws_lang_usuario||'</th>');
			htp.p('<th style="width: 50%;">'||ws_lang_usuario||'</th>');
	    htp.p('</tr>');
	    htp.p('</thead>');
	    htp.p('<tbody>');
			for i in crs_traducao_colunas loop
				ws_texto_original_escape := utl_url.escape(i.texto_original, true, 'UTF-8');  		-- usar UTF-8, mesmo do navegador 		
				htp.p('<tr>');
					htp.p('<td style="width: 50%; white-space: nowrap; max-width: 300px; text-overflow: ellipsis; overflow: hidden;" title="'||i.texto_original||'">'||i.texto_original||'</td>');
					--htp.p('<td style="width: 50%"><input type="text" class="'||ws_padrao.ingles||'" value="'||ws_padrao.ingles||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||ws_padrao.texto||'&prm_texto=''+this.value+''&prm_linguagem=ENGLISH''); noerror(''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!'', '''||ws_padrao.texto||'-alert''); this.setAttribute(''class'', this.value); } else { alerta('''||ws_padrao.texto||'-alert'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');
					IF ws_lang_sistema <> ws_lang_usuario then 
					  htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||ws_texto_original_escape||'&prm_texto=''+encodeURIComponent(this.value)+''&prm_linguagem='||ws_lang_usuario||'''); alerta(''feed-fixo'', ''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!''); this.setAttribute(''class'', this.value); } else { alerta(''feed-fixo'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');						
						-- htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default=''+encodeURIComponent('''||i.texto_original||''')+''&prm_texto=''+encodeURIComponent(this.value)+''&prm_linguagem='||ws_lang_usuario||'''); alerta(''feed-fixo'', ''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!''); this.setAttribute(''class'', this.value); } else { alerta(''feed-fixo'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');						
						--htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||i.texto_original||'&prm_texto=''+encodeURIComponent(this.value)+''&prm_linguagem='||ws_lang_usuario||'''); alerta(''feed-fixo'', ''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!''); this.setAttribute(''class'', this.value); } else { alerta(''feed-fixo'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');												
						--htp.p('<td style="width: 50%"><input type="text" class="'||i.texto_traduzido||'" value="'||i.texto_traduzido||'" onblur="if(this.value != this.className){ if(this.value.trim().length > 0){ ajax(''fly'', ''update_lang_table'', ''prm_default='||i.texto_original||'&prm_texto=''+this.value+''&prm_linguagem='||ws_lang_usuario||'''); noerror(''TRADU&Ccedil;&Atilde;O ALTERADA COM SUCESSO!'', '''||i.texto_original||'-alert''); this.setAttribute(''class'', this.value); } else { alerta('''||i.texto_original||'-alert'', ''N&Atilde;O PODE ESTAR EM BRANCO!'') }}"/></td>');						
					else 
						htp.p('<td style="width: 50%; white-space: nowrap; max-width: 300px; text-overflow: ellipsis; overflow: hidden;" title="'||i.texto_traduzido||'">'||i.texto_traduzido||'</td>');	
					end if; 	
				htp.p('</tr>');
				htp.p('<tr><td></td><td class="alert" id="'||i.texto_original||'-alert"></td></tr>');
			end loop;
		htp.p('</tbody>');
	htp.p('</table>');

end lang_table;





procedure update_lang_table ( prm_default varchar2 default null,
	                            prm_texto varchar2 default null,
								prm_linguagem varchar2 default null ) as
ws_lang_sistema  	  varchar2(100);
ws_default            varchar2(1000);
begin

	ws_lang_sistema     := 'PORTUGUESE'; 

	update traducao_colunas
	   set texto = fun.converte(prm_texto)
     where lang_default = fun.converte(prm_default) 
	   and cd_linguagem = prm_linguagem;

	if SQL%NOTFOUND then 
	    insert into traducao_colunas 
		  (select distinct cd_tabela, cd_coluna, prm_linguagem, prm_texto, lang_default, tipo, fixa 
  	 		 from traducao_colunas 
 			 where cd_linguagem =  ws_lang_sistema -- Idioma padrão do sistema  
   		  	  and lang_default  = fun.converte(prm_default)
		  ); 		   
	end if;
exception
    when others then
		insert into bi_log_sistema (dt_log, ds_log, nm_usuario, nm_procedure) values(sysdate, 'Erro: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, gbl.getUsuario, 'EVENTO');
		htp.p('ERRO|'||fun.lang('Erro atualizando tradu&ccedil;&atilde;o') );
end update_lang_table;




/*******************  Alterado em 18/04/2022 - Ivanor 
PROCEDURE UPDATE_LANG_TABLE ( PRM_DEFAULT VARCHAR2 DEFAULT NULL,
	                            PRM_TEXTO VARCHAR2 DEFAULT NULL,
								PRM_LINGUAGEM VARCHAR2 DEFAULT NULL ) AS

	    WS_COUNT NUMBER;
		WS_DUPLICADA EXCEPTION;

	BEGIN

	    SELECT COUNT(*) INTO WS_COUNT
		FROM TRADUCAO_COLUNAS
		WHERE LANG_DEFAULT = PRM_DEFAULT AND
		CD_LINGUAGEM = PRM_LINGUAGEM;

		IF WS_COUNT = 1 THEN
			UPDATE TRADUCAO_COLUNAS
			SET TEXTO = FUN.CONVERTE(PRM_TEXTO)
			WHERE LANG_DEFAULT = FUN.CONVERTE(PRM_DEFAULT) AND
			CD_LINGUAGEM = PRM_LINGUAGEM;
		ELSIF WS_COUNT = 0 THEN
		    INSERT INTO TRADUCAO_COLUNAS
			VALUES ((SELECT CD_TABELA FROM TRADUCAO_COLUNAS WHERE CD_LINGUAGEM = 'PORTUGUESE' AND LANG_DEFAULT = PRM_DEFAULT),
			(SELECT CD_COLUNA FROM TRADUCAO_COLUNAS WHERE CD_LINGUAGEM = 'PORTUGUESE' AND LANG_DEFAULT = PRM_DEFAULT),
			PRM_LINGUAGEM, FUN.CONVERTE(PRM_TEXTO), FUN.CONVERTE(PRM_DEFAULT),
			(SELECT TIPO FROM TRADUCAO_COLUNAS WHERE CD_LINGUAGEM = 'PORTUGUESE' AND LANG_DEFAULT = PRM_DEFAULT), 'N');
		ELSE
		    RAISE WS_DUPLICADA;
		END IF;


	EXCEPTION
	    WHEN WS_DUPLICADA THEN
		    HTP.P(PRM_DEFAULT);
	    WHEN OTHERS THEN
	        HTP.P(SQLERRM);
END UPDATE_LANG_TABLE;
***********************/ 

PROCEDURE PAINEL AS

BEGIN

    HTP.P('<ul style="display: flex;flex-flow: row wrap;">');
	    
		HTP.P('<li style="display: flex; align-items: center; border: 1px solid #777; background-color: #FEFEFE; padding: 4px; border-radius: 2px;" title="MENU A DIREITA DESLIZAR AO PASSAR O MOUSE">');
	        HTP.P('<span style="width: 190px; font-family: &quot;montserrat&quot;; font-weight: bold; font-size: 18px; COLOR: #333;">MENU DESLIZANTE</span>');
			HTP.P('<span class="checkbox" title="N"></span>');
	    HTP.P('</li>');
		
		HTP.P('<li style="display: flex; align-items: center; border: 1px solid #777; background-color: #FEFEFE; padding: 4px; border-radius: 2px;" title="ICONE DE LINGUAGEM DO LADO DO TEXTO">');
	        HTP.P('<span style="width: 190px; font-family: &quot;montserrat&quot;; font-weight: bold; font-size: 18px; COLOR: #333;">LINGUAGEM</span>');
			HTP.P('<span class="checkbox" title="N"></span>');
	    HTP.P('</li>');

		HTP.P('<li style="display: flex; align-items: center; border: 1px solid #777; background-color: #FEFEFE; padding: 4px; border-radius: 2px;" title="ICONE DE LINGUAGEM DO LADO DO TEXTO">');
	        HTP.P('<span style="width: 190px; font-family: &quot;montserrat&quot;; font-weight: bold; font-size: 18px; COLOR: #333;">ETL</span>');
			HTP.P('<span class="checkbox" title="N"></span>');
	    HTP.P('</li>');

	HTP.P('</ul>');

EXCEPTION
	WHEN OTHERS THEN
		HTP.PRINT(SQLERRM);
END PAINEL;

PROCEDURE GERA_CONTEUDO (  WS_EXCEL IN OUT CLOB,
                           PRM_SAIDA VARCHAR2 DEFAULT NULL,
						   PRM_EXCEL VARCHAR2 DEFAULT NULL,
						   PRM_PDF VARCHAR2 DEFAULT NULL,
						   PRM_CSV VARCHAR2 DEFAULT NULL ) AS

BEGIN
    IF PRM_SAIDA = 'S' OR PRM_SAIDA = 'O' THEN
        WS_EXCEL := WS_EXCEL||PRM_EXCEL;
	END IF;

END GERA_CONTEUDO;

PROCEDURE LIST_OBJ  ( PRM_TIPO VARCHAR2 DEFAULT 'N/A',
                      PRM_VIEW VARCHAR2 DEFAULT 'N/A',
					  PRM_GRUPO VARCHAR2 DEFAULT 'N/A',
					  PRM_DESC VARCHAR2 DEFAULT 'N/A' ) AS

	WS_SQL      VARCHAR2(2000);
	WS_LINHAS    INTEGER;
	WS_CURSOR   INTEGER;
	WS_DESC     VARCHAR2(80);
	WS_VISAO    VARCHAR2(80);
	WS_ID       VARCHAR2(80);
	WS_TIPO     VARCHAR2(80);
	WS_COD      VARCHAR2(80);

BEGIN

    WS_SQL := 'select cd_objeto, cod, nm_objeto, visao, tp_objeto, cd_grupo from (select cd_objeto, cod, nm_objeto, tp_objeto, cd_grupo, (select cd_micro_visao from ponto_avaliacao t2 where cd_ponto = t1.cd_objeto) as visao from objetos t1 where cd_objeto not like (''%_temp'')) where tp_objeto <> ''TEXTO'' and tp_objeto <> ''SCREEN'' ';

    IF PRM_TIPO <> 'N/A' THEN
        IF PRM_TIPO <> 'OUTROS' THEN
		    WS_SQL := WS_SQL||' and tp_objeto = '''||PRM_TIPO||''' ';
		END IF;
    END IF;

    IF PRM_VIEW <> 'N/A' THEN
        WS_SQL := WS_SQL||' and visao = '''||PRM_VIEW||''' ';
    END IF;

    IF PRM_GRUPO <> 'N/A' THEN
        WS_SQL := WS_SQL||' and cd_grupo = '''||PRM_GRUPO||''' ';
    END IF;

	IF PRM_DESC <> 'N/A' THEN
        WS_SQL := WS_SQL||' and (upper(nm_objeto) like ''%'||UPPER(PRM_DESC)||'%'' or upper(cd_objeto) like ''%'||UPPER(PRM_DESC)||'%'') ';
    END IF;

	WS_SQL := WS_SQL||' order by nm_objeto asc, visao asc ';

	IF PRM_TIPO <> 'OUTROS' THEN

		WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

			DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_ID, 80);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_COD, 80);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 3, WS_DESC, 80);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 4, WS_VISAO, 80);
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 5, WS_TIPO, 80);

			WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

			LOOP
				WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
				IF  WS_LINHAS <> 1 THEN
					EXIT;
				END IF;

				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_ID);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_COD);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 3, WS_DESC);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 4, WS_VISAO);
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 5, WS_TIPO);

				HTP.P('<li onclick="fastInclude('''||WS_ID||''', '''||WS_TIPO||''')" title="'||FUN.LANG('Objeto do tipo: '||WS_TIPO||'')||'">');
					HTP.P('<span>'||WS_DESC||'</span>');
					HTP.P('<span>'||NVL(WS_COD, WS_ID)||'</span>');
					IF NVL(WS_VISAO, 'N/A') <> 'N/A' THEN
					    HTP.P('<span>'||WS_VISAO||'</span>');
					END IF;
				HTP.P('</li>');
			END LOOP;
		DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
	END IF;

END LIST_OBJ;

PROCEDURE TEMPLATE ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                     PRM_VALOR VARCHAR2 DEFAULT NULL,
					 PRM_VIEW  VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT   NUMBER;
	WS_USUARIO VARCHAR2(80);
BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	SELECT COUNT(*) INTO WS_COUNT FROM OBJECT_ATTRIB WHERE OWNER = WS_USUARIO AND CD_PROP = 'TPT' AND CD_OBJECT = PRM_OBJETO AND SCREEN = PRM_VIEW;

	IF WS_COUNT = 1 THEN
	    UPDATE OBJECT_ATTRIB
		SET PROPRIEDADE = PRM_VALOR
		WHERE OWNER = WS_USUARIO AND
		CD_PROP = 'TPT' AND
		SCREEN = PRM_VIEW AND
		CD_OBJECT = PRM_OBJETO;
		COMMIT;
		UPDATE OBJECT_ATTRIB
		SET PROPRIEDADE = '1'
		WHERE OWNER = WS_USUARIO AND
		CD_PROP = 'ORDEM' AND
		SCREEN = PRM_VIEW AND
		CD_OBJECT = PRM_OBJETO;
		COMMIT;
	ELSIF WS_COUNT = 0 THEN
        INSERT INTO OBJECT_ATTRIB VALUES(WS_USUARIO, 'DEFAULT', PRM_VIEW, UPPER(PRM_OBJETO), 'TPT', PRM_VALOR);
		UPDATE OBJECT_ATTRIB
		SET PROPRIEDADE = '1'
		WHERE OWNER = WS_USUARIO AND
		CD_PROP = 'ORDEM' AND
		SCREEN = PRM_VIEW AND
		CD_OBJECT = PRM_OBJETO;
		COMMIT;
	ELSE
	    HTP.P('#alert '||FUN.LANG('Erro ao alterar')||'!');
	END IF;
EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);

END TEMPLATE;

PROCEDURE SQLPARSE AS

	WS_USUARIO  VARCHAR2(80);
	WS_NOACCESS EXCEPTION;
BEGIN

	WS_USUARIO := GBL.GETUSUARIO;

	IF WS_USUARIO = 'NOUSER' OR GBL.GETNIVEL <> 'A' THEN
		RAISE WS_NOACCESS;
	END IF;

	DELETE FROM BI_LOG_QUERY WHERE DT_LOG <= SYSDATE - 1;

    HTP.P('<div id="exec_query" style="width: 100%; height: 98%;" onkeypress="if(event.which == 13 && event.ctrlKey === true){ document.getElementById(''painel'').children[1].click(); }" >');
		
		HTP.P('<div id="sqlquery"></div>');
		HTP.P('<a class="addpurple" onclick="execute_sql(''N'', ''11'');" title="10 primeiras linhas">'||FUN.LANG('EXECUTAR')||'</a>');
        HTP.P('<a class="addpurple" onclick="execute_sql(''N'', ''999999999'');" title="tudo">'||FUN.LANG('EXECUTAR COMPLETO')||'</a>');
		HTP.P('<a id="logs_recentes" title="'||FUN.LANG('LOGS RECENTES')||'" onclick="ver_logs()"><svg height="512" viewBox="0 0 64 64" width="512" xmlns="http://www.w3.org/2000/svg"><g id="log-file"><path d="m25 27h6v10h-6z"/><path d="m56 16h-9a3 3 0 0 1 -3-3v-9h-26v17h35a1 1 0 0 1 1 1v20a1 1 0 0 1 -1 1h-35v13h38z"/><path d="m54.586 14-8.586-8.586v7.586a1 1 0 0 0 1 1z"/><path d="m60 8h-8.586l6.293 6.293a1 1 0 0 1 .293.707v42a1 1 0 0 1 -1 1h-35v2h38z"/><path d="m52 23h-48v18h48zm-31 16h-9a1 1 0 0 1 -1-1v-13h2v12h8zm12-1a1 1 0 0 1 -1 1h-8a1 1 0 0 1 -1-1v-12a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1zm12-9h-2v-2h-6v10h6v-4h-3v-2h4a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-8a1 1 0 0 1 -1-1v-12a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1z"/></g></svg></a>');
		
		HTP.P('<div id="sqloutput">');
		  HTP.P('<table id="queryresult2"></table>');
		  HTP.P('<table id="queryresult"></table>');
		  HTP.P('<div id="count"></div>');
		HTP.P('</div>');
	HTP.P('</div>');

EXCEPTION
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
END SQLPARSE;

PROCEDURE MAPMARKER ( PRM_OBJETO VARCHAR2 DEFAULT NULL ) AS

  WS_SQL           VARCHAR2(2000);
  WS_CURSOR        INTEGER;
  WS_NOME          VARCHAR2(300);
  WS_LOCALIZACAO   VARCHAR2(400);
  WS_LONGITUDE     VARCHAR2(300);
  WS_LATITUDE      VARCHAR2(300);
  WS_INFO          VARCHAR2(300);
  WS_LINHAS        INTEGER;

BEGIN

    WS_SQL := 'select '||FUN.GETPROP(PRM_OBJETO, 'NAME')||', '||FUN.GETPROP(PRM_OBJETO, 'LAT')||', '||FUN.GETPROP(PRM_OBJETO, 'LON')||', '||FUN.GETPROP(PRM_OBJETO, 'INFO')||' from '||(FUN.GETPROP(PRM_OBJETO, 'TABELA')||'');

	WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

    DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_NOME, 300);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_LATITUDE, 300);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 3, WS_LONGITUDE, 300);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 4, WS_INFO, 300);

	WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

	LOOP
		IF DBMS_SQL.FETCH_ROWS(WS_CURSOR) = 0 THEN
			EXIT;
		END IF;
	    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_NOME);
		DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_LATITUDE);
		DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 3, WS_LONGITUDE);
		DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 4, WS_INFO);

		HTP.P(''||WS_NOME||'| '||WS_LATITUDE||'| '||WS_LONGITUDE||'| '||WS_INFO||'/');
	END LOOP;

	DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

EXCEPTION WHEN OTHERS THEN
    INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - MAPMARKER', GBL.GETUSUARIO, 'ERRO');
    COMMIT;
END MAPMARKER;


PROCEDURE FAVORITAR ( PRM_FAVORITO   NUMBER   DEFAULT NULL,
                      PRM_OBJETO     VARCHAR2 DEFAULT NULL,
					  PRM_NOME       VARCHAR2 DEFAULT NULL,
					  PRM_URL        VARCHAR2 DEFAULT NULL,
					  PRM_SCREEN     VARCHAR2 DEFAULT NULL,
					  PRM_PARAMETROS VARCHAR2 DEFAULT NULL,
					  PRM_DIMENSAO   VARCHAR2 DEFAULT NULL,
					  PRM_MEDIDA     VARCHAR2 DEFAULT NULL,
					  PRM_PIVOT      VARCHAR2 DEFAULT NULL,
					  PRM_ACAO       VARCHAR2 DEFAULT 'incluir' ) AS

	WS_COUNT   NUMBER;
	WS_USUARIO VARCHAR2(80);

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	SELECT MAX(CD_FAVORITO)+1 INTO WS_COUNT FROM FAVORITOS;

	CASE PRM_ACAO
	WHEN 'incluir' THEN
        INSERT INTO FAVORITOS ( CD_FAVORITO, DS_NOME, URL, USUARIO, SCREEN, PARAMETROS, CD_OBJETO, DIMENSAO, MEDIDA, PIVOT ) VALUES ( nvl(WS_COUNT, 1), PRM_NOME, PRM_URL, WS_USUARIO, PRM_SCREEN, PRM_PARAMETROS, PRM_OBJETO, PRM_DIMENSAO, PRM_MEDIDA, PRM_PIVOT );
		COMMIT;
		
		HTP.P('!alert '||FUN.LANG('Adicionado com sucesso')||'!');
	WHEN 'alterar' THEN
        UPDATE FAVORITOS SET DS_NOME = PRM_NOME WHERE CD_FAVORITO = PRM_FAVORITO;
		COMMIT;
		HTP.P('!alert '||FUN.LANG('Alterado com sucesso')||'!');
		
    WHEN 'list' THEN
        HTP.P('<table class="linha">');
            HTP.P('<thead>');
                HTP.P('<tr>');
                    HTP.P('<th>'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'</th>');
                    HTP.P('<th>'||FUN.LANG('USU&Aacute;RIO')||'</th>');
                    HTP.P('<th>'||FUN.LANG('TELA')||'</th>');
                    HTP.P('<th>'||FUN.LANG('OBJETO')||'</th>');
                    HTP.P('<th></th>');
                HTP.P('</tr>');
            HTP.P('</thead>');
            HTP.P('<tbody>');
        FOR I IN (SELECT T1.CD_FAVORITO, T1.DS_NOME, T1.USUARIO, T1.SCREEN, T1.PARAMETROS, T1.CD_OBJETO, T2.DESCRICAO, T3.NM_OBJETO FROM FAVORITOS T1 LEFT JOIN ALL_SCREENS T2 ON T2.SCREEN = T1.SCREEN LEFT JOIN OBJETOS T3 ON T3.CD_OBJETO = T1.CD_OBJETO WHERE T1.USUARIO = WS_USUARIO AND T1.SCREEN = PRM_SCREEN) LOOP
            HTP.P('<tr title="'||I.PARAMETROS||'">');
                HTP.P('<td><input value="'||I.DS_NOME||'" data-padrao="'||I.DS_NOME||'" placeholder="'||FUN.LANG('DESCRI&Ccedil;&Atilde;O')||'" onblur="var valor = this.value; if(valor.length > 0){ ajax(''fly'', ''favoritar'', ''prm_favorito='||I.CD_FAVORITO||'&prm_objeto='||I.CD_OBJETO||'&prm_nome=''+encodeURIComponent(valor)+''&prm_parametros=''+encodeURIComponent('''||I.PARAMETROS||''')+''&prm_screen='||I.SCREEN||'&prm_acao=alterar'', false); this.setAttribute(''data-padrao'', this.value); }"/></td>');
                HTP.P('<td>'||I.USUARIO||'</td>');
                HTP.P('<td title="'||I.SCREEN||'">'||I.DESCRICAO||'</td>');
                HTP.P('<td title="'||I.CD_OBJETO||'">'||I.NM_OBJETO||'</td>');
                HTP.P('<td>');
					FCL.BUTTON_LIXO('favoritar','prm_favorito|prm_objeto|prm_acao', I.CD_FAVORITO||'|'||I.CD_OBJETO||'|'||'excluir', PRM_TAG => 'a');
				HTP.P('</td>');
				
            HTP.P('</tr>');
        END LOOP;
        HTP.P('</tbody>');
    HTP.P('</table>');
	ELSE
	    DELETE FROM FAVORITOS WHERE CD_FAVORITO = PRM_FAVORITO;
		COMMIT;
		HTP.P('!alert '||FUN.LANG('Removido com sucesso')||'!');
	END CASE;
EXCEPTION
	WHEN OTHERS THEN
		HTP.P(SQLERRM);
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - FAVORITAR', WS_USUARIO, 'ERRO');
        COMMIT;
END FAVORITAR;

PROCEDURE FORCELOGOFF ( PRM_NOME VARCHAR2 DEFAULT NULL, PRM_SESSION VARCHAR2 DEFAULT NULL ) AS

    WS_ID_SESSION VARCHAR2(80);
    WS_CMD        VARCHAR2(4000);
BEGIN

    UPDATE ACTIVE_SESSIONS SET STATUS = 'I'
     WHERE STATUS ='A' 
	   AND USUARIO = GBL.GETUSUARIO;

	
	OWA_COOKIE.SEND(PRM_NOME, PRM_SESSION, SYSDATE - 1);
	OWA_COOKIE.REMOVE(PRM_NOME, PRM_SESSION);

END FORCELOGOFF;

PROCEDURE PASSAGEM_TEST ( PICADO IN OWA_UTIL.VC_ARR,
                          NOME VARCHAR2 DEFAULT NULL,
                          PARSEONLY VARCHAR2 DEFAULT 'S' ) AS

	V_INTCUR         PLS_INTEGER;
    V_INTIDX         PLS_INTEGER;
    V_INTNUMROWS     PLS_INTEGER;
    WS_QUERY         DBMS_SQL.VARCHAR2A;
	WS_ERR           VARCHAR2(400) := '';
	WS_EXIST         EXCEPTION;
	

BEGIN
    
	WS_QUERY(1) := 'Create or replace force view '||UPPER(TRIM(NOME))||' as ';
    V_INTIDX := 1;
    FOR I IN PICADO.FIRST..PICADO.LAST
    LOOP
		IF NVL(TRIM(PICADO(I)), '%*%') <> '%*%' THEN
		    V_INTIDX := V_INTIDX + 1;
		    WS_QUERY(V_INTIDX) := PICADO(I);
		END IF;
    END LOOP;

	BEGIN
        V_INTCUR := DBMS_SQL.OPEN_CURSOR;
        DBMS_SQL.PARSE( C => V_INTCUR, STATEMENT => WS_QUERY, LB => 1, UB => V_INTIDX, LFFLG => FALSE, LANGUAGE_FLAG => DBMS_SQL.NATIVE);
		IF TRIM(PARSEONLY) <> 'S' THEN
            V_INTNUMROWS := DBMS_SQL.EXECUTE(V_INTCUR);
			HTP.P('passed');
		END IF;
        DBMS_SQL.CLOSE_CURSOR(V_INTCUR);

    EXCEPTION WHEN OTHERS THEN
	    BEGIN
		    SELECT LISTAGG(TEXT, ' ') WITHIN GROUP (ORDER BY TEXT) INTO WS_ERR FROM USER_ERRORS WHERE NAME = UPPER(NOME);
		END;
		HTP.P('#alert '||DBMS_UTILITY.FORMAT_ERROR_STACK||' '||WS_ERR);
	END;

END PASSAGEM_TEST;

PROCEDURE VERIFICA_JOB AS

 WS_VERIFICA  NUMERIC;
 WS_JOB       NUMERIC;
 WS_NEXT      DATE;
 WS_BROKEN    CHAR(1);
 WS_OK        EXCEPTION;
 WS_USUARIO   VARCHAR2(80);

BEGIN

	SELECT COUNT(*) INTO WS_VERIFICA
    FROM ALL_JOBS
    WHERE UPPER(WHAT) LIKE 'SCH.MAIN;';

	

    IF WS_VERIFICA <> 0 THEN

		SELECT BROKEN, NEXT_DATE, JOB INTO WS_BROKEN, WS_NEXT, WS_JOB
        FROM ALL_JOBS
        WHERE UPPER(WHAT) LIKE 'SCH.MAIN;';
			   
        IF WS_BROKEN = 'Y' THEN
            INSERT INTO LOG_EVENTOS VALUES(SYSDATE , 'REATIVANDO SCH!', 'DWU', 'VRF_SCH', 'ERRO', '0');
            DBMS_JOB.REMOVE(WS_JOB);
			DBMS_JOB.SUBMIT(WS_JOB, 'SCH.MAIN;', SYSDATE, 'SYSDATE + 60/86400');
        END IF;

    ELSE

        INSERT INTO LOG_EVENTOS VALUES(SYSDATE , 'ERRO SEM SCH!' , 'DWU', 'VRF_SCH' , 'ERRO', '0');
		DBMS_JOB.SUBMIT(WS_JOB, 'SCH.MAIN;', SYSDATE, 'SYSDATE + 60/86400');

    END IF;

EXCEPTION
    WHEN WS_OK THEN 
	    NULL;
    WHEN OTHERS THEN
        HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		INSERT INTO LOG_EVENTOS VALUES(SYSDATE , DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, 'DWU', 'VRF_JOB', 'ERRO', '0');
END VERIFICA_JOB;

PROCEDURE REG_PULSE AS

    WS_PENDING      NUMBER;
    WS_STRING       VARCHAR2(1000);
    WS_COMMAND      VARCHAR2(3000);
	WS_ERROR        VARCHAR2(80);

BEGIN

	
	
	WS_COMMAND := 'localhost/update/dwu.renew?prm_par=TIPO|008|CLIENTE|'||FUN.RET_VAR('CLIENTE')||'|CHECK|'||FUN.RET_VAR('TOKEN')||'|CHAVE|'||FUN.CHECK_ID(FUN.RET_VAR('TOKEN'), FUN.RET_VAR('CLIENTE'));

	WS_STRING  := UTL_HTTP.REQUEST(WS_COMMAND);

    WS_STRING := TRIM(REPLACE(WS_STRING,CHR(10),''));

    IF SUBSTR(TRIM(WS_STRING), 1, 6) <> 'CHECK=' THEN
	    IF INSTR(TRIM(WS_STRING), '403') > 0 THEN
		    INSERT INTO LOG_EVENTOS VALUES(SYSDATE, WS_STRING||' SEM PREMISS&Atilde;O!',GBL.GETUSUARIO, 'REG_OFF', 'OFF', '01');
		    COMMIT;
	    ELSE
            INSERT INTO LOG_EVENTOS VALUES(SYSDATE, WS_STRING||' FALHA NO PULSE!',GBL.GETUSUARIO, 'REG_OFF', 'OFF', '01');
		    COMMIT;
		END IF;
    ELSE
	    FCL.PUT_VAR('TOKEN', SUBSTR(WS_STRING, 7, LENGTH(WS_STRING)));
	END IF;

END REG_PULSE;


PROCEDURE PUT_VAR ( PRM_VARIAVEL VARCHAR2 DEFAULT NULL,
                    PRM_CONTEUDO VARCHAR2 DEFAULT NULL ) AS
											  
	WS_COUNT NUMBER;
BEGIN

    BEGIN
        SELECT COUNT(*) INTO WS_COUNT FROM VAR_CONTEUDO WHERE VARIAVEL = PRM_VARIAVEL;
		IF WS_COUNT = 0 THEN
		    INSERT INTO VAR_CONTEUDO VALUES('DWU', PRM_VARIAVEL, SYSDATE, PRM_CONTEUDO, 'N');
            COMMIT;
		ELSE
		    UPDATE VAR_CONTEUDO 
			SET CONTEUDO = PRM_CONTEUDO
			WHERE UPPER(TRIM(VARIAVEL)) = UPPER(TRIM(PRM_VARIAVEL));
			COMMIT;
			
		END IF;
    EXCEPTION WHEN OTHERS THEN
        HTP.P(SQLERRM);
	END;
END PUT_VAR;


PROCEDURE LOGINSCREEN AS

    WS_COR_TELA      VARCHAR2(10);
	WS_URL_TELA      VARCHAR2(400);
    WS_CHAVE         VARCHAR2(100);
BEGIN

    

    


















	


        BEGIN
		    IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
                SELECT NVL(COR_FUNDO, '#FFFFFF'), NVL(URL_FUNDO, FUN.R_GIF('bg','WEBP')) INTO WS_COR_TELA, WS_URL_TELA FROM ALL_SCREENS WHERE SCREEN = 'DEFAULT' AND ROWNUM = 1;
			ELSE	
				SELECT NVL(COR_FUNDO, '#FFFFFF'), NVL(URL_FUNDO, FUN.R_GIF('bg','WEBP')) INTO WS_COR_TELA, WS_URL_TELA FROM ALL_SCREENS WHERE SCREEN = 'DEFAULT' AND ROWNUM = 1;
            END IF;
	    EXCEPTION WHEN OTHERS THEN
            WS_COR_TELA := '#FFFFFF';
			IF INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Safari/') <> 0 THEN
                WS_URL_TELA := FUN.R_GIF('bg','JPG');
			ELSE
                WS_URL_TELA := FUN.R_GIF('bg','WEBP');
			END IF;
        END;
		    HTP.P('<div id="wall">');
				HTP.P('<div id="texto-inicial">');
					HTP.P('<span>CONFIAN&Ccedil;A</span>');
					HTP.P('<span>PARA</span>');
					HTP.P('<span>DECIDIR</span>');
				HTP.P('</div>');
				HTP.P('<div id="login-menu" style="">');
					
					HTP.P('<h1>LOGIN</h1>');
					HTP.P('<form action="login" method="post">');
						
						HTP.P('<span class="input-container">');
							
							HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 412.333 412.333" style="enable-background:new 0 0 412.333 412.333;" xml:space="preserve"> <g> <path d="M206.167,205.333c56.61,0,102.667-46.056,102.667-102.667S262.777,0,206.167,0S103.5,46.056,103.5,102.667 S149.556,205.333,206.167,205.333z M206.167,40c34.554,0,62.667,28.112,62.667,62.667s-28.112,62.667-62.667,62.667 S143.5,137.221,143.5,102.667S171.612,40,206.167,40z"/> <path d="M206.167,223.333c-93.187,0-169,75.813-169,169v20h338v-20C375.167,299.146,299.354,223.333,206.167,223.333z M78.714,372.333c9.637-61.671,63.12-109,127.452-109s117.815,47.329,127.452,109H78.714z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
							HTP.P('<input name="prm_usuario" class="login-session" type="text" required autocomplete="username email" value="" placeholder="'||fun.lang('Usu&aacute;rio ou email')||'" onkeypress="if(event.which == ''13''){ document.querySelectorAll(''.login-session'')[1].focus(); }">');
						HTP.P('</span>');

						HTP.P('<span class="input-container">');
							HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 491.213 491.213" style="enable-background:new 0 0 491.213 491.213;" xml:space="preserve"> <g> <path d="M383.169,66.283c-6.677,0-12.956,2.6-17.677,7.322c-4.722,4.722-7.323,11-7.323,17.678c0,6.677,2.601,12.956,7.323,17.677 c4.722,4.722,11,7.323,17.677,7.323c6.678,0,12.956-2.601,17.678-7.323c4.722-4.722,7.322-11,7.322-17.677 c0-6.678-2.6-12.956-7.322-17.678C396.125,68.883,389.848,66.283,383.169,66.283z"/> <path d="M439.462,34.99C416.898,12.426,386.898,0,354.988,0c-31.91,0-61.91,12.426-84.474,34.99 c-17.276,17.275-28.704,39.072-33.049,63.033c-3.618,19.953-2.156,40.243,4.204,59.273L16.817,382.152l109.061,109.062l63.64-63.64 l-19.434-19.434l21.213-21.213l19.434,19.434l63.64-63.64l-33.576-33.576l76.36-76.36c12.173,4.069,24.869,6.126,37.866,6.126 c31.9,0,61.888-12.42,84.441-34.974C486.041,157.359,486.041,81.569,439.462,34.99z M418.249,182.725 c-16.887,16.887-39.341,26.187-63.228,26.187c-12.363,0-24.352-2.479-35.635-7.369l-9.358-4.056L198.368,309.145l33.576,33.576 l-21.213,21.213L191.297,344.5l-63.639,63.64l19.433,19.434l-21.213,21.213l-66.635-66.635l217.723-217.726l-4.056-9.359 c-14.702-33.924-7.316-72.73,18.817-98.863C308.625,39.306,331.092,30,354.988,30s46.363,9.306,63.26,26.203 C453.131,91.085,453.131,147.843,418.249,182.725z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
							
							HTP.P('<input name="prm_password" class="login-session" type="password" required autocomplete="password" value="" placeholder="'||fun.lang('Senha')||'" onkeypress="if(event.which == ''13''){ login(this.nextElementSibling); }">');
							HTP.P('<svg onclick="if(this.previousElementSibling.type === ''password''){ this.previousElementSibling.type = ''text''; } else { this.previousElementSibling.type = ''password''; }" class="reveal" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 487.55 487.55" style="enable-background:new 0 0 487.55 487.55;" xml:space="preserve"> <g> <g id="XMLID_1992_"> <path id="XMLID_2003_" d="M244.625,171.415c-40,0-72.4,32.4-72.4,72.4s32.4,72.4,72.4,72.4s72.4-32.4,72.4-72.4 C316.925,203.815,284.525,171.415,244.625,171.415z M244.625,220.215c-13,0-23.6,10.6-23.6,23.6c0,6-4.8,10.8-10.8,10.8 s-10.8-4.8-10.8-10.8c0-24.9,20.3-45.2,45.2-45.2c6,0,10.8,4.8,10.8,10.8C255.425,215.415,250.525,220.215,244.625,220.215z"/> <path id="XMLID_2012_" d="M481.325,227.515c-224.8-258.6-428-53.9-476.4,2.8c-6.5,7.6-6.6,18.8-0.1,26.4 c221.9,259,423.4,64.6,476.5,3.7C489.625,251.015,489.625,237.015,481.325,227.515z M244.625,346.615 c-56.8,0-102.8-46-102.8-102.8s46-102.8,102.8-102.8s102.8,46,102.8,102.8S301.325,346.615,244.625,346.615z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
							
							HTP.P('<a class="link" onclick="recoverPassword(this);">'||fun.lang('Esqueceu a senha?')||'</a>');
						HTP.P('</span>');
						
					HTP.P('</form>');
					HTP.P('<span id="qrenviar" onclick="login(this);">Login<a></a></span>');
					
					
					
					
					
				HTP.P('</div>');
			HTP.P('</div>');
		
        
    
	FCL.ALERTA;
    
EXCEPTION WHEN OTHERS THEN
	HTP.P(SQLERRM);
END LOGINSCREEN;

PROCEDURE QRCHECK (  PRM_SESSION VARCHAR2 DEFAULT NULL ) AS
    WS_URL           VARCHAR2(400);
	WS_RESULT        VARCHAR2(4000);
	WS_ERRO          EXCEPTION;
	WS_ERRO_S        EXCEPTION;
BEGIN

    BEGIN
	    WS_URL := 'http://update.upquery.com/update/dwu.check_ac?prm_ping=CHECK_ID&prm_cliente='||FUN.RET_VAR('CLIENTE')||'&prm_session='||PRM_SESSION;
		WS_RESULT := UTL_HTTP.REQUEST(TRIM(WS_URL));
	EXCEPTION WHEN OTHERS THEN
		RAISE WS_ERRO;
	END;

	HTP.P(WS_RESULT);

EXCEPTION
    WHEN WS_ERRO_S THEN
	    HTP.P('SEM PERMISS&Atilde;O');
	WHEN WS_ERRO THEN
	    HTP.P('ERRO '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - QRCHECK', GBL.GETUSUARIO, 'ERRO');
        COMMIT;
	WHEN OTHERS THEN
        HTP.P('ERRO');
END QRCHECK;

PROCEDURE QRMANUAL  ( PRM_SESSION VARCHAR2 DEFAULT NULL,
                      PRM_CHECK   VARCHAR2 DEFAULT NULL ) AS

	WS_URL           VARCHAR2(400);
	WS_CHECK         VARCHAR2(200);
	WS_RESULT        VARCHAR2(4000);
	WS_ERRO          EXCEPTION;

BEGIN

    BEGIN
		
		WS_URL := 'http://update.upquery.com/update/dwu.check_ac?prm_ping=CHECK_ID&prm_check='||PRM_CHECK||'&prm_origem='||PRM_SESSION;
		WS_RESULT := UTL_HTTP.REQUEST(TRIM(WS_URL));
		IF INSTR(WS_RESULT, 'ERRO') = 0 THEN
		    FCL.QRCHECK(PRM_SESSION);
		END IF;
	EXCEPTION WHEN OTHERS THEN
		RAISE WS_ERRO;
	END;

	HTP.P(WS_RESULT);

EXCEPTION
	WHEN WS_ERRO THEN
	    HTP.P('ERRO URL');
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - QRMANUAL', GBL.GETUSUARIO, 'ERRO');
        COMMIT;
	WHEN OTHERS THEN
        HTP.P('ERRO');
END QRMANUAL;

PROCEDURE CHECKPAR ( PRM_VARIAVEL VARCHAR2 DEFAULT NULL,
                     PRM_VISAO    VARCHAR2 DEFAULT NULL ) AS

    WS_VARIAVEL VARCHAR2(120);
    WS_COUNT    NUMBER;
	WS_NOTFOUND EXCEPTION;

BEGIN
    FOR I IN (SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_VARIAVEL))) LOOP
		WS_VARIAVEL := REPLACE(I.COLUMN_VALUE, '$[', '');
		WS_VARIAVEL := REPLACE(WS_VARIAVEL, ']', '');
		SELECT COUNT(*) INTO WS_COUNT FROM PARAMETRO_PADRAO T1, MICRO_COLUNA T2 WHERE T1.CD_PADRAO = WS_VARIAVEL OR (T2.CD_COLUNA = WS_VARIAVEL AND T2.CD_MICRO_VISAO = PRM_VISAO);
		IF WS_COUNT = 0 THEN
		    RAISE WS_NOTFOUND;
			EXIT;
		END IF;
	END LOOP;
EXCEPTION
    WHEN WS_NOTFOUND THEN
	    HTP.P('fail error');
	WHEN OTHERS THEN
	    HTP.P('');
END CHECKPAR;

PROCEDURE ADMIN_OPTIONS AS

	CURSOR CRS_USUARIOS IS
	SELECT USUARIO, MAX(PERMISSAO) AS PERMISSAO FROM (
	    SELECT TRIM(USUARIO) AS USUARIO, LISTAGG(PERMISSAO||'|'||STATUS, '|')  WITHIN GROUP
	    (ORDER BY PERMISSAO) PERMISSAO
		FROM ADMIN_OPTIONS GROUP BY USUARIO
	    UNION
	    SELECT TRIM(USU_NOME) AS USUARIO, '' FROM USUARIOS
	) WHERE USUARIO <> 'DWU' GROUP BY USUARIO ORDER BY USUARIO;

	WS_USUARIO CRS_USUARIOS%ROWTYPE;

	WS_CHECK VARCHAR(20);

BEGIN

    HTP.P('<table class="linha">');
        HTP.P('<thead>');
			HTP.P('<tr>');
			    HTP.P('<th></th>');
				HTP.P('<th colspan="2" style="text-align: center !important;">Drills</th>');
				HTP.P('<th colspan="2" style="text-align: center !important;">'||FUN.LANG('Filtros')||'</th>');
				HTP.P('<th style="text-align: center !important;">'||FUN.LANG('Atributos')||'</th>');
			HTP.P('</tr>');
			HTP.P('<tr>');
			    HTP.P('<th>'||FUN.LANG('Usu&aacute;rio')||'</th>');
			    HTP.P('<th style="font-size: 14px; text-align: center !important;">'||FUN.LANG('Adicionar')||'</th>');
				HTP.P('<th style="font-size: 14px; text-align: center !important;">'||FUN.LANG('Excluir')||'</th>');
				HTP.P('<th style="font-size: 14px; text-align: center !important;">'||FUN.LANG('Adicionar')||'</th>');
				HTP.P('<th style="font-size: 14px; text-align: center !important;">'||FUN.LANG('Excluir')||'</th>');
				HTP.P('<th style="font-size: 14px; text-align: center !important;">'||FUN.LANG('Alterar')||'</th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		OPEN CRS_USUARIOS;
	        LOOP
                FETCH CRS_USUARIOS INTO WS_USUARIO;
                EXIT WHEN CRS_USUARIOS%NOTFOUND;

                HTP.P('<tr>');
				    HTP.P('<td>'||WS_USUARIO.USUARIO||'</td>');

					SELECT DECODE(MAX(CD_CONTEUDO), 'S', 'checked', '') INTO WS_CHECK FROM TABLE(FUN.VPIPE_PAR(NVL(WS_USUARIO.PERMISSAO, 'DRILLS_ADD|N'))) WHERE CD_COLUNA = 'DRILLS_ADD';
					HTP.P('<td><input type="checkbox" '||WS_CHECK||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||WS_USUARIO.USUARIO||'&prm_permissao=DRILLS_ADD'', false);"/></td>');

					SELECT DECODE(MAX(CD_CONTEUDO), 'S', 'checked', '') INTO WS_CHECK FROM TABLE(FUN.VPIPE_PAR(NVL(WS_USUARIO.PERMISSAO, 'DRILLS_EX|N'))) WHERE CD_COLUNA = 'DRILLS_EX';
					HTP.P('<td><input type="checkbox" '||WS_CHECK||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||WS_USUARIO.USUARIO||'&prm_permissao=DRILLS_EX'', false);"/></td>');

					SELECT DECODE(MAX(CD_CONTEUDO), 'S', 'checked', '') INTO WS_CHECK FROM TABLE(FUN.VPIPE_PAR(NVL(WS_USUARIO.PERMISSAO, 'FILTERS_ADD|N'))) WHERE CD_COLUNA = 'FILTERS_ADD';
					HTP.P('<td><input type="checkbox" '||WS_CHECK||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||WS_USUARIO.USUARIO||'&prm_permissao=FILTERS_ADD'', false);"/></td>');

					SELECT DECODE(MAX(CD_CONTEUDO), 'S', 'checked', '') INTO WS_CHECK FROM TABLE(FUN.VPIPE_PAR(NVL(WS_USUARIO.PERMISSAO, 'FILTERS_EX|N'))) WHERE CD_COLUNA = 'FILTERS_EX';
					HTP.P('<td><input type="checkbox" '||WS_CHECK||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||WS_USUARIO.USUARIO||'&prm_permissao=FILTERS_EX'', false);"/></td>');

					SELECT DECODE(MAX(CD_CONTEUDO), 'S', 'checked', '') INTO WS_CHECK FROM TABLE(FUN.VPIPE_PAR(NVL(WS_USUARIO.PERMISSAO, 'ATTRIB_ALT|N'))) WHERE CD_COLUNA = 'ATTRIB_ALT';
					HTP.P('<td><input type="checkbox" '||WS_CHECK||' onchange="ajax(''fly'', ''admin_alter'', ''prm_usuario='||WS_USUARIO.USUARIO||'&prm_permissao=ATTRIB_ALT'', false);"/></td>');

				HTP.P('</tr>');
            END LOOP;
        CLOSE CRS_USUARIOS;
    HTP.P('</table>');
EXCEPTION WHEN OTHERS THEN
    HTP.P(SQLERRM);
END ADMIN_OPTIONS;

PROCEDURE ADMIN_ALTER ( PRM_USUARIO   VARCHAR2 DEFAULT NULL,
                        PRM_PERMISSAO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT  NUMBER;
    WS_STATUS CHAR(1);
	WS_ERRO   EXCEPTION;
    WS_INJECT EXCEPTION;

BEGIN
    IF GBL.GETUSUARIO = FUN.USUARIO THEN
		SELECT COUNT(*) INTO WS_COUNT FROM ADMIN_OPTIONS WHERE USUARIO = PRM_USUARIO AND PERMISSAO = PRM_PERMISSAO;

		IF WS_COUNT = 0 THEN
			INSERT INTO ADMIN_OPTIONS (USUARIO, PERMISSAO, DT_PERMISSAO, STATUS) VALUES (PRM_USUARIO, PRM_PERMISSAO, SYSDATE, 'S');
			COMMIT;
			HTP.P('#alert '||FUN.LANG('Alterado com sucesso')||'!');
		ELSIF WS_COUNT = 1 THEN
			SELECT STATUS INTO WS_STATUS FROM ADMIN_OPTIONS WHERE USUARIO = PRM_USUARIO AND PERMISSAO = PRM_PERMISSAO;
			IF WS_STATUS = 'S' THEN
				UPDATE ADMIN_OPTIONS
				SET STATUS = 'N', DT_PERMISSAO = SYSDATE
				WHERE USUARIO = PRM_USUARIO AND PERMISSAO = PRM_PERMISSAO;
			ELSE
				UPDATE ADMIN_OPTIONS
				SET STATUS = 'S', DT_PERMISSAO = SYSDATE
				WHERE USUARIO = PRM_USUARIO AND PERMISSAO = PRM_PERMISSAO;
			END IF;
			COMMIT;
			HTP.P('#alert '||FUN.LANG('Alterado com sucesso')||'!');
		ELSE
			RAISE WS_ERRO;
		END IF;
	ELSE
	    RAISE WS_INJECT;
	END IF;
EXCEPTION
     WHEN WS_INJECT THEN
	    HTP.P('Usuario sem permiss&atilde;o para essa a&ccedil;&atilde;o!');
    WHEN WS_ERRO THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao alterar permiss&otilde;es, valor duplicado')||'!');
	WHEN OTHERS THEN
	    HTP.P('#alert '||FUN.LANG('Erro ao alterar permiss&otilde;es')||'!');
END ADMIN_ALTER;

PROCEDURE CONDICOES ( PRM_TIPO     VARCHAR2 DEFAULT NULL,
                      PRM_CONDICAO VARCHAR2 DEFAULT NULL ) AS

BEGIN
    
    CASE PRM_TIPO
        WHEN 'simple' THEN
		    HTP.P('<option value="IGUAL">'||FUN.LANG('Igual a')||'</option>');
		    HTP.P('<option value="DIFERENTE">'||FUN.LANG('Diferente de')||'</option>');
		    HTP.P('<option value="MAIOR">'||FUN.LANG('Maior que')||'</option>');
		    HTP.P('<option value="MENOR">'||FUN.LANG('Menor que')||'</option>');
		    HTP.P('<option value="MAIOROUIGUAL">'||FUN.LANG('Maior ou igual a')||'</option>');
		    HTP.P('<option value="MENOROUIGUAL">'||FUN.LANG('Menor ou igual a')||'</option>');
		    HTP.P('<option value="LIKE">'||FUN.LANG('Semelhante a')||'</option>');
		    HTP.P('<option value="NOTLIKE">'||FUN.LANG('Diferente(not like) de')||'</option>');
            HTP.P('<option value="NOFLOAT">'||FUN.LANG('Ignorar float')||'</option>');
        WHEN 'selected' THEN
            IF PRM_CONDICAO = 'DIFERENTE' THEN
			    HTP.P('<option value="DIFERENTE" selected>'||FUN.LANG('Diferente de')||'</option>');
			ELSE
			    HTP.P('<option value="DIFERENTE">'||FUN.LANG('Diferente de')||'</option>');
			END IF;
			IF PRM_CONDICAO = 'IGUAL' THEN
			    HTP.P('<option value="IGUAL" selected>'||FUN.LANG('Igual a')||'</option>');
			ELSE
			    HTP.P('<option value="IGUAL">'||FUN.LANG('Igual a')||'</option>');
			END IF;
			IF PRM_CONDICAO = 'MAIOR' THEN
			    HTP.P('<option value="MAIOR" selected>'||FUN.LANG('Maior que')||'</option>');
			ELSE
			    HTP.P('<option value="MAIOR">'||FUN.LANG('Maior que')||'</option>');
			END IF;
			IF PRM_CONDICAO = 'MENOR' THEN
			    HTP.P('<option value="MENOR" selected>'||FUN.LANG('Menor que')||'</option>');
			ELSE
			    HTP.P('<option value="MENOR">'||FUN.LANG('Menor que')||'</option>');
			END IF;
			IF PRM_CONDICAO = 'MAIOROUIGUAL' THEN
			    HTP.P('<option value="MAIOROUIGUAL" selected>'||FUN.LANG('Maior ou igual a')||'</option>');
			ELSE
			    HTP.P('<option value="MAIOROUIGUAL">'||FUN.LANG('Maior ou igual a')||'</option>');
			END IF;
			IF PRM_CONDICAO = 'MENOROUIGUAL' THEN
			    HTP.P('<option value="MENOROUIGUAL" selected>'||FUN.LANG('Menor ou igual a')||'</option>');
			ELSE
			    HTP.P('<option value="MENOROUIGUAL">'||FUN.LANG('Menor ou igual a')||'</option>');
			END IF;
			IF PRM_CONDICAO = 'LIKE' THEN
			    HTP.P('<option value="LIKE" selected>'||FUN.LANG('Semelhante a')||'</option>');
			ELSE
			    HTP.P('<option value="LIKE">'||FUN.LANG('Semelhante a')||'</option>');
			END IF;
            IF PRM_CONDICAO = 'NOTLIKE' THEN
			    HTP.P('<option value="NOTLIKE" selected>'||FUN.LANG('Diferente(not like) de')||'</option>');
			ELSE
			    HTP.P('<option value="NOTLIKE">'||FUN.LANG('Diferente(not like) de')||'</option>');
			END IF;
            
            IF PRM_CONDICAO = 'NOFLOAT' THEN
                HTP.P('<option value="NOFLOAT" selected>'||FUN.LANG('Ignorar float')||'</option>');
            ELSE
                HTP.P('<option value="NOFLOAT">'||FUN.LANG('Ignorar float')||'</option>');
            END IF;
        ELSE
            HTP.P('');
    END CASE;

END CONDICOES;


PROCEDURE CARREGA_OBJETO ( PRM_TIPO      VARCHAR2 DEFAULT NULL,
                           PRM_POSICAO   VARCHAR2 DEFAULT NULL,
                           PRM_PARAMETRO VARCHAR2 DEFAULT NULL,
                           PRM_VISAO     VARCHAR2 DEFAULT NULL,
                           PRM_COLUNA    VARCHAR2 DEFAULT NULL,
                           PRM_AGRUPADOR VARCHAR2 DEFAULT NULL,
                           PRM_TIP       VARCHAR2 DEFAULT NULL,
                           PRM_OBJ       VARCHAR2 DEFAULT NULL,
                           PRM_SCREEN    VARCHAR2 DEFAULT NULL,
                           PRM_COLUP     VARCHAR2 DEFAULT NULL ) AS

BEGIN

    HTP.P('<div style="display: none;" id="gxml_'||PRM_OBJ||'">');
		FCL.CHAROUT(PRM_PARAMETRO, PRM_VISAO, PRM_OBJ, PRM_SCREEN);
	HTP.P('</div>');

    IF PRM_TIPO IN ('LINHAS','BARRAS', 'COLUNAS') THEN
        HTP.P('<div style="-webkit-overflow-scrolling: touch; overflow-x: auto; height: calc('||FUN.PUT_PAR(PRM_OBJ, 'ALTURA', PRM_TIPO)||'px + 20px);"><div id="ctnr_'||PRM_OBJ||'" class="block-fusion" style="position: relative !important; min-width: inherit; '||PRM_POSICAO||';">'||FUN.LANG('Carregando Informa&ccedil;&otilde;es...Aguarde!')||'</div></div>');
    ELSE
        HTP.P('<div id="ctnr_'||PRM_OBJ||'" class="block-fusion" style="position: relative !important; min-width: inherit; max-width: inherit; '||PRM_POSICAO||';">'||FUN.LANG('Carregando Informa&ccedil;&otilde;es...Aguarde!')||'</div>');
    END IF;

END CARREGA_OBJETO;

PROCEDURE DASHBOARDCOPY ( PRM_DASHBOARD VARCHAR2 DEFAULT NULL, 
                          PRM_ACTUAL    VARCHAR2 DEFAULT NULL ) AS

    WS_ID      VARCHAR2(200);
    WS_ID_ANT  VARCHAR2(200);
    WS_COUNT   NUMBER;
BEGIN
    WS_COUNT := 0;
    FOR I IN(SELECT OBJECT_ID, POSX, POSY, ZINDEX, PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = PRM_DASHBOARD) LOOP
        WS_COUNT := WS_COUNT+1;
        
        
        SELECT 'ARTICLE_'||TRIM((SELECT SID FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||(SELECT SERIAL# FROM V$SESSION WHERE AUDSID = SYS_CONTEXT('userenv','sessionid'))||TO_CHAR(SYSDATE,'yymmddhhmiss'))||WS_COUNT INTO WS_ID FROM DUAL;
        WS_ID_ANT := I.OBJECT_ID;
        
        
        INSERT INTO OBJECT_LOCATION VALUES ('DWU', 'DEFAULT', PRM_ACTUAL, WS_ID, I.POSX, I.POSY, I.ZINDEX, I.PORCENTAGEM);
        
        
        FOR A IN(SELECT OBJECT_ID, POSX, POSY, ZINDEX, PORCENTAGEM FROM OBJECT_LOCATION WHERE SCREEN = WS_ID_ANT) LOOP
            INSERT INTO OBJECT_LOCATION VALUES ('DWU', 'DEFAULT', WS_ID, A.OBJECT_ID, A.POSX, A.POSY, A.ZINDEX, A.PORCENTAGEM);
        END LOOP;
        
    END LOOP;

END DASHBOARDCOPY;

PROCEDURE TITLE_SCREEN ( PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS 

    WS_SCREEN VARCHAR2(2000);
    WS_DESC   VARCHAR2(2000);
    WS_GRUPO  VARCHAR2(40);
	WS_OBS    VARCHAR2(2000);
    WS_PADRAO VARCHAR2(2000);

BEGIN

		WS_PADRAO := GBL.GETLANG;

        SELECT DS_SCREEN, DESCRICAO, DS_OBJETO INTO WS_SCREEN, WS_DESC, WS_OBS
		FROM ALL_SCREENS T1
		LEFT JOIN OBJETOS T2 ON T2.CD_OBJETO = T1.SCREEN
		WHERE TRIM(SCREEN) = TRIM(PRM_SCREEN);
        
        SELECT NM_GRUPO INTO WS_GRUPO FROM GRUPOS_FUNCAO WHERE CD_GRUPO = (SELECT CD_GRUPO FROM OBJETOS WHERE TRIM(CD_OBJETO) = TRIM(PRM_SCREEN));
			
		
		HTP.PRN('<span>'||NVL(TRIM(FUN.SUBPAR(WS_SCREEN, TRIM(PRM_SCREEN))), ''||FUN.UTRANSLATE('NM_GRUPO', 'GRUPOS_FUNCAO', WS_GRUPO, WS_PADRAO)||' - '||FUN.UTRANSLATE('NM_OBJETO', PRM_SCREEN, WS_DESC, WS_PADRAO)||'')||'</span>');
 
		IF NVL(WS_OBS, 'N/A') <> 'N/A' THEN
			HTP.P('<a title="'||FUN.LANG('Informa&ccedil;&atilde;o da tela')||'" data-obs="<h4>'||FUN.LANG('Observa&ccedil;&otilde;es da tela')||'</h4><span>'||FUN.SUBPAR(WS_OBS, PRM_SCREEN)||'</span>" onclick="closeSideBar(''obs-field''); screenObs();"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 490.667 490.667" style="enable-background:new 0 0 490.667 490.667;" xml:space="preserve"> <g> <g> <path d="M245.333,0C110.059,0,0,110.059,0,245.333s110.059,245.333,245.333,245.333s245.333-110.059,245.333-245.333 S380.608,0,245.333,0z M245.333,469.333c-123.52,0-224-100.48-224-224s100.48-224,224-224s224,100.48,224,224 S368.853,469.333,245.333,469.333z"/> </g> </g> <g> <g> <path d="M245.333,106.667c-41.173,0-74.667,33.493-74.667,74.667v21.333c0,5.888,4.779,10.667,10.667,10.667 S192,208.555,192,202.667v-21.333C192,151.936,215.915,128,245.333,128c29.419,0,53.333,23.936,53.333,53.333v16.149 c0,14.251-5.547,27.648-15.637,37.739l-26.496,26.496c-14.101,14.123-21.867,32.853-21.867,52.8v16.149 c0,5.888,4.779,10.667,10.667,10.667S256,336.555,256,330.667v-16.149c0-14.251,5.547-27.648,15.637-37.739l26.496-26.496 C312.235,236.16,320,217.429,320,197.483v-16.149C320,140.16,286.507,106.667,245.333,106.667z"/> </g> </g> <g> <g> <path d="M245.333,362.667C233.557,362.667,224,372.245,224,384c0,11.755,9.557,21.333,21.333,21.333s21.333-9.579,21.333-21.333 C266.667,372.245,257.109,362.667,245.333,362.667z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
		END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('');
END TITLE_SCREEN;

PROCEDURE OBJ_SCREEN_COUNT ( PRM_SCREEN VARCHAR2 DEFAULT NULL,
                             PRM_TIPO   VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER := 0;

BEGIN
    IF PRM_TIPO = 'FLOAT' THEN
        SELECT COUNT(*) INTO WS_COUNT FROM (SELECT OBJECT_ID AS OBJ, SCREEN AS TELA, (SELECT TP_OBJETO FROM OBJETOS WHERE CD_OBJETO = OBJECT_ID) AS TIPO FROM OBJECT_LOCATION) WHERE TRIM(TELA) = TRIM(PRM_SCREEN) AND TRIM(TIPO) IN ('FLOAT_PAR', 'FLOAT_FILTER');
    ELSIF PRM_TIPO = 'FAVORITOS' THEN
         SELECT COUNT(*) INTO WS_COUNT FROM FAVORITOS WHERE SCREEN = PRM_SCREEN AND USUARIO = GBL.GETUSUARIO;
    ELSE
        SELECT COUNT(*) INTO WS_COUNT FROM (SELECT OBJECT_ID AS OBJ, SCREEN AS TELA, (SELECT TP_OBJETO FROM OBJETOS WHERE CD_OBJETO = OBJECT_ID) AS TIPO FROM OBJECT_LOCATION) WHERE TRIM(TELA) = TRIM(PRM_SCREEN) AND TRIM(TIPO) = TRIM(PRM_TIPO);
    END IF;

    HTP.P(WS_COUNT);
EXCEPTION WHEN OTHERS THEN
    HTP.P('0');
END OBJ_SCREEN_COUNT;

PROCEDURE PADRAO_COLUNAS (  PRM_TABELA      VARCHAR2,
							PRM_MICRO_VISAO VARCHAR2 )	AS 

    CURSOR CRS_COLS IS
	
	    SELECT
			COLUMN_NAME, PF.TP_LOV, PF.CD_PREFIXO, SUBSTR(COLUMN_NAME, LENGTH(PF.CD_PREFIXO)+1, 9999) AS COLUNA, NVL(PF.CD_AGRUPADOR, 'SEM') AS CD_AGRUPADOR, NVL(PF.CD_MASCARA, 'SEM') AS CD_MASCARA, PF.ALINHAMENTO
        FROM ALL_TAB_COLUMNS TB
            LEFT JOIN CODIGO_DESCRICAO DS ON DS.NDS_TFISICA = TB.TABLE_NAME 
            LEFT JOIN PREFIXO_PADRAO   PF ON  PF.CD_PREFIXO = SUBSTR(TB.COLUMN_NAME, 1, 3)
            WHERE OWNER = 'DWU' AND TABLE_NAME = PRM_TABELA AND COLUMN_NAME NOT IN(SELECT CD_COLUNA FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_MICRO_VISAO); 

        WS_COLS     CRS_COLS%ROWTYPE;

    BEGIN
	
	    OPEN CRS_COLS;
			
		    LOOP
			    FETCH CRS_COLS INTO WS_COLS;
				EXIT WHEN CRS_COLS%NOTFOUND;		
				
					IF WS_COLS.CD_PREFIXO <> 'NULL' THEN
					
						INSERT INTO MICRO_COLUNA (CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, ROTULO_C, COLOR, HINT, FLEXCOL, URL )
										VALUES (PRM_MICRO_VISAO,WS_COLS.COLUMN_NAME, REPLACE(SUBSTR(WS_COLS.COLUMN_NAME,LENGTH(WS_COLS.CD_PREFIXO)+1,LENGTH(WS_COLS.COLUMN_NAME)),'_',' '),
						'S', WS_COLS.CD_AGRUPADOR, WS_COLS.CD_MASCARA, 'SEM', 'N', WS_COLS.ALINHAMENTO, 'N', 'S', 'N', '', '', 'T', '', '', '', '', '');
								
					END IF;
					
					IF WS_COLS.CD_PREFIXO IS NULL THEN
					
						INSERT INTO MICRO_COLUNA (CD_MICRO_VISAO, CD_COLUNA, NM_ROTULO, ST_GERA_REL, ST_AGRUPADOR, NM_MASCARA, CD_LIGACAO, ST_COM_CODIGO, ST_ALINHAMENTO, ST_RESUMIDO, ST_NEGRITO, ST_INVISIVEL, NM_UNIDADE, FORMULA, TIPO, ROTULO_C, COLOR, HINT, FLEXCOL, URL )
									VALUES (PRM_MICRO_VISAO,WS_COLS.COLUMN_NAME, WS_COLS.COLUMN_NAME, 
						'S', WS_COLS.CD_AGRUPADOR, WS_COLS.CD_MASCARA, 'SEM', 'N', WS_COLS.ALINHAMENTO, 'N', 'S', 'N', '', '', 'T', '', '', '', '', '');
			
							
					END IF;						
				
		    END LOOP;

        CLOSE CRS_COLS;
		
		COMMIT;


    EXCEPTION
        WHEN OTHERS THEN
            HTP.P(SQLERRM);
		
END PADRAO_COLUNAS;









































































PROCEDURE PREFIXO_LISTA AS

    CURSOR CRS_PREFIXOS IS
    SELECT CD_PREFIXO, TP_LOV, PREFIXO_LOV, CD_AGRUPADOR, CD_MASCARA, ALINHAMENTO
    FROM PREFIXO_PADRAO;

    WS_PREFIXO CRS_PREFIXOS%ROWTYPE;

    WS_EVENTO VARCHAR2(2000);

BEGIN


    HTP.P('<table class="linha">');
        HTP.P('<thead>');
            HTP.P('<tr>');
                HTP.P('<th>'||FUN.LANG('Prefixo')||'</th>');
                HTP.P('<th>'||FUN.LANG('Tipo lov')||'</th>');
				HTP.P('<th>'||FUN.LANG('Prefixo lov')||'</th>');
				HTP.P('<th>'||FUN.LANG('Agrupador')||'</th>');
				HTP.P('<th>'||FUN.LANG('M&aacute;scara')||'</th>');
                HTP.P('<th>'||FUN.LANG('Alinhamento')||'</th>');
                HTP.P('<th></th>');
            HTP.P('</tr>');
        HTP.P('</thead>');
        HTP.P('<tbody>');
		    OPEN CRS_PREFIXOS;
		        LOOP
	                FETCH CRS_PREFIXOS INTO WS_PREFIXO;
			        EXIT WHEN CRS_PREFIXOS%NOTFOUND;
			        
			            HTP.P('<tr>');
                            HTP.P('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||WS_PREFIXO.CD_PREFIXO||'" type="text" value="'||WS_PREFIXO.CD_PREFIXO||'" palceholder="'||FUN.LANG('prefixo')||'" /></td>');
							HTP.P('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||WS_PREFIXO.TP_LOV||'" type="text" value="'||WS_PREFIXO.TP_LOV||'" palceholder="'||FUN.LANG('prefixo')||'" /></td>');
							HTP.P('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||WS_PREFIXO.PREFIXO_LOV||'" type="text" value="'||WS_PREFIXO.PREFIXO_LOV||'" palceholder="'||FUN.LANG('prefixo')||'" /></td>');
							HTP.P('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||WS_PREFIXO.CD_AGRUPADOR||'" type="text" value="'||WS_PREFIXO.CD_AGRUPADOR||'" palceholder="'||FUN.LANG('prefixo')||'" /></td>');
							HTP.P('<td><input onchange="savePrefixo(this, ''edit'');" onblur="savePrefixo(this, ''edit'');" data-ant="'||WS_PREFIXO.CD_MASCARA||'" type="text" value="'||WS_PREFIXO.CD_MASCARA||'" palceholder="'||FUN.LANG('prefixo')||'" /></td>');
							HTP.P('<td>');
                                HTP.P('<select onchange="savePrefixo(this, ''edit'');" data-ant="'||WS_PREFIXO.ALINHAMENTO||'">');
                                    HTP.P('<option value="LEFT">'||FUN.LANG('esquerda')||'</option>');
                                    IF WS_PREFIXO.ALINHAMENTO = 'CENTER' THEN
                                        HTP.P('<option value="CENTER" selected>'||FUN.LANG('centro')||'</option>');
                                    ELSE
                                        HTP.P('<option value="CENTER">'||FUN.LANG('centro')||'</option>');
                                    END IF; 
                                    IF WS_PREFIXO.ALINHAMENTO = 'RIGHT' THEN
                                        HTP.P('<option value="RIGHT" selected>'||FUN.LANG('direita')||'</option>');
                                    ELSE
                                        HTP.P('<option value="RIGHT">'||FUN.LANG('direita')||'</option>');
                                    END IF;
                                HTP.P('</select>');
                            HTP.P('</td>');
							HTP.P('<td><a class="remove" onclick="this.parentNode.remove();">X</a></td>');
	                    HTP.P('</tr>');
			        END LOOP;
		    CLOSE CRS_PREFIXOS;
        HTP.P('</tbody>');
    HTP.P('</table>');
END PREFIXO_LISTA;

PROCEDURE PREFIXO_ALTER ( PRM_PREFIXO         VARCHAR2 DEFAULT NULL, 
                          PRM_LOV             VARCHAR2 DEFAULT NULL,
                          PRM_LOVP            VARCHAR2 DEFAULT NULL,
                          PRM_AGRUPADOR       VARCHAR2 DEFAULT NULL,
                          PRM_MASCARA         VARCHAR2 DEFAULT NULL,
                          PRM_ALINHAMENTO     VARCHAR2 DEFAULT NULL,
                          PRM_PREFIXO_ANT     VARCHAR2 DEFAULT NULL, 
                          PRM_LOV_ANT         VARCHAR2 DEFAULT NULL,
                          PRM_LOVP_ANT        VARCHAR2 DEFAULT NULL,
                          PRM_AGRUPADOR_ANT   VARCHAR2 DEFAULT NULL,
                          PRM_MASCARA_ANT     VARCHAR2 DEFAULT NULL,
                          PRM_ALINHAMENTO_ANT VARCHAR2 DEFAULT NULL,
                          PRM_EVENTO          VARCHAR2 DEFAULT NULL ) AS

BEGIN

    CASE PRM_EVENTO
        WHEN 'edit' THEN
            UPDATE PREFIXO_PADRAO SET 
	            CD_PREFIXO   = PRM_PREFIXO, 
	            TP_LOV       = PRM_LOV,
	            PREFIXO_LOV  = PRM_LOVP,
	            CD_AGRUPADOR = PRM_AGRUPADOR,
	            CD_MASCARA   = PRM_MASCARA,
	            ALINHAMENTO  = PRM_ALINHAMENTO
	        WHERE
	            CD_PREFIXO   = PRM_PREFIXO_ANT AND
	            TP_LOV       = PRM_LOV_ANT AND
	            PREFIXO_LOV  = PRM_LOVP_ANT AND
	            CD_AGRUPADOR = PRM_AGRUPADOR_ANT AND
	            CD_MASCARA   = PRM_MASCARA_ANT AND
	            ALINHAMENTO  = PRM_ALINHAMENTO_ANT;
        WHEN 'remove' THEN
            DELETE FROM PREFIXO_PADRAO
            WHERE 
                CD_PREFIXO   = PRM_PREFIXO_ANT AND
                TP_LOV       = PRM_LOV_ANT AND
                PREFIXO_LOV  = PRM_LOVP_ANT AND
                CD_AGRUPADOR = PRM_AGRUPADOR_ANT AND
                CD_MASCARA   = PRM_MASCARA_ANT AND
                ALINHAMENTO  = PRM_ALINHAMENTO_ANT;
        WHEN 'add' THEN
            INSERT INTO PREFIXO_PADRAO (
                CD_PREFIXO, TP_LOV, PREFIXO_LOV, CD_AGRUPADOR, CD_MASCARA, ALINHAMENTO 
            ) VALUES (
                PRM_PREFIXO, PRM_LOV, PRM_LOVP, PRM_AGRUPADOR, PRM_MASCARA, PRM_ALINHAMENTO 
            );
    END CASE;
    COMMIT;
    HTP.P('ok');
EXCEPTION WHEN OTHERS THEN
    HTP.P('fail');
END PREFIXO_ALTER;


PROCEDURE REMOVE_COLUNA ( PRM_VISAO VARCHAR2 DEFAULT NULL ) AS

    WS_TABELA VARCHAR2(200);

BEGIN

    FOR X IN(
		SELECT CD_COLUNA FROM MICRO_COLUNA T1 WHERE TIPO = 'T' AND 
		CD_MICRO_VISAO = PRM_VISAO AND 
		TRIM(CD_COLUNA) NOT IN ( 
			SELECT TRIM(COLUMN_NAME) FROM ALL_TAB_COLUMNS WHERE TRIM(TABLE_NAME) IN (SELECT NM_TABELA FROM MICRO_VISAO WHERE NM_MICRO_VISAO = PRM_VISAO ) 
		) 
	) LOOP
        DELETE FROM MICRO_COLUNA WHERE TRIM(CD_COLUNA) = TRIM(X.CD_COLUNA) AND CD_MICRO_VISAO = PRM_VISAO;
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Coluna '||TRIM(X.CD_COLUNA)||' excluida automaticamente da view '||PRM_VISAO, GBL.GETUSUARIO, 'EVENTO');
    END LOOP;
    
    COMMIT;
    
EXCEPTION WHEN OTHERS THEN
    ROLLBACK;
END REMOVE_COLUNA;


PROCEDURE FAKEOPTION ( PRM_ID          VARCHAR2 DEFAULT NULL,
	                   PRM_PLACEHOLDER VARCHAR2 DEFAULT NULL,
	                   PRM_VALOR       VARCHAR2 DEFAULT NULL,
	                   PRM_OPCAO       VARCHAR2 DEFAULT NULL,
                       PRM_EDITABLE    VARCHAR2 DEFAULT NULL,
                       PRM_MULTI       VARCHAR2 DEFAULT NULL,
                       PRM_VISAO       VARCHAR2 DEFAULT NULL,
                       PRM_FIXED       VARCHAR2 DEFAULT NULL,
                       PRM_ADICIONAL   VARCHAR2 DEFAULT NULL,
                       PRM_DESC        VARCHAR2 DEFAULT NULL,
					   PRM_REVERSE     VARCHAR2 DEFAULT NULL,
					   PRM_CHILDREN    VARCHAR2 DEFAULT NULL,
					   PRM_MIN         NUMBER   DEFAULT NULL,
					   PRM_ENCODE      VARCHAR2  DEFAULT 'N',
					   PRM_IMG         VARCHAR2 DEFAULT NULL ) AS

    WS_EDITABLE    VARCHAR2(120);
    WS_FOCUS       VARCHAR2(120) := '';
    WS_INPUTABLE   VARCHAR2(120);
    WS_BLURCLICK   VARCHAR2(120);
    WS_MULTI_CLASS VARCHAR2(200);
	WS_LEAVE       VARCHAR2(800);
	WS_PROPAGATION VARCHAR2(200);
	WS_IMG         VARCHAR2(200);

BEGIN

    IF NVL(PRM_VALOR, 'N/A') = 'N/A' THEN
        WS_FOCUS := 'onfocus="if(this.innerHTML == '''||PRM_PLACEHOLDER||'''){ this.innerHTML = ''''; }"';
    END IF;

	IF NVL(PRM_IMG, 'N/A') <> 'N/A' THEN
        WS_IMG := PRM_IMG;
		WS_MULTI_CLASS := WS_MULTI_CLASS||' img';
	END IF;

    IF PRM_EDITABLE = 'S' THEN
        
		WS_EDITABLE := 'style="cursor: pointer;"';
        WS_INPUTABLE := 'true';
        WS_BLURCLICK := 'true';
		
        WS_LEAVE     := '';
	ELSE
	    WS_INPUTABLE := 'false';
		WS_BLURCLICK := 'false';
        WS_EDITABLE := 'style="cursor: pointer;"';
    END IF;
    
    IF PRM_MULTI = 'S' THEN
        WS_MULTI_CLASS := WS_MULTI_CLASS||' multi';
		
    END IF;
    
	
    
    
	
	
	
	
	
	
	
	

	HTP.P('<span style="'||WS_IMG||'" class="fakeoption'||WS_MULTI_CLASS||'" data-editable="'||PRM_EDITABLE||'" data-default="'||PRM_VALOR||'" data-ant="" title="'||PRM_VALOR||'" id="'||PRM_ID||'" data-adicional="'||PRM_ADICIONAL||'" data-opcao="'||PRM_OPCAO||'" data-visao="'||PRM_VISAO||'" data-reverse="'||PRM_REVERSE||'" data-children="'||PRM_CHILDREN||'" data-min="'||PRM_MIN||'" data-encode="'||PRM_ENCODE||'" '||WS_LEAVE||'>');
		HTP.P('<span class="input" '||WS_EDITABLE||' spellcheck="false" data-fixed="'||PRM_FIXED||'" data-custom="N" data-placeholder="'||PRM_PLACEHOLDER||'">'||NVL(PRM_DESC, NVL(NVL(PRM_FIXED, PRM_VALOR), PRM_PLACEHOLDER))||'</span>');
	    HTP.P('<svg class="down" xmlns="http://www.w3.org/2000/svg" width="292.362" height="292.362" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg>'); 
		HTP.P('<ul class="fakelistbox" onclick="'||WS_PROPAGATION||'"></ul>');
	    HTP.P('<svg class="load" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 462.088 462.088"><path d="M417.041 202.182c-7.483 0-13.896-5.345-16.034-12.827-18.172-80.171-88.723-136.826-172.101-136.826S74.977 109.184 56.805 189.355c-2.138 8.552-10.689 13.896-19.241 11.758s-13.896-10.689-11.758-19.241c21.379-95.137 105.826-161.411 203.1-161.411s181.721 66.275 203.1 161.411c2.138 8.552-3.207 17.103-11.758 19.241-1.069 0-2.138 1.069-3.207 1.069z" fill="#231f20"/><path d="M422.386 206.458c-2.138 0-4.276 0-6.414-1.069l-55.585-23.517c-8.552-3.207-11.758-12.827-8.552-21.379s12.827-11.758 21.379-8.552l40.62 17.103 17.103-40.62c3.207-8.552 12.827-11.758 21.379-8.552s11.758 12.827 8.552 21.379l-23.517 55.585c-2.138 4.276-4.276 7.483-8.552 8.552-2.137 1.07-4.275 1.07-6.413 1.07zM232.113 441.627c-97.274 0-181.721-66.275-203.1-161.411-2.138-8.552 3.207-17.103 11.758-19.241s17.103 3.207 19.241 11.758c18.172 80.171 88.723 136.826 172.101 136.826s153.929-56.654 172.101-136.826c2.138-8.552 10.689-13.896 19.241-11.758s13.896 10.69 11.758 19.241c-21.379 95.136-104.757 161.411-203.1 161.411z" fill="#231f20"/><path d="M16.185 343.284c-2.138 0-4.276 0-6.414-1.069-8.552-3.207-11.758-12.827-8.552-21.379l23.517-55.585c3.207-8.552 12.827-11.758 21.379-8.552l55.585 23.517c8.552 3.207 11.758 12.827 8.552 21.379-3.207 8.552-12.827 11.758-21.379 8.552l-40.62-17.103-17.103 39.55c-2.137 6.414-8.551 10.69-14.965 10.69z" fill="#231f20"/></svg>');
		IF PRM_MULTI = 'S' THEN
		    HTP.P('<a class="multi"></a>');
		END IF;
	HTP.P('</span>');

END FAKEOPTION;



PROCEDURE CHAROUT ( PRM_PARAMETROS    VARCHAR2 DEFAULT NULL,
				    PRM_MICRO_VISAO   VARCHAR2 DEFAULT NULL,
				    PRM_OBJETO        VARCHAR2 DEFAULT NULL,
				    PRM_SCREEN        VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_COLSB IS
		SELECT COLUMN_VALUE AS CD_COLUNA
		FROM TABLE(FUN.VPIPE((SELECT CS_AGRUPADOR||'|'||FUN.GETPROP(PRM_OBJETO, 'SEC') FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_OBJETO)))
		WHERE TRIM(COLUMN_VALUE) IS NOT NULL;

	WS_COLSB CRS_COLSB%ROWTYPE;
	
	CURSOR CRS_MICRO_VISAO IS
		SELECT RTRIM(CD_GRUPO_FUNCAO) AS CD_GRUPO_FUNCAO
		FROM MICRO_VISAO WHERE NM_MICRO_VISAO = PRM_MICRO_VISAO;

	WS_MICRO_VISAO CRS_MICRO_VISAO%ROWTYPE;

	CURSOR CRS_DESTAQUES(PRM_USUARIO VARCHAR2) IS
			SELECT CD_COLUNA, CONDICAO, CONTEUDO, COR_FUNDO, COR_FONTE, TIPO_DESTAQUE
			FROM DESTAQUE 
			WHERE (CD_USUARIO = PRM_USUARIO OR CD_USUARIO = 'DWU') AND CD_OBJETO = PRM_OBJETO
			ORDER BY PRIORIDADE DESC;
			
			WS_DESTAQUE CRS_DESTAQUES%ROWTYPE;

	TYPE WS_TMCOLUNAS IS TABLE OF MICRO_COLUNA%ROWTYPE
	INDEX BY PLS_INTEGER;

	TYPE GENERIC_CURSOR IS REF CURSOR;

	CRS_SAIDA   GENERIC_CURSOR;

	CURSOR NC_COLUNAS IS  SELECT * FROM MICRO_COLUNA WHERE CD_MICRO_VISAO = PRM_MICRO_VISAO;

	RET_COLUNA       VARCHAR2(400);
	RET_MCOL         WS_TMCOLUNAS;
	WS_NCOLUMNS      DBMS_SQL.VARCHAR2_TABLE;
	WS_COLUNA_ANT    DBMS_SQL.VARCHAR2_TABLE;
	WS_PVCOLUMNS     DBMS_SQL.VARCHAR2_TABLE;
	WS_MFILTRO       DBMS_SQL.VARCHAR2_TABLE;
	WS_VCOL          DBMS_SQL.VARCHAR2_TABLE;
	WS_VCON          DBMS_SQL.VARCHAR2_TABLE;
	WS_DADOS_ARR     DBMS_SQL.NUMBER_TABLE;
	WS_GRUPOS_ARR    DBMS_SQL.VARCHAR2_TABLE;
	WS_LQUERY        NUMBER;
	WS_VALOR         NUMBER;
	WS_VALOR_CHAR    VARCHAR2(32000);
	WS_COUNTER       NUMBER := 0;
	WS_CTX           NUMBER := 0;
	WS_SCOL          NUMBER := 0;
	WS_XCOUNT        NUMBER := 0;
	WS_MULTI         NUMBER := 0;
	WS_CT_AGRUPADOR  NUMBER := 0;
	WS_URL_DEFAULT   LONG;
	WS_COLUP         LONG;
	WS_COLUNA        LONG;
	WS_AGRUPADOR     LONG;
	WS_RP            LONG;
	WS_PARAMETROS    LONG;
	WS_PERC_COL      LONG;
	WS_FIND_COL      LONG;
	WS_CURSOR        INTEGER;
	WS_LINHAS        INTEGER;
	WS_QUERY_MONTADA DBMS_SQL.VARCHAR2A;
	WS_QUERY_PIVOT   LONG;
	WS_SQL           LONG;
	WS_MODE          VARCHAR2(40);
	WS_VAZIO         BOOLEAN := TRUE;
	WS_NODATA        EXCEPTION;
	WS_DATASETS      DBMS_SQL.CLOB_TABLE;
	WS_DATASETS_CD   DBMS_SQL.CLOB_TABLE;
	WS_COUNT         NUMBER;
	WS_COLUNA_NEW    CLOB;
	WS_LABEL         CLOB;
	WS_COD           CLOB;
	WS_LABELC        NUMBER;
	WS_CAB_CROSS     CLOB;
    WS_AMOSTRA       NUMBER := 0;
	WS_QUERYOC	     CLOB;
	WS_QUBE          VARCHAR2(2000);
	WS_DESTAQUES     VARCHAR2(4000);
	WS_COUNT_DESTAQUE NUMBER;
	WS_ACUMULADO      NUMBER;
	WS_ACUMULADO_TEXT VARCHAR2(800);     
	WS_ID             NUMBER := 0;
	WS_USUARIO        VARCHAR2(80);
	WS_PADRAO         VARCHAR2(80) := 'PORTUGUESE';
	ws_tipo			  varchar2(80) := '';
	ws_tam_desc_label	number;

BEGIN

    
	    WS_USUARIO := GBL.GETUSUARIO;
	
	begin

		ws_tam_desc_label:= trunc(trim(fun.getProp(prm_objeto,'TAM_DESC_LABEL_GRAFICO',prm_screen,'DWU','')),0);

	exception

	  when others then

		ws_tam_desc_label:=0;

	end;


	if nvl(ws_tam_desc_label,0) = 0 then

		ws_tam_desc_label := 40;

	end if;
		


	WS_PADRAO := GBL.GETLANG;

    SELECT CS_COLUNA INTO WS_COLUNA FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_OBJETO;

	SELECT CS_AGRUPADOR||'|'||FUN.GETPROP(PRM_OBJETO, 'SEC') INTO WS_AGRUPADOR FROM PONTO_AVALIACAO WHERE CD_PONTO = PRM_OBJETO;
    
    /*if instr(WS_AGRUPADOR, '|') = length(WS_AGRUPADOR) then
        WS_AGRUPADOR := SUBSTR(WS_AGRUPADOR, 1, length(WS_AGRUPADOR)-1);
    end if;*/
	
    WS_RP        := 'GRUPO';
    WS_COLUP     := '';

    OPEN CRS_MICRO_VISAO;
    FETCH CRS_MICRO_VISAO INTO WS_MICRO_VISAO;
    CLOSE CRS_MICRO_VISAO;

    WS_PARAMETROS := PRM_PARAMETROS;

	
    OPEN NC_COLUNAS;
        LOOP
            FETCH NC_COLUNAS BULK COLLECT INTO RET_MCOL LIMIT 600;
            EXIT WHEN NC_COLUNAS%NOTFOUND;
        END LOOP;
    CLOSE NC_COLUNAS;

    OPEN CRS_COLSB;
        LOOP
            FETCH CRS_COLSB INTO WS_COLSB;
            EXIT WHEN CRS_COLSB%NOTFOUND;

            WS_CTX := WS_CTX + 1;
            WS_DATASETS(WS_CTX) := REPLACE(FUN.UTRANSLATE('NM_ROTULO', PRM_MICRO_VISAO, FUN.CHECK_ROTULOC(WS_COLSB.CD_COLUNA,PRM_MICRO_VISAO, PRM_SCREEN), WS_PADRAO), '<BR>', ' ');
			WS_DATASETS_CD(WS_CTX) := WS_COLSB.CD_COLUNA;


        END LOOP;
    CLOSE CRS_COLSB;
    
    
    LOOP
        WS_COUNTER := WS_COUNTER + 1;
        IF WS_COUNTER > RET_MCOL.COUNT THEN
            EXIT;
        END IF;
        IF RTRIM(RET_MCOL(WS_COUNTER).ST_AGRUPADOR) <> 'SEM' AND FUN.SETEM(WS_AGRUPADOR,RTRIM(RET_MCOL(WS_COUNTER).CD_COLUNA)) THEN
            WS_SCOL := WS_SCOL + 1;
        END IF;
		
    END LOOP;

    
    WS_AMOSTRA := TO_NUMBER(NVL(FUN.GETPROP(PRM_OBJETO,'AMOSTRA'), '0'));
	
	
    BEGIN
		WS_SQL := CORE.MONTA_QUERY_DIRECT(PRM_MICRO_VISAO, WS_COLUNA, WS_PARAMETROS, WS_RP, WS_COLUP, WS_QUERY_PIVOT, WS_QUERY_MONTADA, WS_LQUERY, WS_NCOLUMNS, WS_PVCOLUMNS, WS_AGRUPADOR, WS_MFILTRO, PRM_OBJETO, PRM_ORDEM => 'Y', PRM_SCREEN => PRM_SCREEN, PRM_CROSS => 'N', PRM_CAB_CROSS => WS_CAB_CROSS);
    END;
	
	WS_QUERYOC := '';

	
	BEGIN
		WS_COUNTER := 0;
		LOOP
			WS_COUNTER := WS_COUNTER + 1;
			IF  WS_COUNTER > WS_QUERY_MONTADA.COUNT THEN
				EXIT;
			END IF;
			WS_QUERYOC := WS_QUERYOC||WS_QUERY_MONTADA(WS_COUNTER);
		END LOOP;

	END;

	
	WS_CURSOR := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE( C => WS_CURSOR, STATEMENT => WS_QUERY_MONTADA, LB => 1, UB => WS_LQUERY, LFFLG => TRUE, LANGUAGE_FLAG => DBMS_SQL.NATIVE );
	WS_SQL := CORE.BIND_DIRECT(WS_PARAMETROS, WS_CURSOR, '', PRM_OBJETO, PRM_MICRO_VISAO, PRM_SCREEN );

	BEGIN
		WS_COUNTER := 0;
		LOOP
			WS_COUNTER := WS_COUNTER + 1;
			IF WS_COUNTER > WS_NCOLUMNS.COUNT  THEN
				EXIT;
			END IF;
			DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, WS_COUNTER, RET_COLUNA, 200);
		END LOOP;
		WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);
	END;
	
    WS_COUNTER := 0;
    LOOP
        WS_COUNTER := WS_COUNTER + 1;
        IF WS_COUNTER > RET_MCOL.COUNT OR WS_NCOLUMNS(1) = RET_MCOL(WS_COUNTER).CD_COLUNA THEN
            EXIT;
        END IF;
    END LOOP;

    WS_PERC_COL := '';

    SELECT COUNT(*) INTO WS_MULTI
    FROM TABLE(FUN.VPIPE(WS_AGRUPADOR))
    WHERE TRIM(COLUMN_VALUE) IS NOT NULL;
	

	WS_PARAMETROS := FUN.CHECK_VALUE(WS_PARAMETROS);
	WS_COLUNA := FUN.CHECK_VALUE(WS_COLUNA);
	WS_COUNT := 0;
	WS_ACUMULADO := 0;

	select TP_OBJETO into ws_tipo from objetos where cd_objeto = prm_objeto;
	

	HTP.PRN('<span class="json">');
    
		LOOP
            

			



			WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
            IF WS_LINHAS = 1 THEN
                WS_VAZIO := FALSE;
            ELSE
                IF WS_VAZIO = TRUE THEN
                    DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
                    RAISE WS_NODATA;
                END IF;
                EXIT;
            END IF;

			
			IF WS_COUNT < WS_AMOSTRA OR WS_AMOSTRA = 0 THEN
			    WS_ID := WS_ID+1;
			    HTP.PRN('"'||WS_ID||'": {');
			END IF;

			WS_COUNT := WS_COUNT + 1;
			
			WS_XCOUNT  := 0;
			WS_CTX     := 0;
            WS_XCOUNT := WS_XCOUNT + 1;
			WS_CTX     := WS_CTX    + 1;
			
			BEGIN
                DBMS_SQL.COLUMN_VALUE(WS_CURSOR, WS_XCOUNT, RET_COLUNA);
            EXCEPTION WHEN OTHERS THEN
                EXIT;
            END;
            WS_PERC_COL := RET_COLUNA;
            WS_FIND_COL := WS_PERC_COL;

            
			IF WS_MULTI < 2 THEN
				WS_XCOUNT := WS_XCOUNT + 1;
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, WS_XCOUNT, RET_COLUNA);
			END IF;

			IF RET_MCOL(WS_COUNTER).CD_LIGACAO <> 'SEM' THEN
				WS_XCOUNT := WS_XCOUNT + 1;
				WS_PERC_COL := RET_COLUNA;
				DBMS_SQL.COLUMN_VALUE(WS_CURSOR, WS_XCOUNT, RET_COLUNA);
			END IF;

			
            IF WS_MULTI > 1 THEN
			
				
				IF WS_COUNT <= WS_AMOSTRA OR WS_AMOSTRA = 0 THEN
				    HTP.PRN('"cod": "'||REPLACE(WS_FIND_COL, '|', '')||'", ');
					
					HTP.PRN('"colunas": "'||substr(replace(trim(REPLACE(FUN.IFMASCARA(FUN.CDESC(WS_PERC_COL, RET_MCOL(WS_COUNTER).CD_LIGACAO), RET_MCOL(WS_COUNTER).NM_MASCARA, PRM_MICRO_VISAO, RET_MCOL(WS_COUNTER).CD_COLUNA, '', '', '', ''), CHR(34), CHR(39))), chr(9), ''),1,ws_tam_desc_label)||'", ');

					
					
					HTP.PRN('"valores": [');
				END IF;

				WS_CT_AGRUPADOR := 0;
				WS_LABELC := 0;

				LOOP
					WS_CT_AGRUPADOR := WS_CT_AGRUPADOR + 1;
					
                    



					IF  WS_CT_AGRUPADOR > WS_MULTI  THEN
						EXIT;
					END IF;

					

					




					
					WS_XCOUNT := WS_XCOUNT + 1;
					WS_CTX    := WS_CTX    + 1;
					WS_LABELC := WS_LABELC + 1;
					DBMS_SQL.COLUMN_VALUE(WS_CURSOR, WS_XCOUNT, RET_COLUNA);
					WS_PERC_COL := RET_COLUNA;
					WS_VALOR := TO_NUMBER(NVL(RET_COLUNA,0));

					WS_FIND_COL := FUN.CHECK_VALUE(WS_FIND_COL);
					
					IF WS_COUNT <= WS_AMOSTRA OR WS_AMOSTRA = 0 THEN
					    HTP.PRN('{');
					END IF;
						
							




							
							IF WS_COUNT > WS_AMOSTRA AND WS_AMOSTRA <> 0 THEN
							
								BEGIN
									
									
									
									IF WS_DADOS_ARR.COUNT > 0 THEN
										WS_DADOS_ARR(WS_CT_AGRUPADOR)   := WS_DADOS_ARR(WS_CT_AGRUPADOR)+TO_NUMBER(TRIM(WS_VALOR));
									    
									ELSE
										WS_DADOS_ARR(WS_CT_AGRUPADOR)   := TO_NUMBER(TRIM(WS_VALOR));
									END IF;
									WS_GRUPOS_ARR(WS_CT_AGRUPADOR)  := WS_DATASETS(WS_LABELC);
								EXCEPTION WHEN OTHERS THEN
								    
									WS_DADOS_ARR(WS_CT_AGRUPADOR)   := TO_NUMBER(TRIM(WS_VALOR));
									WS_GRUPOS_ARR(WS_CT_AGRUPADOR)  := WS_DATASETS(WS_LABELC);
								END;
                            ELSE
								
								
								
								HTP.PRN('"grupo": "'||FUN.UTRANSLATE('NM_ROTULO', PRM_MICRO_VISAO, WS_DATASETS(WS_LABELC), WS_PADRAO)||'", ');
								
								HTP.PRN('"valor": "'||TRIM(WS_VALOR)||'"');


							END IF;
							
					IF WS_COUNT <= WS_AMOSTRA OR WS_AMOSTRA = 0 THEN
					    IF  WS_CT_AGRUPADOR < WS_MULTI THEN
						    HTP.PRN('}, ');
						ELSE
                            HTP.PRN('} ');
						END IF;
					END IF;

				END LOOP;

				IF WS_COUNT <= WS_AMOSTRA OR WS_AMOSTRA = 0 THEN

					HTP.PRN('] ');

				END IF;
			
		    ELSE
			

				IF WS_COUNT > WS_AMOSTRA AND WS_AMOSTRA <> 0 THEN
				    WS_ACUMULADO := WS_ACUMULADO+TO_NUMBER(NVL(RET_COLUNA,0));
				ELSE

					WS_FIND_COL := FUN.CHECK_VALUE(WS_FIND_COL);
					
					--removido cdesc automatico de mapa, por estar passando desc na drill
					--if nvl(ws_tipo, 'N/A') = 'MAPA' then
					--	HTP.PRN(' "cod": "'||FUN.CDESC(REPLACE(WS_FIND_COL, '|', ''), RET_MCOL(WS_COUNTER).cd_ligacao)||'", ');
					--else
						HTP.PRN(' "cod": "'||REPLACE(WS_FIND_COL, '|', '')||'", ');
					--end if;
					
			        
					HTP.PRN('"colunas": "'||substr(replace(trim(FUN.IFMASCARA(WS_PERC_COL, RET_MCOL(WS_COUNTER).NM_MASCARA, PRM_MICRO_VISAO, RET_MCOL(WS_COUNTER).CD_COLUNA, '', '', '', '')), chr(9), ''),1,ws_tam_desc_label)||'", ');

					BEGIN
						WS_VALOR := TO_NUMBER(NVL(RET_COLUNA,0));
						
						
					
						
					END;
					HTP.PRN('"valores": "'||TRIM(WS_VALOR)||'", ');
					HTP.PRN('"grupo": "A"');
				END IF;

		    END IF;

			IF WS_COUNT <= WS_AMOSTRA OR WS_AMOSTRA = 0 THEN
		        HTP.PRN('}, ');
			END IF;

		END LOOP;

		WS_CT_AGRUPADOR := 0;

        
		IF WS_AMOSTRA <> 0 AND LENGTH(FUN.GETPROP(PRM_OBJETO, 'TEXTO_ACUMULADO')) > 0 THEN
		    
			WS_ID := WS_ID+1;
			HTP.PRN('"'||WS_ID||'": {');
			HTP.PRN('"cod":  "ACUMULADO", ');
            

			
			HTP.PRN('"colunas":  "'||replace(trim(FUN.GETPROP(PRM_OBJETO, 'TEXTO_ACUMULADO')), chr(9), '')||'", ');
			
            WS_COUNT := 0;

			IF WS_MULTI > 1 THEN

                WS_ACUMULADO_TEXT := '[';
				
				LOOP

				    WS_COUNT := WS_COUNT+1;

					IF WS_COUNT > WS_DADOS_ARR.COUNT THEN
						EXIT;
					END IF;

					BEGIN
						WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'{';

						WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'"grupo": ';

						WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'"'||WS_GRUPOS_ARR(WS_COUNT)||'", ';

						WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'"valor": ';

						WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'"'||WS_DADOS_ARR(WS_COUNT)||'" ';

                        IF WS_COUNT < WS_DADOS_ARR.COUNT THEN
						    WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'}, ';
						ELSE
                            WS_ACUMULADO_TEXT := WS_ACUMULADO_TEXT||'} ';
						END IF;
					EXCEPTION WHEN OTHERS THEN
                        HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
					END;

				END LOOP;

				WS_ACUMULADO_TEXT :=  WS_ACUMULADO_TEXT||'] }';

				HTP.PRN('"valores":  '||WS_ACUMULADO_TEXT||', ');

			ELSE

			    HTP.PRN('"valores":  "'||WS_ACUMULADO||'", ');
				HTP.PRN('"grupo":  "A" },');

			END IF;
			    
		END IF;

    DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);

	WS_COUNT := 0;

	WS_COUNTER := 0;
	WS_COUNT_DESTAQUE := 0;
    
	OPEN CRS_DESTAQUES(WS_USUARIO);
	    LOOP
		    FETCH CRS_DESTAQUES INTO WS_DESTAQUE;
			EXIT WHEN CRS_DESTAQUES%NOTFOUND;
			    WS_COUNT_DESTAQUE := WS_COUNT_DESTAQUE+1;
                WS_DESTAQUES := WS_DESTAQUES||', &quot;'||WS_COUNT_DESTAQUE||'&quot: {&quot;coluna&quot;: &quot;'||REPLACE(REPLACE(FUN.NOME_COL(WS_DESTAQUE.CD_COLUNA, PRM_MICRO_VISAO), '<BR>', ' '), '<br>', ' ')||'&quot;, &quot;cor&quot;: &quot;'||WS_DESTAQUE.COR_FUNDO||'&quot;, &quot;valor&quot;: &quot;'||REPLACE(FUN.SUBPAR(WS_DESTAQUE.CONTEUDO, PRM_SCREEN), '<br>', '')||'&quot, &quot;condicao&quot;: &quot;'||WS_DESTAQUE.CONDICAO||'&quot}';
		END LOOP;
	CLOSE CRS_DESTAQUES;

	WS_DESTAQUES := SUBSTR(WS_DESTAQUES, 2, 4000);

	IF WS_USUARIO = FUN.USUARIO THEN
	
		LOOP
			WS_COUNTER := WS_COUNTER + 1;
			
			IF  WS_COUNTER > WS_QUERY_MONTADA.COUNT THEN
				EXIT;
			END IF;
			
			IF FUN.GETPROP(PRM_OBJETO, 'QUBE') = 'S' THEN
				IF INSTR(WS_QUERY_MONTADA(WS_COUNTER), 'SEG') > 0 THEN
					WS_QUBE := '<span style="z-index: 2; height: 15px; width: 16px; position: absolute; top: 2px; right: 2px; opacity: 0.3;"><svg height="512pt" viewBox="-34 0 512 512" width="512pt" xmlns="http://www.w3.org/2000/svg" style="width: inherit;height: inherit;"><path d="m221.703125 0-221.703125 128v256l221.703125 128 221.703125-128v-256zm176.515625 136.652344-176.515625 101.914062-176.515625-101.914062 176.515625-101.910156zm-368.132812 26.027344 176.574218 101.941406v203.953125l-176.574218-101.945313zm206.660156 305.894531v-203.953125l176.574218-101.941406v203.949218zm0 0"></path></svg></span>';
				END IF;
			END IF;

		END LOOP;
	
	END IF;

	HTP.PRN('</span>');
	
	HTP.P('<span class="cor">'||WS_DESTAQUES||'</span>'||WS_QUBE);
	

EXCEPTION 
	WHEN WS_NODATA THEN
        INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CHAROUT', WS_USUARIO, 'ERRO');
        COMMIT;
        HTP.P('</span><span id="'||PRM_OBJETO||'_ERR">'||FUN.SUBPAR(FUN.GETPROP(PRM_OBJETO,'ERR_SD'), PRM_SCREEN)||'</span>');
	WHEN OTHERS THEN
        INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - CHAROUT', WS_USUARIO, 'ERRO');
        COMMIT;
        HTP.P('</span><span class="err">'||WS_QUERYOC||'</span>');
END CHAROUT;

PROCEDURE DATAGAUGE (  PRM_OBJETO  VARCHAR DEFAULT NULL, 
                       PRM_SCREEN  VARCHAR DEFAULT NULL,
                       PRM_MASCARA VARCHAR DEFAULT NULL ) AS

 WS_VISAO       VARCHAR2(30);
 WS_PARAMETROS  VARCHAR2(2000);
 WS_RETORNO     LONG;
 WS_MED         NUMBER;

BEGIN

 SELECT CD_MICRO_VISAO, PARAMETROS   INTO
        WS_VISAO, WS_PARAMETROS
 FROM   PONTO_AVALIACAO
 WHERE  CD_PONTO = PRM_OBJETO;
 

        WS_RETORNO := ('<chart theme="fint" showGaugeBorder="0" lowerlimit="0" upperlimit="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_05_GOM', 'PONTEIRO')||'" minortmnumber="0" majortmheight="0" majortmthickness="0" showValues="'||FUN.GETPROP(PRM_OBJETO,'HIDDEN')||'" exportShowMenuItem="0" exportEnabled="1" exportAtClient="0" exportFileName="'||PRM_OBJETO||'" bgAlpha="0,0" stroke-width="0" stroke-opacity="1"  gaugeFillMix="{light-20},{light-10},{light-10},{dark-10},{dark-20},{dark-30}" numberSuffix="">'
		||'<colorRange>'
            ||'<color label="0" minValue="0" maxValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_01_GOM', 'PONTEIRO')||'" code="'||FUN.PUT_PAR(PRM_OBJETO, 'COR_ID_01_GOM', 'PONTEIRO')||'"></color>'
            ||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||FUN.PUT_PAR(PRM_OBJETO, 'ROTULO_01_GOM', 'PONTEIRO')||'" minValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_01_GOM', 'PONTEIRO')||'" maxValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_02_GOM', 'PONTEIRO')||'" code="'||FUN.PUT_PAR(PRM_OBJETO, 'COR_ID_02_GOM', 'PONTEIRO')||'"></color>'
            ||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||FUN.PUT_PAR(PRM_OBJETO, 'ROTULO_02_GOM', 'PONTEIRO')||'" minValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_02_GOM', 'PONTEIRO')||'" maxValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_03_GOM', 'PONTEIRO')||'" code="'||FUN.PUT_PAR(PRM_OBJETO, 'COR_ID_03_GOM', 'PONTEIRO')||'"></color>'
            ||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||FUN.PUT_PAR(PRM_OBJETO, 'ROTULO_03_GOM', 'PONTEIRO')||'" minValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_03_GOM', 'PONTEIRO')||'" maxValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_04_GOM', 'PONTEIRO')||'" code="'||FUN.PUT_PAR(PRM_OBJETO, 'COR_ID_04_GOM', 'PONTEIRO')||'"></color>'
            ||'<color link="JavaScript: isJavaScriptCall=true; showview2('''');" label="'||FUN.PUT_PAR(PRM_OBJETO, 'ROTULO_04_GOM', 'PONTEIRO')||'" minValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_04_GOM', 'PONTEIRO')||'" maxValue="'||FUN.PUT_PAR(PRM_OBJETO, 'VALOR_05_GOM', 'PONTEIRO')||'" code="'||FUN.PUT_PAR(PRM_OBJETO, 'COR_ID_05_GOM', 'PONTEIRO')||'"></color>'
        ||'</colorRange>'
		||'<trendpoints>'
		||'<point startValue="'||FUN.PUT_PAR(PRM_OBJETO, 'META_01_GOM', 'PONTEIRO')||'" endValue="'||FUN.PUT_PAR(PRM_OBJETO, 'META_02_GOM', 'PONTEIRO')||'" displayvalue="'||FUN.LANG('META')||'" color="transparent" showborder="1" bordercolor="#000000" radius="180" innerradius="1"/>'
		||'</trendpoints>'

        ||'<dials>'
        ||'<dial value="'||FUN.IFMASCARA(FUN.VALOR_PONTO( WS_PARAMETROS, WS_VISAO, PRM_OBJETO, PRM_SCREEN ),RTRIM(PRM_MASCARA))||'"></dial>'
        ||'</dials>'
        ||'</chart>');
		HTP.P(WS_RETORNO);

END DATAGAUGE;

PROCEDURE VALOR_PONTO ( PRM_PARAMETROS   VARCHAR2 DEFAULT NULL,
						PRM_MICRO_VISAO	 VARCHAR2 DEFAULT NULL,
						PRM_OBJETO		 VARCHAR2 DEFAULT NULL, 
						PRM_SCREEN       VARCHAR2 DEFAULT NULL,
						PRM_FORMULA      VARCHAR2 DEFAULT NULL,
						PRM_MASCARA      VARCHAR2 DEFAULT NULL ) AS

	RET_COLUNA			LONG;

	WS_QUERY_PIVOT		LONG;
 	WS_AGRUPADOR		LONG;
	WS_SQL				LONG;
	WS_PARAMETROS		LONG;
 
	WS_LQUERY			NUMBER;
	WS_CURSOR			INTEGER;
	WS_LINHAS			INTEGER;
	WS_COUNTER			INTEGER;

	WS_QUERY_MONTADA	DBMS_SQL.VARCHAR2A;
	WS_NCOLUMNS			DBMS_SQL.VARCHAR2_TABLE;
	WS_PVCOLUMNS		DBMS_SQL.VARCHAR2_TABLE;
	WS_MFILTRO			DBMS_SQL.VARCHAR2_TABLE;
	WS_CAB_CROSS        VARCHAR2(4000);

BEGIN
	WS_PARAMETROS := PRM_PARAMETROS;

	IF  SUBSTR(WS_PARAMETROS,LENGTH(WS_PARAMETROS),1)='|' THEN
	    WS_PARAMETROS := WS_PARAMETROS||'1|1';
	END IF;

	WS_SQL := CORE.MONTA_QUERY_DIRECT(PRM_MICRO_VISAO, '', WS_PARAMETROS, 'SUMARY', '', WS_QUERY_PIVOT, WS_QUERY_MONTADA, WS_LQUERY, WS_NCOLUMNS, WS_PVCOLUMNS, WS_AGRUPADOR, WS_MFILTRO, PRM_OBJETO, PRM_SCREEN => PRM_SCREEN, PRM_CROSS => 'N', PRM_CAB_CROSS => WS_CAB_CROSS);

	WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

	DBMS_SQL.PARSE( C => WS_CURSOR, STATEMENT => WS_QUERY_MONTADA, LB => 1, UB => WS_LQUERY, LFFLG => TRUE, LANGUAGE_FLAG => DBMS_SQL.NATIVE );

	WS_SQL := CORE.BIND_DIRECT(WS_PARAMETROS, WS_CURSOR, 'SUMARY', PRM_OBJETO, PRM_MICRO_VISAO, PRM_SCREEN);

	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, RET_COLUNA, 40);
	WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);
	WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
	DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, RET_COLUNA);
	DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
	
	HTP.P(NVL(FUN.IFMASCARA(RET_COLUNA,TRIM(PRM_MASCARA), PRM_MICRO_VISAO, SUBSTR(PRM_PARAMETROS, 1 ,INSTR(PRM_PARAMETROS,'|')-1), PRM_OBJETO, '', PRM_FORMULA, PRM_SCREEN), 'N/A'));

EXCEPTION
	WHEN OTHERS	     THEN
	   IF GBL.GETUSUARIO = FUN.USUARIO THEN
	       HTP.P('{'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||'}');
	   END IF;
	WS_COUNTER := 0;
	LOOP
	    WS_COUNTER := WS_COUNTER + 1;
	    IF  WS_COUNTER > WS_QUERY_MONTADA.COUNT THEN
	        EXIT;
	    END IF;
	    HTP.P(WS_QUERY_MONTADA(WS_COUNTER));
	END LOOP;

	HTP.P('0');
END VALOR_PONTO;

PROCEDURE UM ( PRM_COLUNA  VARCHAR2 DEFAULT '$[no_co]',
               PRM_VISAO   VARCHAR2 DEFAULT '$[no_ob]',
               PRM_CONTENT VARCHAR2 DEFAULT NULL ) AS
	  
	WS_UNIDADE VARCHAR2(20);
    WS_NULO    VARCHAR2(1) := NULL; 

BEGIN
    
	IF LENGTH(TRIM(PRM_CONTENT)) > 0 THEN
		
		SELECT NM_UNIDADE 
		INTO WS_UNIDADE 
		FROM MICRO_COLUNA
		WHERE CD_MICRO_VISAO = PRM_VISAO AND 
		CD_COLUNA = PRM_COLUNA;
		
		IF INSTR(WS_UNIDADE, '>') = 1 THEN
			HTP.P(PRM_CONTENT||' '||TRIM(REPLACE(WS_UNIDADE, '>', '')));
		ELSIF INSTR(WS_UNIDADE, '<') = 1 THEN
			HTP.P(TRIM(REPLACE(WS_UNIDADE, '<', ''))||' '||PRM_CONTENT);
		ELSE
			HTP.P(PRM_CONTENT);
		END IF;
		
	ELSE
	
	    HTP.P(WS_NULO);
		
	END IF;
     
EXCEPTION
    WHEN OTHERS THEN
        HTP.P(WS_NULO);
END UM;



PROCEDURE UPDATE_PROP ( PRM_ID     VARCHAR2 DEFAULT NULL,
                        PRM_PROP   VARCHAR2 DEFAULT NULL,
                        PRM_VALOR  VARCHAR2 DEFAULT NULL,
                        PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT      NUMBER := 0;
	WS_VALOR VARCHAR2(4000);
	WS_VALOR_CONV VARCHAR2(200);


BEGIN

    WS_VALOR := PRM_VALOR;
	
	CASE PRM_PROP
    
       	WHEN 'manutencao' THEN
            
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'MANUTENCAO';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'MANUTENCAO';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'MANUTENCAO', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;

		WHEN 'atualizando' THEN
            
			MERGE INTO OBJECT_ATTRIB T1
			USING (SELECT 'ATUALIZANDO' AS PROP, UPPER(TRIM(PRM_ID)) AS OBJ FROM DUAL) T2
			ON (T1.CD_PROP = T2.PROP AND T1.CD_OBJECT = T2.OBJ)
			WHEN MATCHED THEN UPDATE 
			SET T1.PROPRIEDADE = TRIM(WS_VALOR)

			WHEN NOT MATCHED THEN INSERT (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
			('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'ATUALIZANDO', TRIM(WS_VALOR));

            
            WS_COUNT := SQL%ROWCOUNT;
	    
		WHEN 'atributos' THEN
            
            UPDATE OBJETOS
            SET ATRIBUTOS = FUN.CONVERTE(TRIM(WS_VALOR))
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
		WHEN 'tipo' THEN
            
            UPDATE OBJETOS
            SET TP_OBJETO = UPPER(TRIM(WS_VALOR))
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'grupo' THEN
            
            UPDATE OBJETOS
            SET CD_GRUPO = UPPER(TRIM(WS_VALOR))
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'view' THEN
        
            IF LENGTH(TRIM(WS_VALOR)) > 0 THEN

	            SELECT COUNT(*) INTO WS_COUNT FROM PONTO_AVALIACAO 
	            WHERE CD_PONTO = UPPER(TRIM(PRM_ID));
	            
	            IF WS_COUNT <> 0 THEN
	        
		            UPDATE PONTO_AVALIACAO
		            SET CD_MICRO_VISAO = UPPER(TRIM(WS_VALOR))
		            WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(PRM_ID));
		        
		        ELSE
		        
		            INSERT INTO PONTO_AVALIACAO 
		            	(CD_PONTO, NM_PONTO, DS_PONTO, AR_DIARIO, AR_MENSAL, AR_ANUAL, CD_VISAO, TP_RENOVACAO, CD_USUARIO, DT_ULTIMA, DT_CRIACAO, CD_MICRO_VISAO, PARAMETROS, ST_FILTROS, VL_SALVO, CS_PARAMETROS, CS_COLUNA, CS_AGRUPADOR, CS_RP, CS_COLUP)
		            VALUES
		                (UPPER(TRIM(PRM_ID)), '', '', 'N', 'N', 'N', 'T', 'O', 'DWU', SYSDATE, SYSDATE, UPPER(TRIM(WS_VALOR)), '', 'A', '', '', '', '', '', '');
		        
		        END IF;
	            
	            WS_COUNT := SQL%ROWCOUNT;
	            
	        END IF;
            
        WHEN 'agrupador' THEN
        
            IF LENGTH(TRIM(WS_VALOR)) > 0 THEN
        
	            DELETE FROM OBJECT_ATTRIB WHERE CD_PROP = 'VISIVEL' AND CD_OBJECT = UPPER(TRIM(PRM_ID));
				COMMIT;
				
				UPDATE PONTO_AVALIACAO
	            SET CS_AGRUPADOR = UPPER(TRIM(WS_VALOR))
	            WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(PRM_ID));
	            
	            WS_COUNT := SQL%ROWCOUNT;
	            
	        END IF;

	    WHEN 'csrp' THEN
	    
	        IF LENGTH(TRIM(WS_VALOR)) > 0 THEN
        
	            UPDATE PONTO_AVALIACAO
	            SET CS_RP = UPPER(TRIM(WS_VALOR))
	            WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(PRM_ID));
	            
	            WS_COUNT := SQL%ROWCOUNT;
	            
	        END IF;

	    WHEN 'colup' THEN

			DELETE FROM OBJECT_ATTRIB WHERE CD_PROP = 'VISIVEL' AND CD_OBJECT = UPPER(TRIM(PRM_ID));
			COMMIT;
        
	        UPDATE PONTO_AVALIACAO
	        SET CS_COLUP = UPPER(TRIM(WS_VALOR))
	        WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(PRM_ID));
	            
	        WS_COUNT := SQL%ROWCOUNT;

		 WHEN 'parametros' THEN
        
			UPDATE PONTO_AVALIACAO
			SET PARAMETROS = UPPER(TRIM(WS_VALOR))
			WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(PRM_ID));
			
			WS_COUNT := SQL%ROWCOUNT;

        WHEN 'coluna' THEN
            
            IF LENGTH(TRIM(WS_VALOR)) > 0 THEN

				DELETE FROM OBJECT_ATTRIB WHERE CD_PROP = 'VISIVEL' AND CD_OBJECT = UPPER(TRIM(PRM_ID));
				COMMIT;
	            
	            UPDATE PONTO_AVALIACAO
	            SET CS_COLUNA = UPPER(TRIM(WS_VALOR))
	            WHERE UPPER(TRIM(CD_PONTO)) = UPPER(TRIM(PRM_ID));
	            
	            WS_COUNT := SQL%ROWCOUNT;
	            
	        END IF;

        WHEN 'nome' THEN

		    WS_VALOR := FUN.CONVERTE(WS_VALOR);
            
            UPDATE OBJETOS
            SET NM_OBJETO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
			
		WHEN 'COD' THEN
            
            UPDATE OBJETOS
            SET COD = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
			
			









            
        WHEN 'subtitulo' THEN

		    WS_VALOR := FUN.CONVERTE(WS_VALOR);
            
            UPDATE OBJETOS
            SET SUBTITULO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'descritivo' THEN

		    WS_VALOR := FUN.CONVERTE(WS_VALOR);
            
            UPDATE OBJETOS
            SET DS_OBJETO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'cor_tela' THEN
            
            UPDATE ALL_SCREENS
            SET COR_FUNDO = TRIM(WS_VALOR)
            WHERE SCREEN = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
         WHEN 'usuarios-tela-del' THEN
            
            DELETE FROM USER_SCREENS WHERE SCREEN = PRM_ID AND TRIM(UPPER(USUARIO)) = TRIM(UPPER(WS_VALOR));
            
            




			

            
            WS_COUNT := SQL%ROWCOUNT;
		
		WHEN 'usuarios-tela-add' THEN
            
            

            
            




			INSERT INTO USER_SCREENS VALUES(WS_VALOR, PRM_ID, 'A');
            
            WS_COUNT := SQL%ROWCOUNT;
        
        WHEN 'descritivo_tela' THEN

		    WS_VALOR := FUN.CONVERTE(WS_VALOR);
            
            UPDATE ALL_SCREENS
            SET DS_SCREEN = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
        WHEN 'nome_tela' THEN

		    WS_VALOR := FUN.CONVERTE(WS_VALOR);
            
            UPDATE ALL_SCREENS
            SET DESCRICAO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
			
			UPDATE OBJETOS
            SET NM_OBJETO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(CD_OBJETO)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'url_tela' THEN
            
            UPDATE ALL_SCREENS
            SET URL_FUNDO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
        
        WHEN 'alinhamento_tela' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'IMG_POS';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'IMG_POS';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'IMG_POS', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'tamanho_tela' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'IMG_SIZE';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'IMG_SIZE';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'IMG_SIZE', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;
        WHEN 'repetir_tela' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'REPEAT';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'REPEAT';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'REPEAT', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;
        
        WHEN 'ordem_tela' THEN
        
            UPDATE ALL_SCREENS
            SET OR_GRUPO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
        
        WHEN 'item_tela' THEN
        
            UPDATE ALL_SCREENS
            SET OR_ITEM = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'dispositivo_tela' THEN
        
            UPDATE ALL_SCREENS
            SET DISPOSITIVO = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'flex_tela' THEN
        
            UPDATE ALL_SCREENS
            SET FLEX_FLOW = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
            
        WHEN 'timer_tela' THEN
        
            UPDATE ALL_SCREENS
            SET TIMER = TRIM(WS_VALOR)
            WHERE UPPER(TRIM(SCREEN)) = UPPER(TRIM(PRM_ID));
            
            WS_COUNT := SQL%ROWCOUNT;
			
		WHEN 'img_valor' THEN
		    
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'IMG';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'IMG';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'IMG', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT; 
			
        WHEN 'sec' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'SEC';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'SEC';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'SEC', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;

        WHEN 'PERMISSAOED' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'PERMISSAOED';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'PERMISSAOED';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE)VALUES ('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'PERMISSAOED', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;
			
        WHEN 'PERMISSAOEX' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'PERMISSAOEX';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'PERMISSAOEX';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'PERMISSAOEX', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;	

        WHEN 'PERMISSAOAD' THEN
        
            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'PERMISSAOAD';
            
            IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'PERMISSAOAD';
	        
	        ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'PERMISSAOAD', TRIM(WS_VALOR));
	        
	        END IF;
            
            WS_COUNT := SQL%ROWCOUNT;	

		WHEN 'PERMISSAONOFILTER' THEN

            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'PERMISSAONOFILTER';
            
             IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'PERMISSAONOFILTER';

            ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'PERMISSAONOFILTER', TRIM(WS_VALOR));
	        
	        END IF;

            WS_COUNT := SQL%ROWCOUNT;

		when 'PERMISSAODESTAQUE' then

            select count(*) into ws_count 
            from object_attrib 
            where upper(trim(cd_object)) = upper(trim(prm_id)) and
            cd_prop = 'PERMISSAODESTAQUE';
            
             if ws_count <> 0 then
	            update object_attrib
	            set propriedade = trim(ws_valor)
	            where cd_object = upper(trim(prm_id)) and
	            cd_prop = 'PERMISSAODESTAQUE';
            else
	            insert into object_attrib (owner, navegador, screen, cd_object, cd_prop, propriedade) values 
				('DWU', 'DEFAULT', 'DEFAULT', upper(trim(prm_id)), 'PERMISSAODESTAQUE', trim(ws_valor));
	        end if;

            ws_count := SQL%ROWCOUNT;


		WHEN 'SUBQUERY' THEN

            SELECT COUNT(*) INTO WS_COUNT 
            FROM OBJECT_ATTRIB 
            WHERE UPPER(TRIM(CD_OBJECT)) = UPPER(TRIM(PRM_ID)) AND
            CD_PROP = 'SUBQUERY';
            
             IF WS_COUNT <> 0 THEN
        
	            UPDATE OBJECT_ATTRIB
	            SET PROPRIEDADE = TRIM(WS_VALOR)
	            WHERE CD_OBJECT = UPPER(TRIM(PRM_ID)) AND
	            CD_PROP = 'SUBQUERY';

            ELSE
	        
	            INSERT INTO OBJECT_ATTRIB (OWNER, NAVEGADOR, SCREEN, CD_OBJECT, CD_PROP, PROPRIEDADE) VALUES 
				('DWU', 'DEFAULT', 'DEFAULT', UPPER(TRIM(PRM_ID)), 'SUBQUERY', TRIM(WS_VALOR));
	        
	        END IF;

            WS_COUNT := SQL%ROWCOUNT;		
            
    END CASE;
    

    COMMIT;
    
    IF WS_COUNT = 0 THEN
        HTP.P('fail');
    ELSE
        HTP.P(FUN.SUBPAR(TRIM(WS_VALOR), PRM_SCREEN));
    END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('fail '||SQLERRM);
END UPDATE_PROP;

PROCEDURE CHECK_ACL ( PRM_HOST      VARCHAR2 DEFAULT NULL,
	                  PRM_PORT_LOWER VARCHAR2 DEFAULT NULL,
	                  PRM_PORT_UPPER VARCHAR2 DEFAULT NULL  ) AS 

    WS_COUNT NUMBER;
    WS_FAIL  EXCEPTION;
    

BEGIN

    HTP.P('');

	

	
	
	
	

































EXCEPTION 
	WHEN WS_FAIL THEN
	    HTP.P('<br /><div style="text-align: center;">CHECK_ACL: <span style="font-weight: bold; color: #00CC00;">FAIL SEM CONEX&Atilde;O</span></div>');
	WHEN OTHERS THEN
	    HTP.P('<br /><div style="text-align: center;">CHECK_ACL: <span style="font-weight: bold; color: #00CC00;">FAIL</span></div>');
END CHECK_ACL;

PROCEDURE REPLACE_BINDS ( PRM_QUERY VARCHAR2 DEFAULT NULL, 
                          PRM_BINDS VARCHAR2 DEFAULT NULL )  AS
	
    WS_COUNT NUMBER;
	WS_QUERY VARCHAR2(24000);
	WS_VALOR VARCHAR2(800);
	WS_LOOP  NUMBER;
	
BEGIN


    WS_QUERY := substr(PRM_QUERY,1,24000);

    SELECT REGEXP_COUNT(WS_QUERY, ':b[0-90-9]+') INTO WS_COUNT FROM DUAL;
	

	WS_LOOP := 0;
	FOR I IN 1..WS_COUNT LOOP
	    WS_LOOP := WS_LOOP+1;
		BEGIN
		    SELECT COLUMN_VALUE INTO WS_VALOR FROM( SELECT COLUMN_VALUE, ROWNUM AS LINHA FROM TABLE(FUN.VPIPE((PRM_BINDS)))) WHERE LINHA = WS_LOOP;
	    END;
		
	    SELECT REGEXP_REPLACE(WS_QUERY, ':b[0-90-9]+', CHR(39)||WS_VALOR||CHR(39), WS_LOOP, 1) INTO WS_QUERY FROM DUAL;
	
	END LOOP;
	
	
	HTP.P(WS_QUERY);
EXCEPTION WHEN OTHERS THEN
   insert into bi_log_sistema values (sysdate,DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE||' - REPLACE_BINDS ',gbl.getUsuario,'ERRO');
   commit;
   HTP.P(WS_QUERY);
END REPLACE_BINDS;

PROCEDURE LISTA_CIDADES ( PRM_ESTADO     VARCHAR2 DEFAULT NULL,
                          PRM_COLUNA     VARCHAR2 DEFAULT 'CD',
						  PRM_OBJ        VARCHAR2 DEFAULT NULL,
						  PRM_SCREEN     VARCHAR2 DEFAULT NULL,
						  PRM_VISAO      VARCHAR2 DEFAULT NULL,
						  PRM_PARAMETROS VARCHAR2 DEFAULT NULL ) AS
    
	CURSOR CRS_FILTROS IS
	    SELECT CD_COLUNA, DECODE(CONDICAO, 'IGUAL', '=', 'DIFERENTE', '<>', 'MAIOR', '>', 'MENOR', '<', 'MAIOROUIGUAL', '>=', 'MENOROUIGUAL', '<=', 'LIKE', ' like ', 'NOTLIKE', ' not like ', '=') AS REGRA, CONTEUDO FROM (
			SELECT 
				DECODE(SUBSTR(TRIM(CD_COLUNA),1,2),'M_',SUBSTR(TRIM(CD_COLUNA),3,LENGTH(TRIM(CD_COLUNA))),TRIM(CD_COLUNA)) AS CD_COLUNA,
				'IGUAL'                           AS CONDICAO,
				REPLACE(TRIM(CONTEUDO), '$[NOT]', '') AS CONTEUDO
			FROM   FLOAT_FILTER_ITEM
			WHERE
				TRIM(CD_USUARIO) = gbl.getUsuario AND
				TRIM(SCREEN) = TRIM(PRM_SCREEN) AND
				
                TRIM(CD_COLUNA) NOT IN (SELECT CD_COLUNA FROM FILTROS WHERE CONDICAO = 'NOFLOAT' AND TP_FILTRO = 'objeto' AND TRIM(MICRO_VISAO) = TRIM(PRM_VISAO) AND TRIM(CD_OBJETO) = TRIM(PRM_OBJ)) AND
				DECODE(SUBSTR(TRIM(CD_COLUNA),1,2),'M_',SUBSTR(TRIM(CD_COLUNA),3,LENGTH(TRIM(CD_COLUNA))),TRIM(CD_COLUNA)) IN ( 
					SELECT TRIM(CD_COLUNA)
				    FROM   MICRO_COLUNA MC
				    WHERE  TRIM(MC.CD_MICRO_VISAO) = TRIM(PRM_VISAO)				 
				)  AND
				LENGTH(TRIM(CONTEUDO)) > 0
				AND CD_COLUNA IN ('NM_CIDADE', 'CD_CIDADE', 'CD_ESTADO')
		    
			UNION ALL

		    SELECT
				TRIM(CD_COLUNA)	AS CD_COLUNA,
				TRIM(CONDICAO)		AS CONDICAO,
				TRIM(CONTEUDO)		AS CONTEUDO
			FROM 	FILTROS T1
			WHERE	TRIM(MICRO_VISAO) = RTRIM(PRM_VISAO) AND
			    TP_FILTRO   = 'geral' AND
                ST_AGRUPADO = 'N' AND 
                (RTRIM(CD_USUARIO)  IN (gbl.getUsuario, 'DWU') OR TRIM(CD_USUARIO) IN (SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = gbl.getUsuario))
			    AND LENGTH(TRIM(CONTEUDO)) > 0
			    AND CD_COLUNA IN ('NM_CIDADE', 'CD_CIDADE', 'CD_ESTADO')

			UNION

			SELECT
				TRIM(CD_COLUNA)	    AS CD_COLUNA,
				TRIM(CONDICAO)		AS CONDICAO,
				TRIM(CONTEUDO)		AS CONTEUDO
			FROM 	FILTROS
			WHERE	TRIM(MICRO_VISAO) = TRIM(PRM_VISAO)  AND
			    TP_FILTRO = 'objeto' AND
                ( TRIM(CD_OBJETO) = TRIM(PRM_OBJ) OR (TRIM(CD_OBJETO) = TRIM(PRM_SCREEN) AND (NVL(FUN.GETPROP(TRIM(PRM_OBJ),'FILTRO'), 'N/A') <>'ISOLADO' AND NVL(FUN.GETPROP(TRIM(PRM_OBJ),'FILTRO'), 'N/A') <> 'COM CORTE')) )
			    AND TRIM(CD_USUARIO)  = 'DWU' 
			    AND LENGTH(TRIM(CONTEUDO)) > 0 
                AND CONDICAO <> 'NOFLOAT'
			    AND CONDICAO <> 'NOFILTER'
			    AND CD_COLUNA IN ('NM_CIDADE', 'CD_CIDADE', 'CD_ESTADO')

			UNION ALL
			
			SELECT
				TRIM(CD_COLUNA)	AS CD_COLUNA,
				TRIM(CONDICAO)		AS CONDICAO,
				TRIM(CONTEUDO)		AS CONTEUDO
			FROM 	FILTROS
			WHERE	RTRIM(MICRO_VISAO) = RTRIM(PRM_VISAO)  AND
                ( RTRIM(CD_OBJETO) = TRIM(PRM_OBJ) OR (RTRIM(CD_OBJETO) = TRIM(PRM_SCREEN)) )
			AND TRIM(CD_USUARIO)  = 'DWU' 
			AND LENGTH(TRIM(CONTEUDO)) > 0  AND 
			CONDICAO = 'NOFILTER' AND CD_COLUNA IN ('NM_CIDADE', 'CD_CIDADE', 'CD_ESTADO')

			UNION ALL
			
			SELECT
				TRIM(CD_COLUNA)	AS CD_COLUNA,
				TRIM(CD_CONDICAO)		AS CONDICAO,
				TRIM(CD_CONTEUDO)		AS CONTEUDO
			FROM 	TABLE(FUN.VPIPE_PAR((PRM_PARAMETROS))) 
			WHERE CD_COLUNA IN ('NM_CIDADE', 'CD_CIDADE', 'CD_ESTADO')
        ) 
		GROUP BY CD_COLUNA, CONDICAO, CONTEUDO
        ORDER BY CD_COLUNA, CONDICAO, CONTEUDO;

	WS_FILTRO CRS_FILTROS%ROWTYPE;
	
	WS_NAME     NUMBER;
	WS_DESC     VARCHAR2(200);
	WS_COUNT    NUMBER;
	WS_SQL      VARCHAR2(20000);
	WS_REGRA    VARCHAR2(10000);
	WS_JSON     CLOB;
	WS_NMCIDADE VARCHAR2(200);
	WS_CDCIDADE VARCHAR2(200);
	WS_ESTADO   VARCHAR2(200);
	WS_CONTEUDO VARCHAR2(400);

	WS_CURSOR	INTEGER;
	WS_LINHAS	INTEGER;

BEGIN
    
	WS_NAME  := 0;
    WS_COUNT := 0;

	WS_SQL := 'select json, nm_cidade, cd_cidade, cd_estado from bi_cidades_brasil';
	WS_SQL := WS_SQL||' where trim(cd_estado) in (select trim(column_value) from table((fun.vpipe(nvl('''||PRM_ESTADO||''', ''RN|RJ|MG|AL|ES|SP|PR|RS|AM|RR|AC|PE|MA|PB|SE|RO|AP|CE|BA|MT|SC|GO|DF|TO|PI|MS|PA'')))))'; 
	
	OPEN CRS_FILTROS;
	    LOOP
            FETCH CRS_FILTROS INTO WS_FILTRO;
			EXIT WHEN CRS_FILTROS%NOTFOUND;

			    WS_CONTEUDO := WS_FILTRO.CONTEUDO;

			    IF SUBSTR(WS_FILTRO.CONTEUDO,1,2) = '$[' THEN
					WS_CONTEUDO := FUN.GPARAMETRO(WS_FILTRO.CONTEUDO, PRM_SCREEN => PRM_SCREEN);
				END IF;

				IF SUBSTR(WS_FILTRO.CONTEUDO,1,2) = '#[' THEN
					WS_CONTEUDO := FUN.RET_VAR(WS_FILTRO.CONTEUDO,gbl.getUsuario);
				END IF;

				IF UPPER(SUBSTR(WS_FILTRO.CONTEUDO,1,5)) = 'EXEC=' THEN
					WS_CONTEUDO := FUN.XEXEC(WS_FILTRO.CONTEUDO, PRM_SCREEN);
				END IF;
            
                WS_REGRA := WS_REGRA||' or '||TRIM(WS_FILTRO.CD_COLUNA)||' '||TRIM(WS_FILTRO.REGRA)||' '||CHR(39)||TRIM(WS_CONTEUDO)||CHR(39);

		END LOOP;
	CLOSE CRS_FILTROS;

	IF LENGTH(WS_REGRA) > 0 THEN
        WS_SQL := WS_SQL||' and ('||SUBSTR(WS_REGRA, 4, LENGTH(WS_REGRA))||') ';
	END IF;

	WS_SQL := WS_SQL||' order by cd_estado, cd_cidade, sequencia asc';


	WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

	DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);
	
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_JSON);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_NMCIDADE, 200);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 3, WS_CDCIDADE, 200);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 4, WS_ESTADO, 200);
	
    WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

    LOOP

	    WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
		IF  WS_LINHAS <> 1 THEN EXIT; END IF;

	    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_JSON);
	    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_NMCIDADE);
	    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 3, WS_CDCIDADE);
	    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 4, WS_ESTADO);
		
		IF WS_CDCIDADE <> WS_NAME THEN
		    IF WS_COUNT > 0 THEN
			    HTP.P('] }}');
	            HTP.P('</li>');
			END IF;
		    WS_NAME := WS_CDCIDADE;
			WS_DESC := WS_NMCIDADE;
			HTP.P('<li data-sigla="'||WS_NAME||'" data-sigla2="'||FUN.PTG_TRANS(UPPER(WS_DESC))||'" data-nome="'||WS_DESC||'">');
            
			HTP.P('{ "type": "Feature", "properties": { "name": "'||WS_NAME||'", "nome": "'||FUN.PTG_TRANS(UPPER(WS_DESC))||'", "sigla": "'||WS_NAME||'" }, "geometry": { "type": "MultiPolygon", "coordinates": [');
		    WS_COUNT := WS_COUNT+1;
		END IF;
			
		HTP.PRN(TRIM(WS_JSON));
			    
	END LOOP;

	DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
	
	HTP.P('] }}');
	HTP.P('</li>');

EXCEPTION WHEN OTHERS THEN
    HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END LISTA_CIDADES;

PROCEDURE LISTA_ESTADOS ( PRM_ESTADO     VARCHAR2 DEFAULT NULL,
                          PRM_COLUNA     VARCHAR2 DEFAULT 'CD',
						  PRM_OBJ        VARCHAR2 DEFAULT NULL,
						  PRM_SCREEN     VARCHAR2 DEFAULT NULL,
						  PRM_VISAO      VARCHAR2 DEFAULT NULL,
						  PRM_PARAMETROS VARCHAR2 DEFAULT NULL ) AS

	CURSOR CRS_FILTROS IS
	    SELECT CD_COLUNA, DECODE(CONDICAO, 'IGUAL', '=', 'DIFERENTE', '<>', 'MAIOR', '>', 'MENOR', '<', 'MAIOROUIGUAL', '>=', 'MENOROUIGUAL', '<=', 'LIKE', ' like ', 'NOTLIKE', ' not like ', '=') AS REGRA, CONTEUDO FROM (
			SELECT 
				DECODE(SUBSTR(TRIM(CD_COLUNA),1,2),'M_',SUBSTR(TRIM(CD_COLUNA),3,LENGTH(TRIM(CD_COLUNA))),TRIM(CD_COLUNA)) AS CD_COLUNA,
				'IGUAL'                           AS CONDICAO,
				REPLACE(TRIM(CONTEUDO), '$[NOT]', '') AS CONTEUDO
			FROM   FLOAT_FILTER_ITEM
			WHERE
				TRIM(CD_USUARIO) = gbl.getUsuario AND
				TRIM(SCREEN) = TRIM(PRM_SCREEN) AND
				
                TRIM(CD_COLUNA) NOT IN (SELECT CD_COLUNA FROM FILTROS WHERE CONDICAO = 'NOFLOAT' AND TP_FILTRO = 'objeto' AND TRIM(MICRO_VISAO) = TRIM(PRM_VISAO) AND TRIM(CD_OBJETO) = TRIM(PRM_OBJ)) AND
				DECODE(SUBSTR(TRIM(CD_COLUNA),1,2),'M_',SUBSTR(TRIM(CD_COLUNA),3,LENGTH(TRIM(CD_COLUNA))),TRIM(CD_COLUNA)) IN ( 
					SELECT TRIM(CD_COLUNA)
				    FROM   MICRO_COLUNA MC
				    WHERE  TRIM(MC.CD_MICRO_VISAO) = TRIM(PRM_VISAO)				 
				)  AND
				LENGTH(TRIM(CONTEUDO)) > 0
				AND CD_COLUNA = 'CD_ESTADO'
		    
			UNION ALL

		    SELECT
				TRIM(CD_COLUNA)	AS CD_COLUNA,
				TRIM(CONDICAO)		AS CONDICAO,
				TRIM(CONTEUDO)		AS CONTEUDO
			FROM 	FILTROS T1
			WHERE	TRIM(MICRO_VISAO) = RTRIM(PRM_VISAO) AND
			    TP_FILTRO   = 'geral' AND
                ST_AGRUPADO = 'N' AND 
                (RTRIM(CD_USUARIO)  IN (gbl.getUsuario, 'DWU') OR TRIM(CD_USUARIO) IN (SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = gbl.getUsuario))
			    AND LENGTH(TRIM(CONTEUDO)) > 0
			    AND CD_COLUNA = 'CD_ESTADO'

			UNION

			SELECT
				TRIM(CD_COLUNA)	    AS CD_COLUNA,
				TRIM(CONDICAO)		AS CONDICAO,
				TRIM(CONTEUDO)		AS CONTEUDO
			FROM 	FILTROS
			WHERE	TRIM(MICRO_VISAO) = TRIM(PRM_VISAO)  AND
			    TP_FILTRO = 'objeto' AND
                ( TRIM(CD_OBJETO) = TRIM(PRM_OBJ) OR (TRIM(CD_OBJETO) = TRIM(PRM_SCREEN) AND (NVL(FUN.GETPROP(TRIM(PRM_OBJ),'FILTRO'), 'N/A')<>'ISOLADO' AND NVL(FUN.GETPROP(TRIM(PRM_OBJ),'FILTRO'), 'N/A') <> 'COM CORTE')) )
			    AND TRIM(CD_USUARIO)  = 'DWU' 
			    AND LENGTH(TRIM(CONTEUDO)) > 0 
                AND CONDICAO <> 'NOFLOAT'
			    AND CONDICAO <> 'NOFILTER'
			    AND CD_COLUNA = 'CD_ESTADO'

			UNION ALL
			
			SELECT
				TRIM(CD_COLUNA)	AS CD_COLUNA,
				TRIM(CONDICAO)		AS CONDICAO,
				TRIM(CONTEUDO)		AS CONTEUDO
			FROM 	FILTROS
			WHERE	RTRIM(MICRO_VISAO) = RTRIM(PRM_VISAO)  AND
                ( RTRIM(CD_OBJETO) = TRIM(PRM_OBJ) OR (RTRIM(CD_OBJETO) = TRIM(PRM_SCREEN)) )
			AND TRIM(CD_USUARIO)  = 'DWU' 
			AND LENGTH(TRIM(CONTEUDO)) > 0  AND 
			CONDICAO = 'NOFILTER' AND CD_COLUNA = 'CD_ESTADO'

			UNION ALL
			
			SELECT
				TRIM(CD_COLUNA)	AS CD_COLUNA,
				TRIM(CD_CONDICAO)		AS CONDICAO,
				TRIM(CD_CONTEUDO)		AS CONTEUDO
			FROM 	TABLE(FUN.VPIPE_PAR((PRM_PARAMETROS))) WHERE CD_COLUNA = 'CD_ESTADO'
        ) 
		GROUP BY CD_COLUNA, CONDICAO, CONTEUDO
        ORDER BY CD_COLUNA, CONDICAO, CONTEUDO;

	WS_FILTRO CRS_FILTROS%ROWTYPE;

    
	
	
	
	WS_NAME     VARCHAR2(40);
	WS_DESC     VARCHAR2(400);
	WS_COUNT    NUMBER;
	WS_SQL      VARCHAR2(20000);
	WS_REGRA    VARCHAR2(10000);
	WS_JSON     CLOB;
	WS_NMESTADO VARCHAR2(200);
	WS_CDESTADO VARCHAR2(200);
	WS_CONTEUDO VARCHAR2(400);

	WS_CURSOR	INTEGER;
	WS_LINHAS	INTEGER;

BEGIN

    WS_COUNT := 0;
	WS_NAME  := '123';

	WS_SQL := 'select cd_estado, nm_estado, json from bi_estados_brasil';
	WS_SQL := WS_SQL||' where trim(cd_estado) in (select trim(column_value) from table((fun.vpipe(nvl('''||PRM_ESTADO||''', ''RN|RJ|MG|AL|ES|SP|PR|RS|AM|RR|AC|PE|MA|PB|SE|RO|AP|CE|BA|MT|SC|GO|DF|TO|PI|MS|PA'')))))'; 
	
	OPEN CRS_FILTROS;
	    LOOP
            FETCH CRS_FILTROS INTO WS_FILTRO;
			EXIT WHEN CRS_FILTROS%NOTFOUND;

			    WS_CONTEUDO := WS_FILTRO.CONTEUDO;

			    IF SUBSTR(WS_FILTRO.CONTEUDO,1,2) = '$[' THEN
					WS_CONTEUDO := FUN.GPARAMETRO(WS_FILTRO.CONTEUDO, PRM_SCREEN => PRM_SCREEN);
				END IF;

				IF SUBSTR(WS_FILTRO.CONTEUDO,1,2) = '#[' THEN
					WS_CONTEUDO := FUN.RET_VAR(WS_FILTRO.CONTEUDO,gbl.getUsuario);
				END IF;

				IF UPPER(SUBSTR(WS_FILTRO.CONTEUDO,1,5)) = 'EXEC=' THEN
					WS_CONTEUDO := FUN.XEXEC(WS_FILTRO.CONTEUDO, PRM_SCREEN);
				END IF;
            
                WS_REGRA := WS_REGRA||' or '||TRIM(WS_FILTRO.CD_COLUNA)||' '||TRIM(WS_FILTRO.REGRA)||' '||CHR(39)||TRIM(WS_CONTEUDO)||CHR(39);

		END LOOP;
	CLOSE CRS_FILTROS;

	IF LENGTH(WS_REGRA) > 0 THEN
        WS_SQL := WS_SQL||' and ('||SUBSTR(WS_REGRA, 4, LENGTH(WS_REGRA))||') ';
	END IF;

	WS_SQL := WS_SQL||' order by cd_estado, sequencia asc';

	WS_CURSOR := DBMS_SQL.OPEN_CURSOR;

	DBMS_SQL.PARSE(WS_CURSOR, WS_SQL, DBMS_SQL.NATIVE);

	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 1, WS_CDESTADO, 200);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 2, WS_NMESTADO, 200);
	DBMS_SQL.DEFINE_COLUMN(WS_CURSOR, 3, WS_JSON);

    WS_LINHAS := DBMS_SQL.EXECUTE(WS_CURSOR);

    LOOP

	    WS_LINHAS := DBMS_SQL.FETCH_ROWS(WS_CURSOR);
		IF  WS_LINHAS <> 1 THEN EXIT; END IF;

        DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 1, WS_CDESTADO);
	    DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 2, WS_NMESTADO);
		DBMS_SQL.COLUMN_VALUE(WS_CURSOR, 3, WS_JSON);
	    
		IF WS_CDESTADO <> WS_NAME THEN
		    IF WS_COUNT > 0 THEN
			    HTP.P(' }}');
	            HTP.P('</li>');
			END IF;
		    WS_NAME := WS_CDESTADO;
			WS_DESC := WS_NMESTADO;
			HTP.P('<li data-sigla="'||WS_NAME||'" data-nome="'||WS_DESC||'">');
            HTP.PRN('{ "type": "Feature", "properties": { "name": "'||WS_NAME||'", "nome": "'||WS_DESC||'", "sigla": "'||WS_NAME||'" }, "geometry": { "type": "MultiPolygon", "coordinates": ');
		    WS_COUNT := WS_COUNT+1;
		END IF;

		HTP.PRN(TRIM(WS_JSON));
			    
	END LOOP;

	DBMS_SQL.CLOSE_CURSOR(WS_CURSOR);
	
	HTP.PRN(' }}');
	HTP.P('</li>');

EXCEPTION WHEN OTHERS THEN
    HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END LISTA_ESTADOS;

PROCEDURE DATA_ATTRIB ( PRM_OBJETO VARCHAR2 DEFAULT NULL,
                        PRM_TIPO   VARCHAR2 DEFAULT NULL,
						PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_ATRIBUTOS IS
	SELECT T1.CD_PROP AS CD_PROP, COALESCE(T3.PROPRIEDADE, T2.VL_DEFAULT, T1.VL_DEFAULT) AS VALOR
	FROM BI_OBJECT_PADRAO T1
	LEFT JOIN
	OBJECT_PADRAO T2 ON T2.CD_PROP = T1.CD_PROP AND T2.TP_OBJETO = T1.TP_OBJETO 
	LEFT JOIN
	OBJECT_ATTRIB T3 ON T3.CD_PROP = T1.CD_PROP AND T3.CD_OBJECT = REPLACE(PRM_OBJETO, 'trl', '') 
	WHERE T1.TP_OBJETO = PRM_TIPO
	AND NVL(T1.SUFIXO, 'N/A') <> 'N/A';
	
	WS_ATTRIB CRS_ATRIBUTOS%ROWTYPE;

BEGIN

    HTP.P('<span id="atributos_'||PRM_OBJETO||'"');
	
	    OPEN CRS_ATRIBUTOS;
		    LOOP
			    FETCH CRS_ATRIBUTOS INTO WS_ATTRIB;
				EXIT WHEN CRS_ATRIBUTOS%NOTFOUND;
				
				    HTP.P(' data-'||LOWER(WS_ATTRIB.CD_PROP)||'="'||FUN.SUBPAR(WS_ATTRIB.VALOR, PRM_SCREEN)||'"');
			END LOOP;
		CLOSE CRS_ATRIBUTOS;
	
	HTP.P('></span>');

END DATA_ATTRIB;

PROCEDURE BROKEN_JOB ( PRM_NUM VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER;
 
BEGIN

    SELECT COUNT(*) INTO WS_COUNT FROM ALL_JOBS WHERE BROKEN = 'Y' AND JOB = PRM_NUM;

	IF WS_COUNT <> 0 THEN
        DBMS_JOB.REMOVE(PRM_NUM);
		VERIFICA_JOB;
	END IF;
	
	SELECT COUNT(*) INTO WS_COUNT FROM ALL_JOBS WHERE BROKEN = 'Y' AND JOB = PRM_NUM;
	
	IF WS_COUNT = 0 THEN
	    HTP.P('JOB FIXADO');
	ELSE
	    HTP.P('ERRO AO RESOLVER O JOB');
	END IF;

END BROKEN_JOB;

PROCEDURE SVG ( PRM_COD NUMBER DEFAULT 99 ) AS

BEGIN

    CASE PRM_COD 
	    WHEN 1 THEN
		    
		    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 201.387 201.387" style="enable-background:new 0 0 201.387 201.387;" xml:space="preserve"> <g> <g> <path d="M129.413,24.885C127.389,10.699,115.041,0,100.692,0C91.464,0,82.7,4.453,77.251,11.916 c-1.113,1.522-0.78,3.657,0.742,4.77c1.517,1.109,3.657,0.78,4.768-0.744c4.171-5.707,10.873-9.115,17.93-9.115 c10.974,0,20.415,8.178,21.963,19.021c0.244,1.703,1.705,2.932,3.376,2.932c0.159,0,0.323-0.012,0.486-0.034 C128.382,28.479,129.679,26.75,129.413,24.885z"/> </g> </g> <g> <g> <path d="M178.712,63.096l-10.24-17.067c-0.616-1.029-1.727-1.657-2.927-1.657h-9.813c-1.884,0-3.413,1.529-3.413,3.413 s1.529,3.413,3.413,3.413h7.881l6.144,10.24H31.626l6.144-10.24h3.615c1.884,0,3.413-1.529,3.413-3.413s-1.529-3.413-3.413-3.413 h-5.547c-1.2,0-2.311,0.628-2.927,1.657l-10.24,17.067c-0.633,1.056-0.648,2.369-0.043,3.439s1.739,1.732,2.97,1.732h150.187 c1.231,0,2.364-0.662,2.97-1.732S179.345,64.15,178.712,63.096z"/> </g> </g> <g> <g> <path d="M161.698,31.623c-0.478-0.771-1.241-1.318-2.123-1.524l-46.531-10.883c-0.881-0.207-1.809-0.053-2.579,0.423 c-0.768,0.478-1.316,1.241-1.522,2.123l-3.509,15c-0.43,1.835,0.71,3.671,2.546,4.099c1.835,0.43,3.673-0.71,4.101-2.546 l2.732-11.675l39.883,9.329l-6.267,26.795c-0.43,1.835,0.71,3.671,2.546,4.099c0.263,0.061,0.524,0.09,0.782,0.09 c1.55,0,2.953-1.062,3.318-2.635l7.045-30.118C162.328,33.319,162.176,32.391,161.698,31.623z"/> </g> </g> <g> <g> <path d="M102.497,39.692l-3.11-26.305c-0.106-0.899-0.565-1.72-1.277-2.28c-0.712-0.56-1.611-0.816-2.514-0.71l-57.09,6.748 c-1.871,0.222-3.209,1.918-2.988,3.791l5.185,43.873c0.206,1.737,1.679,3.014,3.386,3.014c0.133,0,0.27-0.009,0.406-0.024 c1.87-0.222,3.208-1.918,2.988-3.791l-4.785-40.486l50.311-5.946l2.708,22.915c0.222,1.872,1.91,3.202,3.791,2.99 C101.379,43.261,102.717,41.564,102.497,39.692z"/> </g> </g> <g> <g> <path d="M129.492,63.556l-6.775-28.174c-0.212-0.879-0.765-1.64-1.536-2.113c-0.771-0.469-1.696-0.616-2.581-0.406L63.613,46.087 c-1.833,0.44-2.961,2.284-2.521,4.117l3.386,14.082c0.44,1.835,2.284,2.964,4.116,2.521c1.833-0.44,2.961-2.284,2.521-4.117 l-2.589-10.764l48.35-11.626l5.977,24.854c0.375,1.565,1.775,2.615,3.316,2.615c0.265,0,0.533-0.031,0.802-0.096 C128.804,67.232,129.932,65.389,129.492,63.556z"/> </g> </g> <g> <g> <path d="M179.197,64.679c-0.094-1.814-1.592-3.238-3.41-3.238H25.6c-1.818,0-3.316,1.423-3.41,3.238l-6.827,133.12 c-0.048,0.934,0.29,1.848,0.934,2.526c0.645,0.677,1.539,1.062,2.475,1.062h163.84c0.935,0,1.83-0.384,2.478-1.062 c0.643-0.678,0.981-1.591,0.934-2.526L179.197,64.679z M22.364,194.56l6.477-126.293h143.701l6.477,126.293H22.364z"/> </g> </g> <g> <g> <path d="M126.292,75.093c-5.647,0-10.24,4.593-10.24,10.24c0,5.647,4.593,10.24,10.24,10.24c5.647,0,10.24-4.593,10.24-10.24 C136.532,79.686,131.939,75.093,126.292,75.093z M126.292,88.747c-1.883,0-3.413-1.531-3.413-3.413s1.531-3.413,3.413-3.413 c1.882,0,3.413,1.531,3.413,3.413S128.174,88.747,126.292,88.747z"/> </g> </g> <g> <g> <path d="M75.092,75.093c-5.647,0-10.24,4.593-10.24,10.24c0,5.647,4.593,10.24,10.24,10.24c5.647,0,10.24-4.593,10.24-10.24 C85.332,79.686,80.739,75.093,75.092,75.093z M75.092,88.747c-1.882,0-3.413-1.531-3.413-3.413s1.531-3.413,3.413-3.413 s3.413,1.531,3.413,3.413S76.974,88.747,75.092,88.747z"/> </g> </g> <g> <g> <path d="M126.292,85.333h-0.263c-1.884,0-3.413,1.529-3.413,3.413c0,0.466,0.092,0.911,0.263,1.316v17.457 c0,12.233-9.953,22.187-22.187,22.187s-22.187-9.953-22.187-22.187V88.747c0-1.884-1.529-3.413-3.413-3.413 s-3.413,1.529-3.413,3.413v18.773c0,15.998,13.015,29.013,29.013,29.013s29.013-13.015,29.013-29.013V88.747 C129.705,86.863,128.176,85.333,126.292,85.333z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		WHEN 2 THEN
		    
			HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M85.072,454.931c-1.859-1.861-4.439-2.93-7.069-2.93s-5.21,1.069-7.07,2.93c-1.86,1.861-2.93,4.44-2.93,7.07 s1.069,5.21,2.93,7.069c1.86,1.86,4.44,2.931,7.07,2.931s5.21-1.07,7.069-2.931c1.86-1.859,2.931-4.439,2.931-7.069 S86.933,456.791,85.072,454.931z"/> </g> </g> <g> <g> <path d="M469.524,182.938c-1.86-1.861-4.43-2.93-7.07-2.93c-2.63,0-5.21,1.069-7.07,2.93c-1.859,1.86-2.93,4.44-2.93,7.07 s1.07,5.21,2.93,7.069c1.86,1.86,4.44,2.931,7.07,2.931c2.64,0,5.21-1.07,7.07-2.931c1.869-1.859,2.939-4.439,2.939-7.069 S471.393,184.798,469.524,182.938z"/> </g> </g> <g> <g> <path d="M509.065,2.929C507.189,1.054,504.645,0,501.992,0L255.998,0.013c-5.522,0-9.999,4.478-9.999,10V38.61l-94.789,25.399 c-5.335,1.43-8.501,6.913-7.071,12.247l49.127,183.342l-42.499,42.499c-5.409-7.898-14.491-13.092-24.764-13.092H30.006 c-16.542,0-29.999,13.458-29.999,29.999v162.996C0.007,498.542,13.464,512,30.006,512h95.998c14.053,0,25.875-9.716,29.115-22.78 l11.89,10.369c9.179,8.004,20.939,12.412,33.118,12.412h301.867c5.522,0,10-4.478,10-10V10 C511.992,7.348,510.94,4.804,509.065,2.929z M136.002,482.001c0,5.513-4.486,10-10,10H30.005c-5.514,0-10-4.486-10-10V319.005 c0-5.514,4.486-10,10-10h37.999V424.2c0,5.522,4.478,10,10,10s10-4.478,10-10V309.005h37.999c5.514,0,10,4.486,10,10V482.001z M166.045,80.739l79.954-21.424V96.37l-6.702,1.796c-2.563,0.687-4.746,2.362-6.072,4.659s-1.686,5.026-0.999,7.588 c3.843,14.341-4.698,29.134-19.039,32.977c-2.565,0.688-4.752,2.366-6.077,4.668c-1.325,2.301-1.682,5.035-0.989,7.599 l38.979,144.338h-20.07l-10.343-40.464c-0.329-1.288-0.905-2.475-1.676-3.507L166.045,80.739z M245.999,142.229v84.381 l-18.239-67.535C235.379,155.141,241.614,149.255,245.999,142.229z M389.663,492H200.125V492c-7.345,0-14.438-2.658-19.974-7.485 l-24.149-21.061V325.147l43.658-43.658l7.918,30.98c1.132,4.427,5.119,7.523,9.688,7.523l196.604,0.012c7.72,0,14,6.28,14,14 c0,7.72-6.28,14-14,14H313.13c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h132.04c7.72,0,14,6.28,14,14c0,7.72-6.28,14-14,14 H313.13c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h110.643c7.72,0,14,6.28,14,14c0,7.72-6.28,14-14,14H313.13 c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h76.533c7.72,0,14,6.28,14,14C403.662,485.72,397.382,492,389.663,492z M491.994,492h-0.001h-71.359c1.939-4.273,3.028-9.01,3.028-14s-1.089-9.727-3.028-14h3.139c18.747,0,33.999-15.252,33.999-33.999 c0-5.468-1.305-10.635-3.609-15.217c14.396-3.954,25.005-17.149,25.005-32.782c0-7.584-2.498-14.595-6.711-20.255V235.007 c0-5.522-4.478-10-10-10c-5.522,0-10,4.478-10,10v113.792c-2.35-0.515-4.787-0.795-7.289-0.795h-0.328 c1.939-4.273,3.028-9.01,3.028-14c0-18.748-15.252-33.999-33.999-33.999h-16.075c17.069-7.32,29.057-24.286,29.057-44.005 c0-26.389-21.468-47.858-47.857-47.858c-26.388,0-47.857,21.469-47.857,47.858c0,19.719,11.989,36.685,29.057,44.005h-54.663 V109.863c17.864-3.893,31.96-17.988,35.852-35.853h75.221c3.892,17.865,17.988,31.96,35.852,35.853v31.09c0,5.522,4.478,10,10,10 s10-4.478,10-10v-40.018c0-5.522-4.478-10-10-10c-14.847,0-26.924-12.079-26.924-26.925c0-5.522-4.478-10-10-10h-93.076 c-5.522,0-10,4.478-10,10c0,14.847-12.078,26.925-26.924,26.925c-5.522,0-10,4.478-10,10v199.069H266V20.011L491.994,20V492z M378.996,283.858c-15.361,0-27.857-12.497-27.857-27.857s12.497-27.858,27.857-27.858S406.853,240.64,406.853,256 S394.357,283.858,378.996,283.858z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		WHEN 3 THEN
		    
			HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212.755 212.755" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 212.755 212.755"> <g> <path d="M106.377,0C47.721,0,0,47.721,0,106.377s47.721,106.377,106.377,106.377s106.377-47.721,106.377-106.377   S165.034,0,106.377,0z M106.377,198.755C55.44,198.755,14,157.314,14,106.377S55.44,14,106.377,14s92.377,41.44,92.377,92.377   S157.314,198.755,106.377,198.755z"/> <path d="m113.377,100.096v-39.744c3.961,1.471 7.417,4.17 9.82,7.82 2.127,3.229 6.468,4.123 9.696,1.997 3.229-2.126 4.123-6.467 1.996-9.696-5.029-7.636-12.778-12.82-21.512-14.647v-11.12c0-3.866-3.134-7-7-7s-7,3.134-7,7v11.099c-15.493,3.23-27.168,16.989-27.168,33.426 0,16.437 11.676,30.198 27.168,33.428v39.744c-3.961-1.471-7.417-4.17-9.82-7.82-2.127-3.229-6.468-4.124-9.696-1.997-3.229,2.126-4.123,6.467-1.996,9.696 5.029,7.636 12.778,12.82 21.512,14.647v11.119c0,3.866 3.134,7 7,7s7-3.134 7-7v-11.098c15.493-3.23 27.168-16.989 27.168-33.426-2.84217e-14-16.437-11.675-30.198-27.168-33.428zm-27.168-20.865c0-8.653 5.494-16.027 13.168-18.874v37.748c-7.674-2.847-13.168-10.221-13.168-18.874zm27.168,73.166v-37.748c7.674,2.847 13.168,10.221 13.168,18.874s-5.493,16.027-13.168,18.874z"/> </g> </svg>');
	    WHEN 4 THEN
		    
			HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212.755 212.755" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 212.755 212.755"> <g> <path d="M106.377,0C47.721,0,0,47.721,0,106.377s47.721,106.377,106.377,106.377s106.377-47.721,106.377-106.377   S165.034,0,106.377,0z M106.377,198.755C55.44,198.755,14,157.314,14,106.377S55.44,14,106.377,14s92.377,41.44,92.377,92.377   S157.314,198.755,106.377,198.755z"/> <path d="m113.377,100.096v-39.744c3.961,1.471 7.417,4.17 9.82,7.82 2.127,3.229 6.468,4.123 9.696,1.997 3.229-2.126 4.123-6.467 1.996-9.696-5.029-7.636-12.778-12.82-21.512-14.647v-11.12c0-3.866-3.134-7-7-7s-7,3.134-7,7v11.099c-15.493,3.23-27.168,16.989-27.168,33.426 0,16.437 11.676,30.198 27.168,33.428v39.744c-3.961-1.471-7.417-4.17-9.82-7.82-2.127-3.229-6.468-4.124-9.696-1.997-3.229,2.126-4.123,6.467-1.996,9.696 5.029,7.636 12.778,12.82 21.512,14.647v11.119c0,3.866 3.134,7 7,7s7-3.134 7-7v-11.098c15.493-3.23 27.168-16.989 27.168-33.426-2.84217e-14-16.437-11.675-30.198-27.168-33.428zm-27.168-20.865c0-8.653 5.494-16.027 13.168-18.874v37.748c-7.674-2.847-13.168-10.221-13.168-18.874zm27.168,73.166v-37.748c7.674,2.847 13.168,10.221 13.168,18.874s-5.493,16.027-13.168,18.874z"/> </g> </svg>');
		WHEN 5 THEN
		    
			HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M61.069,169.93C59.21,168.069,56.63,167,54,167s-5.209,1.07-7.07,2.93C45.069,171.79,44,174.37,44,177 s1.069,5.21,2.93,7.069C48.79,185.93,51.37,187,54,187s5.21-1.07,7.069-2.931C62.93,182.21,64,179.63,64,177 S62.93,171.79,61.069,169.93z"/> </g> </g> <g> <g> <path d="M438,0H235.667c-5.522,0-10,4.478-10,10s4.478,10,10,10H438c5.514,0,10,4.486,10,10v452c0,5.514-4.486,10-10,10H74 c-5.514,0-10-4.486-10-10V214.333c0-5.522-4.478-10-10-10s-10,4.478-10,10V482c0,16.542,13.458,30,30,30h364 c16.542,0,30-13.458,30-30V30C468,13.458,454.542,0,438,0z"/> </g> </g> <g> <g> <path d="M256,40c-6.804,0-13.642,0.52-20.324,1.544c-5.459,0.838-9.206,5.941-8.369,11.4c0.837,5.459,5.943,9.201,11.4,8.369 C244.39,60.441,250.208,60,256,60c62.309,0,113.001,50.692,113.001,113.001c0,27.67-10.002,53.043-26.574,72.71 c-7.333-12.61-17.349-23.487-29.506-31.924c-7.095-4.924-14.718-8.854-22.698-11.763c9.108-8.903,14.777-21.31,14.777-35.022 v-9.75c0-27.02-21.981-49.001-49-49.001c-27.019,0-49,21.981-49,49.001v9.75c0,13.712,5.668,26.119,14.777,35.022 c-7.979,2.909-15.602,6.839-22.698,11.763c-12.215,8.478-22.271,19.416-29.613,32.102c-12.627-15.005-21.453-33.461-24.906-54.05 c-0.913-5.445-6.074-9.119-11.516-8.208c-5.447,0.913-9.122,6.069-8.209,11.516c5.142,30.66,21.059,58.724,44.82,79.021 c24.031,20.529,54.696,31.835,86.344,31.835c73.337,0,133.001-59.664,133.001-133.001S329.337,40,256,40z M227,157.251 c0-15.991,13.01-29.001,29-29.001s29,13.01,29,29.001v9.75c0,15.99-13.01,29-29,29s-29-13.01-29-29V157.251z M256,286.002 c-27.074,0-52.104-9.454-71.694-25.482c13.428-27.252,40.879-44.519,71.694-44.519c30.751,0,58.15,17.196,71.608,44.349 C308.101,276.371,283.154,286.002,256,286.002z"/> </g> </g> <g> <g> <path d="M348.357,398.002h-142c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h142c5.523,0,10-4.478,10-10 C358.357,402.48,353.879,398.002,348.357,398.002z"/> </g> </g> <g> <g> <path d="M170.71,344.93c-1.86-1.861-4.44-2.93-7.07-2.93s-5.21,1.07-7.07,2.93s-2.93,4.44-2.93,7.07 c0,2.639,1.071,5.21,2.93,7.069c1.86,1.861,4.44,2.931,7.07,2.931s5.21-1.07,7.07-2.931c1.87-1.859,2.93-4.439,2.93-7.069 S172.58,346.79,170.71,344.93z"/> </g> </g> <g> <g> <path d="M170.71,400.93c-1.86-1.861-4.43-2.93-7.07-2.93c-2.63,0-5.21,1.07-7.07,2.93s-2.93,4.44-2.93,7.07 c0,2.639,1.071,5.21,2.93,7.069c1.86,1.861,4.44,2.931,7.07,2.931s5.21-1.07,7.07-2.931c1.87-1.859,2.93-4.429,2.93-7.069 C173.64,405.37,172.58,402.79,170.71,400.93z"/> </g> </g> <g> <g> <path d="M348.357,342.002h-142c-5.522,0-10,4.478-10,10c0,5.522,4.478,10,10,10h142c5.523,0,10-4.478,10-10 C358.357,346.48,353.879,342.002,348.357,342.002z"/> </g> </g> <g> <g> <path d="M161.626,57.629c-3.907-3.904-10.237-3.904-14.143,0l-32.566,32.566l-11.129-11.129c-3.907-3.904-10.237-3.904-14.143,0 c-3.905,3.906-3.905,10.238,0,14.143l18.2,18.2c1.953,1.952,4.511,2.929,7.071,2.929s5.118-0.977,7.072-2.928l39.638-39.638 C165.531,67.866,165.531,61.534,161.626,57.629z"/> </g> </g> <g> <g> <path d="M126,0C80.785,0,44,36.785,44,82c0,45.215,36.785,82,82,82c45.215,0,82-36.785,82-82C208,36.785,171.215,0,126,0z M126,144c-34.187,0-62-27.813-62-62s27.813-62,62-62s62,27.813,62,62S160.187,144,126,144z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
		WHEN 6 THEN
		    
			HTP.P('<svg height="480pt" viewBox="0 -7 480 479" width="480pt" xmlns="http://www.w3.org/2000/svg"><path d="m318.335938 229.730469c43.292968-33.5 60.488281-90.824219 42.785156-142.621094-17.699219-51.800781-66.382813-86.609375-121.121094-86.609375s-103.421875 34.808594-121.121094 86.609375c-17.703125 51.796875-.507812 109.121094 42.785156 142.621094-96.6875 33.472656-161.570312 124.503906-161.664062 226.824219v8h480v-8c-.09375-102.320313-64.976562-193.351563-161.664062-226.824219zm-190.335938-101.175781c-.019531-54.351563 38.984375-100.871094 92.507812-110.332032 53.519532-9.457031 106.109376 20.875 124.71875 71.9375 18.613282 51.066406-2.121093 108.121094-49.179687 135.320313-2.132813 1.234375-4.285156 2.386719-6.453125 3.464843-24.476562 11.789063-52.34375 14.492188-78.625 7.632813-9.476562-2.453125-18.570312-6.191406-27.03125-11.105469-34.566406-20.046875-55.871094-56.960937-55.9375-96.917968zm248 320v-88h-16v88h-240v-88h-16v88h-87.855469c3.519531-97.140626 69.21875-180.957032 162.710938-207.570313.738281.402344 1.496093.738281 2.234375 1.128906 1.238281.640625 2.476562 1.28125 3.742187 1.878907.945313.457031 1.894531.882812 2.855469 1.304687 1.789062.804687 3.589844 1.570313 5.410156 2.296875l.476563.183594c29.863281 11.714844 63.050781 11.714844 92.914062 0l.375-.136719c1.855469-.734375 3.6875-1.519531 5.503907-2.335937.929687-.414063 1.847656-.800782 2.769531-1.261719 1.269531-.617188 2.535156-1.265625 3.792969-1.921875.734374-.375 1.484374-.71875 2.214843-1.109375 93.480469 26.609375 159.183594 110.410156 162.710938 207.542969zm0 0"/></svg>');
	
	ELSE
	    HTP.P('');
	END CASE;

END;

PROCEDURE POPUPMENU ( PRM_TIPO VARCHAR2 DEFAULT NULL,
                      PRM_COND VARCHAR2 DEFAULT NULL ) AS

	WS_COUNT   NUMBER := 0;
	WS_USUARIO VARCHAR2(80);
	WS_ADMIN   VARCHAR2(10);
	WS_PADRAO  VARCHAR2(80);

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;
	WS_ADMIN   := GBL.GETNIVEL;
	WS_PADRAO  := GBL.GETLANG;

    CASE PRM_TIPO 
	    WHEN 'screengroup' THEN

		    HTP.P('<ul id="screengroup" data-usuario="'||WS_USUARIO||'" data-admin="'||WS_ADMIN||'">');
			
				FOR I IN(SELECT CD_GRUPO, NM_GRUPO FROM GRUPOS_FUNCAO WHERE CD_GRUPO IN 
				    (SELECT CD_GRUPO FROM OBJETOS WHERE CD_OBJETO IN 
					    (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = WS_USUARIO OR USUARIO IN 
						    (SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = WS_USUARIO) OR
							WS_ADMIN = 'A'
						)
					) OR CD_GRUPO IN 
					(SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = WS_USUARIO)
					
					
					ORDER BY ORDEM, NM_GRUPO
				) LOOP
					WS_COUNT := WS_COUNT+1;
					HTP.P('<li onclick="popupmenu(''screenlist'', '''||(I.CD_GRUPO)||''', '||WS_COUNT||');">');
						HTP.P('<span title="'||I.CD_GRUPO||'">'||FUN.UTRANSLATE('NM_GRUPO', 'GRUPOS_FUNCAO', I.NM_GRUPO, WS_PADRAO)||'</span>');
						
					    HTP.P('<svg class="down" xmlns="http://www.w3.org/2000/svg" width="292.362" height="292.362" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg>');
					HTP.P('</li>');
				END LOOP;

			HTP.P('</ul>');

        WHEN 'screenlist' THEN  

		    HTP.P('<ul id="screenlist">');

			    




				FOR I IN(SELECT CD_OBJETO, NM_OBJETO, DISPOSITIVO FROM OBJETOS T1
				    LEFT JOIN ALL_SCREENS T2 ON T2.SCREEN = T1.CD_OBJETO
				    WHERE UPPER(TRIM(CD_GRUPO)) = UPPER(TRIM(PRM_COND)) AND (CD_OBJETO LIKE ('SRC_%') OR TP_OBJETO = 'SCREEN') AND 
					(
						(CD_OBJETO IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = WS_USUARIO OR 
					    USUARIO IN (SELECT CD_GROUP FROM GUSERS_ITENS WHERE CD_USUARIO = WS_USUARIO)))
					 OR
					
                        CD_GRUPO IN (SELECT SCREEN FROM USER_SCREENS WHERE USUARIO = WS_USUARIO)

					 OR
					 WS_ADMIN = 'A'
					) 
					ORDER BY TO_NUMBER(T2.OR_ITEM), T1.NM_OBJETO
				) LOOP
				    IF ((INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') > 0 OR INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') > 0) AND NVL(I.DISPOSITIVO, '0') <> 'desktop' AND NVL(I.DISPOSITIVO, '0') <> 'nenhum') OR ((INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'iPhone') = 0 AND INSTR(OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'), 'Android') = 0) AND NVL(I.DISPOSITIVO, '0') <> 'mobile' AND NVL(I.DISPOSITIVO, '0') <> 'nenhum') OR WS_USUARIO = FUN.USUARIO THEN
					  HTP.P('<li onclick="shscr('''||I.CD_OBJETO||''');">'||FUN.UTRANSLATE('NM_OBJETO', I.CD_OBJETO, I.NM_OBJETO, WS_PADRAO)||'</li>');
					END IF;
				END LOOP;
			HTP.P('</ul>');
			
	END CASE;

END POPUPMENU;

PROCEDURE PERFIL AS

  WS_EMAIL   VARCHAR2(60) := '';
  WS_NUMBER  VARCHAR2(60) := '';
  WS_NOME    VARCHAR2(120);
  WS_CSS     VARCHAR2(80);
  WS_PADRAO  VARCHAR2(80);
  WS_USUARIO VARCHAR2(80);

  CURSOR CRS_TEMAS IS SELECT CD_TEMA, NM_TEMA 
  FROM BI_TEMA;

  WS_TEMA CRS_TEMAS%ROWTYPE;

BEGIN

    WS_USUARIO := GBL.GETUSUARIO;

	SELECT USU_EMAIL, USU_COMPLETO, USU_NUMBER INTO WS_EMAIL, WS_NOME, WS_NUMBER FROM USUARIOS WHERE TRIM(USU_NOME) = WS_USUARIO;
	SELECT NVL(FUN.GETPROP('DEFAULT','TEMA', PRM_USUARIO => WS_USUARIO), 'ideativo') INTO WS_CSS FROM DUAL;
	SELECT NVL(FUN.GETPROP('DEFAULT','LINGUAGEM', PRM_USUARIO => WS_USUARIO), 'PORTUGUES') INTO WS_PADRAO FROM DUAL;
    
    HTP.P('<div id="perfil" data-reload="N">');

	    HTP.P('<h4>'||FUN.LANG('Ol&aacute;')||', '||WS_NOME||'</h4>');
	   
		HTP.P('<ul>');

			HTP.P('<li class="readonly">');
			    HTP.P('<label>Login:</label>');
			    HTP.P('<input type="text"  value="'||WS_USUARIO||'" readonly />');
			HTP.P('</li>');

			HTP.P('<li>');
			    HTP.P('<label>'||FUN.LANG('Nome completo')||':</label>');
			    HTP.P('<input id="completo" type="text" value="'||WS_NOME||'"/>');
			HTP.P('</li>');

			HTP.P('<li>');
			    HTP.P('<label>'||FUN.LANG('Digite a nova senha')||':</label>');
			    HTP.P('<input id="senha1" type="password" name="p_senha" value="" maxlength="28" placeholder="'||FUN.LANG('Digite a nova senha')||'" />');
			HTP.P('</li>');

			--HTP.P('<li>');
			--    HTP.P('<label>Email:</label>');
			--    HTP.P('<input type="text" onkeypress="return input(event, ''email'');"  id="email" name="email" value="'||WS_EMAIL||'" maxlength="40" placeholder="Email"/>');
			--HTP.P('</li>');

			-- Alterado para não permitir que o usuário altere o email, o email deve ser parametrizado pelo admnistrado que criou o usuário (Solicitação do Fabiano para que o usuário não consiga colocar emails particular)
			htp.p('<li class="readonly">');
			    htp.p('<label>Email:</label>');
			    htp.p('<input type="text" id="email" name="email" value="'||ws_email||'" maxlength="40" placeholder="Email" readonly />');
			htp.p('</li>');
			
			HTP.P('<li>');
			    HTP.P('<label>'||FUN.LANG('Telefone')||':</label>');
				HTP.P('<input type="text" id="number" oninput="this.value = VMasker.toPattern(this.value, ''(99)99999-9999'');" name="number" value="'||WS_NUMBER||'" maxlength="40" placeholder="'||FUN.LANG('Telefone')||'"/>');
			HTP.P('</li>');

			HTP.P('<li id="temas">');
				HTP.P('<label>'||FUN.LANG('Temas')||':</label>');

					OPEN CRS_TEMAS; 
					    LOOP
						    FETCH CRS_TEMAS INTO WS_TEMA;
							EXIT WHEN CRS_TEMAS%NOTFOUND;
							IF WS_CSS = WS_TEMA.NM_TEMA THEN
								HTP.P('<a class="selectedtheme" style="background-color: '||WS_TEMA.CD_TEMA||'" onclick="document.getElementById(''perfil'').setAttribute(''data-reload'', ''S''); call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value='||WS_TEMA.NM_TEMA||'&prm_usuario='||WS_USUARIO||''').then(() => { this.parentNode.querySelector(''.selectedtheme'').classList.remove(''selectedtheme''); this.classList.add(''selectedtheme''); });"></a>');
							ELSE
								HTP.P('<a style="background-color: '||WS_TEMA.CD_TEMA||';" onclick="document.getElementById(''perfil'').setAttribute(''data-reload'', ''S''); call(''alter_attrib'', ''prm_objeto=DEFAULT&prm_prop=TEMA&prm_value='||WS_TEMA.NM_TEMA||'&prm_usuario='||WS_USUARIO||''').then(() => { this.parentNode.querySelector(''.selectedtheme'').classList.remove(''selectedtheme''); this.classList.add(''selectedtheme''); });"></a>');
							END IF;
						END LOOP;
					CLOSE CRS_TEMAS;

			HTP.P('</li>');

			HTP.P('<li>');
			    HTP.P('<label>'||FUN.LANG('Linguagem')||':</label>');
				HTP.P('<select onchange="ajax(''fly'', ''alter_attrib'',  ''prm_objeto=DEFAULT&prm_prop=LINGUAGEM&prm_value=''+this.value+''&prm_usuario='||WS_USUARIO||''');">');
                    FOR I IN(SELECT DISTINCT NM_LANG FROM LANGUAGE) LOOP
					    IF WS_PADRAO = I.NM_LANG THEN
						    HTP.P('<option value="'||I.NM_LANG||'" selected>'||I.NM_LANG||'</option>');
					    ELSE
                            HTP.P('<option value="'||I.NM_LANG||'">'||I.NM_LANG||'</option>');
						END IF;
					END LOOP;
				HTP.P('</select>');
			HTP.P('</li>');

		HTP.P('</ul>');

		
























        HTP.P('<div style="width: 100%; display: flex; min-height: 46px;">');
            HTP.P('<a class="addpurple" onclick="save_usuario();">'||FUN.LANG('ALTERAR')||'</a>');
        HTP.P('</div>');

	HTP.P('</div>');

END PERFIL;

PROCEDURE ALERTA AS

BEGIN

    HTP.P('<ul id="feed-fixo"></ul>');

	HTP.P('<ul style="display: none;" id="alerta-template">');
		HTP.P('<li>');
			HTP.P('<span></span>');
			HTP.P('<a onclick="var template = this.parentNode; template.classList.add(''clicked''); setTimeout(function(){ template.parentNode.removeChild(template); }, 300);">'||FUN.LANG('FECHAR')||'</a>');
			HTP.P('<span style="display: none;" onclick="this.nextElementSibling.classList.toggle(''show'');">mais detalhes</span>');
			HTP.P('<span></span>');
		HTP.P('</li>');
	HTP.P('</ul>');

END ALERTA;

PROCEDURE USERINFO ( PRM_NOME  VARCHAR2 DEFAULT NULL,
					 PRM_EMAIL VARCHAR2 DEFAULT NULL,
					 PRM_CELL  VARCHAR2 DEFAULT NULL,
					 PRM_NOTIFICACAO VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT      NUMBER;
    WS_COUNTUSER  NUMBER;
    WS_NMCOMPLETO VARCHAR2(100);
    WS_EMAIL      VARCHAR2(100);
    WS_NUMERO     VARCHAR2(100);
	WS_USUARIO    VARCHAR2(80);

	BEGIN

	    WS_USUARIO := GBL.GETUSUARIO;

		IF NVL(GBL.GETNIVEL, 'N') <> 'A' THEN

			SELECT COUNT(NM_USER) INTO WS_COUNTUSER FROM BI_INFO_USER WHERE NM_USER = WS_USUARIO;

			IF WS_COUNTUSER = 0 THEN

				IF NVL(PRM_NOME, 'N/A') = 'N/A' THEN

					SELECT USU_COMPLETO, USU_EMAIL, USU_NUMBER INTO WS_NMCOMPLETO, WS_EMAIL, WS_NUMERO FROM USUARIOS WHERE USU_NOME = WS_USUARIO;

							HTP.P('<div id="blockpage">');

								HTP.P('<div id="infocontainer" class="open">');

									HTP.P('<h1>Atualizar Informa&ccedil;&otilde;es</h1>');
									HTP.P('<ul id="infocontent">');
										HTP.P('<li>');
											HTP.P('<label>Nome Completo</label>');
											HTP.P('<input id="boxnome" type="text" value="'||WS_NMCOMPLETO||'" onchange="enviodecampos();">');
										HTP.P('</li>');

										-- Desabilitado a alteração do email, o usuário final não deve ter permissão de alterar o seu endereço de email  
										htp.p('<li>');
											htp.p('<label>E-mail</label>');
											htp.p('<input id="boxemail" class="readonly" readonly type="text" value="'||ws_email||'" onchange="enviodecampos();"/>');
										htp.p('</li>');
										
										--HTP.P('<li>');
										--	HTP.P('<label>E-mail</label>');
										--	HTP.P('<input id="boxemail" class="boxtext" type="text" value="'||WS_EMAIL||'" onchange="enviodecampos();"/>');
										--HTP.P('</li>');

										HTP.P('<li>');
											HTP.P('<label>Celular</label>');
											HTP.P('<input id="boxcelular" class="boxtext" type="text" value="'||WS_NUMERO||'" onchange="enviodecampos();"/>');
										HTP.P('</li>');

										HTP.P('<h2>Receber Notifica&ccedil;&otilde;es</h2>');
										HTP.P('<li>');    
											HTP.P('<span>E-mail</span>');
											HTP.P('<input id="checkemail" class="checknotify" title="email" type="checkbox" />'); 
											HTP.P('<span>Celular</span>'); 
											HTP.P('<input id="checkcell" class="checknotify" checked title="celular" type="checkbox"/>');            
										HTP.P('</li>');

									HTP.P('</ul>');

									HTP.P('<div class="concluir">');
										HTP.P('<a class="boxconcluir addpurple" onclick="enviodecampos(''enviar'');">CONCLUIR</a>');
									HTP.P('</div>');

									HTP.P('<span id="motivo">');    
										HTP.P('<span title="Os dados coletados ser&atilde;o de uso exclusivo do sistema, podendo ser usados para contato e novos recursos da ferramenta.">Porque devo informar estes dados?</span>');          
									HTP.P('</span>');

								HTP.P('</div>');
							HTP.P('</div>');    

						


				ELSE
					UPDATE USUARIOS SET USU_COMPLETO = PRM_NOME, /*USU_EMAIL = PRM_EMAIL, */ USU_NUMBER = PRM_CELL WHERE USU_NOME = WS_USUARIO;

					INSERT INTO BI_INFO_USER VALUES(WS_USUARIO, PRM_NOTIFICACAO);

					COMMIT;

				END IF;

			END IF;

		END IF;

	EXCEPTION
	WHEN OTHERS THEN
		HTP.P(SQLERRM);

END USERINFO;

PROCEDURE RELEASE_VERSION ( PRM_VERSION VARCHAR2 DEFAULT NULL ) AS

	










BEGIN

	HTP.P('/* ARQUIVO VER '||PRM_VERSION||' */'||CHR(13)||CHR(10));

	




















EXCEPTION WHEN OTHERS THEN
	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END RELEASE_VERSION;

PROCEDURE BUTTON_LIXO ( PRM_REQ      VARCHAR2 DEFAULT NULL,
						PRM_PARM     VARCHAR2 DEFAULT NULL,	
						PRM_VALORES  VARCHAR2 DEFAULT NULL,
						PRM_VLDECODE NUMBER   DEFAULT NULL,
						PRM_OBJETO   VARCHAR2 DEFAULT NULL,
						PRM_TAG      VARCHAR2 DEFAULT 'a',
						PRM_PKG      VARCHAR2 DEFAULT 'FCL'  ) AS

BEGIN	

    HTP.P('<'||PRM_TAG||' class="remove" data-require="'||PRM_REQ||'" data-param="'||PRM_PARM||'" data-valor="'||PRM_VALORES||'" data-decode="'||PRM_VLDECODE||'" data-objeto="'||PRM_OBJETO||'" data-pkg="'||PRM_PKG||'" title="'||FUN.LANG('Excluir')||'">X</'||PRM_TAG||'>');

END BUTTON_LIXO;











PROCEDURE JUMPDRILL ( PRM_OBJETO  VARCHAR2, 
                      PRM_COLUNAS VARCHAR2 DEFAULT NULL,
					  PRM_VISAO   VARCHAR2 DEFAULT NULL,
					  PRM_OBJETO_ANT VARCHAR2 DEFAULT NULL ) AS

    CURSOR CRS_FILTROS_OBJETO IS
        SELECT TRIM(CD_COLUNA)||'|'||DECODE(RTRIM(CONDICAO),'IGUAL','$[IGUAL]','DIFERENTE','$[DIFERENTE]','MAIOR','$[MAIOR]','MENOR','$[MENOR]','MAIOROUIGUAL','$[MAIOROUIGUAL]','MENOROUIGUAL','$[MENOROUIGUAL]','LIKE','$[LIKE]','NOTLIKE','$[NOTLIKE]','$[IGUAL]')||RTRIM(CONTEUDO) AS COLUNA
        FROM FILTROS
        WHERE TRIM(MICRO_VISAO) = TRIM(PRM_VISAO) AND
		    
            TRIM(CD_OBJETO) IN (REPLACE(TRIM(PRM_OBJETO), 'trl', ''), TRIM('xxx')) AND
            TRIM(CD_USUARIO)  = 'DWU' AND 
            TP_FILTRO = 'objeto' AND
            LIGACAO <> 'or' AND
			ST_AGRUPADO = 'N' AND CONDICAO <> 'NOFLOAT' AND CONDICAO <> 'NOFILTER';

    WS_FILTROS_OBJETO CRS_FILTROS_OBJETO%ROWTYPE;
	
	WS_PARAMETROS CLOB;
	WS_COLUNAS    VARCHAR2(20000);
	WS_FILTRO     NUMBER;

BEGIN

    select count(*) into ws_filtro from object_attrib where cd_prop = 'FILTRO' and (propriedade = 'ISOLADO' or propriedade = 'COM CORTE' or propriedade = 'INTERROMPIDO') and cd_object = prm_objeto;
	
	IF WS_FILTRO = 0 THEN
		OPEN CRS_FILTROS_OBJETO;
			LOOP
				FETCH CRS_FILTROS_OBJETO INTO WS_FILTROS_OBJETO;
				EXIT WHEN CRS_FILTROS_OBJETO%NOTFOUND;
				WS_PARAMETROS := WS_PARAMETROS||WS_FILTROS_OBJETO.COLUNA||'|';
				
			END LOOP;
		CLOSE CRS_FILTROS_OBJETO;
	END IF;

    HTP.PRN('<div id="jumpdrill" class="" data-parametros="'||WS_PARAMETROS||'" data-visao="'||PRM_VISAO||'">');
	    HTP.P('<a class="fechartab">x</a>');
		HTP.P('<a class="script" onclick="drillChange(this.nextElementSibling.title, this.parentNode, '''||PRM_OBJETO_ANT||'|'||REPLACE(PRM_OBJETO, 'trl', '')||''');"></a>');
		FCL.FAKEOPTION('lista-drill', FUN.LANG('Lista de drills'), '', 'lista-drill', 'N', 'N', '##'||REPLACE(PRM_OBJETO, 'trl', ''), '', PRM_OBJETO_ANT||'|'||REPLACE(TRIM(PRM_OBJETO), 'trl', '')); 

        HTP.P('<ul>');
			
			HTP.P('<li>');
				HTP.P('<span class="icons" title="ponto de avalia&ccedil;&atilde;o" data-tipo="VALOR">');
				    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <path d="M400.388,175.787c-1.707-3.413-4.267-5.12-7.68-5.12H292.015L391.855,12.8c1.707-2.56,1.707-5.973,0-8.533 S387.588,0,384.175,0H247.642c-3.413,0-5.973,1.707-7.68,4.267l-128,256c-1.707,2.56-1.707,5.973,0,8.533 c1.707,2.56,5.12,4.267,7.68,4.267h87.893l-95.573,227.84c-1.707,3.413,0,7.68,3.413,10.24c0.853,0.853,2.56,0.853,4.267,0.853 c2.56,0,5.12-0.853,6.827-2.56l273.067-324.267C401.242,182.613,402.095,179.2,400.388,175.787z M149.508,454.827l78.507-187.733 c0.853-2.56,0.853-5.12-0.853-7.68c-1.707-1.707-4.267-3.413-6.827-3.413h-87.04L252.762,17.067h116.053L268.122,174.933 c-1.707,2.56-1.707,5.973,0,8.533s4.267,4.267,7.68,4.267h98.987L149.508,454.827z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
					
				HTP.P('</span>');
				HTP.P('<span class="icons" title="gr&aacute;fico de pizza" data-tipo="PIZZA">');
				    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <g> <path d="M234.667,263.019V32c0-5.888-4.779-10.667-10.667-10.667c-123.52,0-224,110.059-224,245.333S110.059,512,245.333,512 c60.523,0,93.269-10.965,134.784-45.099c4.459-3.669,5.184-10.219,1.643-14.784L234.667,263.019z M245.333,490.667 c-123.52,0-224-100.48-224-224c0-119.552,85.184-217.536,192-223.701v223.701c0,2.368,0.789,4.672,2.261,6.549l142.848,183.659 C324.757,482.603,296.661,490.667,245.333,490.667z"/> <path d="M266.667,256h234.667c5.888,0,10.667-4.779,10.667-10.667C512,110.059,401.941,0,266.667,0 C260.779,0,256,4.779,256,10.667v234.667C256,251.221,260.779,256,266.667,256z M277.333,21.589 c115.051,5.419,207.659,98.027,213.077,213.077H277.333V21.589z"/> <path d="M501.333,277.333H288c-4.096,0-7.872,2.368-9.643,6.08c-1.771,3.712-1.237,8.107,1.344,11.285l138.667,171.669 c1.856,2.325,4.587,3.733,7.552,3.947c0.256,0.021,0.491,0.021,0.747,0.021c2.688,0,5.291-1.024,7.275-2.859 C483.541,421.205,512,355.797,512,288C512,282.112,507.221,277.333,501.333,277.333z M427.584,443.819L310.336,298.667h180.075 C487.787,352.896,465.344,404.757,427.584,443.819z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('</span>');
				HTP.P('<span class="icons" title="gr&aacute;fico de linha" data-tipo="LINHAS">');
				    HTP.P('<svg height="512" viewBox="0 0 74 74" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m47.24 67h-2.97a1 1 0 0 1 0-2h2.97a1 1 0 1 1 0 2z"/><path d="m27.37 67h-24.37a1 1 0 0 1 0-2h24.37a1 1 0 1 1 0 2z"/><path d="m37.27 67h-2.9a1 1 0 0 1 0-2h2.9a1 1 0 1 1 0 2z"/><path d="m71 67h-16.76a1 1 0 0 1 0-2h15.76v-26a1 1 0 0 1 2 0v27a1 1 0 0 1 -1 1z"/><path d="m8 42a1 1 0 0 1 -.707-1.707l19.5-19.5a1 1 0 0 1 1.415 0l18.242 18.242 12.8-14.692a.959.959 0 0 1 .776-.343 1 1 0 0 1 .761.382l11 14a1 1 0 0 1 -1.573 1.236l-10.253-13.05-12.707 14.589a1 1 0 0 1 -.719.343 1.011 1.011 0 0 1 -.742-.293l-18.293-18.293-18.792 18.793a1 1 0 0 1 -.708.293z"/><path d="m8 59.75a1 1 0 0 1 -.707-1.707l19.5-19.5a1 1 0 0 1 1.415 0l18.242 18.242 12.8-14.692a.989.989 0 0 1 .779-.343 1 1 0 0 1 .761.382l11 14a1 1 0 0 1 -1.573 1.236l-10.256-13.05-12.707 14.589a1 1 0 0 1 -1.461.05l-18.293-18.293-18.792 18.793a1 1 0 0 1 -.708.293z"/><path d="m8 72a1 1 0 0 1 -1-1v-68a1 1 0 0 1 2 0v68a1 1 0 0 1 -1 1z"/></svg>');
				HTP.P('</span>');
				HTP.P('<span class="icons" title="gr&aacute;fico de coluna" data-tipo="COLUNAS">');
				    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 480 480" style="enable-background:new 0 0 480 480;" xml:space="preserve"> <g> <g> <g> <rect y="464" width="480" height="16"/> <path d="M32,448h80c4.418,0,8-3.582,8-8V296c0-4.418-3.582-8-8-8H32c-4.418,0-8,3.582-8,8v144C24,444.418,27.582,448,32,448z M40,304h64v128H40V304z"/> <path d="M256,448h80c4.418,0,8-3.582,8-8V200c0-4.418-3.582-8-8-8h-80c-4.418,0-8,3.582-8,8v240C248,444.418,251.582,448,256,448 z M264,208h64v224h-64V208z"/> <path d="M144,448h80c4.418,0,8-3.582,8-8V104c0-4.418-3.582-8-8-8h-80c-4.418,0-8,3.582-8,8v336C136,444.418,139.582,448,144,448 z M152,112h64v320h-64V112z"/> <path d="M368,448h80c4.418,0,8-3.582,8-8V8c0-4.418-3.582-8-8-8h-80c-4.418,0-8,3.582-8,8v432C360,444.418,363.582,448,368,448z M376,16h64v416h-64V16z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('</span>');
			    HTP.P('<span class="icons" title="gr&aacute;fico de barra" data-tipo="BARRAS">');
				    
					HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 480 480" style="enable-background:new 0 0 480 480;" xml:space="preserve"> <g> <g> <path d="M448,352H40v-56h272c4.8,0,8-3.2,8-8v-96c0-4.8-3.2-8-8-8H40v-56h144c4.8,0,8-3.2,8-8V24c0-4.8-3.2-8-8-8H40V8 c0-4.8-3.2-8-8-8s-8,3.2-8,8v464c0,4.8,3.2,8,8,8s8-3.2,8-8v-8h408c4.8,0,8-3.2,8-8v-96C456,355.2,452.8,352,448,352z M40,32h136 v80H40V32z M40,200h264v80H40V200z M440,448H40v-80h400V448z"/> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('</span>');
				HTP.P('<span class="icons" title="gr&aacute;fico de mapa" data-tipo="MAPA">');
				    HTP.P('<svg version="1.1" style="border: 1px solid #AAA; padding: 0 2px; border-radius: 4px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 423.221 423.221" style="enable-background:new 0 0 423.221 423.221;" xml:space="preserve"> <g> <path d="M352.346,231.706l7.955-0.378c2.06-0.099,3.976-0.979,5.394-2.48l8.351-8.842c2.28-2.414,2.815-6.032,1.329-9.003 l-5.843-11.564l12.973-7.983c1.674-1.03,2.901-2.637,3.456-4.521l5.253-17.86c1.133-3.855-0.797-7.955-4.49-9.538l-7.879-3.326 l1.049-6.1l9.008-3.793c2.151-0.904,3.788-2.7,4.491-4.927l1.269-4.014l10.367,12.253c1.516,1.791,3.712,2.818,6.026,2.818 c4.398,0,7.976-3.565,7.976-7.948l-0.001-13.994l-0.322-15.146c-0.214-10.079-8.578-18.279-18.645-18.279 c-0.747,0-1.504,0.045-2.25,0.135l-77.435,9.292l0.531-1.442c0.876-2.378,0.558-5.056-0.852-7.161 c-1.409-2.106-3.763-3.422-6.294-3.519l-9.848-0.379c-2.599-0.09-5.105,1.101-6.658,3.17l-24.181,32.253l-21.325,10.69 l-17.579-9.057c-1.12-0.576-2.376-0.881-3.634-0.881c-2.187,0-4.3,0.915-5.794,2.51l-16.302,17.388 c-2.068,2.206-2.704,5.34-1.658,8.177l2.943,7.884l-10.435,9.887l-9.946,5.759c-2.84,1.645-4.361,4.805-3.873,8.051l0.831,5.539 c0.578,3.856,3.955,6.766,7.854,6.765c1.125,0,2.221-0.236,3.257-0.702l8.502-3.827l10.604-4.494l10.86,7.602 c0.921,0.646,1.948,1.081,3.047,1.292l16.603,3.165v4.104l-34.356-5.153c-1.383-0.212-2.799-0.047-4.097,0.466l-22.403,8.843 c-2.456,0.97-4.263,3.087-4.835,5.664l-4.38,19.712c-0.621,2.791,0.314,5.713,2.439,7.624l10.325,9.294 c1.665,1.498,3.893,2.222,6.122,1.996l19.936-2.109l0.574,29.839c0.014,0.731,0.129,1.455,0.34,2.151l3.636,12 c2.232,7.368,8.905,12.318,16.604,12.318c6.49,0,12.385-3.575,15.385-9.33l27.542-52.836c1.64-3.145,0.978-7.037-1.61-9.464 l-3.589-3.364l5.584-1.861c2.629-0.877,4.58-3.012,5.216-5.709c0.637-2.697-0.153-5.479-2.113-7.438l-8.196-8.117l0.544-0.688 l17.154,11.061l13.818,19.96c1.483,2.143,3.921,3.421,6.523,3.421c2.989,0,5.696-1.649,7.064-4.304l6.159-12.105l13.825,9.823 c1.362,0.968,2.948,1.48,4.585,1.48c2.357-0.001,4.585-1.043,6.114-2.861c1.498-1.781,2.126-4.133,1.723-6.452L352.346,231.706z M245.226,298.895c-1.617,3.102-4.794,5.028-8.292,5.028c-4.149,0-7.745-2.668-8.948-6.639l-3.633-11.983l-0.574-29.84 c-0.042-2.214-1.017-4.325-2.675-5.793c-1.657-1.468-3.87-2.173-6.074-1.954l-19.956,2.067l-10.306-9.235l4.344-19.671 l22.372-8.839l37.33,5.6l14.892,19.379c0.341,0.455,9.062,9.044,9.062,9.044L245.226,298.895z M346.147,226.682 c-1.423,1.776-2.016,4.082-1.626,6.325l0.235,1.358l-13.705-9.738c-1.352-0.96-2.94-1.468-4.593-1.468 c-2.99,0-5.697,1.649-7.064,4.305l-6.182,12.064l-13.78-19.905c-0.596-0.86-1.344-1.584-2.225-2.152l-17.17-11.078 c-1.286-0.83-2.774-1.269-4.304-1.269c-2.267,0-4.43,0.972-5.936,2.665l-0.622,0.699c-2.789,3.138-2.648,7.921,0.32,10.89 l8.13,8.131l-9.099,3.075l-13.497-17.975v-7.436c0-3.795-2.704-7.073-6.431-7.796l-16.629-3.214l-10.862-7.603 c-2.212-1.549-5.144-1.863-7.636-0.814l-10.75,4.528l-8.507,3.911l-0.86-5.479l9.938-5.755c0.535-0.308,1.035-0.681,1.49-1.111 l10.445-9.895c2.309-2.186,3.09-5.527,1.991-8.511l-2.941-7.887l16.231-17.376l17.579,9.057c1.119,0.576,2.376,0.881,3.635,0.881 c1.226,0,2.453-0.29,3.551-0.838l21.385-10.692c1.095-0.55,2.061-1.356,2.796-2.335L303.607,102l9.794,0.3l-0.565,1.533 c-0.897,2.435-0.548,5.157,0.934,7.283c1.668,2.391,4.475,3.705,7.462,3.346l77.533-9.304c0.431-0.052,0.868-0.078,1.297-0.078 c5.748,0,10.524,4.688,10.647,10.449l0.321,15.062l-0.002,13.745l-10.33-12.209c-1.512-1.788-3.716-2.814-6.046-2.814 c-3.49,0-6.539,2.23-7.587,5.551l-1.267,4.08l-9.009,3.793c-2.497,1.052-4.268,3.271-4.738,5.938l-1.085,6.144 c-0.644,3.648,1.285,7.217,4.692,8.679l7.88,3.319l-5.228,17.826l-12.972,7.983c-3.531,2.172-4.794,6.606-2.94,10.313l5.831,11.574 l-8.311,8.824l-7.955,0.378C349.691,223.824,347.571,224.906,346.147,226.682z"/> <path d="M422.31,296.3l-9.319-17.706c-1.377-2.616-4.071-4.241-7.03-4.241c-2.629,0-5.073,1.293-6.558,3.468l-2.432-3.04 c-1.515-1.894-3.775-2.979-6.202-2.979c-1.437,0-2.849,0.391-4.083,1.132l-22.045,13.227c-2.104,1.261-3.526,3.47-3.805,5.907 l-1.877,16.424c-0.256,2.246,0.459,4.5,1.962,6.185c1.726,1.935,4.28,2.921,6.912,2.594l18.67-2.377l2.958,7.025 c1.242,2.952,4.114,4.859,7.316,4.859c0,0,0,0,0.001,0c0.455,0,0.913-0.04,1.362-0.118l10.25-1.782 c2.514-0.435,4.678-2.068,5.79-4.365l8.253-17.056C423.524,301.198,423.479,298.522,422.31,296.3z M407.02,316.996l-10.205,1.774 l-2.939-6.982c-1.243-2.951-4.115-4.858-7.317-4.858c-0.326,0-0.656,0.02-0.986,0.062l-18.665,2.407l1.849-16.379l21.969-13.242 l2.483,3.104c1.515,1.894,3.774,2.979,6.198,2.979c2.627,0,5.065-1.286,6.553-3.453l9.272,17.564L407.02,316.996z"/> <path d="M153.469,265.01l-37.698-24.424c-2.067-1.339-4.459-2.047-6.916-2.047c-3.966,0-7.648,1.844-10.051,4.947l-8.455-4.733 l-15.1-21.496h7.702c1.836,0,3.627-0.642,5.043-1.807l28.637-23.547l15.938-9.032c1.94-1.1,3.336-2.977,3.829-5.151 c0.494-2.175,0.045-4.471-1.231-6.301l-14.111-20.227c-1.531-2.193-4.057-3.468-6.713-3.395c-2.673,0.067-5.115,1.462-6.532,3.729 l-7.273,11.782l-8.339-9.378l16.573-12.187c3.068-2.257,4.102-6.388,2.459-9.822l-4.086-8.545 c-0.953-1.992-2.709-3.509-4.818-4.161c-2.11-0.653-4.415-0.391-6.323,0.715l-7.224,4.21l-32.646-13.813L32.686,97.102 c-2.844-1.604-6.443-1.283-8.957,0.795L11.31,108.156c-1.091,0.901-1.923,2.08-2.405,3.408l-8.429,23.181 c-0.871,2.393-0.534,5.079,0.9,7.185c1.435,2.105,3.811,3.4,6.358,3.467l17.89,0.422l11.355,28.074l-1.854,27.803 c-0.112,1.684,0.327,3.394,1.238,4.814l15.267,23.815c0.919,1.435,2.248,2.517,3.845,3.131l29.367,11.24 c0.266,0.254,0.562,0.465,0.876,0.633l8.586,4.807l-4.611,6.916c-1.646,2.469-1.782,5.619-0.355,8.222l9.663,17.604l-1.26,42.85 c-0.054,1.834,0.534,3.643,1.658,5.096l7.795,10.067c1.52,1.963,3.793,3.089,6.239,3.089c2.157,0,4.255-0.882,5.756-2.419 c1.485-1.521,2.274-3.552,2.222-5.719l-0.358-14.23l29.281-28.035c1.052-1.008,1.806-2.283,2.18-3.689l4.311-16.166 C157.713,270.388,156.365,266.888,153.469,265.01z M58.366,226.008l-15.258-23.78l1.854-27.803c0.079-1.189-0.115-2.4-0.561-3.504 l-11.36-28.102c-1.187-2.933-3.997-4.88-7.158-4.961L8.022,137.4l8.382-23.076l12.352-10.253l23.448,13.227 c0.265,0.149,0.538,0.283,0.807,0.396l32.653,13.815c2.281,0.964,4.924,0.798,7.07-0.441l7.194-4.239l4.105,8.471l-16.574,12.186 c-1.79,1.316-2.953,3.337-3.191,5.545s0.467,4.431,1.934,6.098l8.33,9.466c1.674,1.902,4.082,2.879,6.607,2.668 c2.525-0.206,4.744-1.557,6.087-3.705l7.321-11.713l14.079,20.065l-15.932,9.029c-0.394,0.222-0.773,0.482-1.134,0.777 l-28.608,23.54c0,0-8.894,0.001-8.941,0.002c-2.709,0.042-5.164,1.583-6.407,4.021c-1.277,2.505-1.072,5.482,0.536,7.771 l8.353,11.891L58.366,226.008z M144.799,287.798l-29.28,28.034c-1.608,1.54-2.5,3.699-2.447,5.924l0.333,14.091l-7.669-9.884 l1.26-42.851c0.041-1.412-0.295-2.813-0.975-4.051l-9.673-17.572l8.563-12.843c0.879-1.32,2.354-2.107,3.944-2.107 c0.91,0,1.797,0.263,2.566,0.762l37.673,24.358L144.799,287.798z"/> <path d="M136.06,107.943l4.304,3.261v39.436c0,4.382,3.567,7.947,7.951,7.947c1.535,0,3.034-0.45,4.335-1.302l27.258-17.822 c1.707-1.116,2.906-2.823,3.378-4.806l9.091-38.182c0.678-2.85-0.261-5.828-2.45-7.773l-8.403-7.47 c-2.229-1.982-5.52-2.545-8.282-1.414l-35.365,14.468c-2.666,1.09-4.485,3.446-4.865,6.301 C132.632,103.442,133.771,106.192,136.06,107.943z M176.209,87.212l8.384,7.411l-9.065,38.146l-27.165,17.76v-39.324 c0-2.458-1.165-4.816-3.117-6.308l-4.244-3.245L176.209,87.212z"/> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('</span>');
				HTP.P('<span class="icons" title="ponteiro" data-tipo="PONTEIRO">');
				    HTP.P('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"> <g> <g> <g> <path d="M366.292,215.99L241.417,325.781c-0.167,0.146-0.333,0.292-0.479,0.448c-4.042,4.021-6.271,9.385-6.271,15.104 c0,11.76,9.563,21.333,21.333,21.333c5.667,0,11.021-2.208,15.563-6.75l109.792-124.875c3.708-4.219,3.5-10.604-0.479-14.583 C376.896,212.49,370.542,212.281,366.292,215.99z"/> <path d="M256,85.333c-141.167,0-256,114.844-256,256c0,26.479,4.104,52.688,12.167,77.917c1.417,4.417,5.521,7.417,10.167,7.417 h467.333c4.646,0,8.75-3,10.167-7.417C507.896,394.021,512,367.813,512,341.333C512,200.177,397.167,85.333,256,85.333z M458.667,352h31.26c-0.824,18.04-3.237,35.947-8.177,53.333H30.25c-4.94-17.387-7.353-35.293-8.177-53.333h31.26 C59.229,352,64,347.229,64,341.333c0-5.896-4.771-10.667-10.667-10.667h-31.46c1.581-34.919,10.68-67.865,25.948-97.208 l27.324,15.781c1.688,0.969,3.521,1.427,5.333,1.427c3.667,0,7.271-1.906,9.229-5.333c2.958-5.104,1.208-11.625-3.896-14.573 l-27.263-15.746c18.323-28.539,42.602-52.816,71.142-71.138l15.746,27.28c1.958,3.417,5.563,5.333,9.229,5.333 c1.813,0,3.646-0.458,5.333-1.427c5.104-2.948,6.854-9.469,3.896-14.573l-15.777-27.332c29.345-15.27,62.293-24.37,97.215-25.951 v31.46c0,5.896,4.771,10.667,10.667,10.667s10.667-4.771,10.667-10.667v-31.46c34.922,1.581,67.87,10.681,97.215,25.951 l-15.777,27.332c-2.958,5.104-1.208,11.625,3.896,14.573c1.688,0.969,3.521,1.427,5.333,1.427c3.667,0,7.271-1.917,9.229-5.333 l15.746-27.28c28.54,18.322,52.819,42.599,71.142,71.138l-27.263,15.746c-5.104,2.948-6.854,9.469-3.896,14.573 c1.958,3.427,5.563,5.333,9.229,5.333c1.812,0,3.646-0.458,5.333-1.427l27.324-15.781c15.268,29.344,24.367,62.289,25.948,97.208 h-31.46c-5.896,0-10.667,4.771-10.667,10.667C448,347.229,452.771,352,458.667,352z"/> </g> </g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg>');
				HTP.P('</span>');
			HTP.P('</li>');

			HTP.P('<li id="quick-obj" class="quick-closed" data-tipo="" data-visao="" data-grupo="" colspan="9">');
			    IF GBL.GETNIVEL = 'A' THEN
				    HTP.P('<input placeholder="NOME DO NOVO OBJETO">');
				ELSE
					HTP.P('<input type="hidden" placeholder="NOME DO NOVO OBJETO" value="OBJETO">');
				END IF;
				HTP.P('<select id="quick-coluna">');
				    HTP.P('<option selected="true" disabled="true" value="">COLUNAS</option>');
					
					
                    FOR I IN(SELECT COLUMN_VALUE FROM TABLE(FUN.VPIPE((PRM_COLUNAS)))) LOOP
                        HTP.P('<option value="'||I.COLUMN_VALUE||'">'||FUN.CHECK_ROTULOC(I.COLUMN_VALUE, PRM_VISAO)||'</option>');
					END LOOP;
				HTP.P('</select>');
				HTP.P('<a id="confirm-tag" class="addpurple">+</a>');
			HTP.P('</li>');

		HTP.P('</ul>');

	HTP.PRN('</div>');

END JUMPDRILL;

PROCEDURE JUMPMED ( PRM_COLUNA VARCHAR2 DEFAULT NULL,
					PRM_VISAO  VARCHAR2 DEFAULT NULL, 
					PRM_OBJETO VARCHAR2 DEFAULT NULL ) AS

BEGIN

	FCL.FAKEOPTION('ID_'||PRM_COLUNA, 'colunas dispon&iacute;veis', '', 'lista-jumpmed', 'N', 'N', PRM_VISAO, '', PRM_OBJETO);

END;

PROCEDURE LISTACUSTOMIZADO ( PRM_USUARIO  VARCHAR2 DEFAULT NULL ) AS
		

BEGIN

	HTP.P('<table class="linha">');

		HTP.P('<thead>');
			HTP.P('<tr>');
				HTP.P('<th>VIEW</th>');
				HTP.P('<th>'||FUN.LANG('COLUNA')||'</th>');
				HTP.P('<th></th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		HTP.P('<tbody id="ajax" >');

			FOR I IN (SELECT CD_CUSTOM, NM_VISAO, NM_COLUNA FROM BI_CUSTOM_PERMISSAO WHERE NM_USUARIO = PRM_USUARIO) LOOP
				HTP.P('<tr>');
					HTP.P('<td>'||I.NM_VISAO||'</td>');
					HTP.P('<td>'||I.NM_COLUNA||'</td>');
					HTP.P('<td>');
						FCL.BUTTON_LIXO('deletaCustomizado','prm_chave', I.CD_CUSTOM, '', PRM_TAG => 'a');
					HTP.P('</td>');
				HTP.P('</tr>');
			END LOOP;

		HTP.P('</tbody>');
	HTP.P('</table>');

	HTP.P('<div class="listar"><a title="'||FUN.LANG('ir para a lista de usu&aacute;rios')||'" onclick="carregaPainel(''usuarios''); carrega(''list_users''); call_save(''''); document.getElementById(''titulo'').innerHTML = '''||FUN.LANG('USU&Aacute;RIOS')||''';">'||FUN.LANG('Listar usu&aacute;rios')||'</a></div>');

END LISTACUSTOMIZADO;

PROCEDURE ADDCUSTOMIZADO ( PRM_USUARIO  VARCHAR2 DEFAULT NULL,
                           PRM_VISAO    VARCHAR2 DEFAULT NULL,
						   PRM_COLUNAS  VARCHAR2 DEFAULT NULL ) AS

    WS_COUNT NUMBER := 0;

BEGIN

    INSERT INTO BI_CUSTOM_PERMISSAO (CD_CUSTOM, NM_USUARIO, NM_VISAO, NM_COLUNA) 
	SELECT ROWNUM+NVL((SELECT MAX(CD_CUSTOM) FROM BI_CUSTOM_PERMISSAO), 0), PRM_USUARIO, PRM_VISAO, COLUMN_VALUE FROM TABLE(FUN.VPIPE(PRM_COLUNAS));

	WS_COUNT := SQL%ROWCOUNT;


	IF WS_COUNT > 0 THEN	
	    COMMIT;
		HTP.P('ADICIONADO COM SUCESSO');
	ELSE
	    ROLLBACK;
        HTP.P('ERRO AO ADICIONAR');
	END IF;

EXCEPTION WHEN OTHERS THEN
    HTP.P('ERRO AO ADICIONAR');
END ADDCUSTOMIZADO;

PROCEDURE DELETACUSTOMIZADO ( PRM_CHAVE  NUMBER ) AS

    WS_COUNT NUMBER := 0;

BEGIN

    DELETE FROM BI_CUSTOM_PERMISSAO WHERE CD_CUSTOM = PRM_CHAVE;

	WS_COUNT := SQL%ROWCOUNT;

	IF WS_COUNT > 0 THEN
        HTP.P('EXCLUIDO COM SUCESSO');
	ELSE
        HTP.P('ERRO AO EXCLUIR');
	END IF;	

	COMMIT;
EXCEPTION WHEN OTHERS THEN
    HTP.P('ERRO AO EXCLUIR');
END DELETACUSTOMIZADO;

PROCEDURE DELETACUSTOM ( PRM_CUSTOM  NUMBER ) AS

    WS_COUNT NUMBER := 0;

BEGIN

    DELETE FROM BI_CUSTOM_FAV WHERE CD_CUSTOM = PRM_CUSTOM;

	WS_COUNT := SQL%ROWCOUNT;

	IF WS_COUNT > 0 THEN
        HTP.P('EXCLUIDO COM SUCESSO');
	ELSE
        HTP.P('ERRO AO EXCLUIR');
	END IF;	

	COMMIT;
EXCEPTION WHEN OTHERS THEN
    HTP.P('ERRO AO EXCLUIR');
END DELETACUSTOM;

PROCEDURE GERACUSTOMIZADO( PRM_CUSTOM       NUMBER   DEFAULT 0,
	                       PRM_VISAO        VARCHAR2 DEFAULT NULL,
						   PRM_COLUNA_AGRUP VARCHAR2 DEFAULT NULL,
						   PRM_COLUNA_VALOR VARCHAR2 DEFAULT NULL,
						   PRM_COLUNA_PIVOT VARCHAR2 DEFAULT NULL,
						   PRM_COLUNA_TIPO  VARCHAR2 DEFAULT NULL,
						   PRM_LIMITE       VARCHAR2 DEFAULT NULL,
						   FILTROPIPE       VARCHAR2 DEFAULT NULL,
						   PRM_TIPO         VARCHAR2 DEFAULT 'show',
						   PRM_DESC         VARCHAR2 DEFAULT NULL ) AS

	WS_URL VARCHAR2(6000);

BEGIN

    IF PRM_CUSTOM <> 0 AND PRM_TIPO = 'url' THEN
	    SELECT 'prm_visao='||CD_MICRO_VISAO||'&prm_coluna_agrup='||CS_AGRUPADOR||'&prm_coluna_valor='||CS_COLUNA||'&prm_coluna_pivot='||CS_COLUP||'&prm_coluna_tipo='||CS_RP||'&prm_desc='||DS_FAV||'||'||FILTRO INTO WS_URL FROM BI_CUSTOM_FAV WHERE CD_CUSTOM = PRM_CUSTOM;
	    HTP.P(WS_URL);
	ELSE
	    OBJ.SHOW_OBJETO(PRM_OBJETO => PRM_VISAO, PRM_PARAMETROS => PRM_COLUNA_AGRUP||'||'||PRM_COLUNA_VALOR||'||'||PRM_COLUNA_PIVOT||'||'||PRM_COLUNA_TIPO||'||'||REPLACE(FILTROPIPE, '||', '|'), PRM_DRILL => 'C', PRM_ZINDEX => PRM_LIMITE, PRM_SELF => PRM_CUSTOM);
	END IF;
EXCEPTION WHEN OTHERS THEN
  HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END GERACUSTOMIZADO;

PROCEDURE ADICIONACUSTOMIZADO ( PRM_CUSTOM       NUMBER   DEFAULT NULL,
                                PRM_VISAO        VARCHAR2 DEFAULT NULL,
								PRM_COLUNA_AGRUP VARCHAR2 DEFAULT NULL,
								PRM_COLUNA_VALOR VARCHAR2 DEFAULT NULL,
								PRM_COLUNA_PIVOT VARCHAR2 DEFAULT NULL,
								PRM_COLUNA_TIPO  VARCHAR2 DEFAULT NULL,
								PRM_LIMITE       VARCHAR2 DEFAULT NULL,
								FILTROPIPE       VARCHAR2 DEFAULT NULL,
                                PRM_DESC         VARCHAR2 DEFAULT NULL,
								PRM_GRUPO        VARCHAR2 DEFAULT NULL ) AS

	WS_CHAVE NUMBER;
	WS_COUNT NUMBER;
	WS_ERROR EXCEPTION;

BEGIN

    IF NVL(PRM_CUSTOM, 0) = 0 THEN

		SELECT NVL(MAX(CD_CUSTOM), 0)+1 INTO WS_CHAVE FROM BI_CUSTOM_FAV;
		INSERT INTO BI_CUSTOM_FAV (CD_CUSTOM, NM_USUARIO, DS_FAV, CD_MICRO_VISAO, CS_COLUNA, CS_AGRUPADOR, CS_COLUP, CS_RP, GRUPO, FILTRO)
		VALUES (WS_CHAVE, GBL.GETUSUARIO, PRM_DESC, PRM_VISAO, PRM_COLUNA_VALOR, PRM_COLUNA_AGRUP, PRM_COLUNA_PIVOT, PRM_COLUNA_TIPO, PRM_GRUPO, FILTROPIPE);

	ELSE

	    UPDATE BI_CUSTOM_FAV 
		SET 
		CD_MICRO_VISAO = PRM_VISAO, 
		CS_COLUNA      = PRM_COLUNA_VALOR, 
		CS_AGRUPADOR   = PRM_COLUNA_AGRUP, 
		CS_COLUP       = PRM_COLUNA_PIVOT, 
		CS_RP          = PRM_COLUNA_TIPO,
		DS_FAV 		   = PRM_DESC,
		GRUPO          = PRM_GRUPO,
		FILTRO         = FILTROPIPE
		WHERE CD_CUSTOM = PRM_CUSTOM;

	END IF;

    WS_COUNT := SQL%ROWCOUNT;

	IF WS_COUNT = 1 THEN
		COMMIT;
	ELSE
		ROLLBACK;
		RAISE WS_ERROR;
	END IF;

	HTP.P('ok');

EXCEPTION 
    WHEN WS_ERROR THEN
	    HTP.P('Ocorreu um erro ao adicionar uma consulta aos favoritos, tente novamente ou contate o administrador!');
    WHEN OTHERS THEN
        HTP.P('Ocorreu um erro ao adicionar uma consulta aos favoritos, tente novamente ou contate o administrador!');
END ADICIONACUSTOMIZADO;

PROCEDURE CONTEUDOCUSTOMIZADO AS 
BEGIN

    HTP.P('<div class="searchbar">');

		HTP.P('<input type="text" placeholder="'||FUN.LANG('NOME DA CONSULTA')||'" id="custom-conteudo-desc" value=""/>');
		
		HTP.P('<a onclick="get(''gerar-custom'').click();" class="script"></a>');
		FCL.FAKEOPTION('prm_coluna_tipo', FUN.LANG('Mostrar total'), '', '$tpGroup', 'N', 'N', '');
		
		HTP.P('<a onclick="get(''gerar-custom'').click();" class="script"></a>');
		FCL.FAKEOPTION('prm_limite', FUN.LANG('Limite de linhas'), '', '$amostra', 'N', 'N', '');

		HTP.P('<a class="script" onclick="restoreCustom(this);"></a>');
		FCL.FAKEOPTION('lista-custom-fav', FUN.LANG('Consultas favoritas'), '', 'lista-custom-fav', 'N', 'N');
	HTP.P('</div>');

	HTP.P('<div id="custom-conteudo"></div>');

END CONTEUDOCUSTOMIZADO;

PROCEDURE SUBPARREAL ( PRM_TEXTO  VARCHAR2 DEFAULT NULL,
                       PRM_SCREEN VARCHAR2 DEFAULT NULL ) AS

BEGIN

    HTP.P(FUN.SUBPAR(PRM_TEXTO, PRM_SCREEN));

END SUBPARREAL;

PROCEDURE FAKECUSTOM ( PRM_TIPO   VARCHAR2 DEFAULT NULL,
                       PRM_SEARCH VARCHAR2 DEFAULT NULL,
					   PRM_EXTEND VARCHAR2 DEFAULT NULL ) AS

BEGIN

    CASE PRM_TIPO
        
		WHEN 'search' THEN
		    
			HTP.P('<li class="custom">');
				HTP.P('<input type="text" maxlength="80" placeholder="'||FUN.LANG('BUSCAR')||'" value="'||PRM_SEARCH||'" />');
				HTP.P('<a title="search" class="search '||PRM_EXTEND||'"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="485.213px" height="485.213px" viewBox="0 0 485.213 485.213" style="enable-background:new 0 0 485.213 485.213;" xml:space="preserve"> <g> 	<g> 		<path d="M363.909,181.955C363.909,81.473,282.44,0,181.956,0C81.474,0,0.001,81.473,0.001,181.955s81.473,181.951,181.955,181.951 			C282.44,363.906,363.909,282.437,363.909,181.955z M181.956,318.416c-75.252,0-136.465-61.208-136.465-136.46 			c0-75.252,61.213-136.465,136.465-136.465c75.25,0,136.468,61.213,136.468,136.465 			C318.424,257.208,257.206,318.416,181.956,318.416z"></path> 		<path d="M471.882,407.567L360.567,296.243c-16.586,25.795-38.536,47.734-64.331,64.321l111.324,111.324 			c17.772,17.768,46.587,17.768,64.321,0C489.654,454.149,489.654,425.334,471.882,407.567z"></path> 	</g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> <g> </g> </svg></a>');
			HTP.P('</li>');

		WHEN 'add' THEN
		    
			HTP.P('<li class="custom">');
				HTP.P('<input type="text" maxlength="200" placeholder="'||FUN.LANG('INSERIR VALOR')||'" value="'||PRM_SEARCH||'" />');
				HTP.P('<a title="add" class="add '||PRM_EXTEND||'">+</a>');
			HTP.P('</li>');

	END CASE;

END FAKECUSTOM;

PROCEDURE AUTO_UPDATE AS
    
	WS_REQ    VARCHAR2(200);
	WS_RES    VARCHAR2(800);
	WS_ULTIMO DATE;

	WS_NOACCESS EXCEPTION;

BEGIN

	IF NVL(GBL.GETNIVEL, 'N') <> 'A' THEN
		RAISE WS_NOACCESS;
	END IF;

    HTP.P('<table class="linha">');
	    HTP.P('<thead>');
		    HTP.P('<tr>');
				HTP.P('<th>'||FUN.LANG('TIPO')||'</th>');
				HTP.P('<th>'||FUN.LANG('&Uacute;LTIMO UPDATE')||'</th>');
				HTP.P('<th>STATUS</th>');
				
				HTP.P('<th class="dir">'||FUN.LANG('ATUALIZA&Ccedil;&Atilde;O AUTOM&Aacute;TICA')||'</th>');
			HTP.P('</tr>');
		HTP.P('</thead>');

		HTP.P('<tbody id="ajax">');

		    WS_REQ := 'http://'||nvl(FUN.RET_VAR('DOMINIO_REG'),'update.upquery.com')||'/update/dwu.get_padroes?prm_tipo=CHECK_UPDATES&prm_chave=';

			WS_RES := UTL_HTTP.REQUEST(WS_REQ);
			
			




				FOR I IN(SELECT CD_COLUNA, SIGN(TO_DATE(CD_CONTEUDO, 'DD-MM-YYYY')-NVL(ULTIMO_UPDATE, TO_DATE(CD_CONTEUDO, 'DD-MM-YYYY')-2)) AS UPDATABLE, ULTIMO_UPDATE, AUTO,  STATUS
				    FROM TABLE(FUN.VPIPE_PAR((WS_RES))) LEFT JOIN BI_AUTO_UPDATE ON TIPO = CD_COLUNA) LOOP

                    

                    

					HTP.P('<tr>');
						HTP.P('<td>'||I.CD_COLUNA||'</td>');
						HTP.P('<td>'||TO_CHAR(I.ULTIMO_UPDATE, 'DD/MM/YYYY')||'</td>');
						HTP.P('<td>');
                            IF I.STATUS = 'C' THEN
                            	HTP.P('<a class="upd error" onclick="autoUpdate(this, '''||I.CD_COLUNA||''');">'||FUN.LANG('ATUALIZADO COM ERROS')||'</a>');
							ELSE
								IF I.STATUS = 'U' THEN
									HTP.P('<a class="upd loading" onclick="autoUpdate(this, '''||I.CD_COLUNA||''');">'||FUN.LANG('VERIFICANDO')||'</a>');
								ELSE
									IF NVL(I.UPDATABLE, 1) = 1 THEN
										HTP.P('<a class="upd" onclick="autoUpdate(this, '''||I.CD_COLUNA||''');">'||FUN.LANG('ATUALIZA&Ccedil;&Atilde;O DISPON&Iacute;VEL')||'</a>');
									ELSE
										HTP.P('<a class="green ok">'||FUN.LANG('ATUALIZADO')||'</a>');
									END IF;
								END IF;
							END IF;
						HTP.P('</td>');
						




						HTP.P('<td>');
						    HTP.P('<a class="script" onclick="call(''updateAuto'', ''prm_tipo='||I.CD_COLUNA||'&prm_auto=''+this.nextElementSibling.title).then(function(res){ if(res.indexOf(''ok'') != -1){ alerta(''feed-fixo'', TR_AL); } else { alerta(''feed-fixo'', TR_ER); } });"></a>');
						    IF I.AUTO = 'S' THEN
							    HTP.P('<span class="checkbox checked" data-positive="S" data-negative="N" title="'||I.AUTO||'"></span>');
							ELSE
                                HTP.P('<span class="checkbox" data-positive="S" data-negative="N" title="'||I.AUTO||'"></span>');
							END IF;
						HTP.P('</td>');
					HTP.P('</tr>');
				END LOOP;
			
		HTP.P('</tbody>');
	HTP.P('</table>');
EXCEPTION 
	WHEN WS_NOACCESS THEN
		HTP.P('Sem permiss&atilde;o!');
	WHEN OTHERS THEN
    	HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END AUTO_UPDATE;

PROCEDURE UPDATEAUTO ( PRM_TIPO VARCHAR2 DEFAULT NULL,
                       PRM_AUTO VARCHAR2 DEFAULT 'N' ) AS

	WS_COUNT NUMBER;
	WS_ERROR EXCEPTION;

BEGIN

    MERGE INTO BI_AUTO_UPDATE B
    USING (SELECT PRM_TIPO AS P_TIPO, PRM_AUTO AS P_AUTO FROM DUAL) T1 ON (B.TIPO = T1.P_TIPO)
    WHEN MATCHED THEN
        UPDATE SET AUTO = T1.P_AUTO WHERE B.TIPO = T1.P_TIPO
    WHEN NOT MATCHED THEN
        INSERT VALUES (T1.P_TIPO, '', T1.P_AUTO, ''); 

    

	WS_COUNT := SQL%ROWCOUNT;
			
	IF WS_COUNT = 1 THEN
		COMMIT;
	ELSE
		ROLLBACK;
		RAISE WS_ERROR;
	END IF;

	HTP.P('ok');

EXCEPTION 
    WHEN WS_ERROR THEN
	    HTP.P('FAIL');
    WHEN OTHERS THEN
        HTP.P('FAIL');
END UPDATEAUTO;

PROCEDURE LOGIN ( PRM_USER     VARCHAR2 DEFAULT NULL,
                  PRM_PASSWORD VARCHAR2 DEFAULT NULL, 
				  PRM_SESSION  VARCHAR2 DEFAULT NULL,
				  PRM_PRAZO    NUMBER   DEFAULT 0.5,
				  prm_url      varchar2 default null ) AS

    WS_TEST      VARCHAR2(10);
	WS_HASH      VARCHAR2(20);
	WS_USER      VARCHAR2(40) := 'N/A';
	WS_PASSWORD  VARCHAR2(40);
	WS_SHOW      VARCHAR2(40);
	WS_PRAZO     NUMBER   := 0.5;
    WS_ERRO      EXCEPTION;
	WS_SEMACESSO EXCEPTION;
	WS_TOKEN     VARCHAR2(40);
	
	ws_raise_valida exception;	
	ws_msg_valida varchar2(500);	
	ws_tempo_exp    number; 
	ws_dt_validacao date; 
	ws_valida_usu   varchar2(1);
	ws_count        integer;

	HTTP_RESP    UTL_HTTP.RESP;

BEGIN

	IF INSTR(PRM_USER, '@') > 0 THEN
        
		BEGIN
		    SELECT USU_NOME INTO WS_USER FROM USUARIOS WHERE UPPER(USU_EMAIL) = UPPER(PRM_USER) AND ROWNUM = 1;
		EXCEPTION WHEN OTHERS THEN
            RAISE WS_ERRO;
		END;

		WS_USER := UPPER(WS_USER);

	ELSE
        WS_USER := UPPER(PRM_USER);
	END IF;

	IF NVL(WS_USER, 'N/A') = 'N/A' THEN
        RAISE WS_ERRO;
	END IF;

    WS_TEST := FUN.TESTDIGESTEDPASSWORD(WS_USER, PRM_PASSWORD);

	IF WS_TEST = 'Y' THEN
		
		-- Pega a DT_ULTIMA_VALIDACAO do usuario, cria o campo na tabela se não existir
		select count(*) into ws_count 
         from all_tab_columns 
        where table_name = 'USUARIOS'
          and column_name = 'DT_ULTIMA_VALIDACAO';
        if ws_count > 0 then 
			begin 
				EXECUTE IMMEDIATE 'select dt_ultima_validacao from usuarios where usu_nome = :b1' into ws_dt_validacao USING WS_USER; 			
			exception when others then 
				ws_dt_validacao := null;
			end; 
		else 	
			begin 
				EXECUTE IMMEDIATE 'alter table usuarios add dt_ultima_validacao date'; 
				EXECUTE IMMEDIATE 'update usuarios set dt_ultima_validacao = sysdate';     -- Atualiza a data de todos já cadastrados 
				commit; 
			exception when others then 
				insert into bi_log_sistema values(sysdate, 'Erro tentando criar campo DT_ULTIMA_VALIDACAO: '||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_user, 'ERRO');
			end; 	
			ws_dt_validacao := sysdate;
		end if; 
		

		-- Verifica necessidade de Confirmação de identidade para o acesso 
		ws_valida_usu := 'N';
		if ws_dt_validacao is null then 
			ws_valida_usu := 'S'; 
		else 	
			-- Valida tempo de expiração de sessão sem atividade (em dias)
			begin
				ws_tempo_exp := fun.ret_var ('TEMPO_VALIDA_USUARIO', ws_user); 
				if ws_tempo_exp is null then 
					ws_tempo_exp := fun.ret_var ('TEMPO_VALIDA_USUARIO','DWU'); 
				end if;
			exception when others then 
				ws_tempo_exp := 0;
			end; 
			if nvl(ws_tempo_exp,0) <> 0 and (trunc(sysdate) - trunc(ws_dt_validacao) ) >= ws_tempo_exp then
				ws_valida_usu := 'S'; 
			end if;	
		end if; 
		if ws_valida_usu = 'S' then 
        	loginValida (ws_user, '999', prm_url, ws_msg_valida ); 
			raise ws_raise_valida; 
		end if; 



		INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Sess&atilde;o iniciada', WS_USER, 'SESSAO');
    	COMMIT;

		WS_PRAZO := PRM_PRAZO;

		SELECT WS_USER||
		 	TO_CHAR(SYSDATE,'miss')||
		 	ROUND(DBMS_RANDOM.VALUE(10,99))||
			TO_CHAR(SYSDATE,'dd') 
		  INTO WS_TOKEN 
		  FROM DUAL;

		SELECT NVL(SHOW_ONLY,'N') INTO WS_SHOW 
		  FROM USUARIOS 
		 WHERE USU_NOME = WS_USER;

		IF nvl(WS_SHOW,'N') = 'S' THEN
			WS_PRAZO := PRM_PRAZO+6;
		END IF;
		
		OWA_UTIL.MIME_HEADER('text/html', FALSE, NULL);
			OWA_COOKIE.SEND(
        	NAME    => 'SESSION',
			VALUE   => WS_TOKEN,
			EXPIRES => SYSDATE+NVL(WS_PRAZO, 0.5)
		);

		OWA_UTIL.HTTP_HEADER_CLOSE;
		
		IF FUN.CHECK_NETWALL(WS_USER) AND FUN.CHECK_USER(WS_USER) THEN

			FUN.SETSESSAO(WS_TOKEN, WS_USER, SYSDATE+NVL(WS_PRAZO, 0.5));

			IF nvl(WS_SHOW,'N') <> 'S' THEN
				HTP.P(WS_TOKEN);
			END IF;

			UPDATE ACTIVE_SESSIONS
			  SET STATUS = 'I'
			WHERE STATUS = 'A' AND DT_ATIVIDADE < (SYSDATE-((1/1440)*30));
			COMMIT;

			UPDATE ACTIVE_SESSIONS T1  SET T1.DT_ATIVIDADE = SYSDATE 
			 WHERE T1.ID_SESSION = WS_USER||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.')
			   AND T1.STATUS     = 'A';
			IF SQL%NOTFOUND THEN 
				INSERT INTO ACTIVE_SESSIONS VALUES (WS_USER||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.'), WS_USER, SYSDATE, SYSDATE, 'A'); 
			END IF;    

			/* 
			MERGE INTO ACTIVE_SESSIONS T1
			USING (SELECT WS_USER||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.') ID_SESSION FROM DUAL) T2 ON (T1.ID_SESSION = T2.ID_SESSION AND T1.STATUS = 'A')
			WHEN MATCHED THEN
				UPDATE SET DT_ATIVIDADE = SYSDATE WHERE T1.ID_SESSION = T2.ID_SESSION
			WHEN NOT MATCHED THEN
				INSERT VALUES (WS_USER||REPLACE(SYS_CONTEXT('userenv','ip_address'), '.'), WS_USER, SYSDATE, SYSDATE, 'A'); 
			*/ 
			COMMIT;

			



		ELSE
			RAISE WS_SEMACESSO;
		END IF;

	ELSE
        RAISE WS_ERRO;
	END IF;

EXCEPTION 
	when ws_raise_valida then 
		if ws_msg_valida = 'OK' then 
			htp.p('LOGINVALIDA-OK'||fun.lang(ws_msg_valida)); 
		else
			htp.p('LOGINVALIDA-ERRO'||fun.lang(ws_msg_valida)); 
		end if; 	
    WHEN WS_ERRO THEN
	    HTP.P('erro no login');
	WHEN WS_SEMACESSO THEN
		HTP.P('usu&aacute;rio sem acesso ao sistema');
		
		GBL.SETUSUARIO(PRM_SESSION, '');
        COMMIT;
    WHEN OTHERS THEN
        HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
END LOGIN;

PROCEDURE NEWPASSWORD ( PRM_USUARIO VARCHAR2,
                        PRM_CODE    VARCHAR2 DEFAULT NULL,
						PRM_URL     VARCHAR2 DEFAULT NULL ) AS

	WS_CODE     VARCHAR2(100);
	WS_CMD      VARCHAR2(200);
	WS_COUNT    NUMBER;
	WS_VRF      VARCHAR2(10);
	WS_MAIL     VARCHAR2(80);
	WS_USUARIO  VARCHAR2(80);
	WS_ADDRESS  VARCHAR2(80);
	ws_erro_envio    varchar2(1000);
	WS_NOMAIL   EXCEPTION;
	WS_NOUSER   EXCEPTION;
	WS_ERR      EXCEPTION;

BEGIN

    IF NVL(PRM_CODE, '999') = '999' THEN

        
		WS_CODE := FUN.RANDOMCODE(11);
		
		

        
		IF INSTR(PRM_USUARIO, '@') > 0 THEN
            BEGIN
				WS_MAIL := TRIM(UPPER(PRM_USUARIO));
				SELECT COUNT(*) INTO WS_COUNT FROM USUARIOS WHERE TRIM(UPPER(USU_EMAIL)) = WS_MAIL;

				IF NVL(WS_MAIL, 'N/A') = 'N/A' OR WS_COUNT = 0 THEN
					RAISE WS_NOMAIL;
				END IF;

				SELECT TRIM(UPPER(USU_NOME)) INTO WS_USUARIO FROM USUARIOS WHERE TRIM(UPPER(USU_EMAIL)) = WS_MAIL AND ROWNUM = 1;
			EXCEPTION WHEN OTHERS THEN
                RAISE WS_NOMAIL;
			END;
		ELSE
            BEGIN
				WS_USUARIO := TRIM(UPPER(PRM_USUARIO));
				SELECT TRIM(UPPER(USU_EMAIL)) INTO WS_MAIL FROM USUARIOS WHERE TRIM(UPPER(USU_NOME)) = WS_USUARIO;
			EXCEPTION WHEN OTHERS THEN
                RAISE WS_NOUSER;
			END;
		END IF;

		IF WS_MAIL = 'N/A' OR WS_COUNT = 0 THEN
            RAISE WS_NOMAIL;
		END IF;

		
		UPDATE BI_TOKEN
		SET STATUS = 'F' 
		WHERE TRIM(UPPER(USUARIO)) = WS_USUARIO AND TO_CHAR(DT_ENVIO, 'DD/MM/YY HH24') = TO_CHAR(SYSDATE, 'DD/MM/YY HH24') AND STATUS = 'A';
		COMMIT;

        
		INSERT INTO BI_TOKEN 
		( CODE, USUARIO, DT_ENVIO, STATUS ) VALUES
		( WS_CODE, WS_USUARIO, SYSDATE, 'A' );
		COMMIT;

		INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Usuário solicitou alteração de senha através do link <Esqueceu a senha?>', WS_USUARIO, 'EVENTO');
		COMMIT;

		--FCL.XSEND_MAIL('upquery@upquery.com', WS_MAIL, 'Upquery - Validar troca de senha', 'Voc&ecirc; esta recebendo este email pois foi solicitado pelo sistema a troca da senha.<br> Caso tenha sido realmente solicitado <h4><a href="'||PRM_URL||'dwu.fcl.newPassword?prm_usuario='||WS_USUARIO||'&prm_code='||WS_CODE||'">CLIQUE AQUI</a></h4> para alterar a senha, do contr&aacute;rio ignore este email.<br><br><br><br><img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil">');
	    --HTP.P('Em instantes voc&ecirc; receber&aacute; um email para a troca da senha!');

		fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Solicitacao de troca de senha', 
					   '<p>Ol&aacute;,</p>'||
                       '<p>Houve uma solicita&ccedil;&atilde;o de troca de senha do seu usu&aacute;rio, se voc&ecirc; fez essa solicita&ccedil;&atilde;o clique no link abaixo, caso contr&aacute;rio ignore esse email.</p>'||
                       '<h4><a href="'||prm_url||'dwu.fcl.newPassword?prm_usuario='||ws_usuario||'&prm_code='||ws_code||'">Trocar senha</a></h4>'||
                       '<p>Este link tem validade de 12 horas.</p>'||
                       '<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
                       '<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">' , ws_erro_envio);

	   	if ws_erro_envio is not null then 
			htp.p(fun.lang(ws_erro_envio));   -- Erro no envio do email 
		else 	
	    	htp.p(fun.lang('Em instantes voc&ecirc; receber&aacute; um email com instru&ccedil&otilde;es para a troca da sua senha!'));
		end if; 

	ELSE

        SELECT COUNT(*) INTO WS_COUNT FROM BI_TOKEN WHERE TRIM(UPPER(USUARIO)) = TRIM(UPPER(PRM_USUARIO)) AND CODE = PRM_CODE AND TO_CHAR(DT_ENVIO, 'DD/MM/YY HH24') = TO_CHAR(SYSDATE, 'DD/MM/YY HH24') AND STATUS = 'A';

		IF WS_COUNT <> 0 THEN
			BEGIN

			    WS_USUARIO := TRIM(UPPER(PRM_USUARIO));
			    SELECT TRIM(UPPER(USU_EMAIL)) INTO WS_MAIL FROM USUARIOS WHERE TRIM(UPPER(USU_NOME)) = WS_USUARIO;

                SELECT ROUND(DBMS_RANDOM.VALUE(10000000,99999999)) INTO WS_CODE 
		        FROM DUAL;

                
				
				WS_VRF := FUN.DIGESTPASSWORD(WS_USUARIO, WS_CODE);
				
				
				IF WS_VRF = 'Y' THEN
				
					-- XSEND_MAIL AGORA É CHAMADO DE DENTRO DA FCL ,RETIRADO DA AUX. 01/02/2022
					-- FCL.XSEND_MAIL('upquery@upquery.com', WS_MAIL, 'Upquery - Nova senha', 'A sua nova senha &eacute;: <br><h3><b>'||WS_CODE||'</b></h3><br><br><br><br><img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil">');

					fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Solicitacao de troca de senha - Nova senha', 
								'<p>Ol&aacute;,</p><p>Segue abaixo sua nova senha: </p>'||
                       			'<h3><b>'||ws_code||'</b></h3>'||
                       			'<p>Aten&ccedil;&atilde;o, esta &eacute; uma senha tempor&aacute;ria, no seu primeiro acesso ao sistema ser&aacute; solicitado o cadastro de uma nova senha.</p>'||
		                        '<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
        		                '<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">', ws_erro_envio); 

					
					UPDATE BI_TOKEN
					   SET STATUS = 'F' 
					 WHERE TRIM(UPPER(USUARIO)) = WS_USUARIO 
					   AND CODE = PRM_CODE 
					   AND TO_CHAR(DT_ENVIO, 'DD/MM/YY HH24') = TO_CHAR(SYSDATE, 'DD/MM/YY HH24') 
					   AND STATUS = 'A';
					COMMIT;

					DELETE FROM BI_SESSAO WHERE VALOR = TRIM(UPPER(WS_USUARIO));
					INSERT INTO BI_LOG_SISTEMA VALUES (SYSDATE, 'Senha alterada pelo usuário através do link <Esqueceu a senha?>', WS_USUARIO, 'EVENTO');
					COMMIT;

					if ws_erro_envio is not null then 
						htp.p(fun.lang(ws_erro_envio));   -- Erro no envio do email 
					else 	
						htp.p(fun.lang('Senha alterada com sucesso!<br>'));
						htp.p(fun.lang('Em breve voc&ecirc; receber&aacute; um email com a nova senha!'));
					end if; 
					--HTP.P('Senha alterada com sucesso!<br>');
					--HTP.P('Em breve voc&ecirc; vai receber um email com a nova senha!');
				ELSE
					RAISE WS_ERR;
				END IF;
			EXCEPTION WHEN OTHERS THEN
                RAISE WS_ERR;
			END;
		ELSE

		    HTP.P('Ticket inv&aacute;lido ou prazo expirado!<br>');
			HTP.P('Solicite novamente a troca da senha!');

		END IF;

	END IF;
EXCEPTION 
    WHEN WS_ERR THEN
		HTP.P('Erro ao alterar a senha!');
    WHEN WS_NOUSER THEN
	    HTP.P('Usu&aacute;rio n&atilde;o encontrado!');
	WHEN WS_NOMAIL THEN
	    HTP.P('Email n&atilde;o encontrado!');
    WHEN OTHERS THEN
		if instr(UPPER(DBMS_UTILITY.FORMAT_ERROR_STACK),'COULD NOT FIND PROGRAM UNIT') > 0 then 
			htp.p('N&atilde;o foi poss&iacute;vel localizar o pacote de fun&ccedil;&otilde;es do sistema, pacote com situa&ccedil;&atilde;o inv&aacute;lida ou inexistente.');
		else    
	        HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
		end if;	
END NEWPASSWORD;




procedure loginValida ( prm_usuario 	varchar2,
                        prm_code    	varchar2 default null,
						prm_url     	varchar2 default null,
						prm_msg_retorno in out varchar2  ) as

	ws_code          varchar2(100);
	ws_cmd           varchar2(200);
	ws_count         number;
	ws_vrf           varchar2(10);
	ws_mail          varchar2(80);
	ws_usuario       varchar2(80);
	ws_address       varchar2(80);
	ws_erro_envio    varchar2(1000);
	ws_raise_envio	 	exception;
	ws_raise_liberacao  exception;
	ws_nouser           exception;


begin

    if nvl(prm_code, '999') = '999' then

        begin 
			-- verifica se tem email cadastrado 
			prm_msg_retorno := null;
        	ws_mail 		:= null;
			ws_usuario 		:= trim(upper(prm_usuario));
			select trim(upper(max(usu_email))) into ws_mail from usuarios where trim(upper(usu_nome)) = ws_usuario;
			if ws_mail is null then
				prm_msg_retorno := 'Usu&aacute;rio sem e-mail cadastrado';
            	raise ws_raise_envio;
			end if;

			--invalida outros tickets pendentes do mesmo usuário 
			update bi_token set status = 'F' 
			where trim(upper(usuario)) = ws_usuario 
		  	  and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
		  	  and status = 'A';
			commit;

        	--gera novo ticket
		 	ws_code := fun.randomCode(11);
			insert into bi_token ( code, usuario, dt_envio, status )  values   ( ws_code, ws_usuario, sysdate, 'A' );
			commit;

			insert into bi_log_sistema values (sysdate, 'Confirmacao de Identidade - Envio de codigo de confirmacao', ws_usuario, 'EVENTO');
			commit;

			fcl.xsend_mail('upquery@upquery.com', ws_mail, 'Upquery - Confirmacao de Identidade', 
					   '<p>Ol&aacute;,</p>'||
					   '<p>Este &eacute; um email de confirma&ccedil;&atilde;o da sua identidade de acesso ao sistema de BI, para confirmar sua identifica&ccedil;&atilde;o e liberar o acesso ao sistema clique no link abaixo.</p>'||
					   '<h4><a href="'||prm_url||'dwu.fcl.loginValida?prm_usuario='||ws_usuario||'&prm_code='||ws_code||'&prm_url=&prm_msg_retorno='||'">Confirmar identidade</a></h4>'||
					   '<p>Este link &eacute; v&aacute;lido somente para data de hoje, ou at&eacute; o envio de um novo email de confirma&ccedil;&atilde;o.</p>'||
                       '<br><br><p><font size="1">Email gerado automaticamente pelo sistema, n&atilde;o responda.</font></p>'||
                       '<img src="https://www.upquery.com/wp-content/themes/upquery/media/img/assets/brand.svg" alt="UpQuery do Brasil" width="203" height="50">', 
					   ws_erro_envio);

	   		if ws_erro_envio is not null then 
				prm_msg_retorno := ws_erro_envio;   -- Erro no envio do email 
			else 
				prm_msg_retorno := 'OK'; 
			end if; 	
		exception 
			when ws_raise_envio then
				null;
    		when others then
				prm_msg_retorno := 'Erro gerando e-mail de confirma&ccedil;&atilde;o de acesso, entre em contato com o adminstrador do sistema.';
				insert into bi_log_sistema values (sysdate, 'Erro no envio do email de confirmacao de acesso:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
				commit; 
		end;
	else
		begin
	        select count(*) into ws_count from bi_token 
			 where trim(upper(usuario)) = trim(upper(prm_usuario)) 
			   and code                 = prm_code 
		   	   and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
		   	   and status = 'A';

			if ws_count <> 0 then
		    	ws_usuario := trim(upper(prm_usuario));
				ws_mail    := null;

				--update usuarios set dt_ultima_validacao = sysdate where usu_nome = ws_usuario;
				EXECUTE IMMEDIATE 'update usuarios set dt_ultima_validacao = sysdate where usu_nome = :b1' USING ws_usuario; 	-- utilizado o EXECUTE para casos em que o cliente ainda não tem o campo DT_ULTIMA_VALIDACAO (Somente na v155)

				--invalida os tickets
				update bi_token	set status = 'F' 
				 where trim(upper(usuario)) = ws_usuario 
				   and code 	               = prm_code 
				   and to_char(dt_envio, 'DD/MM/YY HH24') = to_char(sysdate, 'DD/MM/YY HH24') 
				   and status = 'A';

				delete from bi_sessao where valor = trim(upper(ws_usuario));
				insert into bi_log_sistema values (sysdate, 'Confirmacao de Identidade - Identificacao confirmada', ws_usuario, 'EVENTO');				
				commit;

				if ws_erro_envio is not null then 
					insert into bi_log_sistema values (sysdate, 'Erro enviando email de confirmacao da liberacao de acesso:'||ws_erro_envio, ws_usuario, 'ERRO');
				end if;	
		    	htp.p(fun.lang('Confirma&ccedil;&atilde;o de identidade realizada com sucesso!<br>'));
				htp.p(fun.lang('Seu acesso ao sistema de BI foi liberado.'));


			else
		    	htp.p(fun.lang('C&oacute;digo de valida&ccedil;&atilde;o inv&aacute;lido ou prazo expirado!<br>'));
				htp.p(fun.lang('Tente realizar um novo acesso ao sistema para gerar um novo email de confirma&ccedil;&atilde;o!'));
			end if;
		exception 
		    when others then
	    		htp.p(fun.lang('Erro na tentativa de libera&ccedil;&atildeo; do acesso.<br>'));
				htp.p(fun.lang('Tente realizar um novo acesso ao sistema para gerar um novo email de confirma&ccedil;&atilde;o, ou entre em contato com o adminstrador do sistema!'));
				insert into bi_log_sistema values (sysdate, 'Erro na confirmacao da liberacao de acesso:'||DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE, ws_usuario, 'ERRO');
				commit; 								
		end;
	end if;
	--
end loginValida;







PROCEDURE COPIARPERMISSAOBOX ( PRM_USUARIO VARCHAR2 DEFAULT NULL ) AS

BEGIN

    HTP.P('<h3>'||FUN.LANG('COPIAR REGRAS')||'</h3>');
    
	FCL.FAKEOPTION('fake-copiar-permissao', FUN.LANG('Lista de usu&aacute;rios'), '', 'lista-usuarios', 'N', 'N');
    HTP.P('<select id="regras">');
	    HTP.P('<option value="manter" selected readonly disabled>'||FUN.LANG('LIMPAR REGRAS ATUAIS')||'</option>');
        HTP.P('<option value="manter">'||FUN.LANG('N&Atilde;O')||'</option>');
		HTP.P('<option value="deletar">'||FUN.LANG('SIM')||'</option>');
	HTP.P('</select>');
	HTP.P('<a class="addpurple" onclick="copyUserBtn('''||PRM_USUARIO||''');">'||FUN.LANG('EXECUTAR')||'</a>');

END;

PROCEDURE COPIARPERMISSAO ( PRM_USUARIO VARCHAR2, 
                            PRM_USUARIO_COP VARCHAR2, 
							PRM_STATUS VARCHAR2 DEFAULT 'manter'
						  ) AS
    
	VAR_USUARIO     VARCHAR2(40) := TRIM(UPPER(PRM_USUARIO));
	VAR_USUARIO_COP VARCHAR2(40) := TRIM(UPPER(PRM_USUARIO_COP));

	WS_KEY          NUMBER;


BEGIN

	IF PRM_STATUS = 'deletar' THEN

		

		DELETE FILTROS              WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
		DELETE DESTAQUE             WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
		DELETE FLOAT_FILTER_ITEM    WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
		DELETE OBJECT_RESTRICTION   WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;
		DELETE PARAMETRO_USUARIO    WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
		DELETE ROLES                WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO;
		DELETE COLUMN_RESTRICTION   WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;
		DELETE USER_NETWALL         WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;
		
		DELETE USER_SCREENS         WHERE TRIM(UPPER(USUARIO))    = VAR_USUARIO;

		

		SELECT NVL(MAX(CD_FILTRO),0)+1 INTO WS_KEY FROM FILTROS;
		FOR I IN(SELECT VAR_USUARIO AS CD_USUARIO, CD_OBJETO, MICRO_VISAO, CD_COLUNA, CONDICAO, CONTEUDO, LIGACAO, ST_AGRUPADO, TP_FILTRO, CD_CRIADO
		FROM FILTROS WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP) LOOP
            WS_KEY := WS_KEY+1;
            INSERT INTO FILTROS VALUES (I.CD_USUARIO, I.CD_OBJETO, I.MICRO_VISAO, I.CD_COLUNA, I.CONDICAO, I.CONTEUDO, I.LIGACAO, I.ST_AGRUPADO, WS_KEY, I.TP_FILTRO, I.CD_CRIADO);
		END LOOP;
		


        SELECT NVL(MAX(CD_DESTAQUE),0)+1 INTO WS_KEY FROM DESTAQUE;
		FOR D IN(SELECT VAR_USUARIO AS CD_USUARIO, CD_OBJETO, CD_COLUNA, CONDICAO, CONTEUDO, COR_FUNDO, COR_FONTE, TIPO_DESTAQUE, PRIORIDADE
		FROM DESTAQUE WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP) LOOP
            WS_KEY := WS_KEY+1;
            INSERT INTO DESTAQUE VALUES (D.CD_USUARIO, D.CD_OBJETO, D.CD_COLUNA, D.CONDICAO, D.CONTEUDO, D.COR_FUNDO, D.COR_FONTE, D.TIPO_DESTAQUE, D.PRIORIDADE, WS_KEY);
		END LOOP;
		


		INSERT INTO FLOAT_FILTER_ITEM SELECT VAR_USUARIO AS CD_USUARIO,SCREEN,CD_COLUNA,CONTEUDO 
		FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

		INSERT INTO OBJECT_RESTRICTION SELECT VAR_USUARIO AS USUARIO,CD_OBJETO,ST_RESTRICAO,DT_LAST
		FROM OBJECT_RESTRICTION WHERE USUARIO = VAR_USUARIO_COP;

		INSERT INTO PARAMETRO_USUARIO SELECT VAR_USUARIO AS CD_USUARIO,CD_PADRAO,CONTEUDO,PRE_LOAD
		FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

		INSERT INTO ROLES SELECT VAR_USUARIO AS CD_USUARIO,CD_ROLE,TIPO
		FROM ROLES WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP;

		INSERT INTO COLUMN_RESTRICTION SELECT VAR_USUARIO AS USUARIO,CD_MICRO_VISAO,CD_COLUNA,ST_RESTRICAO,DT_LAST
		FROM COLUMN_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP;

		INSERT INTO USER_NETWALL SELECT VAR_USUARIO AS USUARIO,NOME_REGRA,TIPO_REGRA,NET_ADDRESS,HR_INICIO,HR_FINAL,DIA_SEMANA,TRUNC(SYSDATE)
		FROM USER_NETWALL WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP;
		
		--COMENTADO BI_CUSTOM_PERMISSAO - CONSULTA CUSTOMIZADA NÃO TEM FUNCIONAMENTO NA 1.5.5 01/06/2022
		--VERIFICAR A NECESSIDADE DE MANTER NA 1.5.6
		/*
			INSERT INTO BI_CUSTOM_PERMISSAO SELECT VAR_USUARIO AS NM_USUARIO,NM_VISAO,NM_COLUNA,CD_CUSTOM 
			FROM BI_CUSTOM_PERMISSAO WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO_COP;
		*/
		INSERT INTO USER_SCREENS SELECT VAR_USUARIO AS USUARIO,SCREEN,STATUS
		FROM USER_SCREENS WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP;

	END IF;

	

	IF PRM_STATUS = 'manter' THEN


		INSERT INTO FILTROS(SELECT CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,(SELECT NVL(MAX(CD_FILTRO),0) FROM FILTROS )+ROWNUM AS CD_FILTRO,TP_FILTRO,CD_CRIADO FROM (
		SELECT VAR_USUARIO AS CD_USUARIO,CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,TP_FILTRO,CD_CRIADO
		FROM FILTROS WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
		MINUS 
		SELECT TRIM(UPPER(CD_USUARIO)),CD_OBJETO,MICRO_VISAO,CD_COLUNA,CONDICAO,CONTEUDO,LIGACAO,ST_AGRUPADO,TP_FILTRO,CD_CRIADO 
		FROM FILTROS WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO));

		INSERT INTO DESTAQUE(
		SELECT TRIM(UPPER(CD_USUARIO)),CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE,(SELECT NVL(MAX(CD_DESTAQUE),0) FROM DESTAQUE)+ROWNUM AS CD_DESTAQUE FROM( 
		SELECT VAR_USUARIO AS CD_USUARIO,CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE
		FROM DESTAQUE WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT TRIM(UPPER(CD_USUARIO)),CD_OBJETO,CD_COLUNA,CONDICAO,CONTEUDO,COR_FUNDO,COR_FONTE,TIPO_DESTAQUE,PRIORIDADE 
		FROM DESTAQUE WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO));


		INSERT INTO FLOAT_FILTER_ITEM(
		SELECT VAR_USUARIO AS CD_USUARIO,SCREEN,CD_COLUNA,CONTEUDO 
		FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT * FROM FLOAT_FILTER_ITEM WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO);

		INSERT INTO OBJECT_RESTRICTION(
		SELECT VAR_USUARIO AS USUARIO,CD_OBJETO,ST_RESTRICAO,DT_LAST
		FROM OBJECT_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT * FROM OBJECT_RESTRICTION WHERE USUARIO = VAR_USUARIO);

		INSERT INTO PARAMETRO_USUARIO(
		SELECT VAR_USUARIO AS CD_USUARIO,CD_PADRAO,CONTEUDO,PRE_LOAD
		FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT * FROM PARAMETRO_USUARIO WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO);

		INSERT INTO ROLES(
		SELECT VAR_USUARIO AS CD_USUARIO,CD_ROLE,TIPO
		FROM ROLES WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT * FROM ROLES WHERE TRIM(UPPER(CD_USUARIO)) = VAR_USUARIO);

		INSERT INTO COLUMN_RESTRICTION(
		SELECT VAR_USUARIO AS USUARIO,CD_MICRO_VISAO,CD_COLUNA,ST_RESTRICAO,DT_LAST
		FROM COLUMN_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT * FROM COLUMN_RESTRICTION WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO);


		INSERT INTO USER_NETWALL(
		SELECT DISTINCT VAR_USUARIO AS USUARIO,NOME_REGRA,TIPO_REGRA,NET_ADDRESS,HR_INICIO,HR_FINAL,DIA_SEMANA,TRUNC(SYSDATE)
		FROM USER_NETWALL WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT USUARIO,NOME_REGRA,TIPO_REGRA,NET_ADDRESS,HR_INICIO,HR_FINAL,DIA_SEMANA,TRUNC(SYSDATE) FROM USER_NETWALL WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO);

		--COMENTADO BI_CUSTOM_PERMISSAO - CONSULTA CUSTOMIZADA NÃO TEM FUNCIONAMENTO NA 1.5.5 01/06/2022
		--VERIFICAR A NECESSIDADE DE MANTER NA 1.5.6
		/*
			INSERT INTO BI_CUSTOM_PERMISSAO(
			SELECT VAR_USUARIO AS NM_USUARIO,NM_VISAO,NM_COLUNA,CD_CUSTOM 
			FROM BI_CUSTOM_PERMISSAO WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO_COP
			MINUS
			SELECT * FROM BI_CUSTOM_PERMISSAO WHERE TRIM(UPPER(NM_USUARIO)) = VAR_USUARIO);
		*/
		INSERT INTO USER_SCREENS(
		SELECT VAR_USUARIO AS USUARIO,SCREEN,STATUS
		FROM USER_SCREENS WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO_COP
		MINUS
		SELECT * FROM USER_SCREENS WHERE TRIM(UPPER(USUARIO)) = VAR_USUARIO);

	END IF;

	

	HTP.P('ok');

	INSERT INTO BI_LOG_SISTEMA VALUES(SYSDATE, 'Foram copiadas regras do usuário '||PRM_USUARIO_COP||' para o usuário '||PRM_USUARIO||', foi decidido '||PRM_STATUS||' as regras atuais ', USER, 'EVENTO');
	COMMIT;

EXCEPTION 
    WHEN OTHERS THEN 
	    HTP.P('erro');
		HTP.P(DBMS_UTILITY.FORMAT_ERROR_STACK||' - '||DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
        ROLLBACK;
END COPIARPERMISSAO;

PROCEDURE LISTCONTAINER AS

    WS_COUNT NUMBER;
	WS_GRUPO VARCHAR2(80);

BEGIN

    HTP.P('<a style="display: none;"></a>');
	HTP.P('<ul class="fakelistbox open">');

		FOR I IN (
			SELECT USU_NOME, USU_COMPLETO, COUNT(T2.CD_GROUP) MSGS
			FROM USUARIOS T1
			LEFT JOIN TEXT_POST T2 ON (T2.CD_USUARIO = T1.USU_NOME AND T2.CD_GROUP = GBL.GETUSUARIO) OR (T2.CD_USUARIO = GBL.GETUSUARIO AND T2.CD_GROUP = T1.USU_NOME)
			WHERE STATUS = 'A' AND 
			USU_NOME <> GBL.GETUSUARIO 
			GROUP BY T1.USU_NOME, T1.USU_COMPLETO
			ORDER BY COUNT(T2.CD_GROUP) DESC, USU_NOME ASC
		) LOOP

			SELECT COUNT(*) INTO WS_COUNT FROM CHECK_POST WHERE CD_USUARIO = GBL.GETUSUARIO AND NM_REMETENTE = I.USU_NOME AND DT_CHECK IS NULL ;
		    IF I.MSGS > 0 THEN
			    IF NVL(WS_GRUPO, 'N/A') = 'N/A' THEN
				    WS_GRUPO := 'CONVERSAS RECENTES';
					HTP.P('<li class="opt group">'||FUN.LANG(WS_GRUPO)||'</li>');
				END IF;
			ELSE
			     IF NVL(WS_GRUPO, 'N/A') = 'N/A' OR WS_GRUPO = 'CONVERSAS RECENTES' THEN
				    WS_GRUPO := 'OUTROS USU&Aacute;RIOS';
					HTP.P('<li class="opt group">'||FUN.LANG(WS_GRUPO)||'</li>');
				END IF;
			END IF;

			IF I.MSGS > 0 AND WS_COUNT <> 0 THEN
				HTP.P('<li class="opt msgs" title="'||I.USU_NOME||'" data-msg="'||I.MSGS||'" onclick="selectTextPost(this);">'||I.USU_NOME||'</li>');
			ELSE
				HTP.P('<li class="opt" title="'||I.USU_NOME||'" data-msg="'||I.MSGS||'" onclick="selectTextPost(this);">'||I.USU_NOME||'</li>');
			END IF;
			
		END LOOP;

	HTP.P('</ul>');

END LISTCONTAINER;

PROCEDURE NUMERICOPTIONS( PRM_NUMBER   NUMBER DEFAULT 20,
					 PRM_SELECTED NUMBER DEFAULT 0 ) AS

BEGIN

	FOR I IN 1..PRM_NUMBER LOOP
		IF I = PRM_SELECTED THEN
			HTP.P('<option value="'||I||'" selected>'||I||'</option>');
		ELSE
			HTP.P('<option value="'||I||'">'||I||'</option>');
		END IF;
	END LOOP;
END NUMERICOPTIONS;

END FCL;